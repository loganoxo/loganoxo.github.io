<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>SpringCloud on Logan的博客</title><link>https://logan.wssw.fun/tags/springcloud/</link><description>Recent content in SpringCloud on Logan的博客</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><copyright>logan</copyright><lastBuildDate>Tue, 03 Jan 2023 15:49:51 +0800</lastBuildDate><atom:link href="https://logan.wssw.fun/tags/springcloud/index.xml" rel="self" type="application/rss+xml"/><item><title>1.SpringCloud实用篇01</title><link>https://logan.wssw.fun/p/2023/01/89c61189/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/89c61189/</guid><description>&lt;h1 id="springcloud01">
&lt;a href="#springcloud01" class="header-anchor">#&lt;/a>
SpringCloud01
&lt;/h1>&lt;h1 id="1认识微服务">
&lt;a href="#1%e8%ae%a4%e8%af%86%e5%be%ae%e6%9c%8d%e5%8a%a1" class="header-anchor">#&lt;/a>
1.认识微服务
&lt;/h1>&lt;p>随着互联网行业的发展，对服务的要求也越来越高，服务架构也从单体架构逐渐演变为现在流行的微服务架构。这些架构之间有怎样的差别呢？&lt;/p>
&lt;h2 id="10学习目标">
&lt;a href="#10%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87" class="header-anchor">#&lt;/a>
1.0.学习目标
&lt;/h2>&lt;p>了解微服务架构的优缺点&lt;/p>
&lt;h2 id="11单体架构">
&lt;a href="#11%e5%8d%95%e4%bd%93%e6%9e%b6%e6%9e%84" class="header-anchor">#&lt;/a>
1.1.单体架构
&lt;/h2>&lt;p>&lt;strong>单体架构&lt;/strong>：将业务的所有功能集中在一个项目中开发，打成一个包部署。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-eb9a1224d4e49b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713202807818"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>单体架构的优缺点如下：&lt;/p>
&lt;p>&lt;strong>优点：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>架构简单&lt;/li>
&lt;li>部署成本低&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>缺点：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>耦合度高（维护困难、升级困难）&lt;/li>
&lt;/ul>
&lt;h2 id="12分布式架构">
&lt;a href="#12%e5%88%86%e5%b8%83%e5%bc%8f%e6%9e%b6%e6%9e%84" class="header-anchor">#&lt;/a>
1.2.分布式架构
&lt;/h2>&lt;p>&lt;strong>分布式架构&lt;/strong>：根据业务功能对系统做拆分，每个业务功能模块作为独立项目开发，称为一个服务。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-15a1cd88f139e2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713203124797"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>分布式架构的优缺点：&lt;/p>
&lt;p>&lt;strong>优点：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>降低服务耦合&lt;/li>
&lt;li>有利于服务升级和拓展&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>缺点：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>服务调用关系错综复杂&lt;/li>
&lt;/ul>
&lt;p>分布式架构虽然降低了服务耦合，但是服务拆分时也有很多问题需要思考：&lt;/p>
&lt;ul>
&lt;li>服务拆分的粒度如何界定？&lt;/li>
&lt;li>服务之间如何调用？&lt;/li>
&lt;li>服务的调用关系如何管理？&lt;/li>
&lt;/ul>
&lt;p>人们需要制定一套行之有效的标准来约束分布式架构。&lt;/p>
&lt;h2 id="13微服务">
&lt;a href="#13%e5%be%ae%e6%9c%8d%e5%8a%a1" class="header-anchor">#&lt;/a>
1.3.微服务
&lt;/h2>&lt;p>微服务的架构特征：&lt;/p>
&lt;ul>
&lt;li>单一职责：微服务拆分粒度更小，每一个服务都对应唯一的业务能力，做到单一职责&lt;/li>
&lt;li>自治：团队独立、技术独立、数据独立，独立部署和交付&lt;/li>
&lt;li>面向服务：服务提供统一标准的接口，与语言和技术无关&lt;/li>
&lt;li>隔离性强：服务调用做好隔离、容错、降级，避免出现级联问题&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-f97e4d64984d2c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713203753373"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>微服务的上述特性其实是在给分布式架构制定一个标准，进一步降低服务之间的耦合度，提供服务的独立性和灵活性。做到高内聚，低耦合。&lt;/p>
&lt;p>因此，可以认为&lt;strong>微服务&lt;/strong>是一种经过良好架构设计的&lt;strong>分布式架构方案&lt;/strong> 。&lt;/p>
&lt;p>但方案该怎么落地？选用什么样的技术栈？全球的互联网公司都在积极尝试自己的微服务落地方案。&lt;/p>
&lt;p>其中在Java领域最引人注目的就是SpringCloud提供的方案了。&lt;/p>
&lt;h2 id="14springcloud">
&lt;a href="#14springcloud" class="header-anchor">#&lt;/a>
1.4.SpringCloud
&lt;/h2>&lt;p>SpringCloud是目前国内使用最广泛的微服务框架。官网地址：https://spring.io/projects/spring-cloud。&lt;/p>
&lt;p>SpringCloud集成了各种微服务功能组件，并基于SpringBoot实现了这些组件的自动装配，从而提供了良好的开箱即用体验。&lt;/p>
&lt;p>其中常见的组件包括：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-3d0f11479d543f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713204155887"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>另外，SpringCloud底层是依赖于SpringBoot的，并且有版本的兼容关系，如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-6b9c0e96398832.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713205003790"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们课堂学习的版本是 Hoxton.SR10，因此对应的SpringBoot版本是2.3.x版本。&lt;/p>
&lt;h2 id="15总结">
&lt;a href="#15%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
1.5.总结
&lt;/h2>&lt;ul>
&lt;li>
&lt;p>单体架构：简单方便，高度耦合，扩展性差，适合小型项目。例如：学生管理系统&lt;/p>
&lt;/li>
&lt;li>
&lt;p>分布式架构：松耦合，扩展性好，但架构复杂，难度大。适合大型互联网项目，例如：京东、淘宝&lt;/p>
&lt;/li>
&lt;li>
&lt;p>微服务：一种良好的分布式架构方案&lt;/p>
&lt;p>①优点：拆分粒度更小、服务更独立、耦合度更低&lt;/p>
&lt;p>②缺点：架构非常复杂，运维、监控、部署难度提高&lt;/p>
&lt;/li>
&lt;li>
&lt;p>SpringCloud是微服务架构的一站式解决方案，集成了各种优秀微服务功能组件&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h1 id="2服务拆分和远程调用">
&lt;a href="#2%e6%9c%8d%e5%8a%a1%e6%8b%86%e5%88%86%e5%92%8c%e8%bf%9c%e7%a8%8b%e8%b0%83%e7%94%a8" class="header-anchor">#&lt;/a>
2.服务拆分和远程调用
&lt;/h1>&lt;p>任何分布式架构都离不开服务的拆分，微服务也是一样。&lt;/p>
&lt;h2 id="21服务拆分原则">
&lt;a href="#21%e6%9c%8d%e5%8a%a1%e6%8b%86%e5%88%86%e5%8e%9f%e5%88%99" class="header-anchor">#&lt;/a>
2.1.服务拆分原则
&lt;/h2>&lt;p>这里我总结了微服务拆分时的几个原则：&lt;/p>
&lt;ul>
&lt;li>不同微服务，不要重复开发相同业务&lt;/li>
&lt;li>微服务数据独立，不要访问其它微服务的数据库&lt;/li>
&lt;li>微服务可以将自己的业务暴露为接口，供其它微服务调用&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-a5fcb3f2c14dbb.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713210800950"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="22服务拆分示例">
&lt;a href="#22%e6%9c%8d%e5%8a%a1%e6%8b%86%e5%88%86%e7%a4%ba%e4%be%8b" class="header-anchor">#&lt;/a>
2.2.服务拆分示例
&lt;/h2>&lt;p>以课前资料中的微服务cloud-demo为例，其结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-86110964ef7705.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713211009593"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>cloud-demo：父工程，管理依赖&lt;/p>
&lt;ul>
&lt;li>order-service：订单微服务，负责订单相关业务&lt;/li>
&lt;li>user-service：用户微服务，负责用户相关业务&lt;/li>
&lt;/ul>
&lt;p>要求：&lt;/p>
&lt;ul>
&lt;li>订单微服务和用户微服务都必须有各自的数据库，相互独立&lt;/li>
&lt;li>订单服务和用户服务都对外暴露Restful的接口&lt;/li>
&lt;li>订单服务如果需要查询用户信息，只能调用用户服务的Restful接口，不能查询用户数据库&lt;/li>
&lt;/ul>
&lt;h3 id="221导入sql语句">
&lt;a href="#221%e5%af%bc%e5%85%a5sql%e8%af%ad%e5%8f%a5" class="header-anchor">#&lt;/a>
2.2.1.导入Sql语句
&lt;/h3>&lt;p>首先，将课前资料提供的&lt;code>cloud-order.sql&lt;/code>和&lt;code>cloud-user.sql&lt;/code>导入到mysql中：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-da6086a4f5008e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713211417049"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>cloud-user表中初始数据如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-02d1276e119efc.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713211550169"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>cloud-order表中初始数据如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-c4624331021a4e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713211657319"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>cloud-order表中持有cloud-user表中的id字段。&lt;/p>
&lt;h3 id="222导入demo工程">
&lt;a href="#222%e5%af%bc%e5%85%a5demo%e5%b7%a5%e7%a8%8b" class="header-anchor">#&lt;/a>
2.2.2.导入demo工程
&lt;/h3>&lt;p>用IDEA导入课前资料提供的Demo：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-3b235b0623cb24.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713211814094"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>项目结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-99774f945e5ecf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713212656887"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>导入后，会在IDEA右下角出现弹窗：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-14bda477c09d17.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713212349272"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>点击弹窗，然后按下图选择：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-8a4e2c22056c2f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713212336185"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>会出现这样的菜单：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-a378b2c221a85b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713212513324"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>配置下项目使用的JDK：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-e3db32e58797bc.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713220736408"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="23实现远程调用案例">
&lt;a href="#23%e5%ae%9e%e7%8e%b0%e8%bf%9c%e7%a8%8b%e8%b0%83%e7%94%a8%e6%a1%88%e4%be%8b" class="header-anchor">#&lt;/a>
2.3.实现远程调用案例
&lt;/h2>&lt;p>在order-service服务中，有一个根据id查询订单的接口：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-4743a60b356f9a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713212749575"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>根据id查询订单，返回值是Order对象，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-4db8d739f59f35.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713212901725"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的user为null&lt;/p>
&lt;p>在user-service中有一个根据id查询用户的接口：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-9cc322f14a6494.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713213146089"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>查询的结果如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-b6698f74b85258.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713213213075"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="231案例需求">
&lt;a href="#231%e6%a1%88%e4%be%8b%e9%9c%80%e6%b1%82" class="header-anchor">#&lt;/a>
2.3.1.案例需求：
&lt;/h3>&lt;p>修改order-service中的根据id查询订单业务，要求在查询订单的同时，根据订单中包含的userId查询出用户信息，一起返回。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-b7a851b0a4e8e5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713213312278"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>因此，我们需要在order-service中 向user-service发起一个http的请求，调用http://localhost:8081/user/{userId}这个接口。&lt;/p>
&lt;p>大概的步骤是这样的：&lt;/p>
&lt;ul>
&lt;li>注册一个RestTemplate的实例到Spring容器&lt;/li>
&lt;li>修改order-service服务中的OrderService类中的queryOrderById方法，根据Order对象中的userId查询User&lt;/li>
&lt;li>将查询的User填充到Order对象，一起返回&lt;/li>
&lt;/ul>
&lt;h3 id="232注册resttemplate">
&lt;a href="#232%e6%b3%a8%e5%86%8cresttemplate" class="header-anchor">#&lt;/a>
2.3.2.注册RestTemplate
&lt;/h3>&lt;p>首先，我们在order-service服务中的OrderApplication启动类中，注册RestTemplate实例：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-6">&lt;a class="lnlinks" href="#hl-0-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-7">&lt;a class="lnlinks" href="#hl-0-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-8">&lt;a class="lnlinks" href="#hl-0-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-9">&lt;a class="lnlinks" href="#hl-0-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-10">&lt;a class="lnlinks" href="#hl-0-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-11">&lt;a class="lnlinks" href="#hl-0-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-12">&lt;a class="lnlinks" href="#hl-0-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-13">&lt;a class="lnlinks" href="#hl-0-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-14">&lt;a class="lnlinks" href="#hl-0-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-15">&lt;a class="lnlinks" href="#hl-0-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-16">&lt;a class="lnlinks" href="#hl-0-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-17">&lt;a class="lnlinks" href="#hl-0-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-18">&lt;a class="lnlinks" href="#hl-0-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-19">&lt;a class="lnlinks" href="#hl-0-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-20">&lt;a class="lnlinks" href="#hl-0-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-21">&lt;a class="lnlinks" href="#hl-0-21">21&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.order&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.mybatis.spring.annotation.MapperScan&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.boot.SpringApplication&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.context.annotation.Bean&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.web.client.RestTemplate&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@MapperScan&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;cn.itcast.order.mapper&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@SpringBootApplication&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">OrderApplication&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SpringApplication&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">OrderApplication&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RestTemplate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">restTemplate&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RestTemplate&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="233实现远程调用">
&lt;a href="#233%e5%ae%9e%e7%8e%b0%e8%bf%9c%e7%a8%8b%e8%b0%83%e7%94%a8" class="header-anchor">#&lt;/a>
2.3.3.实现远程调用
&lt;/h3>&lt;p>修改order-service服务中的cn.itcast.order.service包下的OrderService类中的queryOrderById方法：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-1f8f9b8c7ff6ad.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713213959569"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="24提供者与消费者">
&lt;a href="#24%e6%8f%90%e4%be%9b%e8%80%85%e4%b8%8e%e6%b6%88%e8%b4%b9%e8%80%85" class="header-anchor">#&lt;/a>
2.4.提供者与消费者
&lt;/h2>&lt;p>在服务调用关系中，会有两个不同的角色：&lt;/p>
&lt;p>&lt;strong>服务提供者&lt;/strong>：一次业务中，被其它微服务调用的服务。（提供接口给其它微服务）&lt;/p>
&lt;p>&lt;strong>服务消费者&lt;/strong>：一次业务中，调用其它微服务的服务。（调用其它微服务提供的接口）&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-6a502bcb496038.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713214404481"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>但是，服务提供者与服务消费者的角色并不是绝对的，而是相对于业务而言。&lt;/p>
&lt;p>如果服务A调用了服务B，而服务B又调用了服务C，服务B的角色是什么？&lt;/p>
&lt;ul>
&lt;li>对于A调用B的业务而言：A是服务消费者，B是服务提供者&lt;/li>
&lt;li>对于B调用C的业务而言：B是服务消费者，C是服务提供者&lt;/li>
&lt;/ul>
&lt;p>因此，服务B既可以是服务提供者，也可以是服务消费者。&lt;/p>
&lt;h1 id="3eureka注册中心">
&lt;a href="#3eureka%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83" class="header-anchor">#&lt;/a>
3.Eureka注册中心
&lt;/h1>&lt;p>假如我们的服务提供者user-service部署了多个实例，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-31ada1cfe857fe.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713214925388"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>大家思考几个问题：&lt;/p>
&lt;ul>
&lt;li>order-service在发起远程调用的时候，该如何得知user-service实例的ip地址和端口？&lt;/li>
&lt;li>有多个user-service实例地址，order-service调用时该如何选择？&lt;/li>
&lt;li>order-service如何得知某个user-service实例是否依然健康，是不是已经宕机？&lt;/li>
&lt;/ul>
&lt;h2 id="31eureka的结构和作用">
&lt;a href="#31eureka%e7%9a%84%e7%bb%93%e6%9e%84%e5%92%8c%e4%bd%9c%e7%94%a8" class="header-anchor">#&lt;/a>
3.1.Eureka的结构和作用
&lt;/h2>&lt;p>这些问题都需要利用SpringCloud中的注册中心来解决，其中最广为人知的注册中心就是Eureka，其结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-f7fbeac2424d7c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713220104956"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>回答之前的各个问题。&lt;/p>
&lt;p>问题1：order-service如何得知user-service实例地址？&lt;/p>
&lt;p>获取地址信息的流程如下：&lt;/p>
&lt;ul>
&lt;li>user-service服务实例启动后，将自己的信息注册到eureka-server（Eureka服务端）。这个叫服务注册&lt;/li>
&lt;li>eureka-server保存服务名称到服务实例地址列表的映射关系&lt;/li>
&lt;li>order-service根据服务名称，拉取实例地址列表。这个叫服务发现或服务拉取&lt;/li>
&lt;/ul>
&lt;p>问题2：order-service如何从多个user-service实例中选择具体的实例？&lt;/p>
&lt;ul>
&lt;li>order-service从实例列表中利用负载均衡算法选中一个实例地址&lt;/li>
&lt;li>向该实例地址发起远程调用&lt;/li>
&lt;/ul>
&lt;p>问题3：order-service如何得知某个user-service实例是否依然健康，是不是已经宕机？&lt;/p>
&lt;ul>
&lt;li>user-service会每隔一段时间（默认30秒）向eureka-server发起请求，报告自己状态，称为心跳&lt;/li>
&lt;li>当超过一定时间没有发送心跳时，eureka-server会认为微服务实例故障，将该实例从服务列表中剔除&lt;/li>
&lt;li>order-service拉取服务时，就能将故障实例排除了&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>注意：一个微服务，既可以是服务提供者，又可以是服务消费者，因此eureka将服务注册、服务发现等功能统一封装到了eureka-client端&lt;/p>
&lt;/blockquote>
&lt;p>因此，接下来我们动手实践的步骤包括：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-d718306e66034f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713220509769"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="32搭建eureka-server">
&lt;a href="#32%e6%90%ad%e5%bb%baeureka-server" class="header-anchor">#&lt;/a>
3.2.搭建eureka-server
&lt;/h2>&lt;p>首先大家注册中心服务端：eureka-server，这必须是一个独立的微服务&lt;/p>
&lt;h3 id="321创建eureka-server服务">
&lt;a href="#321%e5%88%9b%e5%bb%baeureka-server%e6%9c%8d%e5%8a%a1" class="header-anchor">#&lt;/a>
3.2.1.创建eureka-server服务
&lt;/h3>&lt;p>在cloud-demo父工程下，创建一个子模块：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-267d6f93613f35.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713220605881"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>填写模块信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-8a716a00569edd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713220857396"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后填写服务信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-0ec8e5a245d6aa.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713221339022"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="322引入eureka依赖">
&lt;a href="#322%e5%bc%95%e5%85%a5eureka%e4%be%9d%e8%b5%96" class="header-anchor">#&lt;/a>
3.2.2.引入eureka依赖
&lt;/h3>&lt;p>引入SpringCloud为eureka提供的starter依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-netflix-eureka-server&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="323编写启动类">
&lt;a href="#323%e7%bc%96%e5%86%99%e5%90%af%e5%8a%a8%e7%b1%bb" class="header-anchor">#&lt;/a>
3.2.3.编写启动类
&lt;/h3>&lt;p>给eureka-server服务编写一个启动类，一定要添加一个@EnableEurekaServer注解，开启eureka的注册中心功能：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-9">&lt;a class="lnlinks" href="#hl-2-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-10">&lt;a class="lnlinks" href="#hl-2-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-11">&lt;a class="lnlinks" href="#hl-2-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-12">&lt;a class="lnlinks" href="#hl-2-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-13">&lt;a class="lnlinks" href="#hl-2-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.eureka&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.boot.SpringApplication&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.cloud.netflix.eureka.server.EnableEurekaServer&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@SpringBootApplication&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@EnableEurekaServer&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">EurekaApplication&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SpringApplication&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">EurekaApplication&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="324编写配置文件">
&lt;a href="#324%e7%bc%96%e5%86%99%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="header-anchor">#&lt;/a>
3.2.4.编写配置文件
&lt;/h3>&lt;p>编写一个application.yml文件，内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-7">&lt;a class="lnlinks" href="#hl-3-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-8">&lt;a class="lnlinks" href="#hl-3-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-9">&lt;a class="lnlinks" href="#hl-3-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10086&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">application&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">eureka-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">eureka&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">client&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">service-url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">defaultZone&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http://127.0.0.1:10086/eureka&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="325启动服务">
&lt;a href="#325%e5%90%af%e5%8a%a8%e6%9c%8d%e5%8a%a1" class="header-anchor">#&lt;/a>
3.2.5.启动服务
&lt;/h3>&lt;p>启动微服务，然后在浏览器访问：http://127.0.0.1:10086&lt;/p>
&lt;p>看到下面结果应该是成功了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-ca5f92688fe83b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713222157190"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="33服务注册">
&lt;a href="#33%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c" class="header-anchor">#&lt;/a>
3.3.服务注册
&lt;/h2>&lt;p>下面，我们将user-service注册到eureka-server中去。&lt;/p>
&lt;h3 id="1引入依赖">
&lt;a href="#1%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96" class="header-anchor">#&lt;/a>
1）引入依赖
&lt;/h3>&lt;p>在user-service的pom文件中，引入下面的eureka-client依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-netflix-eureka-client&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2配置文件">
&lt;a href="#2%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="header-anchor">#&lt;/a>
2）配置文件
&lt;/h3>&lt;p>在user-service中，修改application.yml文件，添加服务名称、eureka地址：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-4">&lt;a class="lnlinks" href="#hl-5-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-5">&lt;a class="lnlinks" href="#hl-5-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-6">&lt;a class="lnlinks" href="#hl-5-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-7">&lt;a class="lnlinks" href="#hl-5-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">application&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">userservice&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">eureka&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">client&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">service-url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">defaultZone&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http://127.0.0.1:10086/eureka&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3启动多个user-service实例">
&lt;a href="#3%e5%90%af%e5%8a%a8%e5%a4%9a%e4%b8%aauser-service%e5%ae%9e%e4%be%8b" class="header-anchor">#&lt;/a>
3）启动多个user-service实例
&lt;/h3>&lt;p>为了演示一个服务有多个实例的场景，我们添加一个SpringBoot的启动配置，再启动一个user-service。&lt;/p>
&lt;p>首先，复制原来的user-service启动配置：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-44432a514fd4d2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713222656562"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后，在弹出的窗口中，填写信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-3f72c6e94da5aa.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713222757702"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>现在，SpringBoot窗口会出现两个user-service启动配置：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-e4ffcfb4dcdd42.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713222841951"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>不过，第一个是8081端口，第二个是8082端口。&lt;/p>
&lt;p>启动两个user-service实例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-33813862b2c4ca.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713223041491"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>查看eureka-server管理页面：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-333425d905efd2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713223150650"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="34服务发现">
&lt;a href="#34%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0" class="header-anchor">#&lt;/a>
3.4.服务发现
&lt;/h2>&lt;p>下面，我们将order-service的逻辑修改：向eureka-server拉取user-service的信息，实现服务发现。&lt;/p>
&lt;h3 id="1引入依赖-1">
&lt;a href="#1%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96-1" class="header-anchor">#&lt;/a>
1）引入依赖
&lt;/h3>&lt;p>之前说过，服务发现、服务注册统一都封装在eureka-client依赖，因此这一步与服务注册时一致。&lt;/p>
&lt;p>在order-service的pom文件中，引入下面的eureka-client依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-netflix-eureka-client&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2配置文件-1">
&lt;a href="#2%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6-1" class="header-anchor">#&lt;/a>
2）配置文件
&lt;/h3>&lt;p>服务发现也需要知道eureka地址，因此第二步与服务注册一致，都是配置eureka信息：&lt;/p>
&lt;p>在order-service中，修改application.yml文件，添加服务名称、eureka地址：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">application&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">orderservice&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">eureka&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">client&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">service-url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">defaultZone&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http://127.0.0.1:10086/eureka&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3服务拉取和负载均衡">
&lt;a href="#3%e6%9c%8d%e5%8a%a1%e6%8b%89%e5%8f%96%e5%92%8c%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" class="header-anchor">#&lt;/a>
3）服务拉取和负载均衡
&lt;/h3>&lt;p>最后，我们要去eureka-server中拉取user-service服务的实例列表，并且实现负载均衡。&lt;/p>
&lt;p>不过这些动作不用我们去做，只需要添加一些注解即可。&lt;/p>
&lt;p>在order-service的OrderApplication中，给RestTemplate这个Bean添加一个@LoadBalanced注解：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-665428243226d6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713224049419"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>修改order-service服务中的cn.itcast.order.service包下的OrderService类中的queryOrderById方法。修改访问的url路径，用服务名代替ip、端口：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-eacf4a8c31a299.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713224245731"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>spring会自动帮助我们从eureka-server端，根据userservice这个服务名称，获取实例列表，而后完成负载均衡。&lt;/p>
&lt;h1 id="4ribbon负载均衡">
&lt;a href="#4ribbon%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" class="header-anchor">#&lt;/a>
4.Ribbon负载均衡
&lt;/h1>&lt;p>上一节中，我们添加了@LoadBalanced注解，即可实现负载均衡功能，这是什么原理呢？&lt;/p>
&lt;h2 id="41负载均衡原理">
&lt;a href="#41%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
4.1.负载均衡原理
&lt;/h2>&lt;p>SpringCloud底层其实是利用了一个名为Ribbon的组件，来实现负载均衡功能的。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-9ff17fd9513b46.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713224517686"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>那么我们发出的请求明明是http://userservice/user/1，怎么变成了http://localhost:8081的呢？&lt;/p>
&lt;h2 id="42源码跟踪">
&lt;a href="#42%e6%ba%90%e7%a0%81%e8%b7%9f%e8%b8%aa" class="header-anchor">#&lt;/a>
4.2.源码跟踪
&lt;/h2>&lt;p>为什么我们只输入了service名称就可以访问了呢？之前还要获取ip和端口。&lt;/p>
&lt;p>显然有人帮我们根据service名称，获取到了服务实例的ip和端口。它就是&lt;code>LoadBalancerInterceptor&lt;/code>，这个类会在对RestTemplate的请求进行拦截，然后从Eureka根据服务id获取服务列表，随后利用负载均衡算法得到真实的服务地址信息，替换服务id。&lt;/p>
&lt;p>我们进行源码跟踪：&lt;/p>
&lt;h3 id="1loadbalancerintercepor">
&lt;a href="#1loadbalancerintercepor" class="header-anchor">#&lt;/a>
1）LoadBalancerIntercepor
&lt;/h3>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-854fca6cf4dd5a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1525620483637"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到这里的intercept方法，拦截了用户的HttpRequest请求，然后做了几件事：&lt;/p>
&lt;ul>
&lt;li>&lt;code>request.getURI()&lt;/code>：获取请求uri，本例中就是 http://user-service/user/8&lt;/li>
&lt;li>&lt;code>originalUri.getHost()&lt;/code>：获取uri路径的主机名，其实就是服务id，&lt;code>user-service&lt;/code>&lt;/li>
&lt;li>&lt;code>this.loadBalancer.execute()&lt;/code>：处理服务id，和用户请求。&lt;/li>
&lt;/ul>
&lt;p>这里的&lt;code>this.loadBalancer&lt;/code>是&lt;code>LoadBalancerClient&lt;/code>类型，我们继续跟入。&lt;/p>
&lt;h3 id="2loadbalancerclient">
&lt;a href="#2loadbalancerclient" class="header-anchor">#&lt;/a>
2）LoadBalancerClient
&lt;/h3>&lt;p>继续跟入execute方法：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-163ff00dc9d648.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1525620787090"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>代码是这样的：&lt;/p>
&lt;ul>
&lt;li>getLoadBalancer(serviceId)：根据服务id获取ILoadBalancer，而ILoadBalancer会拿着服务id去eureka中获取服务列表并保存起来。&lt;/li>
&lt;li>getServer(loadBalancer)：利用内置的负载均衡算法，从服务列表中选择一个。本例中，可以看到获取了8082端口的服务&lt;/li>
&lt;/ul>
&lt;p>放行后，再次访问并跟踪，发现获取的是8081：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-7cf43a6005d41c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1525620835911"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>果然实现了负载均衡。&lt;/p>
&lt;h3 id="3负载均衡策略irule">
&lt;a href="#3%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%ad%96%e7%95%a5irule" class="header-anchor">#&lt;/a>
3）负载均衡策略IRule
&lt;/h3>&lt;p>在刚才的代码中，可以看到获取服务使通过一个&lt;code>getServer&lt;/code>方法来做负载均衡:&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-7cf43a6005d41c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1525620835911"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们继续跟入：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-1d97c11ca26fdf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1544361421671"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>继续跟踪源码chooseServer方法，发现这么一段代码：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-3a6ea4d4515d55.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1525622652849"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们看看这个rule是谁：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-8e084f98b5530c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1525622699666"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这里的rule默认值是一个&lt;code>RoundRobinRule&lt;/code>，看类的介绍：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-de3841292f752f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1525622754316"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这不就是轮询的意思嘛。&lt;/p>
&lt;p>到这里，整个负载均衡的流程我们就清楚了。&lt;/p>
&lt;h3 id="4总结">
&lt;a href="#4%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
4）总结
&lt;/h3>&lt;p>SpringCloudRibbon的底层采用了一个拦截器，拦截了RestTemplate发出的请求，对地址做了修改。用一幅图来总结一下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-592a1f4e8f30d2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713224724673"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>基本流程如下：&lt;/p>
&lt;ul>
&lt;li>拦截我们的RestTemplate请求http://userservice/user/1&lt;/li>
&lt;li>RibbonLoadBalancerClient会从请求url中获取服务名称，也就是user-service&lt;/li>
&lt;li>DynamicServerListLoadBalancer根据user-service到eureka拉取服务列表&lt;/li>
&lt;li>eureka返回列表，localhost:8081、localhost:8082&lt;/li>
&lt;li>IRule利用内置负载均衡规则，从列表中选择一个，例如localhost:8081&lt;/li>
&lt;li>RibbonLoadBalancerClient修改请求地址，用localhost:8081替代userservice，得到http://localhost:8081/user/1，发起真实请求&lt;/li>
&lt;/ul>
&lt;h2 id="43负载均衡策略">
&lt;a href="#43%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%ad%96%e7%95%a5" class="header-anchor">#&lt;/a>
4.3.负载均衡策略
&lt;/h2>&lt;h3 id="431负载均衡策略">
&lt;a href="#431%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%ad%96%e7%95%a5" class="header-anchor">#&lt;/a>
4.3.1.负载均衡策略
&lt;/h3>&lt;p>负载均衡的规则都定义在IRule接口中，而IRule有很多不同的实现类：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-6d8e8e9d8e4aec.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713225653000"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>不同规则的含义如下：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>内置负载均衡规则类&lt;/strong>&lt;/th>
&lt;th>&lt;strong>规则描述&lt;/strong>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>RoundRobinRule&lt;/td>
&lt;td>简单轮询服务列表来选择服务器。它是Ribbon默认的负载均衡规则。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AvailabilityFilteringRule&lt;/td>
&lt;td>对以下两种服务器进行忽略： （1）在默认情况下，这台服务器如果3次连接失败，这台服务器就会被设置为“短路”状态。短路状态将持续30秒，如果再次连接失败，短路的持续时间就会几何级地增加。 （2）并发数过高的服务器。如果一个服务器的并发连接数过高，配置了AvailabilityFilteringRule规则的客户端也会将其忽略。并发连接数的上限，可以由客户端的&lt;clientName>.&lt;clientConfigNameSpace>.ActiveConnectionsLimit属性进行配置。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>WeightedResponseTimeRule&lt;/td>
&lt;td>为每一个服务器赋予一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>ZoneAvoidanceRule&lt;/strong>&lt;/td>
&lt;td>以区域可用的服务器为基础进行服务器的选择。使用Zone对服务器进行分类，这个Zone可以理解为一个机房、一个机架等。而后再对Zone内的多个服务做轮询。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>BestAvailableRule&lt;/td>
&lt;td>忽略那些短路的服务器，并选择并发数较低的服务器。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>RandomRule&lt;/td>
&lt;td>随机选择一个可用的服务器。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>RetryRule&lt;/td>
&lt;td>重试机制的选择逻辑&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>默认的实现就是ZoneAvoidanceRule，是一种轮询方案&lt;/p>
&lt;h3 id="432自定义负载均衡策略">
&lt;a href="#432%e8%87%aa%e5%ae%9a%e4%b9%89%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%ad%96%e7%95%a5" class="header-anchor">#&lt;/a>
4.3.2.自定义负载均衡策略
&lt;/h3>&lt;p>通过定义IRule实现可以修改负载均衡规则，有两种方式：&lt;/p>
&lt;ol>
&lt;li>代码方式：在order-service中的OrderApplication类中，定义一个新的IRule：&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IRule&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">randomRule&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RandomRule&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>配置文件方式：在order-service的application.yml文件中，添加新的配置也可以修改规则：&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">userservice&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 给某个微服务配置负载均衡规则，这里是userservice服务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ribbon&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">NFLoadBalancerRuleClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">com.netflix.loadbalancer.RandomRule&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 负载均衡规则 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>&lt;strong>注意&lt;/strong>，一般用默认的负载均衡规则，不做修改。&lt;/p>
&lt;/blockquote>
&lt;h2 id="44饥饿加载">
&lt;a href="#44%e9%a5%a5%e9%a5%bf%e5%8a%a0%e8%bd%bd" class="header-anchor">#&lt;/a>
4.4.饥饿加载
&lt;/h2>&lt;p>Ribbon默认是采用懒加载，即第一次访问时才会去创建LoadBalanceClient，请求时间会很长。&lt;/p>
&lt;p>而饥饿加载则会在项目启动时创建，降低第一次访问的耗时，通过下面配置开启饥饿加载：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">ribbon&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">eager-load&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">enabled&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">clients&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">userservice&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="5nacos注册中心">
&lt;a href="#5nacos%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83" class="header-anchor">#&lt;/a>
5.Nacos注册中心
&lt;/h1>&lt;p>国内公司一般都推崇阿里巴巴的技术，比如注册中心，SpringCloudAlibaba也推出了一个名为Nacos的注册中心。&lt;/p>
&lt;h2 id="51认识和安装nacos">
&lt;a href="#51%e8%ae%a4%e8%af%86%e5%92%8c%e5%ae%89%e8%a3%85nacos" class="header-anchor">#&lt;/a>
5.1.认识和安装Nacos
&lt;/h2>&lt;p>&lt;a class="link" href="https://nacos.io/" target="_blank" rel="noopener"
>Nacos
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>是阿里巴巴的产品，现在是&lt;a class="link" href="https://spring.io/projects/spring-cloud" target="_blank" rel="noopener"
>SpringCloud
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>中的一个组件。相比&lt;a class="link" href="https://github.com/Netflix/eureka" target="_blank" rel="noopener"
>Eureka
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>功能更加丰富，在国内受欢迎程度较高。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-282dd7a06c9a48.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713230444308"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>安装方式可以参考课前资料《Nacos安装指南.md》&lt;/p>
&lt;h2 id="52服务注册到nacos">
&lt;a href="#52%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e5%88%b0nacos" class="header-anchor">#&lt;/a>
5.2.服务注册到nacos
&lt;/h2>&lt;p>Nacos是SpringCloudAlibaba的组件，而SpringCloudAlibaba也遵循SpringCloud中定义的服务注册、服务发现规范。因此使用Nacos和使用Eureka对于微服务来说，并没有太大区别。&lt;/p>
&lt;p>主要差异在于：&lt;/p>
&lt;ul>
&lt;li>依赖不同&lt;/li>
&lt;li>服务地址不同&lt;/li>
&lt;/ul>
&lt;h3 id="1引入依赖-2">
&lt;a href="#1%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96-2" class="header-anchor">#&lt;/a>
1）引入依赖
&lt;/h3>&lt;p>在cloud-demo父工程的pom文件中的&lt;code>&amp;lt;dependencyManagement&amp;gt;&lt;/code>中引入SpringCloudAlibaba的依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-5">&lt;a class="lnlinks" href="#hl-11-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-6">&lt;a class="lnlinks" href="#hl-11-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-7">&lt;a class="lnlinks" href="#hl-11-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.alibaba.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-alibaba-dependencies&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>2.2.6.RELEASE&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;type&amp;gt;&lt;/span>pom&lt;span class="nt">&amp;lt;/type&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;scope&amp;gt;&lt;/span>import&lt;span class="nt">&amp;lt;/scope&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后在user-service和order-service中的pom文件中引入nacos-discovery依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.alibaba.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-alibaba-nacos-discovery&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>&lt;strong>注意&lt;/strong>：不要忘了注释掉eureka的依赖。&lt;/p>
&lt;/blockquote>
&lt;h3 id="2配置nacos地址">
&lt;a href="#2%e9%85%8d%e7%bd%aenacos%e5%9c%b0%e5%9d%80" class="header-anchor">#&lt;/a>
2）配置nacos地址
&lt;/h3>&lt;p>在user-service和order-service的application.yml中添加nacos地址：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server-addr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost:8848&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>&lt;strong>注意&lt;/strong>：不要忘了注释掉eureka的地址&lt;/p>
&lt;/blockquote>
&lt;h3 id="3重启">
&lt;a href="#3%e9%87%8d%e5%90%af" class="header-anchor">#&lt;/a>
3）重启
&lt;/h3>&lt;p>重启微服务后，登录nacos管理页面，可以看到微服务信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-eed3c224fd4737.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713231439607"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="53服务分级存储模型">
&lt;a href="#53%e6%9c%8d%e5%8a%a1%e5%88%86%e7%ba%a7%e5%ad%98%e5%82%a8%e6%a8%a1%e5%9e%8b" class="header-anchor">#&lt;/a>
5.3.服务分级存储模型
&lt;/h2>&lt;p>一个&lt;strong>服务&lt;/strong>可以有多个&lt;strong>实例&lt;/strong>，例如我们的user-service，可以有:&lt;/p>
&lt;ul>
&lt;li>127.0.0.1:8081&lt;/li>
&lt;li>127.0.0.1:8082&lt;/li>
&lt;li>127.0.0.1:8083&lt;/li>
&lt;/ul>
&lt;p>假如这些实例分布于全国各地的不同机房，例如：&lt;/p>
&lt;ul>
&lt;li>127.0.0.1:8081，在上海机房&lt;/li>
&lt;li>127.0.0.1:8082，在上海机房&lt;/li>
&lt;li>127.0.0.1:8083，在杭州机房&lt;/li>
&lt;/ul>
&lt;p>Nacos就将同一机房内的实例 划分为一个&lt;strong>集群&lt;/strong>。&lt;/p>
&lt;p>也就是说，user-service是服务，一个服务可以包含多个集群，如杭州、上海，每个集群下可以有多个实例，形成分级模型，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-0431eeea9ab1ed.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713232522531"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>微服务互相访问时，应该尽可能访问同集群实例，因为本地访问速度更快。当本集群内不可用时，才访问其它集群。例如：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-662350aca151c4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713232658928"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>杭州机房内的order-service应该优先访问同机房的user-service。&lt;/p>
&lt;h3 id="531给user-service配置集群">
&lt;a href="#531%e7%bb%99user-service%e9%85%8d%e7%bd%ae%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
5.3.1.给user-service配置集群
&lt;/h3>&lt;p>修改user-service的application.yml文件，添加集群配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-5">&lt;a class="lnlinks" href="#hl-14-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-6">&lt;a class="lnlinks" href="#hl-14-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server-addr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost:8848&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">discovery&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cluster-name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">HZ&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 集群名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启两个user-service实例后，我们可以在nacos控制台看到下面结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-463d7e6c7ee441.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713232916215"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们再次复制一个user-service启动配置，添加属性：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">-Dserver.port&lt;span class="o">=&lt;/span>&lt;span class="m">8083&lt;/span> -Dspring.cloud.nacos.discovery.cluster-name&lt;span class="o">=&lt;/span>SH
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>配置如图所示：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-2feebca061cd40.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713233528982"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>启动UserApplication3后再次查看nacos控制台：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-c93f19bb52b619.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713233727923"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="532同集群优先的负载均衡">
&lt;a href="#532%e5%90%8c%e9%9b%86%e7%be%a4%e4%bc%98%e5%85%88%e7%9a%84%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" class="header-anchor">#&lt;/a>
5.3.2.同集群优先的负载均衡
&lt;/h3>&lt;p>默认的&lt;code>ZoneAvoidanceRule&lt;/code>并不能实现根据同集群优先来实现负载均衡。&lt;/p>
&lt;p>因此Nacos中提供了一个&lt;code>NacosRule&lt;/code>的实现，可以优先从同集群中挑选实例。&lt;/p>
&lt;p>1）给order-service配置集群信息&lt;/p>
&lt;p>修改order-service的application.yml文件，添加集群配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">spring:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cloud:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nacos:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server-addr: localhost:8848
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> discovery:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster-name: HZ &lt;span class="c1"># 集群名称&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）修改负载均衡规则&lt;/p>
&lt;p>修改order-service的application.yml文件，修改负载均衡规则：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">userservice&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ribbon&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">NFLoadBalancerRuleClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">com.alibaba.cloud.nacos.ribbon.NacosRule&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 负载均衡规则 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="54权重配置">
&lt;a href="#54%e6%9d%83%e9%87%8d%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
5.4.权重配置
&lt;/h2>&lt;p>实际部署中会出现这样的场景：&lt;/p>
&lt;p>服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求。&lt;/p>
&lt;p>但默认情况下NacosRule是同集群内随机挑选，不会考虑机器的性能问题。&lt;/p>
&lt;p>因此，Nacos提供了权重配置来控制访问频率，权重越大则访问频率越高。&lt;/p>
&lt;p>在nacos控制台，找到user-service的实例列表，点击编辑，即可修改权重：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-9276f165ea963b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713235133225"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在弹出的编辑窗口，修改权重：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-da55227d5cb54d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713235235219"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>注意&lt;/strong>：如果权重修改为0，则该实例永远不会被访问&lt;/p>
&lt;/blockquote>
&lt;h2 id="55环境隔离">
&lt;a href="#55%e7%8e%af%e5%a2%83%e9%9a%94%e7%a6%bb" class="header-anchor">#&lt;/a>
5.5.环境隔离
&lt;/h2>&lt;p>Nacos提供了namespace来实现环境隔离功能。&lt;/p>
&lt;ul>
&lt;li>nacos中可以有多个namespace&lt;/li>
&lt;li>namespace下可以有group、service等&lt;/li>
&lt;li>不同namespace之间相互隔离，例如不同namespace的服务互相不可见&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-a06af0d99675ad.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714000101516"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="551创建namespace">
&lt;a href="#551%e5%88%9b%e5%bb%banamespace" class="header-anchor">#&lt;/a>
5.5.1.创建namespace
&lt;/h3>&lt;p>默认情况下，所有service、data、group都在同一个namespace，名为public：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-74d3683551affb.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714000414781"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们可以点击页面新增按钮，添加一个namespace：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-8e609c509c8f82.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714000440143"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后，填写表单：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-210831bd7b94d0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714000505928"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>就能在页面看到一个新的namespace：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-48bed856c71924.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714000522913"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="552给微服务配置namespace">
&lt;a href="#552%e7%bb%99%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%85%8d%e7%bd%aenamespace" class="header-anchor">#&lt;/a>
5.5.2.给微服务配置namespace
&lt;/h3>&lt;p>给微服务配置namespace只能通过修改配置来实现。&lt;/p>
&lt;p>例如，修改order-service的application.yml文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-5">&lt;a class="lnlinks" href="#hl-18-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-6">&lt;a class="lnlinks" href="#hl-18-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-7">&lt;a class="lnlinks" href="#hl-18-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server-addr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost:8848&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">discovery&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cluster-name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">HZ&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">492a7d5d-237b-46a1-a99a-fa8e98e4b0f9&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 命名空间，填ID&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启order-service后，访问控制台，可以看到下面的结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-cee41a9a0357dd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714000830703"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-e3b1bea18c2f17.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714000837140"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>此时访问order-service，因为namespace不同，会导致找不到userservice，控制台会报错：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-cef5d409ebf04a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714000941256"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="56nacos与eureka的区别">
&lt;a href="#56nacos%e4%b8%8eeureka%e7%9a%84%e5%8c%ba%e5%88%ab" class="header-anchor">#&lt;/a>
5.6.Nacos与Eureka的区别
&lt;/h2>&lt;p>Nacos的服务实例分为两种l类型：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>临时实例：如果实例宕机超过一定时间，会从服务列表剔除，默认的类型。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>非临时实例：如果实例宕机，不会从服务列表剔除，也可以叫永久实例。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>配置一个服务实例为永久实例：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-5">&lt;a class="lnlinks" href="#hl-19-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">discovery&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ephemeral&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 设置为非临时实例&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Nacos和Eureka整体结构类似，服务注册、服务拉取、心跳等待，但是也存在一些差异：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653736909-25fe0e81a59833.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714001728017"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Nacos与eureka的共同点&lt;/p>
&lt;ul>
&lt;li>都支持服务注册和服务拉取&lt;/li>
&lt;li>都支持服务提供者心跳方式做健康检测&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Nacos与Eureka的区别&lt;/p>
&lt;ul>
&lt;li>Nacos支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式&lt;/li>
&lt;li>临时实例心跳不正常会被剔除，非临时实例则不会被剔除&lt;/li>
&lt;li>Nacos支持服务列表变更的消息推送模式，服务列表更新更及时&lt;/li>
&lt;li>Nacos集群默认采用AP方式，当集群中存在非临时实例时，采用CP模式；Eureka采用AP方式&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></description></item><item><title>10.Redis集群</title><link>https://logan.wssw.fun/p/2023/01/91a71491/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/91a71491/</guid><description>&lt;h1 id="redis集群">
&lt;a href="#redis%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
Redis集群
&lt;/h1>&lt;p>本章是基于CentOS7下的Redis集群教程，包括：&lt;/p>
&lt;ul>
&lt;li>单机安装Redis&lt;/li>
&lt;li>Redis主从&lt;/li>
&lt;li>Redis分片集群&lt;/li>
&lt;/ul>
&lt;h1 id="1单机安装redis">
&lt;a href="#1%e5%8d%95%e6%9c%ba%e5%ae%89%e8%a3%85redis" class="header-anchor">#&lt;/a>
1.单机安装Redis
&lt;/h1>&lt;p>首先需要安装Redis所需要的依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">yum install -y gcc tcl
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后将课前资料提供的Redis安装包上传到虚拟机的任意目录：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-9d5e44b5935567.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210629114325516"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>例如，我放到了/tmp目录：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-b9f62daf6946a6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210629114830642"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解压缩：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">tar -xvf redis-6.2.4.tar.gz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>解压后：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-90e2fcc6c636de.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210629114941810"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>进入redis目录：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> redis-6.2.4
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>运行编译命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">make &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> make install
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果没有出错，应该就安装成功了。&lt;/p>
&lt;p>然后修改redis.conf文件中的一些配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 绑定地址，默认是127.0.0.1，会导致只能在本地访问。修改为0.0.0.0则可以在任意IP访问&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">bind&lt;/span> &lt;span class="s">0.0.0.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 数据库数量，设置为1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">databases&lt;/span> &lt;span class="s">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>启动Redis：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">redis-server redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>停止redis服务：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">redis-cli shutdown
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="2redis主从集群">
&lt;a href="#2redis%e4%b8%bb%e4%bb%8e%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
2.Redis主从集群
&lt;/h1>&lt;h2 id="21集群结构">
&lt;a href="#21%e9%9b%86%e7%be%a4%e7%bb%93%e6%9e%84" class="header-anchor">#&lt;/a>
2.1.集群结构
&lt;/h2>&lt;p>我们搭建的主从集群结构如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-6fc7d3e942c2fa.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210630111505799"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>共包含三个节点，一个主节点，两个从节点。&lt;/p>
&lt;p>这里我们会在同一台虚拟机中开启3个redis实例，模拟主从集群，信息如下：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:center">IP&lt;/th>
&lt;th style="text-align:center">PORT&lt;/th>
&lt;th style="text-align:center">角色&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:center">192.168.150.101&lt;/td>
&lt;td style="text-align:center">7001&lt;/td>
&lt;td style="text-align:center">master&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">192.168.150.101&lt;/td>
&lt;td style="text-align:center">7002&lt;/td>
&lt;td style="text-align:center">slave&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">192.168.150.101&lt;/td>
&lt;td style="text-align:center">7003&lt;/td>
&lt;td style="text-align:center">slave&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="22准备实例和配置">
&lt;a href="#22%e5%87%86%e5%a4%87%e5%ae%9e%e4%be%8b%e5%92%8c%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
2.2.准备实例和配置
&lt;/h2>&lt;p>要在同一台虚拟机开启3个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。&lt;/p>
&lt;p>1）创建目录&lt;/p>
&lt;p>我们创建三个文件夹，名字分别叫7001、7002、7003：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入/tmp目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 创建目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir &lt;span class="m">7001&lt;/span> &lt;span class="m">7002&lt;/span> &lt;span class="m">7003&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-b7e48d3d91be81.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210630113929868"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>2）恢复原始配置&lt;/p>
&lt;p>修改redis-6.2.4/redis.conf文件，将其中的持久化模式改为默认的RDB模式，AOF保持关闭状态。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-6">&lt;a class="lnlinks" href="#hl-8-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-7">&lt;a class="lnlinks" href="#hl-8-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-8">&lt;a class="lnlinks" href="#hl-8-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 开启RDB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># save &amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">save&lt;/span> &lt;span class="s">3600 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">save&lt;/span> &lt;span class="s">300 100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">save&lt;/span> &lt;span class="s">60 10000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 关闭AOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">appendonly&lt;/span> &lt;span class="s">no&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）拷贝配置文件到每个实例目录&lt;/p>
&lt;p>然后将redis-6.2.4/redis.conf文件拷贝到三个目录中（在/tmp目录执行下列命令）：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-5">&lt;a class="lnlinks" href="#hl-9-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-6">&lt;a class="lnlinks" href="#hl-9-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 方式一：逐个拷贝&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp redis-6.2.4/redis.conf &lt;span class="m">7001&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp redis-6.2.4/redis.conf &lt;span class="m">7002&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp redis-6.2.4/redis.conf &lt;span class="m">7003&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 方式二：管道组合命令，一键拷贝&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="m">7001&lt;/span> &lt;span class="m">7002&lt;/span> &lt;span class="m">7003&lt;/span> &lt;span class="p">|&lt;/span> xargs -t -n &lt;span class="m">1&lt;/span> cp redis-6.2.4/redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4）修改每个实例的端口、工作目录&lt;/p>
&lt;p>修改每个文件夹内的配置文件，将端口分别修改为7001、7002、7003，将rdb文件保存位置都修改为自己所在目录（在/tmp目录执行下列命令）：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">sed -i -e &lt;span class="s1">&amp;#39;s/6379/7001/g&amp;#39;&lt;/span> -e &lt;span class="s1">&amp;#39;s/dir .\//dir \/tmp\/7001\//g&amp;#39;&lt;/span> 7001/redis.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i -e &lt;span class="s1">&amp;#39;s/6379/7002/g&amp;#39;&lt;/span> -e &lt;span class="s1">&amp;#39;s/dir .\//dir \/tmp\/7002\//g&amp;#39;&lt;/span> 7002/redis.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i -e &lt;span class="s1">&amp;#39;s/6379/7003/g&amp;#39;&lt;/span> -e &lt;span class="s1">&amp;#39;s/dir .\//dir \/tmp\/7003\//g&amp;#39;&lt;/span> 7003/redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>5）修改每个实例的声明IP&lt;/p>
&lt;p>虚拟机本身有多个IP，为了避免将来混乱，我们需要在redis.conf文件中指定每一个实例的绑定ip信息，格式如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># redis实例的声明 IP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">replica-announce-ip&lt;/span> &lt;span class="s">192.168.150.101&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>每个目录都要改，我们一键完成修改（在/tmp目录执行下列命令）：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-6">&lt;a class="lnlinks" href="#hl-12-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-7">&lt;a class="lnlinks" href="#hl-12-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 逐一执行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;1a replica-announce-ip 192.168.150.101&amp;#39;&lt;/span> 7001/redis.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;1a replica-announce-ip 192.168.150.101&amp;#39;&lt;/span> 7002/redis.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;1a replica-announce-ip 192.168.150.101&amp;#39;&lt;/span> 7003/redis.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 或者一键修改&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">printf&lt;/span> &lt;span class="s1">&amp;#39;%s\n&amp;#39;&lt;/span> &lt;span class="m">7001&lt;/span> &lt;span class="m">7002&lt;/span> &lt;span class="m">7003&lt;/span> &lt;span class="p">|&lt;/span> xargs -I&lt;span class="o">{}&lt;/span> -t sed -i &lt;span class="s1">&amp;#39;1a replica-announce-ip 192.168.150.101&amp;#39;&lt;/span> &lt;span class="o">{}&lt;/span>/redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="23启动">
&lt;a href="#23%e5%90%af%e5%8a%a8" class="header-anchor">#&lt;/a>
2.3.启动
&lt;/h2>&lt;p>为了方便查看日志，我们打开3个ssh窗口，分别启动3个redis实例，启动命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-6">&lt;a class="lnlinks" href="#hl-13-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 第1个&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-server 7001/redis.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 第2个&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-server 7002/redis.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 第3个&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-server 7003/redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>启动后：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-3c704a2d75b2ff.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210630183914491"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如果要一键停止，可以运行下面命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">printf&lt;/span> &lt;span class="s1">&amp;#39;%s\n&amp;#39;&lt;/span> &lt;span class="m">7001&lt;/span> &lt;span class="m">7002&lt;/span> &lt;span class="m">7003&lt;/span> &lt;span class="p">|&lt;/span> xargs -I&lt;span class="o">{}&lt;/span> -t redis-cli -p &lt;span class="o">{}&lt;/span> shutdown
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="24开启主从关系">
&lt;a href="#24%e5%bc%80%e5%90%af%e4%b8%bb%e4%bb%8e%e5%85%b3%e7%b3%bb" class="header-anchor">#&lt;/a>
2.4.开启主从关系
&lt;/h2>&lt;p>现在三个实例还没有任何关系，要配置主从可以使用replicaof 或者slaveof（5.0以前）命令。&lt;/p>
&lt;p>有临时和永久两种模式：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>修改配置文件（永久生效）&lt;/p>
&lt;ul>
&lt;li>在redis.conf中添加一行配置：&lt;code>slaveof &amp;lt;masterip&amp;gt; &amp;lt;masterport&amp;gt;&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>使用redis-cli客户端连接到redis服务，执行slaveof命令（重启后失效）：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">slaveof &amp;lt;masterip&amp;gt; &amp;lt;masterport&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>&lt;font color='red'>注意&lt;/font>&lt;/strong>：在5.0以后新增命令replicaof，与salveof效果一致。&lt;/p>
&lt;p>这里我们为了演示方便，使用方式二。&lt;/p>
&lt;p>通过redis-cli命令连接7002，执行下面命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 连接 7002&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-cli -p &lt;span class="m">7002&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 执行slaveof&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">slaveof 192.168.150.101 &lt;span class="m">7001&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>通过redis-cli命令连接7003，执行下面命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-4">&lt;a class="lnlinks" href="#hl-17-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 连接 7003&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-cli -p &lt;span class="m">7003&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 执行slaveof&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">slaveof 192.168.150.101 &lt;span class="m">7001&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后连接 7001节点，查看集群状态：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 连接 7001&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-cli -p &lt;span class="m">7001&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看状态&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">info replication
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-fbfac01fd175fb.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210630201258802"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="25测试">
&lt;a href="#25%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
2.5.测试
&lt;/h2>&lt;p>执行下列操作以测试：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>利用redis-cli连接7001，执行&lt;code>set num 123&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>利用redis-cli连接7002，执行&lt;code>get num&lt;/code>，再执行&lt;code>set num 666&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>利用redis-cli连接7003，执行&lt;code>get num&lt;/code>，再执行&lt;code>set num 888&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>可以发现，只有在7001这个master节点上可以执行写操作，7002和7003这两个slave节点只能执行读操作。&lt;/p>
&lt;h1 id="3搭建哨兵集群">
&lt;a href="#3%e6%90%ad%e5%bb%ba%e5%93%a8%e5%85%b5%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
3.搭建哨兵集群
&lt;/h1>&lt;h2 id="31集群结构">
&lt;a href="#31%e9%9b%86%e7%be%a4%e7%bb%93%e6%9e%84" class="header-anchor">#&lt;/a>
3.1.集群结构
&lt;/h2>&lt;p>这里我们搭建一个三节点形成的Sentinel集群，来监管之前的Redis主从集群。如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-c5cbdb056077ae.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210701215227018"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>三个sentinel实例信息如下：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>节点&lt;/th>
&lt;th style="text-align:center">IP&lt;/th>
&lt;th style="text-align:center">PORT&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>s1&lt;/td>
&lt;td style="text-align:center">192.168.150.101&lt;/td>
&lt;td style="text-align:center">27001&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>s2&lt;/td>
&lt;td style="text-align:center">192.168.150.101&lt;/td>
&lt;td style="text-align:center">27002&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>s3&lt;/td>
&lt;td style="text-align:center">192.168.150.101&lt;/td>
&lt;td style="text-align:center">27003&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="32准备实例和配置">
&lt;a href="#32%e5%87%86%e5%a4%87%e5%ae%9e%e4%be%8b%e5%92%8c%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
3.2.准备实例和配置
&lt;/h2>&lt;p>要在同一台虚拟机开启3个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。&lt;/p>
&lt;p>我们创建三个文件夹，名字分别叫s1、s2、s3：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入/tmp目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 创建目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir s1 s2 s3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-53963280d349e5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210701215534714"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后我们在s1目录创建一个sentinel.conf文件，添加下面的内容：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-4">&lt;a class="lnlinks" href="#hl-20-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-5">&lt;a class="lnlinks" href="#hl-20-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-6">&lt;a class="lnlinks" href="#hl-20-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="na">port 27001&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">sentinel announce-ip 192.168.150.101&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">sentinel monitor mymaster 192.168.150.101 7001 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">sentinel down-after-milliseconds mymaster 5000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">sentinel failover-timeout mymaster 60000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">dir &amp;#34;/tmp/s1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>解读：&lt;/p>
&lt;ul>
&lt;li>&lt;code>port 27001&lt;/code>：是当前sentinel实例的端口&lt;/li>
&lt;li>&lt;code>sentinel monitor mymaster 192.168.150.101 7001 2&lt;/code>：指定主节点信息
&lt;ul>
&lt;li>&lt;code>mymaster&lt;/code>：主节点名称，自定义，任意写&lt;/li>
&lt;li>&lt;code>192.168.150.101 7001&lt;/code>：主节点的ip和端口&lt;/li>
&lt;li>&lt;code>2&lt;/code>：选举master时的quorum值&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>然后将s1/sentinel.conf文件拷贝到s2、s3两个目录中（在/tmp目录执行下列命令）：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-21-1">&lt;a class="lnlinks" href="#hl-21-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-2">&lt;a class="lnlinks" href="#hl-21-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-3">&lt;a class="lnlinks" href="#hl-21-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-4">&lt;a class="lnlinks" href="#hl-21-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-5">&lt;a class="lnlinks" href="#hl-21-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 方式一：逐个拷贝&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp s1/sentinel.conf s2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp s1/sentinel.conf s3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 方式二：管道组合命令，一键拷贝&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> s2 s3 &lt;span class="p">|&lt;/span> xargs -t -n &lt;span class="m">1&lt;/span> cp s1/sentinel.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改s2、s3两个文件夹内的配置文件，将端口分别修改为27002、27003：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-22-1">&lt;a class="lnlinks" href="#hl-22-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-2">&lt;a class="lnlinks" href="#hl-22-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">sed -i -e &lt;span class="s1">&amp;#39;s/27001/27002/g&amp;#39;&lt;/span> -e &lt;span class="s1">&amp;#39;s/s1/s2/g&amp;#39;&lt;/span> s2/sentinel.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i -e &lt;span class="s1">&amp;#39;s/27001/27003/g&amp;#39;&lt;/span> -e &lt;span class="s1">&amp;#39;s/s1/s3/g&amp;#39;&lt;/span> s3/sentinel.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="33启动">
&lt;a href="#33%e5%90%af%e5%8a%a8" class="header-anchor">#&lt;/a>
3.3.启动
&lt;/h2>&lt;p>为了方便查看日志，我们打开3个ssh窗口，分别启动3个redis实例，启动命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-23-1">&lt;a class="lnlinks" href="#hl-23-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-2">&lt;a class="lnlinks" href="#hl-23-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-3">&lt;a class="lnlinks" href="#hl-23-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-4">&lt;a class="lnlinks" href="#hl-23-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-5">&lt;a class="lnlinks" href="#hl-23-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-6">&lt;a class="lnlinks" href="#hl-23-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 第1个&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-sentinel s1/sentinel.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 第2个&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-sentinel s2/sentinel.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 第3个&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-sentinel s3/sentinel.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>启动后：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-78ddd564e492ce.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210701220714104"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="34测试">
&lt;a href="#34%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
3.4.测试
&lt;/h2>&lt;p>尝试让master节点7001宕机，查看sentinel日志：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-88314d58cb8cb2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210701222857997"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>查看7003的日志：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-e7f998021a8251.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210701223025709"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>查看7002的日志：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-e3db30abdbcd87.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210701223131264"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="4搭建分片集群">
&lt;a href="#4%e6%90%ad%e5%bb%ba%e5%88%86%e7%89%87%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.搭建分片集群
&lt;/h1>&lt;h2 id="41集群结构">
&lt;a href="#41%e9%9b%86%e7%be%a4%e7%bb%93%e6%9e%84" class="header-anchor">#&lt;/a>
4.1.集群结构
&lt;/h2>&lt;p>分片集群需要的节点数量较多，这里我们搭建一个最小的分片集群，包含3个master节点，每个master包含一个slave节点，结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-55b58f56eb1fa3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210702164116027"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这里我们会在同一台虚拟机中开启6个redis实例，模拟分片集群，信息如下：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:center">IP&lt;/th>
&lt;th style="text-align:center">PORT&lt;/th>
&lt;th style="text-align:center">角色&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:center">192.168.150.101&lt;/td>
&lt;td style="text-align:center">7001&lt;/td>
&lt;td style="text-align:center">master&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">192.168.150.101&lt;/td>
&lt;td style="text-align:center">7002&lt;/td>
&lt;td style="text-align:center">master&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">192.168.150.101&lt;/td>
&lt;td style="text-align:center">7003&lt;/td>
&lt;td style="text-align:center">master&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">192.168.150.101&lt;/td>
&lt;td style="text-align:center">8001&lt;/td>
&lt;td style="text-align:center">slave&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">192.168.150.101&lt;/td>
&lt;td style="text-align:center">8002&lt;/td>
&lt;td style="text-align:center">slave&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">192.168.150.101&lt;/td>
&lt;td style="text-align:center">8003&lt;/td>
&lt;td style="text-align:center">slave&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="42准备实例和配置">
&lt;a href="#42%e5%87%86%e5%a4%87%e5%ae%9e%e4%be%8b%e5%92%8c%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
4.2.准备实例和配置
&lt;/h2>&lt;p>删除之前的7001、7002、7003这几个目录，重新创建出7001、7002、7003、8001、8002、8003目录：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-24-1">&lt;a class="lnlinks" href="#hl-24-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-2">&lt;a class="lnlinks" href="#hl-24-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-3">&lt;a class="lnlinks" href="#hl-24-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-4">&lt;a class="lnlinks" href="#hl-24-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-5">&lt;a class="lnlinks" href="#hl-24-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-6">&lt;a class="lnlinks" href="#hl-24-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入/tmp目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 删除旧的，避免配置干扰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf &lt;span class="m">7001&lt;/span> &lt;span class="m">7002&lt;/span> &lt;span class="m">7003&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 创建目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir &lt;span class="m">7001&lt;/span> &lt;span class="m">7002&lt;/span> &lt;span class="m">7003&lt;/span> &lt;span class="m">8001&lt;/span> &lt;span class="m">8002&lt;/span> &lt;span class="m">8003&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在/tmp下准备一个新的redis.conf文件，内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-25-1">&lt;a class="lnlinks" href="#hl-25-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-2">&lt;a class="lnlinks" href="#hl-25-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-3">&lt;a class="lnlinks" href="#hl-25-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-4">&lt;a class="lnlinks" href="#hl-25-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-5">&lt;a class="lnlinks" href="#hl-25-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-6">&lt;a class="lnlinks" href="#hl-25-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-7">&lt;a class="lnlinks" href="#hl-25-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-8">&lt;a class="lnlinks" href="#hl-25-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-9">&lt;a class="lnlinks" href="#hl-25-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-10">&lt;a class="lnlinks" href="#hl-25-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-11">&lt;a class="lnlinks" href="#hl-25-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-12">&lt;a class="lnlinks" href="#hl-25-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-13">&lt;a class="lnlinks" href="#hl-25-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-14">&lt;a class="lnlinks" href="#hl-25-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-15">&lt;a class="lnlinks" href="#hl-25-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-16">&lt;a class="lnlinks" href="#hl-25-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-17">&lt;a class="lnlinks" href="#hl-25-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-18">&lt;a class="lnlinks" href="#hl-25-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-19">&lt;a class="lnlinks" href="#hl-25-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-20">&lt;a class="lnlinks" href="#hl-25-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-21">&lt;a class="lnlinks" href="#hl-25-21">21&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="na">port 6379&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 开启集群功能&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">cluster-enabled yes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 集群的配置文件名称，不需要我们创建，由redis自己维护&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">cluster-config-file /tmp/6379/nodes.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 节点心跳失败的超时时间&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">cluster-node-timeout 5000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 持久化文件存放目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">dir /tmp/6379&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 绑定地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">bind 0.0.0.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 让redis后台运行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">daemonize yes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 注册的实例ip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">replica-announce-ip 192.168.150.101&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 保护模式&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">protected-mode no&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 数据库数量&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">databases 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 日志&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">logfile /tmp/6379/run.log&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>将这个文件拷贝到每个目录下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-26-1">&lt;a class="lnlinks" href="#hl-26-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-2">&lt;a class="lnlinks" href="#hl-26-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-3">&lt;a class="lnlinks" href="#hl-26-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-4">&lt;a class="lnlinks" href="#hl-26-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入/tmp目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 执行拷贝&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="m">7001&lt;/span> &lt;span class="m">7002&lt;/span> &lt;span class="m">7003&lt;/span> &lt;span class="m">8001&lt;/span> &lt;span class="m">8002&lt;/span> &lt;span class="m">8003&lt;/span> &lt;span class="p">|&lt;/span> xargs -t -n &lt;span class="m">1&lt;/span> cp redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改每个目录下的redis.conf，将其中的6379修改为与所在目录一致：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-27-1">&lt;a class="lnlinks" href="#hl-27-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-2">&lt;a class="lnlinks" href="#hl-27-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-3">&lt;a class="lnlinks" href="#hl-27-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-4">&lt;a class="lnlinks" href="#hl-27-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入/tmp目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 修改配置文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">printf&lt;/span> &lt;span class="s1">&amp;#39;%s\n&amp;#39;&lt;/span> &lt;span class="m">7001&lt;/span> &lt;span class="m">7002&lt;/span> &lt;span class="m">7003&lt;/span> &lt;span class="m">8001&lt;/span> &lt;span class="m">8002&lt;/span> &lt;span class="m">8003&lt;/span> &lt;span class="p">|&lt;/span> xargs -I&lt;span class="o">{}&lt;/span> -t sed -i &lt;span class="s1">&amp;#39;s/6379/{}/g&amp;#39;&lt;/span> &lt;span class="o">{}&lt;/span>/redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="43启动">
&lt;a href="#43%e5%90%af%e5%8a%a8" class="header-anchor">#&lt;/a>
4.3.启动
&lt;/h2>&lt;p>因为已经配置了后台启动模式，所以可以直接启动服务：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-28-1">&lt;a class="lnlinks" href="#hl-28-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-2">&lt;a class="lnlinks" href="#hl-28-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-3">&lt;a class="lnlinks" href="#hl-28-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-4">&lt;a class="lnlinks" href="#hl-28-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入/tmp目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 一键启动所有服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">printf&lt;/span> &lt;span class="s1">&amp;#39;%s\n&amp;#39;&lt;/span> &lt;span class="m">7001&lt;/span> &lt;span class="m">7002&lt;/span> &lt;span class="m">7003&lt;/span> &lt;span class="m">8001&lt;/span> &lt;span class="m">8002&lt;/span> &lt;span class="m">8003&lt;/span> &lt;span class="p">|&lt;/span> xargs -I&lt;span class="o">{}&lt;/span> -t redis-server &lt;span class="o">{}&lt;/span>/redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>通过ps查看状态：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-29-1">&lt;a class="lnlinks" href="#hl-29-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">ps -ef &lt;span class="p">|&lt;/span> grep redis
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>发现服务都已经正常启动：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-392f49a55fa89c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210702174255799"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如果要关闭所有进程，可以执行命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-30-1">&lt;a class="lnlinks" href="#hl-30-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">ps -ef &lt;span class="p">|&lt;/span> grep redis &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> xargs &lt;span class="nb">kill&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>或者（推荐这种方式）：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-31-1">&lt;a class="lnlinks" href="#hl-31-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">printf&lt;/span> &lt;span class="s1">&amp;#39;%s\n&amp;#39;&lt;/span> &lt;span class="m">7001&lt;/span> &lt;span class="m">7002&lt;/span> &lt;span class="m">7003&lt;/span> &lt;span class="m">8001&lt;/span> &lt;span class="m">8002&lt;/span> &lt;span class="m">8003&lt;/span> &lt;span class="p">|&lt;/span> xargs -I&lt;span class="o">{}&lt;/span> -t redis-cli -p &lt;span class="o">{}&lt;/span> shutdown
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="44创建集群">
&lt;a href="#44%e5%88%9b%e5%bb%ba%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.4.创建集群
&lt;/h2>&lt;p>虽然服务启动了，但是目前每个服务之间都是独立的，没有任何关联。&lt;/p>
&lt;p>我们需要执行命令来创建集群，在Redis5.0之前创建集群比较麻烦，5.0之后集群管理命令都集成到了redis-cli中。&lt;/p>
&lt;p>1）Redis5.0之前&lt;/p>
&lt;p>Redis5.0之前集群命令都是用redis安装包下的src/redis-trib.rb来实现的。因为redis-trib.rb是有ruby语言编写的所以需要安装ruby环境。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-32-1">&lt;a class="lnlinks" href="#hl-32-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-2">&lt;a class="lnlinks" href="#hl-32-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-3">&lt;a class="lnlinks" href="#hl-32-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装依赖&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum -y install zlib ruby rubygems
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gem install redis
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后通过命令来管理集群：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-33-1">&lt;a class="lnlinks" href="#hl-33-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-2">&lt;a class="lnlinks" href="#hl-33-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-3">&lt;a class="lnlinks" href="#hl-33-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-4">&lt;a class="lnlinks" href="#hl-33-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入redis的src目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp/redis-6.2.4/src
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 创建集群&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./redis-trib.rb create --replicas &lt;span class="m">1&lt;/span> 192.168.150.101:7001 192.168.150.101:7002 192.168.150.101:7003 192.168.150.101:8001 192.168.150.101:8002 192.168.150.101:8003
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）Redis5.0以后&lt;/p>
&lt;p>我们使用的是Redis6.2.4版本，集群管理以及集成到了redis-cli中，格式如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-34-1">&lt;a class="lnlinks" href="#hl-34-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">redis-cli --cluster create --cluster-replicas &lt;span class="m">1&lt;/span> 192.168.150.101:7001 192.168.150.101:7002 192.168.150.101:7003 192.168.150.101:8001 192.168.150.101:8002 192.168.150.101:8003
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>命令说明：&lt;/p>
&lt;ul>
&lt;li>&lt;code>redis-cli --cluster&lt;/code>或者&lt;code>./redis-trib.rb&lt;/code>：代表集群操作命令&lt;/li>
&lt;li>&lt;code>create&lt;/code>：代表是创建集群&lt;/li>
&lt;li>&lt;code>--replicas 1&lt;/code>或者&lt;code>--cluster-replicas 1&lt;/code> ：指定集群中每个master的副本个数为1，此时&lt;code>节点总数 ÷ (replicas + 1)&lt;/code> 得到的就是master的数量。因此节点列表中的前n个就是master，其它节点都是slave节点，随机分配到不同master&lt;/li>
&lt;/ul>
&lt;p>运行后的样子：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-051d6691db03e8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210702181101969"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这里输入yes，则集群开始创建：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-9f320f791462ae.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210702181215705"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>通过命令可以查看集群状态：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-35-1">&lt;a class="lnlinks" href="#hl-35-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">redis-cli -p &lt;span class="m">7001&lt;/span> cluster nodes
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-c745a0d7567b59.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210702181922809"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="45测试">
&lt;a href="#45%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
4.5.测试
&lt;/h2>&lt;p>尝试连接7001节点，存储一个数据：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-36-1">&lt;a class="lnlinks" href="#hl-36-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-2">&lt;a class="lnlinks" href="#hl-36-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-3">&lt;a class="lnlinks" href="#hl-36-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-4">&lt;a class="lnlinks" href="#hl-36-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-5">&lt;a class="lnlinks" href="#hl-36-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-6">&lt;a class="lnlinks" href="#hl-36-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-7">&lt;a class="lnlinks" href="#hl-36-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-8">&lt;a class="lnlinks" href="#hl-36-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 连接&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">redis-cli -p &lt;span class="m">7001&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 存储数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> num &lt;span class="m">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 读取数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">get num
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 再次存储&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> a &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果悲剧了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-ea8a9464fdb958.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210702182343979"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>集群操作时，需要给&lt;code>redis-cli&lt;/code>加上&lt;code>-c&lt;/code>参数才可以：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-37-1">&lt;a class="lnlinks" href="#hl-37-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">redis-cli -c -p &lt;span class="m">7001&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这次可以了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740051-56345c9fcaf927.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210702182602145"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p></description></item><item><title>10.分布式缓存</title><link>https://logan.wssw.fun/p/2023/01/57138157/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/57138157/</guid><description>&lt;h1 id="分布式缓存">
&lt;a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%bc%93%e5%ad%98" class="header-anchor">#&lt;/a>
分布式缓存
&lt;/h1>&lt;p>&amp;ndash; 基于Redis集群解决单机Redis存在的问题&lt;/p>
&lt;p>单机的Redis存在四大问题：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-fbe81ffc0f24a3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725144240631"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="0学习目标">
&lt;a href="#0%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87" class="header-anchor">#&lt;/a>
0.学习目标
&lt;/h1>&lt;h1 id="1redis持久化">
&lt;a href="#1redis%e6%8c%81%e4%b9%85%e5%8c%96" class="header-anchor">#&lt;/a>
1.Redis持久化
&lt;/h1>&lt;p>Redis有两种持久化方案：&lt;/p>
&lt;ul>
&lt;li>RDB持久化&lt;/li>
&lt;li>AOF持久化&lt;/li>
&lt;/ul>
&lt;h2 id="11rdb持久化">
&lt;a href="#11rdb%e6%8c%81%e4%b9%85%e5%8c%96" class="header-anchor">#&lt;/a>
1.1.RDB持久化
&lt;/h2>&lt;p>RDB全称Redis Database Backup file（Redis数据备份文件），也被叫做Redis数据快照。简单来说就是把内存中的所有数据都记录到磁盘中。当Redis实例故障重启后，从磁盘读取快照文件，恢复数据。快照文件称为RDB文件，默认是保存在当前运行目录。&lt;/p>
&lt;h3 id="111执行时机">
&lt;a href="#111%e6%89%a7%e8%a1%8c%e6%97%b6%e6%9c%ba" class="header-anchor">#&lt;/a>
1.1.1.执行时机
&lt;/h3>&lt;p>RDB持久化在四种情况下会执行：&lt;/p>
&lt;ul>
&lt;li>执行save命令&lt;/li>
&lt;li>执行bgsave命令&lt;/li>
&lt;li>Redis停机时&lt;/li>
&lt;li>触发RDB条件时&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>1）save命令&lt;/strong>&lt;/p>
&lt;p>执行下面的命令，可以立即执行一次RDB：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-803f07e19f13f4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725144536958"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>save命令会导致主进程执行RDB，这个过程中其它所有命令都会被阻塞。只有在数据迁移时可能用到。&lt;/p>
&lt;p>&lt;strong>2）bgsave命令&lt;/strong>&lt;/p>
&lt;p>下面的命令可以异步执行RDB：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-3ff5ec152ebdd7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725144725943"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这个命令执行后会开启独立进程完成RDB，主进程可以持续处理用户请求，不受影响。&lt;/p>
&lt;p>&lt;strong>3）停机时&lt;/strong>&lt;/p>
&lt;p>Redis停机时会执行一次save命令，实现RDB持久化。&lt;/p>
&lt;p>&lt;strong>4）触发RDB条件&lt;/strong>&lt;/p>
&lt;p>Redis内部有触发RDB的机制，可以在redis.conf文件中找到，格式如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 900秒内，如果至少有1个key被修改，则执行bgsave ， 如果是save &amp;#34;&amp;#34; 则表示禁用RDB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">save&lt;/span> &lt;span class="s">900 1 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">save&lt;/span> &lt;span class="s">300 10 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">save&lt;/span> &lt;span class="s">60 10000 &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>RDB的其它配置也可以在redis.conf文件中设置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 是否压缩 ,建议不开启，压缩也会消耗cpu，磁盘的话不值钱&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">rdbcompression&lt;/span> &lt;span class="s">yes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># RDB文件名称&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">dbfilename&lt;/span> &lt;span class="s">dump.rdb &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 文件保存的路径目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">dir&lt;/span> &lt;span class="s">./ &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="112rdb原理">
&lt;a href="#112rdb%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
1.1.2.RDB原理
&lt;/h3>&lt;p>bgsave开始时会fork主进程得到子进程，子进程共享主进程的内存数据。完成fork后读取内存数据并写入 RDB 文件。&lt;/p>
&lt;p>fork采用的是copy-on-write技术：&lt;/p>
&lt;ul>
&lt;li>当主进程执行读操作时，访问共享内存；&lt;/li>
&lt;li>当主进程执行写操作时，则会拷贝一份数据，执行写操作。&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-f7c682b7b7c143.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725151319695"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="113小结">
&lt;a href="#113%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
1.1.3.小结
&lt;/h3>&lt;p>RDB方式bgsave的基本流程？&lt;/p>
&lt;ul>
&lt;li>fork主进程得到一个子进程，共享内存空间&lt;/li>
&lt;li>子进程读取内存数据并写入新的RDB文件&lt;/li>
&lt;li>用新RDB文件替换旧的RDB文件&lt;/li>
&lt;/ul>
&lt;p>RDB会在什么时候执行？save 60 1000代表什么含义？&lt;/p>
&lt;ul>
&lt;li>默认是服务停止时&lt;/li>
&lt;li>代表60秒内至少执行1000次修改则触发RDB&lt;/li>
&lt;/ul>
&lt;p>RDB的缺点？&lt;/p>
&lt;ul>
&lt;li>RDB执行间隔时间长，两次RDB之间写入数据有丢失的风险&lt;/li>
&lt;li>fork子进程、压缩、写出RDB文件都比较耗时&lt;/li>
&lt;/ul>
&lt;h2 id="12aof持久化">
&lt;a href="#12aof%e6%8c%81%e4%b9%85%e5%8c%96" class="header-anchor">#&lt;/a>
1.2.AOF持久化
&lt;/h2>&lt;h3 id="121aof原理">
&lt;a href="#121aof%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
1.2.1.AOF原理
&lt;/h3>&lt;p>AOF全称为Append Only File（追加文件）。Redis处理的每一个写命令都会记录在AOF文件，可以看做是命令日志文件。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-08bb88370d282c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725151543640"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="122aof配置">
&lt;a href="#122aof%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
1.2.2.AOF配置
&lt;/h3>&lt;p>AOF默认是关闭的，需要修改redis.conf配置文件来开启AOF：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 是否开启AOF功能，默认是no&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">appendonly&lt;/span> &lt;span class="s">yes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># AOF文件的名称&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">appendfilename&lt;/span> &lt;span class="s">&amp;#34;appendonly.aof&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>AOF的命令记录的频率也可以通过redis.conf文件来配：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 表示每执行一次写命令，立即记录到AOF文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">appendfsync&lt;/span> &lt;span class="s">always &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 写命令执行完先放入AOF缓冲区，然后表示每隔1秒将缓冲区数据写到AOF文件，是默认方案&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">appendfsync&lt;/span> &lt;span class="s">everysec &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 写命令执行完先放入AOF缓冲区，由操作系统决定何时将缓冲区内容写回磁盘&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">appendfsync&lt;/span> &lt;span class="s">no&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>三种策略对比：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-fec4cbb9c7c4eb.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725151654046"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="123aof文件重写">
&lt;a href="#123aof%e6%96%87%e4%bb%b6%e9%87%8d%e5%86%99" class="header-anchor">#&lt;/a>
1.2.3.AOF文件重写
&lt;/h3>&lt;p>因为是记录命令，AOF文件会比RDB文件大的多。而且AOF会记录对同一个key的多次写操作，但只有最后一次写操作才有意义。通过执行bgrewriteaof命令，可以让AOF文件执行重写功能，用最少的命令达到相同效果。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-03d4c2f4b45e50.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725151729118"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如图，AOF原本有三个命令，但是&lt;code>set num 123 和 set num 666&lt;/code>都是对num的操作，第二次会覆盖第一次的值，因此第一个命令记录下来没有意义。&lt;/p>
&lt;p>所以重写命令后，AOF文件内容就是：&lt;code>mset name jack num 666&lt;/code>&lt;/p>
&lt;p>Redis也会在触发阈值时自动去重写AOF文件。阈值也可以在redis.conf中配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># AOF文件比上次文件 增长超过多少百分比则触发重写&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">auto-aof-rewrite-percentage&lt;/span> &lt;span class="s">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># AOF文件体积最小多大以上才触发重写 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">auto-aof-rewrite-min-size&lt;/span> &lt;span class="s">64mb &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="13rdb与aof对比">
&lt;a href="#13rdb%e4%b8%8eaof%e5%af%b9%e6%af%94" class="header-anchor">#&lt;/a>
1.3.RDB与AOF对比
&lt;/h2>&lt;p>RDB和AOF各有自己的优缺点，如果对数据安全性要求较高，在实际开发中往往会&lt;strong>结合&lt;/strong>两者来使用。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-316ebd7a0d58b3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725151940515"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="2redis主从">
&lt;a href="#2redis%e4%b8%bb%e4%bb%8e" class="header-anchor">#&lt;/a>
2.Redis主从
&lt;/h1>&lt;h2 id="21搭建主从架构">
&lt;a href="#21%e6%90%ad%e5%bb%ba%e4%b8%bb%e4%bb%8e%e6%9e%b6%e6%9e%84" class="header-anchor">#&lt;/a>
2.1.搭建主从架构
&lt;/h2>&lt;p>单节点Redis的并发能力是有上限的，要进一步提高Redis的并发能力，就需要搭建主从集群，实现读写分离。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-3cf423530a6008.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725152037611"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>具体搭建流程参考课前资料《Redis集群.md》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-a4b9b0cf76d93d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725152052501"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="22主从数据同步原理">
&lt;a href="#22%e4%b8%bb%e4%bb%8e%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
2.2.主从数据同步原理
&lt;/h2>&lt;h3 id="221全量同步">
&lt;a href="#221%e5%85%a8%e9%87%8f%e5%90%8c%e6%ad%a5" class="header-anchor">#&lt;/a>
2.2.1.全量同步
&lt;/h3>&lt;p>主从第一次建立连接时，会执行&lt;strong>全量同步&lt;/strong>，将master节点的所有数据都拷贝给slave节点，流程：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-8ee699a0d9f3ac.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725152222497"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这里有一个问题，master如何得知salve是第一次来连接呢？？&lt;/p>
&lt;p>有几个概念，可以作为判断依据：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Replication Id&lt;/strong>：简称replid，是数据集的标记，id一致则说明是同一数据集。每一个master都有唯一的replid，slave则会继承master节点的replid&lt;/li>
&lt;li>&lt;strong>offset&lt;/strong>：偏移量，随着记录在repl_baklog中的数据增多而逐渐增大。slave完成同步时也会记录当前同步的offset。如果slave的offset小于master的offset，说明slave数据落后于master，需要更新。&lt;/li>
&lt;/ul>
&lt;p>因此slave做数据同步，必须向master声明自己的replication id 和offset，master才可以判断到底需要同步哪些数据。&lt;/p>
&lt;p>因为slave原本也是一个master，有自己的replid和offset，当第一次变成slave，与master建立连接时，发送的replid和offset是自己的replid和offset。&lt;/p>
&lt;p>master判断发现slave发送来的replid与自己的不一致，说明这是一个全新的slave，就知道要做全量同步了。&lt;/p>
&lt;p>master会将自己的replid和offset都发送给这个slave，slave保存这些信息。以后slave的replid就与master一致了。&lt;/p>
&lt;p>因此，&lt;strong>master判断一个节点是否是第一次同步的依据，就是看replid是否一致&lt;/strong>。&lt;/p>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-527ba67793506e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725152700914"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>完整流程描述：&lt;/p>
&lt;ul>
&lt;li>slave节点请求增量同步&lt;/li>
&lt;li>master节点判断replid，发现不一致，拒绝增量同步&lt;/li>
&lt;li>master将完整内存数据生成RDB，发送RDB到slave&lt;/li>
&lt;li>slave清空本地数据，加载master的RDB&lt;/li>
&lt;li>master将RDB期间的命令记录在repl_baklog，并持续将log中的命令发送给slave&lt;/li>
&lt;li>slave执行接收到的命令，保持与master之间的同步&lt;/li>
&lt;/ul>
&lt;h3 id="222增量同步">
&lt;a href="#222%e5%a2%9e%e9%87%8f%e5%90%8c%e6%ad%a5" class="header-anchor">#&lt;/a>
2.2.2.增量同步
&lt;/h3>&lt;p>全量同步需要先做RDB，然后将RDB文件通过网络传输个slave，成本太高了。因此除了第一次做全量同步，其它大多数时候slave与master都是做&lt;strong>增量同步&lt;/strong>。&lt;/p>
&lt;p>什么是增量同步？就是只更新slave与master存在差异的部分数据。如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-078a059318b6a0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725153201086"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>那么master怎么知道slave与自己的数据差异在哪里呢?&lt;/p>
&lt;h3 id="223repl_backlog原理">
&lt;a href="#223repl_backlog%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
2.2.3.repl_backlog原理
&lt;/h3>&lt;p>master怎么知道slave与自己的数据差异在哪里呢?&lt;/p>
&lt;p>这就要说到全量同步时的repl_baklog文件了。&lt;/p>
&lt;p>这个文件是一个固定大小的数组，只不过数组是环形，也就是说&lt;strong>角标到达数组末尾后，会再次从0开始读写&lt;/strong>，这样数组头部的数据就会被覆盖。&lt;/p>
&lt;p>repl_baklog中会记录Redis处理过的命令日志及offset，包括master当前的offset，和slave已经拷贝到的offset：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-e96eaf98112a40.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725153359022"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>slave与master的offset之间的差异，就是salve需要增量拷贝的数据了。&lt;/p>
&lt;p>随着不断有数据写入，master的offset逐渐变大，slave也不断的拷贝，追赶master的offset：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-75684fb921b48f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725153524190"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>直到数组被填满：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-d909c3d2b4ee92.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725153715910"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>此时，如果有新的数据写入，就会覆盖数组中的旧数据。不过，旧的数据只要是绿色的，说明是已经被同步到slave的数据，即便被覆盖了也没什么影响。因为未同步的仅仅是红色部分。&lt;/p>
&lt;p>但是，如果slave出现网络阻塞，导致master的offset远远超过了slave的offset：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-5e48f31a7edfd4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725153937031"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如果master继续写入新数据，其offset就会覆盖旧的数据，直到将slave现在的offset也覆盖：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-ceb1aa2240f34a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725154155984"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>棕色框中的红色部分，就是尚未同步，但是却已经被覆盖的数据。此时如果slave恢复，需要同步，却发现自己的offset都没有了，无法完成增量同步了。只能做全量同步。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-9af030488cb580.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725154216392"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="23主从同步优化">
&lt;a href="#23%e4%b8%bb%e4%bb%8e%e5%90%8c%e6%ad%a5%e4%bc%98%e5%8c%96" class="header-anchor">#&lt;/a>
2.3.主从同步优化
&lt;/h2>&lt;p>主从同步可以保证主从数据的一致性，非常重要。&lt;/p>
&lt;p>可以从以下几个方面来优化Redis主从就集群：&lt;/p>
&lt;ul>
&lt;li>在master中配置repl-diskless-sync yes启用无磁盘复制，避免全量同步时的磁盘IO。&lt;/li>
&lt;li>Redis单节点上的内存占用不要太大，减少RDB导致的过多磁盘IO&lt;/li>
&lt;li>适当提高repl_baklog的大小，发现slave宕机时尽快实现故障恢复，尽可能避免全量同步&lt;/li>
&lt;li>限制一个master上的slave节点数量，如果实在是太多slave，则可以采用主-从-从链式结构，减少master压力&lt;/li>
&lt;/ul>
&lt;p>主从从架构图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-73df5d2c5c46f8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725154405899"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="24小结">
&lt;a href="#24%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
2.4.小结
&lt;/h2>&lt;p>简述全量同步和增量同步区别？&lt;/p>
&lt;ul>
&lt;li>全量同步：master将完整内存数据生成RDB，发送RDB到slave。后续命令则记录在repl_baklog，逐个发送给slave。&lt;/li>
&lt;li>增量同步：slave提交自己的offset到master，master获取repl_baklog中从offset之后的命令给slave&lt;/li>
&lt;/ul>
&lt;p>什么时候执行全量同步？&lt;/p>
&lt;ul>
&lt;li>slave节点第一次连接master节点时&lt;/li>
&lt;li>slave节点断开时间太久，repl_baklog中的offset已经被覆盖时&lt;/li>
&lt;/ul>
&lt;p>什么时候执行增量同步？&lt;/p>
&lt;ul>
&lt;li>slave节点断开又恢复，并且在repl_baklog中能找到offset时&lt;/li>
&lt;/ul>
&lt;h1 id="3redis哨兵">
&lt;a href="#3redis%e5%93%a8%e5%85%b5" class="header-anchor">#&lt;/a>
3.Redis哨兵
&lt;/h1>&lt;p>Redis提供了哨兵（Sentinel）机制来实现主从集群的自动故障恢复。&lt;/p>
&lt;h2 id="31哨兵原理">
&lt;a href="#31%e5%93%a8%e5%85%b5%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
3.1.哨兵原理
&lt;/h2>&lt;h3 id="311集群结构和作用">
&lt;a href="#311%e9%9b%86%e7%be%a4%e7%bb%93%e6%9e%84%e5%92%8c%e4%bd%9c%e7%94%a8" class="header-anchor">#&lt;/a>
3.1.1.集群结构和作用
&lt;/h3>&lt;p>哨兵的结构如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-32e5374d9be4cf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725154528072"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>哨兵的作用如下：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>监控&lt;/strong>：Sentinel 会不断检查您的master和slave是否按预期工作&lt;/li>
&lt;li>&lt;strong>自动故障恢复&lt;/strong>：如果master故障，Sentinel会将一个slave提升为master。当故障实例恢复后也以新的master为主&lt;/li>
&lt;li>&lt;strong>通知&lt;/strong>：Sentinel充当Redis客户端的服务发现来源，当集群发生故障转移时，会将最新信息推送给Redis的客户端&lt;/li>
&lt;/ul>
&lt;h3 id="312集群监控原理">
&lt;a href="#312%e9%9b%86%e7%be%a4%e7%9b%91%e6%8e%a7%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
3.1.2.集群监控原理
&lt;/h3>&lt;p>Sentinel基于心跳机制监测服务状态，每隔1秒向集群的每个实例发送ping命令：&lt;/p>
&lt;p>•主观下线：如果某sentinel节点发现某实例未在规定时间响应，则认为该实例&lt;strong>主观下线&lt;/strong>。&lt;/p>
&lt;p>•客观下线：若超过指定数量（quorum）的sentinel都认为该实例主观下线，则该实例&lt;strong>客观下线&lt;/strong>。quorum值最好超过Sentinel实例数量的一半。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-ae3cd700c23206.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725154632354"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="313集群故障恢复原理">
&lt;a href="#313%e9%9b%86%e7%be%a4%e6%95%85%e9%9a%9c%e6%81%a2%e5%a4%8d%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
3.1.3.集群故障恢复原理
&lt;/h3>&lt;p>一旦发现master故障，sentinel需要在salve中选择一个作为新的master，选择依据是这样的：&lt;/p>
&lt;ul>
&lt;li>首先会判断slave节点与master节点断开时间长短，如果超过指定值（down-after-milliseconds * 10）则会排除该slave节点&lt;/li>
&lt;li>然后判断slave节点的slave-priority值，越小优先级越高，如果是0则永不参与选举&lt;/li>
&lt;li>如果slave-prority一样，则判断slave节点的offset值，越大说明数据越新，优先级越高&lt;/li>
&lt;li>最后是判断slave节点的运行id大小，越小优先级越高。&lt;/li>
&lt;/ul>
&lt;p>当选出一个新的master后，该如何实现切换呢？&lt;/p>
&lt;p>流程如下：&lt;/p>
&lt;ul>
&lt;li>sentinel给备选的slave1节点发送slaveof no one命令，让该节点成为master&lt;/li>
&lt;li>sentinel给所有其它slave发送slaveof 192.168.150.101 7002 命令，让这些slave成为新master的从节点，开始从新的master上同步数据。&lt;/li>
&lt;li>最后，sentinel将故障节点标记为slave，当故障节点恢复后会自动成为新的master的slave节点&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-8b610645ff2189.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725154816841"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="314小结">
&lt;a href="#314%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
3.1.4.小结
&lt;/h3>&lt;p>Sentinel的三个作用是什么？&lt;/p>
&lt;ul>
&lt;li>监控&lt;/li>
&lt;li>故障转移&lt;/li>
&lt;li>通知&lt;/li>
&lt;/ul>
&lt;p>Sentinel如何判断一个redis实例是否健康？&lt;/p>
&lt;ul>
&lt;li>每隔1秒发送一次ping命令，如果超过一定时间没有相向则认为是主观下线&lt;/li>
&lt;li>如果大多数sentinel都认为实例主观下线，则判定服务下线&lt;/li>
&lt;/ul>
&lt;p>故障转移步骤有哪些？&lt;/p>
&lt;ul>
&lt;li>首先选定一个slave作为新的master，执行slaveof no one&lt;/li>
&lt;li>然后让所有节点都执行slaveof 新master&lt;/li>
&lt;li>修改故障节点配置，添加slaveof 新master&lt;/li>
&lt;/ul>
&lt;h2 id="32搭建哨兵集群">
&lt;a href="#32%e6%90%ad%e5%bb%ba%e5%93%a8%e5%85%b5%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
3.2.搭建哨兵集群
&lt;/h2>&lt;p>具体搭建流程参考课前资料《Redis集群.md》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-46a8e00f00b2fb.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725155019276"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="33redistemplate">
&lt;a href="#33redistemplate" class="header-anchor">#&lt;/a>
3.3.RedisTemplate
&lt;/h2>&lt;p>在Sentinel集群监管下的Redis主从集群，其节点会因为自动故障转移而发生变化，Redis的客户端必须感知这种变化，及时更新连接信息。Spring的RedisTemplate底层利用lettuce实现了节点的感知和自动切换。&lt;/p>
&lt;p>下面，我们通过一个测试来实现RedisTemplate集成哨兵机制。&lt;/p>
&lt;h3 id="331导入demo工程">
&lt;a href="#331%e5%af%bc%e5%85%a5demo%e5%b7%a5%e7%a8%8b" class="header-anchor">#&lt;/a>
3.3.1.导入Demo工程
&lt;/h3>&lt;p>首先，我们引入课前资料提供的Demo工程：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-f1ec76131ffa94.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725155124958"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="332引入依赖">
&lt;a href="#332%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96" class="header-anchor">#&lt;/a>
3.3.2.引入依赖
&lt;/h3>&lt;p>在项目的pom文件中引入依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-4">&lt;a class="lnlinks" href="#hl-5-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.boot&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-boot-starter-data-redis&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="333配置redis地址">
&lt;a href="#333%e9%85%8d%e7%bd%aeredis%e5%9c%b0%e5%9d%80" class="header-anchor">#&lt;/a>
3.3.3.配置Redis地址
&lt;/h3>&lt;p>然后在配置文件application.yml中指定redis的sentinel相关信息：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-5">&lt;a class="lnlinks" href="#hl-6-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-6">&lt;a class="lnlinks" href="#hl-6-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-7">&lt;a class="lnlinks" href="#hl-6-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-8">&lt;a class="lnlinks" href="#hl-6-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nl">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">redis&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">sentinel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">mymaster&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">nodes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">192&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">150&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">27001&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">192&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">150&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">27002&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">192&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">150&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">27003&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="334配置读写分离">
&lt;a href="#334%e9%85%8d%e7%bd%ae%e8%af%bb%e5%86%99%e5%88%86%e7%a6%bb" class="header-anchor">#&lt;/a>
3.3.4.配置读写分离
&lt;/h3>&lt;p>在项目的启动类中，添加一个新的bean：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LettuceClientConfigurationBuilderCustomizer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">clientConfigurationBuilderCustomizer&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientConfigurationBuilder&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientConfigurationBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">readFrom&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ReadFrom&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">REPLICA_PREFERRED&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个bean中配置的就是读写策略，包括四种：&lt;/p>
&lt;ul>
&lt;li>MASTER：从主节点读取&lt;/li>
&lt;li>MASTER_PREFERRED：优先从master节点读取，master不可用才读取replica&lt;/li>
&lt;li>REPLICA：从slave（replica）节点读取&lt;/li>
&lt;li>REPLICA _PREFERRED：优先从slave（replica）节点读取，所有的slave都不可用才读取master&lt;/li>
&lt;/ul>
&lt;h1 id="4redis分片集群">
&lt;a href="#4redis%e5%88%86%e7%89%87%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.Redis分片集群
&lt;/h1>&lt;h2 id="41搭建分片集群">
&lt;a href="#41%e6%90%ad%e5%bb%ba%e5%88%86%e7%89%87%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.1.搭建分片集群
&lt;/h2>&lt;p>主从和哨兵可以解决高可用、高并发读的问题。但是依然有两个问题没有解决：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>海量数据存储问题&lt;/p>
&lt;/li>
&lt;li>
&lt;p>高并发写的问题&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>使用分片集群可以解决上述问题，如图:&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-67a9fc5b332729.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725155747294"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>分片集群特征：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>集群中有多个master，每个master保存不同数据&lt;/p>
&lt;/li>
&lt;li>
&lt;p>每个master都可以有多个slave节点&lt;/p>
&lt;/li>
&lt;li>
&lt;p>master之间通过ping监测彼此健康状态&lt;/p>
&lt;/li>
&lt;li>
&lt;p>客户端请求可以访问集群任意节点，最终都会被转发到正确节点&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>具体搭建流程参考课前资料《Redis集群.md》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-5a24c947a4bb1c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725155806288"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="42散列插槽">
&lt;a href="#42%e6%95%a3%e5%88%97%e6%8f%92%e6%a7%bd" class="header-anchor">#&lt;/a>
4.2.散列插槽
&lt;/h2>&lt;h3 id="421插槽原理">
&lt;a href="#421%e6%8f%92%e6%a7%bd%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
4.2.1.插槽原理
&lt;/h3>&lt;p>Redis会把每一个master节点映射到0~16383共16384个插槽（hash slot）上，查看集群信息时就能看到：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-9489a2df98b503.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725155820320"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>数据key不是与节点绑定，而是与插槽绑定。redis会根据key的有效部分计算插槽值，分两种情况：&lt;/p>
&lt;ul>
&lt;li>key中包含&amp;quot;{}&amp;quot;，且“{}”中至少包含1个字符，“{}”中的部分是有效部分&lt;/li>
&lt;li>key中不包含“{}”，整个key都是有效部分&lt;/li>
&lt;/ul>
&lt;p>例如：key是num，那么就根据num计算，如果是{itcast}num，则根据itcast计算。计算方式是利用CRC16算法得到一个hash值，然后对16384取余，得到的结果就是slot值。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-6d138cf5f8e1f4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725155850200"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如图，在7001这个节点执行set a 1时，对a做hash运算，对16384取余，得到的结果是15495，因此要存储到103节点。&lt;/p>
&lt;p>到了7003后，执行&lt;code>get num&lt;/code>时，对num做hash运算，对16384取余，得到的结果是2765，因此需要切换到7001节点&lt;/p>
&lt;h3 id="421小结">
&lt;a href="#421%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
4.2.1.小结
&lt;/h3>&lt;p>Redis如何判断某个key应该在哪个实例？&lt;/p>
&lt;ul>
&lt;li>将16384个插槽分配到不同的实例&lt;/li>
&lt;li>根据key的有效部分计算哈希值，对16384取余&lt;/li>
&lt;li>余数作为插槽，寻找插槽所在实例即可&lt;/li>
&lt;/ul>
&lt;p>如何将同一类数据固定的保存在同一个Redis实例？&lt;/p>
&lt;ul>
&lt;li>这一类数据使用相同的有效部分，例如key都以{typeId}为前缀&lt;/li>
&lt;/ul>
&lt;h2 id="43集群伸缩">
&lt;a href="#43%e9%9b%86%e7%be%a4%e4%bc%b8%e7%bc%a9" class="header-anchor">#&lt;/a>
4.3.集群伸缩
&lt;/h2>&lt;p>redis-cli &amp;ndash;cluster提供了很多操作集群的命令，可以通过下面方式查看：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-87821db066457e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725160138290"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>比如，添加节点的命令：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-aa9520d13a334e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725160448139"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="431需求分析">
&lt;a href="#431%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90" class="header-anchor">#&lt;/a>
4.3.1.需求分析
&lt;/h3>&lt;p>需求：向集群中添加一个新的master节点，并向其中存储 num = 10&lt;/p>
&lt;ul>
&lt;li>启动一个新的redis实例，端口为7004&lt;/li>
&lt;li>添加7004到之前的集群，并作为一个master节点&lt;/li>
&lt;li>给7004节点分配插槽，使得num这个key可以存储到7004实例&lt;/li>
&lt;/ul>
&lt;p>这里需要两个新的功能：&lt;/p>
&lt;ul>
&lt;li>添加一个节点到集群中&lt;/li>
&lt;li>将部分插槽分配到新插槽&lt;/li>
&lt;/ul>
&lt;h3 id="432创建新的redis实例">
&lt;a href="#432%e5%88%9b%e5%bb%ba%e6%96%b0%e7%9a%84redis%e5%ae%9e%e4%be%8b" class="header-anchor">#&lt;/a>
4.3.2.创建新的redis实例
&lt;/h3>&lt;p>创建一个文件夹：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">mkdir &lt;span class="m">7004&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>拷贝配置文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">cp redis.conf /7004
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改配置文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">sed /s/6379/7004/g 7004/redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>启动&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">redis-server 7004/redis.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="433添加新节点到redis">
&lt;a href="#433%e6%b7%bb%e5%8a%a0%e6%96%b0%e8%8a%82%e7%82%b9%e5%88%b0redis" class="header-anchor">#&lt;/a>
4.3.3.添加新节点到redis
&lt;/h3>&lt;p>添加节点的语法如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-aa9520d13a334e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725160448139"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>执行命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">redis-cli --cluster add-node 192.168.150.101:7004 192.168.150.101:7001
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>通过命令查看集群状态：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">redis-cli -p &lt;span class="m">7001&lt;/span> cluster nodes
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如图，7004加入了集群，并且默认是一个master节点：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-ecb9e67fe52456.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725161007099"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>但是，可以看到7004节点的插槽数量为0，因此没有任何数据可以存储到7004上&lt;/p>
&lt;h3 id="434转移插槽">
&lt;a href="#434%e8%bd%ac%e7%a7%bb%e6%8f%92%e6%a7%bd" class="header-anchor">#&lt;/a>
4.3.4.转移插槽
&lt;/h3>&lt;p>我们要将num存储到7004节点，因此需要先看看num的插槽是多少：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-c3cd73b92fd560.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725161241793"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如上图所示，num的插槽为2765.&lt;/p>
&lt;p>我们可以将0~3000的插槽从7001转移到7004，命令格式如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-95f40e84ec2da7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725161401925"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>具体命令如下：&lt;/p>
&lt;p>建立连接：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-40ed275ab841b6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725161506241"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>得到下面的反馈：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-2a816e81b99115.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725161540841"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>询问要移动多少个插槽，我们计划是3000个：&lt;/p>
&lt;p>新的问题来了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-5eaeb1543c55b4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725161637152"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>那个node来接收这些插槽？？&lt;/p>
&lt;p>显然是7004，那么7004节点的id是多少呢？&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-91024cde362c82.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725161731738"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>复制这个id，然后拷贝到刚才的控制台后：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-ff4f0f9eca4d39.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725161817642"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这里询问，你的插槽是从哪里移动过来的？&lt;/p>
&lt;ul>
&lt;li>all：代表全部，也就是三个节点各转移一部分&lt;/li>
&lt;li>具体的id：目标节点的id&lt;/li>
&lt;li>done：没有了&lt;/li>
&lt;/ul>
&lt;p>这里我们要从7001获取，因此填写7001的id：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-8f22ebbddcb03e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725162030478"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>填完后，点击done，这样插槽转移就准备好了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-251ac268a90746.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725162101228"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>确认要转移吗？输入yes：&lt;/p>
&lt;p>然后，通过命令查看结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-151b18320b363f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725162145497"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-f6e61c3991fc4b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725162224058"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>目的达成。&lt;/p>
&lt;h2 id="44故障转移">
&lt;a href="#44%e6%95%85%e9%9a%9c%e8%bd%ac%e7%a7%bb" class="header-anchor">#&lt;/a>
4.4.故障转移
&lt;/h2>&lt;p>集群初识状态是这样的：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-c08606c53cddbf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210727161152065"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中7001、7002、7003都是master，我们计划让7002宕机。&lt;/p>
&lt;h3 id="441自动故障转移">
&lt;a href="#441%e8%87%aa%e5%8a%a8%e6%95%85%e9%9a%9c%e8%bd%ac%e7%a7%bb" class="header-anchor">#&lt;/a>
4.4.1.自动故障转移
&lt;/h3>&lt;p>当集群中有一个master宕机会发生什么呢？&lt;/p>
&lt;p>直接停止一个redis实例，例如7002：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">redis-cli -p &lt;span class="m">7002&lt;/span> shutdown
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>1）首先是该实例与其它实例失去连接&lt;/p>
&lt;p>2）然后是疑似宕机：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-6f56f3dc81c63d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725162319490"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>3）最后是确定下线，自动提升一个slave为新的master：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-b82048ee50d5fc.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725162408979"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>4）当7002再次启动，就会变为一个slave节点了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-3af39d0c2e8fcf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210727160803386"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="442手动故障转移">
&lt;a href="#442%e6%89%8b%e5%8a%a8%e6%95%85%e9%9a%9c%e8%bd%ac%e7%a7%bb" class="header-anchor">#&lt;/a>
4.4.2.手动故障转移
&lt;/h3>&lt;p>利用cluster failover命令可以手动让集群中的某个master宕机，切换到执行cluster failover命令的这个slave节点，实现无感知的数据迁移。其流程如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-13e8da4e7c068c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210725162441407"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这种failover命令可以指定三种模式：&lt;/p>
&lt;ul>
&lt;li>缺省：默认的流程，如图1~6歩&lt;/li>
&lt;li>force：省略了对offset的一致性校验&lt;/li>
&lt;li>takeover：直接执行第5歩，忽略数据一致性、忽略master状态和其它master的意见&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>案例需求&lt;/strong>：在7002这个slave节点执行手动故障转移，重新夺回master地位&lt;/p>
&lt;p>步骤如下：&lt;/p>
&lt;p>1）利用redis-cli连接7002这个节点&lt;/p>
&lt;p>2）执行cluster failover命令&lt;/p>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-73e5c17b463717.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210727160037766"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>效果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738710-c08606c53cddbf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210727161152065"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="45redistemplate访问分片集群">
&lt;a href="#45redistemplate%e8%ae%bf%e9%97%ae%e5%88%86%e7%89%87%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.5.RedisTemplate访问分片集群
&lt;/h2>&lt;p>RedisTemplate底层同样基于lettuce实现了分片集群的支持，而使用的步骤与哨兵模式基本一致：&lt;/p>
&lt;p>1）引入redis的starter依赖&lt;/p>
&lt;p>2）配置分片集群地址&lt;/p>
&lt;p>3）配置读写分离&lt;/p>
&lt;p>与哨兵模式相比，其中只有分片集群的配置方式略有差异，如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-6">&lt;a class="lnlinks" href="#hl-15-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-7">&lt;a class="lnlinks" href="#hl-15-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-8">&lt;a class="lnlinks" href="#hl-15-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-9">&lt;a class="lnlinks" href="#hl-15-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-10">&lt;a class="lnlinks" href="#hl-15-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">redis&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cluster&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nodes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="m">192.168.150.101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">7001&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="m">192.168.150.101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">7002&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="m">192.168.150.101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">7003&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="m">192.168.150.101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">8001&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="m">192.168.150.101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">8002&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="m">192.168.150.101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">8003&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>11.安装Canal</title><link>https://logan.wssw.fun/p/2023/01/49z67149/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/49z67149/</guid><description>&lt;h1 id="安装和配置canal">
&lt;a href="#%e5%ae%89%e8%a3%85%e5%92%8c%e9%85%8d%e7%bd%aecanal" class="header-anchor">#&lt;/a>
安装和配置Canal
&lt;/h1>&lt;p>下面我们就开启mysql的主从同步机制，让Canal来模拟salve&lt;/p>
&lt;h1 id="1开启mysql主从">
&lt;a href="#1%e5%bc%80%e5%90%afmysql%e4%b8%bb%e4%bb%8e" class="header-anchor">#&lt;/a>
1.开启MySQL主从
&lt;/h1>&lt;p>Canal是基于MySQL的主从同步功能，因此必须先开启MySQL的主从功能才可以。&lt;/p>
&lt;p>这里以之前用Docker运行的mysql为例：&lt;/p>
&lt;h2 id="11开启binlog">
&lt;a href="#11%e5%bc%80%e5%90%afbinlog" class="header-anchor">#&lt;/a>
1.1.开启binlog
&lt;/h2>&lt;p>打开mysql容器挂载的日志文件，我的在&lt;code>/tmp/mysql/conf&lt;/code>目录:&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740142-bf657a40c9fc37.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210813153241537"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>修改文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">vi /tmp/mysql/conf/my.cnf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>添加内容：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="na">log-bin&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/var/lib/mysql/mysql-bin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">binlog-do-db&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">heima&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>配置解读：&lt;/p>
&lt;ul>
&lt;li>&lt;code>log-bin=/var/lib/mysql/mysql-bin&lt;/code>：设置binary log文件的存放地址和文件名，叫做mysql-bin&lt;/li>
&lt;li>&lt;code>binlog-do-db=heima&lt;/code>：指定对哪个database记录binary log events，这里记录heima这个库&lt;/li>
&lt;/ul>
&lt;p>最终效果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[mysqld]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">skip-name-resolve&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">character_set_server&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">utf8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">datadir&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/var/lib/mysql&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server-id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">log-bin&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/var/lib/mysql/mysql-bin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">binlog-do-db&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">heima&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="12设置用户权限">
&lt;a href="#12%e8%ae%be%e7%bd%ae%e7%94%a8%e6%88%b7%e6%9d%83%e9%99%90" class="header-anchor">#&lt;/a>
1.2.设置用户权限
&lt;/h2>&lt;p>接下来添加一个仅用于数据同步的账户，出于安全考虑，这里仅提供对heima这个库的操作权限。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-mysql" data-lang="mysql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">user&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">canal&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="s1">&amp;#39;%&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IDENTIFIED&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">by&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;canal&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">GRANT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">REPLICATION&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SLAVE&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">REPLICATION&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CLIENT&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">SUPER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;canal&amp;#39;&lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="s1">&amp;#39;%&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">identified&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">by&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;canal&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FLUSH&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIVILEGES&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启mysql容器即可&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">docker restart mysql
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试设置是否成功：在mysql控制台，或者Navicat中，输入命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">show master status;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740142-56f0ba6eb13859.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20200327094735948"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="2安装canal">
&lt;a href="#2%e5%ae%89%e8%a3%85canal" class="header-anchor">#&lt;/a>
2.安装Canal
&lt;/h1>&lt;h2 id="21创建网络">
&lt;a href="#21%e5%88%9b%e5%bb%ba%e7%bd%91%e7%bb%9c" class="header-anchor">#&lt;/a>
2.1.创建网络
&lt;/h2>&lt;p>我们需要创建一个网络，将MySQL、Canal、MQ放到同一个Docker网络中：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker network create heima
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>让mysql加入这个网络：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker network connect heima mysql
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="23安装canal">
&lt;a href="#23%e5%ae%89%e8%a3%85canal" class="header-anchor">#&lt;/a>
2.3.安装Canal
&lt;/h2>&lt;p>课前资料中提供了canal的镜像压缩包:&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740142-09d7ea6ca7ff6a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210813161804292"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>大家可以上传到虚拟机，然后通过命令导入：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">docker&lt;/span> &lt;span class="nb">load&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="n">canal&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tar&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后运行命令创建Canal容器：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-5">&lt;a class="lnlinks" href="#hl-9-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-6">&lt;a class="lnlinks" href="#hl-9-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-7">&lt;a class="lnlinks" href="#hl-9-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-8">&lt;a class="lnlinks" href="#hl-9-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-9">&lt;a class="lnlinks" href="#hl-9-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-10">&lt;a class="lnlinks" href="#hl-9-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-11">&lt;a class="lnlinks" href="#hl-9-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run -p 11111:11111 --name canal &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e canal.destinations&lt;span class="o">=&lt;/span>heima &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e canal.instance.master.address&lt;span class="o">=&lt;/span>mysql:3306 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e canal.instance.dbUsername&lt;span class="o">=&lt;/span>canal &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e canal.instance.dbPassword&lt;span class="o">=&lt;/span>canal &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e canal.instance.connectionCharset&lt;span class="o">=&lt;/span>UTF-8 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e canal.instance.tsdb.enable&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e canal.instance.gtidon&lt;span class="o">=&lt;/span>&lt;span class="nb">false&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e canal.instance.filter.regex&lt;span class="o">=&lt;/span>heima&lt;span class="se">\\&lt;/span>..* &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--network heima &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-d canal/canal-server:v1.1.5
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>说明:&lt;/p>
&lt;ul>
&lt;li>&lt;code>-p 11111:11111&lt;/code>：这是canal的默认监听端口&lt;/li>
&lt;li>&lt;code>-e canal.instance.master.address=mysql:3306&lt;/code>：数据库地址和端口，如果不知道mysql容器地址，可以通过&lt;code>docker inspect 容器id&lt;/code>来查看&lt;/li>
&lt;li>&lt;code>-e canal.instance.dbUsername=canal&lt;/code>：数据库用户名&lt;/li>
&lt;li>&lt;code>-e canal.instance.dbPassword=canal&lt;/code> ：数据库密码&lt;/li>
&lt;li>&lt;code>-e canal.instance.filter.regex=&lt;/code>：要监听的表名称&lt;/li>
&lt;/ul>
&lt;p>表名称监听支持的语法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-5">&lt;a class="lnlinks" href="#hl-10-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-6">&lt;a class="lnlinks" href="#hl-10-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-7">&lt;a class="lnlinks" href="#hl-10-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-8">&lt;a class="lnlinks" href="#hl-10-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">mysql 数据解析关注的表，Perl正则表达式.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">多个正则之间以逗号(,)分隔，转义符需要双斜杠(\\)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">常见例子：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 所有表：.* or .*\\..*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. canal schema下所有表： canal\\..*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. canal下的以canal打头的表：canal\\.canal.*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4. canal schema下的一张表：canal.test1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5. 多个规则组合使用然后以逗号隔开：canal\\..*,mysql.test1,mysql.test2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>11.安装OpenResty</title><link>https://logan.wssw.fun/p/2023/01/451178u5/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/451178u5/</guid><description>&lt;h1 id="安装openresty">
&lt;a href="#%e5%ae%89%e8%a3%85openresty" class="header-anchor">#&lt;/a>
安装OpenResty
&lt;/h1>&lt;h1 id="1安装">
&lt;a href="#1%e5%ae%89%e8%a3%85" class="header-anchor">#&lt;/a>
1.安装
&lt;/h1>&lt;p>首先你的Linux虚拟机必须联网&lt;/p>
&lt;h2 id="1安装开发库">
&lt;a href="#1%e5%ae%89%e8%a3%85%e5%bc%80%e5%8f%91%e5%ba%93" class="header-anchor">#&lt;/a>
&lt;strong>1）安装开发库&lt;/strong>
&lt;/h2>&lt;p>首先要安装OpenResty的依赖开发库，执行命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">yum install -y pcre-devel openssl-devel gcc --skip-broken
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="2安装openresty仓库">
&lt;a href="#2%e5%ae%89%e8%a3%85openresty%e4%bb%93%e5%ba%93" class="header-anchor">#&lt;/a>
&lt;strong>2）安装OpenResty仓库&lt;/strong>
&lt;/h2>&lt;p>你可以在你的 CentOS 系统中添加 &lt;code>openresty&lt;/code> 仓库，这样就可以便于未来安装或更新我们的软件包（通过 &lt;code>yum check-update&lt;/code> 命令）。运行下面的命令就可以添加我们的仓库：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果提示说命令不存在，则运行：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">yum install -y yum-utils
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后再重复上面的命令&lt;/p>
&lt;h2 id="3安装openresty">
&lt;a href="#3%e5%ae%89%e8%a3%85openresty" class="header-anchor">#&lt;/a>
&lt;strong>3）安装OpenResty&lt;/strong>
&lt;/h2>&lt;p>然后就可以像下面这样安装软件包，比如 &lt;code>openresty&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">yum install -y openresty
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="4安装opm工具">
&lt;a href="#4%e5%ae%89%e8%a3%85opm%e5%b7%a5%e5%85%b7" class="header-anchor">#&lt;/a>
&lt;strong>4）安装opm工具&lt;/strong>
&lt;/h2>&lt;p>opm是OpenResty的一个管理工具，可以帮助我们安装一个第三方的Lua模块。&lt;/p>
&lt;p>如果你想安装命令行工具 &lt;code>opm&lt;/code>，那么可以像下面这样安装 &lt;code>openresty-opm&lt;/code> 包：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">yum install -y openresty-opm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="5目录结构">
&lt;a href="#5%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84" class="header-anchor">#&lt;/a>
&lt;strong>5）目录结构&lt;/strong>
&lt;/h2>&lt;p>默认情况下，OpenResty安装的目录是：/usr/local/openresty&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740242-e63550f0c15395.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20200310225539214"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>看到里面的nginx目录了吗，OpenResty就是在Nginx基础上集成了一些Lua模块。&lt;/p>
&lt;h2 id="6配置nginx的环境变量">
&lt;a href="#6%e9%85%8d%e7%bd%aenginx%e7%9a%84%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" class="header-anchor">#&lt;/a>
&lt;strong>6）配置nginx的环境变量&lt;/strong>
&lt;/h2>&lt;p>打开配置文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">vi /etc/profile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在最下面加入两行：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">NGINX_HOME&lt;/span>&lt;span class="o">=&lt;/span>/usr/local/openresty/nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">NGINX_HOME&lt;/span>&lt;span class="si">}&lt;/span>/sbin:&lt;span class="nv">$PATH&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>NGINX_HOME：后面是OpenResty安装目录下的nginx的目录&lt;/p>
&lt;p>然后让配置生效：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">source /etc/profile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="2启动和运行">
&lt;a href="#2%e5%90%af%e5%8a%a8%e5%92%8c%e8%bf%90%e8%a1%8c" class="header-anchor">#&lt;/a>
2.启动和运行
&lt;/h1>&lt;p>OpenResty底层是基于Nginx的，查看OpenResty目录的nginx目录，结构与windows中安装的nginx基本一致：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740242-8f30603d1bef72.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210811100653291"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>所以运行方式与nginx基本一致：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-6">&lt;a class="lnlinks" href="#hl-8-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 启动nginx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 重新加载配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx -s reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 停止&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx -s stop
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>nginx的默认配置文件注释太多，影响后续我们的编辑，这里将nginx.conf中的注释部分删除，保留有效部分。&lt;/p>
&lt;p>修改&lt;code>/usr/local/openresty/nginx/conf/nginx.conf&lt;/code>文件，内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-5">&lt;a class="lnlinks" href="#hl-9-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-6">&lt;a class="lnlinks" href="#hl-9-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-7">&lt;a class="lnlinks" href="#hl-9-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-8">&lt;a class="lnlinks" href="#hl-9-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-9">&lt;a class="lnlinks" href="#hl-9-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-10">&lt;a class="lnlinks" href="#hl-9-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-11">&lt;a class="lnlinks" href="#hl-9-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-12">&lt;a class="lnlinks" href="#hl-9-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-13">&lt;a class="lnlinks" href="#hl-9-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-14">&lt;a class="lnlinks" href="#hl-9-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-15">&lt;a class="lnlinks" href="#hl-9-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-16">&lt;a class="lnlinks" href="#hl-9-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-17">&lt;a class="lnlinks" href="#hl-9-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-18">&lt;a class="lnlinks" href="#hl-9-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-19">&lt;a class="lnlinks" href="#hl-9-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-20">&lt;a class="lnlinks" href="#hl-9-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-21">&lt;a class="lnlinks" href="#hl-9-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-22">&lt;a class="lnlinks" href="#hl-9-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-23">&lt;a class="lnlinks" href="#hl-9-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-24">&lt;a class="lnlinks" href="#hl-9-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-25">&lt;a class="lnlinks" href="#hl-9-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-26">&lt;a class="lnlinks" href="#hl-9-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-27">&lt;a class="lnlinks" href="#hl-9-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-28">&lt;a class="lnlinks" href="#hl-9-28">28&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#user nobody;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">worker_processes&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">error_log&lt;/span> &lt;span class="s">logs/error.log&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">events&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">worker_connections&lt;/span> &lt;span class="mi">1024&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">http&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">include&lt;/span> &lt;span class="s">mime.types&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">default_type&lt;/span> &lt;span class="s">application/octet-stream&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">sendfile&lt;/span> &lt;span class="no">on&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">keepalive_timeout&lt;/span> &lt;span class="mi">65&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">8081&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">localhost&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">root&lt;/span> &lt;span class="s">html&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">index&lt;/span> &lt;span class="s">index.html&lt;/span> &lt;span class="s">index.htm&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">error_page&lt;/span> &lt;span class="mi">500&lt;/span> &lt;span class="mi">502&lt;/span> &lt;span class="mi">503&lt;/span> &lt;span class="mi">504&lt;/span> &lt;span class="s">/50x.html&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">/50x.html&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">root&lt;/span> &lt;span class="s">html&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在Linux的控制台输入命令以启动nginx：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">nginx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后访问页面：http://192.168.150.101:8081，注意ip地址替换为你自己的虚拟机IP：&lt;/p>
&lt;h1 id="3备注">
&lt;a href="#3%e5%a4%87%e6%b3%a8" class="header-anchor">#&lt;/a>
3.备注
&lt;/h1>&lt;p>加载OpenResty的lua模块：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#lua 模块
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">lua_package_path&lt;/span> &lt;span class="s">&amp;#34;/usr/local/openresty/lualib/?.lua&lt;/span>&lt;span class="p">;&lt;/span>;&lt;span class="k">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#c模块
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">lua_package_cpath&lt;/span> &lt;span class="s">&amp;#34;/usr/local/openresty/lualib/?.so&lt;/span>&lt;span class="p">;&lt;/span>;&lt;span class="k">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>common.lua&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-6">&lt;a class="lnlinks" href="#hl-12-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-7">&lt;a class="lnlinks" href="#hl-12-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-8">&lt;a class="lnlinks" href="#hl-12-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-9">&lt;a class="lnlinks" href="#hl-12-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-10">&lt;a class="lnlinks" href="#hl-12-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-11">&lt;a class="lnlinks" href="#hl-12-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-12">&lt;a class="lnlinks" href="#hl-12-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-13">&lt;a class="lnlinks" href="#hl-12-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-14">&lt;a class="lnlinks" href="#hl-12-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-15">&lt;a class="lnlinks" href="#hl-12-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-16">&lt;a class="lnlinks" href="#hl-12-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-17">&lt;a class="lnlinks" href="#hl-12-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-18">&lt;a class="lnlinks" href="#hl-12-18">18&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 封装函数，发送http请求，并解析响应&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="kr">function&lt;/span> &lt;span class="nf">read_http&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.location&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">capture&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">method&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.HTTP_GET&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">args&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 记录错误信息，返回404&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;http not found, path: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span> &lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;, args: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">404&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">resp.body&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 将方法导出&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">_M&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">read_http&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_http&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">return&lt;/span> &lt;span class="n">_M&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>释放Redis连接API：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-6">&lt;a class="lnlinks" href="#hl-13-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-7">&lt;a class="lnlinks" href="#hl-13-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-8">&lt;a class="lnlinks" href="#hl-13-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-9">&lt;a class="lnlinks" href="#hl-13-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 关闭redis连接的工具方法，其实是放入连接池&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="kr">function&lt;/span> &lt;span class="nf">close_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">red&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">pool_max_idle_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">10000&lt;/span> &lt;span class="c1">-- 连接的空闲时间，单位是毫秒&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">pool_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">100&lt;/span> &lt;span class="c1">--连接池大小&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">ok&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">set_keepalive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pool_max_idle_time&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pool_size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">ok&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;放入redis连接池失败: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>读取Redis数据的API：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-5">&lt;a class="lnlinks" href="#hl-14-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-6">&lt;a class="lnlinks" href="#hl-14-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-7">&lt;a class="lnlinks" href="#hl-14-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-8">&lt;a class="lnlinks" href="#hl-14-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-9">&lt;a class="lnlinks" href="#hl-14-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-10">&lt;a class="lnlinks" href="#hl-14-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-11">&lt;a class="lnlinks" href="#hl-14-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-12">&lt;a class="lnlinks" href="#hl-14-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-13">&lt;a class="lnlinks" href="#hl-14-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-14">&lt;a class="lnlinks" href="#hl-14-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-15">&lt;a class="lnlinks" href="#hl-14-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-16">&lt;a class="lnlinks" href="#hl-14-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-17">&lt;a class="lnlinks" href="#hl-14-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-18">&lt;a class="lnlinks" href="#hl-14-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-19">&lt;a class="lnlinks" href="#hl-14-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-20">&lt;a class="lnlinks" href="#hl-14-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-21">&lt;a class="lnlinks" href="#hl-14-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-22">&lt;a class="lnlinks" href="#hl-14-22">22&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 查询redis的方法 ip和port是redis地址，key是查询的key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="kr">function&lt;/span> &lt;span class="nf">read_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 获取一个连接&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">ok&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">connect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">ok&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;连接redis失败 : &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询失败处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;查询Redis失败: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;, key = &amp;#34;&lt;/span> &lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">--得到的数据为空处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">ngx.null&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">resp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;查询Redis数据为空, key = &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">close_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">red&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">resp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>开启共享词典：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 共享字典，也就是本地缓存，名称叫做：item_cache，大小150m
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">lua_shared_dict&lt;/span> &lt;span class="s">item_cache&lt;/span> &lt;span class="mi">150m&lt;/span>&lt;span class="p">;&lt;/span> 
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>11.案例导入说明</title><link>https://logan.wssw.fun/p/2023/01/34916834/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/34916834/</guid><description>&lt;h1 id="案例导入说明">
&lt;a href="#%e6%a1%88%e4%be%8b%e5%af%bc%e5%85%a5%e8%af%b4%e6%98%8e" class="header-anchor">#&lt;/a>
案例导入说明
&lt;/h1>&lt;p>为了演示多级缓存，我们先导入一个商品管理的案例，其中包含商品的CRUD功能。我们将来会给查询商品添加多级缓存。&lt;/p>
&lt;h1 id="1安装mysql">
&lt;a href="#1%e5%ae%89%e8%a3%85mysql" class="header-anchor">#&lt;/a>
1.安装MySQL
&lt;/h1>&lt;p>后期做数据同步需要用到MySQL的主从功能，所以需要大家在虚拟机中，利用Docker来运行一个MySQL容器。&lt;/p>
&lt;h2 id="11准备目录">
&lt;a href="#11%e5%87%86%e5%a4%87%e7%9b%ae%e5%bd%95" class="header-anchor">#&lt;/a>
1.1.准备目录
&lt;/h2>&lt;p>为了方便后期配置MySQL，我们先准备两个目录，用于挂载容器的数据和配置文件目录：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-6">&lt;a class="lnlinks" href="#hl-0-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入/tmp目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 创建文件夹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir mysql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入mysql目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> mysql
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="12运行命令">
&lt;a href="#12%e8%bf%90%e8%a1%8c%e5%91%bd%e4%bb%a4" class="header-anchor">#&lt;/a>
1.2.运行命令
&lt;/h2>&lt;p>进入mysql目录后，执行下面的Docker命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-9">&lt;a class="lnlinks" href="#hl-1-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-10">&lt;a class="lnlinks" href="#hl-1-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -p 3306:3306 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --name mysql &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v &lt;span class="nv">$PWD&lt;/span>/conf:/etc/mysql/conf.d &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v &lt;span class="nv">$PWD&lt;/span>/logs:/logs &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v &lt;span class="nv">$PWD&lt;/span>/data:/var/lib/mysql &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -e &lt;span class="nv">MYSQL_ROOT_PASSWORD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">123&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --privileged &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -d &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> mysql:5.7.25
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="13修改配置">
&lt;a href="#13%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
1.3.修改配置
&lt;/h2>&lt;p>在/tmp/mysql/conf目录添加一个my.cnf文件，作为mysql的配置文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 创建文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">touch /tmp/mysql/conf/my.cnf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>文件的内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[mysqld]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">skip-name-resolve&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">character_set_server&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">utf8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">datadir&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/var/lib/mysql&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server-id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">1000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="14重启">
&lt;a href="#14%e9%87%8d%e5%90%af" class="header-anchor">#&lt;/a>
1.4.重启
&lt;/h2>&lt;p>配置修改后，必须重启容器：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker restart mysql
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="2导入sql">
&lt;a href="#2%e5%af%bc%e5%85%a5sql" class="header-anchor">#&lt;/a>
2.导入SQL
&lt;/h1>&lt;p>接下来，利用Navicat客户端连接MySQL，然后导入课前资料提供的sql文件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-de371ac84f9640.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210809180936732"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中包含两张表：&lt;/p>
&lt;ul>
&lt;li>tb_item：商品表，包含商品的基本信息&lt;/li>
&lt;li>tb_item_stock：商品库存表，包含商品的库存信息&lt;/li>
&lt;/ul>
&lt;p>之所以将库存分离出来，是因为库存是更新比较频繁的信息，写操作较多。而其他信息修改的频率非常低。&lt;/p>
&lt;h1 id="3导入demo工程">
&lt;a href="#3%e5%af%bc%e5%85%a5demo%e5%b7%a5%e7%a8%8b" class="header-anchor">#&lt;/a>
3.导入Demo工程
&lt;/h1>&lt;p>下面导入课前资料提供的工程：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-f43ea875906c0a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210809181147502"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>项目结构如图所示：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-5a50630633dc09.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210809181346450"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的业务包括：&lt;/p>
&lt;ul>
&lt;li>分页查询商品&lt;/li>
&lt;li>新增商品&lt;/li>
&lt;li>修改商品&lt;/li>
&lt;li>修改库存&lt;/li>
&lt;li>删除商品&lt;/li>
&lt;li>根据id查询商品&lt;/li>
&lt;li>根据id查询库存&lt;/li>
&lt;/ul>
&lt;p>业务全部使用mybatis-plus来实现，如有需要请自行修改业务逻辑。&lt;/p>
&lt;h2 id="31分页查询商品">
&lt;a href="#31%e5%88%86%e9%a1%b5%e6%9f%a5%e8%af%a2%e5%95%86%e5%93%81" class="header-anchor">#&lt;/a>
3.1.分页查询商品
&lt;/h2>&lt;p>在&lt;code>com.heima.item.web&lt;/code>包的&lt;code>ItemController&lt;/code>中可以看到接口定义：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-29a133e3ea079a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210809181554563"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="32新增商品">
&lt;a href="#32%e6%96%b0%e5%a2%9e%e5%95%86%e5%93%81" class="header-anchor">#&lt;/a>
3.2.新增商品
&lt;/h2>&lt;p>在&lt;code>com.heima.item.web&lt;/code>包的&lt;code>ItemController&lt;/code>中可以看到接口定义：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-a7375ea1e87ee1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210809181646907"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="33修改商品">
&lt;a href="#33%e4%bf%ae%e6%94%b9%e5%95%86%e5%93%81" class="header-anchor">#&lt;/a>
3.3.修改商品
&lt;/h2>&lt;p>在&lt;code>com.heima.item.web&lt;/code>包的&lt;code>ItemController&lt;/code>中可以看到接口定义：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-6779ef4d36919f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210809181714607"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="34修改库存">
&lt;a href="#34%e4%bf%ae%e6%94%b9%e5%ba%93%e5%ad%98" class="header-anchor">#&lt;/a>
3.4.修改库存
&lt;/h2>&lt;p>在&lt;code>com.heima.item.web&lt;/code>包的&lt;code>ItemController&lt;/code>中可以看到接口定义：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-02d3756e5833f1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210809181744011"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="35删除商品">
&lt;a href="#35%e5%88%a0%e9%99%a4%e5%95%86%e5%93%81" class="header-anchor">#&lt;/a>
3.5.删除商品
&lt;/h2>&lt;p>在&lt;code>com.heima.item.web&lt;/code>包的&lt;code>ItemController&lt;/code>中可以看到接口定义：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-60da2f27b12f2c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210809181821696"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这里是采用了逻辑删除，将商品状态修改为3&lt;/p>
&lt;h2 id="36根据id查询商品">
&lt;a href="#36%e6%a0%b9%e6%8d%aeid%e6%9f%a5%e8%af%a2%e5%95%86%e5%93%81" class="header-anchor">#&lt;/a>
3.6.根据id查询商品
&lt;/h2>&lt;p>在&lt;code>com.heima.item.web&lt;/code>包的&lt;code>ItemController&lt;/code>中可以看到接口定义：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-c506442803b32d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210809181901823"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这里只返回了商品信息，不包含库存&lt;/p>
&lt;h2 id="37根据id查询库存">
&lt;a href="#37%e6%a0%b9%e6%8d%aeid%e6%9f%a5%e8%af%a2%e5%ba%93%e5%ad%98" class="header-anchor">#&lt;/a>
3.7.根据id查询库存
&lt;/h2>&lt;p>在&lt;code>com.heima.item.web&lt;/code>包的&lt;code>ItemController&lt;/code>中可以看到接口定义：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-c82822629e1a55.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210809181932805"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="38启动">
&lt;a href="#38%e5%90%af%e5%8a%a8" class="header-anchor">#&lt;/a>
3.8.启动
&lt;/h2>&lt;p>注意修改application.yml文件中配置的mysql地址信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-cd815a02eb9ee1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210809182350132"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>需要修改为自己的虚拟机地址信息、还有账号和密码。&lt;/p>
&lt;p>修改后，启动服务，访问：http://localhost:8081/item/10001即可查询数据&lt;/p>
&lt;h1 id="4导入商品查询页面">
&lt;a href="#4%e5%af%bc%e5%85%a5%e5%95%86%e5%93%81%e6%9f%a5%e8%af%a2%e9%a1%b5%e9%9d%a2" class="header-anchor">#&lt;/a>
4.导入商品查询页面
&lt;/h1>&lt;p>商品查询是购物页面，与商品管理的页面是分离的。&lt;/p>
&lt;p>部署方式如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-6eb76a6bdd33cd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210816111210961"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们需要准备一个反向代理的nginx服务器，如上图红框所示，将静态的商品页面放到nginx目录中。&lt;/p>
&lt;p>页面需要的数据通过ajax向服务端（nginx业务集群）查询。&lt;/p>
&lt;h2 id="41运行nginx服务">
&lt;a href="#41%e8%bf%90%e8%a1%8cnginx%e6%9c%8d%e5%8a%a1" class="header-anchor">#&lt;/a>
4.1.运行nginx服务
&lt;/h2>&lt;p>这里我已经给大家准备好了nginx反向代理服务器和静态资源。&lt;/p>
&lt;p>我们找到课前资料的nginx目录：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-b9030fca5c95ed.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210816111348353"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>将其拷贝到一个非中文目录下，运行这个nginx服务。&lt;/p>
&lt;p>运行命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">start &lt;/span>&lt;span class="n">nginx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后访问 http://localhost/item.html?id=10001即可：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-d289846bfceaf0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210816112323632"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="42反向代理">
&lt;a href="#42%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86" class="header-anchor">#&lt;/a>
4.2.反向代理
&lt;/h2>&lt;p>现在，页面是假数据展示的。我们需要向服务器发送ajax请求，查询商品数据。&lt;/p>
&lt;p>打开控制台，可以看到页面有发起ajax查询数据：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-61778e11a70a0e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210816113816958"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>而这个请求地址同样是80端口，所以被当前的nginx反向代理了。&lt;/p>
&lt;p>查看nginx的conf目录下的nginx.conf文件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-3ece18afc5abbe.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210816113917002"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的关键配置如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-2c8aa87e0004cd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210816114416561"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的192.168.150.101是我的虚拟机IP，也就是我的Nginx业务集群要部署的地方：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740267-396eedeac6a58d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210816114554645"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>完整内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-5">&lt;a class="lnlinks" href="#hl-6-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-6">&lt;a class="lnlinks" href="#hl-6-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-7">&lt;a class="lnlinks" href="#hl-6-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-8">&lt;a class="lnlinks" href="#hl-6-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-9">&lt;a class="lnlinks" href="#hl-6-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-10">&lt;a class="lnlinks" href="#hl-6-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-11">&lt;a class="lnlinks" href="#hl-6-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-12">&lt;a class="lnlinks" href="#hl-6-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-13">&lt;a class="lnlinks" href="#hl-6-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-14">&lt;a class="lnlinks" href="#hl-6-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-15">&lt;a class="lnlinks" href="#hl-6-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-16">&lt;a class="lnlinks" href="#hl-6-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-17">&lt;a class="lnlinks" href="#hl-6-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-18">&lt;a class="lnlinks" href="#hl-6-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-19">&lt;a class="lnlinks" href="#hl-6-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-20">&lt;a class="lnlinks" href="#hl-6-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-21">&lt;a class="lnlinks" href="#hl-6-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-22">&lt;a class="lnlinks" href="#hl-6-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-23">&lt;a class="lnlinks" href="#hl-6-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-24">&lt;a class="lnlinks" href="#hl-6-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-25">&lt;a class="lnlinks" href="#hl-6-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-26">&lt;a class="lnlinks" href="#hl-6-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-27">&lt;a class="lnlinks" href="#hl-6-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-28">&lt;a class="lnlinks" href="#hl-6-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-29">&lt;a class="lnlinks" href="#hl-6-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-30">&lt;a class="lnlinks" href="#hl-6-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-31">&lt;a class="lnlinks" href="#hl-6-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-32">&lt;a class="lnlinks" href="#hl-6-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-33">&lt;a class="lnlinks" href="#hl-6-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-34">&lt;a class="lnlinks" href="#hl-6-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-35">&lt;a class="lnlinks" href="#hl-6-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-36">&lt;a class="lnlinks" href="#hl-6-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-37">&lt;a class="lnlinks" href="#hl-6-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-38">&lt;a class="lnlinks" href="#hl-6-38">38&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#user nobody;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">worker_processes&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">events&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">worker_connections&lt;/span> &lt;span class="mi">1024&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">http&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">include&lt;/span> &lt;span class="s">mime.types&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">default_type&lt;/span> &lt;span class="s">application/octet-stream&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">sendfile&lt;/span> &lt;span class="no">on&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#tcp_nopush on;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">keepalive_timeout&lt;/span> &lt;span class="mi">65&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">upstream&lt;/span> &lt;span class="s">nginx-cluster&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">192.168.150.101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8081&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">80&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">localhost&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/api&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://nginx-cluster&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">root&lt;/span> &lt;span class="s">html&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">index&lt;/span> &lt;span class="s">index.html&lt;/span> &lt;span class="s">index.htm&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">error_page&lt;/span> &lt;span class="mi">500&lt;/span> &lt;span class="mi">502&lt;/span> &lt;span class="mi">503&lt;/span> &lt;span class="mi">504&lt;/span> &lt;span class="s">/50x.html&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">/50x.html&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">root&lt;/span> &lt;span class="s">html&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>11.多级缓存</title><link>https://logan.wssw.fun/p/2023/01/38u56138/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/38u56138/</guid><description>&lt;h1 id="多级缓存">
&lt;a href="#%e5%a4%9a%e7%ba%a7%e7%bc%93%e5%ad%98" class="header-anchor">#&lt;/a>
多级缓存
&lt;/h1>&lt;h1 id="0学习目标">
&lt;a href="#0%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87" class="header-anchor">#&lt;/a>
0.学习目标
&lt;/h1>&lt;h1 id="1什么是多级缓存">
&lt;a href="#1%e4%bb%80%e4%b9%88%e6%98%af%e5%a4%9a%e7%ba%a7%e7%bc%93%e5%ad%98" class="header-anchor">#&lt;/a>
1.什么是多级缓存
&lt;/h1>&lt;p>传统的缓存策略一般是请求到达Tomcat后，先查询Redis，如果未命中则查询数据库，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-6b4cf6935932c9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821075259137"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>存在下面的问题：&lt;/p>
&lt;p>•请求要经过Tomcat处理，Tomcat的性能成为整个系统的瓶颈&lt;/p>
&lt;p>•Redis缓存失效时，会对数据库产生冲击&lt;/p>
&lt;p>多级缓存就是充分利用请求处理的每个环节，分别添加缓存，减轻Tomcat压力，提升服务性能：&lt;/p>
&lt;ul>
&lt;li>浏览器访问静态资源时，优先读取浏览器本地缓存&lt;/li>
&lt;li>访问非静态资源（ajax查询数据）时，访问服务端&lt;/li>
&lt;li>请求到达Nginx后，优先读取Nginx本地缓存&lt;/li>
&lt;li>如果Nginx本地缓存未命中，则去直接查询Redis（不经过Tomcat）&lt;/li>
&lt;li>如果Redis查询未命中，则查询Tomcat&lt;/li>
&lt;li>请求进入Tomcat后，优先查询JVM进程缓存&lt;/li>
&lt;li>如果JVM进程缓存未命中，则查询数据库&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-91cd2f64c1ec56.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821075558137"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在多级缓存架构中，Nginx内部需要编写本地缓存查询、Redis查询、Tomcat查询的业务逻辑，因此这样的nginx服务不再是一个&lt;strong>反向代理服务器&lt;/strong>，而是一个编写&lt;strong>业务的Web服务器了&lt;/strong>。&lt;/p>
&lt;p>因此这样的业务Nginx服务也需要搭建集群来提高并发，再有专门的nginx服务来做反向代理，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-6fa164613e5285.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821080511581"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>另外，我们的Tomcat服务将来也会部署为集群模式：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-50f2f461935883.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821080954947"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可见，多级缓存的关键有两个：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>一个是在nginx中编写业务，实现nginx本地缓存、Redis、Tomcat的查询&lt;/p>
&lt;/li>
&lt;li>
&lt;p>另一个就是在Tomcat中实现JVM进程缓存&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>其中Nginx编程则会用到OpenResty框架结合Lua这样的语言。&lt;/p>
&lt;p>这也是今天课程的难点和重点。&lt;/p>
&lt;h1 id="2jvm进程缓存">
&lt;a href="#2jvm%e8%bf%9b%e7%a8%8b%e7%bc%93%e5%ad%98" class="header-anchor">#&lt;/a>
2.JVM进程缓存
&lt;/h1>&lt;p>为了演示多级缓存的案例，我们先准备一个商品查询的业务。&lt;/p>
&lt;h2 id="21导入案例">
&lt;a href="#21%e5%af%bc%e5%85%a5%e6%a1%88%e4%be%8b" class="header-anchor">#&lt;/a>
2.1.导入案例
&lt;/h2>&lt;p>参考课前资料的：《案例导入说明.md》&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-8b7ffcbb0dcb83.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821081418456"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="22初识caffeine">
&lt;a href="#22%e5%88%9d%e8%af%86caffeine" class="header-anchor">#&lt;/a>
2.2.初识Caffeine
&lt;/h2>&lt;p>缓存在日常开发中启动至关重要的作用，由于是存储在内存中，数据的读取速度是非常快的，能大量减少对数据库的访问，减少数据库的压力。我们把缓存分为两类：&lt;/p>
&lt;ul>
&lt;li>分布式缓存，例如Redis：
&lt;ul>
&lt;li>优点：存储容量更大、可靠性更好、可以在集群间共享&lt;/li>
&lt;li>缺点：访问缓存有网络开销&lt;/li>
&lt;li>场景：缓存数据量较大、可靠性要求较高、需要在集群间共享&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>进程本地缓存，例如HashMap、GuavaCache：
&lt;ul>
&lt;li>优点：读取本地内存，没有网络开销，速度更快&lt;/li>
&lt;li>缺点：存储容量有限、可靠性较低、无法共享&lt;/li>
&lt;li>场景：性能要求较高，缓存数据量较小&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>我们今天会利用Caffeine框架来实现JVM进程缓存。&lt;/p>
&lt;p>&lt;strong>Caffeine&lt;/strong>是一个基于Java8开发的，提供了近乎最佳命中率的高性能的本地缓存库。目前Spring内部的缓存使用的就是Caffeine。GitHub地址：https://github.com/ben-manes/caffeine&lt;/p>
&lt;p>Caffeine的性能非常好，下图是官方给出的性能对比：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-82b12bb60fdc07.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821081826399"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到Caffeine的性能遥遥领先！&lt;/p>
&lt;p>缓存使用的基本API：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-6">&lt;a class="lnlinks" href="#hl-0-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-7">&lt;a class="lnlinks" href="#hl-0-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-8">&lt;a class="lnlinks" href="#hl-0-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-9">&lt;a class="lnlinks" href="#hl-0-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-10">&lt;a class="lnlinks" href="#hl-0-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-11">&lt;a class="lnlinks" href="#hl-0-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-12">&lt;a class="lnlinks" href="#hl-0-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-13">&lt;a class="lnlinks" href="#hl-0-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-14">&lt;a class="lnlinks" href="#hl-0-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-15">&lt;a class="lnlinks" href="#hl-0-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-16">&lt;a class="lnlinks" href="#hl-0-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-17">&lt;a class="lnlinks" href="#hl-0-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-18">&lt;a class="lnlinks" href="#hl-0-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-19">&lt;a class="lnlinks" href="#hl-0-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-20">&lt;a class="lnlinks" href="#hl-0-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-21">&lt;a class="lnlinks" href="#hl-0-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-22">&lt;a class="lnlinks" href="#hl-0-22">22&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testBasicOps&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 构建cache对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Cache&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Caffeine&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">newBuilder&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 存数据&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;gf&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;迪丽热巴&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 取数据&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">gf&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIfPresent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;gf&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;gf = &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">gf&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 取数据，包含两个参数：&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 参数一：缓存的key&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 参数二：Lambda表达式，表达式参数就是缓存的key，方法体是查询数据库的逻辑&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 优先根据key查询JVM缓存，如果未命中，则执行参数二的Lambda表达式&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">defaultGF&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;defaultGF&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 根据key去数据库查询数据&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;柳岩&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">});&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;defaultGF = &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">defaultGF&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Caffeine既然是缓存的一种，肯定需要有缓存的清除策略，不然的话内存总会有耗尽的时候。&lt;/p>
&lt;p>Caffeine提供了三种缓存驱逐策略：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>基于容量&lt;/strong>：设置缓存的数量上限&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 创建缓存对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Cache&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Caffeine&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">newBuilder&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">maximumSize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// 设置缓存大小上限为 1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;strong>基于时间&lt;/strong>：设置缓存的有效时间&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 创建缓存对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Cache&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Caffeine&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">newBuilder&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 设置缓存有效期为 10 秒，从最后一次写入开始计时 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">expireAfterWrite&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Duration&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ofSeconds&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">10&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;strong>基于引用&lt;/strong>：设置缓存为软引用或弱引用，利用GC来回收缓存数据。性能较差，不建议使用。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>&lt;strong>注意&lt;/strong>：在默认情况下，当一个缓存元素过期的时候，Caffeine不会自动立即将其清理和驱逐。而是在一次读或写操作后，或者在空闲时间完成对失效数据的驱逐。&lt;/p>
&lt;/blockquote>
&lt;h2 id="23实现jvm进程缓存">
&lt;a href="#23%e5%ae%9e%e7%8e%b0jvm%e8%bf%9b%e7%a8%8b%e7%bc%93%e5%ad%98" class="header-anchor">#&lt;/a>
2.3.实现JVM进程缓存
&lt;/h2>&lt;h3 id="231需求">
&lt;a href="#231%e9%9c%80%e6%b1%82" class="header-anchor">#&lt;/a>
2.3.1.需求
&lt;/h3>&lt;p>利用Caffeine实现下列需求：&lt;/p>
&lt;ul>
&lt;li>给根据id查询商品的业务添加缓存，缓存未命中时查询数据库&lt;/li>
&lt;li>给根据id查询商品库存的业务添加缓存，缓存未命中时查询数据库&lt;/li>
&lt;li>缓存初始大小为100&lt;/li>
&lt;li>缓存上限为10000&lt;/li>
&lt;/ul>
&lt;h3 id="232实现">
&lt;a href="#232%e5%ae%9e%e7%8e%b0" class="header-anchor">#&lt;/a>
2.3.2.实现
&lt;/h3>&lt;p>首先，我们需要定义两个Caffeine的缓存对象，分别保存商品、库存的缓存数据。&lt;/p>
&lt;p>在item-service的&lt;code>com.heima.item.config&lt;/code>包下定义&lt;code>CaffeineConfig&lt;/code>类：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-7">&lt;a class="lnlinks" href="#hl-3-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-8">&lt;a class="lnlinks" href="#hl-3-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-9">&lt;a class="lnlinks" href="#hl-3-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-10">&lt;a class="lnlinks" href="#hl-3-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-11">&lt;a class="lnlinks" href="#hl-3-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-12">&lt;a class="lnlinks" href="#hl-3-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-13">&lt;a class="lnlinks" href="#hl-3-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-14">&lt;a class="lnlinks" href="#hl-3-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-15">&lt;a class="lnlinks" href="#hl-3-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-16">&lt;a class="lnlinks" href="#hl-3-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-17">&lt;a class="lnlinks" href="#hl-3-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-18">&lt;a class="lnlinks" href="#hl-3-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-19">&lt;a class="lnlinks" href="#hl-3-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-20">&lt;a class="lnlinks" href="#hl-3-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-21">&lt;a class="lnlinks" href="#hl-3-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-22">&lt;a class="lnlinks" href="#hl-3-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-23">&lt;a class="lnlinks" href="#hl-3-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-24">&lt;a class="lnlinks" href="#hl-3-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-25">&lt;a class="lnlinks" href="#hl-3-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-26">&lt;a class="lnlinks" href="#hl-3-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-27">&lt;a class="lnlinks" href="#hl-3-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-28">&lt;a class="lnlinks" href="#hl-3-28">28&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.config&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.github.benmanes.caffeine.cache.Cache&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.github.benmanes.caffeine.cache.Caffeine&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.pojo.Item&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.pojo.ItemStock&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.context.annotation.Bean&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.context.annotation.Configuration&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Configuration&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">CaffeineConfig&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Cache&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">itemCache&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Caffeine&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">newBuilder&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">initialCapacity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">100&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">maximumSize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">10_000&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Cache&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ItemStock&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">stockCache&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Caffeine&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">newBuilder&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">initialCapacity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">100&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">maximumSize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">10_000&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后，修改item-service中的&lt;code>com.heima.item.web&lt;/code>包下的ItemController类，添加缓存逻辑：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-5">&lt;a class="lnlinks" href="#hl-4-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-6">&lt;a class="lnlinks" href="#hl-4-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-7">&lt;a class="lnlinks" href="#hl-4-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-8">&lt;a class="lnlinks" href="#hl-4-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-9">&lt;a class="lnlinks" href="#hl-4-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-10">&lt;a class="lnlinks" href="#hl-4-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-11">&lt;a class="lnlinks" href="#hl-4-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-12">&lt;a class="lnlinks" href="#hl-4-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-13">&lt;a class="lnlinks" href="#hl-4-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-14">&lt;a class="lnlinks" href="#hl-4-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-15">&lt;a class="lnlinks" href="#hl-4-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-16">&lt;a class="lnlinks" href="#hl-4-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-17">&lt;a class="lnlinks" href="#hl-4-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-18">&lt;a class="lnlinks" href="#hl-4-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-19">&lt;a class="lnlinks" href="#hl-4-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-20">&lt;a class="lnlinks" href="#hl-4-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-21">&lt;a class="lnlinks" href="#hl-4-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-22">&lt;a class="lnlinks" href="#hl-4-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-23">&lt;a class="lnlinks" href="#hl-4-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-24">&lt;a class="lnlinks" href="#hl-4-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-25">&lt;a class="lnlinks" href="#hl-4-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-26">&lt;a class="lnlinks" href="#hl-4-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-27">&lt;a class="lnlinks" href="#hl-4-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-28">&lt;a class="lnlinks" href="#hl-4-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-29">&lt;a class="lnlinks" href="#hl-4-29">29&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RestController&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@RequestMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;item&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">ItemController&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IItemService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IItemStockService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stockService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Cache&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemCache&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Cache&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ItemStock&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stockCache&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// ...其它略&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@GetMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/{id}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">findById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nd">@PathVariable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemCache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">query&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ne&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;status&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">3&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">eq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">one&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@GetMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/stock/{id}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ItemStock&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">findStockById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nd">@PathVariable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stockCache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stockService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="3lua语法入门">
&lt;a href="#3lua%e8%af%ad%e6%b3%95%e5%85%a5%e9%97%a8" class="header-anchor">#&lt;/a>
3.Lua语法入门
&lt;/h1>&lt;p>Nginx编程需要用到Lua语言，因此我们必须先入门Lua的基本语法。&lt;/p>
&lt;h2 id="31初识lua">
&lt;a href="#31%e5%88%9d%e8%af%86lua" class="header-anchor">#&lt;/a>
3.1.初识Lua
&lt;/h2>&lt;p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。官网：https://www.lua.org/&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-afa14e0ebc5cfe.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821091437975"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>Lua经常嵌入到C语言开发的程序中，例如游戏开发、游戏插件等。&lt;/p>
&lt;p>Nginx本身也是C语言开发，因此也允许基于Lua做拓展。&lt;/p>
&lt;h2 id="31helloworld">
&lt;a href="#31helloworld" class="header-anchor">#&lt;/a>
3.1.HelloWorld
&lt;/h2>&lt;p>CentOS7默认已经安装了Lua语言环境，所以可以直接运行Lua代码。&lt;/p>
&lt;p>1）在Linux虚拟机的任意目录下，新建一个hello.lua文件&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-5187e7ef3d4dba.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821091621308"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>2）添加下面的内容&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="n">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Hello World!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）运行&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-2b7b8698a5fd57.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821091638140"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="32变量和循环">
&lt;a href="#32%e5%8f%98%e9%87%8f%e5%92%8c%e5%be%aa%e7%8e%af" class="header-anchor">#&lt;/a>
3.2.变量和循环
&lt;/h2>&lt;p>学习任何语言必然离不开变量，而变量的声明必须先知道数据的类型。&lt;/p>
&lt;h3 id="321lua的数据类型">
&lt;a href="#321lua%e7%9a%84%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b" class="header-anchor">#&lt;/a>
3.2.1.Lua的数据类型
&lt;/h3>&lt;p>Lua中支持的常见数据类型包括：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-3d7c06974547cd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821091835406"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>另外，Lua提供了type()函数来判断一个变量的数据类型：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-dac06d2f067482.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821091904332"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="322声明变量">
&lt;a href="#322%e5%a3%b0%e6%98%8e%e5%8f%98%e9%87%8f" class="header-anchor">#&lt;/a>
3.2.2.声明变量
&lt;/h3>&lt;p>Lua声明变量的时候无需指定数据类型，而是用local来声明变量为局部变量：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-5">&lt;a class="lnlinks" href="#hl-6-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-6">&lt;a class="lnlinks" href="#hl-6-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-7">&lt;a class="lnlinks" href="#hl-6-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-8">&lt;a class="lnlinks" href="#hl-6-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 声明字符串，可以用单引号或双引号，&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;hello&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 字符串拼接可以使用 ..&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">str2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;hello&amp;#39;&lt;/span> &lt;span class="o">..&lt;/span> &lt;span class="s1">&amp;#39;world&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 声明数字&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">num&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">21&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 声明布尔类型&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">flag&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Lua中的table类型既可以作为数组，又可以作为Java中的map来使用。数组就是特殊的table，key是数组角标而已：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 声明数组 ，key为角标的 table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">arr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;java&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;python&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;lua&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 声明table，类似java的map&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">map&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;Jack&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">age&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">21&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Lua中的数组角标是从1开始，访问的时候与Java中类似：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 访问数组，lua数组的角标从1开始&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Lua中的table可以用key来访问：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 访问table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">map.name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="323循环">
&lt;a href="#323%e5%be%aa%e7%8e%af" class="header-anchor">#&lt;/a>
3.2.3.循环
&lt;/h3>&lt;p>对于table，我们可以利用for循环来遍历。不过数组和普通table遍历略有差异。&lt;/p>
&lt;p>遍历数组：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-5">&lt;a class="lnlinks" href="#hl-10-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-6">&lt;a class="lnlinks" href="#hl-10-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 声明数组 key为索引的 table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">arr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;java&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;python&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;lua&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 遍历数组&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">for&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="kr">in&lt;/span> &lt;span class="n">ipairs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>遍历普通table&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-5">&lt;a class="lnlinks" href="#hl-11-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-6">&lt;a class="lnlinks" href="#hl-11-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 声明map，也就是table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">map&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;Jack&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">age&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">21&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 遍历table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">for&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="kr">in&lt;/span> &lt;span class="n">pairs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="33条件控制函数">
&lt;a href="#33%e6%9d%a1%e4%bb%b6%e6%8e%a7%e5%88%b6%e5%87%bd%e6%95%b0" class="header-anchor">#&lt;/a>
3.3.条件控制、函数
&lt;/h2>&lt;p>Lua中的条件控制和函数声明与Java类似。&lt;/p>
&lt;h3 id="331函数">
&lt;a href="#331%e5%87%bd%e6%95%b0" class="header-anchor">#&lt;/a>
3.3.1.函数
&lt;/h3>&lt;p>定义函数的语法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">function&lt;/span> &lt;span class="nf">函数名&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="n">argument1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">argument2&lt;/span>&lt;span class="p">...,&lt;/span> &lt;span class="n">argumentn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 函数体&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="err">返回值&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>例如，定义一个函数，用来打印数组：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">function&lt;/span> &lt;span class="nf">printArr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">for&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="kr">in&lt;/span> &lt;span class="n">ipairs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="332条件控制">
&lt;a href="#332%e6%9d%a1%e4%bb%b6%e6%8e%a7%e5%88%b6" class="header-anchor">#&lt;/a>
3.3.2.条件控制
&lt;/h3>&lt;p>类似Java的条件控制，例如if、else语法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-5">&lt;a class="lnlinks" href="#hl-14-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-6">&lt;a class="lnlinks" href="#hl-14-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">布尔表达式&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">--[ 布尔表达式为 true 时执行该语句块 --]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">--[ 布尔表达式为 false 时执行该语句块 --]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>与java不同，布尔表达式中的逻辑运算是基于英文单词：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-43dbec1b754118.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821092657918"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="333案例">
&lt;a href="#333%e6%a1%88%e4%be%8b" class="header-anchor">#&lt;/a>
3.3.3.案例
&lt;/h3>&lt;p>需求：自定义一个函数，可以打印table，当参数为nil时，打印错误信息&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-6">&lt;a class="lnlinks" href="#hl-15-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-7">&lt;a class="lnlinks" href="#hl-15-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-8">&lt;a class="lnlinks" href="#hl-15-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">function&lt;/span> &lt;span class="nf">printArr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">arr&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;数组不能为空！&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">for&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="kr">in&lt;/span> &lt;span class="n">ipairs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="4实现多级缓存">
&lt;a href="#4%e5%ae%9e%e7%8e%b0%e5%a4%9a%e7%ba%a7%e7%bc%93%e5%ad%98" class="header-anchor">#&lt;/a>
4.实现多级缓存
&lt;/h1>&lt;p>多级缓存的实现离不开Nginx编程，而Nginx编程又离不开OpenResty。&lt;/p>
&lt;h2 id="41安装openresty">
&lt;a href="#41%e5%ae%89%e8%a3%85openresty" class="header-anchor">#&lt;/a>
4.1.安装OpenResty
&lt;/h2>&lt;p>OpenResty® 是一个基于 Nginx的高性能 Web 平台，用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。具备下列特点：&lt;/p>
&lt;ul>
&lt;li>具备Nginx的完整功能&lt;/li>
&lt;li>基于Lua语言进行扩展，集成了大量精良的 Lua 库、第三方模块&lt;/li>
&lt;li>允许使用Lua&lt;strong>自定义业务逻辑&lt;/strong>、&lt;strong>自定义库&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>官方网站： &lt;a class="link" href="https://openresty.org/cn/" target="_blank" rel="noopener"
>https://openresty.org/cn/
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-f76ae006ba604a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821092902946"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>安装Lua可以参考课前资料提供的《安装OpenResty.md》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-73675cae296a49.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821092941139"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="42openresty快速入门">
&lt;a href="#42openresty%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8" class="header-anchor">#&lt;/a>
4.2.OpenResty快速入门
&lt;/h2>&lt;p>我们希望达到的多级缓存架构如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-2badcc1cb90174.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="yeVDlwtfMx"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>windows上的nginx用来做反向代理服务，将前端的查询商品的ajax请求代理到OpenResty集群&lt;/p>
&lt;/li>
&lt;li>
&lt;p>OpenResty集群用来编写多级缓存业务&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="421反向代理流程">
&lt;a href="#421%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e6%b5%81%e7%a8%8b" class="header-anchor">#&lt;/a>
4.2.1.反向代理流程
&lt;/h3>&lt;p>现在，商品详情页使用的是假的商品数据。不过在浏览器中，可以看到页面有发起ajax请求查询真实商品数据。&lt;/p>
&lt;p>这个请求如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-99b82aad8f9139.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821093144700"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>请求地址是localhost，端口是80，就被windows上安装的Nginx服务给接收到了。然后代理给了OpenResty集群：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-636c411d5a54ed.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821094447709"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们需要在OpenResty中编写业务，查询商品数据并返回到浏览器。&lt;/p>
&lt;p>但是这次，我们先在OpenResty接收请求，返回假的商品数据。&lt;/p>
&lt;h3 id="422openresty监听请求">
&lt;a href="#422openresty%e7%9b%91%e5%90%ac%e8%af%b7%e6%b1%82" class="header-anchor">#&lt;/a>
4.2.2.OpenResty监听请求
&lt;/h3>&lt;p>OpenResty的很多功能都依赖于其目录下的Lua库，需要在nginx.conf中指定依赖库的目录，并导入依赖：&lt;/p>
&lt;p>1）添加对OpenResty的Lua模块的加载&lt;/p>
&lt;p>修改&lt;code>/usr/local/openresty/nginx/conf/nginx.conf&lt;/code>文件，在其中的http下面，添加下面代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#lua 模块
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">lua_package_path&lt;/span> &lt;span class="s">&amp;#34;/usr/local/openresty/lualib/?.lua&lt;/span>&lt;span class="p">;&lt;/span>;&lt;span class="k">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#c模块
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">lua_package_cpath&lt;/span> &lt;span class="s">&amp;#34;/usr/local/openresty/lualib/?.so&lt;/span>&lt;span class="p">;&lt;/span>;&lt;span class="k">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）监听/api/item路径&lt;/p>
&lt;p>修改&lt;code>/usr/local/openresty/nginx/conf/nginx.conf&lt;/code>文件，在nginx.conf的server下面，添加对/api/item这个路径的监听：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-4">&lt;a class="lnlinks" href="#hl-17-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-5">&lt;a class="lnlinks" href="#hl-17-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-6">&lt;a class="lnlinks" href="#hl-17-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">location&lt;/span> &lt;span class="s">/api/item&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 默认的响应类型
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">default_type&lt;/span> &lt;span class="s">application/json&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 响应结果由lua/item.lua文件来决定
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">content_by_lua_file&lt;/span> &lt;span class="s">lua/item.lua&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个监听，就类似于SpringMVC中的&lt;code>@GetMapping(&amp;quot;/api/item&amp;quot;)&lt;/code>做路径映射。&lt;/p>
&lt;p>而&lt;code>content_by_lua_file lua/item.lua&lt;/code>则相当于调用item.lua这个文件，执行其中的业务，把结果返回给用户。相当于java中调用service。&lt;/p>
&lt;h3 id="423编写itemlua">
&lt;a href="#423%e7%bc%96%e5%86%99itemlua" class="header-anchor">#&lt;/a>
4.2.3.编写item.lua
&lt;/h3>&lt;p>1）在&lt;code>/usr/loca/openresty/nginx&lt;/code>目录创建文件夹：lua&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-cfffd32f06fa4b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821100755080"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>2）在&lt;code>/usr/loca/openresty/nginx/lua&lt;/code>文件夹下，新建文件：item.lua&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-426e1bd13638c2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821100801756"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>3）编写item.lua，返回假数据&lt;/p>
&lt;p>item.lua中，利用ngx.say()函数返回数据到Response中&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="n">ngx.say&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;{&amp;#34;id&amp;#34;:10001,&amp;#34;name&amp;#34;:&amp;#34;SALSA AIR&amp;#34;,&amp;#34;title&amp;#34;:&amp;#34;RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4&amp;#34;,&amp;#34;price&amp;#34;:17900,&amp;#34;image&amp;#34;:&amp;#34;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&amp;#34;,&amp;#34;category&amp;#34;:&amp;#34;拉杆箱&amp;#34;,&amp;#34;brand&amp;#34;:&amp;#34;RIMOWA&amp;#34;,&amp;#34;spec&amp;#34;:&amp;#34;&amp;#34;,&amp;#34;status&amp;#34;:1,&amp;#34;createTime&amp;#34;:&amp;#34;2019-04-30T16:00:00.000+00:00&amp;#34;,&amp;#34;updateTime&amp;#34;:&amp;#34;2019-04-30T16:00:00.000+00:00&amp;#34;,&amp;#34;stock&amp;#34;:2999,&amp;#34;sold&amp;#34;:31290}&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4）重新加载配置&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">nginx -s reload
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>刷新商品页面：http://localhost/item.html?id=1001，即可看到效果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-382aea9a153d9b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821101217089"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="43请求参数处理">
&lt;a href="#43%e8%af%b7%e6%b1%82%e5%8f%82%e6%95%b0%e5%a4%84%e7%90%86" class="header-anchor">#&lt;/a>
4.3.请求参数处理
&lt;/h2>&lt;p>上一节中，我们在OpenResty接收前端请求，但是返回的是假数据。&lt;/p>
&lt;p>要返回真实数据，必须根据前端传递来的商品id，查询商品信息才可以。&lt;/p>
&lt;p>那么如何获取前端传递的商品参数呢？&lt;/p>
&lt;h3 id="431获取参数的api">
&lt;a href="#431%e8%8e%b7%e5%8f%96%e5%8f%82%e6%95%b0%e7%9a%84api" class="header-anchor">#&lt;/a>
4.3.1.获取参数的API
&lt;/h3>&lt;p>OpenResty中提供了一些API用来获取不同类型的前端请求参数：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-74b4c35aaad51c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821101433528"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="432获取参数并返回">
&lt;a href="#432%e8%8e%b7%e5%8f%96%e5%8f%82%e6%95%b0%e5%b9%b6%e8%bf%94%e5%9b%9e" class="header-anchor">#&lt;/a>
4.3.2.获取参数并返回
&lt;/h3>&lt;p>在前端发起的ajax请求如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-af59202de07bf1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821101721649"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到商品id是以路径占位符方式传递的，因此可以利用正则表达式匹配的方式来获取ID&lt;/p>
&lt;p>1）获取商品id&lt;/p>
&lt;p>修改&lt;code>/usr/loca/openresty/nginx/nginx.conf&lt;/code>文件中监听/api/item的代码，利用正则表达式获取ID：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-4">&lt;a class="lnlinks" href="#hl-20-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-5">&lt;a class="lnlinks" href="#hl-20-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-6">&lt;a class="lnlinks" href="#hl-20-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">location&lt;/span> &lt;span class="p">~&lt;/span> &lt;span class="sr">/api/item/(\d+)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 默认的响应类型
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">default_type&lt;/span> &lt;span class="s">application/json&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 响应结果由lua/item.lua文件来决定
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">content_by_lua_file&lt;/span> &lt;span class="s">lua/item.lua&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）拼接ID并返回&lt;/p>
&lt;p>修改&lt;code>/usr/loca/openresty/nginx/lua/item.lua&lt;/code>文件，获取id并拼接到结果中返回：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-21-1">&lt;a class="lnlinks" href="#hl-21-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-2">&lt;a class="lnlinks" href="#hl-21-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-3">&lt;a class="lnlinks" href="#hl-21-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-4">&lt;a class="lnlinks" href="#hl-21-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 获取商品id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.var&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 拼接并返回&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ngx.say&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;{&amp;#34;id&amp;#34;:&amp;#39;&lt;/span> &lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">..&lt;/span> &lt;span class="s1">&amp;#39;,&amp;#34;name&amp;#34;:&amp;#34;SALSA AIR&amp;#34;,&amp;#34;title&amp;#34;:&amp;#34;RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4&amp;#34;,&amp;#34;price&amp;#34;:17900,&amp;#34;image&amp;#34;:&amp;#34;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&amp;#34;,&amp;#34;category&amp;#34;:&amp;#34;拉杆箱&amp;#34;,&amp;#34;brand&amp;#34;:&amp;#34;RIMOWA&amp;#34;,&amp;#34;spec&amp;#34;:&amp;#34;&amp;#34;,&amp;#34;status&amp;#34;:1,&amp;#34;createTime&amp;#34;:&amp;#34;2019-04-30T16:00:00.000+00:00&amp;#34;,&amp;#34;updateTime&amp;#34;:&amp;#34;2019-04-30T16:00:00.000+00:00&amp;#34;,&amp;#34;stock&amp;#34;:2999,&amp;#34;sold&amp;#34;:31290}&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）重新加载并测试&lt;/p>
&lt;p>运行命令以重新加载OpenResty配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-22-1">&lt;a class="lnlinks" href="#hl-22-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">nginx -s reload
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>刷新页面可以看到结果中已经带上了ID：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-03fbc61f58fa82.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821102235467"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="44查询tomcat">
&lt;a href="#44%e6%9f%a5%e8%af%a2tomcat" class="header-anchor">#&lt;/a>
4.4.查询Tomcat
&lt;/h2>&lt;p>拿到商品ID后，本应去缓存中查询商品信息，不过目前我们还未建立nginx、redis缓存。因此，这里我们先根据商品id去tomcat查询商品信息。我们实现如图部分：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-921ab74fb97837.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821102610167"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>需要注意的是，我们的OpenResty是在虚拟机，Tomcat是在Windows电脑上。两者IP一定不要搞错了。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-02022197b88de9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821102959829"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="441发送http请求的api">
&lt;a href="#441%e5%8f%91%e9%80%81http%e8%af%b7%e6%b1%82%e7%9a%84api" class="header-anchor">#&lt;/a>
4.4.1.发送http请求的API
&lt;/h3>&lt;p>nginx提供了内部API用以发送http请求：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-23-1">&lt;a class="lnlinks" href="#hl-23-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-2">&lt;a class="lnlinks" href="#hl-23-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-3">&lt;a class="lnlinks" href="#hl-23-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-4">&lt;a class="lnlinks" href="#hl-23-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.location&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">capture&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/path&amp;#34;&lt;/span>&lt;span class="p">,{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">method&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.HTTP_GET&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">-- 请求方式&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">args&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="c1">-- get方式传参数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>返回的响应内容包括：&lt;/p>
&lt;ul>
&lt;li>resp.status：响应状态码&lt;/li>
&lt;li>resp.header：响应头，是一个table&lt;/li>
&lt;li>resp.body：响应体，就是响应数据&lt;/li>
&lt;/ul>
&lt;p>注意：这里的path是路径，并不包含IP和端口。这个请求会被nginx内部的server监听并处理。&lt;/p>
&lt;p>但是我们希望这个请求发送到Tomcat服务器，所以还需要编写一个server来对这个路径做反向代理：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-24-1">&lt;a class="lnlinks" href="#hl-24-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-2">&lt;a class="lnlinks" href="#hl-24-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-3">&lt;a class="lnlinks" href="#hl-24-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-4">&lt;a class="lnlinks" href="#hl-24-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl"> &lt;span class="k">location&lt;/span> &lt;span class="s">/path&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 这里是windows电脑的ip和Java服务端口，需要确保windows防火墙处于关闭状态
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://192.168.150.1:8081&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>原理如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-e3a360d02f0c6c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821104149061"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="442封装http工具">
&lt;a href="#442%e5%b0%81%e8%a3%85http%e5%b7%a5%e5%85%b7" class="header-anchor">#&lt;/a>
4.4.2.封装http工具
&lt;/h3>&lt;p>下面，我们封装一个发送Http请求的工具，基于ngx.location.capture来实现查询tomcat。&lt;/p>
&lt;p>1）添加反向代理，到windows的Java服务&lt;/p>
&lt;p>因为item-service中的接口都是/item开头，所以我们监听/item路径，代理到windows上的tomcat服务。&lt;/p>
&lt;p>修改 &lt;code>/usr/local/openresty/nginx/conf/nginx.conf&lt;/code>文件，添加一个location：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-25-1">&lt;a class="lnlinks" href="#hl-25-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-2">&lt;a class="lnlinks" href="#hl-25-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-3">&lt;a class="lnlinks" href="#hl-25-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">location&lt;/span> &lt;span class="s">/item&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://192.168.150.1:8081&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>以后，只要我们调用&lt;code>ngx.location.capture(&amp;quot;/item&amp;quot;)&lt;/code>，就一定能发送请求到windows的tomcat服务。&lt;/p>
&lt;p>2）封装工具类&lt;/p>
&lt;p>之前我们说过，OpenResty启动时会加载以下两个目录中的工具文件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-d1113944054956.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821104857413"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>所以，自定义的http工具也需要放到这个目录下。&lt;/p>
&lt;p>在&lt;code>/usr/local/openresty/lualib&lt;/code>目录下，新建一个common.lua文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-26-1">&lt;a class="lnlinks" href="#hl-26-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">vi /usr/local/openresty/lualib/common.lua
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>内容如下:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-27-1">&lt;a class="lnlinks" href="#hl-27-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-2">&lt;a class="lnlinks" href="#hl-27-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-3">&lt;a class="lnlinks" href="#hl-27-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-4">&lt;a class="lnlinks" href="#hl-27-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-5">&lt;a class="lnlinks" href="#hl-27-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-6">&lt;a class="lnlinks" href="#hl-27-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-7">&lt;a class="lnlinks" href="#hl-27-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-8">&lt;a class="lnlinks" href="#hl-27-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-9">&lt;a class="lnlinks" href="#hl-27-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-10">&lt;a class="lnlinks" href="#hl-27-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-11">&lt;a class="lnlinks" href="#hl-27-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-12">&lt;a class="lnlinks" href="#hl-27-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-13">&lt;a class="lnlinks" href="#hl-27-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-14">&lt;a class="lnlinks" href="#hl-27-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-15">&lt;a class="lnlinks" href="#hl-27-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-16">&lt;a class="lnlinks" href="#hl-27-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-17">&lt;a class="lnlinks" href="#hl-27-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-18">&lt;a class="lnlinks" href="#hl-27-18">18&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 封装函数，发送http请求，并解析响应&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="kr">function&lt;/span> &lt;span class="nf">read_http&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.location&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">capture&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">method&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.HTTP_GET&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">args&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 记录错误信息，返回404&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;http请求查询失败, path: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span> &lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;, args: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">404&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">resp.body&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 将方法导出&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">_M&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">read_http&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_http&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">return&lt;/span> &lt;span class="n">_M&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个工具将read_http函数封装到_M这个table类型的变量中，并且返回，这类似于导出。&lt;/p>
&lt;p>使用的时候，可以利用&lt;code>require('common')&lt;/code>来导入该函数库，这里的common是函数库的文件名。&lt;/p>
&lt;p>3）实现商品查询&lt;/p>
&lt;p>最后，我们修改&lt;code>/usr/local/openresty/lua/item.lua&lt;/code>文件，利用刚刚封装的函数库实现对tomcat的查询：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-28-1">&lt;a class="lnlinks" href="#hl-28-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-2">&lt;a class="lnlinks" href="#hl-28-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-3">&lt;a class="lnlinks" href="#hl-28-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-4">&lt;a class="lnlinks" href="#hl-28-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-5">&lt;a class="lnlinks" href="#hl-28-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-6">&lt;a class="lnlinks" href="#hl-28-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-7">&lt;a class="lnlinks" href="#hl-28-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-8">&lt;a class="lnlinks" href="#hl-28-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-9">&lt;a class="lnlinks" href="#hl-28-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-10">&lt;a class="lnlinks" href="#hl-28-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 引入自定义common工具模块，返回值是common中返回的 _M&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">common&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;common&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 从 common中获取read_http这个函数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">read_http&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">common.read_http&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 获取路径参数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.var&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 根据id查询商品&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">itemJSON&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_http&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/item/&amp;#34;&lt;/span>&lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 根据id查询商品库存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">itemStockJSON&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_http&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/item/stock/&amp;#34;&lt;/span>&lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里查询到的结果是json字符串，并且包含商品、库存两个json字符串，页面最终需要的是把两个json拼接为一个json：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-9168867c4dd9db.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821110441222"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这就需要我们先把JSON变为lua的table，完成数据整合后，再转为JSON。&lt;/p>
&lt;h3 id="443cjson工具类">
&lt;a href="#443cjson%e5%b7%a5%e5%85%b7%e7%b1%bb" class="header-anchor">#&lt;/a>
4.4.3.CJSON工具类
&lt;/h3>&lt;p>OpenResty提供了一个cjson的模块用来处理JSON的序列化和反序列化。&lt;/p>
&lt;p>官方地址： &lt;a class="link" href="https://github.com/openresty/lua-cjson/" target="_blank" rel="noopener"
>https://github.com/openresty/lua-cjson/
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/p>
&lt;p>1）引入cjson模块：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-29-1">&lt;a class="lnlinks" href="#hl-29-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">cjson&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">require&lt;/span> &lt;span class="s2">&amp;#34;cjson&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）序列化：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-30-1">&lt;a class="lnlinks" href="#hl-30-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-2">&lt;a class="lnlinks" href="#hl-30-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-3">&lt;a class="lnlinks" href="#hl-30-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-4">&lt;a class="lnlinks" href="#hl-30-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-5">&lt;a class="lnlinks" href="#hl-30-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-6">&lt;a class="lnlinks" href="#hl-30-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">obj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;jack&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">age&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">21&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 把 table 序列化为 json&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">json&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cjson.encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）反序列化：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-31-1">&lt;a class="lnlinks" href="#hl-31-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-2">&lt;a class="lnlinks" href="#hl-31-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-3">&lt;a class="lnlinks" href="#hl-31-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-4">&lt;a class="lnlinks" href="#hl-31-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">json&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;{&amp;#34;name&amp;#34;: &amp;#34;jack&amp;#34;, &amp;#34;age&amp;#34;: 21}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 反序列化 json为 table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">obj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cjson.decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj.name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="444实现tomcat查询">
&lt;a href="#444%e5%ae%9e%e7%8e%b0tomcat%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
4.4.4.实现Tomcat查询
&lt;/h3>&lt;p>下面，我们修改之前的item.lua中的业务，添加json处理功能：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-32-1">&lt;a class="lnlinks" href="#hl-32-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-2">&lt;a class="lnlinks" href="#hl-32-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-3">&lt;a class="lnlinks" href="#hl-32-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-4">&lt;a class="lnlinks" href="#hl-32-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-5">&lt;a class="lnlinks" href="#hl-32-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-6">&lt;a class="lnlinks" href="#hl-32-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-7">&lt;a class="lnlinks" href="#hl-32-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-8">&lt;a class="lnlinks" href="#hl-32-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-9">&lt;a class="lnlinks" href="#hl-32-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-10">&lt;a class="lnlinks" href="#hl-32-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-11">&lt;a class="lnlinks" href="#hl-32-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-12">&lt;a class="lnlinks" href="#hl-32-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-13">&lt;a class="lnlinks" href="#hl-32-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-14">&lt;a class="lnlinks" href="#hl-32-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-15">&lt;a class="lnlinks" href="#hl-32-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-16">&lt;a class="lnlinks" href="#hl-32-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-17">&lt;a class="lnlinks" href="#hl-32-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-18">&lt;a class="lnlinks" href="#hl-32-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-19">&lt;a class="lnlinks" href="#hl-32-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-20">&lt;a class="lnlinks" href="#hl-32-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-21">&lt;a class="lnlinks" href="#hl-32-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-22">&lt;a class="lnlinks" href="#hl-32-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-23">&lt;a class="lnlinks" href="#hl-32-23">23&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 导入common函数库&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">common&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;common&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">read_http&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">common.read_http&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 导入cjson库&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">cjson&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;cjson&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 获取路径参数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.var&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 根据id查询商品&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">itemJSON&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_http&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/item/&amp;#34;&lt;/span>&lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 根据id查询商品库存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">itemStockJSON&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_http&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/item/stock/&amp;#34;&lt;/span>&lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- JSON转化为lua的table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">item&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cjson.decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">itemJSON&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">stock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cjson.decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stockJSON&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 组合数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">item.stock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">stock.stock&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">item.sold&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">stock.sold&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 把item序列化为json 返回结果&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ngx.say&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cjson.encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="445基于id负载均衡">
&lt;a href="#445%e5%9f%ba%e4%ba%8eid%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" class="header-anchor">#&lt;/a>
4.4.5.基于ID负载均衡
&lt;/h3>&lt;p>刚才的代码中，我们的tomcat是单机部署。而实际开发中，tomcat一定是集群模式：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-4ff2d5975d2d6e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821111023255"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>因此，OpenResty需要对tomcat集群做负载均衡。&lt;/p>
&lt;p>而默认的负载均衡规则是轮询模式，当我们查询/item/10001时：&lt;/p>
&lt;ul>
&lt;li>第一次会访问8081端口的tomcat服务，在该服务内部就形成了JVM进程缓存&lt;/li>
&lt;li>第二次会访问8082端口的tomcat服务，该服务内部没有JVM缓存（因为JVM缓存无法共享），会查询数据库&lt;/li>
&lt;li>&amp;hellip;&lt;/li>
&lt;/ul>
&lt;p>你看，因为轮询的原因，第一次查询8081形成的JVM缓存并未生效，直到下一次再次访问到8081时才可以生效，缓存命中率太低了。&lt;/p>
&lt;p>怎么办？&lt;/p>
&lt;p>如果能让同一个商品，每次查询时都访问同一个tomcat服务，那么JVM缓存就一定能生效了。&lt;/p>
&lt;p>也就是说，我们需要根据商品id做负载均衡，而不是轮询。&lt;/p>
&lt;h4 id="1原理">
&lt;a href="#1%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
1）原理
&lt;/h4>&lt;p>nginx提供了基于请求路径做负载均衡的算法：&lt;/p>
&lt;p>nginx根据请求路径做hash运算，把得到的数值对tomcat服务的数量取余，余数是几，就访问第几个服务，实现负载均衡。&lt;/p>
&lt;p>例如：&lt;/p>
&lt;ul>
&lt;li>我们的请求路径是 /item/10001&lt;/li>
&lt;li>tomcat总数为2台（8081、8082）&lt;/li>
&lt;li>对请求路径/item/1001做hash运算求余的结果为1&lt;/li>
&lt;li>则访问第一个tomcat服务，也就是8081&lt;/li>
&lt;/ul>
&lt;p>只要id不变，每次hash运算结果也不会变，那就可以保证同一个商品，一直访问同一个tomcat服务，确保JVM缓存生效。&lt;/p>
&lt;h4 id="2实现">
&lt;a href="#2%e5%ae%9e%e7%8e%b0" class="header-anchor">#&lt;/a>
2）实现
&lt;/h4>&lt;p>修改&lt;code>/usr/local/openresty/nginx/conf/nginx.conf&lt;/code>文件，实现基于ID做负载均衡。&lt;/p>
&lt;p>首先，定义tomcat集群，并设置基于路径做负载均衡：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-33-1">&lt;a class="lnlinks" href="#hl-33-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-2">&lt;a class="lnlinks" href="#hl-33-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-3">&lt;a class="lnlinks" href="#hl-33-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-4">&lt;a class="lnlinks" href="#hl-33-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-5">&lt;a class="lnlinks" href="#hl-33-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">upstream&lt;/span> &lt;span class="s">tomcat-cluster&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">hash&lt;/span> &lt;span class="nv">$request_uri&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">192.168.150.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8081&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">192.168.150.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8082&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后，修改对tomcat服务的反向代理，目标指向tomcat集群：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-34-1">&lt;a class="lnlinks" href="#hl-34-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-2">&lt;a class="lnlinks" href="#hl-34-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-3">&lt;a class="lnlinks" href="#hl-34-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">location&lt;/span> &lt;span class="s">/item&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://tomcat-cluster&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重新加载OpenResty&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-35-1">&lt;a class="lnlinks" href="#hl-35-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">nginx -s reload
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="3测试">
&lt;a href="#3%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
3）测试
&lt;/h4>&lt;p>启动两台tomcat服务：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-9b234fe8e77688.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821112420464"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>同时启动：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-0aca3f7056b717.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821112444482"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>清空日志后，再次访问页面，可以看到不同id的商品，访问到了不同的tomcat服务：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-f517eb5516a09e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821112559965"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-47ef8e6958483d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821112637430"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="45redis缓存预热">
&lt;a href="#45redis%e7%bc%93%e5%ad%98%e9%a2%84%e7%83%ad" class="header-anchor">#&lt;/a>
4.5.Redis缓存预热
&lt;/h2>&lt;p>Redis缓存会面临冷启动问题：&lt;/p>
&lt;p>&lt;strong>冷启动&lt;/strong>：服务刚刚启动时，Redis中并没有缓存，如果所有商品数据都在第一次查询时添加缓存，可能会给数据库带来较大压力。&lt;/p>
&lt;p>&lt;strong>缓存预热&lt;/strong>：在实际开发中，我们可以利用大数据统计用户访问的热点数据，在项目启动时将这些热点数据提前查询并保存到Redis中。&lt;/p>
&lt;p>我们数据量较少，并且没有数据统计相关功能，目前可以在启动时将所有数据都放入缓存中。&lt;/p>
&lt;p>1）利用Docker安装Redis&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-36-1">&lt;a class="lnlinks" href="#hl-36-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run --name redis -p 6379:6379 -d redis redis-server --appendonly yes
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）在item-service服务中引入Redis依赖&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-37-1">&lt;a class="lnlinks" href="#hl-37-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-2">&lt;a class="lnlinks" href="#hl-37-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-3">&lt;a class="lnlinks" href="#hl-37-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-4">&lt;a class="lnlinks" href="#hl-37-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.boot&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-boot-starter-data-redis&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）配置Redis地址&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-38-1">&lt;a class="lnlinks" href="#hl-38-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-2">&lt;a class="lnlinks" href="#hl-38-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-3">&lt;a class="lnlinks" href="#hl-38-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">redis&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">192.168.150.101&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4）编写初始化类&lt;/p>
&lt;p>缓存预热需要在项目启动时完成，并且必须是拿到RedisTemplate之后。&lt;/p>
&lt;p>这里我们利用InitializingBean接口来实现，因为InitializingBean可以在对象被Spring创建并且成员变量全部注入后执行。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-39-1">&lt;a class="lnlinks" href="#hl-39-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-2">&lt;a class="lnlinks" href="#hl-39-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-3">&lt;a class="lnlinks" href="#hl-39-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-4">&lt;a class="lnlinks" href="#hl-39-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-5">&lt;a class="lnlinks" href="#hl-39-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-6">&lt;a class="lnlinks" href="#hl-39-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-7">&lt;a class="lnlinks" href="#hl-39-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-8">&lt;a class="lnlinks" href="#hl-39-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-9">&lt;a class="lnlinks" href="#hl-39-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-10">&lt;a class="lnlinks" href="#hl-39-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-11">&lt;a class="lnlinks" href="#hl-39-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-12">&lt;a class="lnlinks" href="#hl-39-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-13">&lt;a class="lnlinks" href="#hl-39-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-14">&lt;a class="lnlinks" href="#hl-39-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-15">&lt;a class="lnlinks" href="#hl-39-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-16">&lt;a class="lnlinks" href="#hl-39-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-17">&lt;a class="lnlinks" href="#hl-39-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-18">&lt;a class="lnlinks" href="#hl-39-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-19">&lt;a class="lnlinks" href="#hl-39-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-20">&lt;a class="lnlinks" href="#hl-39-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-21">&lt;a class="lnlinks" href="#hl-39-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-22">&lt;a class="lnlinks" href="#hl-39-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-23">&lt;a class="lnlinks" href="#hl-39-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-24">&lt;a class="lnlinks" href="#hl-39-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-25">&lt;a class="lnlinks" href="#hl-39-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-26">&lt;a class="lnlinks" href="#hl-39-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-27">&lt;a class="lnlinks" href="#hl-39-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-28">&lt;a class="lnlinks" href="#hl-39-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-29">&lt;a class="lnlinks" href="#hl-39-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-30">&lt;a class="lnlinks" href="#hl-39-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-31">&lt;a class="lnlinks" href="#hl-39-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-32">&lt;a class="lnlinks" href="#hl-39-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-33">&lt;a class="lnlinks" href="#hl-39-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-34">&lt;a class="lnlinks" href="#hl-39-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-35">&lt;a class="lnlinks" href="#hl-39-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-36">&lt;a class="lnlinks" href="#hl-39-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-37">&lt;a class="lnlinks" href="#hl-39-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-38">&lt;a class="lnlinks" href="#hl-39-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-39">&lt;a class="lnlinks" href="#hl-39-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-40">&lt;a class="lnlinks" href="#hl-39-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-41">&lt;a class="lnlinks" href="#hl-39-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-42">&lt;a class="lnlinks" href="#hl-39-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-43">&lt;a class="lnlinks" href="#hl-39-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-44">&lt;a class="lnlinks" href="#hl-39-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-45">&lt;a class="lnlinks" href="#hl-39-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-46">&lt;a class="lnlinks" href="#hl-39-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-47">&lt;a class="lnlinks" href="#hl-39-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-48">&lt;a class="lnlinks" href="#hl-39-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-49">&lt;a class="lnlinks" href="#hl-39-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-50">&lt;a class="lnlinks" href="#hl-39-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-51">&lt;a class="lnlinks" href="#hl-39-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-52">&lt;a class="lnlinks" href="#hl-39-52">52&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.config&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.fasterxml.jackson.core.JsonProcessingException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.fasterxml.jackson.databind.ObjectMapper&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.pojo.Item&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.pojo.ItemStock&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.service.IItemService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.service.IItemStockService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.factory.InitializingBean&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.factory.annotation.Autowired&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.data.redis.core.StringRedisTemplate&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.stereotype.Component&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.util.List&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Component&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">RedisHandler&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">implements&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InitializingBean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringRedisTemplate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">redisTemplate&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IItemService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IItemStockService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stockService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ObjectMapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MAPPER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ObjectMapper&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">afterPropertiesSet&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 初始化缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.查询商品信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemList&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">list&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.放入缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemList&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.1.item序列化为JSON&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MAPPER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">writeValueAsString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.2.存入redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">redisTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">opsForValue&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;item:id:&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.查询商品库存信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ItemStock&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stockList&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stockService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">list&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.放入缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ItemStock&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stock&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stockList&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.1.item序列化为JSON&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MAPPER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">writeValueAsString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stock&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.2.存入redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">redisTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">opsForValue&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;item:stock:id:&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="46查询redis缓存">
&lt;a href="#46%e6%9f%a5%e8%af%a2redis%e7%bc%93%e5%ad%98" class="header-anchor">#&lt;/a>
4.6.查询Redis缓存
&lt;/h2>&lt;p>现在，Redis缓存已经准备就绪，我们可以再OpenResty中实现查询Redis的逻辑了。如下图红框所示：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-10b7c9c7feb119.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821113340111"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>当请求进入OpenResty之后：&lt;/p>
&lt;ul>
&lt;li>优先查询Redis缓存&lt;/li>
&lt;li>如果Redis缓存未命中，再查询Tomcat&lt;/li>
&lt;/ul>
&lt;h3 id="461封装redis工具">
&lt;a href="#461%e5%b0%81%e8%a3%85redis%e5%b7%a5%e5%85%b7" class="header-anchor">#&lt;/a>
4.6.1.封装Redis工具
&lt;/h3>&lt;p>OpenResty提供了操作Redis的模块，我们只要引入该模块就能直接使用。但是为了方便，我们将Redis操作封装到之前的common.lua工具库中。&lt;/p>
&lt;p>修改&lt;code>/usr/local/openresty/lualib/common.lua&lt;/code>文件：&lt;/p>
&lt;p>1）引入Redis模块，并初始化Redis对象&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-40-1">&lt;a class="lnlinks" href="#hl-40-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-2">&lt;a class="lnlinks" href="#hl-40-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-3">&lt;a class="lnlinks" href="#hl-40-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-4">&lt;a class="lnlinks" href="#hl-40-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-5">&lt;a class="lnlinks" href="#hl-40-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 导入redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">redis&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;resty.redis&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 初始化redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">red&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redis&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">red&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">set_timeouts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）封装函数，用来释放Redis连接，其实是放入连接池&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-41-1">&lt;a class="lnlinks" href="#hl-41-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-2">&lt;a class="lnlinks" href="#hl-41-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-3">&lt;a class="lnlinks" href="#hl-41-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-4">&lt;a class="lnlinks" href="#hl-41-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-5">&lt;a class="lnlinks" href="#hl-41-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-6">&lt;a class="lnlinks" href="#hl-41-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-7">&lt;a class="lnlinks" href="#hl-41-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-8">&lt;a class="lnlinks" href="#hl-41-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-9">&lt;a class="lnlinks" href="#hl-41-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 关闭redis连接的工具方法，其实是放入连接池&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="kr">function&lt;/span> &lt;span class="nf">close_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">red&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">pool_max_idle_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">10000&lt;/span> &lt;span class="c1">-- 连接的空闲时间，单位是毫秒&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">pool_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">100&lt;/span> &lt;span class="c1">--连接池大小&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">ok&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">set_keepalive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pool_max_idle_time&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pool_size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">ok&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;放入redis连接池失败: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）封装函数，根据key查询Redis数据&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-42-1">&lt;a class="lnlinks" href="#hl-42-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-2">&lt;a class="lnlinks" href="#hl-42-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-3">&lt;a class="lnlinks" href="#hl-42-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-4">&lt;a class="lnlinks" href="#hl-42-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-5">&lt;a class="lnlinks" href="#hl-42-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-6">&lt;a class="lnlinks" href="#hl-42-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-7">&lt;a class="lnlinks" href="#hl-42-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-8">&lt;a class="lnlinks" href="#hl-42-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-9">&lt;a class="lnlinks" href="#hl-42-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-10">&lt;a class="lnlinks" href="#hl-42-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-11">&lt;a class="lnlinks" href="#hl-42-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-12">&lt;a class="lnlinks" href="#hl-42-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-13">&lt;a class="lnlinks" href="#hl-42-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-14">&lt;a class="lnlinks" href="#hl-42-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-15">&lt;a class="lnlinks" href="#hl-42-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-16">&lt;a class="lnlinks" href="#hl-42-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-17">&lt;a class="lnlinks" href="#hl-42-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-18">&lt;a class="lnlinks" href="#hl-42-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-19">&lt;a class="lnlinks" href="#hl-42-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-20">&lt;a class="lnlinks" href="#hl-42-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-21">&lt;a class="lnlinks" href="#hl-42-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-22">&lt;a class="lnlinks" href="#hl-42-22">22&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 查询redis的方法 ip和port是redis地址，key是查询的key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="kr">function&lt;/span> &lt;span class="nf">read_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 获取一个连接&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">ok&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">connect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">ok&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;连接redis失败 : &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询失败处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;查询Redis失败: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;, key = &amp;#34;&lt;/span> &lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">--得到的数据为空处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">ngx.null&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">resp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;查询Redis数据为空, key = &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">close_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">red&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">resp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4）导出&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-43-1">&lt;a class="lnlinks" href="#hl-43-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-2">&lt;a class="lnlinks" href="#hl-43-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-3">&lt;a class="lnlinks" href="#hl-43-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-4">&lt;a class="lnlinks" href="#hl-43-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-5">&lt;a class="lnlinks" href="#hl-43-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-6">&lt;a class="lnlinks" href="#hl-43-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 将方法导出&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">_M&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">read_http&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_http&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">read_redis&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">return&lt;/span> &lt;span class="n">_M&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>完整的common.lua：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-44-1">&lt;a class="lnlinks" href="#hl-44-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-2">&lt;a class="lnlinks" href="#hl-44-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-3">&lt;a class="lnlinks" href="#hl-44-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-4">&lt;a class="lnlinks" href="#hl-44-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-5">&lt;a class="lnlinks" href="#hl-44-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-6">&lt;a class="lnlinks" href="#hl-44-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-7">&lt;a class="lnlinks" href="#hl-44-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-8">&lt;a class="lnlinks" href="#hl-44-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-9">&lt;a class="lnlinks" href="#hl-44-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-10">&lt;a class="lnlinks" href="#hl-44-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-11">&lt;a class="lnlinks" href="#hl-44-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-12">&lt;a class="lnlinks" href="#hl-44-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-13">&lt;a class="lnlinks" href="#hl-44-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-14">&lt;a class="lnlinks" href="#hl-44-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-15">&lt;a class="lnlinks" href="#hl-44-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-16">&lt;a class="lnlinks" href="#hl-44-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-17">&lt;a class="lnlinks" href="#hl-44-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-18">&lt;a class="lnlinks" href="#hl-44-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-19">&lt;a class="lnlinks" href="#hl-44-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-20">&lt;a class="lnlinks" href="#hl-44-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-21">&lt;a class="lnlinks" href="#hl-44-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-22">&lt;a class="lnlinks" href="#hl-44-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-23">&lt;a class="lnlinks" href="#hl-44-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-24">&lt;a class="lnlinks" href="#hl-44-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-25">&lt;a class="lnlinks" href="#hl-44-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-26">&lt;a class="lnlinks" href="#hl-44-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-27">&lt;a class="lnlinks" href="#hl-44-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-28">&lt;a class="lnlinks" href="#hl-44-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-29">&lt;a class="lnlinks" href="#hl-44-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-30">&lt;a class="lnlinks" href="#hl-44-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-31">&lt;a class="lnlinks" href="#hl-44-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-32">&lt;a class="lnlinks" href="#hl-44-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-33">&lt;a class="lnlinks" href="#hl-44-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-34">&lt;a class="lnlinks" href="#hl-44-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-35">&lt;a class="lnlinks" href="#hl-44-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-36">&lt;a class="lnlinks" href="#hl-44-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-37">&lt;a class="lnlinks" href="#hl-44-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-38">&lt;a class="lnlinks" href="#hl-44-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-39">&lt;a class="lnlinks" href="#hl-44-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-40">&lt;a class="lnlinks" href="#hl-44-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-41">&lt;a class="lnlinks" href="#hl-44-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-42">&lt;a class="lnlinks" href="#hl-44-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-43">&lt;a class="lnlinks" href="#hl-44-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-44">&lt;a class="lnlinks" href="#hl-44-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-45">&lt;a class="lnlinks" href="#hl-44-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-46">&lt;a class="lnlinks" href="#hl-44-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-47">&lt;a class="lnlinks" href="#hl-44-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-48">&lt;a class="lnlinks" href="#hl-44-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-49">&lt;a class="lnlinks" href="#hl-44-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-50">&lt;a class="lnlinks" href="#hl-44-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-51">&lt;a class="lnlinks" href="#hl-44-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-52">&lt;a class="lnlinks" href="#hl-44-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-53">&lt;a class="lnlinks" href="#hl-44-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-54">&lt;a class="lnlinks" href="#hl-44-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-55">&lt;a class="lnlinks" href="#hl-44-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-56">&lt;a class="lnlinks" href="#hl-44-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-57">&lt;a class="lnlinks" href="#hl-44-57">57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-58">&lt;a class="lnlinks" href="#hl-44-58">58&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 导入redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">redis&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;resty.redis&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 初始化redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">red&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redis&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">red&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">set_timeouts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 关闭redis连接的工具方法，其实是放入连接池&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="kr">function&lt;/span> &lt;span class="nf">close_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">red&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">pool_max_idle_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">10000&lt;/span> &lt;span class="c1">-- 连接的空闲时间，单位是毫秒&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">pool_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">100&lt;/span> &lt;span class="c1">--连接池大小&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">ok&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">set_keepalive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pool_max_idle_time&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pool_size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">ok&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;放入redis连接池失败: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 查询redis的方法 ip和port是redis地址，key是查询的key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="kr">function&lt;/span> &lt;span class="nf">read_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 获取一个连接&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">ok&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">connect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">ok&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;连接redis失败 : &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询失败处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;查询Redis失败: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;, key = &amp;#34;&lt;/span> &lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">--得到的数据为空处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">ngx.null&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">resp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;查询Redis数据为空, key = &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">close_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">red&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">resp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 封装函数，发送http请求，并解析响应&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="kr">function&lt;/span> &lt;span class="nf">read_http&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.location&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">capture&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">method&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.HTTP_GET&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">args&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 记录错误信息，返回404&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;http查询失败, path: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span> &lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;, args: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">404&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">resp.body&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 将方法导出&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">_M&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">read_http&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_http&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">read_redis&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">return&lt;/span> &lt;span class="n">_M&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="462实现redis查询">
&lt;a href="#462%e5%ae%9e%e7%8e%b0redis%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
4.6.2.实现Redis查询
&lt;/h3>&lt;p>接下来，我们就可以去修改item.lua文件，实现对Redis的查询了。&lt;/p>
&lt;p>查询逻辑是：&lt;/p>
&lt;ul>
&lt;li>根据id查询Redis&lt;/li>
&lt;li>如果查询失败则继续查询Tomcat&lt;/li>
&lt;li>将查询结果返回&lt;/li>
&lt;/ul>
&lt;p>1）修改&lt;code>/usr/local/openresty/lua/item.lua&lt;/code>文件，添加一个查询函数：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-45-1">&lt;a class="lnlinks" href="#hl-45-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-2">&lt;a class="lnlinks" href="#hl-45-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-3">&lt;a class="lnlinks" href="#hl-45-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-4">&lt;a class="lnlinks" href="#hl-45-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-5">&lt;a class="lnlinks" href="#hl-45-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-6">&lt;a class="lnlinks" href="#hl-45-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-7">&lt;a class="lnlinks" href="#hl-45-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-8">&lt;a class="lnlinks" href="#hl-45-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-9">&lt;a class="lnlinks" href="#hl-45-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-10">&lt;a class="lnlinks" href="#hl-45-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-11">&lt;a class="lnlinks" href="#hl-45-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-12">&lt;a class="lnlinks" href="#hl-45-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-13">&lt;a class="lnlinks" href="#hl-45-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-14">&lt;a class="lnlinks" href="#hl-45-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-15">&lt;a class="lnlinks" href="#hl-45-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-16">&lt;a class="lnlinks" href="#hl-45-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-17">&lt;a class="lnlinks" href="#hl-45-17">17&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 导入common函数库&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">common&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;common&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">read_http&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">common.read_http&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">read_redis&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">common.read_redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 封装查询函数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">function&lt;/span> &lt;span class="nf">read_data&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询本地缓存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;127.0.0.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6379&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 判断查询结果&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;redis查询失败，尝试查询http， key: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- redis查询失败，去查询http&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_http&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 返回数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">val&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）而后修改商品查询、库存查询的业务：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-46f75fee939ce7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821114528954"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>3）完整的item.lua代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-46-1">&lt;a class="lnlinks" href="#hl-46-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-2">&lt;a class="lnlinks" href="#hl-46-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-3">&lt;a class="lnlinks" href="#hl-46-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-4">&lt;a class="lnlinks" href="#hl-46-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-5">&lt;a class="lnlinks" href="#hl-46-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-6">&lt;a class="lnlinks" href="#hl-46-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-7">&lt;a class="lnlinks" href="#hl-46-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-8">&lt;a class="lnlinks" href="#hl-46-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-9">&lt;a class="lnlinks" href="#hl-46-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-10">&lt;a class="lnlinks" href="#hl-46-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-11">&lt;a class="lnlinks" href="#hl-46-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-12">&lt;a class="lnlinks" href="#hl-46-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-13">&lt;a class="lnlinks" href="#hl-46-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-14">&lt;a class="lnlinks" href="#hl-46-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-15">&lt;a class="lnlinks" href="#hl-46-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-16">&lt;a class="lnlinks" href="#hl-46-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-17">&lt;a class="lnlinks" href="#hl-46-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-18">&lt;a class="lnlinks" href="#hl-46-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-19">&lt;a class="lnlinks" href="#hl-46-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-20">&lt;a class="lnlinks" href="#hl-46-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-21">&lt;a class="lnlinks" href="#hl-46-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-22">&lt;a class="lnlinks" href="#hl-46-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-23">&lt;a class="lnlinks" href="#hl-46-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-24">&lt;a class="lnlinks" href="#hl-46-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-25">&lt;a class="lnlinks" href="#hl-46-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-26">&lt;a class="lnlinks" href="#hl-46-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-27">&lt;a class="lnlinks" href="#hl-46-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-28">&lt;a class="lnlinks" href="#hl-46-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-29">&lt;a class="lnlinks" href="#hl-46-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-30">&lt;a class="lnlinks" href="#hl-46-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-31">&lt;a class="lnlinks" href="#hl-46-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-32">&lt;a class="lnlinks" href="#hl-46-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-33">&lt;a class="lnlinks" href="#hl-46-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-34">&lt;a class="lnlinks" href="#hl-46-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-35">&lt;a class="lnlinks" href="#hl-46-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-36">&lt;a class="lnlinks" href="#hl-46-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-37">&lt;a class="lnlinks" href="#hl-46-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-38">&lt;a class="lnlinks" href="#hl-46-38">38&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 导入common函数库&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">common&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;common&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">read_http&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">common.read_http&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">read_redis&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">common.read_redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 导入cjson库&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">cjson&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;cjson&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 封装查询函数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">function&lt;/span> &lt;span class="nf">read_data&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询本地缓存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;127.0.0.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6379&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 判断查询结果&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;redis查询失败，尝试查询http， key: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- redis查询失败，去查询http&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_http&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 返回数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">val&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 获取路径参数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.var&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 查询商品信息&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">itemJSON&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_data&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;item:id:&amp;#34;&lt;/span> &lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;/item/&amp;#34;&lt;/span> &lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 查询库存信息&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">stockJSON&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_data&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;item:stock:id:&amp;#34;&lt;/span> &lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;/item/stock/&amp;#34;&lt;/span> &lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- JSON转化为lua的table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">item&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cjson.decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">itemJSON&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">stock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cjson.decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stockJSON&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 组合数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">item.stock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">stock.stock&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">item.sold&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">stock.sold&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 把item序列化为json 返回结果&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ngx.say&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cjson.encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="47nginx本地缓存">
&lt;a href="#47nginx%e6%9c%ac%e5%9c%b0%e7%bc%93%e5%ad%98" class="header-anchor">#&lt;/a>
4.7.Nginx本地缓存
&lt;/h2>&lt;p>现在，整个多级缓存中只差最后一环，也就是nginx的本地缓存了。如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-2cda0c588661f9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821114742950"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="471本地缓存api">
&lt;a href="#471%e6%9c%ac%e5%9c%b0%e7%bc%93%e5%ad%98api" class="header-anchor">#&lt;/a>
4.7.1.本地缓存API
&lt;/h3>&lt;p>OpenResty为Nginx提供了&lt;strong>shard dict&lt;/strong>的功能，可以在nginx的多个worker之间共享数据，实现缓存功能。&lt;/p>
&lt;p>1）开启共享字典，在nginx.conf的http下添加配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-47-1">&lt;a class="lnlinks" href="#hl-47-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-2">&lt;a class="lnlinks" href="#hl-47-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 共享字典，也就是本地缓存，名称叫做：item_cache，大小150m
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">lua_shared_dict&lt;/span> &lt;span class="s">item_cache&lt;/span> &lt;span class="mi">150m&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）操作共享字典：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-48-1">&lt;a class="lnlinks" href="#hl-48-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-2">&lt;a class="lnlinks" href="#hl-48-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-3">&lt;a class="lnlinks" href="#hl-48-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-4">&lt;a class="lnlinks" href="#hl-48-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-5">&lt;a class="lnlinks" href="#hl-48-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-6">&lt;a class="lnlinks" href="#hl-48-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 获取本地缓存对象&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">item_cache&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.shared&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">item_cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 存储, 指定key、value、过期时间，单位s，默认为0代表永不过期&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">item_cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;key&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;value&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 读取&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item_cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;key&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="472实现本地缓存查询">
&lt;a href="#472%e5%ae%9e%e7%8e%b0%e6%9c%ac%e5%9c%b0%e7%bc%93%e5%ad%98%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
4.7.2.实现本地缓存查询
&lt;/h3>&lt;p>1）修改&lt;code>/usr/local/openresty/lua/item.lua&lt;/code>文件，修改read_data查询函数，添加本地缓存逻辑：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-49-1">&lt;a class="lnlinks" href="#hl-49-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-2">&lt;a class="lnlinks" href="#hl-49-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-3">&lt;a class="lnlinks" href="#hl-49-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-4">&lt;a class="lnlinks" href="#hl-49-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-5">&lt;a class="lnlinks" href="#hl-49-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-6">&lt;a class="lnlinks" href="#hl-49-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-7">&lt;a class="lnlinks" href="#hl-49-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-8">&lt;a class="lnlinks" href="#hl-49-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-9">&lt;a class="lnlinks" href="#hl-49-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-10">&lt;a class="lnlinks" href="#hl-49-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-11">&lt;a class="lnlinks" href="#hl-49-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-12">&lt;a class="lnlinks" href="#hl-49-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-13">&lt;a class="lnlinks" href="#hl-49-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-14">&lt;a class="lnlinks" href="#hl-49-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-15">&lt;a class="lnlinks" href="#hl-49-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-16">&lt;a class="lnlinks" href="#hl-49-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-17">&lt;a class="lnlinks" href="#hl-49-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-18">&lt;a class="lnlinks" href="#hl-49-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-19">&lt;a class="lnlinks" href="#hl-49-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-20">&lt;a class="lnlinks" href="#hl-49-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-21">&lt;a class="lnlinks" href="#hl-49-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-22">&lt;a class="lnlinks" href="#hl-49-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-23">&lt;a class="lnlinks" href="#hl-49-23">23&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 导入共享词典，本地缓存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">item_cache&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.shared&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">item_cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 封装查询函数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">function&lt;/span> &lt;span class="nf">read_data&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">expire&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询本地缓存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item_cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;本地缓存查询失败，尝试查询Redis， key: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;127.0.0.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6379&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 判断查询结果&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;redis查询失败，尝试查询http， key: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- redis查询失败，去查询http&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_http&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询成功，把数据写入本地缓存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">item_cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">val&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">expire&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 返回数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">val&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）修改item.lua中查询商品和库存的业务，实现最新的read_data函数：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-4dbd565ec2b8ed.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821115108528"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其实就是多了缓存时间参数，过期后nginx缓存会自动删除，下次访问即可更新缓存。&lt;/p>
&lt;p>这里给商品基本信息设置超时时间为30分钟，库存为1分钟。&lt;/p>
&lt;p>因为库存更新频率较高，如果缓存时间过长，可能与数据库差异较大。&lt;/p>
&lt;p>3）完整的item.lua文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-50-1">&lt;a class="lnlinks" href="#hl-50-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-2">&lt;a class="lnlinks" href="#hl-50-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-3">&lt;a class="lnlinks" href="#hl-50-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-4">&lt;a class="lnlinks" href="#hl-50-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-5">&lt;a class="lnlinks" href="#hl-50-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-6">&lt;a class="lnlinks" href="#hl-50-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-7">&lt;a class="lnlinks" href="#hl-50-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-8">&lt;a class="lnlinks" href="#hl-50-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-9">&lt;a class="lnlinks" href="#hl-50-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-10">&lt;a class="lnlinks" href="#hl-50-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-11">&lt;a class="lnlinks" href="#hl-50-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-12">&lt;a class="lnlinks" href="#hl-50-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-13">&lt;a class="lnlinks" href="#hl-50-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-14">&lt;a class="lnlinks" href="#hl-50-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-15">&lt;a class="lnlinks" href="#hl-50-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-16">&lt;a class="lnlinks" href="#hl-50-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-17">&lt;a class="lnlinks" href="#hl-50-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-18">&lt;a class="lnlinks" href="#hl-50-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-19">&lt;a class="lnlinks" href="#hl-50-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-20">&lt;a class="lnlinks" href="#hl-50-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-21">&lt;a class="lnlinks" href="#hl-50-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-22">&lt;a class="lnlinks" href="#hl-50-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-23">&lt;a class="lnlinks" href="#hl-50-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-24">&lt;a class="lnlinks" href="#hl-50-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-25">&lt;a class="lnlinks" href="#hl-50-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-26">&lt;a class="lnlinks" href="#hl-50-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-27">&lt;a class="lnlinks" href="#hl-50-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-28">&lt;a class="lnlinks" href="#hl-50-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-29">&lt;a class="lnlinks" href="#hl-50-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-30">&lt;a class="lnlinks" href="#hl-50-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-31">&lt;a class="lnlinks" href="#hl-50-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-32">&lt;a class="lnlinks" href="#hl-50-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-33">&lt;a class="lnlinks" href="#hl-50-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-34">&lt;a class="lnlinks" href="#hl-50-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-35">&lt;a class="lnlinks" href="#hl-50-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-36">&lt;a class="lnlinks" href="#hl-50-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-37">&lt;a class="lnlinks" href="#hl-50-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-38">&lt;a class="lnlinks" href="#hl-50-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-39">&lt;a class="lnlinks" href="#hl-50-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-40">&lt;a class="lnlinks" href="#hl-50-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-41">&lt;a class="lnlinks" href="#hl-50-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-42">&lt;a class="lnlinks" href="#hl-50-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-43">&lt;a class="lnlinks" href="#hl-50-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-44">&lt;a class="lnlinks" href="#hl-50-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-45">&lt;a class="lnlinks" href="#hl-50-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-46">&lt;a class="lnlinks" href="#hl-50-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-47">&lt;a class="lnlinks" href="#hl-50-47">47&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 导入common函数库&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">common&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;common&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">read_http&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">common.read_http&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">read_redis&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">common.read_redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 导入cjson库&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">cjson&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;cjson&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 导入共享词典，本地缓存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">item_cache&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.shared&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">item_cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 封装查询函数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">function&lt;/span> &lt;span class="nf">read_data&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">expire&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询本地缓存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">local&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item_cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;本地缓存查询失败，尝试查询Redis， key: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_redis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;127.0.0.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6379&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 判断查询结果&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">val&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;redis查询失败，尝试查询http， key: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- redis查询失败，去查询http&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">val&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_http&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 查询成功，把数据写入本地缓存&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">item_cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">val&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">expire&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">-- 返回数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">val&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 获取路径参数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.var&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 查询商品信息&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">itemJSON&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_data&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;item:id:&amp;#34;&lt;/span> &lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1800&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;/item/&amp;#34;&lt;/span> &lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 查询库存信息&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">stockJSON&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_data&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;item:stock:id:&amp;#34;&lt;/span> &lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">60&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;/item/stock/&amp;#34;&lt;/span> &lt;span class="o">..&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- JSON转化为lua的table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">item&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cjson.decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">itemJSON&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">stock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cjson.decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stockJSON&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 组合数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">item.stock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">stock.stock&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">item.sold&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">stock.sold&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 把item序列化为json 返回结果&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ngx.say&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cjson.encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="5缓存同步">
&lt;a href="#5%e7%bc%93%e5%ad%98%e5%90%8c%e6%ad%a5" class="header-anchor">#&lt;/a>
5.缓存同步
&lt;/h1>&lt;p>大多数情况下，浏览器查询到的都是缓存数据，如果缓存数据与数据库数据存在较大差异，可能会产生比较严重的后果。&lt;/p>
&lt;p>所以我们必须保证数据库数据、缓存数据的一致性，这就是缓存与数据库的同步。&lt;/p>
&lt;h2 id="51数据同步策略">
&lt;a href="#51%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5%e7%ad%96%e7%95%a5" class="header-anchor">#&lt;/a>
5.1.数据同步策略
&lt;/h2>&lt;p>缓存数据同步的常见方式有三种：&lt;/p>
&lt;p>&lt;strong>设置有效期&lt;/strong>：给缓存设置有效期，到期后自动删除。再次查询时更新&lt;/p>
&lt;ul>
&lt;li>优势：简单、方便&lt;/li>
&lt;li>缺点：时效性差，缓存过期之前可能不一致&lt;/li>
&lt;li>场景：更新频率较低，时效性要求低的业务&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>同步双写&lt;/strong>：在修改数据库的同时，直接修改缓存&lt;/p>
&lt;ul>
&lt;li>优势：时效性强，缓存与数据库强一致&lt;/li>
&lt;li>缺点：有代码侵入，耦合度高；&lt;/li>
&lt;li>场景：对一致性、时效性要求较高的缓存数据&lt;/li>
&lt;/ul>
&lt;p>**异步通知：**修改数据库时发送事件通知，相关服务监听到通知后修改缓存数据&lt;/p>
&lt;ul>
&lt;li>优势：低耦合，可以同时通知多个缓存服务&lt;/li>
&lt;li>缺点：时效性一般，可能存在中间不一致状态&lt;/li>
&lt;li>场景：时效性要求一般，有多个服务需要同步&lt;/li>
&lt;/ul>
&lt;p>而异步实现又可以基于MQ或者Canal来实现：&lt;/p>
&lt;p>1）基于MQ的异步通知：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-e05a4894873500.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821115552327"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解读：&lt;/p>
&lt;ul>
&lt;li>商品服务完成对数据的修改后，只需要发送一条消息到MQ中。&lt;/li>
&lt;li>缓存服务监听MQ消息，然后完成对缓存的更新&lt;/li>
&lt;/ul>
&lt;p>依然有少量的代码侵入。&lt;/p>
&lt;p>2）基于Canal的通知&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-45132ac0596572.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821115719363"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解读：&lt;/p>
&lt;ul>
&lt;li>商品服务完成商品修改后，业务直接结束，没有任何代码侵入&lt;/li>
&lt;li>Canal监听MySQL变化，当发现变化后，立即通知缓存服务&lt;/li>
&lt;li>缓存服务接收到canal通知，更新缓存&lt;/li>
&lt;/ul>
&lt;p>代码零侵入&lt;/p>
&lt;h2 id="52安装canal">
&lt;a href="#52%e5%ae%89%e8%a3%85canal" class="header-anchor">#&lt;/a>
5.2.安装Canal
&lt;/h2>&lt;h3 id="521认识canal">
&lt;a href="#521%e8%ae%a4%e8%af%86canal" class="header-anchor">#&lt;/a>
5.2.1.认识Canal
&lt;/h3>&lt;p>&lt;strong>Canal [kə&amp;rsquo;næl]&lt;/strong>，译意为水道/管道/沟渠，canal是阿里巴巴旗下的一款开源项目，基于Java开发。基于数据库增量日志解析，提供增量数据订阅&amp;amp;消费。GitHub的地址：https://github.com/alibaba/canal&lt;/p>
&lt;p>Canal是基于mysql的主从同步来实现的，MySQL主从同步的原理如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-dacd8cd67858d5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821115914748"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;ul>
&lt;li>1）MySQL master 将数据变更写入二进制日志( binary log），其中记录的数据叫做binary log events&lt;/li>
&lt;li>2）MySQL slave 将 master 的 binary log events拷贝到它的中继日志(relay log)&lt;/li>
&lt;li>3）MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据&lt;/li>
&lt;/ul>
&lt;p>而Canal就是把自己伪装成MySQL的一个slave节点，从而监听master的binary log变化。再把得到的变化信息通知给Canal的客户端，进而完成对其它数据库的同步。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-7f9a077c97fc4e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821115948395"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="522安装canal">
&lt;a href="#522%e5%ae%89%e8%a3%85canal" class="header-anchor">#&lt;/a>
5.2.2.安装Canal
&lt;/h3>&lt;p>安装和配置Canal参考课前资料文档：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-012a86b0b6cab3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821120017324"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="53监听canal">
&lt;a href="#53%e7%9b%91%e5%90%accanal" class="header-anchor">#&lt;/a>
5.3.监听Canal
&lt;/h2>&lt;p>Canal提供了各种语言的客户端，当Canal监听到binlog变化时，会通知Canal的客户端。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738835-16342071c8b49b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821120049024"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们可以利用Canal提供的Java客户端，监听Canal通知消息。当收到变化的消息时，完成对缓存的更新。&lt;/p>
&lt;p>不过这里我们会使用GitHub上的第三方开源的canal-starter客户端。地址：https://github.com/NormanGyllenhaal/canal-client&lt;/p>
&lt;p>与SpringBoot完美整合，自动装配，比官方客户端要简单好用很多。&lt;/p>
&lt;h3 id="531引入依赖">
&lt;a href="#531%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96" class="header-anchor">#&lt;/a>
5.3.1.引入依赖：
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-51-1">&lt;a class="lnlinks" href="#hl-51-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-2">&lt;a class="lnlinks" href="#hl-51-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-3">&lt;a class="lnlinks" href="#hl-51-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-4">&lt;a class="lnlinks" href="#hl-51-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-5">&lt;a class="lnlinks" href="#hl-51-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>top.javatool&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>canal-spring-boot-starter&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>1.2.1-RELEASE&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="532编写配置">
&lt;a href="#532%e7%bc%96%e5%86%99%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
5.3.2.编写配置：
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-52-1">&lt;a class="lnlinks" href="#hl-52-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-2">&lt;a class="lnlinks" href="#hl-52-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-3">&lt;a class="lnlinks" href="#hl-52-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">canal&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">destination&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">heima&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># canal的集群名字，要与安装canal时设置的名称一致&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">192.168.150.101&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">11111&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># canal服务地址&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="533修改item实体类">
&lt;a href="#533%e4%bf%ae%e6%94%b9item%e5%ae%9e%e4%bd%93%e7%b1%bb" class="header-anchor">#&lt;/a>
5.3.3.修改Item实体类
&lt;/h3>&lt;p>通过@Id、@Column、等注解完成Item与数据库表字段的映射：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-53-1">&lt;a class="lnlinks" href="#hl-53-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-2">&lt;a class="lnlinks" href="#hl-53-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-3">&lt;a class="lnlinks" href="#hl-53-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-4">&lt;a class="lnlinks" href="#hl-53-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-5">&lt;a class="lnlinks" href="#hl-53-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-6">&lt;a class="lnlinks" href="#hl-53-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-7">&lt;a class="lnlinks" href="#hl-53-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-8">&lt;a class="lnlinks" href="#hl-53-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-9">&lt;a class="lnlinks" href="#hl-53-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-10">&lt;a class="lnlinks" href="#hl-53-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-11">&lt;a class="lnlinks" href="#hl-53-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-12">&lt;a class="lnlinks" href="#hl-53-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-13">&lt;a class="lnlinks" href="#hl-53-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-14">&lt;a class="lnlinks" href="#hl-53-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-15">&lt;a class="lnlinks" href="#hl-53-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-16">&lt;a class="lnlinks" href="#hl-53-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-17">&lt;a class="lnlinks" href="#hl-53-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-18">&lt;a class="lnlinks" href="#hl-53-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-19">&lt;a class="lnlinks" href="#hl-53-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-20">&lt;a class="lnlinks" href="#hl-53-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-21">&lt;a class="lnlinks" href="#hl-53-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-22">&lt;a class="lnlinks" href="#hl-53-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-23">&lt;a class="lnlinks" href="#hl-53-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-24">&lt;a class="lnlinks" href="#hl-53-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-25">&lt;a class="lnlinks" href="#hl-53-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-26">&lt;a class="lnlinks" href="#hl-53-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-27">&lt;a class="lnlinks" href="#hl-53-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-28">&lt;a class="lnlinks" href="#hl-53-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-29">&lt;a class="lnlinks" href="#hl-53-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-30">&lt;a class="lnlinks" href="#hl-53-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-31">&lt;a class="lnlinks" href="#hl-53-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-32">&lt;a class="lnlinks" href="#hl-53-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-33">&lt;a class="lnlinks" href="#hl-53-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-34">&lt;a class="lnlinks" href="#hl-53-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-35">&lt;a class="lnlinks" href="#hl-53-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-36">&lt;a class="lnlinks" href="#hl-53-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-37">&lt;a class="lnlinks" href="#hl-53-37">37&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.pojo&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.baomidou.mybatisplus.annotation.IdType&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.baomidou.mybatisplus.annotation.TableField&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.baomidou.mybatisplus.annotation.TableId&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.baomidou.mybatisplus.annotation.TableName&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.Data&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.data.annotation.Id&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.data.annotation.Transient&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">javax.persistence.Column&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.util.Date&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Data&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@TableName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tb_item&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">Item&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@TableId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IdType&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">AUTO&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="c1">//商品id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="c1">//商品名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">title&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="c1">//商品标题&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="c1">//价格（分）&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">image&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="c1">//商品图片&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">category&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="c1">//分类名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brand&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="c1">//品牌名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">spec&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="c1">//规格&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="c1">//商品状态 1-正常，2-下架&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Date&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">createTime&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="c1">//创建时间&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Date&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">updateTime&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="c1">//更新时间&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@TableField&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exist&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Transient&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stock&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@TableField&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exist&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Transient&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sold&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="534编写监听器">
&lt;a href="#534%e7%bc%96%e5%86%99%e7%9b%91%e5%90%ac%e5%99%a8" class="header-anchor">#&lt;/a>
5.3.4.编写监听器
&lt;/h3>&lt;p>通过实现&lt;code>EntryHandler&amp;lt;T&amp;gt;&lt;/code>接口编写监听器，监听Canal消息。注意两点：&lt;/p>
&lt;ul>
&lt;li>实现类通过&lt;code>@CanalTable(&amp;quot;tb_item&amp;quot;)&lt;/code>指定监听的表信息&lt;/li>
&lt;li>EntryHandler的泛型是与表对应的实体类&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-54-1">&lt;a class="lnlinks" href="#hl-54-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-2">&lt;a class="lnlinks" href="#hl-54-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-3">&lt;a class="lnlinks" href="#hl-54-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-4">&lt;a class="lnlinks" href="#hl-54-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-5">&lt;a class="lnlinks" href="#hl-54-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-6">&lt;a class="lnlinks" href="#hl-54-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-7">&lt;a class="lnlinks" href="#hl-54-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-8">&lt;a class="lnlinks" href="#hl-54-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-9">&lt;a class="lnlinks" href="#hl-54-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-10">&lt;a class="lnlinks" href="#hl-54-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-11">&lt;a class="lnlinks" href="#hl-54-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-12">&lt;a class="lnlinks" href="#hl-54-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-13">&lt;a class="lnlinks" href="#hl-54-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-14">&lt;a class="lnlinks" href="#hl-54-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-15">&lt;a class="lnlinks" href="#hl-54-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-16">&lt;a class="lnlinks" href="#hl-54-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-17">&lt;a class="lnlinks" href="#hl-54-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-18">&lt;a class="lnlinks" href="#hl-54-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-19">&lt;a class="lnlinks" href="#hl-54-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-20">&lt;a class="lnlinks" href="#hl-54-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-21">&lt;a class="lnlinks" href="#hl-54-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-22">&lt;a class="lnlinks" href="#hl-54-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-23">&lt;a class="lnlinks" href="#hl-54-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-24">&lt;a class="lnlinks" href="#hl-54-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-25">&lt;a class="lnlinks" href="#hl-54-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-26">&lt;a class="lnlinks" href="#hl-54-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-27">&lt;a class="lnlinks" href="#hl-54-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-28">&lt;a class="lnlinks" href="#hl-54-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-29">&lt;a class="lnlinks" href="#hl-54-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-30">&lt;a class="lnlinks" href="#hl-54-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-31">&lt;a class="lnlinks" href="#hl-54-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-32">&lt;a class="lnlinks" href="#hl-54-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-33">&lt;a class="lnlinks" href="#hl-54-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-34">&lt;a class="lnlinks" href="#hl-54-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-35">&lt;a class="lnlinks" href="#hl-54-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-36">&lt;a class="lnlinks" href="#hl-54-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-37">&lt;a class="lnlinks" href="#hl-54-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-38">&lt;a class="lnlinks" href="#hl-54-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-39">&lt;a class="lnlinks" href="#hl-54-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-40">&lt;a class="lnlinks" href="#hl-54-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-41">&lt;a class="lnlinks" href="#hl-54-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-42">&lt;a class="lnlinks" href="#hl-54-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-43">&lt;a class="lnlinks" href="#hl-54-43">43&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.canal&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.github.benmanes.caffeine.cache.Cache&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.config.RedisHandler&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.pojo.Item&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.factory.annotation.Autowired&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.stereotype.Component&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">top.javatool.canal.client.annotation.CanalTable&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">top.javatool.canal.client.handler.EntryHandler&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@CanalTable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tb_item&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Component&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">ItemHandler&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">implements&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">EntryHandler&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RedisHandler&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">redisHandler&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Cache&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemCache&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 写数据到JVM进程缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">itemCache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 写数据到redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">redisHandler&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">saveItem&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">before&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">after&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 写数据到JVM进程缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">itemCache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">after&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">after&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 写数据到redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">redisHandler&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">saveItem&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">after&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 删除数据到JVM进程缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">itemCache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">invalidate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 删除数据到redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">redisHandler&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">deleteItemById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在这里对Redis的操作都封装到了RedisHandler这个对象中，是我们之前做缓存预热时编写的一个类，内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-55-1">&lt;a class="lnlinks" href="#hl-55-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-2">&lt;a class="lnlinks" href="#hl-55-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-3">&lt;a class="lnlinks" href="#hl-55-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-4">&lt;a class="lnlinks" href="#hl-55-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-5">&lt;a class="lnlinks" href="#hl-55-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-6">&lt;a class="lnlinks" href="#hl-55-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-7">&lt;a class="lnlinks" href="#hl-55-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-8">&lt;a class="lnlinks" href="#hl-55-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-9">&lt;a class="lnlinks" href="#hl-55-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-10">&lt;a class="lnlinks" href="#hl-55-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-11">&lt;a class="lnlinks" href="#hl-55-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-12">&lt;a class="lnlinks" href="#hl-55-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-13">&lt;a class="lnlinks" href="#hl-55-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-14">&lt;a class="lnlinks" href="#hl-55-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-15">&lt;a class="lnlinks" href="#hl-55-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-16">&lt;a class="lnlinks" href="#hl-55-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-17">&lt;a class="lnlinks" href="#hl-55-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-18">&lt;a class="lnlinks" href="#hl-55-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-19">&lt;a class="lnlinks" href="#hl-55-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-20">&lt;a class="lnlinks" href="#hl-55-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-21">&lt;a class="lnlinks" href="#hl-55-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-22">&lt;a class="lnlinks" href="#hl-55-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-23">&lt;a class="lnlinks" href="#hl-55-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-24">&lt;a class="lnlinks" href="#hl-55-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-25">&lt;a class="lnlinks" href="#hl-55-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-26">&lt;a class="lnlinks" href="#hl-55-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-27">&lt;a class="lnlinks" href="#hl-55-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-28">&lt;a class="lnlinks" href="#hl-55-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-29">&lt;a class="lnlinks" href="#hl-55-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-30">&lt;a class="lnlinks" href="#hl-55-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-31">&lt;a class="lnlinks" href="#hl-55-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-32">&lt;a class="lnlinks" href="#hl-55-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-33">&lt;a class="lnlinks" href="#hl-55-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-34">&lt;a class="lnlinks" href="#hl-55-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-35">&lt;a class="lnlinks" href="#hl-55-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-36">&lt;a class="lnlinks" href="#hl-55-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-37">&lt;a class="lnlinks" href="#hl-55-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-38">&lt;a class="lnlinks" href="#hl-55-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-39">&lt;a class="lnlinks" href="#hl-55-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-40">&lt;a class="lnlinks" href="#hl-55-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-41">&lt;a class="lnlinks" href="#hl-55-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-42">&lt;a class="lnlinks" href="#hl-55-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-43">&lt;a class="lnlinks" href="#hl-55-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-44">&lt;a class="lnlinks" href="#hl-55-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-45">&lt;a class="lnlinks" href="#hl-55-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-46">&lt;a class="lnlinks" href="#hl-55-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-47">&lt;a class="lnlinks" href="#hl-55-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-48">&lt;a class="lnlinks" href="#hl-55-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-49">&lt;a class="lnlinks" href="#hl-55-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-50">&lt;a class="lnlinks" href="#hl-55-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-51">&lt;a class="lnlinks" href="#hl-55-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-52">&lt;a class="lnlinks" href="#hl-55-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-53">&lt;a class="lnlinks" href="#hl-55-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-54">&lt;a class="lnlinks" href="#hl-55-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-55">&lt;a class="lnlinks" href="#hl-55-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-56">&lt;a class="lnlinks" href="#hl-55-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-57">&lt;a class="lnlinks" href="#hl-55-57">57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-58">&lt;a class="lnlinks" href="#hl-55-58">58&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-59">&lt;a class="lnlinks" href="#hl-55-59">59&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-60">&lt;a class="lnlinks" href="#hl-55-60">60&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-61">&lt;a class="lnlinks" href="#hl-55-61">61&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-62">&lt;a class="lnlinks" href="#hl-55-62">62&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-63">&lt;a class="lnlinks" href="#hl-55-63">63&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-64">&lt;a class="lnlinks" href="#hl-55-64">64&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-65">&lt;a class="lnlinks" href="#hl-55-65">65&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.config&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.fasterxml.jackson.core.JsonProcessingException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.fasterxml.jackson.databind.ObjectMapper&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.pojo.Item&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.pojo.ItemStock&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.service.IItemService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.heima.item.service.IItemStockService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.factory.InitializingBean&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.factory.annotation.Autowired&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.data.redis.core.StringRedisTemplate&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.stereotype.Component&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.util.List&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Component&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">RedisHandler&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">implements&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InitializingBean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringRedisTemplate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">redisTemplate&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IItemService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IItemStockService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stockService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ObjectMapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MAPPER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ObjectMapper&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">afterPropertiesSet&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 初始化缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.查询商品信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemList&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">list&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.放入缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itemList&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.1.item序列化为JSON&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MAPPER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">writeValueAsString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.2.存入redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">redisTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">opsForValue&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;item:id:&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.查询商品库存信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ItemStock&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stockList&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stockService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">list&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.放入缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ItemStock&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stock&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stockList&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.1.item序列化为JSON&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MAPPER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">writeValueAsString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stock&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.2.存入redis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">redisTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">opsForValue&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;item:stock:id:&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">saveItem&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MAPPER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">writeValueAsString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">redisTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">opsForValue&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;item:id:&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">JsonProcessingException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuntimeException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">deleteItemById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">redisTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;item:id:&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>12.RabbitMQ-高级篇</title><link>https://logan.wssw.fun/p/2023/01/89461189/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/89461189/</guid><description>&lt;h1 id="服务异步通信-高级篇">
&lt;a href="#%e6%9c%8d%e5%8a%a1%e5%bc%82%e6%ad%a5%e9%80%9a%e4%bf%a1-%e9%ab%98%e7%ba%a7%e7%af%87" class="header-anchor">#&lt;/a>
服务异步通信-高级篇
&lt;/h1>&lt;p>消息队列在使用过程中，面临着很多实际问题需要思考：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-ed04e0725414ab.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718155003157"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="1消息可靠性">
&lt;a href="#1%e6%b6%88%e6%81%af%e5%8f%af%e9%9d%a0%e6%80%a7" class="header-anchor">#&lt;/a>
1.消息可靠性
&lt;/h1>&lt;p>消息从发送，到消费者接收，会经理多个过程：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-b4472b4a349f6f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718155059371"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的每一步都可能导致消息丢失，常见的丢失原因包括：&lt;/p>
&lt;ul>
&lt;li>发送时丢失：
&lt;ul>
&lt;li>生产者发送的消息未送达exchange&lt;/li>
&lt;li>消息到达exchange后未到达queue&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>MQ宕机，queue将消息丢失&lt;/li>
&lt;li>consumer接收到消息后未消费就宕机&lt;/li>
&lt;/ul>
&lt;p>针对这些问题，RabbitMQ分别给出了解决方案：&lt;/p>
&lt;ul>
&lt;li>生产者确认机制&lt;/li>
&lt;li>mq持久化&lt;/li>
&lt;li>消费者确认机制&lt;/li>
&lt;li>失败重试机制&lt;/li>
&lt;/ul>
&lt;p>下面我们就通过案例来演示每一个步骤。&lt;/p>
&lt;p>首先，导入课前资料提供的demo工程：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-fd014f7b17b087.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718155328927"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>项目结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-0b647f3e71a224.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718155448734"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="11生产者消息确认">
&lt;a href="#11%e7%94%9f%e4%ba%a7%e8%80%85%e6%b6%88%e6%81%af%e7%a1%ae%e8%ae%a4" class="header-anchor">#&lt;/a>
1.1.生产者消息确认
&lt;/h2>&lt;p>RabbitMQ提供了publisher confirm机制来避免消息发送到MQ过程中丢失。这种机制必须给每个消息指定一个唯一ID。消息发送到MQ以后，会返回一个结果给发送者，表示消息是否处理成功。&lt;/p>
&lt;p>返回结果有两种方式：&lt;/p>
&lt;ul>
&lt;li>publisher-confirm，发送者确认
&lt;ul>
&lt;li>消息成功投递到交换机，返回ack&lt;/li>
&lt;li>消息未投递到交换机，返回nack&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>publisher-return，发送者回执
&lt;ul>
&lt;li>消息投递到交换机了，但是没有路由到队列。返回ACK，及路由失败原因。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-27e5d763fccbb2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718160907166"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>注意：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-c2ac78587f5fce.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718161707992"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="111修改配置">
&lt;a href="#111%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
1.1.1.修改配置
&lt;/h3>&lt;p>首先，修改publisher服务中的application.yml文件，添加下面的内容：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-6">&lt;a class="lnlinks" href="#hl-0-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-7">&lt;a class="lnlinks" href="#hl-0-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rabbitmq&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">publisher-confirm-type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">correlated&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">publisher-returns&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mandatory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>说明：&lt;/p>
&lt;ul>
&lt;li>&lt;code>publish-confirm-type&lt;/code>：开启publisher-confirm，这里支持两种类型：
&lt;ul>
&lt;li>&lt;code>simple&lt;/code>：同步等待confirm结果，直到超时&lt;/li>
&lt;li>&lt;code>correlated&lt;/code>：异步回调，定义ConfirmCallback，MQ返回结果时会回调这个ConfirmCallback&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>publish-returns&lt;/code>：开启publish-return功能，同样是基于callback机制，不过是定义ReturnCallback&lt;/li>
&lt;li>&lt;code>template.mandatory&lt;/code>：定义消息路由失败时的策略。true，则调用ReturnCallback；false：则直接丢弃消息&lt;/li>
&lt;/ul>
&lt;h3 id="112定义return回调">
&lt;a href="#112%e5%ae%9a%e4%b9%89return%e5%9b%9e%e8%b0%83" class="header-anchor">#&lt;/a>
1.1.2.定义Return回调
&lt;/h3>&lt;p>每个RabbitTemplate只能配置一个ReturnCallback，因此需要在项目加载时配置：&lt;/p>
&lt;p>修改publisher服务，添加一个：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-9">&lt;a class="lnlinks" href="#hl-1-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-10">&lt;a class="lnlinks" href="#hl-1-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-11">&lt;a class="lnlinks" href="#hl-1-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-12">&lt;a class="lnlinks" href="#hl-1-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-13">&lt;a class="lnlinks" href="#hl-1-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-14">&lt;a class="lnlinks" href="#hl-1-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-15">&lt;a class="lnlinks" href="#hl-1-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-16">&lt;a class="lnlinks" href="#hl-1-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-17">&lt;a class="lnlinks" href="#hl-1-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-18">&lt;a class="lnlinks" href="#hl-1-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-19">&lt;a class="lnlinks" href="#hl-1-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-20">&lt;a class="lnlinks" href="#hl-1-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-21">&lt;a class="lnlinks" href="#hl-1-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-22">&lt;a class="lnlinks" href="#hl-1-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-23">&lt;a class="lnlinks" href="#hl-1-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-24">&lt;a class="lnlinks" href="#hl-1-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-25">&lt;a class="lnlinks" href="#hl-1-25">25&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.mq.config&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.extern.slf4j.Slf4j&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.rabbit.core.RabbitTemplate&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.BeansException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.context.ApplicationContext&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.context.ApplicationContextAware&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.context.annotation.Configuration&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Slf4j&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Configuration&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">CommonConfig&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">implements&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ApplicationContextAware&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">setApplicationContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ApplicationContext&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">applicationContext&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BeansException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取RabbitTemplate&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">RabbitTemplate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">applicationContext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBean&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RabbitTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 设置ReturnCallback&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setReturnCallback&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">replyCode&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">replyText&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">routingKey&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 投递失败，记录日志&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消息发送失败，应答码{}，原因{}，交换机{}，路由键{},消息{}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">replyCode&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">replyText&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">routingKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果有业务需要，可以重发消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">});&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="113定义confirmcallback">
&lt;a href="#113%e5%ae%9a%e4%b9%89confirmcallback" class="header-anchor">#&lt;/a>
1.1.3.定义ConfirmCallback
&lt;/h3>&lt;p>ConfirmCallback可以在发送消息时指定，因为每个业务处理confirm成功或失败的逻辑不一定相同。&lt;/p>
&lt;p>在publisher服务的cn.itcast.mq.spring.SpringAmqpTest类中，定义一个单元测试方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-9">&lt;a class="lnlinks" href="#hl-2-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-10">&lt;a class="lnlinks" href="#hl-2-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-11">&lt;a class="lnlinks" href="#hl-2-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-12">&lt;a class="lnlinks" href="#hl-2-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-13">&lt;a class="lnlinks" href="#hl-2-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-14">&lt;a class="lnlinks" href="#hl-2-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-15">&lt;a class="lnlinks" href="#hl-2-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-16">&lt;a class="lnlinks" href="#hl-2-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-17">&lt;a class="lnlinks" href="#hl-2-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-18">&lt;a class="lnlinks" href="#hl-2-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-19">&lt;a class="lnlinks" href="#hl-2-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-20">&lt;a class="lnlinks" href="#hl-2-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-21">&lt;a class="lnlinks" href="#hl-2-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-22">&lt;a class="lnlinks" href="#hl-2-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-23">&lt;a class="lnlinks" href="#hl-2-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-24">&lt;a class="lnlinks" href="#hl-2-24">24&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testSendMessage2SimpleQueue&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InterruptedException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.消息体&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;hello, spring amqp!&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.全局唯一的消息ID，需要封装到CorrelationData中&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">CorrelationData&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">correlationData&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CorrelationData&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">UUID&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">randomUUID&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.添加callback&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">correlationData&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getFuture&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">addCallback&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isAck&lt;/span>&lt;span class="p">()){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.1.ack，消息成功&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消息发送成功, ID:{}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">correlationData&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.2.nack，消息失败&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消息发送失败, ID:{}, 原因{}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">correlationData&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getReason&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">},&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消息发送异常, ID:{}, 原因{}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">correlationData&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMessage&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.发送消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">convertAndSend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;task.direct&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;task&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">correlationData&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 休眠一会儿，等待ack回执&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">2000&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="12消息持久化">
&lt;a href="#12%e6%b6%88%e6%81%af%e6%8c%81%e4%b9%85%e5%8c%96" class="header-anchor">#&lt;/a>
1.2.消息持久化
&lt;/h2>&lt;p>生产者确认可以确保消息投递到RabbitMQ的队列中，但是消息发送到RabbitMQ以后，如果突然宕机，也可能导致消息丢失。&lt;/p>
&lt;p>要想确保消息在RabbitMQ中安全保存，必须开启消息持久化机制。&lt;/p>
&lt;ul>
&lt;li>交换机持久化&lt;/li>
&lt;li>队列持久化&lt;/li>
&lt;li>消息持久化&lt;/li>
&lt;/ul>
&lt;h3 id="121交换机持久化">
&lt;a href="#121%e4%ba%a4%e6%8d%a2%e6%9c%ba%e6%8c%81%e4%b9%85%e5%8c%96" class="header-anchor">#&lt;/a>
1.2.1.交换机持久化
&lt;/h3>&lt;p>RabbitMQ中交换机默认是非持久化的，mq重启后就丢失。&lt;/p>
&lt;p>SpringAMQP中可以通过代码指定交换机持久化：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DirectExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">simpleExchange&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DirectExchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;simple.direct&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>事实上，默认情况下，由SpringAMQP声明的交换机都是持久化的。&lt;/p>
&lt;p>可以在RabbitMQ控制台看到持久化的交换机都会带上&lt;code>D&lt;/code>的标示：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-3041636d876e6f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718164412450"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="122队列持久化">
&lt;a href="#122%e9%98%9f%e5%88%97%e6%8c%81%e4%b9%85%e5%8c%96" class="header-anchor">#&lt;/a>
1.2.2.队列持久化
&lt;/h3>&lt;p>RabbitMQ中队列默认是非持久化的，mq重启后就丢失。&lt;/p>
&lt;p>SpringAMQP中可以通过代码指定交换机持久化：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-5">&lt;a class="lnlinks" href="#hl-4-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">simpleQueue&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 使用QueueBuilder构建队列，durable就是持久化的&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">QueueBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">durable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;simple.queue&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>事实上，默认情况下，由SpringAMQP声明的队列都是持久化的。&lt;/p>
&lt;p>可以在RabbitMQ控制台看到持久化的队列都会带上&lt;code>D&lt;/code>的标示：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-762ed6e4ffadf1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718164729543"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="123消息持久化">
&lt;a href="#123%e6%b6%88%e6%81%af%e6%8c%81%e4%b9%85%e5%8c%96" class="header-anchor">#&lt;/a>
1.2.3.消息持久化
&lt;/h3>&lt;p>利用SpringAMQP发送消息时，可以设置消息的属性（MessageProperties），指定delivery-mode：&lt;/p>
&lt;ul>
&lt;li>1：非持久化&lt;/li>
&lt;li>2：持久化&lt;/li>
&lt;/ul>
&lt;p>用java代码指定：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-365d4cc4d06590.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718165100016"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>默认情况下，SpringAMQP发出的任何消息都是持久化的，不用特意指定。&lt;/p>
&lt;h2 id="13消费者消息确认">
&lt;a href="#13%e6%b6%88%e8%b4%b9%e8%80%85%e6%b6%88%e6%81%af%e7%a1%ae%e8%ae%a4" class="header-anchor">#&lt;/a>
1.3.消费者消息确认
&lt;/h2>&lt;p>RabbitMQ是&lt;strong>阅后即焚&lt;/strong>机制，RabbitMQ确认消息被消费者消费后会立刻删除。&lt;/p>
&lt;p>而RabbitMQ是通过消费者回执来确认消费者是否成功处理消息的：消费者获取消息后，应该向RabbitMQ发送ACK回执，表明自己已经处理消息。&lt;/p>
&lt;p>设想这样的场景：&lt;/p>
&lt;ul>
&lt;li>1）RabbitMQ投递消息给消费者&lt;/li>
&lt;li>2）消费者获取消息后，返回ACK给RabbitMQ&lt;/li>
&lt;li>3）RabbitMQ删除消息&lt;/li>
&lt;li>4）消费者宕机，消息尚未处理&lt;/li>
&lt;/ul>
&lt;p>这样，消息就丢失了。因此消费者返回ACK的时机非常重要。&lt;/p>
&lt;p>而SpringAMQP则允许配置三种确认模式：&lt;/p>
&lt;p>•manual：手动ack，需要在业务代码结束后，调用api发送ack。&lt;/p>
&lt;p>•auto：自动ack，由spring监测listener代码是否出现异常，没有异常则返回ack；抛出异常则返回nack&lt;/p>
&lt;p>•none：关闭ack，MQ假定消费者获取消息后会成功处理，因此消息投递后立即被删除&lt;/p>
&lt;p>由此可知：&lt;/p>
&lt;ul>
&lt;li>none模式下，消息投递是不可靠的，可能丢失&lt;/li>
&lt;li>auto模式类似事务机制，出现异常时返回nack，消息回滚到mq；没有异常，返回ack&lt;/li>
&lt;li>manual：自己根据业务情况，判断什么时候该ack&lt;/li>
&lt;/ul>
&lt;p>一般，我们都是使用默认的auto即可。&lt;/p>
&lt;h3 id="131演示none模式">
&lt;a href="#131%e6%bc%94%e7%a4%banone%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
1.3.1.演示none模式
&lt;/h3>&lt;p>修改consumer服务的application.yml文件，添加下面内容：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-4">&lt;a class="lnlinks" href="#hl-5-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-5">&lt;a class="lnlinks" href="#hl-5-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rabbitmq&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">listener&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">simple&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">acknowledge-mode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">none&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 关闭ack&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改consumer服务的SpringRabbitListener类中的方法，模拟一个消息处理异常：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-5">&lt;a class="lnlinks" href="#hl-6-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-6">&lt;a class="lnlinks" href="#hl-6-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-7">&lt;a class="lnlinks" href="#hl-6-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queues&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;simple.queue&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenSimpleQueue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消费者接收到simple.queue的消息：【{}】&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 模拟异常&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消息处理完成！&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试可以发现，当消息处理抛异常时，消息依然被RabbitMQ删除了。&lt;/p>
&lt;h3 id="132演示auto模式">
&lt;a href="#132%e6%bc%94%e7%a4%baauto%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
1.3.2.演示auto模式
&lt;/h3>&lt;p>再次把确认机制修改为auto:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rabbitmq&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">listener&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">simple&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">acknowledge-mode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">auto&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 关闭ack&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在异常位置打断点，再次发送消息，程序卡在断点时，可以发现此时消息状态为unack（未确定状态）：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-ae4608529e125a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718171705383"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>抛出异常后，因为Spring会自动返回nack，所以消息恢复至Ready状态，并且没有被RabbitMQ删除：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-f28046d217bcd3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718171759179"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="14消费失败重试机制">
&lt;a href="#14%e6%b6%88%e8%b4%b9%e5%a4%b1%e8%b4%a5%e9%87%8d%e8%af%95%e6%9c%ba%e5%88%b6" class="header-anchor">#&lt;/a>
1.4.消费失败重试机制
&lt;/h2>&lt;p>当消费者出现异常后，消息会不断requeue（重入队）到队列，再重新发送给消费者，然后再次异常，再次requeue，无限循环，导致mq的消息处理飙升，带来不必要的压力：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-e44233dfb7de39.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718172746378"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>怎么办呢？&lt;/p>
&lt;h3 id="141本地重试">
&lt;a href="#141%e6%9c%ac%e5%9c%b0%e9%87%8d%e8%af%95" class="header-anchor">#&lt;/a>
1.4.1.本地重试
&lt;/h3>&lt;p>我们可以利用Spring的retry机制，在消费者出现异常时利用本地重试，而不是无限制的requeue到mq队列。&lt;/p>
&lt;p>修改consumer服务的application.yml文件，添加内容：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-6">&lt;a class="lnlinks" href="#hl-8-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-7">&lt;a class="lnlinks" href="#hl-8-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-8">&lt;a class="lnlinks" href="#hl-8-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-9">&lt;a class="lnlinks" href="#hl-8-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-10">&lt;a class="lnlinks" href="#hl-8-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rabbitmq&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">listener&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">simple&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">retry&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">enabled&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 开启消费者失败重试&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">initial-interval&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1000&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 初识的失败等待时长为1秒&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">multiplier&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 失败的等待时长倍数，下次等待时长 = multiplier * last-interval&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">max-attempts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 最大重试次数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stateless&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># true无状态；false有状态。如果业务中包含事务，这里改为false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启consumer服务，重复之前的测试。可以发现：&lt;/p>
&lt;ul>
&lt;li>在重试3次后，SpringAMQP会抛出异常AmqpRejectAndDontRequeueException，说明本地重试触发了&lt;/li>
&lt;li>查看RabbitMQ控制台，发现消息被删除了，说明最后SpringAMQP返回的是ack，mq删除消息了&lt;/li>
&lt;/ul>
&lt;p>结论：&lt;/p>
&lt;ul>
&lt;li>开启本地重试时，消息处理过程中抛出异常，不会requeue到队列，而是在消费者本地重试&lt;/li>
&lt;li>重试达到最大次数后，Spring会返回ack，消息会被丢弃&lt;/li>
&lt;/ul>
&lt;h3 id="142失败策略">
&lt;a href="#142%e5%a4%b1%e8%b4%a5%e7%ad%96%e7%95%a5" class="header-anchor">#&lt;/a>
1.4.2.失败策略
&lt;/h3>&lt;p>在之前的测试中，达到最大重试次数后，消息会被丢弃，这是由Spring内部机制决定的。&lt;/p>
&lt;p>在开启重试模式后，重试次数耗尽，如果消息依然失败，则需要有MessageRecovery接口来处理，它包含三种不同的实现：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>RejectAndDontRequeueRecoverer：重试耗尽后，直接reject，丢弃消息。默认就是这种方式&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ImmediateRequeueMessageRecoverer：重试耗尽后，返回nack，消息重新入队&lt;/p>
&lt;/li>
&lt;li>
&lt;p>RepublishMessageRecoverer：重试耗尽后，将失败消息投递到指定的交换机&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>比较优雅的一种处理方案是RepublishMessageRecoverer，失败后将消息投递到一个指定的，专门存放异常消息的队列，后续由人工集中处理。&lt;/p>
&lt;p>1）在consumer服务中定义处理失败消息的交换机和队列&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-5">&lt;a class="lnlinks" href="#hl-9-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-6">&lt;a class="lnlinks" href="#hl-9-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-7">&lt;a class="lnlinks" href="#hl-9-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-8">&lt;a class="lnlinks" href="#hl-9-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-9">&lt;a class="lnlinks" href="#hl-9-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-10">&lt;a class="lnlinks" href="#hl-9-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-11">&lt;a class="lnlinks" href="#hl-9-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-12">&lt;a class="lnlinks" href="#hl-9-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DirectExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">errorMessageExchange&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DirectExchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error.direct&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">errorQueue&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error.queue&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Binding&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">errorBinding&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">errorQueue&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DirectExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">errorMessageExchange&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BindingBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">errorQueue&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">errorMessageExchange&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">with&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）定义一个RepublishMessageRecoverer，关联队列和交换机&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MessageRecoverer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">republishMessageRecoverer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RabbitTemplate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RepublishMessageRecoverer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;error.direct&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>完整代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-5">&lt;a class="lnlinks" href="#hl-11-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-6">&lt;a class="lnlinks" href="#hl-11-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-7">&lt;a class="lnlinks" href="#hl-11-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-8">&lt;a class="lnlinks" href="#hl-11-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-9">&lt;a class="lnlinks" href="#hl-11-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-10">&lt;a class="lnlinks" href="#hl-11-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-11">&lt;a class="lnlinks" href="#hl-11-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-12">&lt;a class="lnlinks" href="#hl-11-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-13">&lt;a class="lnlinks" href="#hl-11-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-14">&lt;a class="lnlinks" href="#hl-11-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-15">&lt;a class="lnlinks" href="#hl-11-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-16">&lt;a class="lnlinks" href="#hl-11-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-17">&lt;a class="lnlinks" href="#hl-11-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-18">&lt;a class="lnlinks" href="#hl-11-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-19">&lt;a class="lnlinks" href="#hl-11-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-20">&lt;a class="lnlinks" href="#hl-11-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-21">&lt;a class="lnlinks" href="#hl-11-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-22">&lt;a class="lnlinks" href="#hl-11-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-23">&lt;a class="lnlinks" href="#hl-11-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-24">&lt;a class="lnlinks" href="#hl-11-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-25">&lt;a class="lnlinks" href="#hl-11-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-26">&lt;a class="lnlinks" href="#hl-11-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-27">&lt;a class="lnlinks" href="#hl-11-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-28">&lt;a class="lnlinks" href="#hl-11-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-29">&lt;a class="lnlinks" href="#hl-11-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-30">&lt;a class="lnlinks" href="#hl-11-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-31">&lt;a class="lnlinks" href="#hl-11-31">31&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.mq.config&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.core.Binding&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.core.BindingBuilder&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.core.DirectExchange&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.core.Queue&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.rabbit.core.RabbitTemplate&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.rabbit.retry.MessageRecoverer&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.rabbit.retry.RepublishMessageRecoverer&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.context.annotation.Bean&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Configuration&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">ErrorMessageConfig&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DirectExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">errorMessageExchange&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DirectExchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error.direct&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">errorQueue&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error.queue&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Binding&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">errorBinding&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">errorQueue&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DirectExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">errorMessageExchange&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BindingBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">errorQueue&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">errorMessageExchange&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">with&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MessageRecoverer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">republishMessageRecoverer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RabbitTemplate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RepublishMessageRecoverer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;error.direct&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="15总结">
&lt;a href="#15%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
1.5.总结
&lt;/h2>&lt;p>如何确保RabbitMQ消息的可靠性？&lt;/p>
&lt;ul>
&lt;li>开启生产者确认机制，确保生产者的消息能到达队列&lt;/li>
&lt;li>开启持久化功能，确保消息未消费前在队列中不会丢失&lt;/li>
&lt;li>开启消费者确认机制为auto，由spring确认消息处理成功后完成ack&lt;/li>
&lt;li>开启消费者失败重试机制，并设置MessageRecoverer，多次重试失败后将消息投递到异常交换机，交由人工处理&lt;/li>
&lt;/ul>
&lt;h1 id="2死信交换机">
&lt;a href="#2%e6%ad%bb%e4%bf%a1%e4%ba%a4%e6%8d%a2%e6%9c%ba" class="header-anchor">#&lt;/a>
2.死信交换机
&lt;/h1>&lt;h2 id="21初识死信交换机">
&lt;a href="#21%e5%88%9d%e8%af%86%e6%ad%bb%e4%bf%a1%e4%ba%a4%e6%8d%a2%e6%9c%ba" class="header-anchor">#&lt;/a>
2.1.初识死信交换机
&lt;/h2>&lt;h3 id="211什么是死信交换机">
&lt;a href="#211%e4%bb%80%e4%b9%88%e6%98%af%e6%ad%bb%e4%bf%a1%e4%ba%a4%e6%8d%a2%e6%9c%ba" class="header-anchor">#&lt;/a>
2.1.1.什么是死信交换机
&lt;/h3>&lt;p>什么是死信？&lt;/p>
&lt;p>当一个队列中的消息满足下列情况之一时，可以成为死信（dead letter）：&lt;/p>
&lt;ul>
&lt;li>消费者使用basic.reject或 basic.nack声明消费失败，并且消息的requeue参数设置为false&lt;/li>
&lt;li>消息是一个过期消息，超时无人消费&lt;/li>
&lt;li>要投递的队列消息满了，无法投递&lt;/li>
&lt;/ul>
&lt;p>如果这个包含死信的队列配置了&lt;code>dead-letter-exchange&lt;/code>属性，指定了一个交换机，那么队列中的死信就会投递到这个交换机中，而这个交换机称为&lt;strong>死信交换机&lt;/strong>（Dead Letter Exchange，检查DLX）。&lt;/p>
&lt;p>如图，一个消息被消费者拒绝了，变成了死信：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-20eacc476b066a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718174328383"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>因为simple.queue绑定了死信交换机 dl.direct，因此死信会投递给这个交换机：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-10a11e4a0bdd14.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718174416160"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如果这个死信交换机也绑定了一个队列，则消息最终会进入这个存放死信的队列：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-99077802d28fd2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718174506856"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>另外，队列将死信投递给死信交换机时，必须知道两个信息：&lt;/p>
&lt;ul>
&lt;li>死信交换机名称&lt;/li>
&lt;li>死信交换机与死信队列绑定的RoutingKey&lt;/li>
&lt;/ul>
&lt;p>这样才能确保投递的消息能到达死信交换机，并且正确的路由到死信队列。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-ff634f35f0be20.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210821073801398"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="212利用死信交换机接收死信拓展">
&lt;a href="#212%e5%88%a9%e7%94%a8%e6%ad%bb%e4%bf%a1%e4%ba%a4%e6%8d%a2%e6%9c%ba%e6%8e%a5%e6%94%b6%e6%ad%bb%e4%bf%a1%e6%8b%93%e5%b1%95" class="header-anchor">#&lt;/a>
2.1.2.利用死信交换机接收死信（拓展）
&lt;/h3>&lt;p>在失败重试策略中，默认的RejectAndDontRequeueRecoverer会在本地重试次数耗尽后，发送reject给RabbitMQ，消息变成死信，被丢弃。&lt;/p>
&lt;p>我们可以给simple.queue添加一个死信交换机，给死信交换机绑定一个队列。这样消息变成死信后也不会丢弃，而是最终投递到死信交换机，路由到与死信交换机绑定的队列。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-99077802d28fd2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718174506856"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们在consumer服务中，定义一组死信交换机、死信队列：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-6">&lt;a class="lnlinks" href="#hl-12-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-7">&lt;a class="lnlinks" href="#hl-12-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-8">&lt;a class="lnlinks" href="#hl-12-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-9">&lt;a class="lnlinks" href="#hl-12-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-10">&lt;a class="lnlinks" href="#hl-12-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-11">&lt;a class="lnlinks" href="#hl-12-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-12">&lt;a class="lnlinks" href="#hl-12-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-13">&lt;a class="lnlinks" href="#hl-12-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-14">&lt;a class="lnlinks" href="#hl-12-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-15">&lt;a class="lnlinks" href="#hl-12-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-16">&lt;a class="lnlinks" href="#hl-12-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-17">&lt;a class="lnlinks" href="#hl-12-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-18">&lt;a class="lnlinks" href="#hl-12-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-19">&lt;a class="lnlinks" href="#hl-12-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-20">&lt;a class="lnlinks" href="#hl-12-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-21">&lt;a class="lnlinks" href="#hl-12-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-22">&lt;a class="lnlinks" href="#hl-12-22">22&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 声明普通的 simple.queue队列，并且为其指定死信交换机：dl.direct&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">simpleQueue2&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">QueueBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">durable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;simple.queue&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// 指定队列名称，并持久化&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">deadLetterExchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dl.direct&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// 指定死信交换机&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">// 声明死信交换机 dl.direct&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DirectExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">dlExchange&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DirectExchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dl.direct&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">// 声明存储死信的队列 dl.queue&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">dlQueue&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dl.queue&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">// 将死信队列 与 死信交换机绑定&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Binding&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">dlBinding&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BindingBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dlQueue&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="na">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dlExchange&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="na">with&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;simple&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="213总结">
&lt;a href="#213%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
2.1.3.总结
&lt;/h3>&lt;p>什么样的消息会成为死信？&lt;/p>
&lt;ul>
&lt;li>消息被消费者reject或者返回nack&lt;/li>
&lt;li>消息超时未消费&lt;/li>
&lt;li>队列满了&lt;/li>
&lt;/ul>
&lt;p>死信交换机的使用场景是什么？&lt;/p>
&lt;ul>
&lt;li>如果队列绑定了死信交换机，死信会投递到死信交换机；&lt;/li>
&lt;li>可以利用死信交换机收集所有消费者处理失败的消息（死信），交由人工处理，进一步提高消息队列的可靠性。&lt;/li>
&lt;/ul>
&lt;h2 id="22ttl">
&lt;a href="#22ttl" class="header-anchor">#&lt;/a>
2.2.TTL
&lt;/h2>&lt;p>一个队列中的消息如果超时未消费，则会变为死信，超时分为两种情况：&lt;/p>
&lt;ul>
&lt;li>消息所在的队列设置了超时时间&lt;/li>
&lt;li>消息本身设置了超时时间&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-a49fc4586d2828.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718182643311"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="221接收超时死信的死信交换机">
&lt;a href="#221%e6%8e%a5%e6%94%b6%e8%b6%85%e6%97%b6%e6%ad%bb%e4%bf%a1%e7%9a%84%e6%ad%bb%e4%bf%a1%e4%ba%a4%e6%8d%a2%e6%9c%ba" class="header-anchor">#&lt;/a>
2.2.1.接收超时死信的死信交换机
&lt;/h3>&lt;p>在consumer服务的SpringRabbitListener中，定义一个新的消费者，并且声明 死信交换机、死信队列：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-6">&lt;a class="lnlinks" href="#hl-13-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-7">&lt;a class="lnlinks" href="#hl-13-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-8">&lt;a class="lnlinks" href="#hl-13-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bindings&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@QueueBinding&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@Queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;dl.ttl.queue&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">durable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;true&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@Exchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;dl.ttl.direct&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;ttl&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenDlQueue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;接收到 dl.ttl.queue的延迟消息：{}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="222声明一个队列并且指定ttl">
&lt;a href="#222%e5%a3%b0%e6%98%8e%e4%b8%80%e4%b8%aa%e9%98%9f%e5%88%97%e5%b9%b6%e4%b8%94%e6%8c%87%e5%ae%9attl" class="header-anchor">#&lt;/a>
2.2.2.声明一个队列，并且指定TTL
&lt;/h3>&lt;p>要给队列设置超时时间，需要在声明队列时配置x-message-ttl属性：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-5">&lt;a class="lnlinks" href="#hl-14-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-6">&lt;a class="lnlinks" href="#hl-14-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-7">&lt;a class="lnlinks" href="#hl-14-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">ttlQueue&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">QueueBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">durable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ttl.queue&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// 指定队列名称，并持久化&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ttl&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">10000&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// 设置队列的超时时间，10秒&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">deadLetterExchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dl.ttl.direct&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// 指定死信交换机&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>注意，这个队列设定了死信交换机为&lt;code>dl.ttl.direct&lt;/code>&lt;/p>
&lt;p>声明交换机，将ttl与交换机绑定：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-6">&lt;a class="lnlinks" href="#hl-15-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-7">&lt;a class="lnlinks" href="#hl-15-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-8">&lt;a class="lnlinks" href="#hl-15-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DirectExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">ttlExchange&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DirectExchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ttl.direct&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Binding&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">ttlBinding&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BindingBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ttlQueue&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="na">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ttlExchange&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="na">with&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ttl&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>发送消息，但是不要指定TTL：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-7">&lt;a class="lnlinks" href="#hl-16-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-8">&lt;a class="lnlinks" href="#hl-16-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-9">&lt;a class="lnlinks" href="#hl-16-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-10">&lt;a class="lnlinks" href="#hl-16-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-11">&lt;a class="lnlinks" href="#hl-16-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testTTLQueue&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;hello, ttl queue&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 消息ID，需要封装到CorrelationData中&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">CorrelationData&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">correlationData&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CorrelationData&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">UUID&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">randomUUID&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发送消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">convertAndSend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ttl.direct&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;ttl&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">correlationData&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 记录日志&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;发送消息成功&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>发送消息的日志：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-186b17db7fa72d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718191657478"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>查看下接收消息的日志：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-5d84d593608ee7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718191738706"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>因为队列的TTL值是10000ms，也就是10秒。可以看到消息发送与接收之间的时差刚好是10秒。&lt;/p>
&lt;h3 id="223发送消息时设定ttl">
&lt;a href="#223%e5%8f%91%e9%80%81%e6%b6%88%e6%81%af%e6%97%b6%e8%ae%be%e5%ae%9attl" class="header-anchor">#&lt;/a>
2.2.3.发送消息时，设定TTL
&lt;/h3>&lt;p>在发送消息时，也可以指定TTL：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-4">&lt;a class="lnlinks" href="#hl-17-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-5">&lt;a class="lnlinks" href="#hl-17-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-6">&lt;a class="lnlinks" href="#hl-17-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-7">&lt;a class="lnlinks" href="#hl-17-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-8">&lt;a class="lnlinks" href="#hl-17-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-9">&lt;a class="lnlinks" href="#hl-17-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-10">&lt;a class="lnlinks" href="#hl-17-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-11">&lt;a class="lnlinks" href="#hl-17-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-12">&lt;a class="lnlinks" href="#hl-17-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-13">&lt;a class="lnlinks" href="#hl-17-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testTTLMsg&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MessageBuilder&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">withBody&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hello, ttl message&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">StandardCharsets&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">UTF_8&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setExpiration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;5000&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 消息ID，需要封装到CorrelationData中&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">CorrelationData&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">correlationData&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CorrelationData&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">UUID&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">randomUUID&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发送消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">convertAndSend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ttl.direct&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;ttl&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">correlationData&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;发送消息成功&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查看发送消息日志：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-4d8a94ef2e719b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718191939140"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>接收消息日志：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-54273e067ffa2d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718192004662"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这次，发送与接收的延迟只有5秒。说明当队列、消息都设置了TTL时，任意一个到期就会成为死信。&lt;/p>
&lt;h3 id="224总结">
&lt;a href="#224%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
2.2.4.总结
&lt;/h3>&lt;p>消息超时的两种方式是？&lt;/p>
&lt;ul>
&lt;li>给队列设置ttl属性，进入队列后超过ttl时间的消息变为死信&lt;/li>
&lt;li>给消息设置ttl属性，队列接收到消息超过ttl时间后变为死信&lt;/li>
&lt;/ul>
&lt;p>如何实现发送一个消息20秒后消费者才收到消息？&lt;/p>
&lt;ul>
&lt;li>给消息的目标队列指定死信交换机&lt;/li>
&lt;li>将消费者监听的队列绑定到死信交换机&lt;/li>
&lt;li>发送消息时给消息设置超时时间为20秒&lt;/li>
&lt;/ul>
&lt;h2 id="23延迟队列">
&lt;a href="#23%e5%bb%b6%e8%bf%9f%e9%98%9f%e5%88%97" class="header-anchor">#&lt;/a>
2.3.延迟队列
&lt;/h2>&lt;p>利用TTL结合死信交换机，我们实现了消息发出后，消费者延迟收到消息的效果。这种消息模式就称为延迟队列（Delay Queue）模式。&lt;/p>
&lt;p>延迟队列的使用场景包括：&lt;/p>
&lt;ul>
&lt;li>延迟发送短信&lt;/li>
&lt;li>用户下单，如果用户在15 分钟内未支付，则自动取消&lt;/li>
&lt;li>预约工作会议，20分钟后自动通知所有参会人员&lt;/li>
&lt;/ul>
&lt;p>因为延迟队列的需求非常多，所以RabbitMQ的官方也推出了一个插件，原生支持延迟队列效果。&lt;/p>
&lt;p>这个插件就是DelayExchange插件。参考RabbitMQ的插件列表页面：https://www.rabbitmq.com/community-plugins.html&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-029ef40fceda2c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718192529342"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>使用方式可以参考官网地址：https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq&lt;/p>
&lt;h3 id="231安装delayexchange插件">
&lt;a href="#231%e5%ae%89%e8%a3%85delayexchange%e6%8f%92%e4%bb%b6" class="header-anchor">#&lt;/a>
2.3.1.安装DelayExchange插件
&lt;/h3>&lt;p>参考课前资料：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-9a18870d4ab1e4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718193409812"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="232delayexchange原理">
&lt;a href="#232delayexchange%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
2.3.2.DelayExchange原理
&lt;/h3>&lt;p>DelayExchange需要将一个交换机声明为delayed类型。当我们发送消息到delayExchange时，流程如下：&lt;/p>
&lt;ul>
&lt;li>接收消息&lt;/li>
&lt;li>判断消息是否具备x-delay属性&lt;/li>
&lt;li>如果有x-delay属性，说明是延迟消息，持久化到硬盘，读取x-delay值，作为延迟时间&lt;/li>
&lt;li>返回routing not found结果给消息发送者&lt;/li>
&lt;li>x-delay时间到期后，重新投递消息到指定队列&lt;/li>
&lt;/ul>
&lt;h3 id="233使用delayexchange">
&lt;a href="#233%e4%bd%bf%e7%94%a8delayexchange" class="header-anchor">#&lt;/a>
2.3.3.使用DelayExchange
&lt;/h3>&lt;p>插件的使用也非常简单：声明一个交换机，交换机的类型可以是任意类型，只需要设定delayed属性为true即可，然后声明队列与其绑定即可。&lt;/p>
&lt;h4 id="1声明delayexchange交换机">
&lt;a href="#1%e5%a3%b0%e6%98%8edelayexchange%e4%ba%a4%e6%8d%a2%e6%9c%ba" class="header-anchor">#&lt;/a>
1）声明DelayExchange交换机
&lt;/h4>&lt;p>基于注解方式（推荐）：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-f5c89d8a33be48.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718193747649"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>也可以基于@Bean的方式：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-e308494477f304.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718193831076"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h4 id="2发送消息">
&lt;a href="#2%e5%8f%91%e9%80%81%e6%b6%88%e6%81%af" class="header-anchor">#&lt;/a>
2）发送消息
&lt;/h4>&lt;p>发送消息时，一定要携带x-delay属性，指定延迟的时间：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-498643b60eaa3e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718193917009"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="234总结">
&lt;a href="#234%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
2.3.4.总结
&lt;/h3>&lt;p>延迟队列插件的使用步骤包括哪些？&lt;/p>
&lt;p>•声明一个交换机，添加delayed属性为true&lt;/p>
&lt;p>•发送消息时，添加x-delay头，值为超时时间&lt;/p>
&lt;h1 id="3惰性队列">
&lt;a href="#3%e6%83%b0%e6%80%a7%e9%98%9f%e5%88%97" class="header-anchor">#&lt;/a>
3.惰性队列
&lt;/h1>&lt;h2 id="31消息堆积问题">
&lt;a href="#31%e6%b6%88%e6%81%af%e5%a0%86%e7%a7%af%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
3.1.消息堆积问题
&lt;/h2>&lt;p>当生产者发送消息的速度超过了消费者处理消息的速度，就会导致队列中的消息堆积，直到队列存储消息达到上限。之后发送的消息就会成为死信，可能会被丢弃，这就是消息堆积问题。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-1da82381df4840.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718194040498"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解决消息堆积有两种思路：&lt;/p>
&lt;ul>
&lt;li>增加更多消费者，提高消费速度。也就是我们之前说的work queue模式&lt;/li>
&lt;li>扩大队列容积，提高堆积上限&lt;/li>
&lt;/ul>
&lt;p>要提升队列容积，把消息保存在内存中显然是不行的。&lt;/p>
&lt;h2 id="32惰性队列">
&lt;a href="#32%e6%83%b0%e6%80%a7%e9%98%9f%e5%88%97" class="header-anchor">#&lt;/a>
3.2.惰性队列
&lt;/h2>&lt;p>从RabbitMQ的3.6.0版本开始，就增加了Lazy Queues的概念，也就是惰性队列。惰性队列的特征如下：&lt;/p>
&lt;ul>
&lt;li>接收到消息后直接存入磁盘而非内存&lt;/li>
&lt;li>消费者要消费消息时才会从磁盘中读取并加载到内存&lt;/li>
&lt;li>支持数百万条的消息存储&lt;/li>
&lt;/ul>
&lt;h3 id="321基于命令行设置lazy-queue">
&lt;a href="#321%e5%9f%ba%e4%ba%8e%e5%91%bd%e4%bb%a4%e8%a1%8c%e8%ae%be%e7%bd%aelazy-queue" class="header-anchor">#&lt;/a>
3.2.1.基于命令行设置lazy-queue
&lt;/h3>&lt;p>而要设置一个队列为惰性队列，只需要在声明队列时，指定x-queue-mode属性为lazy即可。可以通过命令行将一个运行中的队列修改为惰性队列：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">rabbitmqctl set_policy Lazy &lt;span class="s2">&amp;#34;^lazy-queue&lt;/span>$&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s1">&amp;#39;{&amp;#34;queue-mode&amp;#34;:&amp;#34;lazy&amp;#34;}&amp;#39;&lt;/span> --apply-to queues
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>命令解读：&lt;/p>
&lt;ul>
&lt;li>&lt;code>rabbitmqctl&lt;/code> ：RabbitMQ的命令行工具&lt;/li>
&lt;li>&lt;code>set_policy&lt;/code> ：添加一个策略&lt;/li>
&lt;li>&lt;code>Lazy&lt;/code> ：策略名称，可以自定义&lt;/li>
&lt;li>&lt;code>&amp;quot;^lazy-queue$&amp;quot;&lt;/code> ：用正则表达式匹配队列的名字&lt;/li>
&lt;li>&lt;code>'{&amp;quot;queue-mode&amp;quot;:&amp;quot;lazy&amp;quot;}'&lt;/code> ：设置队列模式为lazy模式&lt;/li>
&lt;li>&lt;code>--apply-to queues &lt;/code>：策略的作用对象，是所有的队列&lt;/li>
&lt;/ul>
&lt;h3 id="322基于bean声明lazy-queue">
&lt;a href="#322%e5%9f%ba%e4%ba%8ebean%e5%a3%b0%e6%98%8elazy-queue" class="header-anchor">#&lt;/a>
3.2.2.基于@Bean声明lazy-queue
&lt;/h3>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-b1c6185abbb2af.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718194522223"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="323基于rabbitlistener声明lazyqueue">
&lt;a href="#323%e5%9f%ba%e4%ba%8erabbitlistener%e5%a3%b0%e6%98%8elazyqueue" class="header-anchor">#&lt;/a>
3.2.3.基于@RabbitListener声明LazyQueue
&lt;/h3>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-f9ee7a93c04703.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718194539054"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="33总结">
&lt;a href="#33%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
3.3.总结
&lt;/h3>&lt;p>消息堆积问题的解决方案？&lt;/p>
&lt;ul>
&lt;li>队列上绑定多个消费者，提高消费速度&lt;/li>
&lt;li>使用惰性队列，可以再mq中保存更多消息&lt;/li>
&lt;/ul>
&lt;p>惰性队列的优点有哪些？&lt;/p>
&lt;ul>
&lt;li>基于磁盘存储，消息上限高&lt;/li>
&lt;li>没有间歇性的page-out，性能比较稳定&lt;/li>
&lt;/ul>
&lt;p>惰性队列的缺点有哪些？&lt;/p>
&lt;ul>
&lt;li>基于磁盘存储，消息时效性会降低&lt;/li>
&lt;li>性能受限于磁盘的IO&lt;/li>
&lt;/ul>
&lt;h1 id="4mq集群">
&lt;a href="#4mq%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.MQ集群
&lt;/h1>&lt;h2 id="41集群分类">
&lt;a href="#41%e9%9b%86%e7%be%a4%e5%88%86%e7%b1%bb" class="header-anchor">#&lt;/a>
4.1.集群分类
&lt;/h2>&lt;p>RabbitMQ的是基于Erlang语言编写，而Erlang又是一个面向并发的语言，天然支持集群模式。RabbitMQ的集群有两种模式：&lt;/p>
&lt;p>•&lt;strong>普通集群&lt;/strong>：是一种分布式集群，将队列分散到集群的各个节点，从而提高整个集群的并发能力。&lt;/p>
&lt;p>•&lt;strong>镜像集群&lt;/strong>：是一种主从集群，普通集群的基础上，添加了主从备份功能，提高集群的数据可用性。&lt;/p>
&lt;p>镜像集群虽然支持主从，但主从同步并不是强一致的，某些情况下可能有数据丢失的风险。因此在RabbitMQ的3.8版本以后，推出了新的功能：&lt;strong>仲裁队列&lt;/strong>来代替镜像集群，底层采用Raft协议确保主从的数据一致性。&lt;/p>
&lt;h2 id="42普通集群">
&lt;a href="#42%e6%99%ae%e9%80%9a%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.2.普通集群
&lt;/h2>&lt;h3 id="421集群结构和特征">
&lt;a href="#421%e9%9b%86%e7%be%a4%e7%bb%93%e6%9e%84%e5%92%8c%e7%89%b9%e5%be%81" class="header-anchor">#&lt;/a>
4.2.1.集群结构和特征
&lt;/h3>&lt;p>普通集群，或者叫标准集群（classic cluster），具备下列特征：&lt;/p>
&lt;ul>
&lt;li>会在集群的各个节点间共享部分数据，包括：交换机、队列元信息。不包含队列中的消息。&lt;/li>
&lt;li>当访问集群某节点时，如果队列不在该节点，会从数据所在节点传递到当前节点并返回&lt;/li>
&lt;li>队列所在节点宕机，队列中的消息就会丢失&lt;/li>
&lt;/ul>
&lt;p>结构如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-18967d172d2182.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718220843323"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="422部署">
&lt;a href="#422%e9%83%a8%e7%bd%b2" class="header-anchor">#&lt;/a>
4.2.2.部署
&lt;/h3>&lt;p>参考课前资料：《RabbitMQ部署指南.md》&lt;/p>
&lt;h2 id="43镜像集群">
&lt;a href="#43%e9%95%9c%e5%83%8f%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.3.镜像集群
&lt;/h2>&lt;h3 id="431集群结构和特征">
&lt;a href="#431%e9%9b%86%e7%be%a4%e7%bb%93%e6%9e%84%e5%92%8c%e7%89%b9%e5%be%81" class="header-anchor">#&lt;/a>
4.3.1.集群结构和特征
&lt;/h3>&lt;p>镜像集群：本质是主从模式，具备下面的特征：&lt;/p>
&lt;ul>
&lt;li>交换机、队列、队列中的消息会在各个mq的镜像节点之间同步备份。&lt;/li>
&lt;li>创建队列的节点被称为该队列的&lt;strong>主节点，&lt;strong>备份到的其它节点叫做该队列的&lt;/strong>镜像&lt;/strong>节点。&lt;/li>
&lt;li>一个队列的主节点可能是另一个队列的镜像节点&lt;/li>
&lt;li>所有操作都是主节点完成，然后同步给镜像节点&lt;/li>
&lt;li>主宕机后，镜像节点会替代成新的主&lt;/li>
&lt;/ul>
&lt;p>结构如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738916-fe1a1e145d2de5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718221039542"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="432部署">
&lt;a href="#432%e9%83%a8%e7%bd%b2" class="header-anchor">#&lt;/a>
4.3.2.部署
&lt;/h3>&lt;p>参考课前资料：《RabbitMQ部署指南.md》&lt;/p>
&lt;h2 id="44仲裁队列">
&lt;a href="#44%e4%bb%b2%e8%a3%81%e9%98%9f%e5%88%97" class="header-anchor">#&lt;/a>
4.4.仲裁队列
&lt;/h2>&lt;h3 id="441集群特征">
&lt;a href="#441%e9%9b%86%e7%be%a4%e7%89%b9%e5%be%81" class="header-anchor">#&lt;/a>
4.4.1.集群特征
&lt;/h3>&lt;p>仲裁队列：仲裁队列是3.8版本以后才有的新功能，用来替代镜像队列，具备下列特征：&lt;/p>
&lt;ul>
&lt;li>与镜像队列一样，都是主从模式，支持主从数据同步&lt;/li>
&lt;li>使用非常简单，没有复杂的配置&lt;/li>
&lt;li>主从同步基于Raft协议，强一致&lt;/li>
&lt;/ul>
&lt;h3 id="442部署">
&lt;a href="#442%e9%83%a8%e7%bd%b2" class="header-anchor">#&lt;/a>
4.4.2.部署
&lt;/h3>&lt;p>参考课前资料：《RabbitMQ部署指南.md》&lt;/p>
&lt;h3 id="443java代码创建仲裁队列">
&lt;a href="#443java%e4%bb%a3%e7%a0%81%e5%88%9b%e5%bb%ba%e4%bb%b2%e8%a3%81%e9%98%9f%e5%88%97" class="header-anchor">#&lt;/a>
4.4.3.Java代码创建仲裁队列
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-5">&lt;a class="lnlinks" href="#hl-19-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-6">&lt;a class="lnlinks" href="#hl-19-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-7">&lt;a class="lnlinks" href="#hl-19-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">quorumQueue&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">QueueBuilder&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">durable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;quorum.queue&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// 持久化&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">quorum&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// 仲裁队列&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="444springamqp连接mq集群">
&lt;a href="#444springamqp%e8%bf%9e%e6%8e%a5mq%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.4.4.SpringAMQP连接MQ集群
&lt;/h3>&lt;p>注意，这里用address来代替host、port方式&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-4">&lt;a class="lnlinks" href="#hl-20-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-5">&lt;a class="lnlinks" href="#hl-20-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-6">&lt;a class="lnlinks" href="#hl-20-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nl">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitmq&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">addresses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">192&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">150&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">105&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">8071&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">192&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">150&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">105&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">8072&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">192&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">150&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">105&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">8073&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">itcast&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">password&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">123321&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>13.Nacos源码分析</title><link>https://logan.wssw.fun/p/2023/01/9167149t/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/9167149t/</guid><description>&lt;h1 id="nacos源码分析">
&lt;a href="#nacos%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" class="header-anchor">#&lt;/a>
Nacos源码分析
&lt;/h1>&lt;h1 id="1下载nacos源码并运行">
&lt;a href="#1%e4%b8%8b%e8%bd%bdnacos%e6%ba%90%e7%a0%81%e5%b9%b6%e8%bf%90%e8%a1%8c" class="header-anchor">#&lt;/a>
1.下载Nacos源码并运行
&lt;/h1>&lt;p>要研究Nacos源码自然不能用打包好的Nacos服务端jar包来运行，需要下载源码自己编译来运行。&lt;/p>
&lt;h2 id="11下载nacos源码">
&lt;a href="#11%e4%b8%8b%e8%bd%bdnacos%e6%ba%90%e7%a0%81" class="header-anchor">#&lt;/a>
1.1.下载Nacos源码
&lt;/h2>&lt;p>Nacos的GitHub地址：https://github.com/alibaba/nacos&lt;/p>
&lt;p>课前资料中已经提供了下载好的1.4.2版本的Nacos源码：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-06b89873e80b31.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906105652113"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如果需要研究其他版本的同学，也可以自行下载：&lt;/p>
&lt;p>大家找到其release页面：https://github.com/alibaba/nacos/tags，找到其中的1.4.2.版本：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-7fc48f9b6dce51.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906105157409"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>点击进入后，下载Source code(zip)：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-011614212141ad.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906105102668"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="12导入demo工程">
&lt;a href="#12%e5%af%bc%e5%85%a5demo%e5%b7%a5%e7%a8%8b" class="header-anchor">#&lt;/a>
1.2.导入Demo工程
&lt;/h2>&lt;p>我们的课前资料提供了一个微服务Demo，包含了服务注册、发现等业务。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-f25cc5a00a38cb.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906105858000"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>导入该项目后，查看其项目结构：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-b0e73901ffdff6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906110014198"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>结构说明：&lt;/p>
&lt;ul>
&lt;li>cloud-source-demo：项目父目录
&lt;ul>
&lt;li>cloud-demo：微服务的父工程，管理微服务依赖
&lt;ul>
&lt;li>order-service：订单微服务，业务中需要访问user-service，是一个服务消费者&lt;/li>
&lt;li>user-service：用户微服务，对外暴露根据id查询用户的接口，是一个服务提供者&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="13导入nacos源码">
&lt;a href="#13%e5%af%bc%e5%85%a5nacos%e6%ba%90%e7%a0%81" class="header-anchor">#&lt;/a>
1.3.导入Nacos源码
&lt;/h2>&lt;p>将之前下载好的Nacos源码解压到cloud-source-demo项目目录中：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-c8f91407aaed95.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906111053263"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后，使用IDEA将其作为一个module来导入：&lt;/p>
&lt;p>1）选择项目结构选项：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-9e4a217e857cae.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906111152447"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后点击导入module：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-4a7ce8955c6979.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906111259352"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在弹出窗口中，选择nacos源码目录：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-5872f36dd5647a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906111422406"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后选择maven模块，finish：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-2fa260de287d5c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906111519198"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>最后，点击OK即可：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-f6b3d509905e0f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906111543747"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>导入后的项目结构：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-88590dadce2815.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906111632336"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="14proto编译">
&lt;a href="#14proto%e7%bc%96%e8%af%91" class="header-anchor">#&lt;/a>
1.4.proto编译
&lt;/h2>&lt;p>Nacos底层的数据通信会基于protobuf对数据做序列化和反序列化。并将对应的proto文件定义在了consistency这个子模块中：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-ec7816ee44ab36.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906111941399"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们需要先将proto文件编译为对应的Java代码。&lt;/p>
&lt;h3 id="141什么是protobuf">
&lt;a href="#141%e4%bb%80%e4%b9%88%e6%98%afprotobuf" class="header-anchor">#&lt;/a>
1.4.1.什么是protobuf
&lt;/h3>&lt;p>protobuf的全称是Protocol Buffer，是Google提供的一种数据序列化协议，这是Google官方的定义：&lt;/p>
&lt;blockquote>
&lt;p>Protocol Buffers 是一种轻便高效的结构化数据存储格式，可以用于结构化数据序列化，很适合做数据存储或 RPC 数据交换格式。它可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。&lt;/p>
&lt;/blockquote>
&lt;p>可以简单理解为，是一种跨语言、跨平台的数据传输格式。与json的功能类似，但是无论是性能，还是数据大小都比json要好很多。&lt;/p>
&lt;p>protobuf的之所以可以跨语言，就是因为数据定义的格式为&lt;code>.proto&lt;/code>格式，需要基于protoc编译为对应的语言。&lt;/p>
&lt;h3 id="142安装protoc">
&lt;a href="#142%e5%ae%89%e8%a3%85protoc" class="header-anchor">#&lt;/a>
1.4.2.安装protoc
&lt;/h3>&lt;p>Protobuf的GitHub地址：https://github.com/protocolbuffers/protobuf/releases&lt;/p>
&lt;p>我们可以下载windows版本的来使用：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-a927dd1e0558cf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906112814549"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>另外，课前资料也提供了下载好的安装包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-dca798fc57b401.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906112920575"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解压到任意非中文目录下，其中的bin目录中的protoc.exe可以帮助我们编译：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-1cb16d2e683299.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906113011871"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后将这个bin目录配置到你的环境变量path中，可以参考JDK的配置方式：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-54fa051083335d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906113552081"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="143编译proto">
&lt;a href="#143%e7%bc%96%e8%af%91proto" class="header-anchor">#&lt;/a>
1.4.3.编译proto
&lt;/h3>&lt;p>进入nacos-1.4.2的consistency模块下的src/main目录下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-4b99204b15c9b8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906113655302"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后打开cmd窗口，运行下面的两个命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoc&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-java_out&lt;/span>&lt;span class="p">=./&lt;/span>&lt;span class="n">java&lt;/span> &lt;span class="p">./&lt;/span>&lt;span class="n">proto&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">consistency&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">proto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">protoc&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-java_out&lt;/span>&lt;span class="p">=./&lt;/span>&lt;span class="n">java&lt;/span> &lt;span class="p">./&lt;/span>&lt;span class="n">proto&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">Data&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">proto&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-916debbf4b84ae.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906113829647"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>会在nacos的consistency模块中编译出这些java代码：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-78dd166edebd2f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906113923430"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="15运行">
&lt;a href="#15%e8%bf%90%e8%a1%8c" class="header-anchor">#&lt;/a>
1.5.运行
&lt;/h2>&lt;p>nacos服务端的入口是在console模块中的Nacos类：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-115ec829c3f760.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906114035628"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们需要让它单机启动：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-db5e74c0aa9e63.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906114143669"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后新建一个SpringBootApplication：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-5fa19f55155530.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906114220412"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后填写应用信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-35b334c3eabb44.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906114519073"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后运行Nacos这个main函数：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-ecd6e18b717412.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906114705910"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>将order-service和user-service服务启动后，可以查看nacos控制台：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-db7618a45ed767.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210906151358154"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="2服务注册">
&lt;a href="#2%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c" class="header-anchor">#&lt;/a>
2.服务注册
&lt;/h1>&lt;p>服务注册到Nacos以后，会保存在一个本地注册表中，其结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-89c2b7ecfb47a4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922111651314"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>首先最外层是一个Map，结构为：&lt;code>Map&amp;lt;String, Map&amp;lt;String, Service&amp;gt;&amp;gt;&lt;/code>：&lt;/p>
&lt;ul>
&lt;li>key：是namespace_id，起到环境隔离的作用。namespace下可以有多个group&lt;/li>
&lt;li>value：又是一个&lt;code>Map&amp;lt;String, Service&amp;gt;&lt;/code>，代表分组及组内的服务。一个组内可以有多个服务
&lt;ul>
&lt;li>key：代表group分组，不过作为key时格式是group_name:service_name&lt;/li>
&lt;li>value：分组下的某一个服务，例如userservice，用户服务。类型为&lt;code>Service&lt;/code>，内部也包含一个&lt;code>Map&amp;lt;String,Cluster&amp;gt;&lt;/code>，一个服务下可以有多个集群
&lt;ul>
&lt;li>key：集群名称&lt;/li>
&lt;li>value：&lt;code>Cluster&lt;/code>类型，包含集群的具体信息。一个集群中可能包含多个实例，也就是具体的节点信息，其中包含一个&lt;code>Set&amp;lt;Instance&amp;gt;&lt;/code>，就是该集群下的实例的集合
&lt;ul>
&lt;li>Instance：实例信息，包含实例的IP、Port、健康状态、权重等等信息&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>每一个服务去注册到Nacos时，就会把信息组织并存入这个Map中。&lt;/p>
&lt;h2 id="21服务注册接口">
&lt;a href="#21%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e6%8e%a5%e5%8f%a3" class="header-anchor">#&lt;/a>
2.1.服务注册接口
&lt;/h2>&lt;p>Nacos提供了服务注册的API接口，客户端只需要向该接口发送请求，即可实现服务注册。&lt;/p>
&lt;p>**接口说明：**注册一个实例到Nacos服务。&lt;/p>
&lt;p>&lt;strong>请求类型&lt;/strong>：&lt;code>POST&lt;/code>&lt;/p>
&lt;p>&lt;strong>请求路径&lt;/strong>：&lt;code>/nacos/v1/ns/instance&lt;/code>&lt;/p>
&lt;p>&lt;strong>请求参数&lt;/strong>：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">名称&lt;/th>
&lt;th style="text-align:left">类型&lt;/th>
&lt;th style="text-align:left">是否必选&lt;/th>
&lt;th>描述&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">ip&lt;/td>
&lt;td style="text-align:left">字符串&lt;/td>
&lt;td style="text-align:left">是&lt;/td>
&lt;td>服务实例IP&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">port&lt;/td>
&lt;td style="text-align:left">int&lt;/td>
&lt;td style="text-align:left">是&lt;/td>
&lt;td>服务实例port&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">namespaceId&lt;/td>
&lt;td style="text-align:left">字符串&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>命名空间ID&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">weight&lt;/td>
&lt;td style="text-align:left">double&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>权重&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">enabled&lt;/td>
&lt;td style="text-align:left">boolean&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>是否上线&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">healthy&lt;/td>
&lt;td style="text-align:left">boolean&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>是否健康&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">metadata&lt;/td>
&lt;td style="text-align:left">字符串&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>扩展信息&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">clusterName&lt;/td>
&lt;td style="text-align:left">字符串&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>集群名&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">serviceName&lt;/td>
&lt;td style="text-align:left">字符串&lt;/td>
&lt;td style="text-align:left">是&lt;/td>
&lt;td>服务名&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">groupName&lt;/td>
&lt;td style="text-align:left">字符串&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>分组名&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">ephemeral&lt;/td>
&lt;td style="text-align:left">boolean&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>是否临时实例&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;strong>错误编码&lt;/strong>：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">错误代码&lt;/th>
&lt;th style="text-align:left">描述&lt;/th>
&lt;th style="text-align:left">语义&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">400&lt;/td>
&lt;td style="text-align:left">Bad Request&lt;/td>
&lt;td style="text-align:left">客户端请求中的语法错误&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">403&lt;/td>
&lt;td style="text-align:left">Forbidden&lt;/td>
&lt;td style="text-align:left">没有权限&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">404&lt;/td>
&lt;td style="text-align:left">Not Found&lt;/td>
&lt;td style="text-align:left">无法找到资源&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">500&lt;/td>
&lt;td style="text-align:left">Internal Server Error&lt;/td>
&lt;td style="text-align:left">服务器内部错误&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">200&lt;/td>
&lt;td style="text-align:left">OK&lt;/td>
&lt;td style="text-align:left">正常&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="22客户端">
&lt;a href="#22%e5%ae%a2%e6%88%b7%e7%ab%af" class="header-anchor">#&lt;/a>
2.2.客户端
&lt;/h2>&lt;p>首先，我们需要找到服务注册的入口。&lt;/p>
&lt;h3 id="221nacosserviceregistryautoconfiguration">
&lt;a href="#221nacosserviceregistryautoconfiguration" class="header-anchor">#&lt;/a>
2.2.1.NacosServiceRegistryAutoConfiguration
&lt;/h3>&lt;p>因为Nacos的客户端是基于SpringBoot的自动装配实现的，我们可以在nacos-discovery依赖：&lt;/p>
&lt;p>&lt;code>spring-cloud-starter-alibaba-nacos-discovery-2.2.6.RELEASE.jar&lt;/code>&lt;/p>
&lt;p>这个包中找到Nacos自动装配信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-ba3eac1132930c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210907201333049"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，有很多个自动配置类被加载了，其中跟服务注册有关的就是NacosServiceRegistryAutoConfiguration这个类，我们跟入其中。&lt;/p>
&lt;p>可以看到，在NacosServiceRegistryAutoConfiguration这个类中，包含一个跟自动注册有关的Bean：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-67b4025281ac3a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210907201612322"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="222nacosautoserviceregistration">
&lt;a href="#222nacosautoserviceregistration" class="header-anchor">#&lt;/a>
2.2.2.NacosAutoServiceRegistration
&lt;/h3>&lt;p>&lt;code>NacosAutoServiceRegistration&lt;/code>源码如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-a570202bd8d39b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210907213647145"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到在初始化时，其父类&lt;code>AbstractAutoServiceRegistration&lt;/code>也被初始化了。&lt;/p>
&lt;p>&lt;code>AbstractAutoServiceRegistration&lt;/code>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-adf93738740705.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210907214111801"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到它实现了&lt;code>ApplicationListener&lt;/code>接口，监听Spring容器启动过程中的事件。&lt;/p>
&lt;p>在监听到&lt;code>WebServerInitializedEvent&lt;/code>（web服务初始化完成）的事件后，执行了&lt;code>bind&lt;/code> 方法。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-90e1c770b84f42.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210907214411267"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的bind方法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-9">&lt;a class="lnlinks" href="#hl-1-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-10">&lt;a class="lnlinks" href="#hl-1-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-11">&lt;a class="lnlinks" href="#hl-1-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-12">&lt;a class="lnlinks" href="#hl-1-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-13">&lt;a class="lnlinks" href="#hl-1-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-14">&lt;a class="lnlinks" href="#hl-1-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-15">&lt;a class="lnlinks" href="#hl-1-15">15&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">WebServerInitializedEvent&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">event&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取 ApplicationContext&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ApplicationContext&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">event&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getApplicationContext&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断服务的 namespace,一般都是null&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">instanceof&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ConfigurableWebServerApplicationContext&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;management&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(((&lt;/span>&lt;span class="n">ConfigurableWebServerApplicationContext&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getServerNamespace&lt;/span>&lt;span class="p">()))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 记录当前 web 服务的端口&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">port&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">compareAndSet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">event&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getWebServer&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getPort&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 启动当前服务注册流程&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中的start方法流程：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-9">&lt;a class="lnlinks" href="#hl-2-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-10">&lt;a class="lnlinks" href="#hl-2-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-11">&lt;a class="lnlinks" href="#hl-2-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-12">&lt;a class="lnlinks" href="#hl-2-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-13">&lt;a class="lnlinks" href="#hl-2-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-14">&lt;a class="lnlinks" href="#hl-2-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-15">&lt;a class="lnlinks" href="#hl-2-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-16">&lt;a class="lnlinks" href="#hl-2-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-17">&lt;a class="lnlinks" href="#hl-2-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-18">&lt;a class="lnlinks" href="#hl-2-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-19">&lt;a class="lnlinks" href="#hl-2-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-20">&lt;a class="lnlinks" href="#hl-2-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-21">&lt;a class="lnlinks" href="#hl-2-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-22">&lt;a class="lnlinks" href="#hl-2-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-23">&lt;a class="lnlinks" href="#hl-2-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-24">&lt;a class="lnlinks" href="#hl-2-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-25">&lt;a class="lnlinks" href="#hl-2-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-26">&lt;a class="lnlinks" href="#hl-2-26">26&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">start&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">isEnabled&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isDebugEnabled&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Discovery Lifecycle disabled. Not starting&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 当前服务处于未运行状态时，才进行初始化&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">running&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发布服务开始注册的事件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">publishEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InstancePreRegisteredEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getRegistration&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// ☆☆☆☆开始注册☆☆☆☆&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">register&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">shouldRegisterManagement&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">registerManagement&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发布注册完成事件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">publishEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InstanceRegisteredEvent&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getConfiguration&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 服务状态设置为运行状态，基于AtomicBoolean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">running&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">compareAndSet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中最关键的register()方法就是完成服务注册的关键，代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">protected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">register&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">serviceRegistry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">register&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">getRegistration&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>此处的this.serviceRegistry就是NacosServiceRegistry：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-c6232b34d665ba.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210907215903335"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="223nacosserviceregistry">
&lt;a href="#223nacosserviceregistry" class="header-anchor">#&lt;/a>
2.2.3.NacosServiceRegistry
&lt;/h3>&lt;p>&lt;code>NacosServiceRegistry&lt;/code>是Spring的&lt;code>ServiceRegistry&lt;/code>接口的实现类，而ServiceRegistry接口是服务注册、发现的规约接口，定义了register、deregister等方法的声明。&lt;/p>
&lt;p>而&lt;code>NacosServiceRegistry&lt;/code>对&lt;code>register&lt;/code>的实现如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-5">&lt;a class="lnlinks" href="#hl-4-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-6">&lt;a class="lnlinks" href="#hl-4-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-7">&lt;a class="lnlinks" href="#hl-4-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-8">&lt;a class="lnlinks" href="#hl-4-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-9">&lt;a class="lnlinks" href="#hl-4-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-10">&lt;a class="lnlinks" href="#hl-4-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-11">&lt;a class="lnlinks" href="#hl-4-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-12">&lt;a class="lnlinks" href="#hl-4-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-13">&lt;a class="lnlinks" href="#hl-4-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-14">&lt;a class="lnlinks" href="#hl-4-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-15">&lt;a class="lnlinks" href="#hl-4-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-16">&lt;a class="lnlinks" href="#hl-4-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-17">&lt;a class="lnlinks" href="#hl-4-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-18">&lt;a class="lnlinks" href="#hl-4-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-19">&lt;a class="lnlinks" href="#hl-4-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-20">&lt;a class="lnlinks" href="#hl-4-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-21">&lt;a class="lnlinks" href="#hl-4-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-22">&lt;a class="lnlinks" href="#hl-4-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-23">&lt;a class="lnlinks" href="#hl-4-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-24">&lt;a class="lnlinks" href="#hl-4-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-25">&lt;a class="lnlinks" href="#hl-4-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-26">&lt;a class="lnlinks" href="#hl-4-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-27">&lt;a class="lnlinks" href="#hl-4-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-28">&lt;a class="lnlinks" href="#hl-4-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-29">&lt;a class="lnlinks" href="#hl-4-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-30">&lt;a class="lnlinks" href="#hl-4-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-31">&lt;a class="lnlinks" href="#hl-4-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-32">&lt;a class="lnlinks" href="#hl-4-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-33">&lt;a class="lnlinks" href="#hl-4-33">33&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">register&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Registration&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">registration&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断serviceId是否为空，也就是spring.application.name不能为空&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">registration&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getServiceId&lt;/span>&lt;span class="p">()))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">warn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;No service to register for nacos client...&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取Nacos的命名服务，其实就是注册中心服务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NamingService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namingService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namingService&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取 serviceId 和 Group&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceId&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">registration&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getServiceId&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">group&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">nacosDiscoveryProperties&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getGroup&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 封装服务实例的基本信息，如 cluster-name、是否为临时实例、权重、IP、端口等&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getNacosInstanceFromRegistration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">registration&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 开始注册服务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">namingService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">registerInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">group&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;nacos registry, {} {} {}:{} register finished&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">group&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIp&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPort&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nacosDiscoveryProperties&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isFailFast&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;nacos registry, {} register failed...{},&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">registration&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">rethrowRuntimeException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">warn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Failfast is false. {} register failed...{},&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">registration&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可以看到方法中最终是调用NamingService的registerInstance方法实现注册的。&lt;/p>
&lt;p>而NamingService接口的默认实现就是NacosNamingService。&lt;/p>
&lt;h3 id="224nacosnamingservice">
&lt;a href="#224nacosnamingservice" class="header-anchor">#&lt;/a>
2.2.4.NacosNamingService
&lt;/h3>&lt;p>NacosNamingService提供了服务注册、订阅等功能。&lt;/p>
&lt;p>其中registerInstance就是注册服务实例，源码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-4">&lt;a class="lnlinks" href="#hl-5-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-5">&lt;a class="lnlinks" href="#hl-5-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-6">&lt;a class="lnlinks" href="#hl-5-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-7">&lt;a class="lnlinks" href="#hl-5-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-8">&lt;a class="lnlinks" href="#hl-5-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-9">&lt;a class="lnlinks" href="#hl-5-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-10">&lt;a class="lnlinks" href="#hl-5-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-11">&lt;a class="lnlinks" href="#hl-5-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-12">&lt;a class="lnlinks" href="#hl-5-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-13">&lt;a class="lnlinks" href="#hl-5-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-14">&lt;a class="lnlinks" href="#hl-5-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-15">&lt;a class="lnlinks" href="#hl-5-15">15&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">registerInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 检查超时参数是否异常。心跳超时时间(默认15秒)必须大于心跳周期(默认5秒)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NamingUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">checkInstanceIsLegal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 拼接得到新的服务名，格式为：groupName@@serviceId&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupedServiceName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NamingUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getGroupedName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断是否为临时实例，默认为 true。&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEphemeral&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果是临时实例，需要定时向 Nacos 服务发送心跳&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">BeatInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">buildBeatInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">groupedServiceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">beatReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addBeatInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">groupedServiceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发送注册服务实例的请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serverProxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">registerService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">groupedServiceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>最终，由NacosProxy的registerService方法，完成服务注册。&lt;/p>
&lt;p>代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-5">&lt;a class="lnlinks" href="#hl-6-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-6">&lt;a class="lnlinks" href="#hl-6-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-7">&lt;a class="lnlinks" href="#hl-6-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-8">&lt;a class="lnlinks" href="#hl-6-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-9">&lt;a class="lnlinks" href="#hl-6-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-10">&lt;a class="lnlinks" href="#hl-6-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-11">&lt;a class="lnlinks" href="#hl-6-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-12">&lt;a class="lnlinks" href="#hl-6-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-13">&lt;a class="lnlinks" href="#hl-6-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-14">&lt;a class="lnlinks" href="#hl-6-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-15">&lt;a class="lnlinks" href="#hl-6-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-16">&lt;a class="lnlinks" href="#hl-6-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-17">&lt;a class="lnlinks" href="#hl-6-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-18">&lt;a class="lnlinks" href="#hl-6-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-19">&lt;a class="lnlinks" href="#hl-6-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-20">&lt;a class="lnlinks" href="#hl-6-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-21">&lt;a class="lnlinks" href="#hl-6-21">21&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">registerService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NAMING_LOGGER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[REGISTER-SERVICE] {} registering service {} with instance: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 组织请求参数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">16&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">NAMESPACE_ID&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SERVICE_NAME&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">GROUP_NAME&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CLUSTER_NAME&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterName&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ip&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIp&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;port&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">valueOf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPort&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;weight&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">valueOf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getWeight&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;enable&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">valueOf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEnabled&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;healthy&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">valueOf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isHealthy&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ephemeral&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">valueOf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEphemeral&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;metadata&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toJson&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMetadata&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 通过POST请求将上述参数，发送到 /nacos/v1/ns/instance&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">reqApi&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">UtilAndComs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">nacosUrlInstance&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HttpMethod&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">POST&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里提交的信息就是Nacos服务注册接口需要的完整参数，核心参数有：&lt;/p>
&lt;ul>
&lt;li>namespace_id：环境&lt;/li>
&lt;li>service_name：服务名称&lt;/li>
&lt;li>group_name：组名称&lt;/li>
&lt;li>cluster_name：集群名称&lt;/li>
&lt;li>ip: 当前实例的ip地址&lt;/li>
&lt;li>port: 当前实例的端口&lt;/li>
&lt;/ul>
&lt;p>而在NacosNamingService的registerInstance方法中，有一段是与服务心跳有关的代码，我们在后续会继续学习。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-c791fb223c52bd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210908141019175"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="225客户端注册的流程图">
&lt;a href="#225%e5%ae%a2%e6%88%b7%e7%ab%af%e6%b3%a8%e5%86%8c%e7%9a%84%e6%b5%81%e7%a8%8b%e5%9b%be" class="header-anchor">#&lt;/a>
2.2.5.客户端注册的流程图
&lt;/h3>&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-259cc47b77c95c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210923185331470"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="23服务端">
&lt;a href="#23%e6%9c%8d%e5%8a%a1%e7%ab%af" class="header-anchor">#&lt;/a>
2.3.服务端
&lt;/h2>&lt;p>在nacos-console的模块中，会引入nacos-naming这个模块：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-d24d2bcf7f0af5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922112801808"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>模块结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-daee000095a358.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922112954630"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的com.alibaba.nacos.naming.controllers包下就有服务注册、发现等相关的各种接口，其中的服务注册是在&lt;code>InstanceController&lt;/code>类中：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-4e863fe193a696.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922113158618"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="231instancecontroller">
&lt;a href="#231instancecontroller" class="header-anchor">#&lt;/a>
2.3.1.InstanceController
&lt;/h3>&lt;p>进入InstanceController类，可以看到一个register方法，就是服务注册的方法了：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-8">&lt;a class="lnlinks" href="#hl-7-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-9">&lt;a class="lnlinks" href="#hl-7-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-10">&lt;a class="lnlinks" href="#hl-7-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-11">&lt;a class="lnlinks" href="#hl-7-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-12">&lt;a class="lnlinks" href="#hl-7-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-13">&lt;a class="lnlinks" href="#hl-7-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-14">&lt;a class="lnlinks" href="#hl-7-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-15">&lt;a class="lnlinks" href="#hl-7-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-16">&lt;a class="lnlinks" href="#hl-7-16">16&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@CanDistro&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@PostMapping&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Secured&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">parser&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NamingResourceParser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ActionTypes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">WRITE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">register&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 尝试获取namespaceId&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">NAMESPACE_ID&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT_NAMESPACE_ID&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 尝试获取serviceName，其格式为 group_name@@service_name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">required&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SERVICE_NAME&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NamingUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">checkServiceNameFormat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 解析出实例信息，封装为Instance对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">parseInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 注册实例&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceManager&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">registerInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;ok&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里，进入到了serviceManager.registerInstance()方法中。&lt;/p>
&lt;h3 id="232servicemanager">
&lt;a href="#232servicemanager" class="header-anchor">#&lt;/a>
2.3.2.ServiceManager
&lt;/h3>&lt;p>ServiceManager就是Nacos中管理服务、实例信息的核心API，其中就包含Nacos的服务注册表：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-879175cdb32ffe.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922141703128"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>而其中的registerInstance方法就是注册服务实例的方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-6">&lt;a class="lnlinks" href="#hl-8-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-7">&lt;a class="lnlinks" href="#hl-8-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-8">&lt;a class="lnlinks" href="#hl-8-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-9">&lt;a class="lnlinks" href="#hl-8-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-10">&lt;a class="lnlinks" href="#hl-8-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-11">&lt;a class="lnlinks" href="#hl-8-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-12">&lt;a class="lnlinks" href="#hl-8-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-13">&lt;a class="lnlinks" href="#hl-8-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-14">&lt;a class="lnlinks" href="#hl-8-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-15">&lt;a class="lnlinks" href="#hl-8-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-16">&lt;a class="lnlinks" href="#hl-8-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-17">&lt;a class="lnlinks" href="#hl-8-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-18">&lt;a class="lnlinks" href="#hl-8-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-19">&lt;a class="lnlinks" href="#hl-8-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-20">&lt;a class="lnlinks" href="#hl-8-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-21">&lt;a class="lnlinks" href="#hl-8-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-22">&lt;a class="lnlinks" href="#hl-8-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-23">&lt;a class="lnlinks" href="#hl-8-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-24">&lt;a class="lnlinks" href="#hl-8-24">24&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * Register an instance to a service in AP mode.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * &amp;lt;p&amp;gt;This method creates service or cluster silently if they don&amp;#39;t exist.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param namespaceId id of namespace
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param serviceName service name
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param instance instance to register
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @throws Exception any error occurred in the process
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">registerInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建一个空的service（如果是第一次来注册实例，要先创建一个空service出来，放入注册表）&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 此时不包含实例信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">createEmptyService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEphemeral&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 拿到创建好的service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 拿不到则抛异常&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">INVALID_PARAM&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;service not found, namespace: &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;, service: &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 添加要注册的实例到service中&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">addInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEphemeral&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>创建好了服务，接下来就要添加实例到服务中：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-5">&lt;a class="lnlinks" href="#hl-9-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-6">&lt;a class="lnlinks" href="#hl-9-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-7">&lt;a class="lnlinks" href="#hl-9-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-8">&lt;a class="lnlinks" href="#hl-9-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-9">&lt;a class="lnlinks" href="#hl-9-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-10">&lt;a class="lnlinks" href="#hl-9-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-11">&lt;a class="lnlinks" href="#hl-9-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-12">&lt;a class="lnlinks" href="#hl-9-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-13">&lt;a class="lnlinks" href="#hl-9-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-14">&lt;a class="lnlinks" href="#hl-9-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-15">&lt;a class="lnlinks" href="#hl-9-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-16">&lt;a class="lnlinks" href="#hl-9-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-17">&lt;a class="lnlinks" href="#hl-9-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-18">&lt;a class="lnlinks" href="#hl-9-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-19">&lt;a class="lnlinks" href="#hl-9-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-20">&lt;a class="lnlinks" href="#hl-9-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-21">&lt;a class="lnlinks" href="#hl-9-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-22">&lt;a class="lnlinks" href="#hl-9-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-23">&lt;a class="lnlinks" href="#hl-9-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-24">&lt;a class="lnlinks" href="#hl-9-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-25">&lt;a class="lnlinks" href="#hl-9-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-26">&lt;a class="lnlinks" href="#hl-9-26">26&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * Add instance to service.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param namespaceId namespace
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param serviceName service name
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param ephemeral whether instance is ephemeral
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param ips instances
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @throws NacosException nacos exception
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">addInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 监听服务列表用到的key，服务唯一标识，例如：com.alibaba.nacos.naming.iplist.ephemeral.public##DEFAULT_GROUP@@order-service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">KeyBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">buildInstanceListKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取服务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 同步锁，避免并发修改的安全问题&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">synchronized&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1）获取要更新的实例列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instanceList&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">addIpAddresses&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2）封装实例列表到Instances对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Instances&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instances&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instances&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instances&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setInstanceList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instanceList&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3）完成 注册表更新 以及 Nacos集群的数据同步&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">consistencyService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instances&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>该方法中对修改服务列表的动作加锁处理，确保线程安全。而在同步代码块中，包含下面几步：&lt;/p>
&lt;ul>
&lt;li>1）先获取要更新的实例列表，&lt;code>addIpAddresses(service, ephemeral, ips);&lt;/code>&lt;/li>
&lt;li>2）然后将更新后的数据封装到&lt;code>Instances&lt;/code>对象中，后面更新注册表时使用&lt;/li>
&lt;li>3）最后，调用&lt;code>consistencyService.put()&lt;/code>方法完成Nacos集群的数据同步，保证集群一致性。&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>注意：在第1步的addIPAddress中，会拷贝旧的实例列表，添加新实例到列表中。在第3步中，完成对实例状态更新后，则会用新列表直接覆盖旧实例列表。而在更新过程中，旧实例列表不受影响，用户依然可以读取。&lt;/p>
&lt;p>这样在更新列表状态过程中，无需阻塞用户的读操作，也不会导致用户读取到脏数据，性能比较好。这种方案称为CopyOnWrite方案。&lt;/p>
&lt;/blockquote>
&lt;h4 id="1更服务列表">
&lt;a href="#1%e6%9b%b4%e6%9c%8d%e5%8a%a1%e5%88%97%e8%a1%a8" class="header-anchor">#&lt;/a>
1）更服务列表
&lt;/h4>&lt;p>我们来看看实例列表的更新，对应的方法是&lt;code>addIpAddresses(service, ephemeral, ips);&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">addIpAddresses&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">updateIpAddresses&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UtilsAndCommons&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">UPDATE_INSTANCE_ACTION_ADD&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>继续进入&lt;code>updateIpAddresses&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-5">&lt;a class="lnlinks" href="#hl-11-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-6">&lt;a class="lnlinks" href="#hl-11-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-7">&lt;a class="lnlinks" href="#hl-11-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-8">&lt;a class="lnlinks" href="#hl-11-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-9">&lt;a class="lnlinks" href="#hl-11-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-10">&lt;a class="lnlinks" href="#hl-11-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-11">&lt;a class="lnlinks" href="#hl-11-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-12">&lt;a class="lnlinks" href="#hl-11-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-13">&lt;a class="lnlinks" href="#hl-11-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-14">&lt;a class="lnlinks" href="#hl-11-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-15">&lt;a class="lnlinks" href="#hl-11-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-16">&lt;a class="lnlinks" href="#hl-11-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-17">&lt;a class="lnlinks" href="#hl-11-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-18">&lt;a class="lnlinks" href="#hl-11-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-19">&lt;a class="lnlinks" href="#hl-11-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-20">&lt;a class="lnlinks" href="#hl-11-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-21">&lt;a class="lnlinks" href="#hl-11-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-22">&lt;a class="lnlinks" href="#hl-11-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-23">&lt;a class="lnlinks" href="#hl-11-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-24">&lt;a class="lnlinks" href="#hl-11-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-25">&lt;a class="lnlinks" href="#hl-11-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-26">&lt;a class="lnlinks" href="#hl-11-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-27">&lt;a class="lnlinks" href="#hl-11-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-28">&lt;a class="lnlinks" href="#hl-11-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-29">&lt;a class="lnlinks" href="#hl-11-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-30">&lt;a class="lnlinks" href="#hl-11-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-31">&lt;a class="lnlinks" href="#hl-11-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-32">&lt;a class="lnlinks" href="#hl-11-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-33">&lt;a class="lnlinks" href="#hl-11-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-34">&lt;a class="lnlinks" href="#hl-11-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-35">&lt;a class="lnlinks" href="#hl-11-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-36">&lt;a class="lnlinks" href="#hl-11-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-37">&lt;a class="lnlinks" href="#hl-11-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-38">&lt;a class="lnlinks" href="#hl-11-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-39">&lt;a class="lnlinks" href="#hl-11-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-40">&lt;a class="lnlinks" href="#hl-11-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-41">&lt;a class="lnlinks" href="#hl-11-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-42">&lt;a class="lnlinks" href="#hl-11-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-43">&lt;a class="lnlinks" href="#hl-11-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-44">&lt;a class="lnlinks" href="#hl-11-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-45">&lt;a class="lnlinks" href="#hl-11-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-46">&lt;a class="lnlinks" href="#hl-11-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-47">&lt;a class="lnlinks" href="#hl-11-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-48">&lt;a class="lnlinks" href="#hl-11-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-49">&lt;a class="lnlinks" href="#hl-11-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-50">&lt;a class="lnlinks" href="#hl-11-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-51">&lt;a class="lnlinks" href="#hl-11-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-52">&lt;a class="lnlinks" href="#hl-11-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-53">&lt;a class="lnlinks" href="#hl-11-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-54">&lt;a class="lnlinks" href="#hl-11-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-55">&lt;a class="lnlinks" href="#hl-11-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-56">&lt;a class="lnlinks" href="#hl-11-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-57">&lt;a class="lnlinks" href="#hl-11-57">57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-58">&lt;a class="lnlinks" href="#hl-11-58">58&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-59">&lt;a class="lnlinks" href="#hl-11-59">59&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-60">&lt;a class="lnlinks" href="#hl-11-60">60&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-61">&lt;a class="lnlinks" href="#hl-11-61">61&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-62">&lt;a class="lnlinks" href="#hl-11-62">62&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-63">&lt;a class="lnlinks" href="#hl-11-63">63&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-64">&lt;a class="lnlinks" href="#hl-11-64">64&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-65">&lt;a class="lnlinks" href="#hl-11-65">65&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-66">&lt;a class="lnlinks" href="#hl-11-66">66&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-67">&lt;a class="lnlinks" href="#hl-11-67">67&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">updateIpAddresses&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 根据namespaceId、serviceName获取当前服务的实例列表，返回值是Datum&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 第一次来，肯定是null&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Datum&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datum&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">consistencyService&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">KeyBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">buildInstanceListKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getNamespaceId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 得到服务中现有的实例列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">currentIPs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">allIPs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建map，保存实例列表，key为ip地址，value是Instance对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">currentInstances&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentIPs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建Set集合，保存实例的instanceId&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Set&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">currentInstanceIds&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Sets&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">newHashSet&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 遍历要现有的实例列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">currentIPs&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 添加到map中&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">currentInstances&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toIpAddr&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 添加instanceId到set中&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">currentInstanceIds&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getInstanceId&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建map，用来保存更新后的实例列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instanceMap&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datum&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datum&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果服务中已经有旧的数据，则先保存旧的实例列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instanceMap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">setValid&lt;/span>&lt;span class="p">(((&lt;/span>&lt;span class="n">Instances&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datum&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">getInstanceList&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">currentInstances&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果没有旧数据，则直接创建新的map&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instanceMap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 遍历实例列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断服务中是否包含要注册的实例的cluster信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterMap&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">containsKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterName&lt;/span>&lt;span class="p">()))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果不包含，创建新的cluster&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Cluster&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Cluster&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">init&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 将集群放入service的注册表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterMap&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">warn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;cluster: {} not found, ip: {}, will create new cluster with default configuration.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toJson&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 删除实例 or 新增实例 ？&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">UtilsAndCommons&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">UPDATE_INSTANCE_ACTION_REMOVE&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instanceMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getDatumKey&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 新增实例，instance生成全新的instanceId&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldInstance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instanceMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getDatumKey&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">oldInstance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setInstanceId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">oldInstance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getInstanceId&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setInstanceId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">generateInstanceId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentInstanceIds&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放入instance列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instanceMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getDatumKey&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instanceMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UtilsAndCommons&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">UPDATE_INSTANCE_ACTION_ADD&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IllegalArgumentException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;ip list can not be empty, service: &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;, ip list: &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toJson&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instanceMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">values&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 将instanceMap中的所有实例转为List返回&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instanceMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">values&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>简单来讲，就是先获取旧的实例列表，然后把新的实例信息与旧的做对比，新的实例就添加，老的实例同步ID。然后返回最新的实例列表。&lt;/p>
&lt;h4 id="2nacos集群一致性">
&lt;a href="#2nacos%e9%9b%86%e7%be%a4%e4%b8%80%e8%87%b4%e6%80%a7" class="header-anchor">#&lt;/a>
2）Nacos集群一致性
&lt;/h4>&lt;p>在完成本地服务列表更新后，Nacos又实现了集群一致性更新，调用的是:&lt;/p>
&lt;p>&lt;code>consistencyService.put(key, instances);&lt;/code>&lt;/p>
&lt;p>这里的ConsistencyService接口，代表集群一致性的接口，有很多中不同实现：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-1d2b24b9f4803e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922161705573"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们进入DelegateConsistencyServiceImpl来看：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Record&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 根据实例是否是临时实例，判断委托对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">mapConsistencyService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中的&lt;code>mapConsistencyService(key)&lt;/code>方法就是选择委托方式的：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-6">&lt;a class="lnlinks" href="#hl-13-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ConsistencyService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">mapConsistencyService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断是否是临时实例：&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 是，选择 ephemeralConsistencyService，也就是 DistroConsistencyServiceImpl类&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 否，选择 persistentConsistencyService，也就是PersistentConsistencyServiceDelegateImpl&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">KeyBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchEphemeralKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeralConsistencyService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">persistentConsistencyService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>默认情况下，所有实例都是临时实例，我们关注DistroConsistencyServiceImpl即可。&lt;/p>
&lt;h3 id="234distroconsistencyserviceimpl">
&lt;a href="#234distroconsistencyserviceimpl" class="header-anchor">#&lt;/a>
2.3.4.DistroConsistencyServiceImpl
&lt;/h3>&lt;p>我们来看临时实例的一致性实现：DistroConsistencyServiceImpl类的put方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-5">&lt;a class="lnlinks" href="#hl-14-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-6">&lt;a class="lnlinks" href="#hl-14-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-7">&lt;a class="lnlinks" href="#hl-14-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Record&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 先将要更新的实例信息写入本地实例列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">onPut&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 开始集群同步&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">distroProtocol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">sync&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DistroKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">KeyBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">INSTANCE_LIST_KEY_PREFIX&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DataOperation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CHANGE&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">globalConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getTaskDispatchPeriod&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">2&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里方法只有两行：&lt;/p>
&lt;ul>
&lt;li>&lt;code>onPut(key, value)&lt;/code>：其中value就是Instances，要更新的服务信息。这行主要是基于线程池方式，异步的将Service信息写入注册表中(就是那个多重Map)&lt;/li>
&lt;li>&lt;code>distroProtocol.sync()&lt;/code>：就是通过Distro协议将数据同步给集群中的其它Nacos节点&lt;/li>
&lt;/ul>
&lt;p>我们先看onPut方法&lt;/p>
&lt;h4 id="2341更新本地实例列表">
&lt;a href="#2341%e6%9b%b4%e6%96%b0%e6%9c%ac%e5%9c%b0%e5%ae%9e%e4%be%8b%e5%88%97%e8%a1%a8" class="header-anchor">#&lt;/a>
2.3.4.1.更新本地实例列表
&lt;/h4>&lt;h5 id="1放入阻塞队列">
&lt;a href="#1%e6%94%be%e5%85%a5%e9%98%bb%e5%a1%9e%e9%98%9f%e5%88%97" class="header-anchor">#&lt;/a>
1）放入阻塞队列
&lt;/h5>&lt;p>onPut方法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-6">&lt;a class="lnlinks" href="#hl-15-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-7">&lt;a class="lnlinks" href="#hl-15-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-8">&lt;a class="lnlinks" href="#hl-15-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-9">&lt;a class="lnlinks" href="#hl-15-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-10">&lt;a class="lnlinks" href="#hl-15-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-11">&lt;a class="lnlinks" href="#hl-15-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-12">&lt;a class="lnlinks" href="#hl-15-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-13">&lt;a class="lnlinks" href="#hl-15-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-14">&lt;a class="lnlinks" href="#hl-15-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-15">&lt;a class="lnlinks" href="#hl-15-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-16">&lt;a class="lnlinks" href="#hl-15-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-17">&lt;a class="lnlinks" href="#hl-15-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-18">&lt;a class="lnlinks" href="#hl-15-18">18&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">onPut&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Record&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断是否是临时实例&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">KeyBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchEphemeralInstanceListKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 封装 Instances 信息到 数据集：Datum&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Datum&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instances&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datum&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Datum&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">datum&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instances&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">datum&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">datum&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">timestamp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">incrementAndGet&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放入DataStore&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">dataStore&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datum&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">listeners&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">containsKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放入阻塞队列，这里的 notifier维护了一个阻塞队列，并且基于线程池异步执行队列中的任务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">notifier&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DataOperation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CHANGE&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>notifier的类型就是&lt;code>DistroConsistencyServiceImpl.Notifier&lt;/code>，内部维护了一个阻塞队列，存放服务列表变更的事件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-4a0315e7442f08.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922180246555"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>addTask时，将任务加入该阻塞队列：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-7">&lt;a class="lnlinks" href="#hl-16-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-8">&lt;a class="lnlinks" href="#hl-16-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-9">&lt;a class="lnlinks" href="#hl-16-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-10">&lt;a class="lnlinks" href="#hl-16-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-11">&lt;a class="lnlinks" href="#hl-16-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-12">&lt;a class="lnlinks" href="#hl-16-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// DistroConsistencyServiceImpl.Notifier类的 addTask 方法：&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">addTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DataOperation&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">services&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">containsKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DataOperation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CHANGE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DataOperation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CHANGE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">services&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EMPTY&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 任务放入阻塞队列&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">tasks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">offer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Pair&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">with&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="2notifier异步更新">
&lt;a href="#2notifier%e5%bc%82%e6%ad%a5%e6%9b%b4%e6%96%b0" class="header-anchor">#&lt;/a>
2）Notifier异步更新
&lt;/h5>&lt;p>同时，notifier还是一个Runnable，通过一个单线程的线程池来不断从阻塞队列中获取任务，执行服务列表的更新。来看下其中的run方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-4">&lt;a class="lnlinks" href="#hl-17-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-5">&lt;a class="lnlinks" href="#hl-17-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-6">&lt;a class="lnlinks" href="#hl-17-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-7">&lt;a class="lnlinks" href="#hl-17-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-8">&lt;a class="lnlinks" href="#hl-17-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-9">&lt;a class="lnlinks" href="#hl-17-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-10">&lt;a class="lnlinks" href="#hl-17-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-11">&lt;a class="lnlinks" href="#hl-17-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-12">&lt;a class="lnlinks" href="#hl-17-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-13">&lt;a class="lnlinks" href="#hl-17-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-14">&lt;a class="lnlinks" href="#hl-17-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-15">&lt;a class="lnlinks" href="#hl-17-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-16">&lt;a class="lnlinks" href="#hl-17-16">16&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// DistroConsistencyServiceImpl.Notifier类的run方法：&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">run&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DISTRO&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;distro notifier started&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 死循环，不断执行任务。因为是阻塞队列，不会导致CPU负载过高&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 从阻塞队列中获取任务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Pair&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DataOperation&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pair&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tasks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">take&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 处理任务，更新服务列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pair&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DISTRO&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[NACOS-DISTRO] Error while handling notifying task&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>来看看handle方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-5">&lt;a class="lnlinks" href="#hl-18-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-6">&lt;a class="lnlinks" href="#hl-18-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-7">&lt;a class="lnlinks" href="#hl-18-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-8">&lt;a class="lnlinks" href="#hl-18-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-9">&lt;a class="lnlinks" href="#hl-18-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-10">&lt;a class="lnlinks" href="#hl-18-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-11">&lt;a class="lnlinks" href="#hl-18-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-12">&lt;a class="lnlinks" href="#hl-18-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-13">&lt;a class="lnlinks" href="#hl-18-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-14">&lt;a class="lnlinks" href="#hl-18-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-15">&lt;a class="lnlinks" href="#hl-18-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-16">&lt;a class="lnlinks" href="#hl-18-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-17">&lt;a class="lnlinks" href="#hl-18-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-18">&lt;a class="lnlinks" href="#hl-18-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-19">&lt;a class="lnlinks" href="#hl-18-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-20">&lt;a class="lnlinks" href="#hl-18-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-21">&lt;a class="lnlinks" href="#hl-18-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-22">&lt;a class="lnlinks" href="#hl-18-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-23">&lt;a class="lnlinks" href="#hl-18-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-24">&lt;a class="lnlinks" href="#hl-18-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-25">&lt;a class="lnlinks" href="#hl-18-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-26">&lt;a class="lnlinks" href="#hl-18-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-27">&lt;a class="lnlinks" href="#hl-18-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-28">&lt;a class="lnlinks" href="#hl-18-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-29">&lt;a class="lnlinks" href="#hl-18-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-30">&lt;a class="lnlinks" href="#hl-18-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-31">&lt;a class="lnlinks" href="#hl-18-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-32">&lt;a class="lnlinks" href="#hl-18-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-33">&lt;a class="lnlinks" href="#hl-18-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-34">&lt;a class="lnlinks" href="#hl-18-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-35">&lt;a class="lnlinks" href="#hl-18-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-36">&lt;a class="lnlinks" href="#hl-18-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-37">&lt;a class="lnlinks" href="#hl-18-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-38">&lt;a class="lnlinks" href="#hl-18-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-39">&lt;a class="lnlinks" href="#hl-18-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-40">&lt;a class="lnlinks" href="#hl-18-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-41">&lt;a class="lnlinks" href="#hl-18-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-42">&lt;a class="lnlinks" href="#hl-18-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-43">&lt;a class="lnlinks" href="#hl-18-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-44">&lt;a class="lnlinks" href="#hl-18-44">44&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// DistroConsistencyServiceImpl.Notifier类的 handle 方法：&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Pair&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DataOperation&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pair&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pair&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getValue0&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">DataOperation&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pair&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getValue1&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">services&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">listeners&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">containsKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 遍历，找到变化的service，这里的 RecordListener就是 Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RecordListener&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">listener&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">listeners&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 服务的实例列表CHANGE事件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DataOperation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CHANGE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 更新服务列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">listener&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">onChange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dataStore&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 服务的实例列表 DELETE 事件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DataOperation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DELETE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">listener&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">onDelete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DISTRO&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[NACOS-DISTRO] error while notifying listener of key: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DISTRO&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isDebugEnabled&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DISTRO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[NACOS-DISTRO] datum change notified, key: {}, listener count: {}, action: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">datumKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">name&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DISTRO&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[NACOS-DISTRO] Error while handling notifying task&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="3覆盖实例列表">
&lt;a href="#3%e8%a6%86%e7%9b%96%e5%ae%9e%e4%be%8b%e5%88%97%e8%a1%a8" class="header-anchor">#&lt;/a>
3）覆盖实例列表
&lt;/h5>&lt;p>而在Service的onChange方法中，就可以看到更新实例列表的逻辑了：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-5">&lt;a class="lnlinks" href="#hl-19-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-6">&lt;a class="lnlinks" href="#hl-19-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-7">&lt;a class="lnlinks" href="#hl-19-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-8">&lt;a class="lnlinks" href="#hl-19-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-9">&lt;a class="lnlinks" href="#hl-19-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-10">&lt;a class="lnlinks" href="#hl-19-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">onChange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instances&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[NACOS-RAFT] datum is changed, key: {}, value: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 更新实例列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">updateIPs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getInstanceList&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">KeyBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchEphemeralInstanceListKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">recalculateChecksum&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>updateIPs方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-4">&lt;a class="lnlinks" href="#hl-20-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-5">&lt;a class="lnlinks" href="#hl-20-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-6">&lt;a class="lnlinks" href="#hl-20-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-7">&lt;a class="lnlinks" href="#hl-20-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-8">&lt;a class="lnlinks" href="#hl-20-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-9">&lt;a class="lnlinks" href="#hl-20-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-10">&lt;a class="lnlinks" href="#hl-20-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-11">&lt;a class="lnlinks" href="#hl-20-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-12">&lt;a class="lnlinks" href="#hl-20-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-13">&lt;a class="lnlinks" href="#hl-20-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-14">&lt;a class="lnlinks" href="#hl-20-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-15">&lt;a class="lnlinks" href="#hl-20-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-16">&lt;a class="lnlinks" href="#hl-20-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-17">&lt;a class="lnlinks" href="#hl-20-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-18">&lt;a class="lnlinks" href="#hl-20-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-19">&lt;a class="lnlinks" href="#hl-20-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-20">&lt;a class="lnlinks" href="#hl-20-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-21">&lt;a class="lnlinks" href="#hl-20-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-22">&lt;a class="lnlinks" href="#hl-20-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-23">&lt;a class="lnlinks" href="#hl-20-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-24">&lt;a class="lnlinks" href="#hl-20-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-25">&lt;a class="lnlinks" href="#hl-20-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-26">&lt;a class="lnlinks" href="#hl-20-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-27">&lt;a class="lnlinks" href="#hl-20-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-28">&lt;a class="lnlinks" href="#hl-20-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-29">&lt;a class="lnlinks" href="#hl-20-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-30">&lt;a class="lnlinks" href="#hl-20-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-31">&lt;a class="lnlinks" href="#hl-20-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-32">&lt;a class="lnlinks" href="#hl-20-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-33">&lt;a class="lnlinks" href="#hl-20-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-34">&lt;a class="lnlinks" href="#hl-20-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-35">&lt;a class="lnlinks" href="#hl-20-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-36">&lt;a class="lnlinks" href="#hl-20-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-37">&lt;a class="lnlinks" href="#hl-20-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-38">&lt;a class="lnlinks" href="#hl-20-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-39">&lt;a class="lnlinks" href="#hl-20-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-40">&lt;a class="lnlinks" href="#hl-20-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-41">&lt;a class="lnlinks" href="#hl-20-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-42">&lt;a class="lnlinks" href="#hl-20-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-43">&lt;a class="lnlinks" href="#hl-20-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-44">&lt;a class="lnlinks" href="#hl-20-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-45">&lt;a class="lnlinks" href="#hl-20-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-46">&lt;a class="lnlinks" href="#hl-20-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-47">&lt;a class="lnlinks" href="#hl-20-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-48">&lt;a class="lnlinks" href="#hl-20-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-49">&lt;a class="lnlinks" href="#hl-20-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-50">&lt;a class="lnlinks" href="#hl-20-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-51">&lt;a class="lnlinks" href="#hl-20-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-52">&lt;a class="lnlinks" href="#hl-20-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-53">&lt;a class="lnlinks" href="#hl-20-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-54">&lt;a class="lnlinks" href="#hl-20-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-55">&lt;a class="lnlinks" href="#hl-20-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-56">&lt;a class="lnlinks" href="#hl-20-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-57">&lt;a class="lnlinks" href="#hl-20-57">57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-58">&lt;a class="lnlinks" href="#hl-20-58">58&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-59">&lt;a class="lnlinks" href="#hl-20-59">59&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-60">&lt;a class="lnlinks" href="#hl-20-60">60&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">updateIPs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Collection&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instances&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 准备一个Map，key是cluster，值是集群下的Instance集合&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ipMap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusterMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取服务的所有cluster名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">keySet&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ipMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 遍历要更新的实例&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instances&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[NACOS-DOM] received malformed ip: null&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断实例是否包含clusterName，没有的话用默认cluster&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterName&lt;/span>&lt;span class="p">()))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setClusterName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">UtilsAndCommons&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT_CLUSTER_NAME&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断cluster是否存在，不存在则创建新的cluster&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">clusterMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">containsKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterName&lt;/span>&lt;span class="p">()))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">warn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;cluster: {} not found, ip: {}, will create new cluster with default configuration.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toJson&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Cluster&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Cluster&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">init&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">getClusterMap&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取当前cluster实例的集合，不存在则创建新的&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterIPs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ipMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterName&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusterIPs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clusterIPs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LinkedList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ipMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterIPs&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 添加新的实例到 Instance 集合&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clusterIPs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[NACOS-DOM] failed to process ip: &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ipMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">entrySet&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">//make every ip mine&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entryIPs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 将实例集合更新到 clusterMap（注册表）&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clusterMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="na">updateIps&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">entryIPs&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">setLastModifiedMillis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发布服务变更的通知消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">getPushService&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">serviceChanged&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">StringBuilder&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stringBuilder&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringBuilder&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">allIPs&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">stringBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toIpAddr&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;_&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isHealthy&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="na">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;,&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EVT_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[IP-UPDATED] namespace: {}, service: {}, ips: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getNamespaceId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">stringBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在第45行的代码中：&lt;code>clusterMap.get(entry.getKey()).updateIps(entryIPs, ephemeral);&lt;/code>&lt;/p>
&lt;p>就是在更新注册表：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-21-1">&lt;a class="lnlinks" href="#hl-21-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-2">&lt;a class="lnlinks" href="#hl-21-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-3">&lt;a class="lnlinks" href="#hl-21-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-4">&lt;a class="lnlinks" href="#hl-21-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-5">&lt;a class="lnlinks" href="#hl-21-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-6">&lt;a class="lnlinks" href="#hl-21-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-7">&lt;a class="lnlinks" href="#hl-21-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-8">&lt;a class="lnlinks" href="#hl-21-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-9">&lt;a class="lnlinks" href="#hl-21-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-10">&lt;a class="lnlinks" href="#hl-21-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-11">&lt;a class="lnlinks" href="#hl-21-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-12">&lt;a class="lnlinks" href="#hl-21-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-13">&lt;a class="lnlinks" href="#hl-21-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-14">&lt;a class="lnlinks" href="#hl-21-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-15">&lt;a class="lnlinks" href="#hl-21-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-16">&lt;a class="lnlinks" href="#hl-21-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-17">&lt;a class="lnlinks" href="#hl-21-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-18">&lt;a class="lnlinks" href="#hl-21-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-19">&lt;a class="lnlinks" href="#hl-21-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-20">&lt;a class="lnlinks" href="#hl-21-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-21">&lt;a class="lnlinks" href="#hl-21-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-22">&lt;a class="lnlinks" href="#hl-21-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-23">&lt;a class="lnlinks" href="#hl-21-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-24">&lt;a class="lnlinks" href="#hl-21-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-25">&lt;a class="lnlinks" href="#hl-21-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-26">&lt;a class="lnlinks" href="#hl-21-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-27">&lt;a class="lnlinks" href="#hl-21-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-28">&lt;a class="lnlinks" href="#hl-21-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-29">&lt;a class="lnlinks" href="#hl-21-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-30">&lt;a class="lnlinks" href="#hl-21-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-31">&lt;a class="lnlinks" href="#hl-21-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-32">&lt;a class="lnlinks" href="#hl-21-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-33">&lt;a class="lnlinks" href="#hl-21-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-34">&lt;a class="lnlinks" href="#hl-21-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-35">&lt;a class="lnlinks" href="#hl-21-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-36">&lt;a class="lnlinks" href="#hl-21-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-37">&lt;a class="lnlinks" href="#hl-21-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-38">&lt;a class="lnlinks" href="#hl-21-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-39">&lt;a class="lnlinks" href="#hl-21-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-40">&lt;a class="lnlinks" href="#hl-21-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-41">&lt;a class="lnlinks" href="#hl-21-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-42">&lt;a class="lnlinks" href="#hl-21-42">42&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">updateIps&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取旧实例列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Set&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">toUpdateInstances&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeralInstances&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">persistentInstances&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldIpMap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">toUpdateInstances&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">toUpdateInstances&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">oldIpMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getDatumKey&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 检查新加入实例的状态&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">newIPs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">subtract&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldIpMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">values&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">newIPs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EVT_LOG&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;{} {SYNC} {IP-NEW} cluster: {}, new ips size: {}, content: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getService&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">newIPs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">newIPs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">newIPs&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HealthCheckStatus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">reset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 移除要删除的实例&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">deadIPs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">subtract&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">oldIpMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">values&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">deadIPs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EVT_LOG&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;{} {SYNC} {IP-DEAD} cluster: {}, dead ips size: {}, content: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getService&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">deadIPs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">deadIPs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">deadIPs&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HealthCheckStatus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">remv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">toUpdateInstances&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashSet&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 直接覆盖旧实例列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ephemeral&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ephemeralInstances&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">toUpdateInstances&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">persistentInstances&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">toUpdateInstances&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="2342集群数据同步">
&lt;a href="#2342%e9%9b%86%e7%be%a4%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5" class="header-anchor">#&lt;/a>
2.3.4.2.集群数据同步
&lt;/h4>&lt;p>在DistroConsistencyServiceImpl的put方法中分为两步：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-d559ebb0e2f998.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922195603450"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的onPut方法已经分析过了。&lt;/p>
&lt;p>下面的distroProtocol.sync()就是集群同步的逻辑了。&lt;/p>
&lt;p>DistroProtocol类的sync方法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-22-1">&lt;a class="lnlinks" href="#hl-22-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-2">&lt;a class="lnlinks" href="#hl-22-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-3">&lt;a class="lnlinks" href="#hl-22-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-4">&lt;a class="lnlinks" href="#hl-22-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-5">&lt;a class="lnlinks" href="#hl-22-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-6">&lt;a class="lnlinks" href="#hl-22-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-7">&lt;a class="lnlinks" href="#hl-22-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-8">&lt;a class="lnlinks" href="#hl-22-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-9">&lt;a class="lnlinks" href="#hl-22-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-10">&lt;a class="lnlinks" href="#hl-22-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-11">&lt;a class="lnlinks" href="#hl-22-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-12">&lt;a class="lnlinks" href="#hl-22-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-13">&lt;a class="lnlinks" href="#hl-22-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-14">&lt;a class="lnlinks" href="#hl-22-14">14&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">sync&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DistroKey&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">distroKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DataOperation&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">delay&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 遍历 Nacos 集群中除自己以外的其它节点&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Member&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">each&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">memberManager&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">allMembersWithoutSelf&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">DistroKey&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">distroKeyWithTarget&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DistroKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">distroKey&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getResourceKey&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">distroKey&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getResourceType&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">each&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getAddress&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 定义一个Distro的同步任务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">DistroDelayTask&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">distroDelayTask&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DistroDelayTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">distroKeyWithTarget&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">delay&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 交给线程池去执行&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">distroTaskEngineHolder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getDelayTaskExecuteEngine&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">addTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">distroKeyWithTarget&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">distroDelayTask&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DISTRO&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isDebugEnabled&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DISTRO&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[DISTRO-SCHEDULE] {} to {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">distroKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">each&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getAddress&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中同步的任务封装为一个&lt;code>DistroDelayTask&lt;/code>对象。&lt;/p>
&lt;p>交给了&lt;code>distroTaskEngineHolder.getDelayTaskExecuteEngine()&lt;/code>执行，这行代码的返回值是：&lt;/p>
&lt;p>&lt;code>NacosDelayTaskExecuteEngine&lt;/code>，这个类维护了一个线程池，并且接收任务，执行任务。&lt;/p>
&lt;p>执行任务的方法为processTasks()方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-23-1">&lt;a class="lnlinks" href="#hl-23-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-2">&lt;a class="lnlinks" href="#hl-23-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-3">&lt;a class="lnlinks" href="#hl-23-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-4">&lt;a class="lnlinks" href="#hl-23-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-5">&lt;a class="lnlinks" href="#hl-23-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-6">&lt;a class="lnlinks" href="#hl-23-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-7">&lt;a class="lnlinks" href="#hl-23-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-8">&lt;a class="lnlinks" href="#hl-23-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-9">&lt;a class="lnlinks" href="#hl-23-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-10">&lt;a class="lnlinks" href="#hl-23-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-11">&lt;a class="lnlinks" href="#hl-23-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-12">&lt;a class="lnlinks" href="#hl-23-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-13">&lt;a class="lnlinks" href="#hl-23-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-14">&lt;a class="lnlinks" href="#hl-23-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-15">&lt;a class="lnlinks" href="#hl-23-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-16">&lt;a class="lnlinks" href="#hl-23-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-17">&lt;a class="lnlinks" href="#hl-23-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-18">&lt;a class="lnlinks" href="#hl-23-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-19">&lt;a class="lnlinks" href="#hl-23-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-20">&lt;a class="lnlinks" href="#hl-23-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-21">&lt;a class="lnlinks" href="#hl-23-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-22">&lt;a class="lnlinks" href="#hl-23-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-23">&lt;a class="lnlinks" href="#hl-23-23">23&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">protected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">processTasks&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Collection&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getAllTaskKeys&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">taskKey&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">AbstractDelayTask&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">task&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">removeTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">taskKey&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">task&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NacosTaskProcessor&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">processor&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getProcessor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">taskKey&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">processor&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">getEngineLog&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;processor not found for task, so discarded. &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">task&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 尝试执行同步任务，如果失败会重试&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">processor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">process&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">task&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">retryFailedTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">taskKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">task&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">getEngineLog&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Nacos task execute error : &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">retryFailedTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">taskKey&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">task&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可以看出来基于Distro模式的同步是异步进行的，并且失败时会将任务重新入队并充实，因此不保证同步结果的强一致性，属于AP模式的一致性策略。&lt;/p>
&lt;h3 id="235服务端流程图">
&lt;a href="#235%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b5%81%e7%a8%8b%e5%9b%be" class="header-anchor">#&lt;/a>
2.3.5.服务端流程图
&lt;/h3>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-578b29d8930eb1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210923214042926"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="24总结">
&lt;a href="#24%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
2.4.总结
&lt;/h2>&lt;ul>
&lt;li>
&lt;p>Nacos的注册表结构是什么样的？&lt;/p>
&lt;ul>
&lt;li>
&lt;p>答：Nacos是多级存储模型，最外层通过namespace来实现环境隔离，然后是group分组，分组下就是服务，一个服务有可以分为不同的集群，集群中包含多个实例。因此其注册表结构为一个Map，类型是：&lt;/p>
&lt;p>&lt;code>Map&amp;lt;String, Map&amp;lt;String, Service&amp;gt;&amp;gt;&lt;/code>，&lt;/p>
&lt;p>外层key是&lt;code>namespace_id&lt;/code>，内层key是&lt;code>group+serviceName&lt;/code>.&lt;/p>
&lt;p>Service内部维护一个Map，结构是：&lt;code>Map&amp;lt;String,Cluster&amp;gt;&lt;/code>，key是clusterName，值是集群信息&lt;/p>
&lt;p>Cluster内部维护一个Set集合，元素是Instance类型，代表集群中的多个实例。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Nacos如何保证并发写的安全性？&lt;/p>
&lt;ul>
&lt;li>答：首先，在注册实例时，会对service加锁，不同service之间本身就不存在并发写问题，互不影响。相同service时通过锁来互斥。并且，在更新实例列表时，是基于异步的线程池来完成，而线程池的线程数量为1.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Nacos如何避免并发读写的冲突？&lt;/p>
&lt;ul>
&lt;li>答：Nacos在更新实例列表时，会采用CopyOnWrite技术，首先将Old实例列表拷贝一份，然后更新拷贝的实例列表，再用更新后的实例列表来覆盖旧的实例列表。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Nacos如何应对阿里内部数十万服务的并发写请求？&lt;/p>
&lt;ul>
&lt;li>答：Nacos内部会将服务注册的任务放入阻塞队列，采用线程池异步来完成实例更新，从而提高并发写能力。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h1 id="3服务心跳">
&lt;a href="#3%e6%9c%8d%e5%8a%a1%e5%bf%83%e8%b7%b3" class="header-anchor">#&lt;/a>
3.服务心跳
&lt;/h1>&lt;p>Nacos的实例分为临时实例和永久实例两种，可以通过在yaml 文件配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-24-1">&lt;a class="lnlinks" href="#hl-24-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-2">&lt;a class="lnlinks" href="#hl-24-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-3">&lt;a class="lnlinks" href="#hl-24-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-4">&lt;a class="lnlinks" href="#hl-24-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-5">&lt;a class="lnlinks" href="#hl-24-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-6">&lt;a class="lnlinks" href="#hl-24-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-7">&lt;a class="lnlinks" href="#hl-24-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-8">&lt;a class="lnlinks" href="#hl-24-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">application&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">order-service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">discovery&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ephemeral&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 设置实例为永久实例。true：临时; false：永久&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server-addr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">192.168.150.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">8845&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>临时实例基于心跳方式做健康检测，而永久实例则是由Nacos主动探测实例状态。&lt;/p>
&lt;p>其中Nacos提供的心跳的API接口为：&lt;/p>
&lt;p>&lt;strong>接口描述&lt;/strong>：发送某个实例的心跳&lt;/p>
&lt;p>&lt;strong>请求类型&lt;/strong>：PUT&lt;/p>
&lt;p>&lt;strong>请求路径&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-25-1">&lt;a class="lnlinks" href="#hl-25-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">/nacos/v1/ns/instance/beat
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>请求参数&lt;/strong>：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">名称&lt;/th>
&lt;th style="text-align:left">类型&lt;/th>
&lt;th style="text-align:left">是否必选&lt;/th>
&lt;th>描述&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">serviceName&lt;/td>
&lt;td style="text-align:left">字符串&lt;/td>
&lt;td style="text-align:left">是&lt;/td>
&lt;td>服务名&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">groupName&lt;/td>
&lt;td style="text-align:left">字符串&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>分组名&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">ephemeral&lt;/td>
&lt;td style="text-align:left">boolean&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>是否临时实例&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">beat&lt;/td>
&lt;td style="text-align:left">JSON格式字符串&lt;/td>
&lt;td style="text-align:left">是&lt;/td>
&lt;td>实例心跳内容&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;strong>错误编码&lt;/strong>：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">错误代码&lt;/th>
&lt;th style="text-align:left">描述&lt;/th>
&lt;th style="text-align:left">语义&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">400&lt;/td>
&lt;td style="text-align:left">Bad Request&lt;/td>
&lt;td style="text-align:left">客户端请求中的语法错误&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">403&lt;/td>
&lt;td style="text-align:left">Forbidden&lt;/td>
&lt;td style="text-align:left">没有权限&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">404&lt;/td>
&lt;td style="text-align:left">Not Found&lt;/td>
&lt;td style="text-align:left">无法找到资源&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">500&lt;/td>
&lt;td style="text-align:left">Internal Server Error&lt;/td>
&lt;td style="text-align:left">服务器内部错误&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">200&lt;/td>
&lt;td style="text-align:left">OK&lt;/td>
&lt;td style="text-align:left">正常&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="31客户端">
&lt;a href="#31%e5%ae%a2%e6%88%b7%e7%ab%af" class="header-anchor">#&lt;/a>
3.1.客户端
&lt;/h2>&lt;p>在2.2.4.服务注册这一节中，我们说过NacosNamingService这个类实现了服务的注册，同时也实现了服务心跳：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-26-1">&lt;a class="lnlinks" href="#hl-26-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-2">&lt;a class="lnlinks" href="#hl-26-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-3">&lt;a class="lnlinks" href="#hl-26-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-4">&lt;a class="lnlinks" href="#hl-26-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-5">&lt;a class="lnlinks" href="#hl-26-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-6">&lt;a class="lnlinks" href="#hl-26-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-7">&lt;a class="lnlinks" href="#hl-26-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-8">&lt;a class="lnlinks" href="#hl-26-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-9">&lt;a class="lnlinks" href="#hl-26-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-10">&lt;a class="lnlinks" href="#hl-26-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-11">&lt;a class="lnlinks" href="#hl-26-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-12">&lt;a class="lnlinks" href="#hl-26-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-13">&lt;a class="lnlinks" href="#hl-26-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">registerInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NamingUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">checkInstanceIsLegal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupedServiceName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NamingUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getGroupedName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断是否是临时实例。&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEphemeral&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果是临时实例，则构建心跳信息BeatInfo&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">BeatInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">buildBeatInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">groupedServiceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 添加心跳任务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">beatReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addBeatInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">groupedServiceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serverProxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">registerService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">groupedServiceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="311beatinfo">
&lt;a href="#311beatinfo" class="header-anchor">#&lt;/a>
3.1.1.BeatInfo
&lt;/h3>&lt;p>这里的BeanInfo就包含心跳需要的各种信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-547f507f6ee6f6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922213313677"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="312beatreactor">
&lt;a href="#312beatreactor" class="header-anchor">#&lt;/a>
3.1.2.BeatReactor
&lt;/h3>&lt;p>而&lt;code>BeatReactor&lt;/code>这个类则维护了一个线程池：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-4fd12787589c9b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922213455549"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>当调用&lt;code>BeatReactor&lt;/code>的&lt;code>.addBeatInfo(groupedServiceName, beatInfo)&lt;/code>方法时，就会执行心跳：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-27-1">&lt;a class="lnlinks" href="#hl-27-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-2">&lt;a class="lnlinks" href="#hl-27-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-3">&lt;a class="lnlinks" href="#hl-27-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-4">&lt;a class="lnlinks" href="#hl-27-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-5">&lt;a class="lnlinks" href="#hl-27-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-6">&lt;a class="lnlinks" href="#hl-27-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-7">&lt;a class="lnlinks" href="#hl-27-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-8">&lt;a class="lnlinks" href="#hl-27-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-9">&lt;a class="lnlinks" href="#hl-27-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-10">&lt;a class="lnlinks" href="#hl-27-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-11">&lt;a class="lnlinks" href="#hl-27-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-12">&lt;a class="lnlinks" href="#hl-27-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-13">&lt;a class="lnlinks" href="#hl-27-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">addBeatInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BeatInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NAMING_LOGGER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[BEAT] adding beat: {} to beat map.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">buildKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIp&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPort&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">BeatInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">existBeat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">//fix #1733&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">existBeat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dom2Beat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">existBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setStopped&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">dom2Beat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 利用线程池，定期执行心跳任务，周期为 beatInfo.getPeriod()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">executorService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">schedule&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BeatTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPeriod&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TimeUnit&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">MetricsMonitor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getDom2BeatSizeMonitor&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dom2Beat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>心跳周期的默认值在&lt;code>com.alibaba.nacos.api.common.Constants&lt;/code>类中：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-1a8ff269cfe66d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922213829632"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到是5秒，默认5秒一次心跳。&lt;/p>
&lt;h3 id="313beattask">
&lt;a href="#313beattask" class="header-anchor">#&lt;/a>
3.1.3.BeatTask
&lt;/h3>&lt;p>心跳的任务封装在&lt;code>BeatTask&lt;/code>这个类中，是一个Runnable，其run方法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-28-1">&lt;a class="lnlinks" href="#hl-28-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-2">&lt;a class="lnlinks" href="#hl-28-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-3">&lt;a class="lnlinks" href="#hl-28-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-4">&lt;a class="lnlinks" href="#hl-28-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-5">&lt;a class="lnlinks" href="#hl-28-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-6">&lt;a class="lnlinks" href="#hl-28-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-7">&lt;a class="lnlinks" href="#hl-28-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-8">&lt;a class="lnlinks" href="#hl-28-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-9">&lt;a class="lnlinks" href="#hl-28-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-10">&lt;a class="lnlinks" href="#hl-28-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-11">&lt;a class="lnlinks" href="#hl-28-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-12">&lt;a class="lnlinks" href="#hl-28-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-13">&lt;a class="lnlinks" href="#hl-28-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-14">&lt;a class="lnlinks" href="#hl-28-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-15">&lt;a class="lnlinks" href="#hl-28-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-16">&lt;a class="lnlinks" href="#hl-28-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-17">&lt;a class="lnlinks" href="#hl-28-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-18">&lt;a class="lnlinks" href="#hl-28-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-19">&lt;a class="lnlinks" href="#hl-28-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-20">&lt;a class="lnlinks" href="#hl-28-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-21">&lt;a class="lnlinks" href="#hl-28-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-22">&lt;a class="lnlinks" href="#hl-28-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-23">&lt;a class="lnlinks" href="#hl-28-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-24">&lt;a class="lnlinks" href="#hl-28-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-25">&lt;a class="lnlinks" href="#hl-28-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-26">&lt;a class="lnlinks" href="#hl-28-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-27">&lt;a class="lnlinks" href="#hl-28-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-28">&lt;a class="lnlinks" href="#hl-28-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-29">&lt;a class="lnlinks" href="#hl-28-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-30">&lt;a class="lnlinks" href="#hl-28-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-31">&lt;a class="lnlinks" href="#hl-28-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-32">&lt;a class="lnlinks" href="#hl-28-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-33">&lt;a class="lnlinks" href="#hl-28-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-34">&lt;a class="lnlinks" href="#hl-28-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-35">&lt;a class="lnlinks" href="#hl-28-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-36">&lt;a class="lnlinks" href="#hl-28-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-37">&lt;a class="lnlinks" href="#hl-28-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-38">&lt;a class="lnlinks" href="#hl-28-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-39">&lt;a class="lnlinks" href="#hl-28-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-40">&lt;a class="lnlinks" href="#hl-28-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-41">&lt;a class="lnlinks" href="#hl-28-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-42">&lt;a class="lnlinks" href="#hl-28-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-43">&lt;a class="lnlinks" href="#hl-28-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-44">&lt;a class="lnlinks" href="#hl-28-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-45">&lt;a class="lnlinks" href="#hl-28-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-46">&lt;a class="lnlinks" href="#hl-28-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-47">&lt;a class="lnlinks" href="#hl-28-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-48">&lt;a class="lnlinks" href="#hl-28-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-49">&lt;a class="lnlinks" href="#hl-28-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-50">&lt;a class="lnlinks" href="#hl-28-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-51">&lt;a class="lnlinks" href="#hl-28-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-52">&lt;a class="lnlinks" href="#hl-28-52">52&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">run&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isStopped&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取心跳周期&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">nextTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPeriod&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发送心跳&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">JsonNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serverProxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">sendBeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BeatReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">lightBeatEnabled&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">interval&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;clientBeatInterval&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">asLong&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">lightBeatEnabled&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">has&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">LIGHT_BEAT_ENABLED&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">lightBeatEnabled&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">LIGHT_BEAT_ENABLED&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">asBoolean&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">BeatReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">lightBeatEnabled&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">lightBeatEnabled&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">interval&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">nextTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">interval&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断心跳结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">code&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NamingResponseCode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">OK&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">has&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CODE&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">code&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CODE&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">asInt&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">code&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NamingResponseCode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">RESOURCE_NOT_FOUND&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果失败，则需要 重新注册实例&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPort&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setIp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIp&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setWeight&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getWeight&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setMetadata&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMetadata&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setClusterName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCluster&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setServiceName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getServiceName&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setInstanceId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getInstanceId&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setEphemeral&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serverProxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">registerService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getServiceName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NamingUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getGroupName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getServiceName&lt;/span>&lt;span class="p">()),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ignore&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NAMING_LOGGER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[CLIENT-BEAT] failed to send beat: {}, code: {}, msg: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toJson&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getErrCode&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getErrMsg&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unknownEx&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NAMING_LOGGER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[CLIENT-BEAT] failed to send beat: {}, unknown exception msg: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toJson&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unknownEx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMessage&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unknownEx&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">finally&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">executorService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">schedule&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BeatTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">nextTime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TimeUnit&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="315发送心跳">
&lt;a href="#315%e5%8f%91%e9%80%81%e5%bf%83%e8%b7%b3" class="header-anchor">#&lt;/a>
3.1.5.发送心跳
&lt;/h3>&lt;p>最终心跳的发送还是通过&lt;code>NamingProxy&lt;/code>的&lt;code>sendBeat&lt;/code>方法来实现：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-29-1">&lt;a class="lnlinks" href="#hl-29-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-2">&lt;a class="lnlinks" href="#hl-29-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-3">&lt;a class="lnlinks" href="#hl-29-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-4">&lt;a class="lnlinks" href="#hl-29-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-5">&lt;a class="lnlinks" href="#hl-29-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-6">&lt;a class="lnlinks" href="#hl-29-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-7">&lt;a class="lnlinks" href="#hl-29-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-8">&lt;a class="lnlinks" href="#hl-29-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-9">&lt;a class="lnlinks" href="#hl-29-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-10">&lt;a class="lnlinks" href="#hl-29-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-11">&lt;a class="lnlinks" href="#hl-29-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-12">&lt;a class="lnlinks" href="#hl-29-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-13">&lt;a class="lnlinks" href="#hl-29-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-14">&lt;a class="lnlinks" href="#hl-29-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-15">&lt;a class="lnlinks" href="#hl-29-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-16">&lt;a class="lnlinks" href="#hl-29-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-17">&lt;a class="lnlinks" href="#hl-29-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-18">&lt;a class="lnlinks" href="#hl-29-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-19">&lt;a class="lnlinks" href="#hl-29-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-20">&lt;a class="lnlinks" href="#hl-29-20">20&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JsonNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">sendBeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BeatInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">lightBeatEnabled&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NAMING_LOGGER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isDebugEnabled&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NAMING_LOGGER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[BEAT] {} sending beat to server: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 组织请求参数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">8&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">bodyMap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">2&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">lightBeatEnabled&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">bodyMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;beat&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toJson&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">NAMESPACE_ID&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SERVICE_NAME&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getServiceName&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CLUSTER_NAME&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCluster&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ip&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIp&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;port&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">valueOf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beatInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPort&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发送请求，这个地址就是：/v1/ns/instance/beat&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">reqApi&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">UtilAndComs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">nacosUrlBase&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;/instance/beat&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">bodyMap&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HttpMethod&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">PUT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toObj&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="32服务端">
&lt;a href="#32%e6%9c%8d%e5%8a%a1%e7%ab%af" class="header-anchor">#&lt;/a>
3.2.服务端
&lt;/h2>&lt;p>对于临时实例，服务端代码分两部分：&lt;/p>
&lt;ul>
&lt;li>1）InstanceController提供了一个接口，处理客户端的心跳请求&lt;/li>
&lt;li>2）定时检测实例心跳是否按期执行&lt;/li>
&lt;/ul>
&lt;h3 id="321instancecontroller">
&lt;a href="#321instancecontroller" class="header-anchor">#&lt;/a>
3.2.1.InstanceController
&lt;/h3>&lt;p>与服务注册时一样，在nacos-naming模块中的InstanceController类中，定义了一个方法用来处理心跳请求：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-30-1">&lt;a class="lnlinks" href="#hl-30-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-2">&lt;a class="lnlinks" href="#hl-30-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-3">&lt;a class="lnlinks" href="#hl-30-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-4">&lt;a class="lnlinks" href="#hl-30-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-5">&lt;a class="lnlinks" href="#hl-30-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-6">&lt;a class="lnlinks" href="#hl-30-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-7">&lt;a class="lnlinks" href="#hl-30-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-8">&lt;a class="lnlinks" href="#hl-30-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-9">&lt;a class="lnlinks" href="#hl-30-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-10">&lt;a class="lnlinks" href="#hl-30-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-11">&lt;a class="lnlinks" href="#hl-30-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-12">&lt;a class="lnlinks" href="#hl-30-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-13">&lt;a class="lnlinks" href="#hl-30-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-14">&lt;a class="lnlinks" href="#hl-30-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-15">&lt;a class="lnlinks" href="#hl-30-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-16">&lt;a class="lnlinks" href="#hl-30-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-17">&lt;a class="lnlinks" href="#hl-30-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-18">&lt;a class="lnlinks" href="#hl-30-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-19">&lt;a class="lnlinks" href="#hl-30-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-20">&lt;a class="lnlinks" href="#hl-30-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-21">&lt;a class="lnlinks" href="#hl-30-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-22">&lt;a class="lnlinks" href="#hl-30-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-23">&lt;a class="lnlinks" href="#hl-30-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-24">&lt;a class="lnlinks" href="#hl-30-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-25">&lt;a class="lnlinks" href="#hl-30-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-26">&lt;a class="lnlinks" href="#hl-30-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-27">&lt;a class="lnlinks" href="#hl-30-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-28">&lt;a class="lnlinks" href="#hl-30-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-29">&lt;a class="lnlinks" href="#hl-30-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-30">&lt;a class="lnlinks" href="#hl-30-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-31">&lt;a class="lnlinks" href="#hl-30-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-32">&lt;a class="lnlinks" href="#hl-30-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-33">&lt;a class="lnlinks" href="#hl-30-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-34">&lt;a class="lnlinks" href="#hl-30-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-35">&lt;a class="lnlinks" href="#hl-30-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-36">&lt;a class="lnlinks" href="#hl-30-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-37">&lt;a class="lnlinks" href="#hl-30-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-38">&lt;a class="lnlinks" href="#hl-30-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-39">&lt;a class="lnlinks" href="#hl-30-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-40">&lt;a class="lnlinks" href="#hl-30-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-41">&lt;a class="lnlinks" href="#hl-30-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-42">&lt;a class="lnlinks" href="#hl-30-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-43">&lt;a class="lnlinks" href="#hl-30-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-44">&lt;a class="lnlinks" href="#hl-30-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-45">&lt;a class="lnlinks" href="#hl-30-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-46">&lt;a class="lnlinks" href="#hl-30-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-47">&lt;a class="lnlinks" href="#hl-30-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-48">&lt;a class="lnlinks" href="#hl-30-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-49">&lt;a class="lnlinks" href="#hl-30-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-50">&lt;a class="lnlinks" href="#hl-30-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-51">&lt;a class="lnlinks" href="#hl-30-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-52">&lt;a class="lnlinks" href="#hl-30-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-53">&lt;a class="lnlinks" href="#hl-30-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-54">&lt;a class="lnlinks" href="#hl-30-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-55">&lt;a class="lnlinks" href="#hl-30-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-56">&lt;a class="lnlinks" href="#hl-30-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-57">&lt;a class="lnlinks" href="#hl-30-57">57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-58">&lt;a class="lnlinks" href="#hl-30-58">58&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-59">&lt;a class="lnlinks" href="#hl-30-59">59&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-60">&lt;a class="lnlinks" href="#hl-30-60">60&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-61">&lt;a class="lnlinks" href="#hl-30-61">61&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-62">&lt;a class="lnlinks" href="#hl-30-62">62&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-63">&lt;a class="lnlinks" href="#hl-30-63">63&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-64">&lt;a class="lnlinks" href="#hl-30-64">64&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-65">&lt;a class="lnlinks" href="#hl-30-65">65&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-66">&lt;a class="lnlinks" href="#hl-30-66">66&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-67">&lt;a class="lnlinks" href="#hl-30-67">67&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-68">&lt;a class="lnlinks" href="#hl-30-68">68&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-69">&lt;a class="lnlinks" href="#hl-30-69">69&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-70">&lt;a class="lnlinks" href="#hl-30-70">70&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-71">&lt;a class="lnlinks" href="#hl-30-71">71&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-72">&lt;a class="lnlinks" href="#hl-30-72">72&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-73">&lt;a class="lnlinks" href="#hl-30-73">73&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-74">&lt;a class="lnlinks" href="#hl-30-74">74&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-75">&lt;a class="lnlinks" href="#hl-30-75">75&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-76">&lt;a class="lnlinks" href="#hl-30-76">76&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-77">&lt;a class="lnlinks" href="#hl-30-77">77&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-78">&lt;a class="lnlinks" href="#hl-30-78">78&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-79">&lt;a class="lnlinks" href="#hl-30-79">79&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@CanDistro&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@PutMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/beat&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Secured&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">parser&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NamingResourceParser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ActionTypes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">WRITE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ObjectNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">beat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 解析心跳的请求参数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ObjectNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">createEmptyJsonNode&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SwitchEntry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CLIENT_BEAT_INTERVAL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">switchDomain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClientBeatInterval&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;beat&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EMPTY&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">RsInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isNotBlank&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toObj&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RsInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CLUSTER_NAME&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UtilsAndCommons&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT_CLUSTER_NAME&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;ip&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EMPTY&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">port&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">parseInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;port&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;0&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isNotBlank&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCluster&lt;/span>&lt;span class="p">()))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCluster&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// fix #2533&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setCluster&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIp&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">port&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPort&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">NAMESPACE_ID&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT_NAMESPACE_ID&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">required&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SERVICE_NAME&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NamingUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">checkServiceNameFormat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[CLIENT-BEAT] full arguments: beat: {}, serviceName: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 尝试根据参数中的namespaceId、serviceName、clusterName、ip、port等信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 从Nacos的注册表中 获取实例&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceManager&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">port&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果获取失败，说明心跳失败，实例尚未注册&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CODE&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NamingResponseCode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">RESOURCE_NOT_FOUND&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">warn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[CLIENT-BEAT] The instance has been removed for health mechanism, &amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;perform data compensation operations, beat: {}, serviceName: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 这里重新注册一个实例&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPort&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setIp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIp&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setWeight&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getWeight&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setMetadata&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMetadata&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setClusterName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setServiceName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setInstanceId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getInstanceId&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setEphemeral&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEphemeral&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceManager&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">registerInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 尝试基于namespaceId和serviceName从 注册表中获取Service服务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceManager&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果不存在，说明服务不存在，返回404&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SERVER_ERROR&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;service not found: &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;@&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RsInfo&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setIp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">port&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setCluster&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果心跳没问题，开始处理心跳结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">processClientBeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeat&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CODE&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NamingResponseCode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">OK&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">containsMetadata&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PreservedMetadataKeys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HEART_BEAT_INTERVAL&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SwitchEntry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CLIENT_BEAT_INTERVAL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getInstanceHeartBeatInterval&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SwitchEntry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">LIGHT_BEAT_ENABLED&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">switchDomain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isLightBeatEnabled&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>最终，在确认心跳请求对应的服务、实例都在的情况下，开始交给Service类处理这次心跳请求。调用了Service的processClientBeat方法&lt;/p>
&lt;h3 id="322处理心跳请求">
&lt;a href="#322%e5%a4%84%e7%90%86%e5%bf%83%e8%b7%b3%e8%af%b7%e6%b1%82" class="header-anchor">#&lt;/a>
3.2.2.处理心跳请求
&lt;/h3>&lt;p>查看&lt;code>Service&lt;/code>的&lt;code>service.processClientBeat(clientBeat);&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-31-1">&lt;a class="lnlinks" href="#hl-31-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-2">&lt;a class="lnlinks" href="#hl-31-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-3">&lt;a class="lnlinks" href="#hl-31-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-4">&lt;a class="lnlinks" href="#hl-31-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-5">&lt;a class="lnlinks" href="#hl-31-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-6">&lt;a class="lnlinks" href="#hl-31-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">processClientBeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RsInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rsInfo&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ClientBeatProcessor&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeatProcessor&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ClientBeatProcessor&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeatProcessor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clientBeatProcessor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setRsInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rsInfo&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HealthCheckReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">scheduleNow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeatProcessor&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可以看到心跳信息被封装到了 ClientBeatProcessor类中，交给了HealthCheckReactor处理，HealthCheckReactor就是对线程池的封装，不用过多查看。&lt;/p>
&lt;p>关键的业务逻辑都在ClientBeatProcessor这个类中，它是一个Runnable，其中的run方法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-32-1">&lt;a class="lnlinks" href="#hl-32-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-2">&lt;a class="lnlinks" href="#hl-32-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-3">&lt;a class="lnlinks" href="#hl-32-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-4">&lt;a class="lnlinks" href="#hl-32-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-5">&lt;a class="lnlinks" href="#hl-32-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-6">&lt;a class="lnlinks" href="#hl-32-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-7">&lt;a class="lnlinks" href="#hl-32-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-8">&lt;a class="lnlinks" href="#hl-32-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-9">&lt;a class="lnlinks" href="#hl-32-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-10">&lt;a class="lnlinks" href="#hl-32-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-11">&lt;a class="lnlinks" href="#hl-32-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-12">&lt;a class="lnlinks" href="#hl-32-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-13">&lt;a class="lnlinks" href="#hl-32-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-14">&lt;a class="lnlinks" href="#hl-32-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-15">&lt;a class="lnlinks" href="#hl-32-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-16">&lt;a class="lnlinks" href="#hl-32-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-17">&lt;a class="lnlinks" href="#hl-32-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-18">&lt;a class="lnlinks" href="#hl-32-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-19">&lt;a class="lnlinks" href="#hl-32-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-20">&lt;a class="lnlinks" href="#hl-32-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-21">&lt;a class="lnlinks" href="#hl-32-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-22">&lt;a class="lnlinks" href="#hl-32-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-23">&lt;a class="lnlinks" href="#hl-32-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-24">&lt;a class="lnlinks" href="#hl-32-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-25">&lt;a class="lnlinks" href="#hl-32-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-26">&lt;a class="lnlinks" href="#hl-32-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-27">&lt;a class="lnlinks" href="#hl-32-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-28">&lt;a class="lnlinks" href="#hl-32-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-29">&lt;a class="lnlinks" href="#hl-32-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-30">&lt;a class="lnlinks" href="#hl-32-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-31">&lt;a class="lnlinks" href="#hl-32-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-32">&lt;a class="lnlinks" href="#hl-32-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-33">&lt;a class="lnlinks" href="#hl-32-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-34">&lt;a class="lnlinks" href="#hl-32-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-35">&lt;a class="lnlinks" href="#hl-32-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-36">&lt;a class="lnlinks" href="#hl-32-36">36&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">run&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">service&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EVT_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isDebugEnabled&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EVT_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[CLIENT-BEAT] processing beat: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rsInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rsInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIp&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rsInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCluster&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">port&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rsInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPort&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取集群信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Cluster&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterMap&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取集群中的所有实例信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instances&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">allIPs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instances&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 找到心跳的这个实例&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIp&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPort&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">port&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EVT_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isDebugEnabled&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EVT_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[CLIENT-BEAT] refresh beat: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rsInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 更新实例的最后一次心跳时间 lastBeat&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setLastBeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isMarked&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isHealthy&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setHealthy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EVT_LOG&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;service: {} {POS} {IP-ENABLED} valid: {}:{}@{}, region: {}, msg: client beat ok&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getService&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">port&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">UtilsAndCommons&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">LOCALHOST_SITE&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">getPushService&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">serviceChanged&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>处理心跳请求的核心就是更新心跳实例的最后一次心跳时间，lastBeat，这个会成为判断实例心跳是否过期的关键指标！&lt;/p>
&lt;h3 id="333心跳异常检测">
&lt;a href="#333%e5%bf%83%e8%b7%b3%e5%bc%82%e5%b8%b8%e6%a3%80%e6%b5%8b" class="header-anchor">#&lt;/a>
3.3.3.心跳异常检测
&lt;/h3>&lt;p>在服务注册时，一定会创建一个&lt;code>Service&lt;/code>对象，而&lt;code>Service&lt;/code>中有一个&lt;code>init&lt;/code>方法，会在注册时被调用：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-33-1">&lt;a class="lnlinks" href="#hl-33-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-2">&lt;a class="lnlinks" href="#hl-33-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-3">&lt;a class="lnlinks" href="#hl-33-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-4">&lt;a class="lnlinks" href="#hl-33-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-5">&lt;a class="lnlinks" href="#hl-33-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-6">&lt;a class="lnlinks" href="#hl-33-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-7">&lt;a class="lnlinks" href="#hl-33-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-8">&lt;a class="lnlinks" href="#hl-33-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 开启心跳检测的任务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HealthCheckReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">scheduleCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeatCheckTask&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Cluster&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">entrySet&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">setService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">init&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中HealthCheckReactor.scheduleCheck就是执行心跳检测的定时任务：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-7fd3ac1445bed9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922221022107"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，该任务是5000ms执行一次，也就是5秒对实例的心跳状态做一次检测。&lt;/p>
&lt;p>此处的ClientBeatCheckTask同样是一个Runnable，其中的run方法为：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-34-1">&lt;a class="lnlinks" href="#hl-34-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-2">&lt;a class="lnlinks" href="#hl-34-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-3">&lt;a class="lnlinks" href="#hl-34-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-4">&lt;a class="lnlinks" href="#hl-34-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-5">&lt;a class="lnlinks" href="#hl-34-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-6">&lt;a class="lnlinks" href="#hl-34-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-7">&lt;a class="lnlinks" href="#hl-34-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-8">&lt;a class="lnlinks" href="#hl-34-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-9">&lt;a class="lnlinks" href="#hl-34-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-10">&lt;a class="lnlinks" href="#hl-34-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-11">&lt;a class="lnlinks" href="#hl-34-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-12">&lt;a class="lnlinks" href="#hl-34-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-13">&lt;a class="lnlinks" href="#hl-34-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-14">&lt;a class="lnlinks" href="#hl-34-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-15">&lt;a class="lnlinks" href="#hl-34-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-16">&lt;a class="lnlinks" href="#hl-34-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-17">&lt;a class="lnlinks" href="#hl-34-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-18">&lt;a class="lnlinks" href="#hl-34-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-19">&lt;a class="lnlinks" href="#hl-34-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-20">&lt;a class="lnlinks" href="#hl-34-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-21">&lt;a class="lnlinks" href="#hl-34-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-22">&lt;a class="lnlinks" href="#hl-34-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-23">&lt;a class="lnlinks" href="#hl-34-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-24">&lt;a class="lnlinks" href="#hl-34-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-25">&lt;a class="lnlinks" href="#hl-34-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-26">&lt;a class="lnlinks" href="#hl-34-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-27">&lt;a class="lnlinks" href="#hl-34-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-28">&lt;a class="lnlinks" href="#hl-34-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-29">&lt;a class="lnlinks" href="#hl-34-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-30">&lt;a class="lnlinks" href="#hl-34-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-31">&lt;a class="lnlinks" href="#hl-34-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-32">&lt;a class="lnlinks" href="#hl-34-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-33">&lt;a class="lnlinks" href="#hl-34-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-34">&lt;a class="lnlinks" href="#hl-34-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-35">&lt;a class="lnlinks" href="#hl-34-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-36">&lt;a class="lnlinks" href="#hl-34-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-37">&lt;a class="lnlinks" href="#hl-34-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-38">&lt;a class="lnlinks" href="#hl-34-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-39">&lt;a class="lnlinks" href="#hl-34-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-40">&lt;a class="lnlinks" href="#hl-34-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-41">&lt;a class="lnlinks" href="#hl-34-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-42">&lt;a class="lnlinks" href="#hl-34-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-43">&lt;a class="lnlinks" href="#hl-34-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-44">&lt;a class="lnlinks" href="#hl-34-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-45">&lt;a class="lnlinks" href="#hl-34-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-46">&lt;a class="lnlinks" href="#hl-34-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-47">&lt;a class="lnlinks" href="#hl-34-47">47&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">run&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 找到所有临时实例的列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instances&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">allIPs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// first set health status of instances:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instances&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断 心跳间隔（当前时间 - 最后一次心跳时间） 是否大于 心跳超时时间，默认15秒&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLastBeat&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getInstanceHeartBeatTimeOut&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isMarked&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isHealthy&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果超时，标记实例为不健康 healthy = false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setHealthy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发布实例状态变更的事件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">getPushService&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">serviceChanged&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ApplicationUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">publishEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InstanceHeartbeatTimeoutEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">getGlobalConfig&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">isExpireInstance&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// then remove obsolete instances:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instances&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isMarked&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断心跳间隔（当前时间 - 最后一次心跳时间）是否大于 实例被删除的最长超时时间，默认30秒&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLastBeat&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIpDeleteTimeout&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果是超过了30秒，则删除实例&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[AUTO-DELETE-IP] service: {}, ip: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toJson&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">deleteIp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">warn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Exception while processing client beat time out.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中的超时时间同样是在&lt;code>com.alibaba.nacos.api.common.Constants&lt;/code>这个类中：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-af51b0053070d9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210922221344417"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="334主动健康检测">
&lt;a href="#334%e4%b8%bb%e5%8a%a8%e5%81%a5%e5%ba%b7%e6%a3%80%e6%b5%8b" class="header-anchor">#&lt;/a>
3.3.4.主动健康检测
&lt;/h3>&lt;p>对于非临时实例（ephemeral=false)，Nacos会采用主动的健康检测，定时向实例发送请求，根据响应来判断实例健康状态。&lt;/p>
&lt;p>入口在2.3.2小节的&lt;code>ServiceManager&lt;/code>类中的registerInstance方法：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-0599b3093860e6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210923100740065"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>创建空服务时：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-35-1">&lt;a class="lnlinks" href="#hl-35-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-2">&lt;a class="lnlinks" href="#hl-35-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-3">&lt;a class="lnlinks" href="#hl-35-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-4">&lt;a class="lnlinks" href="#hl-35-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">createEmptyService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果服务不存在，创建新的服务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">createServiceIfAbsent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>创建服务流程：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-36-1">&lt;a class="lnlinks" href="#hl-36-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-2">&lt;a class="lnlinks" href="#hl-36-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-3">&lt;a class="lnlinks" href="#hl-36-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-4">&lt;a class="lnlinks" href="#hl-36-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-5">&lt;a class="lnlinks" href="#hl-36-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-6">&lt;a class="lnlinks" href="#hl-36-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-7">&lt;a class="lnlinks" href="#hl-36-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-8">&lt;a class="lnlinks" href="#hl-36-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-9">&lt;a class="lnlinks" href="#hl-36-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-10">&lt;a class="lnlinks" href="#hl-36-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-11">&lt;a class="lnlinks" href="#hl-36-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-12">&lt;a class="lnlinks" href="#hl-36-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-13">&lt;a class="lnlinks" href="#hl-36-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-14">&lt;a class="lnlinks" href="#hl-36-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-15">&lt;a class="lnlinks" href="#hl-36-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-16">&lt;a class="lnlinks" href="#hl-36-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-17">&lt;a class="lnlinks" href="#hl-36-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-18">&lt;a class="lnlinks" href="#hl-36-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-19">&lt;a class="lnlinks" href="#hl-36-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-20">&lt;a class="lnlinks" href="#hl-36-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-21">&lt;a class="lnlinks" href="#hl-36-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-22">&lt;a class="lnlinks" href="#hl-36-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-23">&lt;a class="lnlinks" href="#hl-36-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-24">&lt;a class="lnlinks" href="#hl-36-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-25">&lt;a class="lnlinks" href="#hl-36-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-26">&lt;a class="lnlinks" href="#hl-36-26">26&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">createServiceIfAbsent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Cluster&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 尝试获取服务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发现服务不存在，开始创建新服务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;creating empty service {}:{}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Service&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setNamespaceId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setGroupName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NamingUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getGroupName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// now validate the service. if failed, exception will be thrown&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setLastModifiedMillis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">recalculateChecksum&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterMap&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">validate&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// ** 写入注册表并初始化 **&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">putServiceAndInit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">addOrReplaceService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>关键在&lt;code>putServiceAndInit(service)&lt;/code>方法中：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-37-1">&lt;a class="lnlinks" href="#hl-37-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-2">&lt;a class="lnlinks" href="#hl-37-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-3">&lt;a class="lnlinks" href="#hl-37-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-4">&lt;a class="lnlinks" href="#hl-37-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-5">&lt;a class="lnlinks" href="#hl-37-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-6">&lt;a class="lnlinks" href="#hl-37-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-7">&lt;a class="lnlinks" href="#hl-37-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-8">&lt;a class="lnlinks" href="#hl-37-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-9">&lt;a class="lnlinks" href="#hl-37-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-10">&lt;a class="lnlinks" href="#hl-37-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-11">&lt;a class="lnlinks" href="#hl-37-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-12">&lt;a class="lnlinks" href="#hl-37-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">putServiceAndInit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 将服务写入注册表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">putService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getNamespaceId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 完成服务的初始化&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">init&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">consistencyService&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">KeyBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">buildInstanceListKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getNamespaceId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">consistencyService&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">KeyBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">buildInstanceListKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getNamespaceId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[NEW-SERVICE] {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toJson&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>进入初始化逻辑：&lt;code>service.init()&lt;/code>，这个会进入Service类中：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-38-1">&lt;a class="lnlinks" href="#hl-38-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-2">&lt;a class="lnlinks" href="#hl-38-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-3">&lt;a class="lnlinks" href="#hl-38-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-4">&lt;a class="lnlinks" href="#hl-38-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-5">&lt;a class="lnlinks" href="#hl-38-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-6">&lt;a class="lnlinks" href="#hl-38-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-7">&lt;a class="lnlinks" href="#hl-38-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-8">&lt;a class="lnlinks" href="#hl-38-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-9">&lt;a class="lnlinks" href="#hl-38-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-10">&lt;a class="lnlinks" href="#hl-38-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-11">&lt;a class="lnlinks" href="#hl-38-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-12">&lt;a class="lnlinks" href="#hl-38-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-13">&lt;a class="lnlinks" href="#hl-38-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * Init service.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 开启临时实例的心跳监测任务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HealthCheckReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">scheduleCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientBeatCheckTask&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 遍历注册表中的集群&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Cluster&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">entrySet&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">setService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 完成集群初识化&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">init&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里集群的初始化&lt;code> entry.getValue().init();&lt;/code>会进入&lt;code>Cluster&lt;/code>类型的&lt;code>init()&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-39-1">&lt;a class="lnlinks" href="#hl-39-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-2">&lt;a class="lnlinks" href="#hl-39-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-3">&lt;a class="lnlinks" href="#hl-39-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-4">&lt;a class="lnlinks" href="#hl-39-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-5">&lt;a class="lnlinks" href="#hl-39-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-6">&lt;a class="lnlinks" href="#hl-39-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-7">&lt;a class="lnlinks" href="#hl-39-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-8">&lt;a class="lnlinks" href="#hl-39-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-9">&lt;a class="lnlinks" href="#hl-39-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-10">&lt;a class="lnlinks" href="#hl-39-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-11">&lt;a class="lnlinks" href="#hl-39-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-12">&lt;a class="lnlinks" href="#hl-39-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-13">&lt;a class="lnlinks" href="#hl-39-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * Init cluster.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">inited&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建健康检测的任务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">checkTask&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HealthCheckTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 这里会开启对 非临时实例的 定时健康检测&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HealthCheckReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">scheduleCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">checkTask&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">inited&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里的&lt;code>HealthCheckReactor.scheduleCheck(checkTask);&lt;/code>会开启定时任务，对非临时实例做健康检测。检测逻辑定义在&lt;code>HealthCheckTask&lt;/code>这个类中，是一个Runnable，其中的run方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-40-1">&lt;a class="lnlinks" href="#hl-40-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-2">&lt;a class="lnlinks" href="#hl-40-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-3">&lt;a class="lnlinks" href="#hl-40-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-4">&lt;a class="lnlinks" href="#hl-40-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-5">&lt;a class="lnlinks" href="#hl-40-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-6">&lt;a class="lnlinks" href="#hl-40-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-7">&lt;a class="lnlinks" href="#hl-40-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-8">&lt;a class="lnlinks" href="#hl-40-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-9">&lt;a class="lnlinks" href="#hl-40-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-10">&lt;a class="lnlinks" href="#hl-40-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-11">&lt;a class="lnlinks" href="#hl-40-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-12">&lt;a class="lnlinks" href="#hl-40-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-13">&lt;a class="lnlinks" href="#hl-40-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-14">&lt;a class="lnlinks" href="#hl-40-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-15">&lt;a class="lnlinks" href="#hl-40-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-16">&lt;a class="lnlinks" href="#hl-40-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-17">&lt;a class="lnlinks" href="#hl-40-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-18">&lt;a class="lnlinks" href="#hl-40-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-19">&lt;a class="lnlinks" href="#hl-40-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-20">&lt;a class="lnlinks" href="#hl-40-20">20&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">run&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">distroMapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">responsible&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getService&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">switchDomain&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isHealthCheckEnabled&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getService&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">()))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 开始健康检测&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">healthCheckProcessor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">process&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 记录日志 。。。&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 记录日志 。。。&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">finally&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">cancelled&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 结束后，再次进行任务调度，一定延迟后执行&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HealthCheckReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">scheduleCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 。。。&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>健康检测逻辑定义在&lt;code>healthCheckProcessor.process(this);&lt;/code>方法中，在HealthCheckProcessor接口中，这个接口也有很多实现，默认是&lt;code>TcpSuperSenseProcessor&lt;/code>：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-4dd9ff0801b1cf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210923102824451"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>进入&lt;code>TcpSuperSenseProcessor&lt;/code>的process方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-41-1">&lt;a class="lnlinks" href="#hl-41-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-2">&lt;a class="lnlinks" href="#hl-41-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-3">&lt;a class="lnlinks" href="#hl-41-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-4">&lt;a class="lnlinks" href="#hl-41-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-5">&lt;a class="lnlinks" href="#hl-41-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-6">&lt;a class="lnlinks" href="#hl-41-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-7">&lt;a class="lnlinks" href="#hl-41-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-8">&lt;a class="lnlinks" href="#hl-41-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-9">&lt;a class="lnlinks" href="#hl-41-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-10">&lt;a class="lnlinks" href="#hl-41-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-11">&lt;a class="lnlinks" href="#hl-41-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-12">&lt;a class="lnlinks" href="#hl-41-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-13">&lt;a class="lnlinks" href="#hl-41-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-14">&lt;a class="lnlinks" href="#hl-41-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-15">&lt;a class="lnlinks" href="#hl-41-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-16">&lt;a class="lnlinks" href="#hl-41-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-17">&lt;a class="lnlinks" href="#hl-41-17">17&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">process&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HealthCheckTask&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">task&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取所有 非临时实例的 集合&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">task&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCluster&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">allIPs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CollectionUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ips&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 封装健康检测信息到 Beat&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Beat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Beat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">task&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放入一个阻塞队列中&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">taskQueue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">MetricsMonitor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getTcpHealthCheckMonitor&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">incrementAndGet&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可以看到，所有的健康检测任务都被放入一个阻塞队列，而不是立即执行了。这里又采用了异步执行的策略，可以看到Nacos中大量这样的设计。&lt;/p>
&lt;p>而&lt;code>TcpSuperSenseProcessor&lt;/code>本身就是一个Runnable，在它的构造函数中会把自己放入线程池中去执行，其run方法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-42-1">&lt;a class="lnlinks" href="#hl-42-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-2">&lt;a class="lnlinks" href="#hl-42-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-3">&lt;a class="lnlinks" href="#hl-42-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-4">&lt;a class="lnlinks" href="#hl-42-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-5">&lt;a class="lnlinks" href="#hl-42-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-6">&lt;a class="lnlinks" href="#hl-42-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-7">&lt;a class="lnlinks" href="#hl-42-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-8">&lt;a class="lnlinks" href="#hl-42-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-9">&lt;a class="lnlinks" href="#hl-42-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-10">&lt;a class="lnlinks" href="#hl-42-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-11">&lt;a class="lnlinks" href="#hl-42-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">run&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">while&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 处理任务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">processTask&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// ...&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[HEALTH-CHECK] error while processing NIO task&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>通过processTask来处理健康检测的任务：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-43-1">&lt;a class="lnlinks" href="#hl-43-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-2">&lt;a class="lnlinks" href="#hl-43-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-3">&lt;a class="lnlinks" href="#hl-43-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-4">&lt;a class="lnlinks" href="#hl-43-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-5">&lt;a class="lnlinks" href="#hl-43-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-6">&lt;a class="lnlinks" href="#hl-43-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-7">&lt;a class="lnlinks" href="#hl-43-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-8">&lt;a class="lnlinks" href="#hl-43-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-9">&lt;a class="lnlinks" href="#hl-43-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-10">&lt;a class="lnlinks" href="#hl-43-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-11">&lt;a class="lnlinks" href="#hl-43-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-12">&lt;a class="lnlinks" href="#hl-43-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-13">&lt;a class="lnlinks" href="#hl-43-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-14">&lt;a class="lnlinks" href="#hl-43-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-15">&lt;a class="lnlinks" href="#hl-43-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-16">&lt;a class="lnlinks" href="#hl-43-16">16&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">processTask&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 将任务封装为一个 TaskProcessor，并放入集合&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Collection&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Callable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Void&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tasks&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LinkedList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">do&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Beat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">taskQueue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">poll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CONNECT_TIMEOUT_MS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TimeUnit&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">tasks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TaskProcessor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">while&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">taskQueue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tasks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NIO_THREAD_COUNT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">64&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 批量处理集合中的任务&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Future&lt;/span>&lt;span class="o">&amp;lt;?&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GlobalExecutor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">invokeAllTcpSuperSenseTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tasks&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>任务被封装到了TaskProcessor中去执行了，TaskProcessor是一个Callable，其中的call方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-44-1">&lt;a class="lnlinks" href="#hl-44-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-2">&lt;a class="lnlinks" href="#hl-44-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-3">&lt;a class="lnlinks" href="#hl-44-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-4">&lt;a class="lnlinks" href="#hl-44-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-5">&lt;a class="lnlinks" href="#hl-44-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-6">&lt;a class="lnlinks" href="#hl-44-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-7">&lt;a class="lnlinks" href="#hl-44-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-8">&lt;a class="lnlinks" href="#hl-44-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-9">&lt;a class="lnlinks" href="#hl-44-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-10">&lt;a class="lnlinks" href="#hl-44-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-11">&lt;a class="lnlinks" href="#hl-44-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-12">&lt;a class="lnlinks" href="#hl-44-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-13">&lt;a class="lnlinks" href="#hl-44-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-14">&lt;a class="lnlinks" href="#hl-44-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-15">&lt;a class="lnlinks" href="#hl-44-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-16">&lt;a class="lnlinks" href="#hl-44-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-17">&lt;a class="lnlinks" href="#hl-44-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-18">&lt;a class="lnlinks" href="#hl-44-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-19">&lt;a class="lnlinks" href="#hl-44-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-20">&lt;a class="lnlinks" href="#hl-44-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-21">&lt;a class="lnlinks" href="#hl-44-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-22">&lt;a class="lnlinks" href="#hl-44-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-23">&lt;a class="lnlinks" href="#hl-44-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-24">&lt;a class="lnlinks" href="#hl-44-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-25">&lt;a class="lnlinks" href="#hl-44-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-26">&lt;a class="lnlinks" href="#hl-44-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-27">&lt;a class="lnlinks" href="#hl-44-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-28">&lt;a class="lnlinks" href="#hl-44-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-29">&lt;a class="lnlinks" href="#hl-44-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-30">&lt;a class="lnlinks" href="#hl-44-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-31">&lt;a class="lnlinks" href="#hl-44-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-32">&lt;a class="lnlinks" href="#hl-44-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-33">&lt;a class="lnlinks" href="#hl-44-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-34">&lt;a class="lnlinks" href="#hl-44-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-35">&lt;a class="lnlinks" href="#hl-44-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-36">&lt;a class="lnlinks" href="#hl-44-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-37">&lt;a class="lnlinks" href="#hl-44-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-38">&lt;a class="lnlinks" href="#hl-44-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-39">&lt;a class="lnlinks" href="#hl-44-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-40">&lt;a class="lnlinks" href="#hl-44-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-41">&lt;a class="lnlinks" href="#hl-44-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-42">&lt;a class="lnlinks" href="#hl-44-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-43">&lt;a class="lnlinks" href="#hl-44-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-44">&lt;a class="lnlinks" href="#hl-44-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-45">&lt;a class="lnlinks" href="#hl-44-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-46">&lt;a class="lnlinks" href="#hl-44-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-47">&lt;a class="lnlinks" href="#hl-44-47">47&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">call&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取检测任务已经等待的时长&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">waited&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getStartTime&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">waited&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MAX_WAIT_TIME_MILLISECONDS&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">warn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;beat task waited too long: &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">waited&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;ms&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SocketChannel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取实例信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIp&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 通过NIO建立TCP连接&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SocketChannel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">open&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">configureBlocking&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// only by setting this can we make the socket close event asynchronous&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">socket&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">setSoLinger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">socket&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">setReuseAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">socket&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">setKeepAlive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">socket&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">setTcpNoDelay&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Cluster&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getTask&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getCluster&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">port&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isUseIPPort4Check&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPort&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cluster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getDefCkport&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">connect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InetSocketAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getIp&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">port&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 注册连接、读取事件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SelectionKey&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">register&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">selector&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SelectionKey&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">OP_CONNECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SelectionKey&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">OP_READ&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">attach&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">keyMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BeatKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setStartTime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">GlobalExecutor&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">scheduleTcpSuperSenseTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TimeOutTask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CONNECT_TIMEOUT_MS&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TimeUnit&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">beat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">finishCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">switchDomain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getTcpHealthParams&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getMax&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;tcp:error:&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMessage&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ignore&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="33总结">
&lt;a href="#33%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
3.3.总结
&lt;/h2>&lt;p>Nacos的健康检测有两种模式：&lt;/p>
&lt;ul>
&lt;li>临时实例：
&lt;ul>
&lt;li>采用客户端心跳检测模式，心跳周期5秒&lt;/li>
&lt;li>心跳间隔超过15秒则标记为不健康&lt;/li>
&lt;li>心跳间隔超过30秒则从服务列表删除&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>永久实例：
&lt;ul>
&lt;li>采用服务端主动健康检测方式&lt;/li>
&lt;li>周期为2000 + 5000毫秒内的随机数&lt;/li>
&lt;li>检测异常只会标记为不健康，不会删除&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>那么为什么Nacos有临时和永久两种实例呢？&lt;/p>
&lt;p>以淘宝为例，双十一大促期间，流量会比平常高出很多，此时服务肯定需要增加更多实例来应对高并发，而这些实例在双十一之后就无需继续使用了，采用&lt;strong>临时实例&lt;/strong>比较合适。而对于服务的一些常备实例，则使用&lt;strong>永久实例&lt;/strong>更合适。&lt;/p>
&lt;p>与eureka相比，Nacos与Eureka在临时实例上都是基于心跳模式实现，差别不大，主要是心跳周期不同，eureka是30秒，Nacos是5秒。&lt;/p>
&lt;p>另外，Nacos支持永久实例，而Eureka不支持，Eureka只提供了心跳模式的健康监测，而没有主动检测功能。&lt;/p>
&lt;h1 id="4服务发现">
&lt;a href="#4%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0" class="header-anchor">#&lt;/a>
4.服务发现
&lt;/h1>&lt;p>Nacos提供了一个根据serviceId查询实例列表的接口：&lt;/p>
&lt;p>&lt;strong>接口描述&lt;/strong>：查询服务下的实例列表&lt;/p>
&lt;p>&lt;strong>请求类型&lt;/strong>：GET&lt;/p>
&lt;p>&lt;strong>请求路径&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-45-1">&lt;a class="lnlinks" href="#hl-45-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">/nacos/v1/ns/instance/list
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>请求参数&lt;/strong>：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">名称&lt;/th>
&lt;th style="text-align:left">类型&lt;/th>
&lt;th style="text-align:left">是否必选&lt;/th>
&lt;th>描述&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">serviceName&lt;/td>
&lt;td style="text-align:left">字符串&lt;/td>
&lt;td style="text-align:left">是&lt;/td>
&lt;td>服务名&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">groupName&lt;/td>
&lt;td style="text-align:left">字符串&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>分组名&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">namespaceId&lt;/td>
&lt;td style="text-align:left">字符串&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>命名空间ID&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">clusters&lt;/td>
&lt;td style="text-align:left">字符串，多个集群用逗号分隔&lt;/td>
&lt;td style="text-align:left">否&lt;/td>
&lt;td>集群名称&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">healthyOnly&lt;/td>
&lt;td style="text-align:left">boolean&lt;/td>
&lt;td style="text-align:left">否，默认为false&lt;/td>
&lt;td>是否只返回健康实例&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;strong>错误编码&lt;/strong>：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">错误代码&lt;/th>
&lt;th style="text-align:left">描述&lt;/th>
&lt;th style="text-align:left">语义&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">400&lt;/td>
&lt;td style="text-align:left">Bad Request&lt;/td>
&lt;td style="text-align:left">客户端请求中的语法错误&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">403&lt;/td>
&lt;td style="text-align:left">Forbidden&lt;/td>
&lt;td style="text-align:left">没有权限&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">404&lt;/td>
&lt;td style="text-align:left">Not Found&lt;/td>
&lt;td style="text-align:left">无法找到资源&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">500&lt;/td>
&lt;td style="text-align:left">Internal Server Error&lt;/td>
&lt;td style="text-align:left">服务器内部错误&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">200&lt;/td>
&lt;td style="text-align:left">OK&lt;/td>
&lt;td style="text-align:left">正常&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="41客户端">
&lt;a href="#41%e5%ae%a2%e6%88%b7%e7%ab%af" class="header-anchor">#&lt;/a>
4.1.客户端
&lt;/h2>&lt;h3 id="411定时更新服务列表">
&lt;a href="#411%e5%ae%9a%e6%97%b6%e6%9b%b4%e6%96%b0%e6%9c%8d%e5%8a%a1%e5%88%97%e8%a1%a8" class="header-anchor">#&lt;/a>
4.1.1.定时更新服务列表
&lt;/h3>&lt;h4 id="4111nacosnamingservice">
&lt;a href="#4111nacosnamingservice" class="header-anchor">#&lt;/a>
4.1.1.1.NacosNamingService
&lt;/h4>&lt;p>在2.2.4小节中，我们讲到一个类&lt;code>NacosNamingService&lt;/code>，这个类不仅仅提供了服务注册功能，同样提供了服务发现的功能。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-7db35d7569165c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210923153419392"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>多个重载的方法最终都会进入一个方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-46-1">&lt;a class="lnlinks" href="#hl-46-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-2">&lt;a class="lnlinks" href="#hl-46-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-3">&lt;a class="lnlinks" href="#hl-46-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-4">&lt;a class="lnlinks" href="#hl-46-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-5">&lt;a class="lnlinks" href="#hl-46-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-6">&lt;a class="lnlinks" href="#hl-46-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-7">&lt;a class="lnlinks" href="#hl-46-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-8">&lt;a class="lnlinks" href="#hl-46-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-9">&lt;a class="lnlinks" href="#hl-46-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-10">&lt;a class="lnlinks" href="#hl-46-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-11">&lt;a class="lnlinks" href="#hl-46-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-12">&lt;a class="lnlinks" href="#hl-46-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-13">&lt;a class="lnlinks" href="#hl-46-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-14">&lt;a class="lnlinks" href="#hl-46-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-15">&lt;a class="lnlinks" href="#hl-46-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-16">&lt;a class="lnlinks" href="#hl-46-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-17">&lt;a class="lnlinks" href="#hl-46-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-18">&lt;a class="lnlinks" href="#hl-46-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-19">&lt;a class="lnlinks" href="#hl-46-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-20">&lt;a class="lnlinks" href="#hl-46-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-21">&lt;a class="lnlinks" href="#hl-46-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-22">&lt;a class="lnlinks" href="#hl-46-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-23">&lt;a class="lnlinks" href="#hl-46-23">23&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">getAllInstances&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">subscribe&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ServiceInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.判断是否需要订阅服务信息（默认为 true）&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">subscribe&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.1.订阅服务信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hostReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getServiceInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NamingUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getGroupedName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupName&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;,&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.2.直接去nacos拉取服务信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hostReactor&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getServiceInfoDirectlyFromServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NamingUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getGroupedName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">groupName&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;,&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.从服务信息中获取实例列表并返回&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">||&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CollectionUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getHosts&lt;/span>&lt;span class="p">()))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="4112hostreactor">
&lt;a href="#4112hostreactor" class="header-anchor">#&lt;/a>
4.1.1.2.HostReactor
&lt;/h4>&lt;p>进入1.1.订阅服务消息，这里是由&lt;code>HostReactor&lt;/code>类的&lt;code>getServiceInfo()&lt;/code>方法来实现的：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-47-1">&lt;a class="lnlinks" href="#hl-47-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-2">&lt;a class="lnlinks" href="#hl-47-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-3">&lt;a class="lnlinks" href="#hl-47-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-4">&lt;a class="lnlinks" href="#hl-47-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-5">&lt;a class="lnlinks" href="#hl-47-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-6">&lt;a class="lnlinks" href="#hl-47-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-7">&lt;a class="lnlinks" href="#hl-47-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-8">&lt;a class="lnlinks" href="#hl-47-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-9">&lt;a class="lnlinks" href="#hl-47-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-10">&lt;a class="lnlinks" href="#hl-47-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-11">&lt;a class="lnlinks" href="#hl-47-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-12">&lt;a class="lnlinks" href="#hl-47-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-13">&lt;a class="lnlinks" href="#hl-47-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-14">&lt;a class="lnlinks" href="#hl-47-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-15">&lt;a class="lnlinks" href="#hl-47-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-16">&lt;a class="lnlinks" href="#hl-47-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-17">&lt;a class="lnlinks" href="#hl-47-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-18">&lt;a class="lnlinks" href="#hl-47-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-19">&lt;a class="lnlinks" href="#hl-47-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-20">&lt;a class="lnlinks" href="#hl-47-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-21">&lt;a class="lnlinks" href="#hl-47-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-22">&lt;a class="lnlinks" href="#hl-47-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-23">&lt;a class="lnlinks" href="#hl-47-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-24">&lt;a class="lnlinks" href="#hl-47-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-25">&lt;a class="lnlinks" href="#hl-47-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-26">&lt;a class="lnlinks" href="#hl-47-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-27">&lt;a class="lnlinks" href="#hl-47-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-28">&lt;a class="lnlinks" href="#hl-47-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-29">&lt;a class="lnlinks" href="#hl-47-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-30">&lt;a class="lnlinks" href="#hl-47-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-31">&lt;a class="lnlinks" href="#hl-47-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-32">&lt;a class="lnlinks" href="#hl-47-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-33">&lt;a class="lnlinks" href="#hl-47-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-34">&lt;a class="lnlinks" href="#hl-47-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-35">&lt;a class="lnlinks" href="#hl-47-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-36">&lt;a class="lnlinks" href="#hl-47-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-37">&lt;a class="lnlinks" href="#hl-47-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-38">&lt;a class="lnlinks" href="#hl-47-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-39">&lt;a class="lnlinks" href="#hl-47-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-40">&lt;a class="lnlinks" href="#hl-47-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-41">&lt;a class="lnlinks" href="#hl-47-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-47-42">&lt;a class="lnlinks" href="#hl-47-42">42&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ServiceInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">getServiceInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NAMING_LOGGER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failover-mode: &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">failoverReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isFailoverSwitch&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 由 服务名@@集群名拼接 key&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ServiceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">failoverReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isFailoverSwitch&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">failoverReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 读取本地服务列表的缓存，缓存是一个Map，格式：Map&amp;lt;String, ServiceInfo&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ServiceInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceObj&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getServiceInfo0&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断缓存是否存在&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceObj&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 不存在，创建空ServiceInfo&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceObj&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ServiceInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放入缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfoMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceObj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceObj&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放入待更新的服务列表（updatingMap）中&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">updatingMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 立即更新服务列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">updateServiceNow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 从待更新列表中移除&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">updatingMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">updatingMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">containsKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 缓存中有，但是需要更新&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">UPDATE_HOLD_INTERVAL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// hold a moment waiting for update finish 等待5秒中，待更新完成&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">synchronized&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceObj&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceObj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">UPDATE_HOLD_INTERVAL&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NAMING_LOGGER&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[getServiceInfo] serviceName:&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;, clusters:&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 开启定时更新服务列表的功能&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">scheduleUpdateIfAbsent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 返回缓存中的服务信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfoMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceObj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>基本逻辑就是先从本地缓存读，根据结果来选择：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>如果本地缓存没有，立即去nacos读取，&lt;code>updateServiceNow(serviceName, clusters)&lt;/code>&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-5388076a8ce0fd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210923161528710"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;/li>
&lt;li>
&lt;p>如果本地缓存有，则开启定时更新功能，并返回缓存结果：&lt;/p>
&lt;ul>
&lt;li>&lt;code>scheduleUpdateIfAbsent(serviceName, clusters)&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-6bfc165a2c46f2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210923161630575"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在UpdateTask中，最终还是调用updateService方法：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-d582eb7ffbfb6e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210923161752521"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>不管是立即更新服务列表，还是定时更新服务列表，最终都会执行HostReactor中的updateService()方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-48-1">&lt;a class="lnlinks" href="#hl-48-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-2">&lt;a class="lnlinks" href="#hl-48-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-3">&lt;a class="lnlinks" href="#hl-48-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-4">&lt;a class="lnlinks" href="#hl-48-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-5">&lt;a class="lnlinks" href="#hl-48-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-6">&lt;a class="lnlinks" href="#hl-48-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-7">&lt;a class="lnlinks" href="#hl-48-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-8">&lt;a class="lnlinks" href="#hl-48-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-9">&lt;a class="lnlinks" href="#hl-48-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-10">&lt;a class="lnlinks" href="#hl-48-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-11">&lt;a class="lnlinks" href="#hl-48-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-12">&lt;a class="lnlinks" href="#hl-48-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-13">&lt;a class="lnlinks" href="#hl-48-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-14">&lt;a class="lnlinks" href="#hl-48-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-15">&lt;a class="lnlinks" href="#hl-48-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-16">&lt;a class="lnlinks" href="#hl-48-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-17">&lt;a class="lnlinks" href="#hl-48-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-48-18">&lt;a class="lnlinks" href="#hl-48-18">18&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">updateService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ServiceInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getServiceInfo0&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 基于ServerProxy发起远程调用，查询服务列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serverProxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">queryList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pushReceiver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getUdpPort&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isNotEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 处理查询结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">processServiceJson&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">finally&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">oldService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">synchronized&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">oldService&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">oldService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">notifyAll&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="4113serverproxy">
&lt;a href="#4113serverproxy" class="header-anchor">#&lt;/a>
4.1.1.3.ServerProxy
&lt;/h4>&lt;p>而ServerProxy的queryList方法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-49-1">&lt;a class="lnlinks" href="#hl-49-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-2">&lt;a class="lnlinks" href="#hl-49-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-3">&lt;a class="lnlinks" href="#hl-49-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-4">&lt;a class="lnlinks" href="#hl-49-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-5">&lt;a class="lnlinks" href="#hl-49-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-6">&lt;a class="lnlinks" href="#hl-49-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-7">&lt;a class="lnlinks" href="#hl-49-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-8">&lt;a class="lnlinks" href="#hl-49-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-9">&lt;a class="lnlinks" href="#hl-49-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-10">&lt;a class="lnlinks" href="#hl-49-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-11">&lt;a class="lnlinks" href="#hl-49-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-12">&lt;a class="lnlinks" href="#hl-49-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-49-13">&lt;a class="lnlinks" href="#hl-49-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">queryList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">udpPort&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">healthyOnly&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NacosException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 准备请求参数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">8&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">NAMESPACE_ID&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SERVICE_NAME&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;clusters&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;udpPort&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">valueOf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">udpPort&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;clientIP&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NetUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">localIP&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;healthyOnly&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">valueOf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">healthyOnly&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发起请求，地址与API接口一致&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">reqApi&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">UtilAndComs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">nacosUrlBase&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;/instance/list&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HttpMethod&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">GET&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="412处理服务变更通知">
&lt;a href="#412%e5%a4%84%e7%90%86%e6%9c%8d%e5%8a%a1%e5%8f%98%e6%9b%b4%e9%80%9a%e7%9f%a5" class="header-anchor">#&lt;/a>
4.1.2.处理服务变更通知
&lt;/h3>&lt;p>除了定时更新服务列表的功能外，Nacos还支持服务列表变更时的主动推送功能。&lt;/p>
&lt;p>在HostReactor类的构造函数中，有非常重要的几个步骤：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-017a14a14c1361.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210923164145915"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>基本思路是：&lt;/p>
&lt;ul>
&lt;li>通过PushReceiver监听服务端推送的变更数据&lt;/li>
&lt;li>解析数据后，通过NotifyCenter发布服务变更的事件&lt;/li>
&lt;li>InstanceChangeNotifier监听变更事件，完成对服务列表的更新&lt;/li>
&lt;/ul>
&lt;h4 id="4121pushreceiver">
&lt;a href="#4121pushreceiver" class="header-anchor">#&lt;/a>
4.1.2.1.PushReceiver
&lt;/h4>&lt;p>我们先看PushReceiver，这个类会以UDP方式接收Nacos服务端推送的服务变更数据。&lt;/p>
&lt;p>先看构造函数：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-50-1">&lt;a class="lnlinks" href="#hl-50-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-2">&lt;a class="lnlinks" href="#hl-50-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-3">&lt;a class="lnlinks" href="#hl-50-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-4">&lt;a class="lnlinks" href="#hl-50-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-5">&lt;a class="lnlinks" href="#hl-50-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-6">&lt;a class="lnlinks" href="#hl-50-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-7">&lt;a class="lnlinks" href="#hl-50-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-8">&lt;a class="lnlinks" href="#hl-50-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-9">&lt;a class="lnlinks" href="#hl-50-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-10">&lt;a class="lnlinks" href="#hl-50-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-11">&lt;a class="lnlinks" href="#hl-50-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-12">&lt;a class="lnlinks" href="#hl-50-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-13">&lt;a class="lnlinks" href="#hl-50-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-14">&lt;a class="lnlinks" href="#hl-50-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-15">&lt;a class="lnlinks" href="#hl-50-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-16">&lt;a class="lnlinks" href="#hl-50-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-17">&lt;a class="lnlinks" href="#hl-50-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-18">&lt;a class="lnlinks" href="#hl-50-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-19">&lt;a class="lnlinks" href="#hl-50-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-20">&lt;a class="lnlinks" href="#hl-50-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-21">&lt;a class="lnlinks" href="#hl-50-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-22">&lt;a class="lnlinks" href="#hl-50-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-23">&lt;a class="lnlinks" href="#hl-50-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-24">&lt;a class="lnlinks" href="#hl-50-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-25">&lt;a class="lnlinks" href="#hl-50-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-50-26">&lt;a class="lnlinks" href="#hl-50-26">26&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">PushReceiver&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HostReactor&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hostReactor&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">hostReactor&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hostReactor&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建 UDP客户端&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">udpPort&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getPushReceiverUdpPort&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">udpPort&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">udpSocket&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DatagramSocket&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">udpSocket&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DatagramSocket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InetSocketAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">parseInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">udpPort&lt;/span>&lt;span class="p">)));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 准备线程池&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">executorService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ScheduledThreadPoolExecutor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ThreadFactory&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">newThread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Runnable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">thread&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">thread&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setDaemon&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">thread&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;com.alibaba.nacos.naming.push.receiver&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">thread&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">});&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 开启线程任务，准备接收变更数据&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">executorService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NAMING_LOGGER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[NA] init udp socket failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>PushReceiver构造函数中基于线程池来运行任务。这是因为PushReceiver本身也是一个Runnable，其中的run方法业务逻辑如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-51-1">&lt;a class="lnlinks" href="#hl-51-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-2">&lt;a class="lnlinks" href="#hl-51-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-3">&lt;a class="lnlinks" href="#hl-51-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-4">&lt;a class="lnlinks" href="#hl-51-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-5">&lt;a class="lnlinks" href="#hl-51-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-6">&lt;a class="lnlinks" href="#hl-51-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-7">&lt;a class="lnlinks" href="#hl-51-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-8">&lt;a class="lnlinks" href="#hl-51-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-9">&lt;a class="lnlinks" href="#hl-51-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-10">&lt;a class="lnlinks" href="#hl-51-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-11">&lt;a class="lnlinks" href="#hl-51-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-12">&lt;a class="lnlinks" href="#hl-51-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-13">&lt;a class="lnlinks" href="#hl-51-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-14">&lt;a class="lnlinks" href="#hl-51-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-15">&lt;a class="lnlinks" href="#hl-51-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-16">&lt;a class="lnlinks" href="#hl-51-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-17">&lt;a class="lnlinks" href="#hl-51-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-18">&lt;a class="lnlinks" href="#hl-51-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-19">&lt;a class="lnlinks" href="#hl-51-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-20">&lt;a class="lnlinks" href="#hl-51-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-21">&lt;a class="lnlinks" href="#hl-51-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-22">&lt;a class="lnlinks" href="#hl-51-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-23">&lt;a class="lnlinks" href="#hl-51-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-24">&lt;a class="lnlinks" href="#hl-51-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-25">&lt;a class="lnlinks" href="#hl-51-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-26">&lt;a class="lnlinks" href="#hl-51-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-27">&lt;a class="lnlinks" href="#hl-51-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-51-28">&lt;a class="lnlinks" href="#hl-51-28">28&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">run&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">while&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">closed&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// byte[] is initialized with 0 full filled by default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">UDP_MSS&lt;/span>&lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">DatagramPacket&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">packet&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DatagramPacket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 接收推送数据&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">udpSocket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">receive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packet&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 解析为json字符串&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IoUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">tryDecompress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packet&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getData&lt;/span>&lt;span class="p">()),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UTF_8&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">trim&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NAMING_LOGGER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;received push data: &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; from &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">packet&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getAddress&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 反序列化为对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">PushPacket&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pushPacket&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toObj&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PushPacket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ack&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dom&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pushPacket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">type&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">||&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;service&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pushPacket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">type&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 交给 HostReactor去处理&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">hostReactor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">processServiceJson&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pushPacket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">data&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// send ack to server 发送ACK回执，略。。&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">closed&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NAMING_LOGGER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[NA] error while receiving push data&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="4122hostreactor">
&lt;a href="#4122hostreactor" class="header-anchor">#&lt;/a>
4.1.2.2.HostReactor
&lt;/h4>&lt;p>通知数据的处理由交给了&lt;code>HostReactor&lt;/code>的&lt;code>processServiceJson&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-52-1">&lt;a class="lnlinks" href="#hl-52-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-2">&lt;a class="lnlinks" href="#hl-52-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-3">&lt;a class="lnlinks" href="#hl-52-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-4">&lt;a class="lnlinks" href="#hl-52-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-5">&lt;a class="lnlinks" href="#hl-52-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-6">&lt;a class="lnlinks" href="#hl-52-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-7">&lt;a class="lnlinks" href="#hl-52-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-8">&lt;a class="lnlinks" href="#hl-52-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-9">&lt;a class="lnlinks" href="#hl-52-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-10">&lt;a class="lnlinks" href="#hl-52-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-11">&lt;a class="lnlinks" href="#hl-52-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-12">&lt;a class="lnlinks" href="#hl-52-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-13">&lt;a class="lnlinks" href="#hl-52-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-14">&lt;a class="lnlinks" href="#hl-52-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-15">&lt;a class="lnlinks" href="#hl-52-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-16">&lt;a class="lnlinks" href="#hl-52-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-17">&lt;a class="lnlinks" href="#hl-52-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-18">&lt;a class="lnlinks" href="#hl-52-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-19">&lt;a class="lnlinks" href="#hl-52-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-20">&lt;a class="lnlinks" href="#hl-52-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-21">&lt;a class="lnlinks" href="#hl-52-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-22">&lt;a class="lnlinks" href="#hl-52-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-23">&lt;a class="lnlinks" href="#hl-52-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-24">&lt;a class="lnlinks" href="#hl-52-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-25">&lt;a class="lnlinks" href="#hl-52-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-26">&lt;a class="lnlinks" href="#hl-52-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-27">&lt;a class="lnlinks" href="#hl-52-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-28">&lt;a class="lnlinks" href="#hl-52-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-29">&lt;a class="lnlinks" href="#hl-52-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-30">&lt;a class="lnlinks" href="#hl-52-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-31">&lt;a class="lnlinks" href="#hl-52-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-32">&lt;a class="lnlinks" href="#hl-52-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-33">&lt;a class="lnlinks" href="#hl-52-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-34">&lt;a class="lnlinks" href="#hl-52-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-35">&lt;a class="lnlinks" href="#hl-52-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-36">&lt;a class="lnlinks" href="#hl-52-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-37">&lt;a class="lnlinks" href="#hl-52-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-38">&lt;a class="lnlinks" href="#hl-52-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-39">&lt;a class="lnlinks" href="#hl-52-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-40">&lt;a class="lnlinks" href="#hl-52-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-41">&lt;a class="lnlinks" href="#hl-52-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-42">&lt;a class="lnlinks" href="#hl-52-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-43">&lt;a class="lnlinks" href="#hl-52-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-44">&lt;a class="lnlinks" href="#hl-52-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-45">&lt;a class="lnlinks" href="#hl-52-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-52-46">&lt;a class="lnlinks" href="#hl-52-46">46&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ServiceInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">processServiceJson&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 解析出ServiceInfo信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ServiceInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toObj&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ServiceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceKey&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceKey&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 查询缓存中的 ServiceInfo&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ServiceInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfoMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceKey&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果缓存存在，则需要校验哪些数据要更新&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">changed&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">oldService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 拉取的数据是否已经过期&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">oldService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLastRefTime&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLastRefTime&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NAMING_LOGGER&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">warn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;out of date data received, old-t: &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLastRefTime&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;, new-t: &amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLastRefTime&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放入缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfoMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 中间是缓存与新数据的对比，得到newHosts：新增的实例；remvHosts：待移除的实例;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// modHosts：需要修改的实例&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">newHosts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">||&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">remvHosts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">||&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">modHosts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发布实例变更的事件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NotifyCenter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">publishEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InstancesChangeEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getGroupName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusters&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getHosts&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">DiskCache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cacheDir&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 本地缓存不存在&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">changed&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放入缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfoMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 直接发布实例变更的事件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NotifyCenter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">publishEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InstancesChangeEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getGroupName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusters&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getHosts&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setJsonFromServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">DiskCache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cacheDir&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 。。。&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceInfo&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="42服务端">
&lt;a href="#42%e6%9c%8d%e5%8a%a1%e7%ab%af" class="header-anchor">#&lt;/a>
4.2.服务端
&lt;/h2>&lt;h3 id="421拉取服务列表接口">
&lt;a href="#421%e6%8b%89%e5%8f%96%e6%9c%8d%e5%8a%a1%e5%88%97%e8%a1%a8%e6%8e%a5%e5%8f%a3" class="header-anchor">#&lt;/a>
4.2.1.拉取服务列表接口
&lt;/h3>&lt;p>在2.3.1小节介绍的InstanceController中，提供了拉取服务列表的接口：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-53-1">&lt;a class="lnlinks" href="#hl-53-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-2">&lt;a class="lnlinks" href="#hl-53-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-3">&lt;a class="lnlinks" href="#hl-53-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-4">&lt;a class="lnlinks" href="#hl-53-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-5">&lt;a class="lnlinks" href="#hl-53-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-6">&lt;a class="lnlinks" href="#hl-53-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-7">&lt;a class="lnlinks" href="#hl-53-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-8">&lt;a class="lnlinks" href="#hl-53-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-9">&lt;a class="lnlinks" href="#hl-53-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-10">&lt;a class="lnlinks" href="#hl-53-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-11">&lt;a class="lnlinks" href="#hl-53-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-12">&lt;a class="lnlinks" href="#hl-53-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-13">&lt;a class="lnlinks" href="#hl-53-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-14">&lt;a class="lnlinks" href="#hl-53-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-15">&lt;a class="lnlinks" href="#hl-53-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-16">&lt;a class="lnlinks" href="#hl-53-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-17">&lt;a class="lnlinks" href="#hl-53-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-18">&lt;a class="lnlinks" href="#hl-53-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-19">&lt;a class="lnlinks" href="#hl-53-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-20">&lt;a class="lnlinks" href="#hl-53-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-21">&lt;a class="lnlinks" href="#hl-53-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-22">&lt;a class="lnlinks" href="#hl-53-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-23">&lt;a class="lnlinks" href="#hl-53-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-24">&lt;a class="lnlinks" href="#hl-53-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-25">&lt;a class="lnlinks" href="#hl-53-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-26">&lt;a class="lnlinks" href="#hl-53-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-27">&lt;a class="lnlinks" href="#hl-53-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-28">&lt;a class="lnlinks" href="#hl-53-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-29">&lt;a class="lnlinks" href="#hl-53-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-30">&lt;a class="lnlinks" href="#hl-53-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-31">&lt;a class="lnlinks" href="#hl-53-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-32">&lt;a class="lnlinks" href="#hl-53-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-53-33">&lt;a class="lnlinks" href="#hl-53-33">33&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * Get all instance of input service.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param request http request
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @return list of instance
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @throws Exception any error during list
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@GetMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/list&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Secured&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">parser&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NamingResourceParser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ActionTypes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">READ&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ObjectNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 从request中获取namespaceId和serviceName&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">NAMESPACE_ID&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT_NAMESPACE_ID&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">required&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CommonParams&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SERVICE_NAME&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">NamingUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">checkServiceNameFormat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">agent&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getUserAgent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;clusters&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EMPTY&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientIP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;clientIP&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EMPTY&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取客户端的 UDP端口&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">udpPort&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">parseInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;udpPort&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;0&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">env&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;env&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EMPTY&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">isCheck&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Boolean&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">parseBoolean&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;isCheck&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;app&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EMPTY&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tenant&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;tid&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">EMPTY&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">healthyOnly&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Boolean&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">parseBoolean&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">WebUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;healthyOnly&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;false&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取服务列表&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">doSrvIpxt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">agent&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientIP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">udpPort&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">env&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">isCheck&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tenant&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">healthyOnly&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>进入&lt;code>doSrvIpxt()&lt;/code>方法来获取服务列表：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-54-1">&lt;a class="lnlinks" href="#hl-54-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-2">&lt;a class="lnlinks" href="#hl-54-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-3">&lt;a class="lnlinks" href="#hl-54-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-4">&lt;a class="lnlinks" href="#hl-54-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-5">&lt;a class="lnlinks" href="#hl-54-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-6">&lt;a class="lnlinks" href="#hl-54-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-7">&lt;a class="lnlinks" href="#hl-54-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-8">&lt;a class="lnlinks" href="#hl-54-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-9">&lt;a class="lnlinks" href="#hl-54-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-10">&lt;a class="lnlinks" href="#hl-54-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-11">&lt;a class="lnlinks" href="#hl-54-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-12">&lt;a class="lnlinks" href="#hl-54-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-13">&lt;a class="lnlinks" href="#hl-54-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-14">&lt;a class="lnlinks" href="#hl-54-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-15">&lt;a class="lnlinks" href="#hl-54-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-16">&lt;a class="lnlinks" href="#hl-54-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-17">&lt;a class="lnlinks" href="#hl-54-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-18">&lt;a class="lnlinks" href="#hl-54-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-19">&lt;a class="lnlinks" href="#hl-54-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-20">&lt;a class="lnlinks" href="#hl-54-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-21">&lt;a class="lnlinks" href="#hl-54-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-22">&lt;a class="lnlinks" href="#hl-54-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-23">&lt;a class="lnlinks" href="#hl-54-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-24">&lt;a class="lnlinks" href="#hl-54-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-25">&lt;a class="lnlinks" href="#hl-54-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-26">&lt;a class="lnlinks" href="#hl-54-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-27">&lt;a class="lnlinks" href="#hl-54-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-28">&lt;a class="lnlinks" href="#hl-54-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-29">&lt;a class="lnlinks" href="#hl-54-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-30">&lt;a class="lnlinks" href="#hl-54-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-31">&lt;a class="lnlinks" href="#hl-54-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-32">&lt;a class="lnlinks" href="#hl-54-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-33">&lt;a class="lnlinks" href="#hl-54-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-34">&lt;a class="lnlinks" href="#hl-54-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-35">&lt;a class="lnlinks" href="#hl-54-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-36">&lt;a class="lnlinks" href="#hl-54-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-37">&lt;a class="lnlinks" href="#hl-54-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-38">&lt;a class="lnlinks" href="#hl-54-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-39">&lt;a class="lnlinks" href="#hl-54-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-40">&lt;a class="lnlinks" href="#hl-54-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-41">&lt;a class="lnlinks" href="#hl-54-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-42">&lt;a class="lnlinks" href="#hl-54-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-43">&lt;a class="lnlinks" href="#hl-54-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-44">&lt;a class="lnlinks" href="#hl-54-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-45">&lt;a class="lnlinks" href="#hl-54-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-46">&lt;a class="lnlinks" href="#hl-54-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-47">&lt;a class="lnlinks" href="#hl-54-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-48">&lt;a class="lnlinks" href="#hl-54-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-49">&lt;a class="lnlinks" href="#hl-54-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-50">&lt;a class="lnlinks" href="#hl-54-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-51">&lt;a class="lnlinks" href="#hl-54-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-52">&lt;a class="lnlinks" href="#hl-54-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-53">&lt;a class="lnlinks" href="#hl-54-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-54">&lt;a class="lnlinks" href="#hl-54-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-55">&lt;a class="lnlinks" href="#hl-54-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-54-56">&lt;a class="lnlinks" href="#hl-54-56">56&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ObjectNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">doSrvIpxt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">agent&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientIP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">udpPort&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">env&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">isCheck&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">healthyOnly&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ClientInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientInfo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ClientInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">agent&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ObjectNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">createEmptyJsonNode&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取服务列表信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceManager&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cacheMillis&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">switchDomain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getDefaultCacheMillis&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// now try to enable the push&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">udpPort&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pushService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">canEnablePush&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">agent&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 添加当前客户端 IP、UDP端口到 PushService 中&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">pushService&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">agent&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InetSocketAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientIP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">udpPort&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">pushDataSource&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">cacheMillis&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">switchDomain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPushCacheMillis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[NACOS-API] failed to added push client {}, {}:{}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientInfo&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientIP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">udpPort&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">cacheMillis&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">switchDomain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getDefaultCacheMillis&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果没找到，返回空&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isDebugEnabled&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Loggers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">SRV_LOG&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;no instance to serve for service: {}&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;clusters&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;cacheMillis&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cacheMillis&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hosts&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">createEmptyArrayNode&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 结果的检测，异常实例的剔除等逻辑省略&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 最终封装结果并返回 。。。&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hosts&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hosts&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ClientInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ClientType&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">JAVA&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clientInfo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">version&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">compareTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">VersionUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">parseVersion&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;1.0.0&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dom&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dom&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NamingUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getServiceName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;cacheMillis&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cacheMillis&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;lastRefTime&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;checksum&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getChecksum&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;useSpecifiedURL&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;clusters&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;env&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">env&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;metadata&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JacksonUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">transferToJsonNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMetadata&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="422发布服务变更的udp通知">
&lt;a href="#422%e5%8f%91%e5%b8%83%e6%9c%8d%e5%8a%a1%e5%8f%98%e6%9b%b4%e7%9a%84udp%e9%80%9a%e7%9f%a5" class="header-anchor">#&lt;/a>
4.2.2.发布服务变更的UDP通知
&lt;/h3>&lt;p>在上一节中，&lt;code>InstanceController&lt;/code>中的&lt;code>doSrvIpxt()&lt;/code>方法中，有这样一行代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-55-1">&lt;a class="lnlinks" href="#hl-55-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-2">&lt;a class="lnlinks" href="#hl-55-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-55-3">&lt;a class="lnlinks" href="#hl-55-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">pushService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">namespaceId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">serviceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusters&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">agent&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InetSocketAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clientIP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">udpPort&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">pushDataSource&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其实是把消费者的UDP端口、IP等信息封装为一个PushClient对象，存储PushService中。方便以后服务变更后推送消息。&lt;/p>
&lt;p>PushService类本身实现了&lt;code>ApplicationListener&lt;/code>接口：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-00dad1fdffa69c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210923182429636"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这个是事件监听器接口，监听的是ServiceChangeEvent（服务变更事件）。&lt;/p>
&lt;p>当服务列表变化时，就会通知我们：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739078-962cb3da381185.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210923183017424"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="43总结">
&lt;a href="#43%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
4.3.总结
&lt;/h2>&lt;p>Nacos的服务发现分为两种模式：&lt;/p>
&lt;ul>
&lt;li>模式一：主动拉取模式，消费者定期主动从Nacos拉取服务列表并缓存起来，再服务调用时优先读取本地缓存中的服务列表。&lt;/li>
&lt;li>模式二：订阅模式，消费者订阅Nacos中的服务列表，并基于UDP协议来接收服务变更通知。当Nacos中的服务列表更新时，会发送UDP广播给所有订阅者。&lt;/li>
&lt;/ul>
&lt;p>与Eureka相比，Nacos的订阅模式服务状态更新更及时，消费者更容易及时发现服务列表的变化，剔除故障服务。&lt;/p></description></item><item><title>14.Sentinel源码分析</title><link>https://logan.wssw.fun/p/2023/01/15713815/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/15713815/</guid><description>&lt;h1 id="sentinel源码分析">
&lt;a href="#sentinel%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" class="header-anchor">#&lt;/a>
Sentinel源码分析
&lt;/h1>&lt;h1 id="1sentinel的基本概念">
&lt;a href="#1sentinel%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" class="header-anchor">#&lt;/a>
1.Sentinel的基本概念
&lt;/h1>&lt;p>Sentinel实现限流、隔离、降级、熔断等功能，本质要做的就是两件事情：&lt;/p>
&lt;ul>
&lt;li>统计数据：统计某个资源的访问数据（QPS、RT等信息）&lt;/li>
&lt;li>规则判断：判断限流规则、隔离规则、降级规则、熔断规则是否满足&lt;/li>
&lt;/ul>
&lt;p>这里的&lt;strong>资源&lt;/strong>就是希望被Sentinel保护的业务，例如项目中定义的controller方法就是默认被Sentinel保护的资源。&lt;/p>
&lt;h2 id="11processorslotchain">
&lt;a href="#11processorslotchain" class="header-anchor">#&lt;/a>
1.1.ProcessorSlotChain
&lt;/h2>&lt;p>实现上述功能的核心骨架是一个叫做ProcessorSlotChain的类。这个类基于责任链模式来设计，将不同的功能（限流、降级、系统保护）封装为一个个的Slot，请求进入后逐个执行即可。&lt;/p>
&lt;p>其工作流如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-a5790797c7a075.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925092845529"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>责任链中的Slot也分为两大类：&lt;/p>
&lt;ul>
&lt;li>统计数据构建部分（statistic）
&lt;ul>
&lt;li>NodeSelectorSlot：负责构建簇点链路中的节点（DefaultNode），将这些节点形成链路树&lt;/li>
&lt;li>ClusterBuilderSlot：负责构建某个资源的ClusterNode，ClusterNode可以保存资源的运行信息（响应时间、QPS、block 数目、线程数、异常数等）以及来源信息（origin名称）&lt;/li>
&lt;li>StatisticSlot：负责统计实时调用数据，包括运行信息、来源信息等&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>规则判断部分（rule checking）
&lt;ul>
&lt;li>AuthoritySlot：负责授权规则（来源控制）&lt;/li>
&lt;li>SystemSlot：负责系统保护规则&lt;/li>
&lt;li>ParamFlowSlot：负责热点参数限流规则&lt;/li>
&lt;li>FlowSlot：负责限流规则&lt;/li>
&lt;li>DegradeSlot：负责降级规则&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="12node">
&lt;a href="#12node" class="header-anchor">#&lt;/a>
1.2.Node
&lt;/h2>&lt;p>Sentinel中的簇点链路是由一个个的Node组成的，Node是一个接口，包括下面的实现：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-0a4a6c7bfbbd6f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925103029924"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>所有的节点都可以记录对资源的访问统计数据，所以都是StatisticNode的子类。&lt;/p>
&lt;p>按照作用分为两类Node：&lt;/p>
&lt;ul>
&lt;li>DefaultNode：代表链路树中的每一个资源，一个资源出现在不同链路中时，会创建不同的DefaultNode节点。而树的入口节点叫EntranceNode，是一种特殊的DefaultNode&lt;/li>
&lt;li>ClusterNode：代表资源，一个资源不管出现在多少链路中，只会有一个ClusterNode。记录的是当前资源被访问的所有统计数据之和。&lt;/li>
&lt;/ul>
&lt;p>DefaultNode记录的是资源在当前链路中的访问数据，用来实现基于链路模式的限流规则。ClusterNode记录的是资源在所有链路中的访问数据，实现默认模式、关联模式的限流规则。&lt;/p>
&lt;p>例如：我们在一个SpringMVC项目中，有两个业务：&lt;/p>
&lt;ul>
&lt;li>业务1：controller中的资源&lt;code>/order/query&lt;/code>访问了service中的资源&lt;code>/goods&lt;/code>&lt;/li>
&lt;li>业务2：controller中的资源&lt;code>/order/save&lt;/code>访问了service中的资源&lt;code>/goods&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>创建的链路图如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-a91856c22d0868.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925104726158"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="13entry">
&lt;a href="#13entry" class="header-anchor">#&lt;/a>
1.3.Entry
&lt;/h2>&lt;p>默认情况下，Sentinel会将controller中的方法作为被保护资源，那么问题来了，我们该如何将自己的一段代码标记为一个Sentinel的资源呢？&lt;/p>
&lt;p>Sentinel中的资源用Entry来表示。声明Entry的API示例：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-6">&lt;a class="lnlinks" href="#hl-0-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-7">&lt;a class="lnlinks" href="#hl-0-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-8">&lt;a class="lnlinks" href="#hl-0-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 资源名可使用任意有业务语义的字符串，比如方法名、接口名或其它可唯一标识的字符串。&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SphU&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;resourceName&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 被保护的业务逻辑&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// do something here...&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 资源访问阻止，被限流或被降级&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 在此处进行相应的处理操作&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="131自定义资源">
&lt;a href="#131%e8%87%aa%e5%ae%9a%e4%b9%89%e8%b5%84%e6%ba%90" class="header-anchor">#&lt;/a>
1.3.1.自定义资源
&lt;/h3>&lt;p>例如，我们在order-service服务中，将&lt;code>OrderService&lt;/code>的&lt;code>queryOrderById()&lt;/code>方法标记为一个资源。&lt;/p>
&lt;p>1）首先在order-service中引入sentinel依赖&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!--sentinel--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.alibaba.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-alibaba-sentinel&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）然后配置Sentinel地址&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">sentinel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">transport&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dashboard&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost:8089&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 这里我的sentinel用了8089的端口&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）修改OrderService类的queryOrderById方法&lt;/p>
&lt;p>代码这样来实现：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-7">&lt;a class="lnlinks" href="#hl-3-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-8">&lt;a class="lnlinks" href="#hl-3-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-9">&lt;a class="lnlinks" href="#hl-3-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-10">&lt;a class="lnlinks" href="#hl-3-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-11">&lt;a class="lnlinks" href="#hl-3-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-12">&lt;a class="lnlinks" href="#hl-3-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-13">&lt;a class="lnlinks" href="#hl-3-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-14">&lt;a class="lnlinks" href="#hl-3-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-15">&lt;a class="lnlinks" href="#hl-3-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-16">&lt;a class="lnlinks" href="#hl-3-16">16&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Order&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">queryOrderById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">orderId&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建Entry，标记资源，资源名为resource1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SphU&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;resource1&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.查询订单，这里是假数据&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Order&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">order&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Order&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">101L&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">4999L&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;小米 MIX4&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1L&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.查询用户，基于Feign的远程调用&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">User&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">userClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">findById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">order&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getUserId&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.设置&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">order&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setUser&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.返回&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">order&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;被限流或降级&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4）访问&lt;/p>
&lt;p>打开浏览器，访问order服务：http://localhost:8080/order/101&lt;/p>
&lt;p>然后打开sentinel控制台，查看簇点链路：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-e828a3a5de957e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925113122759"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="132基于注解标记资源">
&lt;a href="#132%e5%9f%ba%e4%ba%8e%e6%b3%a8%e8%a7%a3%e6%a0%87%e8%ae%b0%e8%b5%84%e6%ba%90" class="header-anchor">#&lt;/a>
1.3.2.基于注解标记资源
&lt;/h3>&lt;p>在之前学习Sentinel的时候，我们知道可以通过给方法添加@SentinelResource注解的形式来标记资源。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-fa8a9641f25bff.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925141507603"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这个是怎么实现的呢？&lt;/p>
&lt;p>来看下我们引入的Sentinel依赖包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-c6f1e9f589e3dd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925115601560"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的spring.factories声明需要就是自动装配的配置类，内容如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-fb46bf87e95451.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925115740281"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们来看下&lt;code>SentinelAutoConfiguration&lt;/code>这个类：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-0b4a15fa62e684.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925141553785"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，在这里声明了一个Bean，&lt;code>SentinelResourceAspect&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-5">&lt;a class="lnlinks" href="#hl-4-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-6">&lt;a class="lnlinks" href="#hl-4-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-7">&lt;a class="lnlinks" href="#hl-4-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-8">&lt;a class="lnlinks" href="#hl-4-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-9">&lt;a class="lnlinks" href="#hl-4-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-10">&lt;a class="lnlinks" href="#hl-4-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-11">&lt;a class="lnlinks" href="#hl-4-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-12">&lt;a class="lnlinks" href="#hl-4-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-13">&lt;a class="lnlinks" href="#hl-4-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-14">&lt;a class="lnlinks" href="#hl-4-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-15">&lt;a class="lnlinks" href="#hl-4-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-16">&lt;a class="lnlinks" href="#hl-4-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-17">&lt;a class="lnlinks" href="#hl-4-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-18">&lt;a class="lnlinks" href="#hl-4-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-19">&lt;a class="lnlinks" href="#hl-4-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-20">&lt;a class="lnlinks" href="#hl-4-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-21">&lt;a class="lnlinks" href="#hl-4-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-22">&lt;a class="lnlinks" href="#hl-4-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-23">&lt;a class="lnlinks" href="#hl-4-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-24">&lt;a class="lnlinks" href="#hl-4-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-25">&lt;a class="lnlinks" href="#hl-4-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-26">&lt;a class="lnlinks" href="#hl-4-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-27">&lt;a class="lnlinks" href="#hl-4-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-28">&lt;a class="lnlinks" href="#hl-4-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-29">&lt;a class="lnlinks" href="#hl-4-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-30">&lt;a class="lnlinks" href="#hl-4-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-31">&lt;a class="lnlinks" href="#hl-4-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-32">&lt;a class="lnlinks" href="#hl-4-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-33">&lt;a class="lnlinks" href="#hl-4-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-34">&lt;a class="lnlinks" href="#hl-4-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-35">&lt;a class="lnlinks" href="#hl-4-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-36">&lt;a class="lnlinks" href="#hl-4-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-37">&lt;a class="lnlinks" href="#hl-4-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-38">&lt;a class="lnlinks" href="#hl-4-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-39">&lt;a class="lnlinks" href="#hl-4-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-40">&lt;a class="lnlinks" href="#hl-4-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-41">&lt;a class="lnlinks" href="#hl-4-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-42">&lt;a class="lnlinks" href="#hl-4-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-43">&lt;a class="lnlinks" href="#hl-4-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-44">&lt;a class="lnlinks" href="#hl-4-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-45">&lt;a class="lnlinks" href="#hl-4-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-46">&lt;a class="lnlinks" href="#hl-4-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-47">&lt;a class="lnlinks" href="#hl-4-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-48">&lt;a class="lnlinks" href="#hl-4-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-49">&lt;a class="lnlinks" href="#hl-4-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-50">&lt;a class="lnlinks" href="#hl-4-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-51">&lt;a class="lnlinks" href="#hl-4-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-52">&lt;a class="lnlinks" href="#hl-4-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-53">&lt;a class="lnlinks" href="#hl-4-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-54">&lt;a class="lnlinks" href="#hl-4-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-55">&lt;a class="lnlinks" href="#hl-4-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-56">&lt;a class="lnlinks" href="#hl-4-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-57">&lt;a class="lnlinks" href="#hl-4-57">57&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * Aspect for methods with {@link SentinelResource} annotation.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @author Eric Zhao
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Aspect&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">SentinelResourceAspect&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">extends&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AbstractSentinelAspectSupport&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 切点是添加了 @SentinelResource注解的类&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Pointcut&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;@annotation(com.alibaba.csp.sentinel.annotation.SentinelResource)&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">sentinelResourceAnnotationPointcut&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 环绕增强&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Around&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sentinelResourceAnnotationPointcut()&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">invokeResourceWithSentinel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ProceedingJoinPoint&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pjp&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取受保护的方法&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Method&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">originMethod&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resolveMethod&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pjp&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取 @SentinelResource注解&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SentinelResource&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">annotation&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">originMethod&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getAnnotation&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SentinelResource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">annotation&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// Should not go through here.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IllegalStateException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Wrong state for SentinelResource annotation&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取注解上的资源名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getResourceName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">annotation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">originMethod&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">EntryType&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entryType&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">annotation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">entryType&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceType&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">annotation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">resourceType&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建资源 Entry&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SphU&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entryType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pjp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getArgs&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 执行受保护的方法&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pjp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">proceed&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">handleBlockException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pjp&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">annotation&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;?&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">extends&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="o">&amp;gt;[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exceptionsToIgnore&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">annotation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">exceptionsToIgnore&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// The ignore list will be checked first.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exceptionsToIgnore&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exceptionBelongsTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exceptionsToIgnore&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exceptionBelongsTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">annotation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">exceptionsToTrace&lt;/span>&lt;span class="p">()))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">traceException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">handleFallback&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pjp&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">annotation&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// No fallback function can handle the exception, so throw it out.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">finally&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pjp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getArgs&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>简单来说，@SentinelResource注解就是一个标记，而Sentinel基于AOP思想，对被标记的方法做环绕增强，完成资源（&lt;code>Entry&lt;/code>）的创建。&lt;/p>
&lt;h2 id="14context">
&lt;a href="#14context" class="header-anchor">#&lt;/a>
1.4.Context
&lt;/h2>&lt;p>上一节，我们发现簇点链路中除了controller方法、service方法两个资源外，还多了一个默认的入口节点：&lt;/p>
&lt;p>sentinel_spring_web_context，是一个EntranceNode类型的节点&lt;/p>
&lt;p>这个节点是在初始化Context的时候由Sentinel帮我们创建的。&lt;/p>
&lt;h3 id="141什么是context">
&lt;a href="#141%e4%bb%80%e4%b9%88%e6%98%afcontext" class="header-anchor">#&lt;/a>
1.4.1.什么是Context
&lt;/h3>&lt;p>那么，什么是Context呢？&lt;/p>
&lt;ul>
&lt;li>Context 代表调用链路上下文，贯穿一次调用链路中的所有资源（ &lt;code>Entry&lt;/code>），基于ThreadLocal。&lt;/li>
&lt;li>Context 维持着入口节点（&lt;code>entranceNode&lt;/code>）、本次调用链路的 curNode（当前资源节点）、调用来源（&lt;code>origin&lt;/code>）等信息。&lt;/li>
&lt;li>后续的Slot都可以通过Context拿到DefaultNode或者ClusterNode，从而获取统计数据，完成规则判断&lt;/li>
&lt;li>Context初始化的过程中，会创建EntranceNode，contextName就是EntranceNode的名称&lt;/li>
&lt;/ul>
&lt;p>对应的API如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 创建context，包含两个参数：context名称、 来源名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">ContextUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">enter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;contextName&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;originName&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="142context的初始化">
&lt;a href="#142context%e7%9a%84%e5%88%9d%e5%a7%8b%e5%8c%96" class="header-anchor">#&lt;/a>
1.4.2.Context的初始化
&lt;/h3>&lt;p>那么这个Context又是在何时完成初始化的呢？&lt;/p>
&lt;h4 id="1421自动装配">
&lt;a href="#1421%e8%87%aa%e5%8a%a8%e8%a3%85%e9%85%8d" class="header-anchor">#&lt;/a>
1.4.2.1.自动装配
&lt;/h4>&lt;p>来看下我们引入的Sentinel依赖包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-c6f1e9f589e3dd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925115601560"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的spring.factories声明需要就是自动装配的配置类，内容如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-fb46bf87e95451.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925115740281"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们先看SentinelWebAutoConfiguration这个类：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-4df850f56ad0dd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925115824345"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这个类实现了WebMvcConfigurer，我们知道这个是SpringMVC自定义配置用到的类，可以配置HandlerInterceptor：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-7aafc0e57bfec7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925115946064"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到这里配置了一个&lt;code>SentinelWebInterceptor&lt;/code>的拦截器。&lt;/p>
&lt;p>&lt;code>SentinelWebInterceptor&lt;/code>的声明如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-f75e66264581a3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925120119030"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>发现它继承了&lt;code>AbstractSentinelInterceptor&lt;/code>这个类。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-9893fc6c3325be.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925120221883"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>&lt;code>HandlerInterceptor&lt;/code>拦截器会拦截一切进入controller的方法，执行&lt;code>preHandle&lt;/code>前置拦截方法，而Context的初始化就是在这里完成的。&lt;/p>
&lt;h4 id="1422abstractsentinelinterceptor">
&lt;a href="#1422abstractsentinelinterceptor" class="header-anchor">#&lt;/a>
1.4.2.2.AbstractSentinelInterceptor
&lt;/h4>&lt;p>&lt;code>HandlerInterceptor&lt;/code>拦截器会拦截一切进入controller的方法，执行&lt;code>preHandle&lt;/code>前置拦截方法，而Context的初始化就是在这里完成的。&lt;/p>
&lt;p>我们来看看这个类的&lt;code>preHandle&lt;/code>实现：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-5">&lt;a class="lnlinks" href="#hl-6-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-6">&lt;a class="lnlinks" href="#hl-6-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-7">&lt;a class="lnlinks" href="#hl-6-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-8">&lt;a class="lnlinks" href="#hl-6-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-9">&lt;a class="lnlinks" href="#hl-6-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-10">&lt;a class="lnlinks" href="#hl-6-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-11">&lt;a class="lnlinks" href="#hl-6-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-12">&lt;a class="lnlinks" href="#hl-6-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-13">&lt;a class="lnlinks" href="#hl-6-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-14">&lt;a class="lnlinks" href="#hl-6-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-15">&lt;a class="lnlinks" href="#hl-6-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-16">&lt;a class="lnlinks" href="#hl-6-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-17">&lt;a class="lnlinks" href="#hl-6-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-18">&lt;a class="lnlinks" href="#hl-6-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-19">&lt;a class="lnlinks" href="#hl-6-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-20">&lt;a class="lnlinks" href="#hl-6-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-21">&lt;a class="lnlinks" href="#hl-6-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-22">&lt;a class="lnlinks" href="#hl-6-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-23">&lt;a class="lnlinks" href="#hl-6-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-24">&lt;a class="lnlinks" href="#hl-6-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-25">&lt;a class="lnlinks" href="#hl-6-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-26">&lt;a class="lnlinks" href="#hl-6-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-27">&lt;a class="lnlinks" href="#hl-6-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-28">&lt;a class="lnlinks" href="#hl-6-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-29">&lt;a class="lnlinks" href="#hl-6-29">29&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">preHandle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HttpServletResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">handler&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取资源名称，一般是controller方法的@RequestMapping路径，例如/order/{orderId}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getResourceName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">StringUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceName&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 从request中获取请求来源，将来做 授权规则 判断时会用&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">origin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">parseOrigin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取 contextName，默认是sentinel_spring_web_context&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">contextName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getContextName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建 Context&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ContextUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">enter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">contextName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">origin&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建资源，名称就是当前请求的controller方法的映射路径&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SphU&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ResourceTypeConstants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">COMMON_WEB&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">EntryType&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">IN&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setAttribute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">baseWebMvcConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getRequestAttributeName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">handleBlockException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">finally&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ContextUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">exit&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="1423contextutil">
&lt;a href="#1423contextutil" class="header-anchor">#&lt;/a>
1.4.2.3.ContextUtil
&lt;/h4>&lt;p>创建Context的方法就是&lt;code> ContextUtil.enter(contextName, origin);&lt;/code>&lt;/p>
&lt;p>我们进入该方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">enter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">origin&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CONTEXT_DEFAULT_NAME&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ContextNameDefineException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;The &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CONTEXT_DEFAULT_NAME&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; can&amp;#39;t be permit to defined!&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">trueEnter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">origin&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>进入&lt;code>trueEnter&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-6">&lt;a class="lnlinks" href="#hl-8-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-7">&lt;a class="lnlinks" href="#hl-8-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-8">&lt;a class="lnlinks" href="#hl-8-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-9">&lt;a class="lnlinks" href="#hl-8-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-10">&lt;a class="lnlinks" href="#hl-8-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-11">&lt;a class="lnlinks" href="#hl-8-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-12">&lt;a class="lnlinks" href="#hl-8-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-13">&lt;a class="lnlinks" href="#hl-8-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-14">&lt;a class="lnlinks" href="#hl-8-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-15">&lt;a class="lnlinks" href="#hl-8-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-16">&lt;a class="lnlinks" href="#hl-8-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-17">&lt;a class="lnlinks" href="#hl-8-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-18">&lt;a class="lnlinks" href="#hl-8-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-19">&lt;a class="lnlinks" href="#hl-8-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-20">&lt;a class="lnlinks" href="#hl-8-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-21">&lt;a class="lnlinks" href="#hl-8-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-22">&lt;a class="lnlinks" href="#hl-8-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-23">&lt;a class="lnlinks" href="#hl-8-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-24">&lt;a class="lnlinks" href="#hl-8-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-25">&lt;a class="lnlinks" href="#hl-8-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-26">&lt;a class="lnlinks" href="#hl-8-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-27">&lt;a class="lnlinks" href="#hl-8-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-28">&lt;a class="lnlinks" href="#hl-8-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-29">&lt;a class="lnlinks" href="#hl-8-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-30">&lt;a class="lnlinks" href="#hl-8-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-31">&lt;a class="lnlinks" href="#hl-8-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-32">&lt;a class="lnlinks" href="#hl-8-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-33">&lt;a class="lnlinks" href="#hl-8-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-34">&lt;a class="lnlinks" href="#hl-8-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-35">&lt;a class="lnlinks" href="#hl-8-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-36">&lt;a class="lnlinks" href="#hl-8-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-37">&lt;a class="lnlinks" href="#hl-8-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-38">&lt;a class="lnlinks" href="#hl-8-38">38&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">protected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">trueEnter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">origin&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 尝试获取context&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">contextHolder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判空&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果为空，开始初始化&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">localCacheNameMap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">contextNameNodeMap&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 尝试获取入口节点&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">localCacheNameMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">LOCK&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">lock&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">contextNameNodeMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 入口节点为空，初始化入口节点 EntranceNode&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">EntranceNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringResourceWrapper&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">EntryType&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">IN&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 添加入口节点到 ROOT&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ROOT&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addChild&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 将入口节点放入缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">newMap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">contextNameNodeMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">newMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">putAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">contextNameNodeMap&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">newMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">contextNameNodeMap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">newMap&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">finally&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">LOCK&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建Context，参数为：入口节点 和 contextName&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 设置请求来源 origin&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setOrigin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">origin&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放入ThreadLocal&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">contextHolder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 返回&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="2processorslotchain执行流程">
&lt;a href="#2processorslotchain%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b" class="header-anchor">#&lt;/a>
2.ProcessorSlotChain执行流程
&lt;/h1>&lt;p>接下来我们跟踪源码，验证下ProcessorSlotChain的执行流程。&lt;/p>
&lt;h2 id="21入口">
&lt;a href="#21%e5%85%a5%e5%8f%a3" class="header-anchor">#&lt;/a>
2.1.入口
&lt;/h2>&lt;p>首先，回到一切的入口，&lt;code>AbstractSentinelInterceptor&lt;/code>类的&lt;code>preHandle&lt;/code>方法：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-36bd6e70a28b5f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925142313050"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>还有，&lt;code>SentinelResourceAspect&lt;/code>的环绕增强方法：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-cc896731e8aab1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925142438552"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，任何一个资源必定要执行&lt;code>SphU.entry()&lt;/code>这个方法:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">EntryType&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">trafficType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Env&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">sph&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">entryWithType&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">trafficType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>继续进入&lt;code>Env.sph.entryWithType(name, resourceType, trafficType, 1, args);&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-5">&lt;a class="lnlinks" href="#hl-10-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-6">&lt;a class="lnlinks" href="#hl-10-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-7">&lt;a class="lnlinks" href="#hl-10-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-8">&lt;a class="lnlinks" href="#hl-10-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">entryWithType&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">EntryType&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entryType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 将 资源名称等基本信息 封装为一个 StringResourceWrapper对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">StringResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringResourceWrapper&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entryType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceType&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 继续&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entryWithPriority&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>进入&lt;code>entryWithPriority&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-5">&lt;a class="lnlinks" href="#hl-11-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-6">&lt;a class="lnlinks" href="#hl-11-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-7">&lt;a class="lnlinks" href="#hl-11-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-8">&lt;a class="lnlinks" href="#hl-11-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-9">&lt;a class="lnlinks" href="#hl-11-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-10">&lt;a class="lnlinks" href="#hl-11-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-11">&lt;a class="lnlinks" href="#hl-11-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-12">&lt;a class="lnlinks" href="#hl-11-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-13">&lt;a class="lnlinks" href="#hl-11-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-14">&lt;a class="lnlinks" href="#hl-11-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-15">&lt;a class="lnlinks" href="#hl-11-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-16">&lt;a class="lnlinks" href="#hl-11-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-17">&lt;a class="lnlinks" href="#hl-11-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-18">&lt;a class="lnlinks" href="#hl-11-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-19">&lt;a class="lnlinks" href="#hl-11-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-20">&lt;a class="lnlinks" href="#hl-11-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-21">&lt;a class="lnlinks" href="#hl-11-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-22">&lt;a class="lnlinks" href="#hl-11-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-23">&lt;a class="lnlinks" href="#hl-11-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-24">&lt;a class="lnlinks" href="#hl-11-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-25">&lt;a class="lnlinks" href="#hl-11-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-26">&lt;a class="lnlinks" href="#hl-11-26">26&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">entryWithPriority&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取 Context&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ContextUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getContext&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// Using default context.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InternalContextUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">internalEnter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CONTEXT_DEFAULT_NAME&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">、&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取 Slot执行链，同一个资源，会创建一个执行链，放入缓存&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ProcessorSlot&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">chain&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">lookProcessChain&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建 Entry，并将 resource、chain、context 记录在 Entry中&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CtEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">chain&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 执行 slotChain&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">chain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// This should not happen, unless there are errors existing in Sentinel internal.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">RecordLog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Sentinel unexpected exception&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e1&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在这段代码中，会获取&lt;code>ProcessorSlotChain&lt;/code>对象，然后基于chain.entry()开始执行slotChain中的每一个Slot. 而这里创建的是其实现类：DefaultProcessorSlotChain.&lt;/p>
&lt;p>获取ProcessorSlotChain以后会保存到一个Map中，key是ResourceWrapper，值是ProcessorSlotChain.&lt;/p>
&lt;p>所以，&lt;strong>一个资源只会有一个ProcessorSlotChain&lt;/strong>.&lt;/p>
&lt;h2 id="22defaultprocessorslotchain">
&lt;a href="#22defaultprocessorslotchain" class="header-anchor">#&lt;/a>
2.2.DefaultProcessorSlotChain
&lt;/h2>&lt;p>我们进入DefaultProcessorSlotChain的entry方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-6">&lt;a class="lnlinks" href="#hl-12-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// first，就是责任链中的第一个 slot&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">first&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">transformEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里的first，类型是AbstractLinkedProcessorSlot：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-76a4a0858c0dc2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925144355865"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>看下继承关系：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-ca8288e624ae1d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925144010507"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>因此，first一定是这些实现类中的一个，按照最早讲的责任链顺序，first应该就是 &lt;code>NodeSelectorSlot&lt;/code>。&lt;/p>
&lt;p>不过，既然是基于责任链模式，所以这里只要记住下一个slot就可以了，也就是next：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-1f282b077e9522.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925144233302"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>next确实是NodeSelectSlot类型。&lt;/p>
&lt;p>而NodeSelectSlot的next一定是ClusterBuilderSlot，依次类推：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-530698f90c97e3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925101327080"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>责任链就建立起来了。&lt;/p>
&lt;h2 id="23nodeselectorslot">
&lt;a href="#23nodeselectorslot" class="header-anchor">#&lt;/a>
2.3.NodeSelectorSlot
&lt;/h2>&lt;p>NodeSelectorSlot负责构建簇点链路中的节点（DefaultNode），将这些节点形成链路树。&lt;/p>
&lt;p>核心代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-6">&lt;a class="lnlinks" href="#hl-13-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-7">&lt;a class="lnlinks" href="#hl-13-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-8">&lt;a class="lnlinks" href="#hl-13-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-9">&lt;a class="lnlinks" href="#hl-13-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-10">&lt;a class="lnlinks" href="#hl-13-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-11">&lt;a class="lnlinks" href="#hl-13-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-12">&lt;a class="lnlinks" href="#hl-13-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-13">&lt;a class="lnlinks" href="#hl-13-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-14">&lt;a class="lnlinks" href="#hl-13-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-15">&lt;a class="lnlinks" href="#hl-13-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-16">&lt;a class="lnlinks" href="#hl-13-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-17">&lt;a class="lnlinks" href="#hl-13-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-18">&lt;a class="lnlinks" href="#hl-13-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-19">&lt;a class="lnlinks" href="#hl-13-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-20">&lt;a class="lnlinks" href="#hl-13-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-21">&lt;a class="lnlinks" href="#hl-13-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-22">&lt;a class="lnlinks" href="#hl-13-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-23">&lt;a class="lnlinks" href="#hl-13-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-24">&lt;a class="lnlinks" href="#hl-13-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-25">&lt;a class="lnlinks" href="#hl-13-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-26">&lt;a class="lnlinks" href="#hl-13-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-27">&lt;a class="lnlinks" href="#hl-13-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-28">&lt;a class="lnlinks" href="#hl-13-28">28&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 尝试获取 当前资源的 DefaultNode&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">synchronized&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果为空，为当前资源创建一个新的 DefaultNode&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cacheMap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">cacheMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">putAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放入缓存中，注意这里的 key是contextName，&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 这样不同链路进入相同资源，就会创建多个 DefaultNode&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">cacheMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cacheMap&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 当前节点加入上一节点的 child中，这样就构成了调用链路树&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLastNode&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="na">addChild&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// context中的curNode（当前节点）设置为新的 node&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setCurNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 执行下一个 slot&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">fireEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个Slot完成了这么几件事情：&lt;/p>
&lt;ul>
&lt;li>为当前资源创建 DefaultNode&lt;/li>
&lt;li>将DefaultNode放入缓存中，key是contextName，这样不同链路入口的请求，将会创建多个DefaultNode，相同链路则只有一个DefaultNode&lt;/li>
&lt;li>将当前资源的DefaultNode设置为上一个资源的childNode&lt;/li>
&lt;li>将当前资源的DefaultNode设置为Context中的curNode（当前节点）&lt;/li>
&lt;/ul>
&lt;p>下一个slot，就是ClusterBuilderSlot&lt;/p>
&lt;h2 id="24clusterbuilderslot">
&lt;a href="#24clusterbuilderslot" class="header-anchor">#&lt;/a>
2.4.ClusterBuilderSlot
&lt;/h2>&lt;p>ClusterBuilderSlot负责构建某个资源的ClusterNode，核心代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-5">&lt;a class="lnlinks" href="#hl-14-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-6">&lt;a class="lnlinks" href="#hl-14-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-7">&lt;a class="lnlinks" href="#hl-14-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-8">&lt;a class="lnlinks" href="#hl-14-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-9">&lt;a class="lnlinks" href="#hl-14-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-10">&lt;a class="lnlinks" href="#hl-14-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-11">&lt;a class="lnlinks" href="#hl-14-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-12">&lt;a class="lnlinks" href="#hl-14-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-13">&lt;a class="lnlinks" href="#hl-14-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-14">&lt;a class="lnlinks" href="#hl-14-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-15">&lt;a class="lnlinks" href="#hl-14-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-16">&lt;a class="lnlinks" href="#hl-14-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-17">&lt;a class="lnlinks" href="#hl-14-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-18">&lt;a class="lnlinks" href="#hl-14-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-19">&lt;a class="lnlinks" href="#hl-14-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-20">&lt;a class="lnlinks" href="#hl-14-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-21">&lt;a class="lnlinks" href="#hl-14-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-22">&lt;a class="lnlinks" href="#hl-14-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-23">&lt;a class="lnlinks" href="#hl-14-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-24">&lt;a class="lnlinks" href="#hl-14-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-25">&lt;a class="lnlinks" href="#hl-14-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-26">&lt;a class="lnlinks" href="#hl-14-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-27">&lt;a class="lnlinks" href="#hl-14-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-28">&lt;a class="lnlinks" href="#hl-14-28">28&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判空，注意ClusterNode是共享的成员变量，也就是说一个资源只有一个ClusterNode，与链路无关&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusterNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">synchronized&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lock&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusterNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建 cluster node.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clusterNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ClusterNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getResourceType&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ClusterNode&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">newMap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusterNodeMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">16&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">newMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">putAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusterNodeMap&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放入缓存，可以是nodeId，也就是resource名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">newMap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterNode&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clusterNodeMap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">newMap&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 将资源的 DefaultNode与 ClusterNode关联&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setClusterNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clusterNode&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 记录请求来源 origin 将 origin放入 entry&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getOrigin&lt;/span>&lt;span class="p">()))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">originNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getClusterNode&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getOrCreateOriginNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getOrigin&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCurEntry&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">setOriginNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">originNode&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 继续下一个slot&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">fireEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="25statisticslot">
&lt;a href="#25statisticslot" class="header-anchor">#&lt;/a>
2.5.StatisticSlot
&lt;/h2>&lt;p>StatisticSlot负责统计实时调用数据，包括运行信息（访问次数、线程数）、来源信息等。&lt;/p>
&lt;p>StatisticSlot是实现限流的关键，其中基于&lt;strong>滑动时间窗口算法&lt;/strong>维护了计数器，统计进入某个资源的请求次数。&lt;/p>
&lt;p>核心代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-6">&lt;a class="lnlinks" href="#hl-15-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-7">&lt;a class="lnlinks" href="#hl-15-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-8">&lt;a class="lnlinks" href="#hl-15-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-9">&lt;a class="lnlinks" href="#hl-15-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-10">&lt;a class="lnlinks" href="#hl-15-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-11">&lt;a class="lnlinks" href="#hl-15-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-12">&lt;a class="lnlinks" href="#hl-15-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-13">&lt;a class="lnlinks" href="#hl-15-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-14">&lt;a class="lnlinks" href="#hl-15-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-15">&lt;a class="lnlinks" href="#hl-15-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-16">&lt;a class="lnlinks" href="#hl-15-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-17">&lt;a class="lnlinks" href="#hl-15-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-18">&lt;a class="lnlinks" href="#hl-15-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-19">&lt;a class="lnlinks" href="#hl-15-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-20">&lt;a class="lnlinks" href="#hl-15-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-21">&lt;a class="lnlinks" href="#hl-15-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-22">&lt;a class="lnlinks" href="#hl-15-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-23">&lt;a class="lnlinks" href="#hl-15-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-24">&lt;a class="lnlinks" href="#hl-15-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-25">&lt;a class="lnlinks" href="#hl-15-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-26">&lt;a class="lnlinks" href="#hl-15-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-27">&lt;a class="lnlinks" href="#hl-15-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-28">&lt;a class="lnlinks" href="#hl-15-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-29">&lt;a class="lnlinks" href="#hl-15-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-30">&lt;a class="lnlinks" href="#hl-15-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-31">&lt;a class="lnlinks" href="#hl-15-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-32">&lt;a class="lnlinks" href="#hl-15-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-33">&lt;a class="lnlinks" href="#hl-15-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-34">&lt;a class="lnlinks" href="#hl-15-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-35">&lt;a class="lnlinks" href="#hl-15-35">35&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放行到下一个 slot，做限流、降级等判断&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">fireEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 请求通过了, 线程计数器 +1 ，用作线程隔离&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">increaseThreadNum&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 请求计数器 +1 用作限流&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addPassRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCurEntry&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getOriginNode&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果有 origin，来源计数器也都要 +1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCurEntry&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getOriginNode&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">increaseThreadNum&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCurEntry&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getOriginNode&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">addPassRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getEntryType&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">EntryType&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">IN&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果是入口资源，还要给全局计数器 +1.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ENTRY_NODE&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">increaseThreadNum&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ENTRY_NODE&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addPassRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 请求通过后的回调.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ProcessorSlotEntryCallback&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">handler&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StatisticSlotCallbackRegistry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getEntryCallbacks&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">handler&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">onPass&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 各种异常处理就省略了。。。&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCurEntry&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">setError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>另外，需要注意的是，所有的计数+1动作都包括两部分，以&lt;code> node.addPassRequest(count);&lt;/code>为例：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-7">&lt;a class="lnlinks" href="#hl-16-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">addPassRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// DefaultNode的计数器，代表当前链路的 计数器&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">super&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addPassRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// ClusterNode计数器，代表当前资源的 总计数器&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">clusterNode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addPassRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>具体计数方式，我们后续再看。&lt;/p>
&lt;p>接下来，进入规则校验的相关slot了，依次是：&lt;/p>
&lt;ul>
&lt;li>AuthoritySlot：负责授权规则（来源控制）&lt;/li>
&lt;li>SystemSlot：负责系统保护规则&lt;/li>
&lt;li>ParamFlowSlot：负责热点参数限流规则&lt;/li>
&lt;li>FlowSlot：负责限流规则&lt;/li>
&lt;li>DegradeSlot：负责降级规则&lt;/li>
&lt;/ul>
&lt;h2 id="26authorityslot">
&lt;a href="#26authorityslot" class="header-anchor">#&lt;/a>
2.6.AuthoritySlot
&lt;/h2>&lt;p>负责请求来源origin的授权规则判断，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-43fd4d97e0d6a7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925152626648"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>核心API：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-4">&lt;a class="lnlinks" href="#hl-17-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-5">&lt;a class="lnlinks" href="#hl-17-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-6">&lt;a class="lnlinks" href="#hl-17-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-7">&lt;a class="lnlinks" href="#hl-17-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-8">&lt;a class="lnlinks" href="#hl-17-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 校验黑白名单&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">checkBlackWhiteAuthority&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 进入下一个 slot&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">fireEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>黑白名单校验的逻辑：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-5">&lt;a class="lnlinks" href="#hl-18-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-6">&lt;a class="lnlinks" href="#hl-18-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-7">&lt;a class="lnlinks" href="#hl-18-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-8">&lt;a class="lnlinks" href="#hl-18-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-9">&lt;a class="lnlinks" href="#hl-18-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-10">&lt;a class="lnlinks" href="#hl-18-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-11">&lt;a class="lnlinks" href="#hl-18-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-12">&lt;a class="lnlinks" href="#hl-18-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-13">&lt;a class="lnlinks" href="#hl-18-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-14">&lt;a class="lnlinks" href="#hl-18-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-15">&lt;a class="lnlinks" href="#hl-18-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-16">&lt;a class="lnlinks" href="#hl-18-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-17">&lt;a class="lnlinks" href="#hl-18-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-18">&lt;a class="lnlinks" href="#hl-18-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-19">&lt;a class="lnlinks" href="#hl-18-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-20">&lt;a class="lnlinks" href="#hl-18-20">20&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">checkBlackWhiteAuthority&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AuthorityException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取授权规则&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Set&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">AuthorityRule&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">authorityRules&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AuthorityRuleManager&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getAuthorityRules&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">authorityRules&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Set&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">AuthorityRule&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rules&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">authorityRules&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rules&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 遍历规则并判断&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AuthorityRule&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rules&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">AuthorityRuleChecker&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">passCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 规则不通过，直接抛出异常&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AuthorityException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getOrigin&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>再看下&lt;code>AuthorityRuleChecker.passCheck(rule, context)&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-5">&lt;a class="lnlinks" href="#hl-19-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-6">&lt;a class="lnlinks" href="#hl-19-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-7">&lt;a class="lnlinks" href="#hl-19-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-8">&lt;a class="lnlinks" href="#hl-19-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-9">&lt;a class="lnlinks" href="#hl-19-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-10">&lt;a class="lnlinks" href="#hl-19-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-11">&lt;a class="lnlinks" href="#hl-19-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-12">&lt;a class="lnlinks" href="#hl-19-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-13">&lt;a class="lnlinks" href="#hl-19-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-14">&lt;a class="lnlinks" href="#hl-19-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-15">&lt;a class="lnlinks" href="#hl-19-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-16">&lt;a class="lnlinks" href="#hl-19-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-17">&lt;a class="lnlinks" href="#hl-19-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-18">&lt;a class="lnlinks" href="#hl-19-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-19">&lt;a class="lnlinks" href="#hl-19-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-20">&lt;a class="lnlinks" href="#hl-19-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-21">&lt;a class="lnlinks" href="#hl-19-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-22">&lt;a class="lnlinks" href="#hl-19-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-23">&lt;a class="lnlinks" href="#hl-19-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-24">&lt;a class="lnlinks" href="#hl-19-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-25">&lt;a class="lnlinks" href="#hl-19-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-26">&lt;a class="lnlinks" href="#hl-19-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-27">&lt;a class="lnlinks" href="#hl-19-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-28">&lt;a class="lnlinks" href="#hl-19-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-29">&lt;a class="lnlinks" href="#hl-19-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-30">&lt;a class="lnlinks" href="#hl-19-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-31">&lt;a class="lnlinks" href="#hl-19-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-32">&lt;a class="lnlinks" href="#hl-19-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-33">&lt;a class="lnlinks" href="#hl-19-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-34">&lt;a class="lnlinks" href="#hl-19-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-35">&lt;a class="lnlinks" href="#hl-19-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-36">&lt;a class="lnlinks" href="#hl-19-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-37">&lt;a class="lnlinks" href="#hl-19-37">37&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">passCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AuthorityRule&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 得到请求来源 origin&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">requester&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getOrigin&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 来源为空，或者规则为空，都直接放行&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">StringUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">requester&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">||&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">StringUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLimitApp&lt;/span>&lt;span class="p">()))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// rule.getLimitApp()得到的就是 白名单 或 黑名单 的字符串，这里先用 indexOf方法判断&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pos&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLimitApp&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">indexOf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">requester&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">contain&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pos&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">contain&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果包含 origin，还要进一步做精确判断，把名单列表以&amp;#34;,&amp;#34;分割，逐个判断&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exactlyMatch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">appArray&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLimitApp&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;,&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">appArray&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">requester&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">exactlyMatch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">contain&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exactlyMatch&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果是黑名单，并且包含origin，则返回false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">strategy&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getStrategy&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">strategy&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuleConstant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">AUTHORITY_BLACK&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">contain&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果是白名单，并且不包含origin，则返回false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">strategy&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuleConstant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">AUTHORITY_WHITE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">contain&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 其它情况返回true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="27systemslot">
&lt;a href="#27systemslot" class="header-anchor">#&lt;/a>
2.7.SystemSlot
&lt;/h2>&lt;p>SystemSlot是对系统保护的规则校验：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-cd571cdbd56519.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925153228036"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>核心API：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-4">&lt;a class="lnlinks" href="#hl-20-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-5">&lt;a class="lnlinks" href="#hl-20-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-6">&lt;a class="lnlinks" href="#hl-20-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-7">&lt;a class="lnlinks" href="#hl-20-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-8">&lt;a class="lnlinks" href="#hl-20-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 系统规则校验&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SystemRuleManager&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">checkSystem&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 进入下一个 slot&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">fireEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>来看下&lt;code>SystemRuleManager.checkSystem(resourceWrapper);&lt;/code>的代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-21-1">&lt;a class="lnlinks" href="#hl-21-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-2">&lt;a class="lnlinks" href="#hl-21-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-3">&lt;a class="lnlinks" href="#hl-21-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-4">&lt;a class="lnlinks" href="#hl-21-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-5">&lt;a class="lnlinks" href="#hl-21-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-6">&lt;a class="lnlinks" href="#hl-21-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-7">&lt;a class="lnlinks" href="#hl-21-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-8">&lt;a class="lnlinks" href="#hl-21-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-9">&lt;a class="lnlinks" href="#hl-21-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-10">&lt;a class="lnlinks" href="#hl-21-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-11">&lt;a class="lnlinks" href="#hl-21-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-12">&lt;a class="lnlinks" href="#hl-21-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-13">&lt;a class="lnlinks" href="#hl-21-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-14">&lt;a class="lnlinks" href="#hl-21-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-15">&lt;a class="lnlinks" href="#hl-21-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-16">&lt;a class="lnlinks" href="#hl-21-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-17">&lt;a class="lnlinks" href="#hl-21-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-18">&lt;a class="lnlinks" href="#hl-21-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-19">&lt;a class="lnlinks" href="#hl-21-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-20">&lt;a class="lnlinks" href="#hl-21-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-21">&lt;a class="lnlinks" href="#hl-21-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-22">&lt;a class="lnlinks" href="#hl-21-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-23">&lt;a class="lnlinks" href="#hl-21-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-24">&lt;a class="lnlinks" href="#hl-21-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-25">&lt;a class="lnlinks" href="#hl-21-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-26">&lt;a class="lnlinks" href="#hl-21-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-27">&lt;a class="lnlinks" href="#hl-21-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-28">&lt;a class="lnlinks" href="#hl-21-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-29">&lt;a class="lnlinks" href="#hl-21-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-30">&lt;a class="lnlinks" href="#hl-21-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-31">&lt;a class="lnlinks" href="#hl-21-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-32">&lt;a class="lnlinks" href="#hl-21-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-33">&lt;a class="lnlinks" href="#hl-21-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-34">&lt;a class="lnlinks" href="#hl-21-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-35">&lt;a class="lnlinks" href="#hl-21-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-36">&lt;a class="lnlinks" href="#hl-21-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-37">&lt;a class="lnlinks" href="#hl-21-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-38">&lt;a class="lnlinks" href="#hl-21-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-39">&lt;a class="lnlinks" href="#hl-21-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-40">&lt;a class="lnlinks" href="#hl-21-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-41">&lt;a class="lnlinks" href="#hl-21-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-42">&lt;a class="lnlinks" href="#hl-21-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-43">&lt;a class="lnlinks" href="#hl-21-43">43&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">checkSystem&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// Ensure the checking switch is on.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">checkSystemStatus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 只针对入口资源做校验，其它直接返回&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getEntryType&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">EntryType&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">IN&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 全局 QPS校验&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">double&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">currentQps&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ENTRY_NODE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ENTRY_NODE&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">successQps&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentQps&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">qps&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SystemBlockException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;qps&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 全局 线程数 校验&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">currentThread&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ENTRY_NODE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ENTRY_NODE&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">curThreadNum&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentThread&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">maxThread&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SystemBlockException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;thread&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 全局平均 RT校验&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">double&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rt&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ENTRY_NODE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Constants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ENTRY_NODE&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">avgRt&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rt&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">maxRt&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SystemBlockException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;rt&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 全局 系统负载 校验&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">highestSystemLoadIsSet&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getCurrentSystemAvgLoad&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">highestSystemLoad&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">checkBbr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentThread&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SystemBlockException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;load&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 全局 CPU使用率 校验&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">highestCpuUsageIsSet&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getCurrentCpuUsage&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">highestCpuUsage&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SystemBlockException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;cpu&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="28paramflowslot">
&lt;a href="#28paramflowslot" class="header-anchor">#&lt;/a>
2.8.ParamFlowSlot
&lt;/h2>&lt;p>ParamFlowSlot就是热点参数限流，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-8971fa00fcbed6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925153719891"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>是针对进入资源的请求，针对不同的请求参数值分别统计QPS的限流方式。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>这里的单机阈值，就是最大令牌数量：maxCount&lt;/p>
&lt;/li>
&lt;li>
&lt;p>这里的统计窗口时长，就是统计时长：duration&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>含义是每隔duration时间长度内，最多生产maxCount个令牌，上图配置的含义是每1秒钟生产2个令牌。&lt;/p>
&lt;p>核心API：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-22-1">&lt;a class="lnlinks" href="#hl-22-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-2">&lt;a class="lnlinks" href="#hl-22-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-3">&lt;a class="lnlinks" href="#hl-22-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-4">&lt;a class="lnlinks" href="#hl-22-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-5">&lt;a class="lnlinks" href="#hl-22-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-6">&lt;a class="lnlinks" href="#hl-22-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-7">&lt;a class="lnlinks" href="#hl-22-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-8">&lt;a class="lnlinks" href="#hl-22-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-9">&lt;a class="lnlinks" href="#hl-22-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-10">&lt;a class="lnlinks" href="#hl-22-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-11">&lt;a class="lnlinks" href="#hl-22-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-12">&lt;a class="lnlinks" href="#hl-22-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-13">&lt;a class="lnlinks" href="#hl-22-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果没有设置热点规则，直接放行&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">ParamFlowRuleManager&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">hasRules&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">()))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">fireEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 热点规则判断&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">checkFlow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 进入下一个 slot&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">fireEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="281令牌桶">
&lt;a href="#281%e4%bb%a4%e7%89%8c%e6%a1%b6" class="header-anchor">#&lt;/a>
2.8.1.令牌桶
&lt;/h3>&lt;p>热点规则判断采用了令牌桶算法来实现参数限流，为每一个不同参数值设置令牌桶，Sentinel的令牌桶有两部分组成：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-b9917806a87f13.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925163744108"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这两个Map的key都是请求的参数值，value却不同，其中：&lt;/p>
&lt;ul>
&lt;li>tokenCounters：用来记录剩余令牌数量&lt;/li>
&lt;li>timeCounters：用来记录上一个请求的时间&lt;/li>
&lt;/ul>
&lt;p>当一个携带参数的请求到来后，基本判断流程是这样的：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-aec2612c9eaa5e.jpg"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="sentinel"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="29flowslot">
&lt;a href="#29flowslot" class="header-anchor">#&lt;/a>
2.9.FlowSlot
&lt;/h2>&lt;p>FlowSlot是负责限流规则的判断，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-76e1cf053de8fd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925172542274"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>包括：&lt;/p>
&lt;ul>
&lt;li>三种流控模式：直接模式、关联模式、链路模式&lt;/li>
&lt;li>三种流控效果：快速失败、warm up、排队等待&lt;/li>
&lt;/ul>
&lt;p>三种流控模式，从底层&lt;strong>数据统计&lt;/strong>角度，分为两类：&lt;/p>
&lt;ul>
&lt;li>对进入资源的所有请求（ClusterNode）做限流统计：直接模式、关联模式&lt;/li>
&lt;li>对进入资源的部分链路（DefaultNode）做限流统计：链路模式&lt;/li>
&lt;/ul>
&lt;p>三种流控效果，从&lt;strong>限流算法&lt;/strong>来看，分为两类：&lt;/p>
&lt;ul>
&lt;li>滑动时间窗口算法：快速失败、warm up&lt;/li>
&lt;li>漏桶算法：排队等待效果&lt;/li>
&lt;/ul>
&lt;h3 id="291核心流程">
&lt;a href="#291%e6%a0%b8%e5%bf%83%e6%b5%81%e7%a8%8b" class="header-anchor">#&lt;/a>
2.9.1.核心流程
&lt;/h3>&lt;p>核心API如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-23-1">&lt;a class="lnlinks" href="#hl-23-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-2">&lt;a class="lnlinks" href="#hl-23-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-3">&lt;a class="lnlinks" href="#hl-23-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-4">&lt;a class="lnlinks" href="#hl-23-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-5">&lt;a class="lnlinks" href="#hl-23-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-6">&lt;a class="lnlinks" href="#hl-23-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-7">&lt;a class="lnlinks" href="#hl-23-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-8">&lt;a class="lnlinks" href="#hl-23-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 限流规则检测&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">checkFlow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放行&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">fireEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>checkFlow方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-24-1">&lt;a class="lnlinks" href="#hl-24-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-2">&lt;a class="lnlinks" href="#hl-24-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-3">&lt;a class="lnlinks" href="#hl-24-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-4">&lt;a class="lnlinks" href="#hl-24-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-5">&lt;a class="lnlinks" href="#hl-24-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">checkFlow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// checker是 FlowRuleChecker 类的一个对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">checker&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">checkFlow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ruleProvider&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>跟入FlowRuleChecker：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-25-1">&lt;a class="lnlinks" href="#hl-25-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-2">&lt;a class="lnlinks" href="#hl-25-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-3">&lt;a class="lnlinks" href="#hl-25-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-4">&lt;a class="lnlinks" href="#hl-25-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-5">&lt;a class="lnlinks" href="#hl-25-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-6">&lt;a class="lnlinks" href="#hl-25-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-7">&lt;a class="lnlinks" href="#hl-25-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-8">&lt;a class="lnlinks" href="#hl-25-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-9">&lt;a class="lnlinks" href="#hl-25-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-10">&lt;a class="lnlinks" href="#hl-25-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-11">&lt;a class="lnlinks" href="#hl-25-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-12">&lt;a class="lnlinks" href="#hl-25-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-13">&lt;a class="lnlinks" href="#hl-25-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-14">&lt;a class="lnlinks" href="#hl-25-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-15">&lt;a class="lnlinks" href="#hl-25-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-16">&lt;a class="lnlinks" href="#hl-25-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-17">&lt;a class="lnlinks" href="#hl-25-17">17&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">checkFlow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Function&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Collection&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">FlowRule&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ruleProvider&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ruleProvider&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">||&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取当前资源的所有限流规则&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Collection&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">FlowRule&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rules&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ruleProvider&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">apply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rules&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FlowRule&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rules&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 遍历，逐个规则做校验&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">canPassCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FlowException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLimitApp&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里的FlowRule就是限流规则接口，其中的几个成员变量，刚好对应表单参数：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-26-1">&lt;a class="lnlinks" href="#hl-26-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-2">&lt;a class="lnlinks" href="#hl-26-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-3">&lt;a class="lnlinks" href="#hl-26-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-4">&lt;a class="lnlinks" href="#hl-26-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-5">&lt;a class="lnlinks" href="#hl-26-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-6">&lt;a class="lnlinks" href="#hl-26-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-7">&lt;a class="lnlinks" href="#hl-26-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-8">&lt;a class="lnlinks" href="#hl-26-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-9">&lt;a class="lnlinks" href="#hl-26-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-10">&lt;a class="lnlinks" href="#hl-26-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-11">&lt;a class="lnlinks" href="#hl-26-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-12">&lt;a class="lnlinks" href="#hl-26-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-13">&lt;a class="lnlinks" href="#hl-26-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-14">&lt;a class="lnlinks" href="#hl-26-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-15">&lt;a class="lnlinks" href="#hl-26-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-16">&lt;a class="lnlinks" href="#hl-26-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-17">&lt;a class="lnlinks" href="#hl-26-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-18">&lt;a class="lnlinks" href="#hl-26-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-19">&lt;a class="lnlinks" href="#hl-26-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-20">&lt;a class="lnlinks" href="#hl-26-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-21">&lt;a class="lnlinks" href="#hl-26-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-22">&lt;a class="lnlinks" href="#hl-26-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-23">&lt;a class="lnlinks" href="#hl-26-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-24">&lt;a class="lnlinks" href="#hl-26-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-25">&lt;a class="lnlinks" href="#hl-26-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-26">&lt;a class="lnlinks" href="#hl-26-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-27">&lt;a class="lnlinks" href="#hl-26-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-28">&lt;a class="lnlinks" href="#hl-26-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-29">&lt;a class="lnlinks" href="#hl-26-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-30">&lt;a class="lnlinks" href="#hl-26-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-31">&lt;a class="lnlinks" href="#hl-26-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-32">&lt;a class="lnlinks" href="#hl-26-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-33">&lt;a class="lnlinks" href="#hl-26-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-34">&lt;a class="lnlinks" href="#hl-26-34">34&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">FlowRule&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">extends&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AbstractRule&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 阈值类型 (0: 线程, 1: QPS).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">grade&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuleConstant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">FLOW_GRADE_QPS&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 阈值.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">double&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 三种限流模式.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * {@link RuleConstant#STRATEGY_DIRECT} 直连模式;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * {@link RuleConstant#STRATEGY_RELATE} 关联模式;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * {@link RuleConstant#STRATEGY_CHAIN} 链路模式.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">strategy&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuleConstant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">STRATEGY_DIRECT&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 关联模式关联的资源名称.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">refResource&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 3种流控效果.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 0. 快速失败, 1. warm up, 2. 排队等待, 3. warm up + 排队等待
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">controlBehavior&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuleConstant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CONTROL_BEHAVIOR_DEFAULT&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 预热时长&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">warmUpPeriodSec&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">10&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 队列最大等待时间.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">maxQueueingTimeMs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">500&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 。。。 略&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>校验的逻辑定义在&lt;code>FlowRuleChecker&lt;/code>的&lt;code>canPassCheck&lt;/code>方法中：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-27-1">&lt;a class="lnlinks" href="#hl-27-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-2">&lt;a class="lnlinks" href="#hl-27-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-3">&lt;a class="lnlinks" href="#hl-27-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-4">&lt;a class="lnlinks" href="#hl-27-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-5">&lt;a class="lnlinks" href="#hl-27-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-6">&lt;a class="lnlinks" href="#hl-27-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-7">&lt;a class="lnlinks" href="#hl-27-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-8">&lt;a class="lnlinks" href="#hl-27-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-9">&lt;a class="lnlinks" href="#hl-27-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-10">&lt;a class="lnlinks" href="#hl-27-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">canPassCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="cm">/*@NonNull*/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FlowRule&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">acquireCount&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取限流资源名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">limitApp&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLimitApp&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">limitApp&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 校验规则&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">passLocalCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">acquireCount&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>进入&lt;code>passLocalCheck()&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-28-1">&lt;a class="lnlinks" href="#hl-28-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-2">&lt;a class="lnlinks" href="#hl-28-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-3">&lt;a class="lnlinks" href="#hl-28-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-4">&lt;a class="lnlinks" href="#hl-28-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-5">&lt;a class="lnlinks" href="#hl-28-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-6">&lt;a class="lnlinks" href="#hl-28-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-7">&lt;a class="lnlinks" href="#hl-28-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-8">&lt;a class="lnlinks" href="#hl-28-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-9">&lt;a class="lnlinks" href="#hl-28-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-10">&lt;a class="lnlinks" href="#hl-28-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-11">&lt;a class="lnlinks" href="#hl-28-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">passLocalCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FlowRule&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">acquireCount&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 基于限流模式判断要统计的节点， &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果是直连模式，关联模式，对ClusterNode统计，如果是链路模式，则对DefaultNode统计&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">selectedNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">selectNodeByRequesterAndStrategy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">selectedNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断规则&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rule&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getRater&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">canPass&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">selectedNode&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">acquireCount&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里对规则的判断先要通过&lt;code>FlowRule#getRater()&lt;/code>获取流量控制器&lt;code>TrafficShapingController&lt;/code>，然后再做限流。&lt;/p>
&lt;p>而&lt;code>TrafficShapingController&lt;/code>有3种实现：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-7df42e79d81531.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925175221211"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;ul>
&lt;li>DefaultController：快速失败，默认的方式，基于滑动时间窗口算法&lt;/li>
&lt;li>WarmUpController：预热模式，基于滑动时间窗口算法，只不过阈值是动态的&lt;/li>
&lt;li>RateLimiterController：排队等待模式，基于漏桶算法&lt;/li>
&lt;/ul>
&lt;p>最终的限流判断都在TrafficShapingController的canPass方法中。&lt;/p>
&lt;h3 id="292滑动时间窗口">
&lt;a href="#292%e6%bb%91%e5%8a%a8%e6%97%b6%e9%97%b4%e7%aa%97%e5%8f%a3" class="header-anchor">#&lt;/a>
2.9.2.滑动时间窗口
&lt;/h3>&lt;p>滑动时间窗口的功能分两部分来看：&lt;/p>
&lt;ul>
&lt;li>一是时间区间窗口的QPS计数功能，这个是在StatisticSlot中调用的&lt;/li>
&lt;li>二是对滑动窗口内的时间区间窗口QPS累加，这个是在FlowRule中调用的&lt;/li>
&lt;/ul>
&lt;p>先来看时间区间窗口的QPS计数功能。&lt;/p>
&lt;h4 id="2921时间窗口请求量统计">
&lt;a href="#2921%e6%97%b6%e9%97%b4%e7%aa%97%e5%8f%a3%e8%af%b7%e6%b1%82%e9%87%8f%e7%bb%9f%e8%ae%a1" class="header-anchor">#&lt;/a>
2.9.2.1.时间窗口请求量统计
&lt;/h4>&lt;p>回顾2.5章节中的StatisticSlot部分，有这样一段代码：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-adc5ecf240f576.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925180522926"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>就是在统计通过该节点的QPS，我们跟入看看，这里进入了DefaultNode内部：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-206fd0fd55ad64.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925180619492"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>发现同时对&lt;code>DefaultNode&lt;/code>和&lt;code>ClusterNode&lt;/code>在做QPS统计，我们知道&lt;code>DefaultNode&lt;/code>和&lt;code>ClusterNode&lt;/code>都是&lt;code>StatisticNode&lt;/code>的子类，这里调用&lt;code>addPassRequest()&lt;/code>方法，最终都会进入&lt;code>StatisticNode&lt;/code>中。&lt;/p>
&lt;p>随便跟入一个：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-210afc903dfd22.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925180810181"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这里有秒、分两种纬度的统计，对应两个计数器。找到对应的成员变量，可以看到：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-98445e1d695529.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925180954856"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>两个计数器都是ArrayMetric类型，并且传入了两个参数：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-29-1">&lt;a class="lnlinks" href="#hl-29-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-2">&lt;a class="lnlinks" href="#hl-29-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-3">&lt;a class="lnlinks" href="#hl-29-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-4">&lt;a class="lnlinks" href="#hl-29-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-5">&lt;a class="lnlinks" href="#hl-29-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// intervalInMs：是滑动窗口的时间间隔，默认为 1 秒&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">// sampleCount: 时间窗口的分隔数量，默认为 2，就是把 1秒分为 2个小时间窗&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">ArrayMetric&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sampleCount&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">intervalInMs&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">data&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OccupiableBucketLeapArray&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sampleCount&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">intervalInMs&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-0f5b2984bd6887.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925181359203"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>接下来，我们进入&lt;code>ArrayMetric&lt;/code>类的&lt;code>addPass&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-30-1">&lt;a class="lnlinks" href="#hl-30-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-2">&lt;a class="lnlinks" href="#hl-30-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-3">&lt;a class="lnlinks" href="#hl-30-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-4">&lt;a class="lnlinks" href="#hl-30-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-5">&lt;a class="lnlinks" href="#hl-30-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-6">&lt;a class="lnlinks" href="#hl-30-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-7">&lt;a class="lnlinks" href="#hl-30-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">addPass&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取当前时间所在的时间窗&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">WindowWrap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">MetricBucket&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">wrap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentWindow&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 计数器 +1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">wrap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">addPass&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>那么，计数器如何知道当前所在的窗口是哪个呢？&lt;/p>
&lt;p>这里的data是一个LeapArray：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-951299e9839986.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925181714605"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>LeapArray的四个属性：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-31-1">&lt;a class="lnlinks" href="#hl-31-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-2">&lt;a class="lnlinks" href="#hl-31-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-3">&lt;a class="lnlinks" href="#hl-31-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-4">&lt;a class="lnlinks" href="#hl-31-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-5">&lt;a class="lnlinks" href="#hl-31-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-6">&lt;a class="lnlinks" href="#hl-31-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-7">&lt;a class="lnlinks" href="#hl-31-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-8">&lt;a class="lnlinks" href="#hl-31-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-9">&lt;a class="lnlinks" href="#hl-31-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-10">&lt;a class="lnlinks" href="#hl-31-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">abstract&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">LeapArray&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 小窗口的时间长度，默认是500ms ，值 = intervalInMs / sampleCount&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">protected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">windowLengthInMs&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 滑动窗口内的 小窗口 数量，默认为 2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">protected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sampleCount&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 滑动窗口的时间间隔，默认为 1000ms&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">protected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">intervalInMs&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 滑动窗口的时间间隔，单位为秒，默认为 1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">double&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">intervalInSecond&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>LeapArray是一个环形数组，因为时间是无限的，数组长度不可能无限，因此数组中每一个格子放入一个时间窗（window），当数组放满后，角标归0，覆盖最初的window。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-503f2b10d20bf7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925182127206"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>因为滑动窗口最多分成sampleCount数量的小窗口，因此数组长度只要大于sampleCount，那么最近的一个滑动窗口内的2个小窗口就永远不会被覆盖，就不用担心旧数据被覆盖的问题了。&lt;/p>
&lt;p>我们跟入&lt;code> data.currentWindow();&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-32-1">&lt;a class="lnlinks" href="#hl-32-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-2">&lt;a class="lnlinks" href="#hl-32-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-3">&lt;a class="lnlinks" href="#hl-32-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-4">&lt;a class="lnlinks" href="#hl-32-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-5">&lt;a class="lnlinks" href="#hl-32-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-6">&lt;a class="lnlinks" href="#hl-32-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-7">&lt;a class="lnlinks" href="#hl-32-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-8">&lt;a class="lnlinks" href="#hl-32-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-9">&lt;a class="lnlinks" href="#hl-32-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-10">&lt;a class="lnlinks" href="#hl-32-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-11">&lt;a class="lnlinks" href="#hl-32-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-12">&lt;a class="lnlinks" href="#hl-32-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-13">&lt;a class="lnlinks" href="#hl-32-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-14">&lt;a class="lnlinks" href="#hl-32-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-15">&lt;a class="lnlinks" href="#hl-32-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-16">&lt;a class="lnlinks" href="#hl-32-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-17">&lt;a class="lnlinks" href="#hl-32-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-18">&lt;a class="lnlinks" href="#hl-32-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-19">&lt;a class="lnlinks" href="#hl-32-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-20">&lt;a class="lnlinks" href="#hl-32-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-21">&lt;a class="lnlinks" href="#hl-32-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-22">&lt;a class="lnlinks" href="#hl-32-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-23">&lt;a class="lnlinks" href="#hl-32-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-24">&lt;a class="lnlinks" href="#hl-32-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-25">&lt;a class="lnlinks" href="#hl-32-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-26">&lt;a class="lnlinks" href="#hl-32-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-27">&lt;a class="lnlinks" href="#hl-32-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-28">&lt;a class="lnlinks" href="#hl-32-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-29">&lt;a class="lnlinks" href="#hl-32-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-30">&lt;a class="lnlinks" href="#hl-32-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-31">&lt;a class="lnlinks" href="#hl-32-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-32">&lt;a class="lnlinks" href="#hl-32-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-33">&lt;a class="lnlinks" href="#hl-32-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-34">&lt;a class="lnlinks" href="#hl-32-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-35">&lt;a class="lnlinks" href="#hl-32-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-36">&lt;a class="lnlinks" href="#hl-32-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-37">&lt;a class="lnlinks" href="#hl-32-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-38">&lt;a class="lnlinks" href="#hl-32-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-39">&lt;a class="lnlinks" href="#hl-32-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-40">&lt;a class="lnlinks" href="#hl-32-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-41">&lt;a class="lnlinks" href="#hl-32-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-42">&lt;a class="lnlinks" href="#hl-32-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-43">&lt;a class="lnlinks" href="#hl-32-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-44">&lt;a class="lnlinks" href="#hl-32-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-45">&lt;a class="lnlinks" href="#hl-32-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-46">&lt;a class="lnlinks" href="#hl-32-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-47">&lt;a class="lnlinks" href="#hl-32-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-48">&lt;a class="lnlinks" href="#hl-32-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-49">&lt;a class="lnlinks" href="#hl-32-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-50">&lt;a class="lnlinks" href="#hl-32-50">50&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WindowWrap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">currentWindow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">timeMillis&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timeMillis&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 计算当前时间对应的数组角标&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">idx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">calculateTimeIdx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timeMillis&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 计算当前时间所在窗口的开始时间.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">windowStart&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">calculateWindowStart&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timeMillis&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 先根据角标获取数组中保存的 oldWindow 对象，可能是旧数据，需要判断.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * (1) oldWindow 不存在, 说明是第一次，创建新 window并存入，然后返回即可
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * (2) oldWindow的 starTime = 本次请求的 windowStar, 说明正是要找的窗口，直接返回.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * (3) oldWindow的 starTime &amp;lt; 本次请求的 windowStar, 说明是旧数据，需要被覆盖，创建
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 新窗口，覆盖旧窗口
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">while&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">WindowWrap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">old&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">idx&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">old&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建新 window&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">WindowWrap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">window&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WindowWrap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">windowLengthInMs&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">windowStart&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">newEmptyBucket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timeMillis&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 基于CAS写入数组，避免线程安全问题&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">compareAndSet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">idx&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">window&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 写入成功，返回新的 window&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">window&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 写入失败，说明有并发更新，等待其它人更新完成即可&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">yield&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">windowStart&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">old&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">windowStart&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">old&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">windowStart&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">old&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">windowStart&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">updateLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">tryLock&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取并发锁，覆盖旧窗口并返回&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resetWindowTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">old&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">windowStart&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">finally&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">updateLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">unlock&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取锁失败，等待其它线程处理就可以了&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">yield&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">windowStart&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">old&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">windowStart&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 这种情况不应该存在，写这里只是以防万一。&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WindowWrap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">windowLengthInMs&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">windowStart&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">newEmptyBucket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timeMillis&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>找到当前时间所在窗口（WindowWrap）后，只要调用WindowWrap对象中的add方法，计数器+1即可。&lt;/p>
&lt;p>这里只负责统计每个窗口的请求量，不负责拦截。限流拦截要看FlowSlot中的逻辑。&lt;/p>
&lt;h4 id="2922滑动窗口qps计算">
&lt;a href="#2922%e6%bb%91%e5%8a%a8%e7%aa%97%e5%8f%a3qps%e8%ae%a1%e7%ae%97" class="header-anchor">#&lt;/a>
2.9.2.2.滑动窗口QPS计算
&lt;/h4>&lt;p>在2.9.1小节我们讲过，FlowSlot的限流判断最终都由&lt;code>TrafficShapingController&lt;/code>接口中的&lt;code>canPass&lt;/code>方法来实现。该接口有三个实现类：&lt;/p>
&lt;ul>
&lt;li>DefaultController：快速失败，默认的方式，基于滑动时间窗口算法&lt;/li>
&lt;li>WarmUpController：预热模式，基于滑动时间窗口算法，只不过阈值是动态的&lt;/li>
&lt;li>RateLimiterController：排队等待模式，基于漏桶算法&lt;/li>
&lt;/ul>
&lt;p>因此，我们跟入默认的DefaultController中的canPass方法来分析：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-33-1">&lt;a class="lnlinks" href="#hl-33-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-2">&lt;a class="lnlinks" href="#hl-33-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-3">&lt;a class="lnlinks" href="#hl-33-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-4">&lt;a class="lnlinks" href="#hl-33-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-5">&lt;a class="lnlinks" href="#hl-33-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-6">&lt;a class="lnlinks" href="#hl-33-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-7">&lt;a class="lnlinks" href="#hl-33-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-8">&lt;a class="lnlinks" href="#hl-33-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-9">&lt;a class="lnlinks" href="#hl-33-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-10">&lt;a class="lnlinks" href="#hl-33-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-11">&lt;a class="lnlinks" href="#hl-33-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-12">&lt;a class="lnlinks" href="#hl-33-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-13">&lt;a class="lnlinks" href="#hl-33-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-14">&lt;a class="lnlinks" href="#hl-33-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-15">&lt;a class="lnlinks" href="#hl-33-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-16">&lt;a class="lnlinks" href="#hl-33-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-17">&lt;a class="lnlinks" href="#hl-33-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-18">&lt;a class="lnlinks" href="#hl-33-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-19">&lt;a class="lnlinks" href="#hl-33-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-20">&lt;a class="lnlinks" href="#hl-33-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-21">&lt;a class="lnlinks" href="#hl-33-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-22">&lt;a class="lnlinks" href="#hl-33-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-23">&lt;a class="lnlinks" href="#hl-33-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-24">&lt;a class="lnlinks" href="#hl-33-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-25">&lt;a class="lnlinks" href="#hl-33-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-26">&lt;a class="lnlinks" href="#hl-33-26">26&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">canPass&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">acquireCount&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 计算目前为止滑动窗口内已经存在的请求量&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">curCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">avgUsedTokens&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断：已使用请求量 + 需要的请求量（1） 是否大于 窗口的请求阈值&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">curCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">acquireCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 大于，说明超出阈值，返回false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">grade&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuleConstant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">FLOW_GRADE_QPS&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">currentTime&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">waitInMs&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">currentTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TimeUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">waitInMs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">tryOccupyNext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentTime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">acquireCount&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">waitInMs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OccupyTimeoutProperty&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getOccupyTimeout&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addWaitingRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">waitInMs&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">acquireCount&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addOccupiedPass&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">acquireCount&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">waitInMs&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// PriorityWaitException indicates that the request will pass after waiting for {@link @waitInMs}.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PriorityWaitException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">waitInMs&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 小于等于，说明在阈值范围内，返回true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>因此，判断的关键就是&lt;code>int curCount = avgUsedTokens(node);&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-34-1">&lt;a class="lnlinks" href="#hl-34-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-2">&lt;a class="lnlinks" href="#hl-34-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-3">&lt;a class="lnlinks" href="#hl-34-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-4">&lt;a class="lnlinks" href="#hl-34-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-5">&lt;a class="lnlinks" href="#hl-34-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-6">&lt;a class="lnlinks" href="#hl-34-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">avgUsedTokens&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DEFAULT_AVG_USED_TOKENS&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">grade&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuleConstant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">FLOW_GRADE_THREAD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">curThreadNum&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">passQps&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>因为我们采用的是限流，走&lt;code>node.passQps()&lt;/code>逻辑：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-35-1">&lt;a class="lnlinks" href="#hl-35-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-2">&lt;a class="lnlinks" href="#hl-35-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-3">&lt;a class="lnlinks" href="#hl-35-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-4">&lt;a class="lnlinks" href="#hl-35-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-5">&lt;a class="lnlinks" href="#hl-35-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-6">&lt;a class="lnlinks" href="#hl-35-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 这里又进入了 StatisticNode类&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">double&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">passQps&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 请求量 ÷ 滑动窗口时间间隔 ，得到的就是QPS&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rollingCounterInSecond&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">pass&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rollingCounterInSecond&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getWindowIntervalInSec&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>那么&lt;code>rollingCounterInSecond.pass()&lt;/code>是如何得到请求量的呢？&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-36-1">&lt;a class="lnlinks" href="#hl-36-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-2">&lt;a class="lnlinks" href="#hl-36-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-3">&lt;a class="lnlinks" href="#hl-36-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-4">&lt;a class="lnlinks" href="#hl-36-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-5">&lt;a class="lnlinks" href="#hl-36-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-6">&lt;a class="lnlinks" href="#hl-36-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-7">&lt;a class="lnlinks" href="#hl-36-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-8">&lt;a class="lnlinks" href="#hl-36-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-9">&lt;a class="lnlinks" href="#hl-36-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-10">&lt;a class="lnlinks" href="#hl-36-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-11">&lt;a class="lnlinks" href="#hl-36-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-12">&lt;a class="lnlinks" href="#hl-36-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-13">&lt;a class="lnlinks" href="#hl-36-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-14">&lt;a class="lnlinks" href="#hl-36-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-15">&lt;a class="lnlinks" href="#hl-36-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-16">&lt;a class="lnlinks" href="#hl-36-16">16&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// rollingCounterInSecond 本质是ArrayMetric，之前说过&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">pass&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取当前窗口&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentWindow&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pass&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取 当前时间的 滑动窗口范围内 的所有小窗口&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">MetricBucket&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">values&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 遍历&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">MetricBucket&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">window&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 累加求和&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">pass&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">window&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">pass&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 返回&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pass&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>来看看&lt;code>data.values()&lt;/code>如何获取 滑动窗口范围内 的所有小窗口：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-37-1">&lt;a class="lnlinks" href="#hl-37-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-2">&lt;a class="lnlinks" href="#hl-37-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-3">&lt;a class="lnlinks" href="#hl-37-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-4">&lt;a class="lnlinks" href="#hl-37-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-5">&lt;a class="lnlinks" href="#hl-37-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-6">&lt;a class="lnlinks" href="#hl-37-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-7">&lt;a class="lnlinks" href="#hl-37-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-8">&lt;a class="lnlinks" href="#hl-37-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-9">&lt;a class="lnlinks" href="#hl-37-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-10">&lt;a class="lnlinks" href="#hl-37-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-11">&lt;a class="lnlinks" href="#hl-37-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-12">&lt;a class="lnlinks" href="#hl-37-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-13">&lt;a class="lnlinks" href="#hl-37-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-14">&lt;a class="lnlinks" href="#hl-37-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-15">&lt;a class="lnlinks" href="#hl-37-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-16">&lt;a class="lnlinks" href="#hl-37-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-17">&lt;a class="lnlinks" href="#hl-37-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-18">&lt;a class="lnlinks" href="#hl-37-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-19">&lt;a class="lnlinks" href="#hl-37-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-20">&lt;a class="lnlinks" href="#hl-37-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-21">&lt;a class="lnlinks" href="#hl-37-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-22">&lt;a class="lnlinks" href="#hl-37-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-23">&lt;a class="lnlinks" href="#hl-37-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-24">&lt;a class="lnlinks" href="#hl-37-24">24&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 此处进入LeapArray类中：&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">values&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">timeMillis&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timeMillis&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 创建空集合，大小等于 LeapArray长度&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">length&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 遍历 LeapArray&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取每一个小窗口&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">WindowWrap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">windowWrap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断这个小窗口是否在 滑动窗口时间范围内（1秒内）&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">windowWrap&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">||&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">isWindowDeprecated&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timeMillis&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">windowWrap&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 不在范围内，则跳过&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 在范围内，则添加到集合中&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">windowWrap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 返回集合&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>那么，&lt;code>isWindowDeprecated(timeMillis, windowWrap)&lt;/code>又是如何判断窗口是否符合要求呢？&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-38-1">&lt;a class="lnlinks" href="#hl-38-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-2">&lt;a class="lnlinks" href="#hl-38-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-3">&lt;a class="lnlinks" href="#hl-38-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-4">&lt;a class="lnlinks" href="#hl-38-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-5">&lt;a class="lnlinks" href="#hl-38-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">isWindowDeprecated&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WindowWrap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">windowWrap&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 当前时间 - 窗口开始时间 是否大于 滑动窗口的最大间隔（1秒）&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 也就是说，我们要统计的时 距离当前时间1秒内的 小窗口的 count之和&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">windowWrap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">windowStart&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">intervalInMs&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="293漏桶">
&lt;a href="#293%e6%bc%8f%e6%a1%b6" class="header-anchor">#&lt;/a>
2.9.3.漏桶
&lt;/h3>&lt;p>上一节我们讲过，FlowSlot的限流判断最终都由&lt;code>TrafficShapingController&lt;/code>接口中的&lt;code>canPass&lt;/code>方法来实现。该接口有三个实现类：&lt;/p>
&lt;ul>
&lt;li>DefaultController：快速失败，默认的方式，基于滑动时间窗口算法&lt;/li>
&lt;li>WarmUpController：预热模式，基于滑动时间窗口算法，只不过阈值是动态的&lt;/li>
&lt;li>RateLimiterController：排队等待模式，基于漏桶算法&lt;/li>
&lt;/ul>
&lt;p>因此，我们跟入默认的RateLimiterController中的canPass方法来分析：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-39-1">&lt;a class="lnlinks" href="#hl-39-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-2">&lt;a class="lnlinks" href="#hl-39-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-3">&lt;a class="lnlinks" href="#hl-39-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-4">&lt;a class="lnlinks" href="#hl-39-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-5">&lt;a class="lnlinks" href="#hl-39-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-6">&lt;a class="lnlinks" href="#hl-39-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-7">&lt;a class="lnlinks" href="#hl-39-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-8">&lt;a class="lnlinks" href="#hl-39-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-9">&lt;a class="lnlinks" href="#hl-39-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-10">&lt;a class="lnlinks" href="#hl-39-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-11">&lt;a class="lnlinks" href="#hl-39-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-12">&lt;a class="lnlinks" href="#hl-39-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-13">&lt;a class="lnlinks" href="#hl-39-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-14">&lt;a class="lnlinks" href="#hl-39-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-15">&lt;a class="lnlinks" href="#hl-39-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-16">&lt;a class="lnlinks" href="#hl-39-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-17">&lt;a class="lnlinks" href="#hl-39-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-18">&lt;a class="lnlinks" href="#hl-39-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-19">&lt;a class="lnlinks" href="#hl-39-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-20">&lt;a class="lnlinks" href="#hl-39-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-21">&lt;a class="lnlinks" href="#hl-39-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-22">&lt;a class="lnlinks" href="#hl-39-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-23">&lt;a class="lnlinks" href="#hl-39-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-24">&lt;a class="lnlinks" href="#hl-39-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-25">&lt;a class="lnlinks" href="#hl-39-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-26">&lt;a class="lnlinks" href="#hl-39-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-27">&lt;a class="lnlinks" href="#hl-39-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-28">&lt;a class="lnlinks" href="#hl-39-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-29">&lt;a class="lnlinks" href="#hl-39-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-30">&lt;a class="lnlinks" href="#hl-39-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-31">&lt;a class="lnlinks" href="#hl-39-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-32">&lt;a class="lnlinks" href="#hl-39-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-33">&lt;a class="lnlinks" href="#hl-39-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-34">&lt;a class="lnlinks" href="#hl-39-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-35">&lt;a class="lnlinks" href="#hl-39-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-36">&lt;a class="lnlinks" href="#hl-39-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-37">&lt;a class="lnlinks" href="#hl-39-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-38">&lt;a class="lnlinks" href="#hl-39-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-39">&lt;a class="lnlinks" href="#hl-39-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-40">&lt;a class="lnlinks" href="#hl-39-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-41">&lt;a class="lnlinks" href="#hl-39-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-42">&lt;a class="lnlinks" href="#hl-39-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-43">&lt;a class="lnlinks" href="#hl-39-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-44">&lt;a class="lnlinks" href="#hl-39-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-45">&lt;a class="lnlinks" href="#hl-39-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-46">&lt;a class="lnlinks" href="#hl-39-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-47">&lt;a class="lnlinks" href="#hl-39-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-48">&lt;a class="lnlinks" href="#hl-39-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-49">&lt;a class="lnlinks" href="#hl-39-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-50">&lt;a class="lnlinks" href="#hl-39-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-51">&lt;a class="lnlinks" href="#hl-39-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-52">&lt;a class="lnlinks" href="#hl-39-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-39-53">&lt;a class="lnlinks" href="#hl-39-53">53&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">canPass&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Node&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">acquireCount&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// Pass when acquire count is less or equal than 0.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">acquireCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 阈值小于等于 0 ，阻止请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取当前时间&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">currentTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TimeUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 计算两次请求之间允许的最小时间间隔&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">costTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">acquireCount&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1000&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 计算本次请求 允许执行的时间点 = 最近一次请求的可执行时间 + 两次请求的最小间隔&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">expectedTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">costTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">latestPassedTime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果允许执行的时间点小于当前时间，说明可以立即执行&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">expectedTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">currentTime&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 更新上一次的请求的执行时间&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">latestPassedTime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentTime&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 不能立即执行，需要计算 预期等待时长&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 预期等待时长 = 两次请求的最小间隔 +最近一次请求的可执行时间 - 当前时间&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">waitTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">costTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">latestPassedTime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TimeUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果预期等待时间超出阈值，则拒绝请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">waitTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">maxQueueingTimeMs&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 预期等待时间小于阈值，更新最近一次请求的可执行时间，加上costTime&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">latestPassedTime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addAndGet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">costTime&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 保险起见，再判断一次预期等待时间，是否超过阈值&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">waitTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oldTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TimeUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">waitTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">maxQueueingTimeMs&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果超过，则把刚才 加 的时间再 减回来&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">latestPassedTime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addAndGet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">costTime&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 拒绝&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// in race condition waitTime may &amp;lt;= 0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">waitTime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 预期等待时间在阈值范围内，休眠要等待的时间，醒来后继续执行&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">waitTime&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">InterruptedException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>与我们之前分析的漏桶算法基本一致：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-a36a1c234566f7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925210716675"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="210degradeslot">
&lt;a href="#210degradeslot" class="header-anchor">#&lt;/a>
2.10.DegradeSlot
&lt;/h2>&lt;p>最后一关，就是降级规则判断了。&lt;/p>
&lt;p>Sentinel的降级是基于状态机来实现的：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-cc085e7f4c5020.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925211020881"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>对应的实现在DegradeSlot类中，核心API：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-40-1">&lt;a class="lnlinks" href="#hl-40-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-2">&lt;a class="lnlinks" href="#hl-40-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-3">&lt;a class="lnlinks" href="#hl-40-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-4">&lt;a class="lnlinks" href="#hl-40-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-5">&lt;a class="lnlinks" href="#hl-40-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-6">&lt;a class="lnlinks" href="#hl-40-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-7">&lt;a class="lnlinks" href="#hl-40-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-40-8">&lt;a class="lnlinks" href="#hl-40-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultNode&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 熔断降级规则判断&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">performChecking&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 继续下一个slot&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">fireEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">resourceWrapper&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prioritized&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>继续进入&lt;code>performChecking&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-41-1">&lt;a class="lnlinks" href="#hl-41-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-2">&lt;a class="lnlinks" href="#hl-41-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-3">&lt;a class="lnlinks" href="#hl-41-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-4">&lt;a class="lnlinks" href="#hl-41-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-5">&lt;a class="lnlinks" href="#hl-41-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-6">&lt;a class="lnlinks" href="#hl-41-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-7">&lt;a class="lnlinks" href="#hl-41-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-8">&lt;a class="lnlinks" href="#hl-41-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-9">&lt;a class="lnlinks" href="#hl-41-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-10">&lt;a class="lnlinks" href="#hl-41-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-11">&lt;a class="lnlinks" href="#hl-41-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-12">&lt;a class="lnlinks" href="#hl-41-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-41-13">&lt;a class="lnlinks" href="#hl-41-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">performChecking&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ResourceWrapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取当前资源上的所有的断路器 CircuitBreaker&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">CircuitBreaker&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">circuitBreakers&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DegradeRuleManager&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCircuitBreakers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">circuitBreakers&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">||&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">circuitBreakers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CircuitBreaker&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cb&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">circuitBreakers&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 遍历断路器，逐个判断&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">cb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">tryPass&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DegradeException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getRule&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getLimitApp&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getRule&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2101circuitbreaker">
&lt;a href="#2101circuitbreaker" class="header-anchor">#&lt;/a>
2.10.1.CircuitBreaker
&lt;/h3>&lt;p>我们进入CircuitBreaker的tryPass方法中：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-42-1">&lt;a class="lnlinks" href="#hl-42-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-2">&lt;a class="lnlinks" href="#hl-42-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-3">&lt;a class="lnlinks" href="#hl-42-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-4">&lt;a class="lnlinks" href="#hl-42-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-5">&lt;a class="lnlinks" href="#hl-42-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-6">&lt;a class="lnlinks" href="#hl-42-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-7">&lt;a class="lnlinks" href="#hl-42-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-8">&lt;a class="lnlinks" href="#hl-42-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-9">&lt;a class="lnlinks" href="#hl-42-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-10">&lt;a class="lnlinks" href="#hl-42-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-11">&lt;a class="lnlinks" href="#hl-42-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-12">&lt;a class="lnlinks" href="#hl-42-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-13">&lt;a class="lnlinks" href="#hl-42-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-14">&lt;a class="lnlinks" href="#hl-42-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-42-15">&lt;a class="lnlinks" href="#hl-42-15">15&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">tryPass&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断状态机状态&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentState&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CLOSED&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果是closed状态，直接放行&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentState&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">OPEN&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果是OPEN状态，断路器打开&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 继续判断OPEN时间窗是否结束，如果是则把状态从OPEN切换到 HALF_OPEN，返回true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">retryTimeoutArrived&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">fromOpenToHalfOpen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// OPEN状态，并且时间窗未到，返回false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>有关时间窗的判断在&lt;code>retryTimeoutArrived()&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-43-1">&lt;a class="lnlinks" href="#hl-43-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-2">&lt;a class="lnlinks" href="#hl-43-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-3">&lt;a class="lnlinks" href="#hl-43-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-43-4">&lt;a class="lnlinks" href="#hl-43-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">protected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">retryTimeoutArrived&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 当前时间 大于 下一次 HalfOpen的重试时间&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TimeUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentTimeMillis&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">nextRetryTimestamp&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>OPEN到HALF_OPEN切换在&lt;code>fromOpenToHalfOpen(context)&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-44-1">&lt;a class="lnlinks" href="#hl-44-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-2">&lt;a class="lnlinks" href="#hl-44-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-3">&lt;a class="lnlinks" href="#hl-44-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-4">&lt;a class="lnlinks" href="#hl-44-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-5">&lt;a class="lnlinks" href="#hl-44-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-6">&lt;a class="lnlinks" href="#hl-44-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-7">&lt;a class="lnlinks" href="#hl-44-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-8">&lt;a class="lnlinks" href="#hl-44-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-9">&lt;a class="lnlinks" href="#hl-44-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-10">&lt;a class="lnlinks" href="#hl-44-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-11">&lt;a class="lnlinks" href="#hl-44-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-12">&lt;a class="lnlinks" href="#hl-44-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-13">&lt;a class="lnlinks" href="#hl-44-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-14">&lt;a class="lnlinks" href="#hl-44-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-15">&lt;a class="lnlinks" href="#hl-44-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-16">&lt;a class="lnlinks" href="#hl-44-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-17">&lt;a class="lnlinks" href="#hl-44-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-18">&lt;a class="lnlinks" href="#hl-44-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-19">&lt;a class="lnlinks" href="#hl-44-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-20">&lt;a class="lnlinks" href="#hl-44-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-21">&lt;a class="lnlinks" href="#hl-44-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-22">&lt;a class="lnlinks" href="#hl-44-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-44-23">&lt;a class="lnlinks" href="#hl-44-23">23&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">protected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">fromOpenToHalfOpen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 基于CAS修改状态，从 OPEN到 HALF_OPEN&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentState&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">compareAndSet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">OPEN&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HALF_OPEN&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 状态变更的事件通知&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">notifyObservers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">OPEN&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HALF_OPEN&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 得到当前资源&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCurEntry&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 给资源设置监听器，在资源Entry销毁时（资源业务执行完毕时）触发&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">whenTerminate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BiConsumer&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">accept&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断 资源业务是否异常&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBlockError&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果异常，则再次进入OPEN状态&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">currentState&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">compareAndSet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HALF_OPEN&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">OPEN&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">notifyObservers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HALF_OPEN&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">OPEN&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">0d&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">});&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里出现了从OPEN到HALF_OPEN、从HALF_OPEN到OPEN的变化，但是还有几个没有：&lt;/p>
&lt;ul>
&lt;li>从CLOSED到OPEN&lt;/li>
&lt;li>从HALF_OPEN到CLOSED&lt;/li>
&lt;/ul>
&lt;h3 id="2102触发断路器">
&lt;a href="#2102%e8%a7%a6%e5%8f%91%e6%96%ad%e8%b7%af%e5%99%a8" class="header-anchor">#&lt;/a>
2.10.2.触发断路器
&lt;/h3>&lt;p>请求经过所有插槽 后，一定会执行exit方法，而在DegradeSlot的exit方法中：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-61a74bda5229a6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925213440686"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>会调用CircuitBreaker的onRequestComplete方法。而CircuitBreaker有两个实现：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739179-79627dec2c50f5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925213939035"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们这里以异常比例熔断为例来看，进入&lt;code>ExceptionCircuitBreaker&lt;/code>的&lt;code>onRequestComplete&lt;/code>方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-45-1">&lt;a class="lnlinks" href="#hl-45-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-2">&lt;a class="lnlinks" href="#hl-45-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-3">&lt;a class="lnlinks" href="#hl-45-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-4">&lt;a class="lnlinks" href="#hl-45-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-5">&lt;a class="lnlinks" href="#hl-45-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-6">&lt;a class="lnlinks" href="#hl-45-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-7">&lt;a class="lnlinks" href="#hl-45-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-8">&lt;a class="lnlinks" href="#hl-45-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-9">&lt;a class="lnlinks" href="#hl-45-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-10">&lt;a class="lnlinks" href="#hl-45-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-11">&lt;a class="lnlinks" href="#hl-45-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-12">&lt;a class="lnlinks" href="#hl-45-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-13">&lt;a class="lnlinks" href="#hl-45-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-14">&lt;a class="lnlinks" href="#hl-45-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-15">&lt;a class="lnlinks" href="#hl-45-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-16">&lt;a class="lnlinks" href="#hl-45-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-17">&lt;a class="lnlinks" href="#hl-45-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-18">&lt;a class="lnlinks" href="#hl-45-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-19">&lt;a class="lnlinks" href="#hl-45-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-45-20">&lt;a class="lnlinks" href="#hl-45-20">20&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">onRequestComplete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取资源 Entry&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCurEntry&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 尝试获取 资源中的 异常&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getError&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取计数器，同样采用了滑动窗口来计数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SimpleErrorCounter&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">counter&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">currentWindow&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果出现异常，则 error计数器 +1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">counter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getErrorCount&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 不管是否出现异常，total计数器 +1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">counter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getTotalCount&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断异常比例是否超出阈值&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">handleStateChangeWhenThresholdExceeded&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>来看阈值判断的方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-46-1">&lt;a class="lnlinks" href="#hl-46-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-2">&lt;a class="lnlinks" href="#hl-46-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-3">&lt;a class="lnlinks" href="#hl-46-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-4">&lt;a class="lnlinks" href="#hl-46-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-5">&lt;a class="lnlinks" href="#hl-46-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-6">&lt;a class="lnlinks" href="#hl-46-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-7">&lt;a class="lnlinks" href="#hl-46-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-8">&lt;a class="lnlinks" href="#hl-46-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-9">&lt;a class="lnlinks" href="#hl-46-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-10">&lt;a class="lnlinks" href="#hl-46-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-11">&lt;a class="lnlinks" href="#hl-46-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-12">&lt;a class="lnlinks" href="#hl-46-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-13">&lt;a class="lnlinks" href="#hl-46-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-14">&lt;a class="lnlinks" href="#hl-46-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-15">&lt;a class="lnlinks" href="#hl-46-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-16">&lt;a class="lnlinks" href="#hl-46-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-17">&lt;a class="lnlinks" href="#hl-46-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-18">&lt;a class="lnlinks" href="#hl-46-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-19">&lt;a class="lnlinks" href="#hl-46-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-20">&lt;a class="lnlinks" href="#hl-46-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-21">&lt;a class="lnlinks" href="#hl-46-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-22">&lt;a class="lnlinks" href="#hl-46-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-23">&lt;a class="lnlinks" href="#hl-46-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-24">&lt;a class="lnlinks" href="#hl-46-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-25">&lt;a class="lnlinks" href="#hl-46-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-26">&lt;a class="lnlinks" href="#hl-46-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-27">&lt;a class="lnlinks" href="#hl-46-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-28">&lt;a class="lnlinks" href="#hl-46-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-29">&lt;a class="lnlinks" href="#hl-46-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-30">&lt;a class="lnlinks" href="#hl-46-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-31">&lt;a class="lnlinks" href="#hl-46-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-32">&lt;a class="lnlinks" href="#hl-46-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-33">&lt;a class="lnlinks" href="#hl-46-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-34">&lt;a class="lnlinks" href="#hl-46-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-35">&lt;a class="lnlinks" href="#hl-46-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-36">&lt;a class="lnlinks" href="#hl-46-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-37">&lt;a class="lnlinks" href="#hl-46-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-38">&lt;a class="lnlinks" href="#hl-46-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-46-39">&lt;a class="lnlinks" href="#hl-46-39">39&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">handleStateChangeWhenThresholdExceeded&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果当前已经是OPEN状态，不做处理&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentState&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">OPEN&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果已经是 HALF_OPEN 状态，判断是否需求切换状态&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">currentState&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HALF_OPEN&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 没有异常，则从 HALF_OPEN 到 CLOSED&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">fromHalfOpenToClose&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 有一次，再次进入OPEN&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">fromHalfOpenToOpen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">0d&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 说明当前是CLOSE状态，需要判断是否触发阈值&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">SimpleErrorCounter&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">counters&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">stat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">values&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">errCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">totalCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 累加计算 异常请求数量、总请求数量&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SimpleErrorCounter&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">counter&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">counters&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">errCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">counter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">errorCount&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">sum&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">totalCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">counter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">totalCount&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">sum&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果总请求数量未达到阈值，什么都不做&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">totalCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">minRequestAmount&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">double&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">curCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">errCount&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">strategy&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DEGRADE_GRADE_EXCEPTION_RATIO&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 计算请求的异常比例&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">curCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">errCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">0d&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">totalCount&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 如果比例超过阈值，切换到 OPEN&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">curCount&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">threshold&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">transformToOpen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">curCount&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>15.微服务常见面试题</title><link>https://logan.wssw.fun/p/2023/01/51178k51/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/51178k51/</guid><description>&lt;h1 id="常见面试题">
&lt;a href="#%e5%b8%b8%e8%a7%81%e9%9d%a2%e8%af%95%e9%a2%98" class="header-anchor">#&lt;/a>
常见面试题
&lt;/h1>&lt;h1 id="1微服务篇">
&lt;a href="#1%e5%be%ae%e6%9c%8d%e5%8a%a1%e7%af%87" class="header-anchor">#&lt;/a>
1.微服务篇
&lt;/h1>&lt;h2 id="11springcloud常见组件有哪些">
&lt;a href="#11springcloud%e5%b8%b8%e8%a7%81%e7%bb%84%e4%bb%b6%e6%9c%89%e5%93%aa%e4%ba%9b" class="header-anchor">#&lt;/a>
1.1.SpringCloud常见组件有哪些？
&lt;/h2>&lt;p>&lt;strong>问题说明&lt;/strong>：这个题目主要考察对SpringCloud的组件基本了解&lt;/p>
&lt;p>&lt;strong>难易程度&lt;/strong>：简单&lt;/p>
&lt;p>&lt;strong>参考话术&lt;/strong>：&lt;/p>
&lt;p>SpringCloud包含的组件很多，有很多功能是重复的。其中最常用组件包括：&lt;/p>
&lt;p>•注册中心组件：Eureka、Nacos等&lt;/p>
&lt;p>•负载均衡组件：Ribbon&lt;/p>
&lt;p>•远程调用组件：OpenFeign&lt;/p>
&lt;p>•网关组件：Zuul、Gateway&lt;/p>
&lt;p>•服务保护组件：Hystrix、Sentinel&lt;/p>
&lt;p>•服务配置管理组件：SpringCloudConfig、Nacos&lt;/p>
&lt;h2 id="12nacos的服务注册表结构是怎样的">
&lt;a href="#12nacos%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e8%a1%a8%e7%bb%93%e6%9e%84%e6%98%af%e6%80%8e%e6%a0%b7%e7%9a%84" class="header-anchor">#&lt;/a>
1.2.Nacos的服务注册表结构是怎样的？
&lt;/h2>&lt;p>&lt;strong>问题说明&lt;/strong>：考察对Nacos数据分级结构的了解，以及Nacos源码的掌握情况&lt;/p>
&lt;p>&lt;strong>难易程度&lt;/strong>：一般&lt;/p>
&lt;p>&lt;strong>参考话术&lt;/strong>：&lt;/p>
&lt;p>Nacos采用了数据的分级存储模型，最外层是Namespace，用来隔离环境。然后是Group，用来对服务分组。接下来就是服务（Service）了，一个服务包含多个实例，但是可能处于不同机房，因此Service下有多个集群（Cluster），Cluster下是不同的实例（Instance）。&lt;/p>
&lt;p>对应到Java代码中，Nacos采用了一个多层的Map来表示。结构为Map&amp;lt;String, Map&amp;lt;String, Service&amp;raquo;，其中最外层Map的key就是namespaceId，值是一个Map。内层Map的key是group拼接serviceName，值是Service对象。Service对象内部又是一个Map，key是集群名称，值是Cluster对象。而Cluster对象内部维护了Instance的集合。&lt;/p>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739030-2d6c1270085eb6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925215305446"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="13nacos如何支撑阿里内部数十万服务注册压力">
&lt;a href="#13nacos%e5%a6%82%e4%bd%95%e6%94%af%e6%92%91%e9%98%bf%e9%87%8c%e5%86%85%e9%83%a8%e6%95%b0%e5%8d%81%e4%b8%87%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e5%8e%8b%e5%8a%9b" class="header-anchor">#&lt;/a>
1.3.Nacos如何支撑阿里内部数十万服务注册压力？
&lt;/h2>&lt;p>&lt;strong>问题说明&lt;/strong>：考察对Nacos源码的掌握情况&lt;/p>
&lt;p>&lt;strong>难易程度&lt;/strong>：难&lt;/p>
&lt;p>&lt;strong>参考话术&lt;/strong>：&lt;/p>
&lt;p>Nacos内部接收到注册的请求时，不会立即写数据，而是将服务注册的任务放入一个阻塞队列就立即响应给客户端。然后利用线程池读取阻塞队列中的任务，异步来完成实例更新，从而提高并发写能力。&lt;/p>
&lt;h2 id="14nacos如何避免并发读写冲突问题">
&lt;a href="#14nacos%e5%a6%82%e4%bd%95%e9%81%bf%e5%85%8d%e5%b9%b6%e5%8f%91%e8%af%bb%e5%86%99%e5%86%b2%e7%aa%81%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
1.4.Nacos如何避免并发读写冲突问题？
&lt;/h2>&lt;p>&lt;strong>问题说明&lt;/strong>：考察对Nacos源码的掌握情况&lt;/p>
&lt;p>&lt;strong>难易程度&lt;/strong>：难&lt;/p>
&lt;p>&lt;strong>参考话术&lt;/strong>：&lt;/p>
&lt;p>Nacos在更新实例列表时，会采用CopyOnWrite技术，首先将旧的实例列表拷贝一份，然后更新拷贝的实例列表，再用更新后的实例列表来覆盖旧的实例列表。&lt;/p>
&lt;p>这样在更新的过程中，就不会对读实例列表的请求产生影响，也不会出现脏读问题了。&lt;/p>
&lt;h2 id="15nacos与eureka的区别有哪些">
&lt;a href="#15nacos%e4%b8%8eeureka%e7%9a%84%e5%8c%ba%e5%88%ab%e6%9c%89%e5%93%aa%e4%ba%9b" class="header-anchor">#&lt;/a>
1.5.Nacos与Eureka的区别有哪些？
&lt;/h2>&lt;p>&lt;strong>问题说明&lt;/strong>：考察对Nacos、Eureka的底层实现的掌握情况&lt;/p>
&lt;p>&lt;strong>难易程度&lt;/strong>：难&lt;/p>
&lt;p>&lt;strong>参考话术&lt;/strong>：&lt;/p>
&lt;p>Nacos与Eureka有相同点，也有不同之处，可以从以下几点来描述：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>接口方式&lt;/strong>：Nacos与Eureka都对外暴露了Rest风格的API接口，用来实现服务注册、发现等功能&lt;/li>
&lt;li>&lt;strong>实例类型&lt;/strong>：Nacos的实例有永久和临时实例之分；而Eureka只支持临时实例&lt;/li>
&lt;li>&lt;strong>健康检测&lt;/strong>：Nacos对临时实例采用心跳模式检测，对永久实例采用主动请求来检测；Eureka只支持心跳模式&lt;/li>
&lt;li>&lt;strong>服务发现&lt;/strong>：Nacos支持定时拉取和订阅推送两种模式；Eureka只支持定时拉取模式&lt;/li>
&lt;/ul>
&lt;h2 id="16sentinel的限流与gateway的限流有什么差别">
&lt;a href="#16sentinel%e7%9a%84%e9%99%90%e6%b5%81%e4%b8%8egateway%e7%9a%84%e9%99%90%e6%b5%81%e6%9c%89%e4%bb%80%e4%b9%88%e5%b7%ae%e5%88%ab" class="header-anchor">#&lt;/a>
1.6.Sentinel的限流与Gateway的限流有什么差别？
&lt;/h2>&lt;p>&lt;strong>问题说明&lt;/strong>：考察对限流算法的掌握情况&lt;/p>
&lt;p>&lt;strong>难易程度&lt;/strong>：难&lt;/p>
&lt;p>&lt;strong>参考话术&lt;/strong>：&lt;/p>
&lt;p>限流算法常见的有三种实现：滑动时间窗口、令牌桶算法、漏桶算法。Gateway则采用了基于Redis实现的令牌桶算法。&lt;/p>
&lt;p>而Sentinel内部却比较复杂：&lt;/p>
&lt;ul>
&lt;li>默认限流模式是基于滑动时间窗口算法&lt;/li>
&lt;li>排队等待的限流模式则基于漏桶算法&lt;/li>
&lt;li>而热点参数限流则是基于令牌桶算法&lt;/li>
&lt;/ul>
&lt;h2 id="17sentinel的线程隔离与hystix的线程隔离有什么差别">
&lt;a href="#17sentinel%e7%9a%84%e7%ba%bf%e7%a8%8b%e9%9a%94%e7%a6%bb%e4%b8%8ehystix%e7%9a%84%e7%ba%bf%e7%a8%8b%e9%9a%94%e7%a6%bb%e6%9c%89%e4%bb%80%e4%b9%88%e5%b7%ae%e5%88%ab" class="header-anchor">#&lt;/a>
1.7.Sentinel的线程隔离与Hystix的线程隔离有什么差别?
&lt;/h2>&lt;p>&lt;strong>问题说明&lt;/strong>：考察对线程隔离方案的掌握情况&lt;/p>
&lt;p>&lt;strong>难易程度&lt;/strong>：一般&lt;/p>
&lt;p>&lt;strong>参考话术&lt;/strong>：&lt;/p>
&lt;p>Hystix默认是基于线程池实现的线程隔离，每一个被隔离的业务都要创建一个独立的线程池，线程过多会带来额外的CPU开销，性能一般，但是隔离性更强。&lt;/p>
&lt;p>Sentinel是基于信号量（计数器）实现的线程隔离，不用创建线程池，性能较好，但是隔离性一般。&lt;/p>
&lt;h1 id="2mq篇">
&lt;a href="#2mq%e7%af%87" class="header-anchor">#&lt;/a>
2.MQ篇
&lt;/h1>&lt;h2 id="21你们为什么选择了rabbitmq而不是其它的mq">
&lt;a href="#21%e4%bd%a0%e4%bb%ac%e4%b8%ba%e4%bb%80%e4%b9%88%e9%80%89%e6%8b%a9%e4%ba%86rabbitmq%e8%80%8c%e4%b8%8d%e6%98%af%e5%85%b6%e5%ae%83%e7%9a%84mq" class="header-anchor">#&lt;/a>
2.1.你们为什么选择了RabbitMQ而不是其它的MQ？
&lt;/h2>&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739030-feafda895f354e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210925220034702"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>&lt;strong>话术：&lt;/strong>&lt;/p>
&lt;p>kafka是以吞吐量高而闻名，不过其数据稳定性一般，而且无法保证消息有序性。我们公司的日志收集也有使用，业务模块中则使用的RabbitMQ。&lt;/p>
&lt;p>阿里巴巴的RocketMQ基于Kafka的原理，弥补了Kafka的缺点，继承了其高吞吐的优势，其客户端目前以Java为主。但是我们担心阿里巴巴开源产品的稳定性，所以就没有使用。&lt;/p>
&lt;p>RabbitMQ基于面向并发的语言Erlang开发，吞吐量不如Kafka，但是对我们公司来讲够用了。而且消息可靠性较好，并且消息延迟极低，集群搭建比较方便。支持多种协议，并且有各种语言的客户端，比较灵活。Spring对RabbitMQ的支持也比较好，使用起来比较方便，比较符合我们公司的需求。&lt;/p>
&lt;p>综合考虑我们公司的并发需求以及稳定性需求，我们选择了RabbitMQ。&lt;/p>
&lt;h2 id="22rabbitmq如何确保消息的不丢失">
&lt;a href="#22rabbitmq%e5%a6%82%e4%bd%95%e7%a1%ae%e4%bf%9d%e6%b6%88%e6%81%af%e7%9a%84%e4%b8%8d%e4%b8%a2%e5%a4%b1" class="header-anchor">#&lt;/a>
2.2.RabbitMQ如何确保消息的不丢失？
&lt;/h2>&lt;p>&lt;strong>话术：&lt;/strong>&lt;/p>
&lt;p>RabbitMQ针对消息传递过程中可能发生问题的各个地方，给出了针对性的解决方案：&lt;/p>
&lt;ul>
&lt;li>生产者发送消息时可能因为网络问题导致消息没有到达交换机：
&lt;ul>
&lt;li>RabbitMQ提供了publisher confirm机制
&lt;ul>
&lt;li>生产者发送消息后，可以编写ConfirmCallback函数&lt;/li>
&lt;li>消息成功到达交换机后，RabbitMQ会调用ConfirmCallback通知消息的发送者，返回ACK&lt;/li>
&lt;li>消息如果未到达交换机，RabbitMQ也会调用ConfirmCallback通知消息的发送者，返回NACK&lt;/li>
&lt;li>消息超时未发送成功也会抛出异常&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>消息到达交换机后，如果未能到达队列，也会导致消息丢失：
&lt;ul>
&lt;li>RabbitMQ提供了publisher return机制
&lt;ul>
&lt;li>生产者可以定义ReturnCallback函数&lt;/li>
&lt;li>消息到达交换机，未到达队列，RabbitMQ会调用ReturnCallback通知发送者，告知失败原因&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>消息到达队列后，MQ宕机也可能导致丢失消息：
&lt;ul>
&lt;li>RabbitMQ提供了持久化功能，集群的主从备份功能
&lt;ul>
&lt;li>消息持久化，RabbitMQ会将交换机、队列、消息持久化到磁盘，宕机重启可以恢复消息&lt;/li>
&lt;li>镜像集群，仲裁队列，都可以提供主从备份功能，主节点宕机，从节点会自动切换为主，数据依然在&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>消息投递给消费者后，如果消费者处理不当，也可能导致消息丢失
&lt;ul>
&lt;li>SpringAMQP基于RabbitMQ提供了消费者确认机制、消费者重试机制，消费者失败处理策略：
&lt;ul>
&lt;li>消费者的确认机制：
&lt;ul>
&lt;li>消费者处理消息成功，未出现异常时，Spring返回ACK给RabbitMQ，消息才被移除&lt;/li>
&lt;li>消费者处理消息失败，抛出异常，宕机，Spring返回NACK或者不返回结果，消息不被异常&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>消费者重试机制：
&lt;ul>
&lt;li>默认情况下，消费者处理失败时，消息会再次回到MQ队列，然后投递给其它消费者。Spring提供的消费者重试机制，则是在处理失败后不返回NACK，而是直接在消费者本地重试。多次重试都失败后，则按照消费者失败处理策略来处理消息。避免了消息频繁入队带来的额外压力。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>消费者失败策略：
&lt;ul>
&lt;li>当消费者多次本地重试失败时，消息默认会丢弃。&lt;/li>
&lt;li>Spring提供了Republish策略，在多次重试都失败，耗尽重试次数后，将消息重新投递给指定的异常交换机，并且会携带上异常栈信息，帮助定位问题。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="23rabbitmq如何避免消息堆积">
&lt;a href="#23rabbitmq%e5%a6%82%e4%bd%95%e9%81%bf%e5%85%8d%e6%b6%88%e6%81%af%e5%a0%86%e7%a7%af" class="header-anchor">#&lt;/a>
2.3.RabbitMQ如何避免消息堆积？
&lt;/h2>&lt;p>&lt;strong>话术：&lt;/strong>&lt;/p>
&lt;p>消息堆积问题产生的原因往往是因为消息发送的速度超过了消费者消息处理的速度。因此解决方案无外乎以下三点：&lt;/p>
&lt;ul>
&lt;li>提高消费者处理速度&lt;/li>
&lt;li>增加更多消费者&lt;/li>
&lt;li>增加队列消息存储上限&lt;/li>
&lt;/ul>
&lt;p>1）提高消费者处理速度&lt;/p>
&lt;p>消费者处理速度是由业务代码决定的，所以我们能做的事情包括：&lt;/p>
&lt;ul>
&lt;li>尽可能优化业务代码，提高业务性能&lt;/li>
&lt;li>接收到消息后，开启线程池，并发处理多个消息&lt;/li>
&lt;/ul>
&lt;p>优点：成本低，改改代码即可&lt;/p>
&lt;p>缺点：开启线程池会带来额外的性能开销，对于高频、低时延的任务不合适。推荐任务执行周期较长的业务。&lt;/p>
&lt;p>2）增加更多消费者&lt;/p>
&lt;p>一个队列绑定多个消费者，共同争抢任务，自然可以提供消息处理的速度。&lt;/p>
&lt;p>优点：能用钱解决的问题都不是问题。实现简单粗暴&lt;/p>
&lt;p>缺点：问题是没有钱。成本太高&lt;/p>
&lt;p>3）增加队列消息存储上限&lt;/p>
&lt;p>在RabbitMQ的1.8版本后，加入了新的队列模式：Lazy Queue&lt;/p>
&lt;p>这种队列不会将消息保存在内存中，而是在收到消息后直接写入磁盘中，理论上没有存储上限。可以解决消息堆积问题。&lt;/p>
&lt;p>优点：磁盘存储更安全；存储无上限；避免内存存储带来的Page Out问题，性能更稳定；&lt;/p>
&lt;p>缺点：磁盘存储受到IO性能的限制，消息时效性不如内存模式，但影响不大。&lt;/p>
&lt;h2 id="24rabbitmq如何保证消息的有序性">
&lt;a href="#24rabbitmq%e5%a6%82%e4%bd%95%e4%bf%9d%e8%af%81%e6%b6%88%e6%81%af%e7%9a%84%e6%9c%89%e5%ba%8f%e6%80%a7" class="header-anchor">#&lt;/a>
2.4.RabbitMQ如何保证消息的有序性？
&lt;/h2>&lt;p>&lt;strong>话术：&lt;/strong>&lt;/p>
&lt;p>其实RabbitMQ是队列存储，天然具备先进先出的特点，只要消息的发送是有序的，那么理论上接收也是有序的。不过当一个队列绑定了多个消费者时，可能出现消息轮询投递给消费者的情况，而消费者的处理顺序就无法保证了。&lt;/p>
&lt;p>因此，要保证消息的有序性，需要做的下面几点：&lt;/p>
&lt;ul>
&lt;li>保证消息发送的有序性&lt;/li>
&lt;li>保证一组有序的消息都发送到同一个队列&lt;/li>
&lt;li>保证一个队列只包含一个消费者&lt;/li>
&lt;/ul>
&lt;h2 id="25如何防止mq消息被重复消费">
&lt;a href="#25%e5%a6%82%e4%bd%95%e9%98%b2%e6%ad%a2mq%e6%b6%88%e6%81%af%e8%a2%ab%e9%87%8d%e5%a4%8d%e6%b6%88%e8%b4%b9" class="header-anchor">#&lt;/a>
2.5.如何防止MQ消息被重复消费？
&lt;/h2>&lt;p>&lt;strong>话术：&lt;/strong>&lt;/p>
&lt;p>消息重复消费的原因多种多样，不可避免。所以只能从消费者端入手，只要能保证消息处理的幂等性就可以确保消息不被重复消费。&lt;/p>
&lt;p>而幂等性的保证又有很多方案：&lt;/p>
&lt;ul>
&lt;li>给每一条消息都添加一个唯一id，在本地记录消息表及消息状态，处理消息时基于数据库表的id唯一性做判断&lt;/li>
&lt;li>同样是记录消息表，利用消息状态字段实现基于乐观锁的判断，保证幂等&lt;/li>
&lt;li>基于业务本身的幂等性。比如根据id的删除、查询业务天生幂等；新增、修改等业务可以考虑基于数据库id唯一性、或者乐观锁机制确保幂等。本质与消息表方案类似。&lt;/li>
&lt;/ul>
&lt;h2 id="26如何保证rabbitmq的高可用">
&lt;a href="#26%e5%a6%82%e4%bd%95%e4%bf%9d%e8%af%81rabbitmq%e7%9a%84%e9%ab%98%e5%8f%af%e7%94%a8" class="header-anchor">#&lt;/a>
2.6.如何保证RabbitMQ的高可用？
&lt;/h2>&lt;p>&lt;strong>话术：&lt;/strong>&lt;/p>
&lt;p>要实现RabbitMQ的高可用无外乎下面两点：&lt;/p>
&lt;ul>
&lt;li>做好交换机、队列、消息的持久化&lt;/li>
&lt;li>搭建RabbitMQ的镜像集群，做好主从备份。当然也可以使用仲裁队列代替镜像集群。&lt;/li>
&lt;/ul>
&lt;h2 id="27使用mq可以解决那些问题">
&lt;a href="#27%e4%bd%bf%e7%94%a8mq%e5%8f%af%e4%bb%a5%e8%a7%a3%e5%86%b3%e9%82%a3%e4%ba%9b%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
2.7.使用MQ可以解决那些问题？
&lt;/h2>&lt;p>&lt;strong>话术：&lt;/strong>&lt;/p>
&lt;p>RabbitMQ能解决的问题很多，例如：&lt;/p>
&lt;ul>
&lt;li>解耦合：将几个业务关联的微服务调用修改为基于MQ的异步通知，可以解除微服务之间的业务耦合。同时还提高了业务性能。&lt;/li>
&lt;li>流量削峰：将突发的业务请求放入MQ中，作为缓冲区。后端的业务根据自己的处理能力从MQ中获取消息，逐个处理任务。流量曲线变的平滑很多&lt;/li>
&lt;li>延迟队列：基于RabbitMQ的死信队列或者DelayExchange插件，可以实现消息发送后，延迟接收的效果。&lt;/li>
&lt;/ul>
&lt;h1 id="3redis篇">
&lt;a href="#3redis%e7%af%87" class="header-anchor">#&lt;/a>
3.Redis篇
&lt;/h1>&lt;h2 id="31redis与memcache的区别">
&lt;a href="#31redis%e4%b8%8ememcache%e7%9a%84%e5%8c%ba%e5%88%ab" class="header-anchor">#&lt;/a>
3.1.Redis与Memcache的区别？
&lt;/h2>&lt;ul>
&lt;li>&lt;code>redis支持更丰富的数据类型&lt;/code>（支持更复杂的应用场景）：Redis不仅仅支持简单的k/v类型的数据，同时还提供list，set，zset，hash等数据结构的存储。memcache支持简单的数据类型，String。&lt;/li>
&lt;li>&lt;code>Redis支持数据的持久化&lt;/code>，可以将内存中的数据保持在磁盘中，重启的时候可以再次加载进行使用,而Memecache把数据全部存在内存之中。&lt;/li>
&lt;li>&lt;code>集群模式&lt;/code>：memcached没有原生的集群模式，需要依靠客户端来实现往集群中分片写入数据；但是 redis 目前是原生支持 cluster 模式的.&lt;/li>
&lt;li>&lt;code>Redis使用单线程&lt;/code>：Memcached是多线程，非阻塞IO复用的网络模型；Redis使用单线程的多路 IO 复用模型。&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739030-834215a92181c5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1574821356723"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="32redis的单线程问题">
&lt;a href="#32redis%e7%9a%84%e5%8d%95%e7%ba%bf%e7%a8%8b%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
3.2.Redis的单线程问题
&lt;/h2>&lt;p>&lt;strong>面试官&lt;/strong>：Redis采用单线程，如何保证高并发？&lt;/p>
&lt;p>&lt;strong>面试话术&lt;/strong>：&lt;/p>
&lt;p>Redis快的主要原因是：&lt;/p>
&lt;ol>
&lt;li>完全基于内存&lt;/li>
&lt;li>数据结构简单，对数据操作也简单&lt;/li>
&lt;li>使用多路 I/O 复用模型，充分利用CPU资源&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>面试官&lt;/strong>：这样做的好处是什么？&lt;/p>
&lt;p>&lt;strong>面试话术&lt;/strong>：&lt;/p>
&lt;p>单线程优势有下面几点：&lt;/p>
&lt;ul>
&lt;li>代码更清晰，处理逻辑更简单&lt;/li>
&lt;li>不用去考虑各种锁的问题，不存在加锁释放锁操作，没有因为锁而导致的性能消耗&lt;/li>
&lt;li>不存在多进程或者多线程导致的CPU切换，充分利用CPU资源&lt;/li>
&lt;/ul>
&lt;h2 id="32redis的持久化方案由哪些">
&lt;a href="#32redis%e7%9a%84%e6%8c%81%e4%b9%85%e5%8c%96%e6%96%b9%e6%a1%88%e7%94%b1%e5%93%aa%e4%ba%9b" class="header-anchor">#&lt;/a>
3.2.Redis的持久化方案由哪些？
&lt;/h2>&lt;p>&lt;strong>相关资料：&lt;/strong>&lt;/p>
&lt;p>1）RDB 持久化&lt;/p>
&lt;p>RDB持久化可以使用save或bgsave，为了不阻塞主进程业务，一般都使用bgsave，流程：&lt;/p>
&lt;ul>
&lt;li>Redis 进程会 fork 出一个子进程（与父进程内存数据一致）。&lt;/li>
&lt;li>父进程继续处理客户端请求命令&lt;/li>
&lt;li>由子进程将内存中的所有数据写入到一个临时的 RDB 文件中。&lt;/li>
&lt;li>完成写入操作之后，旧的 RDB 文件会被新的 RDB 文件替换掉。&lt;/li>
&lt;/ul>
&lt;p>下面是一些和 RDB 持久化相关的配置：&lt;/p>
&lt;ul>
&lt;li>&lt;code>save 60 10000&lt;/code>：如果在 60 秒内有 10000 个 key 发生改变，那就执行 RDB 持久化。&lt;/li>
&lt;li>&lt;code>stop-writes-on-bgsave-error yes&lt;/code>：如果 Redis 执行 RDB 持久化失败（常见于操作系统内存不足），那么 Redis 将不再接受 client 写入数据的请求。&lt;/li>
&lt;li>&lt;code>rdbcompression yes&lt;/code>：当生成 RDB 文件时，同时进行压缩。&lt;/li>
&lt;li>&lt;code>dbfilename dump.rdb&lt;/code>：将 RDB 文件命名为 dump.rdb。&lt;/li>
&lt;li>&lt;code>dir /var/lib/redis&lt;/code>：将 RDB 文件保存在&lt;code>/var/lib/redis&lt;/code>目录下。&lt;/li>
&lt;/ul>
&lt;p>　　当然在实践中，我们通常会将&lt;code>stop-writes-on-bgsave-error&lt;/code>设置为&lt;code>false&lt;/code>，同时让监控系统在 Redis 执行 RDB 持久化失败时发送告警，以便人工介入解决，而不是粗暴地拒绝 client 的写入请求。&lt;/p>
&lt;p>RDB持久化的优点：&lt;/p>
&lt;ul>
&lt;li>RDB持久化文件小，Redis数据恢复时速度快&lt;/li>
&lt;li>子进程不影响父进程，父进程可以持续处理客户端命令&lt;/li>
&lt;li>子进程fork时采用copy-on-write方式，大多数情况下，没有太多的内存消耗，效率比较好。&lt;/li>
&lt;/ul>
&lt;p>RDB 持久化的缺点：&lt;/p>
&lt;ul>
&lt;li>子进程fork时采用copy-on-write方式，如果Redis此时写操作较多，可能导致额外的内存占用，甚至内存溢出&lt;/li>
&lt;li>RDB文件压缩会减小文件体积，但通过时会对CPU有额外的消耗&lt;/li>
&lt;li>如果业务场景很看重数据的持久性 (durability)，那么不应该采用 RDB 持久化。譬如说，如果 Redis 每 5 分钟执行一次 RDB 持久化，要是 Redis 意外奔溃了，那么最多会丢失 5 分钟的数据。&lt;/li>
&lt;/ul>
&lt;p>2）AOF 持久化&lt;/p>
&lt;p>　　可以使用&lt;code>appendonly yes&lt;/code>配置项来开启 AOF 持久化。Redis 执行 AOF 持久化时，会将接收到的写命令追加到 AOF 文件的末尾，因此 Redis 只要对 AOF 文件中的命令进行回放，就可以将数据库还原到原先的状态。
　　与 RDB 持久化相比，AOF 持久化的一个明显优势就是，它可以提高数据的持久性 (durability)。因为在 AOF 模式下，Redis 每次接收到 client 的写命令，就会将命令&lt;code>write()&lt;/code>到 AOF 文件末尾。
　　然而，在 Linux 中，将数据&lt;code>write()&lt;/code>到文件后，数据并不会立即刷新到磁盘，而会先暂存在 OS 的文件系统缓冲区。在合适的时机，OS 才会将缓冲区的数据刷新到磁盘（如果需要将文件内容刷新到磁盘，可以调用&lt;code>fsync()&lt;/code>或&lt;code>fdatasync()&lt;/code>）。
　　通过&lt;code>appendfsync&lt;/code>配置项，可以控制 Redis 将命令同步到磁盘的频率：&lt;/p>
&lt;ul>
&lt;li>&lt;code>always&lt;/code>：每次 Redis 将命令&lt;code>write()&lt;/code>到 AOF 文件时，都会调用&lt;code>fsync()&lt;/code>，将命令刷新到磁盘。这可以保证最好的数据持久性，但却会给系统带来极大的开销。&lt;/li>
&lt;li>&lt;code>no&lt;/code>：Redis 只将命令&lt;code>write()&lt;/code>到 AOF 文件。这会让 OS 决定何时将命令刷新到磁盘。&lt;/li>
&lt;li>&lt;code>everysec&lt;/code>：除了将命令&lt;code>write()&lt;/code>到 AOF 文件，Redis 还会每秒执行一次&lt;code>fsync()&lt;/code>。在实践中，推荐使用这种设置，一定程度上可以保证数据持久性，又不会明显降低 Redis 性能。&lt;/li>
&lt;/ul>
&lt;p>　　然而，AOF 持久化并不是没有缺点的：Redis 会不断将接收到的写命令追加到 AOF 文件中，导致 AOF 文件越来越大。过大的 AOF 文件会消耗磁盘空间，并且导致 Redis 重启时更加缓慢。为了解决这个问题，在适当情况下，Redis 会对 AOF 文件进行重写，去除文件中冗余的命令，以减小 AOF 文件的体积。在重写 AOF 文件期间， Redis 会启动一个子进程，由子进程负责对 AOF 文件进行重写。
　　可以通过下面两个配置项，控制 Redis 重写 AOF 文件的频率：&lt;/p>
&lt;ul>
&lt;li>&lt;code>auto-aof-rewrite-min-size 64mb&lt;/code>&lt;/li>
&lt;li>&lt;code>auto-aof-rewrite-percentage 100&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>　　上面两个配置的作用：当 AOF 文件的体积大于 64MB，并且 AOF 文件的体积比上一次重写之后的体积大了至少一倍，那么 Redis 就会执行 AOF 重写。&lt;/p>
&lt;p>优点：&lt;/p>
&lt;ul>
&lt;li>持久化频率高，数据可靠性高&lt;/li>
&lt;li>没有额外的内存或CPU消耗&lt;/li>
&lt;/ul>
&lt;p>缺点：&lt;/p>
&lt;ul>
&lt;li>文件体积大&lt;/li>
&lt;li>文件大导致服务数据恢复时效率较低&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>面试话术：&lt;/strong>&lt;/p>
&lt;p>Redis 提供了两种数据持久化的方式，一种是 RDB，另一种是 AOF。默认情况下，Redis 使用的是 RDB 持久化。&lt;/p>
&lt;p>RDB持久化文件体积较小，但是保存数据的频率一般较低，可靠性差，容易丢失数据。另外RDB写数据时会采用Fork函数拷贝主进程，可能有额外的内存消耗，文件压缩也会有额外的CPU消耗。&lt;/p>
&lt;p>ROF持久化可以做到每秒钟持久化一次，可靠性高。但是持久化文件体积较大，导致数据恢复时读取文件时间较长，效率略低&lt;/p>
&lt;h2 id="33redis的集群方式有哪些">
&lt;a href="#33redis%e7%9a%84%e9%9b%86%e7%be%a4%e6%96%b9%e5%bc%8f%e6%9c%89%e5%93%aa%e4%ba%9b" class="header-anchor">#&lt;/a>
3.3.Redis的集群方式有哪些？
&lt;/h2>&lt;p>&lt;strong>面试话术：&lt;/strong>&lt;/p>
&lt;p>Redis集群可以分为&lt;strong>主从集群&lt;/strong>和&lt;strong>分片集群&lt;/strong>两类。&lt;/p>
&lt;p>&lt;strong>主从集群&lt;/strong>一般一主多从，主库用来写数据，从库用来读数据。结合哨兵，可以再主库宕机时从新选主，&lt;strong>目的是保证Redis的高可用&lt;/strong>。&lt;/p>
&lt;p>&lt;strong>分片集群&lt;/strong>是数据分片，我们会让多个Redis节点组成集群，并将16383个插槽分到不同的节点上。存储数据时利用对key做hash运算，得到插槽值后存储到对应的节点即可。因为存储数据面向的是插槽而非节点本身，因此可以做到集群动态伸缩。&lt;strong>目的是让Redis能存储更多数据。&lt;/strong>&lt;/p>
&lt;p>1）主从集群&lt;/p>
&lt;p>主从集群，也是读写分离集群。一般都是一主多从方式。&lt;/p>
&lt;p>Redis 的复制（replication）功能允许用户根据一个 Redis 服务器来创建任意多个该服务器的复制品，其中被复制的服务器为主服务器（master），而通过复制创建出来的服务器复制品则为从服务器（slave）。&lt;/p>
&lt;p>只要主从服务器之间的网络连接正常，主从服务器两者会具有相同的数据，主服务器就会一直将发生在自己身上的数据更新同步 给从服务器，从而一直保证主从服务器的数据相同。&lt;/p>
&lt;ul>
&lt;li>写数据时只能通过主节点完成&lt;/li>
&lt;li>读数据可以从任何节点完成&lt;/li>
&lt;li>如果配置了&lt;code>哨兵节点&lt;/code>，当master宕机时，哨兵会从salve节点选出一个新的主。&lt;/li>
&lt;/ul>
&lt;p>主从集群分两种：&lt;/p>
&lt;p>
&lt;img src="assets/1574821993599.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1574821993599"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739030-e57abb3fdc524a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1574822026037"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>带有哨兵的集群：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739030-bc49382739f358.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1574822077190"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>2）分片集群&lt;/p>
&lt;p>主从集群中，每个节点都要保存所有信息，容易形成木桶效应。并且当数据量较大时，单个机器无法满足需求。此时我们就要使用分片集群了。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739030-232c31bf591492.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1574822184467"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>集群特征：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>每个节点都保存不同数据&lt;/p>
&lt;/li>
&lt;li>
&lt;p>所有的redis节点彼此互联(PING-PONG机制),内部使用二进制协议优化传输速度和带宽.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>节点的fail是通过集群中超过半数的节点检测失效时才生效.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>客户端与redis节点直连,不需要中间proxy层连接集群中任何一个可用节点都可以访问到数据&lt;/p>
&lt;/li>
&lt;li>
&lt;p>redis-cluster把所有的物理节点映射到[0-16383]slot（插槽）上，实现动态伸缩&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>为了保证Redis中每个节点的高可用，我们还可以给每个节点创建replication（slave节点），如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739030-b1ec4c46cf1c70.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1574822584357"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>出现故障时，主从可以及时切换：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739030-b0fe6eb5e7b9ca.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1574822602109"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="34redis的常用数据类型有哪些">
&lt;a href="#34redis%e7%9a%84%e5%b8%b8%e7%94%a8%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b%e6%9c%89%e5%93%aa%e4%ba%9b" class="header-anchor">#&lt;/a>
3.4.Redis的常用数据类型有哪些？
&lt;/h2>&lt;p>支持多种类型的数据结构，主要区别是value存储的数据格式不同：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>string：最基本的数据类型，二进制安全的字符串，最大512M。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>list：按照添加顺序保持顺序的字符串列表。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>set：无序的字符串集合，不存在重复的元素。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>sorted set：已排序的字符串集合。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>hash：key-value对格式&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="35聊一下redis事务机制">
&lt;a href="#35%e8%81%8a%e4%b8%80%e4%b8%8bredis%e4%ba%8b%e5%8a%a1%e6%9c%ba%e5%88%b6" class="header-anchor">#&lt;/a>
3.5.聊一下Redis事务机制
&lt;/h2>&lt;p>&lt;strong>相关资料：&lt;/strong>&lt;/p>
&lt;p>参考：http://redisdoc.com/topic/transaction.html&lt;/p>
&lt;p>Redis事务功能是通过MULTI、EXEC、DISCARD和WATCH 四个原语实现的。Redis会将一个事务中的所有命令序列化，然后按顺序执行。但是Redis事务不支持回滚操作，命令运行出错后，正确的命令会继续执行。&lt;/p>
&lt;ul>
&lt;li>&lt;code>MULTI&lt;/code>: 用于开启一个事务，它总是返回OK。 MULTI执行之后，客户端可以继续向服务器发送任意多条命令，这些命令不会立即被执行，而是被放到一个&lt;strong>待执行命令队列&lt;/strong>中&lt;/li>
&lt;li>&lt;code>EXEC&lt;/code>：按顺序执行命令队列内的所有命令。返回所有命令的返回值。事务执行过程中，Redis不会执行其它事务的命令。&lt;/li>
&lt;li>&lt;code>DISCARD&lt;/code>：清空命令队列，并放弃执行事务， 并且客户端会从事务状态中退出&lt;/li>
&lt;li>&lt;code>WATCH&lt;/code>：Redis的乐观锁机制，利用compare-and-set（CAS）原理，可以监控一个或多个键，一旦其中有一个键被修改，之后的事务就不会执行&lt;/li>
&lt;/ul>
&lt;p>使用事务时可能会遇上以下两种错误：&lt;/p>
&lt;ul>
&lt;li>执行 EXEC 之前，入队的命令可能会出错。比如说，命令可能会产生语法错误（参数数量错误，参数名错误，等等），或者其他更严重的错误，比如内存不足（如果服务器使用 &lt;code>maxmemory&lt;/code> 设置了最大内存限制的话）。
&lt;ul>
&lt;li>Redis 2.6.5 开始，服务器会对命令入队失败的情况进行记录，并在客户端调用 EXEC 命令时，拒绝执行并自动放弃这个事务。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>命令可能在 EXEC 调用之后失败。举个例子，事务中的命令可能处理了错误类型的键，比如将列表命令用在了字符串键上面，诸如此类。
&lt;ul>
&lt;li>即使事务中有某个/某些命令在执行时产生了错误， 事务中的其他命令仍然会继续执行，不会回滚。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>为什么 Redis 不支持回滚（roll back）？&lt;/p>
&lt;p>以下是这种做法的优点：&lt;/p>
&lt;ul>
&lt;li>Redis 命令只会因为错误的语法而失败（并且这些问题不能在入队时发现），或是命令用在了错误类型的键上面：这也就是说，从实用性的角度来说，失败的命令是由&lt;strong>编程错误&lt;/strong>造成的，而这些错误应该在开发的过程中被发现，而不应该出现在生产环境中。&lt;/li>
&lt;li>因为不需要对回滚进行支持，所以 Redis 的内部可以保持简单且快速。&lt;/li>
&lt;/ul>
&lt;p>鉴于没有任何机制能避免程序员自己造成的错误， 并且这类错误通常不会在生产环境中出现， 所以 Redis 选择了更简单、更快速的无回滚方式来处理事务。&lt;/p>
&lt;p>&lt;strong>面试话术：&lt;/strong>&lt;/p>
&lt;p>Redis事务其实是把一系列Redis命令放入队列，然后批量执行，执行过程中不会有其它事务来打断。不过与关系型数据库的事务不同，Redis事务不支持回滚操作，事务中某个命令执行失败，其它命令依然会执行。&lt;/p>
&lt;p>为了弥补不能回滚的问题，Redis会在事务入队时就检查命令，如果命令异常则会放弃整个事务。&lt;/p>
&lt;p>因此，只要程序员编程是正确的，理论上说Redis会正确执行所有事务，无需回滚。&lt;/p>
&lt;p>面试官：如果事务执行一半的时候Redis宕机怎么办？&lt;/p>
&lt;p>Redis有持久化机制，因为可靠性问题，我们一般使用AOF持久化。事务的所有命令也会写入AOF文件，但是如果在执行EXEC命令之前，Redis已经宕机，则AOF文件中事务不完整。使用 &lt;code>redis-check-aof&lt;/code> 程序可以移除 AOF 文件中不完整事务的信息，确保服务器可以顺利启动。&lt;/p>
&lt;h2 id="36redis的key过期策略">
&lt;a href="#36redis%e7%9a%84key%e8%bf%87%e6%9c%9f%e7%ad%96%e7%95%a5" class="header-anchor">#&lt;/a>
3.6.Redis的Key过期策略
&lt;/h2>&lt;h3 id="参考资料">
&lt;a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" class="header-anchor">#&lt;/a>
&lt;strong>参考资料：&lt;/strong>
&lt;/h3>&lt;h4 id="为什么需要内存回收">
&lt;a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%86%85%e5%ad%98%e5%9b%9e%e6%94%b6" class="header-anchor">#&lt;/a>
为什么需要内存回收？
&lt;/h4>&lt;ul>
&lt;li>1、在Redis中，set指令可以指定key的过期时间，当过期时间到达以后，key就失效了；&lt;/li>
&lt;li>2、Redis是基于内存操作的，所有的数据都是保存在内存中，一台机器的内存是有限且很宝贵的。&lt;/li>
&lt;/ul>
&lt;p>基于以上两点，为了保证Redis能继续提供可靠的服务，Redis需要一种机制清理掉不常用的、无效的、多余的数据，失效后的数据需要及时清理，这就需要内存回收了。&lt;/p>
&lt;p>Redis的内存回收主要分为过期删除策略和内存淘汰策略两部分。&lt;/p>
&lt;h4 id="过期删除策略">
&lt;a href="#%e8%bf%87%e6%9c%9f%e5%88%a0%e9%99%a4%e7%ad%96%e7%95%a5" class="header-anchor">#&lt;/a>
过期删除策略
&lt;/h4>&lt;p>删除达到过期时间的key。&lt;/p>
&lt;ul>
&lt;li>1）定时删除&lt;/li>
&lt;/ul>
&lt;p>对于每一个设置了过期时间的key都会创建一个定时器，一旦到达过期时间就立即删除。该策略可以立即清除过期的数据，对内存较友好，但是缺点是占用了大量的CPU资源去处理过期的数据，会影响Redis的吞吐量和响应时间。&lt;/p>
&lt;ul>
&lt;li>2）惰性删除&lt;/li>
&lt;/ul>
&lt;p>当访问一个key时，才判断该key是否过期，过期则删除。该策略能最大限度地节省CPU资源，但是对内存却十分不友好。有一种极端的情况是可能出现大量的过期key没有被再次访问，因此不会被清除，导致占用了大量的内存。&lt;/p>
&lt;blockquote>
&lt;p>在计算机科学中，懒惰删除（英文：lazy deletion）指的是从一个散列表（也称哈希表）中删除元素的一种方法。在这个方法中，删除仅仅是指标记一个元素被删除，而不是整个清除它。被删除的位点在插入时被当作空元素，在搜索之时被当作已占据。&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>3）定期删除&lt;/li>
&lt;/ul>
&lt;p>每隔一段时间，扫描Redis中过期key字典，并清除部分过期的key。该策略是前两者的一个折中方案，还可以通过调整定时扫描的时间间隔和每次扫描的限定耗时，在不同情况下使得CPU和内存资源达到最优的平衡效果。&lt;/p>
&lt;p>在Redis中，&lt;code>同时使用了定期删除和惰性删除&lt;/code>。不过Redis定期删除采用的是随机抽取的方式删除部分Key，因此不能保证过期key 100%的删除。&lt;/p>
&lt;p>Redis结合了定期删除和惰性删除，基本上能很好的处理过期数据的清理，但是实际上还是有点问题的，如果过期key较多，定期删除漏掉了一部分，而且也没有及时去查，即没有走惰性删除，那么就会有大量的过期key堆积在内存中，导致redis内存耗尽，当内存耗尽之后，有新的key到来会发生什么事呢？是直接抛弃还是其他措施呢？有什么办法可以接受更多的key？&lt;/p>
&lt;h4 id="内存淘汰策略">
&lt;a href="#%e5%86%85%e5%ad%98%e6%b7%98%e6%b1%b0%e7%ad%96%e7%95%a5" class="header-anchor">#&lt;/a>
内存淘汰策略
&lt;/h4>&lt;p>Redis的内存淘汰策略，是指内存达到maxmemory极限时，使用某种算法来决定清理掉哪些数据，以保证新数据的存入。&lt;/p>
&lt;p>Redis的内存淘汰机制包括：&lt;/p>
&lt;ul>
&lt;li>noeviction: 当内存不足以容纳新写入数据时，新写入操作会报错。&lt;/li>
&lt;li>allkeys-lru：当内存不足以容纳新写入数据时，在键空间（&lt;code>server.db[i].dict&lt;/code>）中，移除最近最少使用的 key（这个是最常用的）。&lt;/li>
&lt;li>allkeys-random：当内存不足以容纳新写入数据时，在键空间（&lt;code>server.db[i].dict&lt;/code>）中，随机移除某个 key。&lt;/li>
&lt;li>volatile-lru：当内存不足以容纳新写入数据时，在设置了过期时间的键空间（&lt;code>server.db[i].expires&lt;/code>）中，移除最近最少使用的 key。&lt;/li>
&lt;li>volatile-random：当内存不足以容纳新写入数据时，在设置了过期时间的键空间（&lt;code>server.db[i].expires&lt;/code>）中，随机移除某个 key。&lt;/li>
&lt;li>volatile-ttl：当内存不足以容纳新写入数据时，在设置了过期时间的键空间（&lt;code>server.db[i].expires&lt;/code>）中，有更早过期时间的 key 优先移除。&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>在配置文件中，通过maxmemory-policy可以配置要使用哪一个淘汰机制。&lt;/p>
&lt;/blockquote>
&lt;p>什么时候会进行淘汰？&lt;/p>
&lt;p>Redis会在每一次处理命令的时候（processCommand函数调用freeMemoryIfNeeded）判断当前redis是否达到了内存的最大限制，如果达到限制，则使用对应的算法去处理需要删除的key。&lt;/p>
&lt;p>在淘汰key时，Redis默认最常用的是LRU算法（Latest Recently Used）。Redis通过在每一个redisObject保存lru属性来保存key最近的访问时间，在实现LRU算法时直接读取key的lru属性。&lt;/p>
&lt;p>具体实现时，Redis遍历每一个db，从每一个db中随机抽取一批样本key，默认是3个key，再从这3个key中，删除最近最少使用的key。&lt;/p>
&lt;h3 id="面试话术">
&lt;a href="#%e9%9d%a2%e8%af%95%e8%af%9d%e6%9c%af" class="header-anchor">#&lt;/a>
面试话术：
&lt;/h3>&lt;p>Redis过期策略包含定期删除和惰性删除两部分。定期删除是在Redis内部有一个定时任务，会定期删除一些过期的key。惰性删除是当用户查询某个Key时，会检查这个Key是否已经过期，如果没过期则返回用户，如果过期则删除。&lt;/p>
&lt;p>但是这两个策略都无法保证过期key一定删除，漏网之鱼越来越多，还可能导致内存溢出。当发生内存不足问题时，Redis还会做内存回收。内存回收采用LRU策略，就是最近最少使用。其原理就是记录每个Key的最近使用时间，内存回收时，随机抽取一些Key，比较其使用时间，把最老的几个删除。&lt;/p>
&lt;p>Redis的逻辑是：最近使用过的，很可能再次被使用&lt;/p>
&lt;h2 id="37redis在项目中的哪些地方有用到">
&lt;a href="#37redis%e5%9c%a8%e9%a1%b9%e7%9b%ae%e4%b8%ad%e7%9a%84%e5%93%aa%e4%ba%9b%e5%9c%b0%e6%96%b9%e6%9c%89%e7%94%a8%e5%88%b0" class="header-anchor">#&lt;/a>
3.7.Redis在项目中的哪些地方有用到?
&lt;/h2>&lt;p>（1）共享session&lt;/p>
&lt;p>在分布式系统下，服务会部署在不同的tomcat，因此多个tomcat的session无法共享，以前存储在session中的数据无法实现共享，可以用redis代替session，解决分布式系统间数据共享问题。&lt;/p>
&lt;p>（2）数据缓存&lt;/p>
&lt;p>Redis采用内存存储，读写效率较高。我们可以把数据库的访问频率高的热点数据存储到redis中，这样用户请求时优先从redis中读取，减少数据库压力，提高并发能力。&lt;/p>
&lt;p>（3）异步队列&lt;/p>
&lt;p>Reids在内存存储引擎领域的一大优点是提供 list 和 set 操作，这使得Redis能作为一个很好的消息队列平台来使用。而且Redis中还有pub/sub这样的专用结构，用于1对N的消息通信模式。&lt;/p>
&lt;p>（4）分布式锁&lt;/p>
&lt;p>Redis中的乐观锁机制，可以帮助我们实现分布式锁的效果，用于解决分布式系统下的多线程安全问题&lt;/p>
&lt;h2 id="38redis的缓存击穿缓存雪崩缓存穿透">
&lt;a href="#38redis%e7%9a%84%e7%bc%93%e5%ad%98%e5%87%bb%e7%a9%bf%e7%bc%93%e5%ad%98%e9%9b%aa%e5%b4%a9%e7%bc%93%e5%ad%98%e7%a9%bf%e9%80%8f" class="header-anchor">#&lt;/a>
3.8.Redis的缓存击穿、缓存雪崩、缓存穿透
&lt;/h2>&lt;h3 id="1缓存穿透">
&lt;a href="#1%e7%bc%93%e5%ad%98%e7%a9%bf%e9%80%8f" class="header-anchor">#&lt;/a>
1）缓存穿透
&lt;/h3>&lt;p>参考资料：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>什么是缓存穿透&lt;/p>
&lt;ul>
&lt;li>正常情况下，我们去查询数据都是存在。那么请求去查询一条压根儿数据库中根本就不存在的数据，也就是缓存和数据库都查询不到这条数据，但是请求每次都会打到数据库上面去。这种查询不存在数据的现象我们称为&lt;strong>缓存穿透&lt;/strong>。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>穿透带来的问题&lt;/p>
&lt;ul>
&lt;li>试想一下，如果有黑客会对你的系统进行攻击，拿一个不存在的id 去查询数据，会产生大量的请求到数据库去查询。可能会导致你的数据库由于压力过大而宕掉。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>解决办法&lt;/p>
&lt;ul>
&lt;li>缓存空值：之所以会发生穿透，就是因为缓存中没有存储这些空数据的key。从而导致每次查询都到数据库去了。那么我们就可以为这些key对应的值设置为null 丢到缓存里面去。后面再出现查询这个key 的请求的时候，直接返回null 。这样，就不用在到数据库中去走一圈了，但是别忘了设置过期时间。&lt;/li>
&lt;li>BloomFilter（布隆过滤）：将所有可能存在的数据哈希到一个足够大的bitmap中，一个一定不存在的数据会被 这个bitmap拦截掉，从而避免了对底层存储系统的查询压力。在缓存之前在加一层 BloomFilter ，在查询的时候先去 BloomFilter 去查询 key 是否存在，如果不存在就直接返回，存在再走查缓存 -&amp;gt; 查 DB。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>话术：&lt;/strong>&lt;/p>
&lt;p>缓存穿透有两种解决方案：&lt;strong>其一&lt;/strong>是把不存在的key设置null值到缓存中。&lt;strong>其二&lt;/strong>是使用布隆过滤器，在查询缓存前先通过布隆过滤器判断key是否存在，存在再去查询缓存。&lt;/p>
&lt;p>设置null值可能被恶意针对，攻击者使用大量不存在的不重复key ，那么方案一就会缓存大量不存在key数据。此时我们还可以对Key规定格式模板，然后对不存在的key做&lt;strong>正则规范&lt;/strong>匹配，如果完全不符合就不用存null值到redis，而是直接返回错误。&lt;/p>
&lt;h3 id="2缓存击穿">
&lt;a href="#2%e7%bc%93%e5%ad%98%e5%87%bb%e7%a9%bf" class="header-anchor">#&lt;/a>
2）缓存击穿
&lt;/h3>&lt;p>&lt;strong>相关资料&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>什么是缓存击穿？&lt;/li>
&lt;/ul>
&lt;p>key可能会在某些时间点被超高并发地访问，是一种非常“热点”的数据。这个时候，需要考虑一个问题：缓存被“击穿”的问题。&lt;/p>
&lt;p>当这个key在失效的瞬间，redis查询失败，持续的大并发就穿破缓存，直接请求数据库，就像在一个屏障上凿开了一个洞。&lt;/p>
&lt;ul>
&lt;li>解决方案：
&lt;ul>
&lt;li>使用互斥锁(mutex key)：mutex，就是互斥。简单地来说，就是在缓存失效的时候（判断拿出来的值为空），不是立即去load db，而是先使用Redis的SETNX去set一个互斥key，当操作返回成功时，再进行load db的操作并回设缓存；否则，就重试整个get缓存的方法。SETNX，是「SET if Not eXists」的缩写，也就是只有不存在的时候才设置，可以利用它来实现互斥的效果。&lt;/li>
&lt;li>软过期：也就是逻辑过期，不使用redis提供的过期时间，而是业务层在数据中存储过期时间信息。查询时由业务程序判断是否过期，如果数据即将过期时，将缓存的时效延长，程序可以派遣一个线程去数据库中获取最新的数据，其他线程这时看到延长了的过期时间，就会继续使用旧数据，等派遣的线程获取最新数据后再更新缓存。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>推荐使用互斥锁，因为软过期会有业务逻辑侵入和额外的判断。&lt;/p>
&lt;p>&lt;strong>面试话术&lt;/strong>：&lt;/p>
&lt;p>缓存击穿主要担心的是某个Key过期，更新缓存时引起对数据库的突发高并发访问。因此我们可以在更新缓存时采用互斥锁控制，只允许一个线程去更新缓存，其它线程等待并重新读取缓存。例如Redis的setnx命令就能实现互斥效果。&lt;/p>
&lt;h3 id="3缓存雪崩">
&lt;a href="#3%e7%bc%93%e5%ad%98%e9%9b%aa%e5%b4%a9" class="header-anchor">#&lt;/a>
3）缓存雪崩
&lt;/h3>&lt;p>&lt;strong>相关资料&lt;/strong>：&lt;/p>
&lt;p>缓存雪崩，是指在某一个时间段，缓存集中过期失效。对这批数据的访问查询，都落到了数据库上，对于数据库而言，就会产生周期性的压力波峰。&lt;/p>
&lt;p>解决方案：&lt;/p>
&lt;ul>
&lt;li>数据分类分批处理：采取不同分类数据，缓存不同周期&lt;/li>
&lt;li>相同分类数据：采用固定时长加随机数方式设置缓存&lt;/li>
&lt;li>热点数据缓存时间长一些，冷门数据缓存时间短一些&lt;/li>
&lt;li>避免redis节点宕机引起雪崩，搭建主从集群，保证高可用&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>面试话术：&lt;/strong>&lt;/p>
&lt;p>解决缓存雪崩问题的关键是让缓存Key的过期时间分散。因此我们可以把数据按照业务分类，然后设置不同过期时间。相同业务类型的key，设置固定时长加随机数。尽可能保证每个Key的过期时间都不相同。&lt;/p>
&lt;p>另外，Redis宕机也可能导致缓存雪崩，因此我们还要搭建Redis主从集群及哨兵监控，保证Redis的高可用。&lt;/p>
&lt;h2 id="39缓存冷热数据分离">
&lt;a href="#39%e7%bc%93%e5%ad%98%e5%86%b7%e7%83%ad%e6%95%b0%e6%8d%ae%e5%88%86%e7%a6%bb" class="header-anchor">#&lt;/a>
3.9.缓存冷热数据分离
&lt;/h2>&lt;p>&lt;strong>背景资料&lt;/strong>：&lt;/p>
&lt;p>Redis使用的是内存存储，当需要海量数据存储时，成本非常高。&lt;/p>
&lt;p>经过调研发现，当前主流DDR3内存和主流SATA SSD的单位成本价格差距大概在20倍左右，为了优化redis机器综合成本，我们考虑实现基于&lt;strong>热度统计 的数据分级存储&lt;/strong>及数据在RAM/FLASH之间的动态交换，从而大幅度降低成本，达到性能与成本的高平衡。&lt;/p>
&lt;p>基本思路：基于key访问次数(LFU)的热度统计算法识别出热点数据，并将热点数据保留在redis中，对于无访问/访问次数少的数据则转存到SSD上，如果SSD上的key再次变热，则重新将其加载到redis内存中。&lt;/p>
&lt;p>目前流行的高性能磁盘存储，并且遵循Redis协议的方案包括：&lt;/p>
&lt;ul>
&lt;li>SSDB：http://ssdb.io/zh_cn/&lt;/li>
&lt;li>RocksDB：https://rocksdb.org.cn/&lt;/li>
&lt;/ul>
&lt;p>因此，我们就需要在应用程序与缓存服务之间引入代理，实现Redis和SSD之间的切换，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739030-4376928d630bfe.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20200521115702956"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这样的代理方案阿里云提供的就有。当然也有一些开源方案，例如：https://github.com/JingchengLi/swapdb&lt;/p>
&lt;h2 id="310redis实现分布式锁">
&lt;a href="#310redis%e5%ae%9e%e7%8e%b0%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81" class="header-anchor">#&lt;/a>
3.10.Redis实现分布式锁
&lt;/h2>&lt;p>分布式锁要满足的条件：&lt;/p>
&lt;ul>
&lt;li>多进程互斥：同一时刻，只有一个进程可以获取锁&lt;/li>
&lt;li>保证锁可以释放：任务结束或出现异常，锁一定要释放，避免死锁&lt;/li>
&lt;li>阻塞锁（可选）：获取锁失败时可否重试&lt;/li>
&lt;li>重入锁（可选）：获取锁的代码递归调用时，依然可以获取锁&lt;/li>
&lt;/ul>
&lt;h3 id="1最基本的分布式锁">
&lt;a href="#1%e6%9c%80%e5%9f%ba%e6%9c%ac%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81" class="header-anchor">#&lt;/a>
1）最基本的分布式锁：
&lt;/h3>&lt;p>利用Redis的setnx命令，这个命令的特征时如果多次执行，只有第一次执行会成功，可以实现&lt;code>互斥&lt;/code>的效果。但是为了保证服务宕机时也可以释放锁，需要利用expire命令给锁设置一个有效期&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">setnx lock thread-01 # 尝试获取锁
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">expire lock 10 # 设置有效期
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>面试官问题1&lt;/strong>：如果expire之前服务宕机怎么办？&lt;/p>
&lt;p>要保证setnx和expire命令的原子性。redis的set命令可以满足：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">set key value [NX] [EX time]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>需要添加nx和ex的选项：&lt;/p>
&lt;ul>
&lt;li>NX：与setnx一致，第一次执行成功&lt;/li>
&lt;li>EX：设置过期时间&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>面试官问题2&lt;/strong>：释放锁的时候，如果自己的锁已经过期了，此时会出现安全漏洞，如何解决？&lt;/p>
&lt;p>在锁中存储当前进程和线程标识，释放锁时对锁的标识判断，如果是自己的则删除，不是则放弃操作。&lt;/p>
&lt;p>但是这两步操作要保证原子性，需要通过Lua脚本来实现。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">if redis.call(&amp;#34;get&amp;#34;,KEYS[1]) == ARGV[1] then
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redis.call(&amp;#34;del&amp;#34;,KEYS[1])
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">end
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2可重入分布式锁">
&lt;a href="#2%e5%8f%af%e9%87%8d%e5%85%a5%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81" class="header-anchor">#&lt;/a>
2）可重入分布式锁
&lt;/h3>&lt;p>如果有重入的需求，则除了在锁中记录进程标识，还要记录重试次数，流程如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739030-647cf0e1f34c52.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1574824172228"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>下面我们假设锁的key为“&lt;code>lock&lt;/code>”，hashKey是当前线程的id：“&lt;code>threadId&lt;/code>”，锁自动释放时间假设为20&lt;/p>
&lt;p>获取锁的步骤：&lt;/p>
&lt;ul>
&lt;li>1、判断lock是否存在 &lt;code>EXISTS lock&lt;/code>
&lt;ul>
&lt;li>存在，说明有人获取锁了，下面判断是不是自己的锁
&lt;ul>
&lt;li>判断当前线程id作为hashKey是否存在：&lt;code>HEXISTS lock threadId&lt;/code>
&lt;ul>
&lt;li>不存在，说明锁已经有了，且不是自己获取的，锁获取失败，end&lt;/li>
&lt;li>存在，说明是自己获取的锁，重入次数+1：&lt;code>HINCRBY lock threadId 1&lt;/code>，去到步骤3&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>2、不存在，说明可以获取锁，&lt;code>HSET key threadId 1&lt;/code>&lt;/li>
&lt;li>3、设置锁自动释放时间，&lt;code>EXPIRE lock 20&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>释放锁的步骤：&lt;/p>
&lt;ul>
&lt;li>1、判断当前线程id作为hashKey是否存在：&lt;code>HEXISTS lock threadId&lt;/code>
&lt;ul>
&lt;li>不存在，说明锁已经失效，不用管了&lt;/li>
&lt;li>存在，说明锁还在，重入次数减1：&lt;code>HINCRBY lock threadId -1&lt;/code>，获取新的重入次数&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>2、判断重入次数是否为0：
&lt;ul>
&lt;li>为0，说明锁全部释放，删除key：&lt;code>DEL lock&lt;/code>&lt;/li>
&lt;li>大于0，说明锁还在使用，重置有效时间：&lt;code>EXPIRE lock 20&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>对应的Lua脚本如下：&lt;/p>
&lt;p>首先是获取锁：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-7">&lt;a class="lnlinks" href="#hl-3-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-8">&lt;a class="lnlinks" href="#hl-3-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-9">&lt;a class="lnlinks" href="#hl-3-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-10">&lt;a class="lnlinks" href="#hl-3-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-11">&lt;a class="lnlinks" href="#hl-3-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-12">&lt;a class="lnlinks" href="#hl-3-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-13">&lt;a class="lnlinks" href="#hl-3-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-14">&lt;a class="lnlinks" href="#hl-3-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-15">&lt;a class="lnlinks" href="#hl-3-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-16">&lt;a class="lnlinks" href="#hl-3-16">16&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="c1">-- 锁的key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">threadId&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="c1">-- 线程唯一标识&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">releaseTime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="c1">-- 锁的自动释放时间&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;exists&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">then&lt;/span> &lt;span class="c1">-- 判断是否存在&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;hset&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threadId&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;1&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">-- 不存在, 获取锁&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;expire&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">releaseTime&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">-- 设置有效期&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">-- 返回结果&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;hexists&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threadId&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">then&lt;/span> &lt;span class="c1">-- 锁已经存在，判断threadId是否是自己 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;hincrby&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threadId&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;1&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">-- 不存在, 获取锁，重入次数+1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;expire&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">releaseTime&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">-- 设置有效期&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">-- 返回结果&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">-- 代码走到这里,说明获取锁的不是自己，获取锁失败&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后是释放锁：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-5">&lt;a class="lnlinks" href="#hl-4-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-6">&lt;a class="lnlinks" href="#hl-4-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-7">&lt;a class="lnlinks" href="#hl-4-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-8">&lt;a class="lnlinks" href="#hl-4-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-9">&lt;a class="lnlinks" href="#hl-4-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-10">&lt;a class="lnlinks" href="#hl-4-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-11">&lt;a class="lnlinks" href="#hl-4-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-12">&lt;a class="lnlinks" href="#hl-4-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-13">&lt;a class="lnlinks" href="#hl-4-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-14">&lt;a class="lnlinks" href="#hl-4-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-15">&lt;a class="lnlinks" href="#hl-4-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-16">&lt;a class="lnlinks" href="#hl-4-16">16&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="c1">-- 锁的key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">threadId&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="c1">-- 线程唯一标识&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">releaseTime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="c1">-- 锁的自动释放时间&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;HEXISTS&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threadId&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">then&lt;/span> &lt;span class="c1">-- 判断当前锁是否还是被自己持有&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">-- 如果已经不是自己，则直接返回&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">local&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;HINCRBY&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threadId&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">-- 是自己的锁，则重入次数-1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">then&lt;/span> &lt;span class="c1">-- 判断是否重入次数是否已经为0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;EXPIRE&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">releaseTime&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">-- 大于0说明不能释放锁，重置有效期然后返回&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;DEL&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">-- 等于0说明可以释放锁，直接删除&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3高可用的锁">
&lt;a href="#3%e9%ab%98%e5%8f%af%e7%94%a8%e7%9a%84%e9%94%81" class="header-anchor">#&lt;/a>
3）高可用的锁
&lt;/h3>&lt;p>&lt;code>面试官问题&lt;/code>：redis分布式锁依赖与redis，如果redis宕机则锁失效。如何解决？&lt;/p>
&lt;p>此时大多数同学会回答说：搭建主从集群，做数据备份。&lt;/p>
&lt;p>这样就进入了陷阱，因为面试官的下一个问题就来了：&lt;/p>
&lt;p>&lt;code>面试官问题&lt;/code>：如果搭建主从集群做数据备份时，进程A获取锁，master还没有把数据备份到slave，master宕机，slave升级为master，此时原来锁失效，其它进程也可以获取锁，出现安全问题。如何解决？&lt;/p>
&lt;p>关于这个问题，Redis官网给出了解决方案，使用RedLock思路可以解决：&lt;/p>
&lt;blockquote>
&lt;p>在Redis的分布式环境中，我们假设有N个Redis master。这些节点完全互相独立，不存在主从复制或者其他集群协调机制。之前我们已经描述了在Redis单实例下怎么安全地获取和释放锁。我们确保将在每（N)个实例上使用此方法获取和释放锁。在这个样例中，我们假设有5个Redis master节点，这是一个比较合理的设置，所以我们需要在5台机器上面或者5台虚拟机上面运行这些实例，这样保证他们不会同时都宕掉。&lt;/p>
&lt;p>为了取到锁，客户端应该执行以下操作:&lt;/p>
&lt;ol>
&lt;li>获取当前Unix时间，以毫秒为单位。&lt;/li>
&lt;li>依次尝试从N个实例，使用相同的key和随机值获取锁。在步骤2，当向Redis设置锁时,客户端应该设置一个网络连接和响应超时时间，这个超时时间应该小于锁的失效时间。例如你的锁自动失效时间为10秒，则超时时间应该在5-50毫秒之间。这样可以避免服务器端Redis已经挂掉的情况下，客户端还在死死地等待响应结果。如果服务器端没有在规定时间内响应，客户端应该尽快尝试另外一个Redis实例。&lt;/li>
&lt;li>客户端使用当前时间减去开始获取锁时间（步骤1记录的时间）就得到获取锁使用的时间。当且仅当从大多数（这里是3个节点）的Redis节点都取到锁，并且使用的时间小于锁失效时间时，锁才算获取成功。&lt;/li>
&lt;li>如果取到了锁，key的真正有效时间等于有效时间减去获取锁所使用的时间（步骤3计算的结果）。&lt;/li>
&lt;li>如果因为某些原因，获取锁失败（&lt;em>没有&lt;/em>在至少N/2+1个Redis实例取到锁或者取锁时间已经超过了有效时间），客户端应该在所有的Redis实例上进行解锁（即便某些Redis实例根本就没有加锁成功）。&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;h2 id="311如何实现数据库与缓存数据一致">
&lt;a href="#311%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e6%95%b0%e6%8d%ae%e5%ba%93%e4%b8%8e%e7%bc%93%e5%ad%98%e6%95%b0%e6%8d%ae%e4%b8%80%e8%87%b4" class="header-anchor">#&lt;/a>
3.11.如何实现数据库与缓存数据一致？
&lt;/h2>&lt;p>面试话术：&lt;/p>
&lt;p>实现方案有下面几种：&lt;/p>
&lt;ul>
&lt;li>本地缓存同步：当前微服务的数据库数据与缓存数据同步，可以直接在数据库修改时加入对Redis的修改逻辑，保证一致。&lt;/li>
&lt;li>跨服务缓存同步：服务A调用了服务B，并对查询结果缓存。服务B数据库修改，可以通过MQ通知服务A，服务A修改Redis缓存数据&lt;/li>
&lt;li>通用方案：使用Canal框架，伪装成MySQL的salve节点，监听MySQL的binLog变化，然后修改Redis缓存数据&lt;/li>
&lt;/ul></description></item><item><title>2.SpringCloud实用篇02</title><link>https://logan.wssw.fun/p/2023/01/138f5613/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/138f5613/</guid><description>&lt;h1 id="springcloud实用篇02">
&lt;a href="#springcloud%e5%ae%9e%e7%94%a8%e7%af%8702" class="header-anchor">#&lt;/a>
SpringCloud实用篇02
&lt;/h1>&lt;h1 id="0学习目标">
&lt;a href="#0%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87" class="header-anchor">#&lt;/a>
0.学习目标
&lt;/h1>&lt;h1 id="1nacos配置管理">
&lt;a href="#1nacos%e9%85%8d%e7%bd%ae%e7%ae%a1%e7%90%86" class="header-anchor">#&lt;/a>
1.Nacos配置管理
&lt;/h1>&lt;p>Nacos除了可以做注册中心，同样可以做配置管理来使用。&lt;/p>
&lt;h2 id="11统一配置管理">
&lt;a href="#11%e7%bb%9f%e4%b8%80%e9%85%8d%e7%bd%ae%e7%ae%a1%e7%90%86" class="header-anchor">#&lt;/a>
1.1.统一配置管理
&lt;/h2>&lt;p>当微服务部署的实例越来越多，达到数十、数百时，逐个修改微服务配置就会让人抓狂，而且很容易出错。我们需要一种统一配置管理方案，可以集中管理所有实例的配置。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-ba6b0b0a38e19d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714164426792"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>Nacos一方面可以将配置集中管理，另一方可以在配置变更时，及时通知微服务，实现配置的热更新。&lt;/p>
&lt;h3 id="111在nacos中添加配置文件">
&lt;a href="#111%e5%9c%a8nacos%e4%b8%ad%e6%b7%bb%e5%8a%a0%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="header-anchor">#&lt;/a>
1.1.1.在nacos中添加配置文件
&lt;/h3>&lt;p>如何在nacos中管理配置呢？&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-04e956f583158c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714164742924"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后在弹出的表单中，填写配置信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-42e0d096998322.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714164856664"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;blockquote>
&lt;p>注意：项目的核心配置，需要热更新的配置才有放到nacos管理的必要。基本不会变更的一些配置还是保存在微服务本地比较好。&lt;/p>
&lt;/blockquote>
&lt;h3 id="112从微服务拉取配置">
&lt;a href="#112%e4%bb%8e%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%8b%89%e5%8f%96%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
1.1.2.从微服务拉取配置
&lt;/h3>&lt;p>微服务要拉取nacos中管理的配置，并且与本地的application.yml配置合并，才能完成项目启动。&lt;/p>
&lt;p>但如果尚未读取application.yml，又如何得知nacos地址呢？&lt;/p>
&lt;p>因此spring引入了一种新的配置文件：bootstrap.yaml文件，会在application.yml之前被读取，流程如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-d72ec0604d4690.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="img"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>1）引入nacos-config依赖&lt;/p>
&lt;p>首先，在user-service服务中，引入nacos-config的客户端依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!--nacos配置管理依赖--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.alibaba.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-alibaba-nacos-config&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）添加bootstrap.yaml&lt;/p>
&lt;p>然后，在user-service中添加一个bootstrap.yaml文件，内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-9">&lt;a class="lnlinks" href="#hl-1-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-10">&lt;a class="lnlinks" href="#hl-1-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">application&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">userservice&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 服务名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">profiles&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">active&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">dev&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#开发环境，这里是dev &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server-addr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost:8848&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Nacos地址&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">config&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">file-extension&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">yaml&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 文件后缀名&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里会根据spring.cloud.nacos.server-addr获取nacos地址，再根据&lt;/p>
&lt;p>&lt;code>${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}&lt;/code>作为文件id，来读取配置。&lt;/p>
&lt;p>本例中，就是去读取&lt;code>userservice-dev.yaml&lt;/code>：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-91a28040085521.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714170845901"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>3）读取nacos配置&lt;/p>
&lt;p>在user-service中的UserController中添加业务逻辑，读取pattern.dateformat配置：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-fbd13213d5f9f0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714170337448"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>完整代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-9">&lt;a class="lnlinks" href="#hl-2-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-10">&lt;a class="lnlinks" href="#hl-2-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-11">&lt;a class="lnlinks" href="#hl-2-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-12">&lt;a class="lnlinks" href="#hl-2-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-13">&lt;a class="lnlinks" href="#hl-2-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-14">&lt;a class="lnlinks" href="#hl-2-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-15">&lt;a class="lnlinks" href="#hl-2-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-16">&lt;a class="lnlinks" href="#hl-2-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-17">&lt;a class="lnlinks" href="#hl-2-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-18">&lt;a class="lnlinks" href="#hl-2-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-19">&lt;a class="lnlinks" href="#hl-2-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-20">&lt;a class="lnlinks" href="#hl-2-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-21">&lt;a class="lnlinks" href="#hl-2-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-22">&lt;a class="lnlinks" href="#hl-2-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-23">&lt;a class="lnlinks" href="#hl-2-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-24">&lt;a class="lnlinks" href="#hl-2-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-25">&lt;a class="lnlinks" href="#hl-2-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-26">&lt;a class="lnlinks" href="#hl-2-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-27">&lt;a class="lnlinks" href="#hl-2-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-28">&lt;a class="lnlinks" href="#hl-2-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-29">&lt;a class="lnlinks" href="#hl-2-29">29&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.user.web&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.user.pojo.User&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.user.service.UserService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.extern.slf4j.Slf4j&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.factory.annotation.Autowired&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.factory.annotation.Value&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.web.bind.annotation.*&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.time.LocalDateTime&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.time.format.DateTimeFormatter&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Slf4j&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@RestController&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@RequestMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/user&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">UserController&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UserService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">userService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Value&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;${pattern.dateformat}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dateformat&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@GetMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;now&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">now&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LocalDateTime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">now&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DateTimeFormatter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ofPattern&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dateformat&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// ...略&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在页面访问，可以看到效果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-c3b83b97f52d26.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714170449612"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="12配置热更新">
&lt;a href="#12%e9%85%8d%e7%bd%ae%e7%83%ad%e6%9b%b4%e6%96%b0" class="header-anchor">#&lt;/a>
1.2.配置热更新
&lt;/h2>&lt;p>我们最终的目的，是修改nacos中的配置后，微服务中无需重启即可让配置生效，也就是&lt;strong>配置热更新&lt;/strong>。&lt;/p>
&lt;p>要实现配置热更新，可以使用两种方式：&lt;/p>
&lt;h3 id="121方式一">
&lt;a href="#121%e6%96%b9%e5%bc%8f%e4%b8%80" class="header-anchor">#&lt;/a>
1.2.1.方式一
&lt;/h3>&lt;p>在@Value注入的变量所在类上添加注解@RefreshScope：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-512538ed0252e1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714171036335"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="122方式二">
&lt;a href="#122%e6%96%b9%e5%bc%8f%e4%ba%8c" class="header-anchor">#&lt;/a>
1.2.2.方式二
&lt;/h3>&lt;p>使用@ConfigurationProperties注解代替@Value注解。&lt;/p>
&lt;p>在user-service服务中，添加一个类，读取patterrn.dateformat属性：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-7">&lt;a class="lnlinks" href="#hl-3-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-8">&lt;a class="lnlinks" href="#hl-3-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-9">&lt;a class="lnlinks" href="#hl-3-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-10">&lt;a class="lnlinks" href="#hl-3-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-11">&lt;a class="lnlinks" href="#hl-3-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-12">&lt;a class="lnlinks" href="#hl-3-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.user.config&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.Data&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.boot.context.properties.ConfigurationProperties&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.stereotype.Component&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Component&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Data&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@ConfigurationProperties&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">prefix&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;pattern&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">PatternProperties&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dateformat&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在UserController中使用这个类代替@Value：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-9667f3510de5d1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714171316124"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>完整代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-5">&lt;a class="lnlinks" href="#hl-4-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-6">&lt;a class="lnlinks" href="#hl-4-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-7">&lt;a class="lnlinks" href="#hl-4-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-8">&lt;a class="lnlinks" href="#hl-4-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-9">&lt;a class="lnlinks" href="#hl-4-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-10">&lt;a class="lnlinks" href="#hl-4-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-11">&lt;a class="lnlinks" href="#hl-4-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-12">&lt;a class="lnlinks" href="#hl-4-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-13">&lt;a class="lnlinks" href="#hl-4-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-14">&lt;a class="lnlinks" href="#hl-4-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-15">&lt;a class="lnlinks" href="#hl-4-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-16">&lt;a class="lnlinks" href="#hl-4-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-17">&lt;a class="lnlinks" href="#hl-4-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-18">&lt;a class="lnlinks" href="#hl-4-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-19">&lt;a class="lnlinks" href="#hl-4-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-20">&lt;a class="lnlinks" href="#hl-4-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-21">&lt;a class="lnlinks" href="#hl-4-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-22">&lt;a class="lnlinks" href="#hl-4-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-23">&lt;a class="lnlinks" href="#hl-4-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-24">&lt;a class="lnlinks" href="#hl-4-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-25">&lt;a class="lnlinks" href="#hl-4-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-26">&lt;a class="lnlinks" href="#hl-4-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-27">&lt;a class="lnlinks" href="#hl-4-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-28">&lt;a class="lnlinks" href="#hl-4-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-29">&lt;a class="lnlinks" href="#hl-4-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-30">&lt;a class="lnlinks" href="#hl-4-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-31">&lt;a class="lnlinks" href="#hl-4-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-32">&lt;a class="lnlinks" href="#hl-4-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-33">&lt;a class="lnlinks" href="#hl-4-33">33&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.user.web&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.user.config.PatternProperties&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.user.pojo.User&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.user.service.UserService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.extern.slf4j.Slf4j&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.factory.annotation.Autowired&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.web.bind.annotation.GetMapping&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.web.bind.annotation.PathVariable&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.web.bind.annotation.RequestMapping&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.web.bind.annotation.RestController&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.time.LocalDateTime&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.time.format.DateTimeFormatter&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Slf4j&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@RestController&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@RequestMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/user&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">UserController&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UserService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">userService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PatternProperties&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">patternProperties&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@GetMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;now&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">now&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LocalDateTime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">now&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DateTimeFormatter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ofPattern&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">patternProperties&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getDateformat&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 略&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="13配置共享">
&lt;a href="#13%e9%85%8d%e7%bd%ae%e5%85%b1%e4%ba%ab" class="header-anchor">#&lt;/a>
1.3.配置共享
&lt;/h2>&lt;p>其实微服务启动时，会去nacos读取多个配置文件，例如：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>[spring.application.name]-[spring.profiles.active].yaml&lt;/code>，例如：userservice-dev.yaml&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>[spring.application.name].yaml&lt;/code>，例如：userservice.yaml&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>而&lt;code>[spring.application.name].yaml&lt;/code>不包含环境，因此可以被多个环境共享。&lt;/p>
&lt;p>下面我们通过案例来测试配置共享&lt;/p>
&lt;h3 id="1添加一个环境共享配置">
&lt;a href="#1%e6%b7%bb%e5%8a%a0%e4%b8%80%e4%b8%aa%e7%8e%af%e5%a2%83%e5%85%b1%e4%ba%ab%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
1）添加一个环境共享配置
&lt;/h3>&lt;p>我们在nacos中添加一个userservice.yaml文件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-07bee6894b1508.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714173233650"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="2在user-service中读取共享配置">
&lt;a href="#2%e5%9c%a8user-service%e4%b8%ad%e8%af%bb%e5%8f%96%e5%85%b1%e4%ba%ab%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
2）在user-service中读取共享配置
&lt;/h3>&lt;p>在user-service服务中，修改PatternProperties类，读取新添加的属性：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-1bc4dc929788f7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714173324231"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在user-service服务中，修改UserController，添加一个方法：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-1abb236a205d35.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714173721309"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="3运行两个userapplication使用不同的profile">
&lt;a href="#3%e8%bf%90%e8%a1%8c%e4%b8%a4%e4%b8%aauserapplication%e4%bd%bf%e7%94%a8%e4%b8%8d%e5%90%8c%e7%9a%84profile" class="header-anchor">#&lt;/a>
3）运行两个UserApplication，使用不同的profile
&lt;/h3>&lt;p>修改UserApplication2这个启动项，改变其profile值：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-2edfa012078a30.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714173538538"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-fac57f69858901.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714173519963"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这样，UserApplication(8081)使用的profile是dev，UserApplication2(8082)使用的profile是test。&lt;/p>
&lt;p>启动UserApplication和UserApplication2&lt;/p>
&lt;p>访问http://localhost:8081/user/prop，结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-a6a0373760d75a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714174313344"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>访问http://localhost:8082/user/prop，结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-e0d0bfe94acb12.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714174424818"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看出来，不管是dev，还是test环境，都读取到了envSharedValue这个属性的值。&lt;/p>
&lt;h3 id="4配置共享的优先级">
&lt;a href="#4%e9%85%8d%e7%bd%ae%e5%85%b1%e4%ba%ab%e7%9a%84%e4%bc%98%e5%85%88%e7%ba%a7" class="header-anchor">#&lt;/a>
4）配置共享的优先级
&lt;/h3>&lt;p>当nacos、服务本地同时出现相同属性时，优先级有高低之分：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-3a4ecc07d5744b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714174623557"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="14搭建nacos集群">
&lt;a href="#14%e6%90%ad%e5%bb%banacos%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
1.4.搭建Nacos集群
&lt;/h2>&lt;p>Nacos生产环境下一定要部署为集群状态，部署方式参考课前资料中的文档：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-df841009ebb24e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714174728042"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="2feign远程调用">
&lt;a href="#2feign%e8%bf%9c%e7%a8%8b%e8%b0%83%e7%94%a8" class="header-anchor">#&lt;/a>
2.Feign远程调用
&lt;/h1>&lt;p>先来看我们以前利用RestTemplate发起远程调用的代码：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-95c8b00e1c04f6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714174814204"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>存在下面的问题：&lt;/p>
&lt;p>•代码可读性差，编程体验不统一&lt;/p>
&lt;p>•参数复杂URL难以维护&lt;/p>
&lt;p>Feign是一个声明式的http客户端，官方地址：https://github.com/OpenFeign/feign&lt;/p>
&lt;p>其作用就是帮助我们优雅的实现http请求的发送，解决上面提到的问题。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-b363710bd0ce62.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714174918088"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="21feign替代resttemplate">
&lt;a href="#21feign%e6%9b%bf%e4%bb%a3resttemplate" class="header-anchor">#&lt;/a>
2.1.Feign替代RestTemplate
&lt;/h2>&lt;p>Fegin的使用步骤如下：&lt;/p>
&lt;h3 id="1引入依赖">
&lt;a href="#1%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96" class="header-anchor">#&lt;/a>
1）引入依赖
&lt;/h3>&lt;p>我们在order-service服务的pom文件中引入feign的依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-4">&lt;a class="lnlinks" href="#hl-5-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-openfeign&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2添加注解">
&lt;a href="#2%e6%b7%bb%e5%8a%a0%e6%b3%a8%e8%a7%a3" class="header-anchor">#&lt;/a>
2）添加注解
&lt;/h3>&lt;p>在order-service的启动类添加注解开启Feign的功能：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-f5f40e32d0bb97.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714175102524"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="3编写feign的客户端">
&lt;a href="#3%e7%bc%96%e5%86%99feign%e7%9a%84%e5%ae%a2%e6%88%b7%e7%ab%af" class="header-anchor">#&lt;/a>
3）编写Feign的客户端
&lt;/h3>&lt;p>在order-service中新建一个接口，内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-5">&lt;a class="lnlinks" href="#hl-6-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-6">&lt;a class="lnlinks" href="#hl-6-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-7">&lt;a class="lnlinks" href="#hl-6-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-8">&lt;a class="lnlinks" href="#hl-6-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-9">&lt;a class="lnlinks" href="#hl-6-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-10">&lt;a class="lnlinks" href="#hl-6-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-11">&lt;a class="lnlinks" href="#hl-6-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-12">&lt;a class="lnlinks" href="#hl-6-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.order.client&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.order.pojo.User&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.cloud.openfeign.FeignClient&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.web.bind.annotation.GetMapping&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.web.bind.annotation.PathVariable&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@FeignClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;userservice&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">interface&lt;/span> &lt;span class="nc">UserClient&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@GetMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/user/{id}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">User&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">findById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nd">@PathVariable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个客户端主要是基于SpringMVC的注解来声明远程调用的信息，比如：&lt;/p>
&lt;ul>
&lt;li>服务名称：userservice&lt;/li>
&lt;li>请求方式：GET&lt;/li>
&lt;li>请求路径：/user/{id}&lt;/li>
&lt;li>请求参数：Long id&lt;/li>
&lt;li>返回值类型：User&lt;/li>
&lt;/ul>
&lt;p>这样，Feign就可以帮助我们发送http请求，无需自己使用RestTemplate来发送了。&lt;/p>
&lt;h3 id="4测试">
&lt;a href="#4%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
4）测试
&lt;/h3>&lt;p>修改order-service中的OrderService类中的queryOrderById方法，使用Feign客户端代替RestTemplate：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-7c98267fb7d7f6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714175415087"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>是不是看起来优雅多了。&lt;/p>
&lt;h3 id="5总结">
&lt;a href="#5%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
5）总结
&lt;/h3>&lt;p>使用Feign的步骤：&lt;/p>
&lt;p>① 引入依赖&lt;/p>
&lt;p>② 添加@EnableFeignClients注解&lt;/p>
&lt;p>③ 编写FeignClient接口&lt;/p>
&lt;p>④ 使用FeignClient中定义的方法代替RestTemplate&lt;/p>
&lt;h2 id="22自定义配置">
&lt;a href="#22%e8%87%aa%e5%ae%9a%e4%b9%89%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
2.2.自定义配置
&lt;/h2>&lt;p>Feign可以支持很多的自定义配置，如下表所示：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>类型&lt;/th>
&lt;th>作用&lt;/th>
&lt;th>说明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>feign.Logger.Level&lt;/strong>&lt;/td>
&lt;td>修改日志级别&lt;/td>
&lt;td>包含四种不同的级别：NONE、BASIC、HEADERS、FULL&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>feign.codec.Decoder&lt;/td>
&lt;td>响应结果的解析器&lt;/td>
&lt;td>http远程调用的结果做解析，例如解析json字符串为java对象&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>feign.codec.Encoder&lt;/td>
&lt;td>请求参数编码&lt;/td>
&lt;td>将请求参数编码，便于通过http请求发送&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>feign. Contract&lt;/td>
&lt;td>支持的注解格式&lt;/td>
&lt;td>默认是SpringMVC的注解&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>feign. Retryer&lt;/td>
&lt;td>失败重试机制&lt;/td>
&lt;td>请求失败的重试机制，默认是没有，不过会使用Ribbon的重试&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>一般情况下，默认值就能满足我们使用，如果要自定义时，只需要创建自定义的@Bean覆盖默认Bean即可。&lt;/p>
&lt;p>下面以日志为例来演示如何自定义配置。&lt;/p>
&lt;h3 id="221配置文件方式">
&lt;a href="#221%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e6%96%b9%e5%bc%8f" class="header-anchor">#&lt;/a>
2.2.1.配置文件方式
&lt;/h3>&lt;p>基于配置文件修改feign的日志级别可以针对单个服务：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">feign&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">client&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">config&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">userservice&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 针对某个微服务的配置&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">loggerLevel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">FULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 日志级别 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>也可以针对所有服务：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">feign&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">client&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">config&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 这里用default就是全局配置，如果是写服务名称，则是针对某个微服务的配置&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">loggerLevel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">FULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 日志级别 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>而日志的级别分为四种：&lt;/p>
&lt;ul>
&lt;li>NONE：不记录任何日志信息，这是默认值。&lt;/li>
&lt;li>BASIC：仅记录请求的方法，URL以及响应状态码和执行时间&lt;/li>
&lt;li>HEADERS：在BASIC的基础上，额外记录了请求和响应的头信息&lt;/li>
&lt;li>FULL：记录所有请求和响应的明细，包括头信息、请求体、元数据。&lt;/li>
&lt;/ul>
&lt;h3 id="222java代码方式">
&lt;a href="#222java%e4%bb%a3%e7%a0%81%e6%96%b9%e5%bc%8f" class="header-anchor">#&lt;/a>
2.2.2.Java代码方式
&lt;/h3>&lt;p>也可以基于Java代码来修改日志级别，先声明一个类，然后声明一个Logger.Level的对象：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-5">&lt;a class="lnlinks" href="#hl-9-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-6">&lt;a class="lnlinks" href="#hl-9-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">DefaultFeignConfiguration&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">Level&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">feignLogLevel&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">Level&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">BASIC&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// 日志级别为BASIC&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果要&lt;strong>全局生效&lt;/strong>，将其放到启动类的@EnableFeignClients这个注解中：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@EnableFeignClients&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">defaultConfiguration&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultFeignConfiguration&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果是&lt;strong>局部生效&lt;/strong>，则把它放到对应的@FeignClient这个注解中：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@FeignClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;userservice&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">configuration&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultFeignConfiguration&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="23feign使用优化">
&lt;a href="#23feign%e4%bd%bf%e7%94%a8%e4%bc%98%e5%8c%96" class="header-anchor">#&lt;/a>
2.3.Feign使用优化
&lt;/h2>&lt;p>Feign底层发起http请求，依赖于其它的框架。其底层客户端实现包括：&lt;/p>
&lt;p>•URLConnection：默认实现，不支持连接池&lt;/p>
&lt;p>•Apache HttpClient ：支持连接池&lt;/p>
&lt;p>•OKHttp：支持连接池&lt;/p>
&lt;p>因此提高Feign的性能主要手段就是使用&lt;strong>连接池&lt;/strong>代替默认的URLConnection。&lt;/p>
&lt;p>这里我们用Apache的HttpClient来演示。&lt;/p>
&lt;p>1）引入依赖&lt;/p>
&lt;p>在order-service的pom文件中引入Apache的HttpClient依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!--httpClient的依赖 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>io.github.openfeign&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>feign-httpclient&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）配置连接池&lt;/p>
&lt;p>在order-service的application.yml中添加配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-6">&lt;a class="lnlinks" href="#hl-13-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-7">&lt;a class="lnlinks" href="#hl-13-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-8">&lt;a class="lnlinks" href="#hl-13-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-9">&lt;a class="lnlinks" href="#hl-13-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">feign&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">client&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">config&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># default全局的配置&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">loggerLevel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">BASIC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 日志级别，BASIC就是基本的请求和响应信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">httpclient&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">enabled&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 开启feign对HttpClient的支持&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">max-connections&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">200&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 最大的连接数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">max-connections-per-route&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">50&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 每个路径的最大连接数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>接下来，在FeignClientFactoryBean中的loadBalance方法中打断点：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-78ba907f941ae4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714185925910"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>Debug方式启动order-service服务，可以看到这里的client，底层就是Apache HttpClient：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-74d3ca14785306.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714190041542"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>总结，Feign的优化：&lt;/p>
&lt;p>1.日志级别尽量用basic&lt;/p>
&lt;p>2.使用HttpClient或OKHttp代替URLConnection&lt;/p>
&lt;p>① 引入feign-httpClient依赖&lt;/p>
&lt;p>② 配置文件开启httpClient功能，设置连接池参数&lt;/p>
&lt;h2 id="24最佳实践">
&lt;a href="#24%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" class="header-anchor">#&lt;/a>
2.4.最佳实践
&lt;/h2>&lt;p>所谓最近实践，就是使用过程中总结的经验，最好的一种使用方式。&lt;/p>
&lt;p>自习观察可以发现，Feign的客户端与服务提供者的controller代码非常相似：&lt;/p>
&lt;p>feign客户端：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-fd410c97f88649.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714190542730"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>UserController：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-35d99a94a8448e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714190528450"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>有没有一种办法简化这种重复的代码编写呢？&lt;/p>
&lt;h3 id="241继承方式">
&lt;a href="#241%e7%bb%a7%e6%89%bf%e6%96%b9%e5%bc%8f" class="header-anchor">#&lt;/a>
2.4.1.继承方式
&lt;/h3>&lt;p>一样的代码可以通过继承来共享：&lt;/p>
&lt;p>1）定义一个API接口，利用定义方法，并基于SpringMVC注解做声明。&lt;/p>
&lt;p>2）Feign客户端和Controller都集成改接口&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-7080c0858811ce.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714190640857"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>优点：&lt;/p>
&lt;ul>
&lt;li>简单&lt;/li>
&lt;li>实现了代码共享&lt;/li>
&lt;/ul>
&lt;p>缺点：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>服务提供方、服务消费方紧耦合&lt;/p>
&lt;/li>
&lt;li>
&lt;p>参数列表中的注解映射并不会继承，因此Controller中必须再次声明方法、参数列表、注解&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="242抽取方式">
&lt;a href="#242%e6%8a%bd%e5%8f%96%e6%96%b9%e5%bc%8f" class="header-anchor">#&lt;/a>
2.4.2.抽取方式
&lt;/h3>&lt;p>将Feign的Client抽取为独立模块，并且把接口有关的POJO、默认的Feign配置都放到这个模块中，提供给所有消费者使用。&lt;/p>
&lt;p>例如，将UserClient、User、Feign的默认配置都抽取到一个feign-api包中，所有微服务引用该依赖包，即可直接使用。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-86ba631b562abc.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714214041796"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="243实现基于抽取的最佳实践">
&lt;a href="#243%e5%ae%9e%e7%8e%b0%e5%9f%ba%e4%ba%8e%e6%8a%bd%e5%8f%96%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" class="header-anchor">#&lt;/a>
2.4.3.实现基于抽取的最佳实践
&lt;/h3>&lt;h4 id="1抽取">
&lt;a href="#1%e6%8a%bd%e5%8f%96" class="header-anchor">#&lt;/a>
1）抽取
&lt;/h4>&lt;p>首先创建一个module，命名为feign-api：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-2da08aa0076263.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714204557771"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>项目结构：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-740eb4b396dedf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714204656214"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在feign-api中然后引入feign的starter依赖&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-openfeign&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后，order-service中编写的UserClient、User、DefaultFeignConfiguration都复制到feign-api项目中&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-f8870e7f5cb9d7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714205221970"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h4 id="2在order-service中使用feign-api">
&lt;a href="#2%e5%9c%a8order-service%e4%b8%ad%e4%bd%bf%e7%94%a8feign-api" class="header-anchor">#&lt;/a>
2）在order-service中使用feign-api
&lt;/h4>&lt;p>首先，删除order-service中的UserClient、User、DefaultFeignConfiguration等类或接口。&lt;/p>
&lt;p>在order-service的pom文件中中引入feign-api的依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>cn.itcast.demo&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>feign-api&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>1.0&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改order-service中的所有与上述三个组件有关的导包部分，改成导入feign-api中的包&lt;/p>
&lt;h4 id="3重启测试">
&lt;a href="#3%e9%87%8d%e5%90%af%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
3）重启测试
&lt;/h4>&lt;p>重启后，发现服务报错了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-bbc51c36082851.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714205623048"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这是因为UserClient现在在cn.itcast.feign.clients包下，&lt;/p>
&lt;p>而order-service的@EnableFeignClients注解是在cn.itcast.order包下，不在同一个包，无法扫描到UserClient。&lt;/p>
&lt;h4 id="4解决扫描包问题">
&lt;a href="#4%e8%a7%a3%e5%86%b3%e6%89%ab%e6%8f%8f%e5%8c%85%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
4）解决扫描包问题
&lt;/h4>&lt;p>方式一：&lt;/p>
&lt;p>指定Feign应该扫描的包：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@EnableFeignClients&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">basePackages&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;cn.itcast.feign.clients&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>方式二：&lt;/p>
&lt;p>指定需要加载的Client接口：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@EnableFeignClients&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clients&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">UserClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">})&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="3gateway服务网关">
&lt;a href="#3gateway%e6%9c%8d%e5%8a%a1%e7%bd%91%e5%85%b3" class="header-anchor">#&lt;/a>
3.Gateway服务网关
&lt;/h1>&lt;p>Spring Cloud Gateway 是 Spring Cloud 的一个全新项目，该项目是基于 Spring 5.0，Spring Boot 2.0 和 Project Reactor 等响应式编程和事件流技术开发的网关，它旨在为微服务架构提供一种简单有效的统一的 API 路由管理方式。&lt;/p>
&lt;h2 id="31为什么需要网关">
&lt;a href="#31%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e7%bd%91%e5%85%b3" class="header-anchor">#&lt;/a>
3.1.为什么需要网关
&lt;/h2>&lt;p>Gateway网关是我们服务的守门神，所有微服务的统一入口。&lt;/p>
&lt;p>网关的&lt;strong>核心功能特性&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>请求路由&lt;/li>
&lt;li>权限控制&lt;/li>
&lt;li>限流&lt;/li>
&lt;/ul>
&lt;p>架构图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-f14a9be22abda7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714210131152"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>&lt;strong>权限控制&lt;/strong>：网关作为微服务入口，需要校验用户是是否有请求资格，如果没有则进行拦截。&lt;/p>
&lt;p>&lt;strong>路由和负载均衡&lt;/strong>：一切请求都必须先经过gateway，但网关不处理业务，而是根据某种规则，把请求转发到某个微服务，这个过程叫做路由。当然路由的目标服务有多个时，还需要做负载均衡。&lt;/p>
&lt;p>&lt;strong>限流&lt;/strong>：当请求流量过高时，在网关中按照下流的微服务能够接受的速度来放行请求，避免服务压力过大。&lt;/p>
&lt;p>在SpringCloud中网关的实现包括两种：&lt;/p>
&lt;ul>
&lt;li>gateway&lt;/li>
&lt;li>zuul&lt;/li>
&lt;/ul>
&lt;p>Zuul是基于Servlet的实现，属于阻塞式编程。而SpringCloudGateway则是基于Spring5中提供的WebFlux，属于响应式编程的实现，具备更好的性能。&lt;/p>
&lt;h2 id="32gateway快速入门">
&lt;a href="#32gateway%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8" class="header-anchor">#&lt;/a>
3.2.gateway快速入门
&lt;/h2>&lt;p>下面，我们就演示下网关的基本路由功能。基本步骤如下：&lt;/p>
&lt;ol>
&lt;li>创建SpringBoot工程gateway，引入网关依赖&lt;/li>
&lt;li>编写启动类&lt;/li>
&lt;li>编写基础配置和路由规则&lt;/li>
&lt;li>启动网关服务进行测试&lt;/li>
&lt;/ol>
&lt;h3 id="1创建gateway服务引入依赖">
&lt;a href="#1%e5%88%9b%e5%bb%bagateway%e6%9c%8d%e5%8a%a1%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96" class="header-anchor">#&lt;/a>
1）创建gateway服务，引入依赖
&lt;/h3>&lt;p>创建服务：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-d500bfc3e9e3f4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714210919458"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>引入依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-5">&lt;a class="lnlinks" href="#hl-18-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-6">&lt;a class="lnlinks" href="#hl-18-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-7">&lt;a class="lnlinks" href="#hl-18-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-8">&lt;a class="lnlinks" href="#hl-18-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-9">&lt;a class="lnlinks" href="#hl-18-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-10">&lt;a class="lnlinks" href="#hl-18-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!--网关--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-gateway&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!--nacos服务发现依赖--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.alibaba.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-alibaba-nacos-discovery&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2编写启动类">
&lt;a href="#2%e7%bc%96%e5%86%99%e5%90%af%e5%8a%a8%e7%b1%bb" class="header-anchor">#&lt;/a>
2）编写启动类
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-5">&lt;a class="lnlinks" href="#hl-19-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-6">&lt;a class="lnlinks" href="#hl-19-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-7">&lt;a class="lnlinks" href="#hl-19-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-8">&lt;a class="lnlinks" href="#hl-19-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-9">&lt;a class="lnlinks" href="#hl-19-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-10">&lt;a class="lnlinks" href="#hl-19-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-11">&lt;a class="lnlinks" href="#hl-19-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-12">&lt;a class="lnlinks" href="#hl-19-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.gateway&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.boot.SpringApplication&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@SpringBootApplication&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">GatewayApplication&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SpringApplication&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">GatewayApplication&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3编写基础配置和路由规则">
&lt;a href="#3%e7%bc%96%e5%86%99%e5%9f%ba%e7%a1%80%e9%85%8d%e7%bd%ae%e5%92%8c%e8%b7%af%e7%94%b1%e8%a7%84%e5%88%99" class="header-anchor">#&lt;/a>
3）编写基础配置和路由规则
&lt;/h3>&lt;p>创建application.yml文件，内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-4">&lt;a class="lnlinks" href="#hl-20-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-5">&lt;a class="lnlinks" href="#hl-20-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-6">&lt;a class="lnlinks" href="#hl-20-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-7">&lt;a class="lnlinks" href="#hl-20-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-8">&lt;a class="lnlinks" href="#hl-20-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-9">&lt;a class="lnlinks" href="#hl-20-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-10">&lt;a class="lnlinks" href="#hl-20-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-11">&lt;a class="lnlinks" href="#hl-20-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-12">&lt;a class="lnlinks" href="#hl-20-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-13">&lt;a class="lnlinks" href="#hl-20-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-14">&lt;a class="lnlinks" href="#hl-20-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-15">&lt;a class="lnlinks" href="#hl-20-15">15&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10010&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 网关端口&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">application&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gateway&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 服务名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server-addr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost:8848&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># nacos地址&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gateway&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">routes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 网关路由配置&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">user-service&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 路由id，自定义，只要唯一即可&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">uri&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">lb://userservice&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 路由的目标地址 lb就是负载均衡，后面跟服务名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">predicates&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 路由断言，也就是判断请求是否符合路由规则的条件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Path=/user/**&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 这个是按照路径匹配，只要以/user/开头就符合要求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我们将符合&lt;code>Path&lt;/code> 规则的一切请求，都代理到 &lt;code>uri&lt;/code>参数指定的地址。&lt;/p>
&lt;p>本例中，我们将 &lt;code>/user/**&lt;/code>开头的请求，代理到&lt;code>lb://userservice&lt;/code>，lb是负载均衡，根据服务名拉取服务列表，实现负载均衡。&lt;/p>
&lt;h3 id="4重启测试">
&lt;a href="#4%e9%87%8d%e5%90%af%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
4）重启测试
&lt;/h3>&lt;p>重启网关，访问http://localhost:10010/user/1时，符合&lt;code>/user/**&lt;/code>规则，请求转发到uri：http://userservice/user/1，得到了结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-758c9888562fce.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714211908341"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="5网关路由的流程图">
&lt;a href="#5%e7%bd%91%e5%85%b3%e8%b7%af%e7%94%b1%e7%9a%84%e6%b5%81%e7%a8%8b%e5%9b%be" class="header-anchor">#&lt;/a>
5）网关路由的流程图
&lt;/h3>&lt;p>整个访问的流程如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-58c8d285f57d0e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714211742956"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>总结：&lt;/p>
&lt;p>网关搭建步骤：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>创建项目，引入nacos服务发现和gateway依赖&lt;/p>
&lt;/li>
&lt;li>
&lt;p>配置application.yml，包括服务基本信息、nacos地址、路由&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>路由配置包括：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>路由id：路由的唯一标示&lt;/p>
&lt;/li>
&lt;li>
&lt;p>路由目标（uri）：路由的目标地址，http代表固定地址，lb代表根据服务名负载均衡&lt;/p>
&lt;/li>
&lt;li>
&lt;p>路由断言（predicates）：判断路由的规则，&lt;/p>
&lt;/li>
&lt;li>
&lt;p>路由过滤器（filters）：对请求或响应做处理&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>接下来，就重点来学习路由断言和路由过滤器的详细知识&lt;/p>
&lt;h2 id="33断言工厂">
&lt;a href="#33%e6%96%ad%e8%a8%80%e5%b7%a5%e5%8e%82" class="header-anchor">#&lt;/a>
3.3.断言工厂
&lt;/h2>&lt;p>我们在配置文件中写的断言规则只是字符串，这些字符串会被Predicate Factory读取并处理，转变为路由判断的条件&lt;/p>
&lt;p>例如Path=/user/**是按照路径匹配，这个规则是由&lt;/p>
&lt;p>&lt;code>org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory&lt;/code>类来&lt;/p>
&lt;p>处理的，像这样的断言工厂在SpringCloudGateway还有十几个:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>名称&lt;/strong>&lt;/th>
&lt;th>&lt;strong>说明&lt;/strong>&lt;/th>
&lt;th>&lt;strong>示例&lt;/strong>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>After&lt;/td>
&lt;td>是某个时间点后的请求&lt;/td>
&lt;td>- After=2037-01-20T17:42:47.789-07:00[America/Denver]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Before&lt;/td>
&lt;td>是某个时间点之前的请求&lt;/td>
&lt;td>- Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Between&lt;/td>
&lt;td>是某两个时间点之前的请求&lt;/td>
&lt;td>- Between=2037-01-20T17:42:47.789-07:00[America/Denver], 2037-01-21T17:42:47.789-07:00[America/Denver]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Cookie&lt;/td>
&lt;td>请求必须包含某些cookie&lt;/td>
&lt;td>- Cookie=chocolate, ch.p&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Header&lt;/td>
&lt;td>请求必须包含某些header&lt;/td>
&lt;td>- Header=X-Request-Id, \d+&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Host&lt;/td>
&lt;td>请求必须是访问某个host（域名）&lt;/td>
&lt;td>- Host=&lt;strong>.somehost.org,&lt;/strong>.anotherhost.org&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Method&lt;/td>
&lt;td>请求方式必须是指定方式&lt;/td>
&lt;td>- Method=GET,POST&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Path&lt;/td>
&lt;td>请求路径必须符合指定规则&lt;/td>
&lt;td>- Path=/red/{segment},/blue/**&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Query&lt;/td>
&lt;td>请求参数必须包含指定参数&lt;/td>
&lt;td>- Query=name, Jack或者- Query=name&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>RemoteAddr&lt;/td>
&lt;td>请求者的ip必须是指定范围&lt;/td>
&lt;td>- RemoteAddr=192.168.1.1/24&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Weight&lt;/td>
&lt;td>权重处理&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>我们只需要掌握Path这种路由工程就可以了。&lt;/p>
&lt;h2 id="34过滤器工厂">
&lt;a href="#34%e8%bf%87%e6%bb%a4%e5%99%a8%e5%b7%a5%e5%8e%82" class="header-anchor">#&lt;/a>
3.4.过滤器工厂
&lt;/h2>&lt;p>GatewayFilter是网关中提供的一种过滤器，可以对进入网关的请求和微服务返回的响应做处理：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-db0f91cd6c97d0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714212312871"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="341路由过滤器的种类">
&lt;a href="#341%e8%b7%af%e7%94%b1%e8%bf%87%e6%bb%a4%e5%99%a8%e7%9a%84%e7%a7%8d%e7%b1%bb" class="header-anchor">#&lt;/a>
3.4.1.路由过滤器的种类
&lt;/h3>&lt;p>Spring提供了31种不同的路由过滤器工厂。例如：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>名称&lt;/strong>&lt;/th>
&lt;th>&lt;strong>说明&lt;/strong>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>AddRequestHeader&lt;/td>
&lt;td>给当前请求添加一个请求头&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>RemoveRequestHeader&lt;/td>
&lt;td>移除请求中的一个请求头&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AddResponseHeader&lt;/td>
&lt;td>给响应结果中添加一个响应头&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>RemoveResponseHeader&lt;/td>
&lt;td>从响应结果中移除有一个响应头&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>RequestRateLimiter&lt;/td>
&lt;td>限制请求的流量&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="342请求头过滤器">
&lt;a href="#342%e8%af%b7%e6%b1%82%e5%a4%b4%e8%bf%87%e6%bb%a4%e5%99%a8" class="header-anchor">#&lt;/a>
3.4.2.请求头过滤器
&lt;/h3>&lt;p>下面我们以AddRequestHeader 为例来讲解。&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>需求&lt;/strong>：给所有进入userservice的请求添加一个请求头：Truth=itcast is freaking awesome!&lt;/p>
&lt;/blockquote>
&lt;p>只需要修改gateway服务的application.yml文件，添加路由过滤即可：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-21-1">&lt;a class="lnlinks" href="#hl-21-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-2">&lt;a class="lnlinks" href="#hl-21-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-3">&lt;a class="lnlinks" href="#hl-21-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-4">&lt;a class="lnlinks" href="#hl-21-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-5">&lt;a class="lnlinks" href="#hl-21-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-6">&lt;a class="lnlinks" href="#hl-21-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-7">&lt;a class="lnlinks" href="#hl-21-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-8">&lt;a class="lnlinks" href="#hl-21-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-9">&lt;a class="lnlinks" href="#hl-21-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-10">&lt;a class="lnlinks" href="#hl-21-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gateway&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">routes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">user-service &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">uri&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">lb://userservice &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">predicates&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Path=/user/** &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">filters&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 过滤器&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">AddRequestHeader=Truth, Itcast is freaking awesome!&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 添加请求头&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>当前过滤器写在userservice路由下，因此仅仅对访问userservice的请求有效。&lt;/p>
&lt;h3 id="343默认过滤器">
&lt;a href="#343%e9%bb%98%e8%ae%a4%e8%bf%87%e6%bb%a4%e5%99%a8" class="header-anchor">#&lt;/a>
3.4.3.默认过滤器
&lt;/h3>&lt;p>如果要对所有的路由都生效，则可以将过滤器工厂写到default下。格式如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-22-1">&lt;a class="lnlinks" href="#hl-22-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-2">&lt;a class="lnlinks" href="#hl-22-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-3">&lt;a class="lnlinks" href="#hl-22-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-4">&lt;a class="lnlinks" href="#hl-22-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-5">&lt;a class="lnlinks" href="#hl-22-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-6">&lt;a class="lnlinks" href="#hl-22-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-7">&lt;a class="lnlinks" href="#hl-22-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-8">&lt;a class="lnlinks" href="#hl-22-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-9">&lt;a class="lnlinks" href="#hl-22-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-10">&lt;a class="lnlinks" href="#hl-22-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gateway&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">routes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">user-service &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">uri&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">lb://userservice &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">predicates&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Path=/user/**&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">default-filters&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 默认过滤项&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">AddRequestHeader=Truth, Itcast is freaking awesome! &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="344总结">
&lt;a href="#344%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
3.4.4.总结
&lt;/h3>&lt;p>过滤器的作用是什么？&lt;/p>
&lt;p>① 对路由的请求或响应做加工处理，比如添加请求头&lt;/p>
&lt;p>② 配置在路由下的过滤器只对当前路由的请求生效&lt;/p>
&lt;p>defaultFilters的作用是什么？&lt;/p>
&lt;p>① 对所有路由都生效的过滤器&lt;/p>
&lt;h2 id="35全局过滤器">
&lt;a href="#35%e5%85%a8%e5%b1%80%e8%bf%87%e6%bb%a4%e5%99%a8" class="header-anchor">#&lt;/a>
3.5.全局过滤器
&lt;/h2>&lt;p>上一节学习的过滤器，网关提供了31种，但每一种过滤器的作用都是固定的。如果我们希望拦截请求，做自己的业务逻辑则没办法实现。&lt;/p>
&lt;h3 id="351全局过滤器作用">
&lt;a href="#351%e5%85%a8%e5%b1%80%e8%bf%87%e6%bb%a4%e5%99%a8%e4%bd%9c%e7%94%a8" class="header-anchor">#&lt;/a>
3.5.1.全局过滤器作用
&lt;/h3>&lt;p>全局过滤器的作用也是处理一切进入网关的请求和微服务响应，与GatewayFilter的作用一样。区别在于GatewayFilter通过配置定义，处理逻辑是固定的；而GlobalFilter的逻辑需要自己写代码实现。&lt;/p>
&lt;p>定义方式是实现GlobalFilter接口。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-23-1">&lt;a class="lnlinks" href="#hl-23-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-2">&lt;a class="lnlinks" href="#hl-23-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-3">&lt;a class="lnlinks" href="#hl-23-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-4">&lt;a class="lnlinks" href="#hl-23-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-5">&lt;a class="lnlinks" href="#hl-23-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-6">&lt;a class="lnlinks" href="#hl-23-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-7">&lt;a class="lnlinks" href="#hl-23-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-8">&lt;a class="lnlinks" href="#hl-23-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-9">&lt;a class="lnlinks" href="#hl-23-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-10">&lt;a class="lnlinks" href="#hl-23-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">interface&lt;/span> &lt;span class="nc">GlobalFilter&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 处理当前请求，有必要的话通过{@link GatewayFilterChain}将请求交给下一个过滤器处理
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param exchange 请求上下文，里面可以获取Request、Response等信息
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param chain 用来把请求委托给下一个过滤器
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @return {@code Mono&amp;lt;Void&amp;gt;} 返回标示当前过滤器业务结束
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Mono&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Void&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ServerWebExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GatewayFilterChain&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">chain&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在filter中编写自定义逻辑，可以实现下列功能：&lt;/p>
&lt;ul>
&lt;li>登录状态判断&lt;/li>
&lt;li>权限校验&lt;/li>
&lt;li>请求限流等&lt;/li>
&lt;/ul>
&lt;h3 id="352自定义全局过滤器">
&lt;a href="#352%e8%87%aa%e5%ae%9a%e4%b9%89%e5%85%a8%e5%b1%80%e8%bf%87%e6%bb%a4%e5%99%a8" class="header-anchor">#&lt;/a>
3.5.2.自定义全局过滤器
&lt;/h3>&lt;p>需求：定义全局过滤器，拦截请求，判断请求的参数是否满足下面条件：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>参数中是否有authorization，&lt;/p>
&lt;/li>
&lt;li>
&lt;p>authorization参数值是否为admin&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>如果同时满足则放行，否则拦截&lt;/p>
&lt;p>实现：&lt;/p>
&lt;p>在gateway中定义一个过滤器：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-24-1">&lt;a class="lnlinks" href="#hl-24-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-2">&lt;a class="lnlinks" href="#hl-24-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-3">&lt;a class="lnlinks" href="#hl-24-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-4">&lt;a class="lnlinks" href="#hl-24-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-5">&lt;a class="lnlinks" href="#hl-24-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-6">&lt;a class="lnlinks" href="#hl-24-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-7">&lt;a class="lnlinks" href="#hl-24-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-8">&lt;a class="lnlinks" href="#hl-24-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-9">&lt;a class="lnlinks" href="#hl-24-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-10">&lt;a class="lnlinks" href="#hl-24-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-11">&lt;a class="lnlinks" href="#hl-24-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-12">&lt;a class="lnlinks" href="#hl-24-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-13">&lt;a class="lnlinks" href="#hl-24-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-14">&lt;a class="lnlinks" href="#hl-24-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-15">&lt;a class="lnlinks" href="#hl-24-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-16">&lt;a class="lnlinks" href="#hl-24-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-17">&lt;a class="lnlinks" href="#hl-24-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-18">&lt;a class="lnlinks" href="#hl-24-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-19">&lt;a class="lnlinks" href="#hl-24-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-20">&lt;a class="lnlinks" href="#hl-24-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-21">&lt;a class="lnlinks" href="#hl-24-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-22">&lt;a class="lnlinks" href="#hl-24-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-23">&lt;a class="lnlinks" href="#hl-24-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-24">&lt;a class="lnlinks" href="#hl-24-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-25">&lt;a class="lnlinks" href="#hl-24-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-26">&lt;a class="lnlinks" href="#hl-24-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-27">&lt;a class="lnlinks" href="#hl-24-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-28">&lt;a class="lnlinks" href="#hl-24-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-29">&lt;a class="lnlinks" href="#hl-24-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-30">&lt;a class="lnlinks" href="#hl-24-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-31">&lt;a class="lnlinks" href="#hl-24-31">31&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.gateway.filters&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.cloud.gateway.filter.GatewayFilterChain&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.cloud.gateway.filter.GlobalFilter&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.core.annotation.Order&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.http.HttpStatus&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.stereotype.Component&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.web.server.ServerWebExchange&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">reactor.core.publisher.Mono&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Order&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Component&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">AuthorizeFilter&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">implements&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GlobalFilter&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Mono&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Void&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ServerWebExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GatewayFilterChain&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">chain&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.获取请求参数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">MultiValueMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getRequest&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">getQueryParams&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.获取authorization参数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">auth&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getFirst&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;authorization&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.校验&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;admin&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">auth&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放行&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">chain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.拦截&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.1.禁止访问，设置状态码&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getResponse&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">setStatusCode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HttpStatus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">FORBIDDEN&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.2.结束处理&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getResponse&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">setComplete&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="353过滤器执行顺序">
&lt;a href="#353%e8%bf%87%e6%bb%a4%e5%99%a8%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f" class="header-anchor">#&lt;/a>
3.5.3.过滤器执行顺序
&lt;/h3>&lt;p>请求进入网关会碰到三类过滤器：当前路由的过滤器、DefaultFilter、GlobalFilter&lt;/p>
&lt;p>请求路由后，会将当前路由过滤器和DefaultFilter、GlobalFilter，合并到一个过滤器链（集合）中，排序后依次执行每个过滤器：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-66e13fae7851c0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714214228409"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>排序的规则是什么呢？&lt;/p>
&lt;ul>
&lt;li>每一个过滤器都必须指定一个int类型的order值，&lt;strong>order值越小，优先级越高，执行顺序越靠前&lt;/strong>。&lt;/li>
&lt;li>GlobalFilter通过实现Ordered接口，或者添加@Order注解来指定order值，由我们自己指定&lt;/li>
&lt;li>路由过滤器和defaultFilter的order由Spring指定，默认是按照声明顺序从1递增。&lt;/li>
&lt;li>当过滤器的order值一样时，会按照 defaultFilter &amp;gt; 路由过滤器 &amp;gt; GlobalFilter的顺序执行。&lt;/li>
&lt;/ul>
&lt;p>详细内容，可以查看源码：&lt;/p>
&lt;p>&lt;code>org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator#getFilters()&lt;/code>方法是先加载defaultFilters，然后再加载某个route的filters，然后合并。&lt;/p>
&lt;p>&lt;code>org.springframework.cloud.gateway.handler.FilteringWebHandler#handle()&lt;/code>方法会加载全局过滤器，与前面的过滤器合并后根据order排序，组织过滤器链&lt;/p>
&lt;h2 id="36跨域问题">
&lt;a href="#36%e8%b7%a8%e5%9f%9f%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
3.6.跨域问题
&lt;/h2>&lt;h3 id="361什么是跨域问题">
&lt;a href="#361%e4%bb%80%e4%b9%88%e6%98%af%e8%b7%a8%e5%9f%9f%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
3.6.1.什么是跨域问题
&lt;/h3>&lt;p>跨域：域名不一致就是跨域，主要包括：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>域名不同： &lt;a class="link" href="https://www.taobao.com" target="_blank" rel="noopener"
>www.taobao.com
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a> 和 &lt;a class="link" href="https://www.taobao.org" target="_blank" rel="noopener"
>www.taobao.org
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a> 和 &lt;a class="link" href="https://www.jd.com" target="_blank" rel="noopener"
>www.jd.com
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a> 和 miaosha.jd.com&lt;/p>
&lt;/li>
&lt;li>
&lt;p>域名相同，端口不同：localhost:8080和localhost8081&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>跨域问题：浏览器禁止请求的发起者与服务端发生跨域ajax请求，请求被浏览器拦截的问题&lt;/p>
&lt;p>解决方案：CORS，这个以前应该学习过，这里不再赘述了。不知道的小伙伴可以查看https://www.ruanyifeng.com/blog/2016/04/cors.html&lt;/p>
&lt;h3 id="362模拟跨域问题">
&lt;a href="#362%e6%a8%a1%e6%8b%9f%e8%b7%a8%e5%9f%9f%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
3.6.2.模拟跨域问题
&lt;/h3>&lt;p>找到课前资料的页面文件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-f6037ad9b50624.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714215713563"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>放入tomcat或者nginx这样的web服务器中，启动并访问。&lt;/p>
&lt;p>可以在浏览器控制台看到下面的错误：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737968-65a5bff30f42c3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210714215832675"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>从localhost:8090访问localhost:10010，端口不同，显然是跨域的请求。&lt;/p>
&lt;h3 id="363解决跨域问题">
&lt;a href="#363%e8%a7%a3%e5%86%b3%e8%b7%a8%e5%9f%9f%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
3.6.3.解决跨域问题
&lt;/h3>&lt;p>在gateway服务的application.yml文件中，添加下面的配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-25-1">&lt;a class="lnlinks" href="#hl-25-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-2">&lt;a class="lnlinks" href="#hl-25-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-3">&lt;a class="lnlinks" href="#hl-25-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-4">&lt;a class="lnlinks" href="#hl-25-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-5">&lt;a class="lnlinks" href="#hl-25-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-6">&lt;a class="lnlinks" href="#hl-25-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-7">&lt;a class="lnlinks" href="#hl-25-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-8">&lt;a class="lnlinks" href="#hl-25-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-9">&lt;a class="lnlinks" href="#hl-25-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-10">&lt;a class="lnlinks" href="#hl-25-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-11">&lt;a class="lnlinks" href="#hl-25-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-12">&lt;a class="lnlinks" href="#hl-25-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-13">&lt;a class="lnlinks" href="#hl-25-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-14">&lt;a class="lnlinks" href="#hl-25-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-15">&lt;a class="lnlinks" href="#hl-25-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-16">&lt;a class="lnlinks" href="#hl-25-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-17">&lt;a class="lnlinks" href="#hl-25-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-18">&lt;a class="lnlinks" href="#hl-25-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-19">&lt;a class="lnlinks" href="#hl-25-19">19&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gateway&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 。。。&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">globalcors&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 全局的跨域处理&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">add-to-simple-url-handler-mapping&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 解决options请求被拦截问题&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">corsConfigurations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">&amp;#39;[/**]&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">allowedOrigins&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 允许哪些网站的跨域请求 &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;http://localhost:8090&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">allowedMethods&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 允许的跨域ajax的请求方式&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;GET&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;POST&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;DELETE&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;PUT&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;OPTIONS&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">allowedHeaders&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 允许在请求中携带的头信息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">allowCredentials&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 是否允许携带cookie&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">maxAge&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">360000&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 这次跨域检测的有效期&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>3.Docker实用篇</title><link>https://logan.wssw.fun/p/2023/01/83491673/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/83491673/</guid><description>&lt;h1 id="docker实用篇">
&lt;a href="#docker%e5%ae%9e%e7%94%a8%e7%af%87" class="header-anchor">#&lt;/a>
Docker实用篇
&lt;/h1>&lt;h1 id="0学习目标">
&lt;a href="#0%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87" class="header-anchor">#&lt;/a>
0.学习目标
&lt;/h1>&lt;h1 id="1初识docker">
&lt;a href="#1%e5%88%9d%e8%af%86docker" class="header-anchor">#&lt;/a>
1.初识Docker
&lt;/h1>&lt;h2 id="11什么是docker">
&lt;a href="#11%e4%bb%80%e4%b9%88%e6%98%afdocker" class="header-anchor">#&lt;/a>
1.1.什么是Docker
&lt;/h2>&lt;p>微服务虽然具备各种各样的优势，但服务的拆分通用给部署带来了很大的麻烦。&lt;/p>
&lt;ul>
&lt;li>分布式系统中，依赖的组件非常多，不同组件之间部署时往往会产生一些冲突。&lt;/li>
&lt;li>在数百上千台服务中重复部署，环境不一定一致，会遇到各种问题&lt;/li>
&lt;/ul>
&lt;h3 id="111应用部署的环境问题">
&lt;a href="#111%e5%ba%94%e7%94%a8%e9%83%a8%e7%bd%b2%e7%9a%84%e7%8e%af%e5%a2%83%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
1.1.1.应用部署的环境问题
&lt;/h3>&lt;p>大型项目组件较多，运行环境也较为复杂，部署时会碰到一些问题：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>依赖关系复杂，容易出现兼容性问题&lt;/p>
&lt;/li>
&lt;li>
&lt;p>开发、测试、生产环境有差异&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-e20785a61f44b3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731141907366"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>例如一个项目中，部署时需要依赖于node.js、Redis、RabbitMQ、MySQL等，这些服务部署时所需要的函数库、依赖项各不相同，甚至会有冲突。给部署带来了极大的困难。&lt;/p>
&lt;h3 id="112docker解决依赖兼容问题">
&lt;a href="#112docker%e8%a7%a3%e5%86%b3%e4%be%9d%e8%b5%96%e5%85%bc%e5%ae%b9%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
1.1.2.Docker解决依赖兼容问题
&lt;/h3>&lt;p>而Docker确巧妙的解决了这些问题，Docker是如何实现的呢？&lt;/p>
&lt;p>Docker为了解决依赖的兼容问题的，采用了两个手段：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>将应用的Libs（函数库）、Deps（依赖）、配置与应用一起打包&lt;/p>
&lt;/li>
&lt;li>
&lt;p>将每个应用放到一个隔离&lt;strong>容器&lt;/strong>去运行，避免互相干扰&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-c4e93b8b05fb8a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731142219735"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这样打包好的应用包中，既包含应用本身，也保护应用所需要的Libs、Deps，无需再操作系统上安装这些，自然就不存在不同应用之间的兼容问题了。&lt;/p>
&lt;p>虽然解决了不同应用的兼容问题，但是开发、测试等环境会存在差异，操作系统版本也会有差异，怎么解决这些问题呢？&lt;/p>
&lt;h3 id="113docker解决操作系统环境差异">
&lt;a href="#113docker%e8%a7%a3%e5%86%b3%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e7%8e%af%e5%a2%83%e5%b7%ae%e5%bc%82" class="header-anchor">#&lt;/a>
1.1.3.Docker解决操作系统环境差异
&lt;/h3>&lt;p>要解决不同操作系统环境差异问题，必须先了解操作系统结构。以一个Ubuntu操作系统为例，结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-2d75dbf7c9a90d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731143401460"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>结构包括：&lt;/p>
&lt;ul>
&lt;li>计算机硬件：例如CPU、内存、磁盘等&lt;/li>
&lt;li>系统内核：所有Linux发行版的内核都是Linux，例如CentOS、Ubuntu、Fedora等。内核可以与计算机硬件交互，对外提供&lt;strong>内核指令&lt;/strong>，用于操作计算机硬件。&lt;/li>
&lt;li>系统应用：操作系统本身提供的应用、函数库。这些函数库是对内核指令的封装，使用更加方便。&lt;/li>
&lt;/ul>
&lt;p>应用于计算机交互的流程如下：&lt;/p>
&lt;p>1）应用调用操作系统应用（函数库），实现各种功能&lt;/p>
&lt;p>2）系统函数库是对内核指令集的封装，会调用内核指令&lt;/p>
&lt;p>3）内核指令操作计算机硬件&lt;/p>
&lt;p>Ubuntu和CentOSpringBoot都是基于Linux内核，无非是系统应用不同，提供的函数库有差异：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-e6948a7d57e354.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731144304990"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>此时，如果将一个Ubuntu版本的MySQL应用安装到CentOS系统，MySQL在调用Ubuntu函数库时，会发现找不到或者不匹配，就会报错了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-36b78e49fadcc8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731144458680"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>Docker如何解决不同系统环境的问题？&lt;/p>
&lt;ul>
&lt;li>Docker将用户程序与所需要调用的系统(比如Ubuntu)函数库一起打包&lt;/li>
&lt;li>Docker运行到不同操作系统时，直接基于打包的函数库，借助于操作系统的Linux内核来运行&lt;/li>
&lt;/ul>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-d6992d4c046897.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731144820638"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="114小结">
&lt;a href="#114%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
1.1.4.小结
&lt;/h3>&lt;p>Docker如何解决大型项目依赖关系复杂，不同组件依赖的兼容性问题？&lt;/p>
&lt;ul>
&lt;li>Docker允许开发中将应用、依赖、函数库、配置一起&lt;strong>打包&lt;/strong>，形成可移植镜像&lt;/li>
&lt;li>Docker应用运行在容器中，使用沙箱机制，相互&lt;strong>隔离&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>Docker如何解决开发、测试、生产环境有差异的问题？&lt;/p>
&lt;ul>
&lt;li>Docker镜像中包含完整运行环境，包括系统函数库，仅依赖系统的Linux内核，因此可以在任意Linux操作系统上运行&lt;/li>
&lt;/ul>
&lt;p>Docker是一个快速交付应用、运行应用的技术，具备下列优势：&lt;/p>
&lt;ul>
&lt;li>可以将程序及其依赖、运行环境一起打包为一个镜像，可以迁移到任意Linux操作系统&lt;/li>
&lt;li>运行时利用沙箱机制形成隔离容器，各个应用互不干扰&lt;/li>
&lt;li>启动、移除都可以通过一行命令完成，方便快捷&lt;/li>
&lt;/ul>
&lt;h2 id="12docker和虚拟机的区别">
&lt;a href="#12docker%e5%92%8c%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%9a%84%e5%8c%ba%e5%88%ab" class="header-anchor">#&lt;/a>
1.2.Docker和虚拟机的区别
&lt;/h2>&lt;p>Docker可以让一个应用在任何操作系统中非常方便的运行。而以前我们接触的虚拟机，也能在一个操作系统中，运行另外一个操作系统，保护系统中的任何应用。&lt;/p>
&lt;p>两者有什么差异呢？&lt;/p>
&lt;p>&lt;strong>虚拟机&lt;/strong>（virtual machine）是在操作系统中&lt;strong>模拟&lt;/strong>硬件设备，然后运行另一个操作系统，比如在 Windows 系统里面运行 Ubuntu 系统，这样就可以运行任意的Ubuntu应用了。&lt;/p>
&lt;p>&lt;strong>Docker&lt;/strong>仅仅是封装函数库，并没有模拟完整的操作系统，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-55f0574e383874.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731145914960"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>对比来看：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-b9c3e963b6606d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731152243765"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>小结：&lt;/p>
&lt;p>Docker和虚拟机的差异：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>docker是一个系统进程；虚拟机是在操作系统中的操作系统&lt;/p>
&lt;/li>
&lt;li>
&lt;p>docker体积小、启动速度快、性能好；虚拟机体积大、启动速度慢、性能一般&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="13docker架构">
&lt;a href="#13docker%e6%9e%b6%e6%9e%84" class="header-anchor">#&lt;/a>
1.3.Docker架构
&lt;/h2>&lt;h3 id="131镜像和容器">
&lt;a href="#131%e9%95%9c%e5%83%8f%e5%92%8c%e5%ae%b9%e5%99%a8" class="header-anchor">#&lt;/a>
1.3.1.镜像和容器
&lt;/h3>&lt;p>Docker中有几个重要的概念：&lt;/p>
&lt;p>&lt;strong>镜像（Image）&lt;/strong>：Docker将应用程序及其所需的依赖、函数库、环境、配置等文件打包在一起，称为镜像。&lt;/p>
&lt;p>&lt;strong>容器（Container）&lt;/strong>：镜像中的应用程序运行后形成的进程就是&lt;strong>容器&lt;/strong>，只是Docker会给容器进程做隔离，对外不可见。&lt;/p>
&lt;p>一切应用最终都是代码组成，都是硬盘中的一个个的字节形成的&lt;strong>文件&lt;/strong>。只有运行时，才会加载到内存，形成进程。&lt;/p>
&lt;p>而&lt;strong>镜像&lt;/strong>，就是把一个应用在硬盘上的文件、及其运行环境、部分系统函数库文件一起打包形成的文件包。这个文件包是只读的。&lt;/p>
&lt;p>&lt;strong>容器&lt;/strong>呢，就是将这些文件中编写的程序、函数加载到内存中允许，形成进程，只不过要隔离起来。因此一个镜像可以启动多次，形成多个容器进程。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-aa8d6736caa1b0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731153059464"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>例如你下载了一个QQ，如果我们将QQ在磁盘上的运行&lt;strong>文件&lt;/strong>及其运行的操作系统依赖打包，形成QQ镜像。然后你可以启动多次，双开、甚至三开QQ，跟多个妹子聊天。&lt;/p>
&lt;h3 id="132dockerhub">
&lt;a href="#132dockerhub" class="header-anchor">#&lt;/a>
1.3.2.DockerHub
&lt;/h3>&lt;p>开源应用程序非常多，打包这些应用往往是重复的劳动。为了避免这些重复劳动，人们就会将自己打包的应用镜像，例如Redis、MySQL镜像放到网络上，共享使用，就像GitHub的代码共享一样。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>DockerHub：DockerHub是一个官方的Docker镜像的托管平台。这样的平台称为Docker Registry。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>国内也有类似于DockerHub 的公开服务，比如 &lt;a class="link" href="https://c.163yun.com/hub" target="_blank" rel="noopener"
>网易云镜像服务
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>、&lt;a class="link" href="https://cr.console.aliyun.com/" target="_blank" rel="noopener"
>阿里云镜像库
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>等。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>我们一方面可以将自己的镜像共享到DockerHub，另一方面也可以从DockerHub拉取镜像：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-fbdcac90ae17a5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731153743354"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="133docker架构">
&lt;a href="#133docker%e6%9e%b6%e6%9e%84" class="header-anchor">#&lt;/a>
1.3.3.Docker架构
&lt;/h3>&lt;p>我们要使用Docker来操作镜像、容器，就必须要安装Docker。&lt;/p>
&lt;p>Docker是一个CS架构的程序，由两部分组成：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>服务端(server)：Docker守护进程，负责处理Docker指令，管理镜像、容器等&lt;/p>
&lt;/li>
&lt;li>
&lt;p>客户端(client)：通过命令或RestAPI向Docker服务端发送指令。可以在本地或远程向服务端发送指令。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-8af42f30297383.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731154257653"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="134小结">
&lt;a href="#134%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
1.3.4.小结
&lt;/h3>&lt;p>镜像：&lt;/p>
&lt;ul>
&lt;li>将应用程序及其依赖、环境、配置打包在一起&lt;/li>
&lt;/ul>
&lt;p>容器：&lt;/p>
&lt;ul>
&lt;li>镜像运行起来就是容器，一个镜像可以运行多个容器&lt;/li>
&lt;/ul>
&lt;p>Docker结构：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>服务端：接收命令或远程请求，操作镜像或容器&lt;/p>
&lt;/li>
&lt;li>
&lt;p>客户端：发送命令或者请求到Docker服务端&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>DockerHub：&lt;/p>
&lt;ul>
&lt;li>一个镜像托管的服务器，类似的还有阿里云镜像服务，统称为DockerRegistry&lt;/li>
&lt;/ul>
&lt;h2 id="14安装docker">
&lt;a href="#14%e5%ae%89%e8%a3%85docker" class="header-anchor">#&lt;/a>
1.4.安装Docker
&lt;/h2>&lt;p>企业部署一般都是采用Linux操作系统，而其中又数CentOS发行版占比最多，因此我们在CentOS下安装Docker。参考课前资料中的文档：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-aef5dcc97195c7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731155002425"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="2docker的基本操作">
&lt;a href="#2docker%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%93%8d%e4%bd%9c" class="header-anchor">#&lt;/a>
2.Docker的基本操作
&lt;/h1>&lt;h2 id="21镜像操作">
&lt;a href="#21%e9%95%9c%e5%83%8f%e6%93%8d%e4%bd%9c" class="header-anchor">#&lt;/a>
2.1.镜像操作
&lt;/h2>&lt;h3 id="211镜像名称">
&lt;a href="#211%e9%95%9c%e5%83%8f%e5%90%8d%e7%a7%b0" class="header-anchor">#&lt;/a>
2.1.1.镜像名称
&lt;/h3>&lt;p>首先来看下镜像的名称组成：&lt;/p>
&lt;ul>
&lt;li>镜名称一般分两部分组成：[repository]:[tag]。&lt;/li>
&lt;li>在没有指定tag时，默认是latest，代表最新版本的镜像&lt;/li>
&lt;/ul>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-11c34be367cda1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731155141362"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这里的mysql就是repository，5.7就是tag，合一起就是镜像名称，代表5.7版本的MySQL镜像。&lt;/p>
&lt;h3 id="212镜像命令">
&lt;a href="#212%e9%95%9c%e5%83%8f%e5%91%bd%e4%bb%a4" class="header-anchor">#&lt;/a>
2.1.2.镜像命令
&lt;/h3>&lt;p>常见的镜像操作命令如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-4f1907e397c51a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731155649535"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="213案例1-拉取查看镜像">
&lt;a href="#213%e6%a1%88%e4%be%8b1-%e6%8b%89%e5%8f%96%e6%9f%a5%e7%9c%8b%e9%95%9c%e5%83%8f" class="header-anchor">#&lt;/a>
2.1.3.案例1-拉取、查看镜像
&lt;/h3>&lt;p>需求：从DockerHub中拉取一个nginx镜像并查看&lt;/p>
&lt;p>1）首先去镜像仓库搜索nginx镜像，比如&lt;a class="link" href="https://hub.docker.com/" target="_blank" rel="noopener"
>DockerHub
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>:&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-4b3a495060c144.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731155844368"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>2）根据查看到的镜像名称，拉取自己需要的镜像，通过命令：docker pull nginx&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-f0584fdf4adf36.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731155856199"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>3）通过命令：docker images 查看拉取到的镜像&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-6776762f4dcaca.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731155903037"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="214案例2-保存导入镜像">
&lt;a href="#214%e6%a1%88%e4%be%8b2-%e4%bf%9d%e5%ad%98%e5%af%bc%e5%85%a5%e9%95%9c%e5%83%8f" class="header-anchor">#&lt;/a>
2.1.4.案例2-保存、导入镜像
&lt;/h3>&lt;p>需求：利用docker save将nginx镜像导出磁盘，然后再通过load加载回来&lt;/p>
&lt;p>1）利用docker xx &amp;ndash;help命令查看docker save和docker load的语法&lt;/p>
&lt;p>例如，查看save命令用法，可以输入命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker save --help
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-3081ac35882d81.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731161104732"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>命令格式：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">docker save -o &lt;span class="o">[&lt;/span>保存的目标文件名称&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>镜像名称&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）使用docker save导出镜像到磁盘&lt;/p>
&lt;p>运行命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker save -o nginx.tar nginx:latest
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-90cb6895c44993.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731161354344"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>3）使用docker load加载镜像&lt;/p>
&lt;p>先删除本地的nginx镜像：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker rmi nginx:latest
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后运行命令，加载本地文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker load -i nginx.tar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-1de14ef8fada1e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731161746245"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="215练习">
&lt;a href="#215%e7%bb%83%e4%b9%a0" class="header-anchor">#&lt;/a>
2.1.5.练习
&lt;/h3>&lt;p>需求：去DockerHub搜索并拉取一个Redis镜像&lt;/p>
&lt;p>目标：&lt;/p>
&lt;p>1）去DockerHub搜索Redis镜像&lt;/p>
&lt;p>2）查看Redis镜像的名称和版本&lt;/p>
&lt;p>3）利用docker pull命令拉取镜像&lt;/p>
&lt;p>4）利用docker save命令将 redis:latest打包为一个redis.tar包&lt;/p>
&lt;p>5）利用docker rmi 删除本地的redis:latest&lt;/p>
&lt;p>6）利用docker load 重新加载 redis.tar文件&lt;/p>
&lt;h2 id="22容器操作">
&lt;a href="#22%e5%ae%b9%e5%99%a8%e6%93%8d%e4%bd%9c" class="header-anchor">#&lt;/a>
2.2.容器操作
&lt;/h2>&lt;h3 id="221容器相关命令">
&lt;a href="#221%e5%ae%b9%e5%99%a8%e7%9b%b8%e5%85%b3%e5%91%bd%e4%bb%a4" class="header-anchor">#&lt;/a>
2.2.1.容器相关命令
&lt;/h3>&lt;p>容器操作的命令如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-17a21f86a37966.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731161950495"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>容器保护三个状态：&lt;/p>
&lt;ul>
&lt;li>运行：进程正常运行&lt;/li>
&lt;li>暂停：进程暂停，CPU不再运行，并不释放内存&lt;/li>
&lt;li>停止：进程终止，回收进程占用的内存、CPU等资源&lt;/li>
&lt;/ul>
&lt;p>其中：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>docker run：创建并运行一个容器，处于运行状态&lt;/p>
&lt;/li>
&lt;li>
&lt;p>docker pause：让一个运行的容器暂停&lt;/p>
&lt;/li>
&lt;li>
&lt;p>docker unpause：让一个容器从暂停状态恢复运行&lt;/p>
&lt;/li>
&lt;li>
&lt;p>docker stop：停止一个运行的容器&lt;/p>
&lt;/li>
&lt;li>
&lt;p>docker start：让一个停止的容器再次运行&lt;/p>
&lt;/li>
&lt;li>
&lt;p>docker rm：删除一个容器&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="222案例-创建并运行一个容器">
&lt;a href="#222%e6%a1%88%e4%be%8b-%e5%88%9b%e5%bb%ba%e5%b9%b6%e8%bf%90%e8%a1%8c%e4%b8%80%e4%b8%aa%e5%ae%b9%e5%99%a8" class="header-anchor">#&lt;/a>
2.2.2.案例-创建并运行一个容器
&lt;/h3>&lt;p>创建并运行nginx容器的命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run --name containerName -p 80:80 -d nginx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>命令解读：&lt;/p>
&lt;ul>
&lt;li>docker run ：创建并运行一个容器&lt;/li>
&lt;li>&amp;ndash;name : 给容器起一个名字，比如叫做mn&lt;/li>
&lt;li>-p ：将宿主机端口与容器端口映射，冒号左侧是宿主机端口，右侧是容器端口&lt;/li>
&lt;li>-d：后台运行容器&lt;/li>
&lt;li>nginx：镜像名称，例如nginx&lt;/li>
&lt;/ul>
&lt;p>这里的&lt;code>-p&lt;/code>参数，是将容器端口映射到宿主机端口。&lt;/p>
&lt;p>默认情况下，容器是隔离环境，我们直接访问宿主机的80端口，肯定访问不到容器中的nginx。&lt;/p>
&lt;p>现在，将容器的80与宿主机的80关联起来，当我们访问宿主机的80端口时，就会被映射到容器的80，这样就能访问到nginx了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-12b872288bc006.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731163255863"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="223案例-进入容器修改文件">
&lt;a href="#223%e6%a1%88%e4%be%8b-%e8%bf%9b%e5%85%a5%e5%ae%b9%e5%99%a8%e4%bf%ae%e6%94%b9%e6%96%87%e4%bb%b6" class="header-anchor">#&lt;/a>
2.2.3.案例-进入容器，修改文件
&lt;/h3>&lt;p>&lt;strong>需求&lt;/strong>：进入Nginx容器，修改HTML文件内容，添加“传智教育欢迎您”&lt;/p>
&lt;p>&lt;strong>提示&lt;/strong>：进入容器要用到docker exec命令。&lt;/p>
&lt;p>&lt;strong>步骤&lt;/strong>：&lt;/p>
&lt;p>1）进入容器。进入我们刚刚创建的nginx容器的命令为：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker &lt;span class="nb">exec&lt;/span> -it mn bash
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>命令解读：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>docker exec ：进入容器内部，执行一个命令&lt;/p>
&lt;/li>
&lt;li>
&lt;p>-it : 给当前进入的容器创建一个标准输入、输出终端，允许我们与容器交互&lt;/p>
&lt;/li>
&lt;li>
&lt;p>mn ：要进入的容器的名称&lt;/p>
&lt;/li>
&lt;li>
&lt;p>bash：进入容器后执行的命令，bash是一个linux终端交互命令&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>2）进入nginx的HTML所在目录 /usr/share/nginx/html&lt;/p>
&lt;p>容器内部会模拟一个独立的Linux文件系统，看起来如同一个linux服务器一样：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-84062f7b6830d7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731164159811"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>nginx的环境、配置、运行文件全部都在这个文件系统中，包括我们要修改的html文件。&lt;/p>
&lt;p>查看DockerHub网站中的nginx页面，可以知道nginx的html目录位置在&lt;code>/usr/share/nginx/html&lt;/code>&lt;/p>
&lt;p>我们执行命令，进入该目录：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /usr/share/nginx/html
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查看目录下文件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-c6acdc8092ebcb.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731164455818"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>3）修改index.html的内容&lt;/p>
&lt;p>容器内没有vi命令，无法直接修改，我们用下面的命令来修改：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">sed -i -e &lt;span class="s1">&amp;#39;s#Welcome to nginx#传智教育欢迎您#g&amp;#39;&lt;/span> -e &lt;span class="s1">&amp;#39;s#&amp;lt;head&amp;gt;#&amp;lt;head&amp;gt;&amp;lt;meta charset=&amp;#34;utf-8&amp;#34;&amp;gt;#g&amp;#39;&lt;/span> index.html
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在浏览器访问自己的虚拟机地址，例如我的是：http://192.168.150.101，即可看到结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-12cb16ee85c2b4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731164717604"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="224小结">
&lt;a href="#224%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
2.2.4.小结
&lt;/h3>&lt;p>docker run命令的常见参数有哪些？&lt;/p>
&lt;ul>
&lt;li>&amp;ndash;name：指定容器名称&lt;/li>
&lt;li>-p：指定端口映射&lt;/li>
&lt;li>-d：让容器后台运行&lt;/li>
&lt;/ul>
&lt;p>查看容器日志的命令：&lt;/p>
&lt;ul>
&lt;li>docker logs&lt;/li>
&lt;li>添加 -f 参数可以持续查看日志&lt;/li>
&lt;/ul>
&lt;p>查看容器状态：&lt;/p>
&lt;ul>
&lt;li>docker ps&lt;/li>
&lt;li>docker ps -a 查看所有容器，包括已经停止的&lt;/li>
&lt;/ul>
&lt;h2 id="23数据卷容器数据管理">
&lt;a href="#23%e6%95%b0%e6%8d%ae%e5%8d%b7%e5%ae%b9%e5%99%a8%e6%95%b0%e6%8d%ae%e7%ae%a1%e7%90%86" class="header-anchor">#&lt;/a>
2.3.数据卷（容器数据管理）
&lt;/h2>&lt;p>在之前的nginx案例中，修改nginx的html页面时，需要进入nginx内部。并且因为没有编辑器，修改文件也很麻烦。&lt;/p>
&lt;p>这就是因为容器与数据（容器内文件）耦合带来的后果。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-ace121e9ed586b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731172440275"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>要解决这个问题，必须将数据与容器解耦，这就要用到数据卷了。&lt;/p>
&lt;h3 id="231什么是数据卷">
&lt;a href="#231%e4%bb%80%e4%b9%88%e6%98%af%e6%95%b0%e6%8d%ae%e5%8d%b7" class="header-anchor">#&lt;/a>
2.3.1.什么是数据卷
&lt;/h3>&lt;p>**数据卷（volume）**是一个虚拟目录，指向宿主机文件系统中的某个目录。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-c6553d2e464a86.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731173541846"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>一旦完成数据卷挂载，对容器的一切操作都会作用在数据卷对应的宿主机目录了。&lt;/p>
&lt;p>这样，我们操作宿主机的/var/lib/docker/volumes/html目录，就等于操作容器内的/usr/share/nginx/html目录了&lt;/p>
&lt;h3 id="232数据集操作命令">
&lt;a href="#232%e6%95%b0%e6%8d%ae%e9%9b%86%e6%93%8d%e4%bd%9c%e5%91%bd%e4%bb%a4" class="header-anchor">#&lt;/a>
2.3.2.数据集操作命令
&lt;/h3>&lt;p>数据卷操作的基本语法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker volume &lt;span class="o">[&lt;/span>COMMAND&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>docker volume命令是数据卷操作，根据命令后跟随的command来确定下一步的操作：&lt;/p>
&lt;ul>
&lt;li>create 创建一个volume&lt;/li>
&lt;li>inspect 显示一个或多个volume的信息&lt;/li>
&lt;li>ls 列出所有的volume&lt;/li>
&lt;li>prune 删除未使用的volume&lt;/li>
&lt;li>rm 删除一个或多个指定的volume&lt;/li>
&lt;/ul>
&lt;h3 id="233创建和查看数据卷">
&lt;a href="#233%e5%88%9b%e5%bb%ba%e5%92%8c%e6%9f%a5%e7%9c%8b%e6%95%b0%e6%8d%ae%e5%8d%b7" class="header-anchor">#&lt;/a>
2.3.3.创建和查看数据卷
&lt;/h3>&lt;p>&lt;strong>需求&lt;/strong>：创建一个数据卷，并查看数据卷在宿主机的目录位置&lt;/p>
&lt;p>① 创建数据卷&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker volume create html
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>② 查看所有数据&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker volume ls
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-b7d923cefdc259.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731173746910"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>③ 查看数据卷详细信息卷&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker volume inspect html
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-253da9afbe2084.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731173809877"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，我们创建的html这个数据卷关联的宿主机目录为&lt;code>/var/lib/docker/volumes/html/_data&lt;/code>目录。&lt;/p>
&lt;p>&lt;strong>小结&lt;/strong>：&lt;/p>
&lt;p>数据卷的作用：&lt;/p>
&lt;ul>
&lt;li>将容器与数据分离，解耦合，方便操作容器内数据，保证数据安全&lt;/li>
&lt;/ul>
&lt;p>数据卷操作：&lt;/p>
&lt;ul>
&lt;li>docker volume create：创建数据卷&lt;/li>
&lt;li>docker volume ls：查看所有数据卷&lt;/li>
&lt;li>docker volume inspect：查看数据卷详细信息，包括关联的宿主机目录位置&lt;/li>
&lt;li>docker volume rm：删除指定数据卷&lt;/li>
&lt;li>docker volume prune：删除所有未使用的数据卷&lt;/li>
&lt;/ul>
&lt;h3 id="234挂载数据卷">
&lt;a href="#234%e6%8c%82%e8%bd%bd%e6%95%b0%e6%8d%ae%e5%8d%b7" class="header-anchor">#&lt;/a>
2.3.4.挂载数据卷
&lt;/h3>&lt;p>我们在创建容器时，可以通过 -v 参数来挂载一个数据卷到某个容器内目录，命令格式如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --name mn &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v html:/root/html &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -p 8080:80
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nginx &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里的-v就是挂载数据卷的命令：&lt;/p>
&lt;ul>
&lt;li>&lt;code>-v html:/root/htm&lt;/code> ：把html数据卷挂载到容器内的/root/html这个目录中&lt;/li>
&lt;/ul>
&lt;h3 id="235案例-给nginx挂载数据卷">
&lt;a href="#235%e6%a1%88%e4%be%8b-%e7%bb%99nginx%e6%8c%82%e8%bd%bd%e6%95%b0%e6%8d%ae%e5%8d%b7" class="header-anchor">#&lt;/a>
2.3.5.案例-给nginx挂载数据卷
&lt;/h3>&lt;p>&lt;strong>需求&lt;/strong>：创建一个nginx容器，修改容器内的html目录内的index.html内容&lt;/p>
&lt;p>&lt;strong>分析&lt;/strong>：上个案例中，我们进入nginx容器内部，已经知道nginx的html目录所在位置/usr/share/nginx/html ，我们需要把这个目录挂载到html这个数据卷上，方便操作其中的内容。&lt;/p>
&lt;p>&lt;strong>提示&lt;/strong>：运行容器时使用 -v 参数挂载数据卷&lt;/p>
&lt;p>步骤：&lt;/p>
&lt;p>① 创建容器并挂载数据卷到容器内的HTML目录&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run --name mn -v html:/usr/share/nginx/html -p 80:80 -d nginx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>② 进入html数据卷所在位置，并修改HTML内容&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-6">&lt;a class="lnlinks" href="#hl-15-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看html数据卷的位置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker volume inspect html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入该目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /var/lib/docker/volumes/html/_data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 修改文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi index.html
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="236案例-给mysql挂载本地目录">
&lt;a href="#236%e6%a1%88%e4%be%8b-%e7%bb%99mysql%e6%8c%82%e8%bd%bd%e6%9c%ac%e5%9c%b0%e7%9b%ae%e5%bd%95" class="header-anchor">#&lt;/a>
2.3.6.案例-给MySQL挂载本地目录
&lt;/h3>&lt;p>容器不仅仅可以挂载数据卷，也可以直接挂载到宿主机目录上。关联关系如下：&lt;/p>
&lt;ul>
&lt;li>带数据卷模式：宿主机目录 &amp;ndash;&amp;gt; 数据卷 &amp;mdash;&amp;gt; 容器内目录&lt;/li>
&lt;li>直接挂载模式：宿主机目录 &amp;mdash;&amp;gt; 容器内目录&lt;/li>
&lt;/ul>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-07257c92b998e8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731175155453"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>&lt;strong>语法&lt;/strong>：&lt;/p>
&lt;p>目录挂载与数据卷挂载的语法是类似的：&lt;/p>
&lt;ul>
&lt;li>-v [宿主机目录]:[容器内目录]&lt;/li>
&lt;li>-v [宿主机文件]:[容器内文件]&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>需求&lt;/strong>：创建并运行一个MySQL容器，将宿主机目录直接挂载到容器&lt;/p>
&lt;p>实现思路如下：&lt;/p>
&lt;p>1）在将课前资料中的mysql.tar文件上传到虚拟机，通过load命令加载为镜像&lt;/p>
&lt;p>2）创建目录/tmp/mysql/data&lt;/p>
&lt;p>3）创建目录/tmp/mysql/conf，将课前资料提供的hmy.cnf文件上传到/tmp/mysql/conf&lt;/p>
&lt;p>4）去DockerHub查阅资料，创建并运行MySQL容器，要求：&lt;/p>
&lt;p>① 挂载/tmp/mysql/data到mysql容器内数据存储目录&lt;/p>
&lt;p>② 挂载/tmp/mysql/conf/hmy.cnf到mysql容器的配置文件&lt;/p>
&lt;p>③ 设置MySQL密码&lt;/p>
&lt;h3 id="237小结">
&lt;a href="#237%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
2.3.7.小结
&lt;/h3>&lt;p>docker run的命令中通过 -v 参数挂载文件或目录到容器中：&lt;/p>
&lt;ul>
&lt;li>-v volume名称:容器内目录&lt;/li>
&lt;li>-v 宿主机文件:容器内文&lt;/li>
&lt;li>-v 宿主机目录:容器内目录&lt;/li>
&lt;/ul>
&lt;p>数据卷挂载与目录直接挂载的&lt;/p>
&lt;ul>
&lt;li>数据卷挂载耦合度低，由docker来管理目录，但是目录较深，不好找&lt;/li>
&lt;li>目录挂载耦合度高，需要我们自己管理目录，不过目录容易寻找查看&lt;/li>
&lt;/ul>
&lt;h1 id="3dockerfile自定义镜像">
&lt;a href="#3dockerfile%e8%87%aa%e5%ae%9a%e4%b9%89%e9%95%9c%e5%83%8f" class="header-anchor">#&lt;/a>
3.Dockerfile自定义镜像
&lt;/h1>&lt;p>常见的镜像在DockerHub就能找到，但是我们自己写的项目就必须自己构建镜像了。&lt;/p>
&lt;p>而要自定义镜像，就必须先了解镜像的结构才行。&lt;/p>
&lt;h2 id="31镜像结构">
&lt;a href="#31%e9%95%9c%e5%83%8f%e7%bb%93%e6%9e%84" class="header-anchor">#&lt;/a>
3.1.镜像结构
&lt;/h2>&lt;p>镜像是将应用程序及其需要的系统函数库、环境、配置、依赖打包而成。&lt;/p>
&lt;p>我们以MySQL为例，来看看镜像的组成结构：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-74db0091e48982.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731175806273"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>简单来说，镜像就是在系统函数库、运行环境基础上，添加应用程序文件、配置文件、依赖文件等组合，然后编写好启动脚本打包在一起形成的文件。&lt;/p>
&lt;p>我们要构建镜像，其实就是实现上述打包的过程。&lt;/p>
&lt;h2 id="32dockerfile语法">
&lt;a href="#32dockerfile%e8%af%ad%e6%b3%95" class="header-anchor">#&lt;/a>
3.2.Dockerfile语法
&lt;/h2>&lt;p>构建自定义的镜像时，并不需要一个个文件去拷贝，打包。&lt;/p>
&lt;p>我们只需要告诉Docker，我们的镜像的组成，需要哪些BaseImage、需要拷贝什么文件、需要安装什么依赖、启动脚本是什么，将来Docker会帮助我们构建镜像。&lt;/p>
&lt;p>而描述上述信息的文件就是Dockerfile文件。&lt;/p>
&lt;p>&lt;strong>Dockerfile&lt;/strong>就是一个文本文件，其中包含一个个的&lt;strong>指令(Instruction)&lt;/strong>，用指令来说明要执行什么操作来构建镜像。每一个指令都会形成一层Layer。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-cf2e97cf6ca887.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731180321133"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>更新详细语法说明，请参考官网文档： &lt;a class="link" href="https://docs.docker.com/engine/reference/builder" target="_blank" rel="noopener"
>https://docs.docker.com/engine/reference/builder
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/p>
&lt;h2 id="33构建java项目">
&lt;a href="#33%e6%9e%84%e5%bb%bajava%e9%a1%b9%e7%9b%ae" class="header-anchor">#&lt;/a>
3.3.构建Java项目
&lt;/h2>&lt;h3 id="331基于ubuntu构建java项目">
&lt;a href="#331%e5%9f%ba%e4%ba%8eubuntu%e6%9e%84%e5%bb%bajava%e9%a1%b9%e7%9b%ae" class="header-anchor">#&lt;/a>
3.3.1.基于Ubuntu构建Java项目
&lt;/h3>&lt;p>需求：基于Ubuntu镜像构建一个新镜像，运行一个java项目&lt;/p>
&lt;ul>
&lt;li>
&lt;p>步骤1：新建一个空文件夹docker-demo&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-3e30979f870f73.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210801101207444"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;/li>
&lt;li>
&lt;p>步骤2：拷贝课前资料中的docker-demo.jar文件到docker-demo这个目录&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-52d139bc7db7a1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210801101314816"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;/li>
&lt;li>
&lt;p>步骤3：拷贝课前资料中的jdk8.tar.gz文件到docker-demo这个目录&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-6dea178e6495fe.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210801101410200"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;/li>
&lt;li>
&lt;p>步骤4：拷贝课前资料提供的Dockerfile到docker-demo这个目录&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-686b1a80eb97e9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210801101455590"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-7">&lt;a class="lnlinks" href="#hl-16-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-8">&lt;a class="lnlinks" href="#hl-16-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-9">&lt;a class="lnlinks" href="#hl-16-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-10">&lt;a class="lnlinks" href="#hl-16-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-11">&lt;a class="lnlinks" href="#hl-16-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-12">&lt;a class="lnlinks" href="#hl-16-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-13">&lt;a class="lnlinks" href="#hl-16-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-14">&lt;a class="lnlinks" href="#hl-16-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-15">&lt;a class="lnlinks" href="#hl-16-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-16">&lt;a class="lnlinks" href="#hl-16-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-17">&lt;a class="lnlinks" href="#hl-16-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-18">&lt;a class="lnlinks" href="#hl-16-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-19">&lt;a class="lnlinks" href="#hl-16-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-20">&lt;a class="lnlinks" href="#hl-16-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-21">&lt;a class="lnlinks" href="#hl-16-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-22">&lt;a class="lnlinks" href="#hl-16-22">22&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 指定基础镜像&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> ubuntu:16.04&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># 配置环境变量，JDK的安装目录&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">ENV&lt;/span> &lt;span class="nv">JAVA_DIR&lt;/span>&lt;span class="o">=&lt;/span>/usr/local&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># 拷贝jdk和java项目的包&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> ./jdk8.tar.gz &lt;span class="nv">$JAVA_DIR&lt;/span>/&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> ./docker-demo.jar /tmp/app.jar&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># 安装JDK&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> &lt;span class="nb">cd&lt;/span> &lt;span class="nv">$JAVA_DIR&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> tar -xf ./jdk8.tar.gz &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> mv ./jdk1.8.0_144 ./java8&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># 配置环境变量&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">ENV&lt;/span> &lt;span class="nv">JAVA_HOME&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$JAVA_DIR&lt;/span>/java8&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">ENV&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$PATH&lt;/span>:&lt;span class="nv">$JAVA_HOME&lt;/span>/bin&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># 暴露端口&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">EXPOSE&lt;/span>&lt;span class="s"> 8090&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># 入口，java项目的启动命令&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">ENTRYPOINT&lt;/span> java -jar /tmp/app.jar&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>步骤5：进入docker-demo&lt;/p>
&lt;p>将准备好的docker-demo上传到虚拟机任意目录，然后进入docker-demo目录下&lt;/p>
&lt;/li>
&lt;li>
&lt;p>步骤6：运行命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker build -t javaweb:1.0 .
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;p>最后访问 http://192.168.150.101:8090/hello/count，其中的ip改成你的虚拟机ip&lt;/p>
&lt;h3 id="332基于java8构建java项目">
&lt;a href="#332%e5%9f%ba%e4%ba%8ejava8%e6%9e%84%e5%bb%bajava%e9%a1%b9%e7%9b%ae" class="header-anchor">#&lt;/a>
3.3.2.基于java8构建Java项目
&lt;/h3>&lt;p>虽然我们可以基于Ubuntu基础镜像，添加任意自己需要的安装包，构建镜像，但是却比较麻烦。所以大多数情况下，我们都可以在一些安装了部分软件的基础镜像上做改造。&lt;/p>
&lt;p>例如，构建java项目的镜像，可以在已经准备了JDK的基础镜像基础上构建。&lt;/p>
&lt;p>需求：基于java:8-alpine镜像，将一个Java项目构建为镜像&lt;/p>
&lt;p>实现思路如下：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>① 新建一个空的目录，然后在目录中新建一个文件，命名为Dockerfile&lt;/p>
&lt;/li>
&lt;li>
&lt;p>② 拷贝课前资料提供的docker-demo.jar到这个目录中&lt;/p>
&lt;/li>
&lt;li>
&lt;p>③ 编写Dockerfile文件：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>a ）基于java:8-alpine作为基础镜像&lt;/p>
&lt;/li>
&lt;li>
&lt;p>b ）将app.jar拷贝到镜像中&lt;/p>
&lt;/li>
&lt;li>
&lt;p>c ）暴露端口&lt;/p>
&lt;/li>
&lt;li>
&lt;p>d ）编写入口ENTRYPOINT&lt;/p>
&lt;p>内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span class="line">&lt;span class="cl">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> java:8-alpine&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> ./app.jar /tmp/app.jar&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">EXPOSE&lt;/span>&lt;span class="s"> 8090&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">ENTRYPOINT&lt;/span> java -jar /tmp/app.jar&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>④ 使用docker build命令构建镜像&lt;/p>
&lt;/li>
&lt;li>
&lt;p>⑤ 使用docker run创建容器并运行&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="34小结">
&lt;a href="#34%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
3.4.小结
&lt;/h2>&lt;p>小结：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Dockerfile的本质是一个文件，通过指令描述镜像的构建过程&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Dockerfile的第一行必须是FROM，从一个基础镜像来构建&lt;/p>
&lt;/li>
&lt;li>
&lt;p>基础镜像可以是基本操作系统，如Ubuntu。也可以是其他人制作好的镜像，例如：java:8-alpine&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h1 id="4docker-compose">
&lt;a href="#4docker-compose" class="header-anchor">#&lt;/a>
4.Docker-Compose
&lt;/h1>&lt;p>Docker Compose可以基于Compose文件帮我们快速的部署分布式应用，而无需手动一个个创建和运行容器！&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-3858329b2b5274.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731180921742"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="41初识dockercompose">
&lt;a href="#41%e5%88%9d%e8%af%86dockercompose" class="header-anchor">#&lt;/a>
4.1.初识DockerCompose
&lt;/h2>&lt;p>Compose文件是一个文本文件，通过指令定义集群中的每个容器如何运行。格式如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-5">&lt;a class="lnlinks" href="#hl-19-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-6">&lt;a class="lnlinks" href="#hl-19-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-7">&lt;a class="lnlinks" href="#hl-19-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-8">&lt;a class="lnlinks" href="#hl-19-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-9">&lt;a class="lnlinks" href="#hl-19-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-10">&lt;a class="lnlinks" href="#hl-19-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-11">&lt;a class="lnlinks" href="#hl-19-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-12">&lt;a class="lnlinks" href="#hl-19-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-13">&lt;a class="lnlinks" href="#hl-19-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">version:&lt;/span> &lt;span class="s2">&amp;#34;3.8&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">services:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="err">mysql:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="err">image:&lt;/span> &lt;span class="err">mysql:&lt;/span>&lt;span class="mf">5.7&lt;/span>&lt;span class="err">.&lt;/span>&lt;span class="mi">25&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">environment:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">MYSQL_ROOT_PASSWORD:&lt;/span> &lt;span class="mi">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="err">volumes:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="err">-&lt;/span> &lt;span class="s2">&amp;#34;/tmp/mysql/data:/var/lib/mysql&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="err">-&lt;/span> &lt;span class="s2">&amp;#34;/tmp/mysql/conf/hmy.cnf:/etc/mysql/conf.d/hmy.cnf&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="err">web:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="err">build:&lt;/span> &lt;span class="err">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="err">ports:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="err">-&lt;/span> &lt;span class="s2">&amp;#34;8090:8090&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>上面的Compose文件就描述一个项目，其中包含两个容器：&lt;/p>
&lt;ul>
&lt;li>mysql：一个基于&lt;code>mysql:5.7.25&lt;/code>镜像构建的容器，并且挂载了两个目录&lt;/li>
&lt;li>web：一个基于&lt;code>docker build&lt;/code>临时构建的镜像容器，映射端口时8090&lt;/li>
&lt;/ul>
&lt;p>DockerCompose的详细语法参考官网：https://docs.docker.com/compose/compose-file/&lt;/p>
&lt;p>其实DockerCompose文件可以看做是将多个docker run命令写到一个文件，只是语法稍有差异。&lt;/p>
&lt;h2 id="42安装dockercompose">
&lt;a href="#42%e5%ae%89%e8%a3%85dockercompose" class="header-anchor">#&lt;/a>
4.2.安装DockerCompose
&lt;/h2>&lt;p>参考课前资料&lt;/p>
&lt;h2 id="43部署微服务集群">
&lt;a href="#43%e9%83%a8%e7%bd%b2%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.3.部署微服务集群
&lt;/h2>&lt;p>&lt;strong>需求&lt;/strong>：将之前学习的cloud-demo微服务集群利用DockerCompose部署&lt;/p>
&lt;p>&lt;strong>实现思路&lt;/strong>：&lt;/p>
&lt;p>① 查看课前资料提供的cloud-demo文件夹，里面已经编写好了docker-compose文件&lt;/p>
&lt;p>② 修改自己的cloud-demo项目，将数据库、nacos地址都命名为docker-compose中的服务名&lt;/p>
&lt;p>③ 使用maven打包工具，将项目中的每个微服务都打包为app.jar&lt;/p>
&lt;p>④ 将打包好的app.jar拷贝到cloud-demo中的每一个对应的子目录中&lt;/p>
&lt;p>⑤ 将cloud-demo上传至虚拟机，利用 docker-compose up -d 来部署&lt;/p>
&lt;h3 id="431compose文件">
&lt;a href="#431compose%e6%96%87%e4%bb%b6" class="header-anchor">#&lt;/a>
4.3.1.compose文件
&lt;/h3>&lt;p>查看课前资料提供的cloud-demo文件夹，里面已经编写好了docker-compose文件，而且每个微服务都准备了一个独立的目录：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-137862c47a1f74.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210731181341330"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-4">&lt;a class="lnlinks" href="#hl-20-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-5">&lt;a class="lnlinks" href="#hl-20-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-6">&lt;a class="lnlinks" href="#hl-20-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-7">&lt;a class="lnlinks" href="#hl-20-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-8">&lt;a class="lnlinks" href="#hl-20-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-9">&lt;a class="lnlinks" href="#hl-20-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-10">&lt;a class="lnlinks" href="#hl-20-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-11">&lt;a class="lnlinks" href="#hl-20-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-12">&lt;a class="lnlinks" href="#hl-20-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-13">&lt;a class="lnlinks" href="#hl-20-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-14">&lt;a class="lnlinks" href="#hl-20-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-15">&lt;a class="lnlinks" href="#hl-20-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-16">&lt;a class="lnlinks" href="#hl-20-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-17">&lt;a class="lnlinks" href="#hl-20-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-18">&lt;a class="lnlinks" href="#hl-20-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-19">&lt;a class="lnlinks" href="#hl-20-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-20">&lt;a class="lnlinks" href="#hl-20-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-21">&lt;a class="lnlinks" href="#hl-20-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-22">&lt;a class="lnlinks" href="#hl-20-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-23">&lt;a class="lnlinks" href="#hl-20-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-24">&lt;a class="lnlinks" href="#hl-20-24">24&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;3.2&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nacos/nacos-server&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">MODE&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">standalone&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;8848:8848&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mysql&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql:5.7.25&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">MYSQL_ROOT_PASSWORD&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">123&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;$PWD/mysql/data:/var/lib/mysql&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;$PWD/mysql/conf:/etc/mysql/conf.d/&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">userservice&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">./user-service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">orderservice&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">./order-service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gateway&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">./gateway&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;10010:10010&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可以看到，其中包含5个service服务：&lt;/p>
&lt;ul>
&lt;li>&lt;code>nacos&lt;/code>：作为注册中心和配置中心
&lt;ul>
&lt;li>&lt;code>image: nacos/nacos-server&lt;/code>： 基于nacos/nacos-server镜像构建&lt;/li>
&lt;li>&lt;code>environment&lt;/code>：环境变量
&lt;ul>
&lt;li>&lt;code>MODE: standalone&lt;/code>：单点模式启动&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>ports&lt;/code>：端口映射，这里暴露了8848端口&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>mysql&lt;/code>：数据库
&lt;ul>
&lt;li>&lt;code>image: mysql:5.7.25&lt;/code>：镜像版本是mysql:5.7.25&lt;/li>
&lt;li>&lt;code>environment&lt;/code>：环境变量
&lt;ul>
&lt;li>&lt;code>MYSQL_ROOT_PASSWORD: 123&lt;/code>：设置数据库root账户的密码为123&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>volumes&lt;/code>：数据卷挂载，这里挂载了mysql的data、conf目录，其中有我提前准备好的数据&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>userservice&lt;/code>、&lt;code>orderservice&lt;/code>、&lt;code>gateway&lt;/code>：都是基于Dockerfile临时构建的&lt;/li>
&lt;/ul>
&lt;p>查看mysql目录，可以看到其中已经准备好了cloud_order、cloud_user表：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-9dca847f167238.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210801095205034"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>查看微服务目录，可以看到都包含Dockerfile文件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-d8807a02cadee0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210801095320586"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-21-1">&lt;a class="lnlinks" href="#hl-21-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-2">&lt;a class="lnlinks" href="#hl-21-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-3">&lt;a class="lnlinks" href="#hl-21-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span class="line">&lt;span class="cl">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> java:8-alpine&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> ./app.jar /tmp/app.jar&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">ENTRYPOINT&lt;/span> java -jar /tmp/app.jar&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="432修改微服务配置">
&lt;a href="#432%e4%bf%ae%e6%94%b9%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
4.3.2.修改微服务配置
&lt;/h3>&lt;p>因为微服务将来要部署为docker容器，而容器之间互联不是通过IP地址，而是通过容器名。这里我们将order-service、user-service、gateway服务的mysql、nacos地址都修改为基于容器名的访问。&lt;/p>
&lt;p>如下所示：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-22-1">&lt;a class="lnlinks" href="#hl-22-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-2">&lt;a class="lnlinks" href="#hl-22-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-3">&lt;a class="lnlinks" href="#hl-22-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-4">&lt;a class="lnlinks" href="#hl-22-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-5">&lt;a class="lnlinks" href="#hl-22-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-6">&lt;a class="lnlinks" href="#hl-22-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-7">&lt;a class="lnlinks" href="#hl-22-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-8">&lt;a class="lnlinks" href="#hl-22-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-9">&lt;a class="lnlinks" href="#hl-22-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-10">&lt;a class="lnlinks" href="#hl-22-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-11">&lt;a class="lnlinks" href="#hl-22-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">datasource&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jdbc:mysql://mysql:3306/cloud_order?useSSL=false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">username&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">root&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">password&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">123&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">driver-class-name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">com.mysql.jdbc.Driver&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">application&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">orderservice&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server-addr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nacos:8848&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># nacos服务地址&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="433打包">
&lt;a href="#433%e6%89%93%e5%8c%85" class="header-anchor">#&lt;/a>
4.3.3.打包
&lt;/h3>&lt;p>接下来需要将我们的每个微服务都打包。因为之前查看到Dockerfile中的jar包名称都是app.jar，因此我们的每个微服务都需要用这个名称。&lt;/p>
&lt;p>可以通过修改pom.xml中的打包名称来实现，每个微服务都需要修改：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-23-1">&lt;a class="lnlinks" href="#hl-23-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-2">&lt;a class="lnlinks" href="#hl-23-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-3">&lt;a class="lnlinks" href="#hl-23-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-4">&lt;a class="lnlinks" href="#hl-23-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-5">&lt;a class="lnlinks" href="#hl-23-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-6">&lt;a class="lnlinks" href="#hl-23-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-7">&lt;a class="lnlinks" href="#hl-23-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-8">&lt;a class="lnlinks" href="#hl-23-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-9">&lt;a class="lnlinks" href="#hl-23-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-10">&lt;a class="lnlinks" href="#hl-23-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;build&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!-- 服务打包的最终名称 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;finalName&amp;gt;&lt;/span>app&lt;span class="nt">&amp;lt;/finalName&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;plugins&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;plugin&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.boot&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-boot-maven-plugin&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/plugin&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/plugins&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/build&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>打包后：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-c0ed9944534d14.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210801095951030"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="434拷贝jar包到部署目录">
&lt;a href="#434%e6%8b%b7%e8%b4%9djar%e5%8c%85%e5%88%b0%e9%83%a8%e7%bd%b2%e7%9b%ae%e5%bd%95" class="header-anchor">#&lt;/a>
4.3.4.拷贝jar包到部署目录
&lt;/h3>&lt;p>编译打包好的app.jar文件，需要放到Dockerfile的同级目录中。注意：每个微服务的app.jar放到与服务名称对应的目录，别搞错了。&lt;/p>
&lt;p>user-service：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-6b1095aee26928.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210801100201253"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>order-service：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-6b3caa2d7d09ec.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210801100231495"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>gateway：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-10611ba5880ffe.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210801100308102"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="435部署">
&lt;a href="#435%e9%83%a8%e7%bd%b2" class="header-anchor">#&lt;/a>
4.3.5.部署
&lt;/h3>&lt;p>最后，我们需要将文件整个cloud-demo文件夹上传到虚拟机中，理由DockerCompose部署。&lt;/p>
&lt;p>上传到任意目录：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653737781-c93ed7e695492f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210801100955653"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>部署：&lt;/p>
&lt;p>进入cloud-demo目录，然后运行下面的命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-24-1">&lt;a class="lnlinks" href="#hl-24-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker-compose up -d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="5docker镜像仓库">
&lt;a href="#5docker%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93" class="header-anchor">#&lt;/a>
5.Docker镜像仓库
&lt;/h1>&lt;h2 id="51搭建私有镜像仓库">
&lt;a href="#51%e6%90%ad%e5%bb%ba%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93" class="header-anchor">#&lt;/a>
5.1.搭建私有镜像仓库
&lt;/h2>&lt;p>参考课前资料《CentOS7安装Docker.md》&lt;/p>
&lt;h2 id="52推送拉取镜像">
&lt;a href="#52%e6%8e%a8%e9%80%81%e6%8b%89%e5%8f%96%e9%95%9c%e5%83%8f" class="header-anchor">#&lt;/a>
5.2.推送、拉取镜像
&lt;/h2>&lt;p>推送镜像到私有镜像服务必须先tag，步骤如下：&lt;/p>
&lt;p>① 重新tag本地镜像，名称前缀为私有仓库的地址：192.168.150.101:8080/&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-25-1">&lt;a class="lnlinks" href="#hl-25-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker tag nginx:latest 192.168.150.101:8080/nginx:1.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>② 推送镜像&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-26-1">&lt;a class="lnlinks" href="#hl-26-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker push 192.168.150.101:8080/nginx:1.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>③ 拉取镜像&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-27-1">&lt;a class="lnlinks" href="#hl-27-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker pull 192.168.150.101:8080/nginx:1.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>4.RabbitMQ</title><link>https://logan.wssw.fun/p/2023/01/95611894/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/95611894/</guid><description>&lt;h1 id="rabbitmq">
&lt;a href="#rabbitmq" class="header-anchor">#&lt;/a>
RabbitMQ
&lt;/h1>&lt;h1 id="1初识mq">
&lt;a href="#1%e5%88%9d%e8%af%86mq" class="header-anchor">#&lt;/a>
1.初识MQ
&lt;/h1>&lt;h2 id="11同步和异步通讯">
&lt;a href="#11%e5%90%8c%e6%ad%a5%e5%92%8c%e5%bc%82%e6%ad%a5%e9%80%9a%e8%ae%af" class="header-anchor">#&lt;/a>
1.1.同步和异步通讯
&lt;/h2>&lt;p>微服务间通讯有同步和异步两种方式：&lt;/p>
&lt;p>同步通讯：就像打电话，需要实时响应。&lt;/p>
&lt;p>异步通讯：就像发邮件，不需要马上回复。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-c2c25b953d0f6d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717161939695"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>两种方式各有优劣，打电话可以立即得到响应，但是你却不能跟多个人同时通话。发送邮件可以同时与多个人收发邮件，但是往往响应会有延迟。&lt;/p>
&lt;h3 id="111同步通讯">
&lt;a href="#111%e5%90%8c%e6%ad%a5%e9%80%9a%e8%ae%af" class="header-anchor">#&lt;/a>
1.1.1.同步通讯
&lt;/h3>&lt;p>我们之前学习的Feign调用就属于同步方式，虽然调用可以实时得到结果，但存在下面的问题：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-193e54e2841a3a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717162004285"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>总结：&lt;/p>
&lt;p>同步调用的优点：&lt;/p>
&lt;ul>
&lt;li>时效性较强，可以立即得到结果&lt;/li>
&lt;/ul>
&lt;p>同步调用的问题：&lt;/p>
&lt;ul>
&lt;li>耦合度高&lt;/li>
&lt;li>性能和吞吐能力下降&lt;/li>
&lt;li>有额外的资源消耗&lt;/li>
&lt;li>有级联失败问题&lt;/li>
&lt;/ul>
&lt;h3 id="112异步通讯">
&lt;a href="#112%e5%bc%82%e6%ad%a5%e9%80%9a%e8%ae%af" class="header-anchor">#&lt;/a>
1.1.2.异步通讯
&lt;/h3>&lt;p>异步调用则可以避免上述问题：&lt;/p>
&lt;p>我们以购买商品为例，用户支付后需要调用订单服务完成订单状态修改，调用物流服务，从仓库分配响应的库存并准备发货。&lt;/p>
&lt;p>在事件模式中，支付服务是事件发布者（publisher），在支付完成后只需要发布一个支付成功的事件（event），事件中带上订单id。&lt;/p>
&lt;p>订单服务和物流服务是事件订阅者（Consumer），订阅支付成功的事件，监听到事件后完成自己业务即可。&lt;/p>
&lt;p>为了解除事件发布者与订阅者之间的耦合，两者并不是直接通信，而是有一个中间人（Broker）。发布者发布事件到Broker，不关心谁来订阅事件。订阅者从Broker订阅事件，不关心谁发来的消息。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-6258c2b905cbb0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210422095356088"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>Broker 是一个像数据总线一样的东西，所有的服务要接收数据和发送数据都发到这个总线上，这个总线就像协议一样，让服务间的通讯变得标准和可控。&lt;/p>
&lt;p>好处：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>吞吐量提升：无需等待订阅者处理完成，响应更快速&lt;/p>
&lt;/li>
&lt;li>
&lt;p>故障隔离：服务没有直接调用，不存在级联失败问题&lt;/p>
&lt;/li>
&lt;li>
&lt;p>调用间没有阻塞，不会造成无效的资源占用&lt;/p>
&lt;/li>
&lt;li>
&lt;p>耦合度极低，每个服务都可以灵活插拔，可替换&lt;/p>
&lt;/li>
&lt;li>
&lt;p>流量削峰：不管发布事件的流量波动多大，都由Broker接收，订阅者可以按照自己的速度去处理事件&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>缺点：&lt;/p>
&lt;ul>
&lt;li>架构复杂了，业务没有明显的流程线，不好管理&lt;/li>
&lt;li>需要依赖于Broker的可靠、安全、性能&lt;/li>
&lt;/ul>
&lt;p>好在现在开源软件或云平台上 Broker 的软件是非常成熟的，比较常见的一种就是我们今天要学习的MQ技术。&lt;/p>
&lt;h2 id="12技术对比">
&lt;a href="#12%e6%8a%80%e6%9c%af%e5%af%b9%e6%af%94" class="header-anchor">#&lt;/a>
1.2.技术对比：
&lt;/h2>&lt;p>MQ，中文是消息队列（MessageQueue），字面来看就是存放消息的队列。也就是事件驱动架构中的Broker。&lt;/p>
&lt;p>比较常见的MQ实现：&lt;/p>
&lt;ul>
&lt;li>ActiveMQ&lt;/li>
&lt;li>RabbitMQ&lt;/li>
&lt;li>RocketMQ&lt;/li>
&lt;li>Kafka&lt;/li>
&lt;/ul>
&lt;p>几种常见MQ的对比：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;/th>
&lt;th>&lt;strong>RabbitMQ&lt;/strong>&lt;/th>
&lt;th>&lt;strong>ActiveMQ&lt;/strong>&lt;/th>
&lt;th>&lt;strong>RocketMQ&lt;/strong>&lt;/th>
&lt;th>&lt;strong>Kafka&lt;/strong>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>公司/社区&lt;/td>
&lt;td>Rabbit&lt;/td>
&lt;td>Apache&lt;/td>
&lt;td>阿里&lt;/td>
&lt;td>Apache&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>开发语言&lt;/td>
&lt;td>Erlang&lt;/td>
&lt;td>Java&lt;/td>
&lt;td>Java&lt;/td>
&lt;td>Scala&amp;amp;Java&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>协议支持&lt;/td>
&lt;td>AMQP，XMPP，SMTP，STOMP&lt;/td>
&lt;td>OpenWire,STOMP，REST,XMPP,AMQP&lt;/td>
&lt;td>自定义协议&lt;/td>
&lt;td>自定义协议&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>可用性&lt;/td>
&lt;td>高&lt;/td>
&lt;td>一般&lt;/td>
&lt;td>高&lt;/td>
&lt;td>高&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>单机吞吐量&lt;/td>
&lt;td>一般&lt;/td>
&lt;td>差&lt;/td>
&lt;td>高&lt;/td>
&lt;td>非常高&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>消息延迟&lt;/td>
&lt;td>微秒级&lt;/td>
&lt;td>毫秒级&lt;/td>
&lt;td>毫秒级&lt;/td>
&lt;td>毫秒以内&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>消息可靠性&lt;/td>
&lt;td>高&lt;/td>
&lt;td>一般&lt;/td>
&lt;td>高&lt;/td>
&lt;td>一般&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>追求可用性：Kafka、 RocketMQ 、RabbitMQ&lt;/p>
&lt;p>追求可靠性：RabbitMQ、RocketMQ&lt;/p>
&lt;p>追求吞吐能力：RocketMQ、Kafka&lt;/p>
&lt;p>追求消息低延迟：RabbitMQ、Kafka&lt;/p>
&lt;h1 id="2快速入门">
&lt;a href="#2%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8" class="header-anchor">#&lt;/a>
2.快速入门
&lt;/h1>&lt;h2 id="21安装rabbitmq">
&lt;a href="#21%e5%ae%89%e8%a3%85rabbitmq" class="header-anchor">#&lt;/a>
2.1.安装RabbitMQ
&lt;/h2>&lt;p>安装RabbitMQ，参考课前资料：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-89d51bd22618ba.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717162628635"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>MQ的基本结构：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-43fb4efdc0365b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717162752376"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>RabbitMQ中的一些角色：&lt;/p>
&lt;ul>
&lt;li>publisher：生产者&lt;/li>
&lt;li>consumer：消费者&lt;/li>
&lt;li>exchange个：交换机，负责消息路由&lt;/li>
&lt;li>queue：队列，存储消息&lt;/li>
&lt;li>virtualHost：虚拟主机，隔离不同租户的exchange、queue、消息的隔离&lt;/li>
&lt;/ul>
&lt;h2 id="22rabbitmq消息模型">
&lt;a href="#22rabbitmq%e6%b6%88%e6%81%af%e6%a8%a1%e5%9e%8b" class="header-anchor">#&lt;/a>
2.2.RabbitMQ消息模型
&lt;/h2>&lt;p>RabbitMQ官方提供了5个不同的Demo示例，对应了不同的消息模型：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-d4006b34bb62e6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717163332646"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="23导入demo工程">
&lt;a href="#23%e5%af%bc%e5%85%a5demo%e5%b7%a5%e7%a8%8b" class="header-anchor">#&lt;/a>
2.3.导入Demo工程
&lt;/h2>&lt;p>课前资料提供了一个Demo工程，mq-demo:&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-9e4a552c84fd2b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717163253264"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>导入后可以看到结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-c1cb89b71acca2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717163604330"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>包括三部分：&lt;/p>
&lt;ul>
&lt;li>mq-demo：父工程，管理项目依赖&lt;/li>
&lt;li>publisher：消息的发送者&lt;/li>
&lt;li>consumer：消息的消费者&lt;/li>
&lt;/ul>
&lt;h2 id="24入门案例">
&lt;a href="#24%e5%85%a5%e9%97%a8%e6%a1%88%e4%be%8b" class="header-anchor">#&lt;/a>
2.4.入门案例
&lt;/h2>&lt;p>简单队列模式的模型图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-5d8c79089626f8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717163434647"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>官方的HelloWorld是基于最基础的消息队列模型来实现的，只包括三个角色：&lt;/p>
&lt;ul>
&lt;li>publisher：消息发布者，将消息发送到队列queue&lt;/li>
&lt;li>queue：消息队列，负责接受并缓存消息&lt;/li>
&lt;li>consumer：订阅队列，处理队列中的消息&lt;/li>
&lt;/ul>
&lt;h3 id="241publisher实现">
&lt;a href="#241publisher%e5%ae%9e%e7%8e%b0" class="header-anchor">#&lt;/a>
2.4.1.publisher实现
&lt;/h3>&lt;p>思路：&lt;/p>
&lt;ul>
&lt;li>建立连接&lt;/li>
&lt;li>创建Channel&lt;/li>
&lt;li>声明队列&lt;/li>
&lt;li>发送消息&lt;/li>
&lt;li>关闭连接和channel&lt;/li>
&lt;/ul>
&lt;p>代码实现：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-6">&lt;a class="lnlinks" href="#hl-0-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-7">&lt;a class="lnlinks" href="#hl-0-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-8">&lt;a class="lnlinks" href="#hl-0-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-9">&lt;a class="lnlinks" href="#hl-0-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-10">&lt;a class="lnlinks" href="#hl-0-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-11">&lt;a class="lnlinks" href="#hl-0-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-12">&lt;a class="lnlinks" href="#hl-0-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-13">&lt;a class="lnlinks" href="#hl-0-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-14">&lt;a class="lnlinks" href="#hl-0-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-15">&lt;a class="lnlinks" href="#hl-0-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-16">&lt;a class="lnlinks" href="#hl-0-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-17">&lt;a class="lnlinks" href="#hl-0-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-18">&lt;a class="lnlinks" href="#hl-0-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-19">&lt;a class="lnlinks" href="#hl-0-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-20">&lt;a class="lnlinks" href="#hl-0-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-21">&lt;a class="lnlinks" href="#hl-0-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-22">&lt;a class="lnlinks" href="#hl-0-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-23">&lt;a class="lnlinks" href="#hl-0-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-24">&lt;a class="lnlinks" href="#hl-0-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-25">&lt;a class="lnlinks" href="#hl-0-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-26">&lt;a class="lnlinks" href="#hl-0-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-27">&lt;a class="lnlinks" href="#hl-0-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-28">&lt;a class="lnlinks" href="#hl-0-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-29">&lt;a class="lnlinks" href="#hl-0-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-30">&lt;a class="lnlinks" href="#hl-0-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-31">&lt;a class="lnlinks" href="#hl-0-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-32">&lt;a class="lnlinks" href="#hl-0-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-33">&lt;a class="lnlinks" href="#hl-0-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-34">&lt;a class="lnlinks" href="#hl-0-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-35">&lt;a class="lnlinks" href="#hl-0-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-36">&lt;a class="lnlinks" href="#hl-0-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-37">&lt;a class="lnlinks" href="#hl-0-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-38">&lt;a class="lnlinks" href="#hl-0-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-39">&lt;a class="lnlinks" href="#hl-0-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-40">&lt;a class="lnlinks" href="#hl-0-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-41">&lt;a class="lnlinks" href="#hl-0-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-42">&lt;a class="lnlinks" href="#hl-0-42">42&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.mq.helloworld&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.rabbitmq.client.Channel&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.rabbitmq.client.Connection&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.rabbitmq.client.ConnectionFactory&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.junit.Test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.io.IOException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.util.concurrent.TimeoutException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">PublisherTest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testSendMessage&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TimeoutException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.建立连接&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ConnectionFactory&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ConnectionFactory&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setHost&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;192.168.150.101&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">5672&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setVirtualHost&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setUsername&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;itcast&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setPassword&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;123321&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.2.建立连接&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Connection&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">connection&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">newConnection&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.创建通道Channel&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Channel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">connection&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">createChannel&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.创建队列&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">queueName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;simple.queue&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">queueDeclare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queueName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.发送消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;hello, rabbitmq!&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">basicPublish&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">queueName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBytes&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;发送消息成功：【&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;】&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 5.关闭通道和连接&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">connection&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="242consumer实现">
&lt;a href="#242consumer%e5%ae%9e%e7%8e%b0" class="header-anchor">#&lt;/a>
2.4.2.consumer实现
&lt;/h3>&lt;p>代码思路：&lt;/p>
&lt;ul>
&lt;li>建立连接&lt;/li>
&lt;li>创建Channel&lt;/li>
&lt;li>声明队列&lt;/li>
&lt;li>订阅消息&lt;/li>
&lt;/ul>
&lt;p>代码实现：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-9">&lt;a class="lnlinks" href="#hl-1-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-10">&lt;a class="lnlinks" href="#hl-1-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-11">&lt;a class="lnlinks" href="#hl-1-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-12">&lt;a class="lnlinks" href="#hl-1-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-13">&lt;a class="lnlinks" href="#hl-1-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-14">&lt;a class="lnlinks" href="#hl-1-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-15">&lt;a class="lnlinks" href="#hl-1-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-16">&lt;a class="lnlinks" href="#hl-1-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-17">&lt;a class="lnlinks" href="#hl-1-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-18">&lt;a class="lnlinks" href="#hl-1-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-19">&lt;a class="lnlinks" href="#hl-1-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-20">&lt;a class="lnlinks" href="#hl-1-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-21">&lt;a class="lnlinks" href="#hl-1-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-22">&lt;a class="lnlinks" href="#hl-1-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-23">&lt;a class="lnlinks" href="#hl-1-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-24">&lt;a class="lnlinks" href="#hl-1-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-25">&lt;a class="lnlinks" href="#hl-1-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-26">&lt;a class="lnlinks" href="#hl-1-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-27">&lt;a class="lnlinks" href="#hl-1-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-28">&lt;a class="lnlinks" href="#hl-1-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-29">&lt;a class="lnlinks" href="#hl-1-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-30">&lt;a class="lnlinks" href="#hl-1-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-31">&lt;a class="lnlinks" href="#hl-1-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-32">&lt;a class="lnlinks" href="#hl-1-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-33">&lt;a class="lnlinks" href="#hl-1-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-34">&lt;a class="lnlinks" href="#hl-1-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-35">&lt;a class="lnlinks" href="#hl-1-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-36">&lt;a class="lnlinks" href="#hl-1-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-37">&lt;a class="lnlinks" href="#hl-1-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-38">&lt;a class="lnlinks" href="#hl-1-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-39">&lt;a class="lnlinks" href="#hl-1-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-40">&lt;a class="lnlinks" href="#hl-1-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-41">&lt;a class="lnlinks" href="#hl-1-41">41&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.mq.helloworld&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.rabbitmq.client.*&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.io.IOException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.util.concurrent.TimeoutException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">ConsumerTest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TimeoutException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.建立连接&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ConnectionFactory&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ConnectionFactory&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setHost&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;192.168.150.101&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">5672&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setVirtualHost&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setUsername&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;itcast&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setPassword&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;123321&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.2.建立连接&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Connection&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">connection&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">factory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">newConnection&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.创建通道Channel&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Channel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">connection&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">createChannel&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.创建队列&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">queueName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;simple.queue&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">queueDeclare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queueName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.订阅消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">basicConsume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queueName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DefaultConsumer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">channel&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">handleDelivery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">consumerTag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Envelope&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">envelope&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">AMQP&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">BasicProperties&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">properties&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 5.处理消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;接收到消息：【&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;】&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">});&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;等待接收消息。。。。&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="25总结">
&lt;a href="#25%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
2.5.总结
&lt;/h2>&lt;p>基本消息队列的消息发送流程：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>建立connection&lt;/p>
&lt;/li>
&lt;li>
&lt;p>创建channel&lt;/p>
&lt;/li>
&lt;li>
&lt;p>利用channel声明队列&lt;/p>
&lt;/li>
&lt;li>
&lt;p>利用channel向队列发送消息&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>基本消息队列的消息接收流程：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>建立connection&lt;/p>
&lt;/li>
&lt;li>
&lt;p>创建channel&lt;/p>
&lt;/li>
&lt;li>
&lt;p>利用channel声明队列&lt;/p>
&lt;/li>
&lt;li>
&lt;p>定义consumer的消费行为handleDelivery()&lt;/p>
&lt;/li>
&lt;li>
&lt;p>利用channel将消费者与队列绑定&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h1 id="3springamqp">
&lt;a href="#3springamqp" class="header-anchor">#&lt;/a>
3.SpringAMQP
&lt;/h1>&lt;p>SpringAMQP是基于RabbitMQ封装的一套模板，并且还利用SpringBoot对其实现了自动装配，使用起来非常方便。&lt;/p>
&lt;p>SpringAmqp的官方地址：https://spring.io/projects/spring-amqp&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-8e2ba4a118d096.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717164024967"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-d7863066ef397a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717164038678"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>SpringAMQP提供了三个功能：&lt;/p>
&lt;ul>
&lt;li>自动声明队列、交换机及其绑定关系&lt;/li>
&lt;li>基于注解的监听器模式，异步接收消息&lt;/li>
&lt;li>封装了RabbitTemplate工具，用于发送消息&lt;/li>
&lt;/ul>
&lt;h2 id="31basic-queue-简单队列模型">
&lt;a href="#31basic-queue-%e7%ae%80%e5%8d%95%e9%98%9f%e5%88%97%e6%a8%a1%e5%9e%8b" class="header-anchor">#&lt;/a>
3.1.Basic Queue 简单队列模型
&lt;/h2>&lt;p>在父工程mq-demo中引入依赖&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!--AMQP依赖，包含RabbitMQ--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.boot&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-boot-starter-amqp&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="311消息发送">
&lt;a href="#311%e6%b6%88%e6%81%af%e5%8f%91%e9%80%81" class="header-anchor">#&lt;/a>
3.1.1.消息发送
&lt;/h3>&lt;p>首先配置MQ地址，在publisher服务的application.yml中添加配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-7">&lt;a class="lnlinks" href="#hl-3-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rabbitmq&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">192.168.150.101&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 主机名&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">5672&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 端口&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">virtual-host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 虚拟主机&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">username&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">itcast&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 用户名&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">password&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">123321&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 密码&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后在publisher服务中编写测试类SpringAmqpTest，并利用RabbitTemplate实现消息发送：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-5">&lt;a class="lnlinks" href="#hl-4-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-6">&lt;a class="lnlinks" href="#hl-4-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-7">&lt;a class="lnlinks" href="#hl-4-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-8">&lt;a class="lnlinks" href="#hl-4-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-9">&lt;a class="lnlinks" href="#hl-4-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-10">&lt;a class="lnlinks" href="#hl-4-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-11">&lt;a class="lnlinks" href="#hl-4-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-12">&lt;a class="lnlinks" href="#hl-4-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-13">&lt;a class="lnlinks" href="#hl-4-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-14">&lt;a class="lnlinks" href="#hl-4-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-15">&lt;a class="lnlinks" href="#hl-4-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-16">&lt;a class="lnlinks" href="#hl-4-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-17">&lt;a class="lnlinks" href="#hl-4-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-18">&lt;a class="lnlinks" href="#hl-4-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-19">&lt;a class="lnlinks" href="#hl-4-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-20">&lt;a class="lnlinks" href="#hl-4-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-21">&lt;a class="lnlinks" href="#hl-4-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-22">&lt;a class="lnlinks" href="#hl-4-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-23">&lt;a class="lnlinks" href="#hl-4-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-24">&lt;a class="lnlinks" href="#hl-4-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-25">&lt;a class="lnlinks" href="#hl-4-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-26">&lt;a class="lnlinks" href="#hl-4-26">26&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.mq.spring&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.junit.Test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.junit.runner.RunWith&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.rabbit.core.RabbitTemplate&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.factory.annotation.Autowired&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.boot.test.context.SpringBootTest&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.test.context.junit4.SpringRunner&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@RunWith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SpringRunner&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@SpringBootTest&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">SpringAmqpTest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RabbitTemplate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testSimpleQueue&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 队列名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">queueName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;simple.queue&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;hello, spring amqp!&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发送消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">convertAndSend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queueName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="312消息接收">
&lt;a href="#312%e6%b6%88%e6%81%af%e6%8e%a5%e6%94%b6" class="header-anchor">#&lt;/a>
3.1.2.消息接收
&lt;/h3>&lt;p>首先配置MQ地址，在consumer服务的application.yml中添加配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-4">&lt;a class="lnlinks" href="#hl-5-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-5">&lt;a class="lnlinks" href="#hl-5-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-6">&lt;a class="lnlinks" href="#hl-5-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-7">&lt;a class="lnlinks" href="#hl-5-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rabbitmq&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">192.168.150.101&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 主机名&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">5672&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 端口&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">virtual-host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 虚拟主机&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">username&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">itcast&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 用户名&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">password&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">123321&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 密码&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后在consumer服务的&lt;code>cn.itcast.mq.listener&lt;/code>包中新建一个类SpringRabbitListener，代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-5">&lt;a class="lnlinks" href="#hl-6-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-6">&lt;a class="lnlinks" href="#hl-6-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-7">&lt;a class="lnlinks" href="#hl-6-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-8">&lt;a class="lnlinks" href="#hl-6-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-9">&lt;a class="lnlinks" href="#hl-6-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-10">&lt;a class="lnlinks" href="#hl-6-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-11">&lt;a class="lnlinks" href="#hl-6-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-12">&lt;a class="lnlinks" href="#hl-6-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-13">&lt;a class="lnlinks" href="#hl-6-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.mq.listener&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.rabbit.annotation.RabbitListener&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.stereotype.Component&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Component&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">SpringRabbitListener&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queues&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;simple.queue&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenSimpleQueueMessage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InterruptedException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;spring 消费者接收到消息：【&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;】&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="313测试">
&lt;a href="#313%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
3.1.3.测试
&lt;/h3>&lt;p>启动consumer服务，然后在publisher服务中运行测试代码，发送MQ消息&lt;/p>
&lt;h2 id="32workqueue">
&lt;a href="#32workqueue" class="header-anchor">#&lt;/a>
3.2.WorkQueue
&lt;/h2>&lt;p>Work queues，也被称为（Task queues），任务模型。简单来说就是&lt;strong>让多个消费者绑定到一个队列，共同消费队列中的消息&lt;/strong>。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-83253bd850d4ce.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717164238910"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。&lt;/p>
&lt;p>此时就可以使用work 模型，多个消费者共同处理消息处理，速度就能大大提高了。&lt;/p>
&lt;h3 id="321消息发送">
&lt;a href="#321%e6%b6%88%e6%81%af%e5%8f%91%e9%80%81" class="header-anchor">#&lt;/a>
3.2.1.消息发送
&lt;/h3>&lt;p>这次我们循环发送，模拟大量消息堆积现象。&lt;/p>
&lt;p>在publisher服务中的SpringAmqpTest类中添加一个测试方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-8">&lt;a class="lnlinks" href="#hl-7-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-9">&lt;a class="lnlinks" href="#hl-7-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-10">&lt;a class="lnlinks" href="#hl-7-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-11">&lt;a class="lnlinks" href="#hl-7-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-12">&lt;a class="lnlinks" href="#hl-7-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-13">&lt;a class="lnlinks" href="#hl-7-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-14">&lt;a class="lnlinks" href="#hl-7-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-15">&lt;a class="lnlinks" href="#hl-7-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-16">&lt;a class="lnlinks" href="#hl-7-16">16&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * workQueue
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 向队列中不停发送消息，模拟消息堆积。
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testWorkQueue&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InterruptedException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 队列名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">queueName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;simple.queue&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;hello, message_&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">50&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发送消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">convertAndSend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queueName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">20&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="322消息接收">
&lt;a href="#322%e6%b6%88%e6%81%af%e6%8e%a5%e6%94%b6" class="header-anchor">#&lt;/a>
3.2.2.消息接收
&lt;/h3>&lt;p>要模拟多个消费者绑定同一个队列，我们在consumer服务的SpringRabbitListener中添加2个新的方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-6">&lt;a class="lnlinks" href="#hl-8-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-7">&lt;a class="lnlinks" href="#hl-8-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-8">&lt;a class="lnlinks" href="#hl-8-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-9">&lt;a class="lnlinks" href="#hl-8-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-10">&lt;a class="lnlinks" href="#hl-8-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-11">&lt;a class="lnlinks" href="#hl-8-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queues&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;simple.queue&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenWorkQueue1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InterruptedException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消费者1接收到消息：【&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;】&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LocalTime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">now&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">20&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queues&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;simple.queue&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenWorkQueue2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InterruptedException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消费者2........接收到消息：【&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;】&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LocalTime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">now&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Thread&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">200&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>注意到这个消费者sleep了1000秒，模拟任务耗时。&lt;/p>
&lt;h3 id="323测试">
&lt;a href="#323%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
3.2.3.测试
&lt;/h3>&lt;p>启动ConsumerApplication后，在执行publisher服务中刚刚编写的发送测试方法testWorkQueue。&lt;/p>
&lt;p>可以看到消费者1很快完成了自己的25条消息。消费者2却在缓慢的处理自己的25条消息。&lt;/p>
&lt;p>也就是说消息是平均分配给每个消费者，并没有考虑到消费者的处理能力。这样显然是有问题的。&lt;/p>
&lt;h3 id="324能者多劳">
&lt;a href="#324%e8%83%bd%e8%80%85%e5%a4%9a%e5%8a%b3" class="header-anchor">#&lt;/a>
3.2.4.能者多劳
&lt;/h3>&lt;p>在spring中有一个简单的配置，可以解决这个问题。我们修改consumer服务的application.yml文件，添加配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-5">&lt;a class="lnlinks" href="#hl-9-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rabbitmq&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">listener&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">simple&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">prefetch&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 每次只能获取一条消息，处理完成才能获取下一个消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="325总结">
&lt;a href="#325%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
3.2.5.总结
&lt;/h3>&lt;p>Work模型的使用：&lt;/p>
&lt;ul>
&lt;li>多个消费者绑定到一个队列，同一条消息只会被一个消费者处理&lt;/li>
&lt;li>通过设置prefetch来控制消费者预取的消息数量&lt;/li>
&lt;/ul>
&lt;h2 id="33发布订阅">
&lt;a href="#33%e5%8f%91%e5%b8%83%e8%ae%a2%e9%98%85" class="header-anchor">#&lt;/a>
3.3.发布/订阅
&lt;/h2>&lt;p>发布订阅的模型如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-fb57fba8b40509.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717165309625"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，在订阅模型中，多了一个exchange角色，而且过程略有变化：&lt;/p>
&lt;ul>
&lt;li>Publisher：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）&lt;/li>
&lt;li>Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有以下3种类型：
&lt;ul>
&lt;li>Fanout：广播，将消息交给所有绑定到交换机的队列&lt;/li>
&lt;li>Direct：定向，把消息交给符合指定routing key 的队列&lt;/li>
&lt;li>Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Consumer：消费者，与以前一样，订阅队列，没有变化&lt;/li>
&lt;li>Queue：消息队列也与以前一样，接收消息、缓存消息。&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Exchange（交换机）只负责转发消息，不具备存储消息的能力&lt;/strong>，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！&lt;/p>
&lt;h2 id="34fanout">
&lt;a href="#34fanout" class="header-anchor">#&lt;/a>
3.4.Fanout
&lt;/h2>&lt;p>Fanout，英文翻译是扇出，我觉得在MQ中叫广播更合适。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-0a3af701ff35d8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717165438225"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在广播模式下，消息发送流程是这样的：&lt;/p>
&lt;ul>
&lt;li>1） 可以有多个队列&lt;/li>
&lt;li>2） 每个队列都要绑定到Exchange（交换机）&lt;/li>
&lt;li>3） 生产者发送的消息，只能发送到交换机，交换机来决定要发给哪个队列，生产者无法决定&lt;/li>
&lt;li>4） 交换机把消息发送给绑定过的所有队列&lt;/li>
&lt;li>5） 订阅队列的消费者都能拿到消息&lt;/li>
&lt;/ul>
&lt;p>我们的计划是这样的：&lt;/p>
&lt;ul>
&lt;li>创建一个交换机 itcast.fanout，类型是Fanout&lt;/li>
&lt;li>创建两个队列fanout.queue1和fanout.queue2，绑定到交换机itcast.fanout&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-64c4da1fb5ae94.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717165509466"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="341声明队列和交换机">
&lt;a href="#341%e5%a3%b0%e6%98%8e%e9%98%9f%e5%88%97%e5%92%8c%e4%ba%a4%e6%8d%a2%e6%9c%ba" class="header-anchor">#&lt;/a>
3.4.1.声明队列和交换机
&lt;/h3>&lt;p>Spring提供了一个接口Exchange，来表示所有不同类型的交换机：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-a72f3126d52589.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717165552676"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在consumer中创建一个类，声明队列和交换机：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-5">&lt;a class="lnlinks" href="#hl-10-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-6">&lt;a class="lnlinks" href="#hl-10-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-7">&lt;a class="lnlinks" href="#hl-10-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-8">&lt;a class="lnlinks" href="#hl-10-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-9">&lt;a class="lnlinks" href="#hl-10-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-10">&lt;a class="lnlinks" href="#hl-10-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-11">&lt;a class="lnlinks" href="#hl-10-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-12">&lt;a class="lnlinks" href="#hl-10-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-13">&lt;a class="lnlinks" href="#hl-10-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-14">&lt;a class="lnlinks" href="#hl-10-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-15">&lt;a class="lnlinks" href="#hl-10-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-16">&lt;a class="lnlinks" href="#hl-10-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-17">&lt;a class="lnlinks" href="#hl-10-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-18">&lt;a class="lnlinks" href="#hl-10-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-19">&lt;a class="lnlinks" href="#hl-10-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-20">&lt;a class="lnlinks" href="#hl-10-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-21">&lt;a class="lnlinks" href="#hl-10-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-22">&lt;a class="lnlinks" href="#hl-10-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-23">&lt;a class="lnlinks" href="#hl-10-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-24">&lt;a class="lnlinks" href="#hl-10-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-25">&lt;a class="lnlinks" href="#hl-10-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-26">&lt;a class="lnlinks" href="#hl-10-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-27">&lt;a class="lnlinks" href="#hl-10-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-28">&lt;a class="lnlinks" href="#hl-10-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-29">&lt;a class="lnlinks" href="#hl-10-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-30">&lt;a class="lnlinks" href="#hl-10-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-31">&lt;a class="lnlinks" href="#hl-10-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-32">&lt;a class="lnlinks" href="#hl-10-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-33">&lt;a class="lnlinks" href="#hl-10-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-34">&lt;a class="lnlinks" href="#hl-10-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-35">&lt;a class="lnlinks" href="#hl-10-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-36">&lt;a class="lnlinks" href="#hl-10-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-37">&lt;a class="lnlinks" href="#hl-10-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-38">&lt;a class="lnlinks" href="#hl-10-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-39">&lt;a class="lnlinks" href="#hl-10-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-40">&lt;a class="lnlinks" href="#hl-10-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-41">&lt;a class="lnlinks" href="#hl-10-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-42">&lt;a class="lnlinks" href="#hl-10-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-43">&lt;a class="lnlinks" href="#hl-10-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-44">&lt;a class="lnlinks" href="#hl-10-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-45">&lt;a class="lnlinks" href="#hl-10-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-46">&lt;a class="lnlinks" href="#hl-10-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-47">&lt;a class="lnlinks" href="#hl-10-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-48">&lt;a class="lnlinks" href="#hl-10-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-49">&lt;a class="lnlinks" href="#hl-10-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-50">&lt;a class="lnlinks" href="#hl-10-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-51">&lt;a class="lnlinks" href="#hl-10-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-52">&lt;a class="lnlinks" href="#hl-10-52">52&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.mq.config&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.core.Binding&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.core.BindingBuilder&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.core.FanoutExchange&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.core.Queue&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.context.annotation.Bean&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.context.annotation.Configuration&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Configuration&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">FanoutConfig&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 声明交换机
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @return Fanout类型交换机
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FanoutExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">fanoutExchange&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FanoutExchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;itcast.fanout&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 第1个队列
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">fanoutQueue1&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;fanout.queue1&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 绑定队列和交换机
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Binding&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">bindingQueue1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">fanoutQueue1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FanoutExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">fanoutExchange&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BindingBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fanoutQueue1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fanoutExchange&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 第2个队列
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">fanoutQueue2&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;fanout.queue2&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 绑定队列和交换机
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Binding&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">bindingQueue2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">fanoutQueue2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FanoutExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">fanoutExchange&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BindingBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fanoutQueue2&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fanoutExchange&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="342消息发送">
&lt;a href="#342%e6%b6%88%e6%81%af%e5%8f%91%e9%80%81" class="header-anchor">#&lt;/a>
3.4.2.消息发送
&lt;/h3>&lt;p>在publisher服务的SpringAmqpTest类中添加测试方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-5">&lt;a class="lnlinks" href="#hl-11-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-6">&lt;a class="lnlinks" href="#hl-11-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-7">&lt;a class="lnlinks" href="#hl-11-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-8">&lt;a class="lnlinks" href="#hl-11-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testFanoutExchange&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 队列名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exchangeName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;itcast.fanout&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;hello, everyone!&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">convertAndSend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exchangeName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="343消息接收">
&lt;a href="#343%e6%b6%88%e6%81%af%e6%8e%a5%e6%94%b6" class="header-anchor">#&lt;/a>
3.4.3.消息接收
&lt;/h3>&lt;p>在consumer服务的SpringRabbitListener中添加两个方法，作为消费者：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-6">&lt;a class="lnlinks" href="#hl-12-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-7">&lt;a class="lnlinks" href="#hl-12-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-8">&lt;a class="lnlinks" href="#hl-12-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-9">&lt;a class="lnlinks" href="#hl-12-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queues&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;fanout.queue1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenFanoutQueue1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消费者1接收到Fanout消息：【&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;】&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queues&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;fanout.queue2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenFanoutQueue2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消费者2接收到Fanout消息：【&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;】&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="344总结">
&lt;a href="#344%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
3.4.4.总结
&lt;/h3>&lt;p>交换机的作用是什么？&lt;/p>
&lt;ul>
&lt;li>接收publisher发送的消息&lt;/li>
&lt;li>将消息按照规则路由到与之绑定的队列&lt;/li>
&lt;li>不能缓存消息，路由失败，消息丢失&lt;/li>
&lt;li>FanoutExchange的会将消息路由到每个绑定的队列&lt;/li>
&lt;/ul>
&lt;p>声明队列、交换机、绑定关系的Bean是什么？&lt;/p>
&lt;ul>
&lt;li>Queue&lt;/li>
&lt;li>FanoutExchange&lt;/li>
&lt;li>Binding&lt;/li>
&lt;/ul>
&lt;h2 id="35direct">
&lt;a href="#35direct" class="header-anchor">#&lt;/a>
3.5.Direct
&lt;/h2>&lt;p>在Fanout模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到Direct类型的Exchange。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-762b7e80392d71.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717170041447"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在Direct模型下：&lt;/p>
&lt;ul>
&lt;li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个&lt;code>RoutingKey&lt;/code>（路由key）&lt;/li>
&lt;li>消息的发送方在 向 Exchange发送消息时，也必须指定消息的 &lt;code>RoutingKey&lt;/code>。&lt;/li>
&lt;li>Exchange不再把消息交给每一个绑定的队列，而是根据消息的&lt;code>Routing Key&lt;/code>进行判断，只有队列的&lt;code>Routingkey&lt;/code>与消息的 &lt;code>Routing key&lt;/code>完全一致，才会接收到消息&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>案例需求如下&lt;/strong>：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>利用@RabbitListener声明Exchange、Queue、RoutingKey&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在consumer服务中，编写两个消费者方法，分别监听direct.queue1和direct.queue2&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在publisher中编写测试方法，向itcast. direct发送消息&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-71327754e676ce.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717170223317"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="351基于注解声明队列和交换机">
&lt;a href="#351%e5%9f%ba%e4%ba%8e%e6%b3%a8%e8%a7%a3%e5%a3%b0%e6%98%8e%e9%98%9f%e5%88%97%e5%92%8c%e4%ba%a4%e6%8d%a2%e6%9c%ba" class="header-anchor">#&lt;/a>
3.5.1.基于注解声明队列和交换机
&lt;/h3>&lt;p>基于@Bean的方式声明队列和交换机比较麻烦，Spring还提供了基于注解方式来声明。&lt;/p>
&lt;p>在consumer的SpringRabbitListener中添加两个消费者，同时基于注解来声明队列和交换机：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-6">&lt;a class="lnlinks" href="#hl-13-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-7">&lt;a class="lnlinks" href="#hl-13-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-8">&lt;a class="lnlinks" href="#hl-13-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-9">&lt;a class="lnlinks" href="#hl-13-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-10">&lt;a class="lnlinks" href="#hl-13-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-11">&lt;a class="lnlinks" href="#hl-13-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-12">&lt;a class="lnlinks" href="#hl-13-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-13">&lt;a class="lnlinks" href="#hl-13-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-14">&lt;a class="lnlinks" href="#hl-13-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-15">&lt;a class="lnlinks" href="#hl-13-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-16">&lt;a class="lnlinks" href="#hl-13-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-17">&lt;a class="lnlinks" href="#hl-13-17">17&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bindings&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@QueueBinding&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@Queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;direct.queue1&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@Exchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;itcast.direct&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ExchangeTypes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DIRECT&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;red&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;blue&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenDirectQueue1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消费者接收到direct.queue1的消息：【&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;】&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bindings&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@QueueBinding&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@Queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;direct.queue2&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@Exchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;itcast.direct&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ExchangeTypes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DIRECT&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;red&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;yellow&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenDirectQueue2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消费者接收到direct.queue2的消息：【&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;】&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="352消息发送">
&lt;a href="#352%e6%b6%88%e6%81%af%e5%8f%91%e9%80%81" class="header-anchor">#&lt;/a>
3.5.2.消息发送
&lt;/h3>&lt;p>在publisher服务的SpringAmqpTest类中添加测试方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-5">&lt;a class="lnlinks" href="#hl-14-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-6">&lt;a class="lnlinks" href="#hl-14-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-7">&lt;a class="lnlinks" href="#hl-14-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-8">&lt;a class="lnlinks" href="#hl-14-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-9">&lt;a class="lnlinks" href="#hl-14-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testSendDirectExchange&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 交换机名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exchangeName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;itcast.direct&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;红色警报！日本乱排核废水，导致海洋生物变异，惊现哥斯拉！&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发送消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">convertAndSend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exchangeName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;red&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="353总结">
&lt;a href="#353%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
3.5.3.总结
&lt;/h3>&lt;p>描述下Direct交换机与Fanout交换机的差异？&lt;/p>
&lt;ul>
&lt;li>Fanout交换机将消息路由给每一个与之绑定的队列&lt;/li>
&lt;li>Direct交换机根据RoutingKey判断路由给哪个队列&lt;/li>
&lt;li>如果多个队列具有相同的RoutingKey，则与Fanout功能类似&lt;/li>
&lt;/ul>
&lt;p>基于@RabbitListener注解声明队列和交换机有哪些常见注解？&lt;/p>
&lt;ul>
&lt;li>@Queue&lt;/li>
&lt;li>@Exchange&lt;/li>
&lt;/ul>
&lt;h2 id="36topic">
&lt;a href="#36topic" class="header-anchor">#&lt;/a>
3.6.Topic
&lt;/h2>&lt;h3 id="361说明">
&lt;a href="#361%e8%af%b4%e6%98%8e" class="header-anchor">#&lt;/a>
3.6.1.说明
&lt;/h3>&lt;p>&lt;code>Topic&lt;/code>类型的&lt;code>Exchange&lt;/code>与&lt;code>Direct&lt;/code>相比，都是可以根据&lt;code>RoutingKey&lt;/code>把消息路由到不同的队列。只不过&lt;code>Topic&lt;/code>类型&lt;code>Exchange&lt;/code>可以让队列在绑定&lt;code>Routing key&lt;/code> 的时候使用通配符！&lt;/p>
&lt;p>&lt;code>Routingkey&lt;/code> 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： &lt;code>item.insert&lt;/code>&lt;/p>
&lt;p>通配符规则：&lt;/p>
&lt;p>&lt;code>#&lt;/code>：匹配一个或多个词&lt;/p>
&lt;p>&lt;code>*&lt;/code>：匹配不多不少恰好1个词&lt;/p>
&lt;p>举例：&lt;/p>
&lt;p>&lt;code>item.#&lt;/code>：能够匹配&lt;code>item.spu.insert&lt;/code> 或者 &lt;code>item.spu&lt;/code>&lt;/p>
&lt;p>&lt;code>item.*&lt;/code>：只能匹配&lt;code>item.spu&lt;/code>&lt;/p>
&lt;p>​&lt;/p>
&lt;p>图示：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-9880902efc82ed.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717170705380"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解释：&lt;/p>
&lt;ul>
&lt;li>Queue1：绑定的是&lt;code>china.#&lt;/code> ，因此凡是以 &lt;code>china.&lt;/code>开头的&lt;code>routing key&lt;/code> 都会被匹配到。包括china.news和china.weather&lt;/li>
&lt;li>Queue2：绑定的是&lt;code>#.news&lt;/code> ，因此凡是以 &lt;code>.news&lt;/code>结尾的 &lt;code>routing key&lt;/code> 都会被匹配。包括china.news和japan.news&lt;/li>
&lt;/ul>
&lt;p>案例需求：&lt;/p>
&lt;p>实现思路如下：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>并利用@RabbitListener声明Exchange、Queue、RoutingKey&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在consumer服务中，编写两个消费者方法，分别监听topic.queue1和topic.queue2&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在publisher中编写测试方法，向itcast. topic发送消息&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-0b40165d1121fe.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717170829229"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="362消息发送">
&lt;a href="#362%e6%b6%88%e6%81%af%e5%8f%91%e9%80%81" class="header-anchor">#&lt;/a>
3.6.2.消息发送
&lt;/h3>&lt;p>在publisher服务的SpringAmqpTest类中添加测试方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-6">&lt;a class="lnlinks" href="#hl-15-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-7">&lt;a class="lnlinks" href="#hl-15-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-8">&lt;a class="lnlinks" href="#hl-15-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-9">&lt;a class="lnlinks" href="#hl-15-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-10">&lt;a class="lnlinks" href="#hl-15-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-11">&lt;a class="lnlinks" href="#hl-15-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-12">&lt;a class="lnlinks" href="#hl-15-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * topicExchange
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testSendTopicExchange&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 交换机名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exchangeName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;itcast.topic&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;喜报！孙悟空大战哥斯拉，胜!&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发送消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">convertAndSend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exchangeName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;china.news&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="363消息接收">
&lt;a href="#363%e6%b6%88%e6%81%af%e6%8e%a5%e6%94%b6" class="header-anchor">#&lt;/a>
3.6.3.消息接收
&lt;/h3>&lt;p>在consumer服务的SpringRabbitListener中添加方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-7">&lt;a class="lnlinks" href="#hl-16-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-8">&lt;a class="lnlinks" href="#hl-16-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-9">&lt;a class="lnlinks" href="#hl-16-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-10">&lt;a class="lnlinks" href="#hl-16-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-11">&lt;a class="lnlinks" href="#hl-16-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-12">&lt;a class="lnlinks" href="#hl-16-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-13">&lt;a class="lnlinks" href="#hl-16-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-14">&lt;a class="lnlinks" href="#hl-16-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-15">&lt;a class="lnlinks" href="#hl-16-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-16">&lt;a class="lnlinks" href="#hl-16-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-17">&lt;a class="lnlinks" href="#hl-16-17">17&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bindings&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@QueueBinding&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@Queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;topic.queue1&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@Exchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;itcast.topic&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ExchangeTypes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">TOPIC&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;china.#&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenTopicQueue1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消费者接收到topic.queue1的消息：【&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;】&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bindings&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@QueueBinding&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@Queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;topic.queue2&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">exchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nd">@Exchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;itcast.topic&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ExchangeTypes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">TOPIC&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;#.news&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenTopicQueue2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;消费者接收到topic.queue2的消息：【&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;】&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="364总结">
&lt;a href="#364%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
3.6.4.总结
&lt;/h3>&lt;p>描述下Direct交换机与Topic交换机的差异？&lt;/p>
&lt;ul>
&lt;li>Topic交换机接收的消息RoutingKey必须是多个单词，以 &lt;code>**.**&lt;/code> 分割&lt;/li>
&lt;li>Topic交换机与队列绑定时的bindingKey可以指定通配符&lt;/li>
&lt;li>&lt;code>#&lt;/code>：代表0个或多个词&lt;/li>
&lt;li>&lt;code>*&lt;/code>：代表1个词&lt;/li>
&lt;/ul>
&lt;h2 id="37消息转换器">
&lt;a href="#37%e6%b6%88%e6%81%af%e8%bd%ac%e6%8d%a2%e5%99%a8" class="header-anchor">#&lt;/a>
3.7.消息转换器
&lt;/h2>&lt;p>之前说过，Spring会把你发送的消息序列化为字节发送给MQ，接收消息的时候，还会把字节反序列化为Java对象。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-4bc3f753a02f4a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20200525170410401"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>只不过，默认情况下Spring采用的序列化方式是JDK序列化。众所周知，JDK序列化存在下列问题：&lt;/p>
&lt;ul>
&lt;li>数据体积过大&lt;/li>
&lt;li>有安全漏洞&lt;/li>
&lt;li>可读性差&lt;/li>
&lt;/ul>
&lt;p>我们来测试一下。&lt;/p>
&lt;h3 id="371测试默认转换器">
&lt;a href="#371%e6%b5%8b%e8%af%95%e9%bb%98%e8%ae%a4%e8%bd%ac%e6%8d%a2%e5%99%a8" class="header-anchor">#&lt;/a>
3.7.1.测试默认转换器
&lt;/h3>&lt;p>我们修改消息发送的代码，发送一个Map对象：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-4">&lt;a class="lnlinks" href="#hl-17-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-5">&lt;a class="lnlinks" href="#hl-17-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-6">&lt;a class="lnlinks" href="#hl-17-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-7">&lt;a class="lnlinks" href="#hl-17-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-8">&lt;a class="lnlinks" href="#hl-17-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-9">&lt;a class="lnlinks" href="#hl-17-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testSendMap&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InterruptedException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 准备消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;Jack&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">21&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 发送消息&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">rabbitTemplate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">convertAndSend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;simple.queue&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>停止consumer服务&lt;/p>
&lt;p>发送消息后查看控制台：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738091-623ac42604437d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210422232835363"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="372配置json转换器">
&lt;a href="#372%e9%85%8d%e7%bd%aejson%e8%bd%ac%e6%8d%a2%e5%99%a8" class="header-anchor">#&lt;/a>
3.7.2.配置JSON转换器
&lt;/h3>&lt;p>显然，JDK序列化方式并不合适。我们希望消息体的体积更小、可读性更高，因此可以使用JSON方式来做序列化和反序列化。&lt;/p>
&lt;p>在publisher和consumer两个服务中都引入依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-5">&lt;a class="lnlinks" href="#hl-18-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.fasterxml.jackson.dataformat&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>jackson-dataformat-xml&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>2.9.10&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>配置消息转换器。&lt;/p>
&lt;p>在启动类中添加一个Bean即可：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MessageConverter&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">jsonMessageConverter&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Jackson2JsonMessageConverter&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>5.分布式搜索引擎01</title><link>https://logan.wssw.fun/p/2023/01/5117b451/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/5117b451/</guid><description>&lt;h1 id="分布式搜索引擎01">
&lt;a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e6%90%9c%e7%b4%a2%e5%bc%95%e6%93%8e01" class="header-anchor">#&lt;/a>
分布式搜索引擎01
&lt;/h1>&lt;p>&amp;ndash; elasticsearch基础&lt;/p>
&lt;h1 id="0学习目标">
&lt;a href="#0%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87" class="header-anchor">#&lt;/a>
0.学习目标
&lt;/h1>&lt;h1 id="1初识elasticsearch">
&lt;a href="#1%e5%88%9d%e8%af%86elasticsearch" class="header-anchor">#&lt;/a>
1.初识elasticsearch
&lt;/h1>&lt;h2 id="11了解es">
&lt;a href="#11%e4%ba%86%e8%a7%a3es" class="header-anchor">#&lt;/a>
1.1.了解ES
&lt;/h2>&lt;h3 id="111elasticsearch的作用">
&lt;a href="#111elasticsearch%e7%9a%84%e4%bd%9c%e7%94%a8" class="header-anchor">#&lt;/a>
1.1.1.elasticsearch的作用
&lt;/h3>&lt;p>elasticsearch是一款非常强大的开源搜索引擎，具备非常多强大功能，可以帮助我们从海量数据中快速找到需要的内容&lt;/p>
&lt;p>例如：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>在GitHub搜索代码&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-096fc089fb1cbf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720193623245"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在电商网站搜索商品&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-9ceb86de5a49d0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720193633483"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在百度搜索答案&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-f8d191cbe7f68b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720193641907"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在打车软件搜索附近的车&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-443d72ea2ce036.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720193648044"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="112elk技术栈">
&lt;a href="#112elk%e6%8a%80%e6%9c%af%e6%a0%88" class="header-anchor">#&lt;/a>
1.1.2.ELK技术栈
&lt;/h3>&lt;p>elasticsearch结合kibana、Logstash、Beats，也就是elastic stack（ELK）。被广泛应用在日志数据分析、实时监控等领域：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-9829297df0736d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720194008781"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>而elasticsearch是elastic stack的核心，负责存储、搜索、分析数据。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-6f053f103f669c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720194230265"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="113elasticsearch和lucene">
&lt;a href="#113elasticsearch%e5%92%8clucene" class="header-anchor">#&lt;/a>
1.1.3.elasticsearch和lucene
&lt;/h3>&lt;p>elasticsearch底层是基于&lt;strong>lucene&lt;/strong>来实现的。&lt;/p>
&lt;p>&lt;strong>Lucene&lt;/strong>是一个Java语言的搜索引擎类库，是Apache公司的顶级项目，由DougCutting于1999年研发。官网地址：https://lucene.apache.org/ 。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-e2a92a258bcf5c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720194547780"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>&lt;strong>elasticsearch&lt;/strong>的发展历史：&lt;/p>
&lt;ul>
&lt;li>2004年Shay Banon基于Lucene开发了Compass&lt;/li>
&lt;li>2010年Shay Banon 重写了Compass，取名为Elasticsearch。&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-0fee02e92145e8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720195001221"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="114为什么不是其他搜索技术">
&lt;a href="#114%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e6%98%af%e5%85%b6%e4%bb%96%e6%90%9c%e7%b4%a2%e6%8a%80%e6%9c%af" class="header-anchor">#&lt;/a>
1.1.4.为什么不是其他搜索技术？
&lt;/h3>&lt;p>目前比较知名的搜索引擎技术排名：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-e6fc25eb72ec5d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720195142535"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>虽然在早期，Apache Solr是最主要的搜索引擎技术，但随着发展elasticsearch已经渐渐超越了Solr，独占鳌头：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-1c1e5a084d5a0c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720195306484"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="115总结">
&lt;a href="#115%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
1.1.5.总结
&lt;/h3>&lt;p>什么是elasticsearch？&lt;/p>
&lt;ul>
&lt;li>一个开源的分布式搜索引擎，可以用来实现搜索、日志统计、分析、系统监控等功能&lt;/li>
&lt;/ul>
&lt;p>什么是elastic stack（ELK）？&lt;/p>
&lt;ul>
&lt;li>是以elasticsearch为核心的技术栈，包括beats、Logstash、kibana、elasticsearch&lt;/li>
&lt;/ul>
&lt;p>什么是Lucene？&lt;/p>
&lt;ul>
&lt;li>是Apache的开源搜索引擎类库，提供了搜索引擎的核心API&lt;/li>
&lt;/ul>
&lt;h2 id="12倒排索引">
&lt;a href="#12%e5%80%92%e6%8e%92%e7%b4%a2%e5%bc%95" class="header-anchor">#&lt;/a>
1.2.倒排索引
&lt;/h2>&lt;p>倒排索引的概念是基于MySQL这样的正向索引而言的。&lt;/p>
&lt;h3 id="121正向索引">
&lt;a href="#121%e6%ad%a3%e5%90%91%e7%b4%a2%e5%bc%95" class="header-anchor">#&lt;/a>
1.2.1.正向索引
&lt;/h3>&lt;p>那么什么是正向索引呢？例如给下表（tb_goods）中的id创建索引：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-b88d07da2465bf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720195531539"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如果是根据id查询，那么直接走索引，查询速度非常快。&lt;/p>
&lt;p>但如果是基于title做模糊查询，只能是逐行扫描数据，流程如下：&lt;/p>
&lt;p>1）用户搜索数据，条件是title符合&lt;code>&amp;quot;%手机%&amp;quot;&lt;/code>&lt;/p>
&lt;p>2）逐行获取数据，比如id为1的数据&lt;/p>
&lt;p>3）判断数据中的title是否符合用户搜索条件&lt;/p>
&lt;p>4）如果符合则放入结果集，不符合则丢弃。回到步骤1&lt;/p>
&lt;p>逐行扫描，也就是全表扫描，随着数据量增加，其查询效率也会越来越低。当数据量达到数百万时，就是一场灾难。&lt;/p>
&lt;h3 id="122倒排索引">
&lt;a href="#122%e5%80%92%e6%8e%92%e7%b4%a2%e5%bc%95" class="header-anchor">#&lt;/a>
1.2.2.倒排索引
&lt;/h3>&lt;p>倒排索引中有两个非常重要的概念：&lt;/p>
&lt;ul>
&lt;li>文档（&lt;code>Document&lt;/code>）：用来搜索的数据，其中的每一条数据就是一个文档。例如一个网页、一个商品信息&lt;/li>
&lt;li>词条（&lt;code>Term&lt;/code>）：对文档数据或用户搜索数据，利用某种算法分词，得到的具备含义的词语就是词条。例如：我是中国人，就可以分为：我、是、中国人、中国、国人这样的几个词条&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>创建倒排索引&lt;/strong>是对正向索引的一种特殊处理，流程如下：&lt;/p>
&lt;ul>
&lt;li>将每一个文档的数据利用算法分词，得到一个个词条&lt;/li>
&lt;li>创建表，每行数据包括词条、词条所在文档id、位置等信息&lt;/li>
&lt;li>因为词条唯一性，可以给词条创建索引，例如hash表结构索引&lt;/li>
&lt;/ul>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-3c1e489aa1606f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720200457207"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>倒排索引的&lt;strong>搜索流程&lt;/strong>如下（以搜索&amp;quot;华为手机&amp;quot;为例）：&lt;/p>
&lt;p>1）用户输入条件&lt;code>&amp;quot;华为手机&amp;quot;&lt;/code>进行搜索。&lt;/p>
&lt;p>2）对用户输入内容&lt;strong>分词&lt;/strong>，得到词条：&lt;code>华为&lt;/code>、&lt;code>手机&lt;/code>。&lt;/p>
&lt;p>3）拿着词条在倒排索引中查找，可以得到包含词条的文档id：1、2、3。&lt;/p>
&lt;p>4）拿着文档id到正向索引中查找具体文档。&lt;/p>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-93f990a34e7a88.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720201115192"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>虽然要先查询倒排索引，再查询倒排索引，但是无论是词条、还是文档id都建立了索引，查询速度非常快！无需全表扫描。&lt;/p>
&lt;h3 id="123正向和倒排">
&lt;a href="#123%e6%ad%a3%e5%90%91%e5%92%8c%e5%80%92%e6%8e%92" class="header-anchor">#&lt;/a>
1.2.3.正向和倒排
&lt;/h3>&lt;p>那么为什么一个叫做正向索引，一个叫做倒排索引呢？&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>正向索引&lt;/strong>是最传统的，根据id索引的方式。但根据词条查询时，必须先逐条获取每个文档，然后判断文档中是否包含所需要的词条，是&lt;strong>根据文档找词条的过程&lt;/strong>。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>而&lt;strong>倒排索引&lt;/strong>则相反，是先找到用户要搜索的词条，根据词条得到保护词条的文档的id，然后根据id获取文档。是&lt;strong>根据词条找文档的过程&lt;/strong>。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>是不是恰好反过来了？&lt;/p>
&lt;p>那么两者方式的优缺点是什么呢？&lt;/p>
&lt;p>&lt;strong>正向索引&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>优点：
&lt;ul>
&lt;li>可以给多个字段创建索引&lt;/li>
&lt;li>根据索引字段搜索、排序速度非常快&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>缺点：
&lt;ul>
&lt;li>根据非索引字段，或者索引字段中的部分词条查找时，只能全表扫描。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>倒排索引&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>优点：
&lt;ul>
&lt;li>根据词条搜索、模糊搜索时，速度非常快&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>缺点：
&lt;ul>
&lt;li>只能给词条创建索引，而不是字段&lt;/li>
&lt;li>无法根据字段做排序&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="13es的一些概念">
&lt;a href="#13es%e7%9a%84%e4%b8%80%e4%ba%9b%e6%a6%82%e5%bf%b5" class="header-anchor">#&lt;/a>
1.3.es的一些概念
&lt;/h2>&lt;p>elasticsearch中有很多独有的概念，与mysql中略有差别，但也有相似之处。&lt;/p>
&lt;h3 id="131文档和字段">
&lt;a href="#131%e6%96%87%e6%a1%a3%e5%92%8c%e5%ad%97%e6%ae%b5" class="header-anchor">#&lt;/a>
1.3.1.文档和字段
&lt;/h3>&lt;p>elasticsearch是面向**文档（Document）**存储的，可以是数据库中的一条商品数据，一个订单信息。文档数据会被序列化为json格式后存储在elasticsearch中：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-26ba1bb0fd4067.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720202707797"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>而Json文档中往往包含很多的&lt;strong>字段（Field）&lt;/strong>，类似于数据库中的列。&lt;/p>
&lt;h3 id="132索引和映射">
&lt;a href="#132%e7%b4%a2%e5%bc%95%e5%92%8c%e6%98%a0%e5%b0%84" class="header-anchor">#&lt;/a>
1.3.2.索引和映射
&lt;/h3>&lt;p>&lt;strong>索引（Index）&lt;/strong>，就是相同类型的文档的集合。&lt;/p>
&lt;p>例如：&lt;/p>
&lt;ul>
&lt;li>所有用户文档，就可以组织在一起，称为用户的索引；&lt;/li>
&lt;li>所有商品的文档，可以组织在一起，称为商品的索引；&lt;/li>
&lt;li>所有订单的文档，可以组织在一起，称为订单的索引；&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-80a0258abea73c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720203022172"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>因此，我们可以把索引当做是数据库中的表。&lt;/p>
&lt;p>数据库的表会有约束信息，用来定义表的结构、字段的名称、类型等信息。因此，索引库中就有&lt;strong>映射（mapping）&lt;/strong>，是索引中文档的字段约束信息，类似表的结构约束。&lt;/p>
&lt;h3 id="133mysql与elasticsearch">
&lt;a href="#133mysql%e4%b8%8eelasticsearch" class="header-anchor">#&lt;/a>
1.3.3.mysql与elasticsearch
&lt;/h3>&lt;p>我们统一的把mysql与elasticsearch的概念做一下对比：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>MySQL&lt;/strong>&lt;/th>
&lt;th>&lt;strong>Elasticsearch&lt;/strong>&lt;/th>
&lt;th>&lt;strong>说明&lt;/strong>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Table&lt;/td>
&lt;td>Index&lt;/td>
&lt;td>索引(index)，就是文档的集合，类似数据库的表(table)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Row&lt;/td>
&lt;td>Document&lt;/td>
&lt;td>文档（Document），就是一条条的数据，类似数据库中的行（Row），文档都是JSON格式&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Column&lt;/td>
&lt;td>Field&lt;/td>
&lt;td>字段（Field），就是JSON文档中的字段，类似数据库中的列（Column）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Schema&lt;/td>
&lt;td>Mapping&lt;/td>
&lt;td>Mapping（映射）是索引中文档的约束，例如字段类型约束。类似数据库的表结构（Schema）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SQL&lt;/td>
&lt;td>DSL&lt;/td>
&lt;td>DSL是elasticsearch提供的JSON风格的请求语句，用来操作elasticsearch，实现CRUD&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>是不是说，我们学习了elasticsearch就不再需要mysql了呢？&lt;/p>
&lt;p>并不是如此，两者各自有自己的擅长支出：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Mysql：擅长事务类型操作，可以确保数据的安全和一致性&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Elasticsearch：擅长海量数据的搜索、分析、计算&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>因此在企业中，往往是两者结合使用：&lt;/p>
&lt;ul>
&lt;li>对安全性要求较高的写操作，使用mysql实现&lt;/li>
&lt;li>对查询性能要求较高的搜索需求，使用elasticsearch实现&lt;/li>
&lt;li>两者再基于某种方式，实现数据的同步，保证一致性&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-d70f75fb936135.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720203534945"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="14安装eskibana">
&lt;a href="#14%e5%ae%89%e8%a3%85eskibana" class="header-anchor">#&lt;/a>
1.4.安装es、kibana
&lt;/h2>&lt;h3 id="141安装">
&lt;a href="#141%e5%ae%89%e8%a3%85" class="header-anchor">#&lt;/a>
1.4.1.安装
&lt;/h3>&lt;p>参考课前资料：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-201d2d9e22a729.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720203805350"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="142分词器">
&lt;a href="#142%e5%88%86%e8%af%8d%e5%99%a8" class="header-anchor">#&lt;/a>
1.4.2.分词器
&lt;/h3>&lt;p>参考课前资料：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-201d2d9e22a729.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720203805350"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="143总结">
&lt;a href="#143%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
1.4.3.总结
&lt;/h3>&lt;p>分词器的作用是什么？&lt;/p>
&lt;ul>
&lt;li>创建倒排索引时对文档分词&lt;/li>
&lt;li>用户搜索时，对输入的内容分词&lt;/li>
&lt;/ul>
&lt;p>IK分词器有几种模式？&lt;/p>
&lt;ul>
&lt;li>ik_smart：智能切分，粗粒度&lt;/li>
&lt;li>ik_max_word：最细切分，细粒度&lt;/li>
&lt;/ul>
&lt;p>IK分词器如何拓展词条？如何停用词条？&lt;/p>
&lt;ul>
&lt;li>利用config目录的IkAnalyzer.cfg.xml文件添加拓展词典和停用词典&lt;/li>
&lt;li>在词典中添加拓展词条或者停用词条&lt;/li>
&lt;/ul>
&lt;h1 id="2索引库操作">
&lt;a href="#2%e7%b4%a2%e5%bc%95%e5%ba%93%e6%93%8d%e4%bd%9c" class="header-anchor">#&lt;/a>
2.索引库操作
&lt;/h1>&lt;p>索引库就类似数据库表，mapping映射就类似表的结构。&lt;/p>
&lt;p>我们要向es中存储数据，必须先创建“库”和“表”。&lt;/p>
&lt;h2 id="21mapping映射属性">
&lt;a href="#21mapping%e6%98%a0%e5%b0%84%e5%b1%9e%e6%80%a7" class="header-anchor">#&lt;/a>
2.1.mapping映射属性
&lt;/h2>&lt;p>mapping是对索引库中文档的约束，常见的mapping属性包括：&lt;/p>
&lt;ul>
&lt;li>type：字段数据类型，常见的简单类型有：
&lt;ul>
&lt;li>字符串：text（可分词的文本）、keyword（精确值，例如：品牌、国家、ip地址）&lt;/li>
&lt;li>数值：long、integer、short、byte、double、float、&lt;/li>
&lt;li>布尔：boolean&lt;/li>
&lt;li>日期：date&lt;/li>
&lt;li>对象：object&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>index：是否创建索引，默认为true&lt;/li>
&lt;li>analyzer：使用哪种分词器&lt;/li>
&lt;li>properties：该字段的子字段&lt;/li>
&lt;/ul>
&lt;p>例如下面的json文档：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-6">&lt;a class="lnlinks" href="#hl-0-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-7">&lt;a class="lnlinks" href="#hl-0-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-8">&lt;a class="lnlinks" href="#hl-0-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-9">&lt;a class="lnlinks" href="#hl-0-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-10">&lt;a class="lnlinks" href="#hl-0-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-11">&lt;a class="lnlinks" href="#hl-0-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-12">&lt;a class="lnlinks" href="#hl-0-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">21&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;weight&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mf">52.1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;isMarried&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;info&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;黑马程序员Java讲师&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;email&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;zy@itcast.cn&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;score&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mf">99.1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">99.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">98.9&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;firstName&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;云&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;lastName&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;赵&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>对应的每个字段映射（mapping）：&lt;/p>
&lt;ul>
&lt;li>age：类型为 integer；参与搜索，因此需要index为true；无需分词器&lt;/li>
&lt;li>weight：类型为float；参与搜索，因此需要index为true；无需分词器&lt;/li>
&lt;li>isMarried：类型为boolean；参与搜索，因此需要index为true；无需分词器&lt;/li>
&lt;li>info：类型为字符串，需要分词，因此是text；参与搜索，因此需要index为true；分词器可以用ik_smart&lt;/li>
&lt;li>email：类型为字符串，但是不需要分词，因此是keyword；不参与搜索，因此需要index为false；无需分词器&lt;/li>
&lt;li>score：虽然是数组，但是我们只看元素的类型，类型为float；参与搜索，因此需要index为true；无需分词器&lt;/li>
&lt;li>name：类型为object，需要定义多个子属性
&lt;ul>
&lt;li>name.firstName；类型为字符串，但是不需要分词，因此是keyword；参与搜索，因此需要index为true；无需分词器&lt;/li>
&lt;li>name.lastName；类型为字符串，但是不需要分词，因此是keyword；参与搜索，因此需要index为true；无需分词器&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="22索引库的crud">
&lt;a href="#22%e7%b4%a2%e5%bc%95%e5%ba%93%e7%9a%84crud" class="header-anchor">#&lt;/a>
2.2.索引库的CRUD
&lt;/h2>&lt;p>这里我们统一使用Kibana编写DSL的方式来演示。&lt;/p>
&lt;h3 id="221创建索引库和映射">
&lt;a href="#221%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95%e5%ba%93%e5%92%8c%e6%98%a0%e5%b0%84" class="header-anchor">#&lt;/a>
2.2.1.创建索引库和映射
&lt;/h3>&lt;h4 id="基本语法">
&lt;a href="#%e5%9f%ba%e6%9c%ac%e8%af%ad%e6%b3%95" class="header-anchor">#&lt;/a>
基本语法：
&lt;/h4>&lt;ul>
&lt;li>请求方式：PUT&lt;/li>
&lt;li>请求路径：/索引库名，可以自定义&lt;/li>
&lt;li>请求参数：mapping映射&lt;/li>
&lt;/ul>
&lt;p>格式：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-9">&lt;a class="lnlinks" href="#hl-1-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-10">&lt;a class="lnlinks" href="#hl-1-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-11">&lt;a class="lnlinks" href="#hl-1-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-12">&lt;a class="lnlinks" href="#hl-1-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-13">&lt;a class="lnlinks" href="#hl-1-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-14">&lt;a class="lnlinks" href="#hl-1-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-15">&lt;a class="lnlinks" href="#hl-1-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-16">&lt;a class="lnlinks" href="#hl-1-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-17">&lt;a class="lnlinks" href="#hl-1-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-18">&lt;a class="lnlinks" href="#hl-1-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-19">&lt;a class="lnlinks" href="#hl-1-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-20">&lt;a class="lnlinks" href="#hl-1-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-21">&lt;a class="lnlinks" href="#hl-1-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-22">&lt;a class="lnlinks" href="#hl-1-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-23">&lt;a class="lnlinks" href="#hl-1-23">23&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">PUT&lt;/span> &lt;span class="err">/索引库名称&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;mappings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;properties&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;字段名&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_smart&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;字段名2&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;index&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;false&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;字段名3&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;properties&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;子字段&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">            &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...略
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="示例">
&lt;a href="#%e7%a4%ba%e4%be%8b" class="header-anchor">#&lt;/a>
示例：
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-9">&lt;a class="lnlinks" href="#hl-2-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-10">&lt;a class="lnlinks" href="#hl-2-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-11">&lt;a class="lnlinks" href="#hl-2-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-12">&lt;a class="lnlinks" href="#hl-2-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-13">&lt;a class="lnlinks" href="#hl-2-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-14">&lt;a class="lnlinks" href="#hl-2-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-15">&lt;a class="lnlinks" href="#hl-2-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-16">&lt;a class="lnlinks" href="#hl-2-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-17">&lt;a class="lnlinks" href="#hl-2-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-18">&lt;a class="lnlinks" href="#hl-2-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-19">&lt;a class="lnlinks" href="#hl-2-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-20">&lt;a class="lnlinks" href="#hl-2-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-21">&lt;a class="lnlinks" href="#hl-2-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-22">&lt;a class="lnlinks" href="#hl-2-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-23">&lt;a class="lnlinks" href="#hl-2-23">23&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">PUT /heima
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="s2">&amp;#34;mappings&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="s2">&amp;#34;properties&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="s2">&amp;#34;type&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;text&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="s2">&amp;#34;analyzer&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;ik_smart&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="s2">&amp;#34;email&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="s2">&amp;#34;type&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="s2">&amp;#34;index&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;falsae&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="s2">&amp;#34;properties&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="s2">&amp;#34;firstName&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">            &lt;span class="s2">&amp;#34;type&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ... 略
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="222查询索引库">
&lt;a href="#222%e6%9f%a5%e8%af%a2%e7%b4%a2%e5%bc%95%e5%ba%93" class="header-anchor">#&lt;/a>
2.2.2.查询索引库
&lt;/h3>&lt;p>&lt;strong>基本语法&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>请求方式：GET&lt;/p>
&lt;/li>
&lt;li>
&lt;p>请求路径：/索引库名&lt;/p>
&lt;/li>
&lt;li>
&lt;p>请求参数：无&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>格式&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">GET /索引库名
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>示例&lt;/strong>：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-52dc1da626dfda.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720211019329"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="223修改索引库">
&lt;a href="#223%e4%bf%ae%e6%94%b9%e7%b4%a2%e5%bc%95%e5%ba%93" class="header-anchor">#&lt;/a>
2.2.3.修改索引库
&lt;/h3>&lt;p>倒排索引结构虽然不复杂，但是一旦数据结构改变（比如改变了分词器），就需要重新创建倒排索引，这简直是灾难。因此索引库&lt;strong>一旦创建，无法修改mapping&lt;/strong>。&lt;/p>
&lt;p>虽然无法修改mapping中已有的字段，但是却允许添加新的字段到mapping中，因为不会对倒排索引产生影响。&lt;/p>
&lt;p>&lt;strong>语法说明&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-5">&lt;a class="lnlinks" href="#hl-4-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-6">&lt;a class="lnlinks" href="#hl-4-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-7">&lt;a class="lnlinks" href="#hl-4-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-8">&lt;a class="lnlinks" href="#hl-4-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">PUT&lt;/span> &lt;span class="err">/索引库名/_mapping&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;properties&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;新字段名&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;integer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>示例&lt;/strong>：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-4b22c509ddbc9f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720212357390"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="224删除索引库">
&lt;a href="#224%e5%88%a0%e9%99%a4%e7%b4%a2%e5%bc%95%e5%ba%93" class="header-anchor">#&lt;/a>
2.2.4.删除索引库
&lt;/h3>&lt;p>&lt;strong>语法：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>请求方式：DELETE&lt;/p>
&lt;/li>
&lt;li>
&lt;p>请求路径：/索引库名&lt;/p>
&lt;/li>
&lt;li>
&lt;p>请求参数：无&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>格式：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">DELETE /索引库名
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在kibana中测试：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-c9069f41640f8e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720212123420"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="225总结">
&lt;a href="#225%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
2.2.5.总结
&lt;/h3>&lt;p>索引库操作有哪些？&lt;/p>
&lt;ul>
&lt;li>创建索引库：PUT /索引库名&lt;/li>
&lt;li>查询索引库：GET /索引库名&lt;/li>
&lt;li>删除索引库：DELETE /索引库名&lt;/li>
&lt;li>添加字段：PUT /索引库名/_mapping&lt;/li>
&lt;/ul>
&lt;h1 id="3文档操作">
&lt;a href="#3%e6%96%87%e6%a1%a3%e6%93%8d%e4%bd%9c" class="header-anchor">#&lt;/a>
3.文档操作
&lt;/h1>&lt;h2 id="31新增文档">
&lt;a href="#31%e6%96%b0%e5%a2%9e%e6%96%87%e6%a1%a3" class="header-anchor">#&lt;/a>
3.1.新增文档
&lt;/h2>&lt;p>&lt;strong>语法：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-5">&lt;a class="lnlinks" href="#hl-6-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-6">&lt;a class="lnlinks" href="#hl-6-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-7">&lt;a class="lnlinks" href="#hl-6-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-8">&lt;a class="lnlinks" href="#hl-6-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-9">&lt;a class="lnlinks" href="#hl-6-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-10">&lt;a class="lnlinks" href="#hl-6-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">/索引库名/_doc/文档id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;字段1&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;值1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;字段2&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;值2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;字段3&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;子属性1&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;值3&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;子属性2&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;值4&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>示例：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-8">&lt;a class="lnlinks" href="#hl-7-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-9">&lt;a class="lnlinks" href="#hl-7-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">/heima/_doc/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;info&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;黑马程序员Java讲师&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;email&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;zy@itcast.cn&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;firstName&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;云&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;lastName&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;赵&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>响应：&lt;/strong>&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-98a873ad26ff1a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720212933362"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="32查询文档">
&lt;a href="#32%e6%9f%a5%e8%af%a2%e6%96%87%e6%a1%a3" class="header-anchor">#&lt;/a>
3.2.查询文档
&lt;/h2>&lt;p>根据rest风格，新增是post，查询应该是get，不过查询一般都需要条件，这里我们把文档id带上。&lt;/p>
&lt;p>&lt;strong>语法：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="err">索引库名称&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">/_doc/&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="err">id&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>通过kibana查看数据：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">GET&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nx">heima&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">_doc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>查看结果：&lt;/strong>&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-68447266336795.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720213345003"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="33删除文档">
&lt;a href="#33%e5%88%a0%e9%99%a4%e6%96%87%e6%a1%a3" class="header-anchor">#&lt;/a>
3.3.删除文档
&lt;/h2>&lt;p>删除使用DELETE请求，同样，需要根据id进行删除：&lt;/p>
&lt;p>&lt;strong>语法：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">DELETE&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">索引库名&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">_doc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">id值&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>示例：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">#&lt;/span> &lt;span class="err">根据id删除数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">DELETE&lt;/span> &lt;span class="err">/heima/_doc/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>结果：&lt;/strong>&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-481a1124412174.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720213634918"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="34修改文档">
&lt;a href="#34%e4%bf%ae%e6%94%b9%e6%96%87%e6%a1%a3" class="header-anchor">#&lt;/a>
3.4.修改文档
&lt;/h2>&lt;p>修改有两种方式：&lt;/p>
&lt;ul>
&lt;li>全量修改：直接覆盖原来的文档&lt;/li>
&lt;li>增量修改：修改文档中的部分字段&lt;/li>
&lt;/ul>
&lt;h3 id="341全量修改">
&lt;a href="#341%e5%85%a8%e9%87%8f%e4%bf%ae%e6%94%b9" class="header-anchor">#&lt;/a>
3.4.1.全量修改
&lt;/h3>&lt;p>全量修改是覆盖原来的文档，其本质是：&lt;/p>
&lt;ul>
&lt;li>根据指定的id删除文档&lt;/li>
&lt;li>新增一个相同id的文档&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>注意&lt;/strong>：如果根据id删除时，id不存在，第二步的新增也会执行，也就从修改变成了新增操作了。&lt;/p>
&lt;p>&lt;strong>语法：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-6">&lt;a class="lnlinks" href="#hl-12-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">PUT&lt;/span> &lt;span class="err">/&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="err">索引库名&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">/_doc/文档id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;字段1&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;值1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;字段2&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;值2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ... 略
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>示例：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-6">&lt;a class="lnlinks" href="#hl-13-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-7">&lt;a class="lnlinks" href="#hl-13-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-8">&lt;a class="lnlinks" href="#hl-13-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-9">&lt;a class="lnlinks" href="#hl-13-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">PUT&lt;/span> &lt;span class="err">/heima/_doc/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;info&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;黑马程序员高级Java讲师&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;email&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;zy@itcast.cn&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;firstName&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;云&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;lastName&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;赵&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="342增量修改">
&lt;a href="#342%e5%a2%9e%e9%87%8f%e4%bf%ae%e6%94%b9" class="header-anchor">#&lt;/a>
3.4.2.增量修改
&lt;/h3>&lt;p>增量修改是只修改指定id匹配的文档中的部分字段。&lt;/p>
&lt;p>&lt;strong>语法：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-5">&lt;a class="lnlinks" href="#hl-14-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-6">&lt;a class="lnlinks" href="#hl-14-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">/&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="err">索引库名&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">/_update/文档id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;doc&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;字段名&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;新的值&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>示例：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-6">&lt;a class="lnlinks" href="#hl-15-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">/heima/_update/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;doc&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;email&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ZhaoYun@itcast.cn&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="35总结">
&lt;a href="#35%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
3.5.总结
&lt;/h2>&lt;p>文档操作有哪些？&lt;/p>
&lt;ul>
&lt;li>创建文档：POST /{索引库名}/_doc/文档id { json文档 }&lt;/li>
&lt;li>查询文档：GET /{索引库名}/_doc/文档id&lt;/li>
&lt;li>删除文档：DELETE /{索引库名}/_doc/文档id&lt;/li>
&lt;li>修改文档：
&lt;ul>
&lt;li>全量修改：PUT /{索引库名}/_doc/文档id { json文档 }&lt;/li>
&lt;li>增量修改：POST /{索引库名}/_update/文档id { &amp;ldquo;doc&amp;rdquo;: {字段}}&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h1 id="4restapi">
&lt;a href="#4restapi" class="header-anchor">#&lt;/a>
4.RestAPI
&lt;/h1>&lt;p>ES官方提供了各种不同语言的客户端，用来操作ES。这些客户端的本质就是组装DSL语句，通过http请求发送给ES。官方文档地址：https://www.elastic.co/guide/en/elasticsearch/client/index.html&lt;/p>
&lt;p>其中的Java Rest Client又包括两种：&lt;/p>
&lt;ul>
&lt;li>Java Low Level Rest Client&lt;/li>
&lt;li>Java High Level Rest Client&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-22d01571cc87e7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720214555863"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们学习的是Java HighLevel Rest Client客户端API&lt;/p>
&lt;h2 id="40导入demo工程">
&lt;a href="#40%e5%af%bc%e5%85%a5demo%e5%b7%a5%e7%a8%8b" class="header-anchor">#&lt;/a>
4.0.导入Demo工程
&lt;/h2>&lt;h3 id="401导入数据">
&lt;a href="#401%e5%af%bc%e5%85%a5%e6%95%b0%e6%8d%ae" class="header-anchor">#&lt;/a>
4.0.1.导入数据
&lt;/h3>&lt;p>首先导入课前资料提供的数据库数据：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-1c28808ad245e3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720220400297"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>数据结构如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-7">&lt;a class="lnlinks" href="#hl-16-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-8">&lt;a class="lnlinks" href="#hl-16-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-9">&lt;a class="lnlinks" href="#hl-16-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-10">&lt;a class="lnlinks" href="#hl-16-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-11">&lt;a class="lnlinks" href="#hl-16-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-12">&lt;a class="lnlinks" href="#hl-16-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-13">&lt;a class="lnlinks" href="#hl-16-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-14">&lt;a class="lnlinks" href="#hl-16-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-15">&lt;a class="lnlinks" href="#hl-16-15">15&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tb_hotel&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;酒店id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;酒店名称；例：7天酒店&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">address&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;酒店地址；例：航头路&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;酒店价格；例：329&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">score&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;酒店评分；例：45，就是4.5分&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">brand&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;酒店品牌；例：如家&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">city&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;所在城市；例：上海&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">star_name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;酒店星级，从低到高分别是：1星到5星，1钻到5钻&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">business&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;商圈；例：虹桥&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">latitude&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;纬度；例：31.2497&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">longitude&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;经度；例：120.3925&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">pic&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;酒店图片；例:/img/1.jpg&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8mb4&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="402导入项目">
&lt;a href="#402%e5%af%bc%e5%85%a5%e9%a1%b9%e7%9b%ae" class="header-anchor">#&lt;/a>
4.0.2.导入项目
&lt;/h3>&lt;p>然后导入课前资料提供的项目:&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-ee3d4c41fd4095.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720220503411"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>项目结构如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-e71f9b6375410b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720220647541"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="403mapping映射分析">
&lt;a href="#403mapping%e6%98%a0%e5%b0%84%e5%88%86%e6%9e%90" class="header-anchor">#&lt;/a>
4.0.3.mapping映射分析
&lt;/h3>&lt;p>创建索引库，最关键的是mapping映射，而mapping映射要考虑的信息包括：&lt;/p>
&lt;ul>
&lt;li>字段名&lt;/li>
&lt;li>字段数据类型&lt;/li>
&lt;li>是否参与搜索&lt;/li>
&lt;li>是否需要分词&lt;/li>
&lt;li>如果分词，分词器是什么？&lt;/li>
&lt;/ul>
&lt;p>其中：&lt;/p>
&lt;ul>
&lt;li>字段名、字段数据类型，可以参考数据表结构的名称和类型&lt;/li>
&lt;li>是否参与搜索要分析业务来判断，例如图片地址，就无需参与搜索&lt;/li>
&lt;li>是否分词呢要看内容，内容如果是一个整体就无需分词，反之则要分词&lt;/li>
&lt;li>分词器，我们可以统一使用ik_max_word&lt;/li>
&lt;/ul>
&lt;p>来看下酒店数据的索引库结构:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-4">&lt;a class="lnlinks" href="#hl-17-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-5">&lt;a class="lnlinks" href="#hl-17-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-6">&lt;a class="lnlinks" href="#hl-17-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-7">&lt;a class="lnlinks" href="#hl-17-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-8">&lt;a class="lnlinks" href="#hl-17-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-9">&lt;a class="lnlinks" href="#hl-17-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-10">&lt;a class="lnlinks" href="#hl-17-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-11">&lt;a class="lnlinks" href="#hl-17-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-12">&lt;a class="lnlinks" href="#hl-17-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-13">&lt;a class="lnlinks" href="#hl-17-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-14">&lt;a class="lnlinks" href="#hl-17-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-15">&lt;a class="lnlinks" href="#hl-17-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-16">&lt;a class="lnlinks" href="#hl-17-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-17">&lt;a class="lnlinks" href="#hl-17-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-18">&lt;a class="lnlinks" href="#hl-17-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-19">&lt;a class="lnlinks" href="#hl-17-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-20">&lt;a class="lnlinks" href="#hl-17-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-21">&lt;a class="lnlinks" href="#hl-17-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-22">&lt;a class="lnlinks" href="#hl-17-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-23">&lt;a class="lnlinks" href="#hl-17-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-24">&lt;a class="lnlinks" href="#hl-17-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-25">&lt;a class="lnlinks" href="#hl-17-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-26">&lt;a class="lnlinks" href="#hl-17-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-27">&lt;a class="lnlinks" href="#hl-17-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-28">&lt;a class="lnlinks" href="#hl-17-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-29">&lt;a class="lnlinks" href="#hl-17-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-30">&lt;a class="lnlinks" href="#hl-17-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-31">&lt;a class="lnlinks" href="#hl-17-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-32">&lt;a class="lnlinks" href="#hl-17-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-33">&lt;a class="lnlinks" href="#hl-17-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-34">&lt;a class="lnlinks" href="#hl-17-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-35">&lt;a class="lnlinks" href="#hl-17-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-36">&lt;a class="lnlinks" href="#hl-17-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-37">&lt;a class="lnlinks" href="#hl-17-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-38">&lt;a class="lnlinks" href="#hl-17-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-39">&lt;a class="lnlinks" href="#hl-17-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-40">&lt;a class="lnlinks" href="#hl-17-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-41">&lt;a class="lnlinks" href="#hl-17-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-42">&lt;a class="lnlinks" href="#hl-17-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-43">&lt;a class="lnlinks" href="#hl-17-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-44">&lt;a class="lnlinks" href="#hl-17-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-45">&lt;a class="lnlinks" href="#hl-17-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-46">&lt;a class="lnlinks" href="#hl-17-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-47">&lt;a class="lnlinks" href="#hl-17-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-48">&lt;a class="lnlinks" href="#hl-17-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-49">&lt;a class="lnlinks" href="#hl-17-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-50">&lt;a class="lnlinks" href="#hl-17-50">50&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">PUT&lt;/span> &lt;span class="err">/hotel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;mappings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;properties&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_max_word&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;copy_to&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;all&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;address&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;index&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;price&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;integer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;score&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;integer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;brand&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;copy_to&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;all&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;city&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;copy_to&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;all&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;starName&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;business&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;location&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;geo_point&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;pic&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;index&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;all&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_max_word&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>几个特殊字段说明：&lt;/p>
&lt;ul>
&lt;li>location：地理坐标，里面包含精度、纬度&lt;/li>
&lt;li>all：一个组合字段，其目的是将多字段的值 利用copy_to合并，提供给用户搜索&lt;/li>
&lt;/ul>
&lt;p>地理坐标说明：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-c85f376e003853.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720222110126"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>copy_to说明：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-4af0dedd42e28a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720222221516"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="404初始化restclient">
&lt;a href="#404%e5%88%9d%e5%a7%8b%e5%8c%96restclient" class="header-anchor">#&lt;/a>
4.0.4.初始化RestClient
&lt;/h3>&lt;p>在elasticsearch提供的API中，与elasticsearch一切交互都封装在一个名为RestHighLevelClient的类中，必须先完成这个对象的初始化，建立与elasticsearch的连接。&lt;/p>
&lt;p>分为三步：&lt;/p>
&lt;p>1）引入es的RestHighLevelClient依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.elasticsearch.client&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>elasticsearch-rest-high-level-client&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）因为SpringBoot默认的ES版本是7.6.2，所以我们需要覆盖默认的ES版本：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;properties&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;java.version&amp;gt;&lt;/span>1.8&lt;span class="nt">&amp;lt;/java.version&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;elasticsearch.version&amp;gt;&lt;/span>7.12.1&lt;span class="nt">&amp;lt;/elasticsearch.version&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/properties&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）初始化RestHighLevelClient：&lt;/p>
&lt;p>初始化的代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">RestHighLevelClient&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RestHighLevelClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RestClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HttpHost&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://192.168.150.101:9200&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里为了单元测试方便，我们创建一个测试类HotelIndexTest，然后将初始化的代码编写在@BeforeEach方法中：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-21-1">&lt;a class="lnlinks" href="#hl-21-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-2">&lt;a class="lnlinks" href="#hl-21-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-3">&lt;a class="lnlinks" href="#hl-21-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-4">&lt;a class="lnlinks" href="#hl-21-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-5">&lt;a class="lnlinks" href="#hl-21-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-6">&lt;a class="lnlinks" href="#hl-21-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-7">&lt;a class="lnlinks" href="#hl-21-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-8">&lt;a class="lnlinks" href="#hl-21-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-9">&lt;a class="lnlinks" href="#hl-21-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-10">&lt;a class="lnlinks" href="#hl-21-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-11">&lt;a class="lnlinks" href="#hl-21-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-12">&lt;a class="lnlinks" href="#hl-21-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-13">&lt;a class="lnlinks" href="#hl-21-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-14">&lt;a class="lnlinks" href="#hl-21-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-15">&lt;a class="lnlinks" href="#hl-21-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-16">&lt;a class="lnlinks" href="#hl-21-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-17">&lt;a class="lnlinks" href="#hl-21-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-18">&lt;a class="lnlinks" href="#hl-21-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-19">&lt;a class="lnlinks" href="#hl-21-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-20">&lt;a class="lnlinks" href="#hl-21-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-21">&lt;a class="lnlinks" href="#hl-21-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-22">&lt;a class="lnlinks" href="#hl-21-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-23">&lt;a class="lnlinks" href="#hl-21-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-24">&lt;a class="lnlinks" href="#hl-21-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-25">&lt;a class="lnlinks" href="#hl-21-25">25&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.apache.http.HttpHost&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.elasticsearch.client.RestHighLevelClient&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.junit.jupiter.api.AfterEach&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.junit.jupiter.api.BeforeEach&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.junit.jupiter.api.Test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.io.IOException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">HotelIndexTest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RestHighLevelClient&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@BeforeEach&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">setUp&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">client&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RestHighLevelClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RestClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HttpHost&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://192.168.150.101:9200&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@AfterEach&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">tearDown&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="41创建索引库">
&lt;a href="#41%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95%e5%ba%93" class="header-anchor">#&lt;/a>
4.1.创建索引库
&lt;/h2>&lt;h3 id="411代码解读">
&lt;a href="#411%e4%bb%a3%e7%a0%81%e8%a7%a3%e8%af%bb" class="header-anchor">#&lt;/a>
4.1.1.代码解读
&lt;/h3>&lt;p>创建索引库的API如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-c3e1c22c3c5777.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720223049408"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>代码分为三步：&lt;/p>
&lt;ul>
&lt;li>1）创建Request对象。因为是创建索引库的操作，因此Request是CreateIndexRequest。&lt;/li>
&lt;li>2）添加请求参数，其实就是DSL的JSON参数部分。因为json字符串很长，这里是定义了静态字符串常量MAPPING_TEMPLATE，让代码看起来更加优雅。&lt;/li>
&lt;li>3）发送请求，client.indices()方法的返回值是IndicesClient类型，封装了所有与索引库操作有关的方法。&lt;/li>
&lt;/ul>
&lt;h3 id="412完整示例">
&lt;a href="#412%e5%ae%8c%e6%95%b4%e7%a4%ba%e4%be%8b" class="header-anchor">#&lt;/a>
4.1.2.完整示例
&lt;/h3>&lt;p>在hotel-demo的cn.itcast.hotel.constants包下，创建一个类，定义mapping映射的JSON字符串常量：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-22-1">&lt;a class="lnlinks" href="#hl-22-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-2">&lt;a class="lnlinks" href="#hl-22-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-3">&lt;a class="lnlinks" href="#hl-22-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-4">&lt;a class="lnlinks" href="#hl-22-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-5">&lt;a class="lnlinks" href="#hl-22-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-6">&lt;a class="lnlinks" href="#hl-22-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-7">&lt;a class="lnlinks" href="#hl-22-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-8">&lt;a class="lnlinks" href="#hl-22-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-9">&lt;a class="lnlinks" href="#hl-22-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-10">&lt;a class="lnlinks" href="#hl-22-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-11">&lt;a class="lnlinks" href="#hl-22-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-12">&lt;a class="lnlinks" href="#hl-22-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-13">&lt;a class="lnlinks" href="#hl-22-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-14">&lt;a class="lnlinks" href="#hl-22-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-15">&lt;a class="lnlinks" href="#hl-22-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-16">&lt;a class="lnlinks" href="#hl-22-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-17">&lt;a class="lnlinks" href="#hl-22-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-18">&lt;a class="lnlinks" href="#hl-22-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-19">&lt;a class="lnlinks" href="#hl-22-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-20">&lt;a class="lnlinks" href="#hl-22-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-21">&lt;a class="lnlinks" href="#hl-22-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-22">&lt;a class="lnlinks" href="#hl-22-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-23">&lt;a class="lnlinks" href="#hl-22-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-24">&lt;a class="lnlinks" href="#hl-22-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-25">&lt;a class="lnlinks" href="#hl-22-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-26">&lt;a class="lnlinks" href="#hl-22-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-27">&lt;a class="lnlinks" href="#hl-22-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-28">&lt;a class="lnlinks" href="#hl-22-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-29">&lt;a class="lnlinks" href="#hl-22-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-30">&lt;a class="lnlinks" href="#hl-22-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-31">&lt;a class="lnlinks" href="#hl-22-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-32">&lt;a class="lnlinks" href="#hl-22-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-33">&lt;a class="lnlinks" href="#hl-22-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-34">&lt;a class="lnlinks" href="#hl-22-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-35">&lt;a class="lnlinks" href="#hl-22-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-36">&lt;a class="lnlinks" href="#hl-22-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-37">&lt;a class="lnlinks" href="#hl-22-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-38">&lt;a class="lnlinks" href="#hl-22-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-39">&lt;a class="lnlinks" href="#hl-22-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-40">&lt;a class="lnlinks" href="#hl-22-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-41">&lt;a class="lnlinks" href="#hl-22-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-42">&lt;a class="lnlinks" href="#hl-22-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-43">&lt;a class="lnlinks" href="#hl-22-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-44">&lt;a class="lnlinks" href="#hl-22-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-45">&lt;a class="lnlinks" href="#hl-22-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-46">&lt;a class="lnlinks" href="#hl-22-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-47">&lt;a class="lnlinks" href="#hl-22-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-48">&lt;a class="lnlinks" href="#hl-22-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-49">&lt;a class="lnlinks" href="#hl-22-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-50">&lt;a class="lnlinks" href="#hl-22-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-51">&lt;a class="lnlinks" href="#hl-22-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-52">&lt;a class="lnlinks" href="#hl-22-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-53">&lt;a class="lnlinks" href="#hl-22-53">53&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.constants&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">HotelConstants&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MAPPING_TEMPLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;{\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;mappings\&amp;#34;: {\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;properties\&amp;#34;: {\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;id\&amp;#34;: {\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;type\&amp;#34;: \&amp;#34;keyword\&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; },\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;name\&amp;#34;:{\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;type\&amp;#34;: \&amp;#34;text\&amp;#34;,\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;analyzer\&amp;#34;: \&amp;#34;ik_max_word\&amp;#34;,\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;copy_to\&amp;#34;: \&amp;#34;all\&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; },\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;address\&amp;#34;:{\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;type\&amp;#34;: \&amp;#34;keyword\&amp;#34;,\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;index\&amp;#34;: false\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; },\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;price\&amp;#34;:{\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;type\&amp;#34;: \&amp;#34;integer\&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; },\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;score\&amp;#34;:{\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;type\&amp;#34;: \&amp;#34;integer\&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; },\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;brand\&amp;#34;:{\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;type\&amp;#34;: \&amp;#34;keyword\&amp;#34;,\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;copy_to\&amp;#34;: \&amp;#34;all\&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; },\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;city\&amp;#34;:{\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;type\&amp;#34;: \&amp;#34;keyword\&amp;#34;,\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;copy_to\&amp;#34;: \&amp;#34;all\&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; },\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;starName\&amp;#34;:{\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;type\&amp;#34;: \&amp;#34;keyword\&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; },\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;business\&amp;#34;:{\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;type\&amp;#34;: \&amp;#34;keyword\&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; },\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;location\&amp;#34;:{\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;type\&amp;#34;: \&amp;#34;geo_point\&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; },\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;pic\&amp;#34;:{\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;type\&amp;#34;: \&amp;#34;keyword\&amp;#34;,\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;index\&amp;#34;: false\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; },\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;all\&amp;#34;:{\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;type\&amp;#34;: \&amp;#34;text\&amp;#34;,\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; \&amp;#34;analyzer\&amp;#34;: \&amp;#34;ik_max_word\&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; }\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; }\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34; }\n&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;}&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在hotel-demo中的HotelIndexTest测试类中，编写单元测试，实现创建索引：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-23-1">&lt;a class="lnlinks" href="#hl-23-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-2">&lt;a class="lnlinks" href="#hl-23-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-3">&lt;a class="lnlinks" href="#hl-23-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-4">&lt;a class="lnlinks" href="#hl-23-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-5">&lt;a class="lnlinks" href="#hl-23-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-6">&lt;a class="lnlinks" href="#hl-23-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-7">&lt;a class="lnlinks" href="#hl-23-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-8">&lt;a class="lnlinks" href="#hl-23-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-9">&lt;a class="lnlinks" href="#hl-23-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">createHotelIndex&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.创建Request对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">CreateIndexRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CreateIndexRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备请求的参数：DSL语句&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">MAPPING_TEMPLATE&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">XContentType&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">JSON&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">indices&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="42删除索引库">
&lt;a href="#42%e5%88%a0%e9%99%a4%e7%b4%a2%e5%bc%95%e5%ba%93" class="header-anchor">#&lt;/a>
4.2.删除索引库
&lt;/h2>&lt;p>删除索引库的DSL语句非常简单：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-24-1">&lt;a class="lnlinks" href="#hl-24-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">DELETE&lt;/span> &lt;span class="err">/hotel&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>与创建索引库相比：&lt;/p>
&lt;ul>
&lt;li>请求方式从PUT变为DELTE&lt;/li>
&lt;li>请求路径不变&lt;/li>
&lt;li>无请求参数&lt;/li>
&lt;/ul>
&lt;p>所以代码的差异，注意体现在Request对象上。依然是三步走：&lt;/p>
&lt;ul>
&lt;li>1）创建Request对象。这次是DeleteIndexRequest对象&lt;/li>
&lt;li>2）准备参数。这里是无参&lt;/li>
&lt;li>3）发送请求。改用delete方法&lt;/li>
&lt;/ul>
&lt;p>在hotel-demo中的HotelIndexTest测试类中，编写单元测试，实现删除索引：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-25-1">&lt;a class="lnlinks" href="#hl-25-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-2">&lt;a class="lnlinks" href="#hl-25-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-3">&lt;a class="lnlinks" href="#hl-25-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-4">&lt;a class="lnlinks" href="#hl-25-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-5">&lt;a class="lnlinks" href="#hl-25-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-6">&lt;a class="lnlinks" href="#hl-25-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-7">&lt;a class="lnlinks" href="#hl-25-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testDeleteHotelIndex&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.创建Request对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">DeleteIndexRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DeleteIndexRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">indices&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="43判断索引库是否存在">
&lt;a href="#43%e5%88%a4%e6%96%ad%e7%b4%a2%e5%bc%95%e5%ba%93%e6%98%af%e5%90%a6%e5%ad%98%e5%9c%a8" class="header-anchor">#&lt;/a>
4.3.判断索引库是否存在
&lt;/h2>&lt;p>判断索引库是否存在，本质就是查询，对应的DSL是：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-26-1">&lt;a class="lnlinks" href="#hl-26-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/hotel&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>因此与删除的Java代码流程是类似的。依然是三步走：&lt;/p>
&lt;ul>
&lt;li>1）创建Request对象。这次是GetIndexRequest对象&lt;/li>
&lt;li>2）准备参数。这里是无参&lt;/li>
&lt;li>3）发送请求。改用exists方法&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-27-1">&lt;a class="lnlinks" href="#hl-27-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-2">&lt;a class="lnlinks" href="#hl-27-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-3">&lt;a class="lnlinks" href="#hl-27-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-4">&lt;a class="lnlinks" href="#hl-27-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-5">&lt;a class="lnlinks" href="#hl-27-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-6">&lt;a class="lnlinks" href="#hl-27-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-7">&lt;a class="lnlinks" href="#hl-27-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-8">&lt;a class="lnlinks" href="#hl-27-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-9">&lt;a class="lnlinks" href="#hl-27-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testExistsHotelIndex&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.创建Request对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">GetIndexRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GetIndexRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exists&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">indices&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">exists&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.输出&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exists&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;索引库已经存在！&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;索引库不存在！&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="44总结">
&lt;a href="#44%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
4.4.总结
&lt;/h2>&lt;p>JavaRestClient操作elasticsearch的流程基本类似。核心是client.indices()方法来获取索引库的操作对象。&lt;/p>
&lt;p>索引库操作的基本步骤：&lt;/p>
&lt;ul>
&lt;li>初始化RestHighLevelClient&lt;/li>
&lt;li>创建XxxIndexRequest。XXX是Create、Get、Delete&lt;/li>
&lt;li>准备DSL（ Create时需要，其它是无参）&lt;/li>
&lt;li>发送请求。调用RestHighLevelClient#indices().xxx()方法，xxx是create、exists、delete&lt;/li>
&lt;/ul>
&lt;h1 id="5restclient操作文档">
&lt;a href="#5restclient%e6%93%8d%e4%bd%9c%e6%96%87%e6%a1%a3" class="header-anchor">#&lt;/a>
5.RestClient操作文档
&lt;/h1>&lt;p>为了与索引库操作分离，我们再次参加一个测试类，做两件事情：&lt;/p>
&lt;ul>
&lt;li>初始化RestHighLevelClient&lt;/li>
&lt;li>我们的酒店数据在数据库，需要利用IHotelService去查询，所以注入这个接口&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-28-1">&lt;a class="lnlinks" href="#hl-28-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-2">&lt;a class="lnlinks" href="#hl-28-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-3">&lt;a class="lnlinks" href="#hl-28-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-4">&lt;a class="lnlinks" href="#hl-28-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-5">&lt;a class="lnlinks" href="#hl-28-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-6">&lt;a class="lnlinks" href="#hl-28-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-7">&lt;a class="lnlinks" href="#hl-28-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-8">&lt;a class="lnlinks" href="#hl-28-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-9">&lt;a class="lnlinks" href="#hl-28-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-10">&lt;a class="lnlinks" href="#hl-28-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-11">&lt;a class="lnlinks" href="#hl-28-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-12">&lt;a class="lnlinks" href="#hl-28-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-13">&lt;a class="lnlinks" href="#hl-28-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-14">&lt;a class="lnlinks" href="#hl-28-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-15">&lt;a class="lnlinks" href="#hl-28-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-16">&lt;a class="lnlinks" href="#hl-28-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-17">&lt;a class="lnlinks" href="#hl-28-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-18">&lt;a class="lnlinks" href="#hl-28-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-19">&lt;a class="lnlinks" href="#hl-28-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-20">&lt;a class="lnlinks" href="#hl-28-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-21">&lt;a class="lnlinks" href="#hl-28-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-22">&lt;a class="lnlinks" href="#hl-28-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-23">&lt;a class="lnlinks" href="#hl-28-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-24">&lt;a class="lnlinks" href="#hl-28-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-25">&lt;a class="lnlinks" href="#hl-28-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-26">&lt;a class="lnlinks" href="#hl-28-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-27">&lt;a class="lnlinks" href="#hl-28-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-28">&lt;a class="lnlinks" href="#hl-28-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-29">&lt;a class="lnlinks" href="#hl-28-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-30">&lt;a class="lnlinks" href="#hl-28-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-31">&lt;a class="lnlinks" href="#hl-28-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-32">&lt;a class="lnlinks" href="#hl-28-32">32&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.pojo.Hotel&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.service.IHotelService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.junit.jupiter.api.AfterEach&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.junit.jupiter.api.BeforeEach&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.junit.jupiter.api.Test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.factory.annotation.Autowired&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.boot.test.context.SpringBootTest&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.io.IOException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.util.List&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@SpringBootTest&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">HotelDocumentTest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IHotelService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RestHighLevelClient&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@BeforeEach&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">setUp&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">client&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RestHighLevelClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RestClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HttpHost&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://192.168.150.101:9200&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@AfterEach&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">tearDown&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="51新增文档">
&lt;a href="#51%e6%96%b0%e5%a2%9e%e6%96%87%e6%a1%a3" class="header-anchor">#&lt;/a>
5.1.新增文档
&lt;/h2>&lt;p>我们要将数据库的酒店数据查询出来，写入elasticsearch中。&lt;/p>
&lt;h3 id="511索引库实体类">
&lt;a href="#511%e7%b4%a2%e5%bc%95%e5%ba%93%e5%ae%9e%e4%bd%93%e7%b1%bb" class="header-anchor">#&lt;/a>
5.1.1.索引库实体类
&lt;/h3>&lt;p>数据库查询后的结果是一个Hotel类型的对象。结构如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-29-1">&lt;a class="lnlinks" href="#hl-29-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-2">&lt;a class="lnlinks" href="#hl-29-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-3">&lt;a class="lnlinks" href="#hl-29-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-4">&lt;a class="lnlinks" href="#hl-29-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-5">&lt;a class="lnlinks" href="#hl-29-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-6">&lt;a class="lnlinks" href="#hl-29-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-7">&lt;a class="lnlinks" href="#hl-29-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-8">&lt;a class="lnlinks" href="#hl-29-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-9">&lt;a class="lnlinks" href="#hl-29-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-10">&lt;a class="lnlinks" href="#hl-29-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-11">&lt;a class="lnlinks" href="#hl-29-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-12">&lt;a class="lnlinks" href="#hl-29-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-13">&lt;a class="lnlinks" href="#hl-29-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-14">&lt;a class="lnlinks" href="#hl-29-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-15">&lt;a class="lnlinks" href="#hl-29-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-16">&lt;a class="lnlinks" href="#hl-29-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-17">&lt;a class="lnlinks" href="#hl-29-17">17&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Data&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@TableName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tb_hotel&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">Hotel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@TableId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IdType&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">INPUT&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">address&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">score&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brand&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">city&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">starName&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">business&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">longitude&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">latitude&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pic&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>与我们的索引库结构存在差异：&lt;/p>
&lt;ul>
&lt;li>longitude和latitude需要合并为location&lt;/li>
&lt;/ul>
&lt;p>因此，我们需要定义一个新的类型，与索引库结构吻合：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-30-1">&lt;a class="lnlinks" href="#hl-30-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-2">&lt;a class="lnlinks" href="#hl-30-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-3">&lt;a class="lnlinks" href="#hl-30-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-4">&lt;a class="lnlinks" href="#hl-30-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-5">&lt;a class="lnlinks" href="#hl-30-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-6">&lt;a class="lnlinks" href="#hl-30-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-7">&lt;a class="lnlinks" href="#hl-30-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-8">&lt;a class="lnlinks" href="#hl-30-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-9">&lt;a class="lnlinks" href="#hl-30-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-10">&lt;a class="lnlinks" href="#hl-30-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-11">&lt;a class="lnlinks" href="#hl-30-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-12">&lt;a class="lnlinks" href="#hl-30-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-13">&lt;a class="lnlinks" href="#hl-30-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-14">&lt;a class="lnlinks" href="#hl-30-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-15">&lt;a class="lnlinks" href="#hl-30-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-16">&lt;a class="lnlinks" href="#hl-30-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-17">&lt;a class="lnlinks" href="#hl-30-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-18">&lt;a class="lnlinks" href="#hl-30-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-19">&lt;a class="lnlinks" href="#hl-30-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-20">&lt;a class="lnlinks" href="#hl-30-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-21">&lt;a class="lnlinks" href="#hl-30-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-22">&lt;a class="lnlinks" href="#hl-30-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-23">&lt;a class="lnlinks" href="#hl-30-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-24">&lt;a class="lnlinks" href="#hl-30-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-25">&lt;a class="lnlinks" href="#hl-30-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-26">&lt;a class="lnlinks" href="#hl-30-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-27">&lt;a class="lnlinks" href="#hl-30-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-28">&lt;a class="lnlinks" href="#hl-30-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-29">&lt;a class="lnlinks" href="#hl-30-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-30">&lt;a class="lnlinks" href="#hl-30-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-31">&lt;a class="lnlinks" href="#hl-30-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-32">&lt;a class="lnlinks" href="#hl-30-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-33">&lt;a class="lnlinks" href="#hl-30-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-34">&lt;a class="lnlinks" href="#hl-30-34">34&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.pojo&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.Data&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.NoArgsConstructor&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Data&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@NoArgsConstructor&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">HotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">address&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">score&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brand&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">city&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">starName&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">business&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">location&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pic&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">HotelDoc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Hotel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">address&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getAddress&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">price&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPrice&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">score&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getScore&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">brand&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBrand&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">city&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCity&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">starName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getStarName&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">business&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBusiness&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">location&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLatitude&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;, &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLongitude&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">pic&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPic&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="512语法说明">
&lt;a href="#512%e8%af%ad%e6%b3%95%e8%af%b4%e6%98%8e" class="header-anchor">#&lt;/a>
5.1.2.语法说明
&lt;/h3>&lt;p>新增文档的DSL语句如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-31-1">&lt;a class="lnlinks" href="#hl-31-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-2">&lt;a class="lnlinks" href="#hl-31-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-3">&lt;a class="lnlinks" href="#hl-31-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-4">&lt;a class="lnlinks" href="#hl-31-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-5">&lt;a class="lnlinks" href="#hl-31-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">/&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="err">索引库名&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">/_doc/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Jack&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">21&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>对应的java代码如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-c303ee0b147ae4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720230027240"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到与创建索引库类似，同样是三步走：&lt;/p>
&lt;ul>
&lt;li>1）创建Request对象&lt;/li>
&lt;li>2）准备请求参数，也就是DSL中的JSON文档&lt;/li>
&lt;li>3）发送请求&lt;/li>
&lt;/ul>
&lt;p>变化的地方在于，这里直接使用client.xxx()的API，不再需要client.indices()了。&lt;/p>
&lt;h3 id="513完整代码">
&lt;a href="#513%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81" class="header-anchor">#&lt;/a>
5.1.3.完整代码
&lt;/h3>&lt;p>我们导入酒店数据，基本流程一致，但是需要考虑几点变化：&lt;/p>
&lt;ul>
&lt;li>酒店数据来自于数据库，我们需要先查询出来，得到hotel对象&lt;/li>
&lt;li>hotel对象需要转为HotelDoc对象&lt;/li>
&lt;li>HotelDoc需要序列化为json格式&lt;/li>
&lt;/ul>
&lt;p>因此，代码整体步骤如下：&lt;/p>
&lt;ul>
&lt;li>1）根据id查询酒店数据Hotel&lt;/li>
&lt;li>2）将Hotel封装为HotelDoc&lt;/li>
&lt;li>3）将HotelDoc序列化为JSON&lt;/li>
&lt;li>4）创建IndexRequest，指定索引库名和id&lt;/li>
&lt;li>5）准备请求参数，也就是JSON文档&lt;/li>
&lt;li>6）发送请求&lt;/li>
&lt;/ul>
&lt;p>在hotel-demo的HotelDocumentTest测试类中，编写单元测试：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-32-1">&lt;a class="lnlinks" href="#hl-32-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-2">&lt;a class="lnlinks" href="#hl-32-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-3">&lt;a class="lnlinks" href="#hl-32-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-4">&lt;a class="lnlinks" href="#hl-32-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-5">&lt;a class="lnlinks" href="#hl-32-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-6">&lt;a class="lnlinks" href="#hl-32-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-7">&lt;a class="lnlinks" href="#hl-32-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-8">&lt;a class="lnlinks" href="#hl-32-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-9">&lt;a class="lnlinks" href="#hl-32-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-10">&lt;a class="lnlinks" href="#hl-32-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-11">&lt;a class="lnlinks" href="#hl-32-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-12">&lt;a class="lnlinks" href="#hl-32-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-13">&lt;a class="lnlinks" href="#hl-32-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-14">&lt;a class="lnlinks" href="#hl-32-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-15">&lt;a class="lnlinks" href="#hl-32-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-16">&lt;a class="lnlinks" href="#hl-32-16">16&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testAddDocument&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.根据id查询酒店数据&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Hotel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">61083L&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.转换为文档类型&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.将HotelDoc转json&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JSON&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toJSONString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">IndexRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IndexRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">id&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备Json文档&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">XContentType&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">JSON&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">index&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="52查询文档">
&lt;a href="#52%e6%9f%a5%e8%af%a2%e6%96%87%e6%a1%a3" class="header-anchor">#&lt;/a>
5.2.查询文档
&lt;/h2>&lt;h3 id="521语法说明">
&lt;a href="#521%e8%af%ad%e6%b3%95%e8%af%b4%e6%98%8e" class="header-anchor">#&lt;/a>
5.2.1.语法说明
&lt;/h3>&lt;p>查询的DSL语句如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-33-1">&lt;a class="lnlinks" href="#hl-33-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/hotel/_doc/&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="err">id&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>非常简单，因此代码大概分两步：&lt;/p>
&lt;ul>
&lt;li>准备Request对象&lt;/li>
&lt;li>发送请求&lt;/li>
&lt;/ul>
&lt;p>不过查询的目的是得到结果，解析为HotelDoc，因此难点是结果的解析。完整代码如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-7bcfee44e4cd59.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720230811674"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，结果是一个JSON，其中文档放在一个&lt;code>_source&lt;/code>属性中，因此解析就是拿到&lt;code>_source&lt;/code>，反序列化为Java对象即可。&lt;/p>
&lt;p>与之前类似，也是三步走：&lt;/p>
&lt;ul>
&lt;li>1）准备Request对象。这次是查询，所以是GetRequest&lt;/li>
&lt;li>2）发送请求，得到结果。因为是查询，这里调用client.get()方法&lt;/li>
&lt;li>3）解析结果，就是对JSON做反序列化&lt;/li>
&lt;/ul>
&lt;h3 id="522完整代码">
&lt;a href="#522%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81" class="header-anchor">#&lt;/a>
5.2.2.完整代码
&lt;/h3>&lt;p>在hotel-demo的HotelDocumentTest测试类中，编写单元测试：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-34-1">&lt;a class="lnlinks" href="#hl-34-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-2">&lt;a class="lnlinks" href="#hl-34-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-3">&lt;a class="lnlinks" href="#hl-34-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-4">&lt;a class="lnlinks" href="#hl-34-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-5">&lt;a class="lnlinks" href="#hl-34-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-6">&lt;a class="lnlinks" href="#hl-34-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-7">&lt;a class="lnlinks" href="#hl-34-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-8">&lt;a class="lnlinks" href="#hl-34-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-9">&lt;a class="lnlinks" href="#hl-34-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-10">&lt;a class="lnlinks" href="#hl-34-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-11">&lt;a class="lnlinks" href="#hl-34-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-12">&lt;a class="lnlinks" href="#hl-34-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testGetDocumentById&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">GetRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GetRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;61082&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.发送请求，得到响应&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">GetResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.解析响应结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getSourceAsString&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JSON&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">parseObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="53删除文档">
&lt;a href="#53%e5%88%a0%e9%99%a4%e6%96%87%e6%a1%a3" class="header-anchor">#&lt;/a>
5.3.删除文档
&lt;/h2>&lt;p>删除的DSL为是这样的：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-35-1">&lt;a class="lnlinks" href="#hl-35-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">DELETE&lt;/span> &lt;span class="err">/hotel/_doc/&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="err">id&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>与查询相比，仅仅是请求方式从DELETE变成GET，可以想象Java代码应该依然是三步走：&lt;/p>
&lt;ul>
&lt;li>1）准备Request对象，因为是删除，这次是DeleteRequest对象。要指定索引库名和id&lt;/li>
&lt;li>2）准备参数，无参&lt;/li>
&lt;li>3）发送请求。因为是删除，所以是client.delete()方法&lt;/li>
&lt;/ul>
&lt;p>在hotel-demo的HotelDocumentTest测试类中，编写单元测试：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-36-1">&lt;a class="lnlinks" href="#hl-36-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-2">&lt;a class="lnlinks" href="#hl-36-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-3">&lt;a class="lnlinks" href="#hl-36-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-4">&lt;a class="lnlinks" href="#hl-36-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-5">&lt;a class="lnlinks" href="#hl-36-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-6">&lt;a class="lnlinks" href="#hl-36-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-7">&lt;a class="lnlinks" href="#hl-36-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testDeleteDocument&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">DeleteRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DeleteRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;61083&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="54修改文档">
&lt;a href="#54%e4%bf%ae%e6%94%b9%e6%96%87%e6%a1%a3" class="header-anchor">#&lt;/a>
5.4.修改文档
&lt;/h2>&lt;h3 id="541语法说明">
&lt;a href="#541%e8%af%ad%e6%b3%95%e8%af%b4%e6%98%8e" class="header-anchor">#&lt;/a>
5.4.1.语法说明
&lt;/h3>&lt;p>修改我们讲过两种方式：&lt;/p>
&lt;ul>
&lt;li>全量修改：本质是先根据id删除，再新增&lt;/li>
&lt;li>增量修改：修改文档中的指定字段值&lt;/li>
&lt;/ul>
&lt;p>在RestClient的API中，全量修改与新增的API完全一致，判断依据是ID：&lt;/p>
&lt;ul>
&lt;li>如果新增时，ID已经存在，则修改&lt;/li>
&lt;li>如果新增时，ID不存在，则新增&lt;/li>
&lt;/ul>
&lt;p>这里不再赘述，我们主要关注增量修改。&lt;/p>
&lt;p>代码示例如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-d34b44ac010e33.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720231040875"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>与之前类似，也是三步走：&lt;/p>
&lt;ul>
&lt;li>1）准备Request对象。这次是修改，所以是UpdateRequest&lt;/li>
&lt;li>2）准备参数。也就是JSON文档，里面包含要修改的字段&lt;/li>
&lt;li>3）更新文档。这里调用client.update()方法&lt;/li>
&lt;/ul>
&lt;h3 id="542完整代码">
&lt;a href="#542%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81" class="header-anchor">#&lt;/a>
5.4.2.完整代码
&lt;/h3>&lt;p>在hotel-demo的HotelDocumentTest测试类中，编写单元测试：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-37-1">&lt;a class="lnlinks" href="#hl-37-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-2">&lt;a class="lnlinks" href="#hl-37-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-3">&lt;a class="lnlinks" href="#hl-37-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-4">&lt;a class="lnlinks" href="#hl-37-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-5">&lt;a class="lnlinks" href="#hl-37-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-6">&lt;a class="lnlinks" href="#hl-37-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-7">&lt;a class="lnlinks" href="#hl-37-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-8">&lt;a class="lnlinks" href="#hl-37-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-9">&lt;a class="lnlinks" href="#hl-37-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-10">&lt;a class="lnlinks" href="#hl-37-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-11">&lt;a class="lnlinks" href="#hl-37-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-37-12">&lt;a class="lnlinks" href="#hl-37-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testUpdateDocument&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">UpdateRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UpdateRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;61083&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备请求参数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">doc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;price&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;952&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;starName&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;四钻&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="55批量导入文档">
&lt;a href="#55%e6%89%b9%e9%87%8f%e5%af%bc%e5%85%a5%e6%96%87%e6%a1%a3" class="header-anchor">#&lt;/a>
5.5.批量导入文档
&lt;/h2>&lt;p>案例需求：利用BulkRequest批量将数据库数据导入到索引库中。&lt;/p>
&lt;p>步骤如下：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>利用mybatis-plus查询酒店数据&lt;/p>
&lt;/li>
&lt;li>
&lt;p>将查询到的酒店数据（Hotel）转换为文档类型数据（HotelDoc）&lt;/p>
&lt;/li>
&lt;li>
&lt;p>利用JavaRestClient中的BulkRequest批处理，实现批量新增文档&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="551语法说明">
&lt;a href="#551%e8%af%ad%e6%b3%95%e8%af%b4%e6%98%8e" class="header-anchor">#&lt;/a>
5.5.1.语法说明
&lt;/h3>&lt;p>批量处理BulkRequest，其本质就是将多个普通的CRUD请求组合在一起发送。&lt;/p>
&lt;p>其中提供了一个add方法，用来添加其他请求：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-1af8b3b513121b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720232105943"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，能添加的请求包括：&lt;/p>
&lt;ul>
&lt;li>IndexRequest，也就是新增&lt;/li>
&lt;li>UpdateRequest，也就是修改&lt;/li>
&lt;li>DeleteRequest，也就是删除&lt;/li>
&lt;/ul>
&lt;p>因此Bulk中添加了多个IndexRequest，就是批量新增功能了。示例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738151-e97eeeb0e50af9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210720232431383"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其实还是三步走：&lt;/p>
&lt;ul>
&lt;li>1）创建Request对象。这里是BulkRequest&lt;/li>
&lt;li>2）准备参数。批处理的参数，就是其它Request对象，这里就是多个IndexRequest&lt;/li>
&lt;li>3）发起请求。这里是批处理，调用的方法为client.bulk()方法&lt;/li>
&lt;/ul>
&lt;p>我们在导入酒店数据时，将上述代码改造成for循环处理即可。&lt;/p>
&lt;h3 id="552完整代码">
&lt;a href="#552%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81" class="header-anchor">#&lt;/a>
5.5.2.完整代码
&lt;/h3>&lt;p>在hotel-demo的HotelDocumentTest测试类中，编写单元测试：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-38-1">&lt;a class="lnlinks" href="#hl-38-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-2">&lt;a class="lnlinks" href="#hl-38-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-3">&lt;a class="lnlinks" href="#hl-38-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-4">&lt;a class="lnlinks" href="#hl-38-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-5">&lt;a class="lnlinks" href="#hl-38-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-6">&lt;a class="lnlinks" href="#hl-38-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-7">&lt;a class="lnlinks" href="#hl-38-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-8">&lt;a class="lnlinks" href="#hl-38-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-9">&lt;a class="lnlinks" href="#hl-38-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-10">&lt;a class="lnlinks" href="#hl-38-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-11">&lt;a class="lnlinks" href="#hl-38-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-12">&lt;a class="lnlinks" href="#hl-38-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-13">&lt;a class="lnlinks" href="#hl-38-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-14">&lt;a class="lnlinks" href="#hl-38-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-15">&lt;a class="lnlinks" href="#hl-38-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-16">&lt;a class="lnlinks" href="#hl-38-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-17">&lt;a class="lnlinks" href="#hl-38-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-18">&lt;a class="lnlinks" href="#hl-38-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-38-19">&lt;a class="lnlinks" href="#hl-38-19">19&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testBulkRequest&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 批量查询酒店数据&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Hotel&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotels&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">list&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.创建Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">BulkRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BulkRequest&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备参数，添加多个新增的Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Hotel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotels&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.1.转换为文档类型HotelDoc&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.2.创建新增文档的Request对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IndexRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">id&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">JSON&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toJSONString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">XContentType&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">JSON&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">bulk&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="56小结">
&lt;a href="#56%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
5.6.小结
&lt;/h2>&lt;p>文档操作的基本步骤：&lt;/p>
&lt;ul>
&lt;li>初始化RestHighLevelClient&lt;/li>
&lt;li>创建XxxRequest。XXX是Index、Get、Update、Delete、Bulk&lt;/li>
&lt;li>准备参数（Index、Update、Bulk时需要）&lt;/li>
&lt;li>发送请求。调用RestHighLevelClient#.xxx()方法，xxx是index、get、update、delete、bulk&lt;/li>
&lt;li>解析结果（Get时需要）&lt;/li>
&lt;/ul></description></item><item><title>6.分布式搜索引擎02</title><link>https://logan.wssw.fun/p/2023/01/13895613/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/13895613/</guid><description>&lt;h1 id="分布式搜索引擎02">
&lt;a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e6%90%9c%e7%b4%a2%e5%bc%95%e6%93%8e02" class="header-anchor">#&lt;/a>
分布式搜索引擎02
&lt;/h1>&lt;p>在昨天的学习中，我们已经导入了大量数据到elasticsearch中，实现了elasticsearch的数据存储功能。但elasticsearch最擅长的还是搜索和数据分析。&lt;/p>
&lt;p>所以今天，我们研究下elasticsearch的数据搜索功能。我们会分别使用&lt;strong>DSL&lt;/strong>和&lt;strong>RestClient&lt;/strong>实现搜索。&lt;/p>
&lt;h1 id="0学习目标">
&lt;a href="#0%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87" class="header-anchor">#&lt;/a>
0.学习目标
&lt;/h1>&lt;h1 id="1dsl查询文档">
&lt;a href="#1dsl%e6%9f%a5%e8%af%a2%e6%96%87%e6%a1%a3" class="header-anchor">#&lt;/a>
1.DSL查询文档
&lt;/h1>&lt;p>elasticsearch的查询依然是基于JSON风格的DSL来实现的。&lt;/p>
&lt;h2 id="11dsl查询分类">
&lt;a href="#11dsl%e6%9f%a5%e8%af%a2%e5%88%86%e7%b1%bb" class="header-anchor">#&lt;/a>
1.1.DSL查询分类
&lt;/h2>&lt;p>Elasticsearch提供了基于JSON的DSL（&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" target="_blank" rel="noopener"
>Domain Specific Language
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>）来定义查询。常见的查询类型包括：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>查询所有&lt;/strong>：查询出所有数据，一般测试用。例如：match_all&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>全文检索（full text）查询&lt;/strong>：利用分词器对用户输入内容分词，然后去倒排索引库中匹配。例如：&lt;/p>
&lt;ul>
&lt;li>match_query&lt;/li>
&lt;li>multi_match_query&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>精确查询&lt;/strong>：根据精确词条值查找数据，一般是查找keyword、数值、日期、boolean等类型字段。例如：&lt;/p>
&lt;ul>
&lt;li>ids&lt;/li>
&lt;li>range&lt;/li>
&lt;li>term&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>地理（geo）查询&lt;/strong>：根据经纬度查询。例如：&lt;/p>
&lt;ul>
&lt;li>geo_distance&lt;/li>
&lt;li>geo_bounding_box&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>复合（compound）查询&lt;/strong>：复合查询可以将上述各种查询条件组合起来，合并查询条件。例如：&lt;/p>
&lt;ul>
&lt;li>bool&lt;/li>
&lt;li>function_score&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>查询的语法基本一致：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-6">&lt;a class="lnlinks" href="#hl-0-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-7">&lt;a class="lnlinks" href="#hl-0-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-8">&lt;a class="lnlinks" href="#hl-0-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/indexName/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;查询类型&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;查询条件&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;条件值&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我们以查询所有为例，其中：&lt;/p>
&lt;ul>
&lt;li>查询类型为match_all&lt;/li>
&lt;li>没有查询条件&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 查询所有
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">GET&lt;/span> &lt;span class="err">/indexName/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;match_all&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其它查询无非就是&lt;strong>查询类型&lt;/strong>、&lt;strong>查询条件&lt;/strong>的变化。&lt;/p>
&lt;h2 id="12全文检索查询">
&lt;a href="#12%e5%85%a8%e6%96%87%e6%a3%80%e7%b4%a2%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
1.2.全文检索查询
&lt;/h2>&lt;h3 id="121使用场景">
&lt;a href="#121%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af" class="header-anchor">#&lt;/a>
1.2.1.使用场景
&lt;/h3>&lt;p>全文检索查询的基本流程如下：&lt;/p>
&lt;ul>
&lt;li>对用户搜索的内容做分词，得到词条&lt;/li>
&lt;li>根据词条去倒排索引库中匹配，得到文档id&lt;/li>
&lt;li>根据文档id找到文档，返回给用户&lt;/li>
&lt;/ul>
&lt;p>比较常用的场景包括：&lt;/p>
&lt;ul>
&lt;li>商城的输入框搜索&lt;/li>
&lt;li>百度输入框搜索&lt;/li>
&lt;/ul>
&lt;p>例如京东：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-952f1c93d2d459.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721165326938"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>因为是拿着词条去匹配，因此参与搜索的字段也必须是可分词的text类型的字段。&lt;/p>
&lt;h3 id="122基本语法">
&lt;a href="#122%e5%9f%ba%e6%9c%ac%e8%af%ad%e6%b3%95" class="header-anchor">#&lt;/a>
1.2.2.基本语法
&lt;/h3>&lt;p>常见的全文检索查询包括：&lt;/p>
&lt;ul>
&lt;li>match查询：单字段查询&lt;/li>
&lt;li>multi_match查询：多字段查询，任意一个字段符合条件就算符合查询条件&lt;/li>
&lt;/ul>
&lt;p>match查询语法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/indexName/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;match&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;FIELD&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;TEXT&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>mulit_match语法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-7">&lt;a class="lnlinks" href="#hl-3-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-8">&lt;a class="lnlinks" href="#hl-3-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-9">&lt;a class="lnlinks" href="#hl-3-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/indexName/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;multi_match&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;TEXT&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;fields&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;FIELD1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34; FIELD12&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="123示例">
&lt;a href="#123%e7%a4%ba%e4%be%8b" class="header-anchor">#&lt;/a>
1.2.3.示例
&lt;/h3>&lt;p>match查询示例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-622a90a1ed6de0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721170455419"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>multi_match查询示例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-46eb607e0fe601.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721170720691"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，两种查询结果是一样的，为什么？&lt;/p>
&lt;p>因为我们将brand、name、business值都利用copy_to复制到了all字段中。因此你根据三个字段搜索，和根据all字段搜索效果当然一样了。&lt;/p>
&lt;p>但是，搜索字段越多，对查询性能影响越大，因此建议采用copy_to，然后单字段查询的方式。&lt;/p>
&lt;h3 id="124总结">
&lt;a href="#124%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
1.2.4.总结
&lt;/h3>&lt;p>match和multi_match的区别是什么？&lt;/p>
&lt;ul>
&lt;li>match：根据一个字段查询&lt;/li>
&lt;li>multi_match：根据多个字段查询，参与查询字段越多，查询性能越差&lt;/li>
&lt;/ul>
&lt;h2 id="13精准查询">
&lt;a href="#13%e7%b2%be%e5%87%86%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
1.3.精准查询
&lt;/h2>&lt;p>精确查询一般是查找keyword、数值、日期、boolean等类型字段。所以&lt;strong>不会&lt;/strong>对搜索条件分词。常见的有：&lt;/p>
&lt;ul>
&lt;li>term：根据词条精确值查询&lt;/li>
&lt;li>range：根据值的范围查询&lt;/li>
&lt;/ul>
&lt;h3 id="131term查询">
&lt;a href="#131term%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
1.3.1.term查询
&lt;/h3>&lt;p>因为精确查询的字段搜是不分词的字段，因此查询的条件也必须是&lt;strong>不分词&lt;/strong>的词条。查询时，用户输入的内容跟自动值完全匹配时才认为符合条件。如果用户输入的内容过多，反而搜索不到数据。&lt;/p>
&lt;p>语法说明：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-5">&lt;a class="lnlinks" href="#hl-4-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-6">&lt;a class="lnlinks" href="#hl-4-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-7">&lt;a class="lnlinks" href="#hl-4-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-8">&lt;a class="lnlinks" href="#hl-4-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-9">&lt;a class="lnlinks" href="#hl-4-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-10">&lt;a class="lnlinks" href="#hl-4-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-11">&lt;a class="lnlinks" href="#hl-4-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// term查询
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">GET&lt;/span> &lt;span class="err">/indexName/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;term&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;FIELD&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;value&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;VALUE&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>示例：&lt;/p>
&lt;p>当我搜索的是精确词条时，能正确查询出结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-4985e07d77ce79.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721171655308"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>但是，当我搜索的内容不是词条，而是多个词语形成的短语时，反而搜索不到：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-db17c237a17c92.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721171838378"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="132range查询">
&lt;a href="#132range%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
1.3.2.range查询
&lt;/h3>&lt;p>范围查询，一般应用在对数值类型做范围过滤的时候。比如做价格范围过滤。&lt;/p>
&lt;p>基本语法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-4">&lt;a class="lnlinks" href="#hl-5-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-5">&lt;a class="lnlinks" href="#hl-5-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-6">&lt;a class="lnlinks" href="#hl-5-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-7">&lt;a class="lnlinks" href="#hl-5-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-8">&lt;a class="lnlinks" href="#hl-5-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-9">&lt;a class="lnlinks" href="#hl-5-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-10">&lt;a class="lnlinks" href="#hl-5-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-11">&lt;a class="lnlinks" href="#hl-5-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-12">&lt;a class="lnlinks" href="#hl-5-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// range查询
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">GET&lt;/span> &lt;span class="err">/indexName/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;range&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;FIELD&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;gte&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 这里的gte代表大于等于，gt则代表大于
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>        &lt;span class="nt">&amp;#34;lte&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span> &lt;span class="c1">// lte代表小于等于，lt则代表小于
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>示例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-3b9879d506df4d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721172307172"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="133总结">
&lt;a href="#133%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
1.3.3.总结
&lt;/h3>&lt;p>精确查询常见的有哪些？&lt;/p>
&lt;ul>
&lt;li>term查询：根据词条精确匹配，一般搜索keyword类型、数值类型、布尔类型、日期类型字段&lt;/li>
&lt;li>range查询：根据数值范围查询，可以是数值、日期的范围&lt;/li>
&lt;/ul>
&lt;h2 id="14地理坐标查询">
&lt;a href="#14%e5%9c%b0%e7%90%86%e5%9d%90%e6%a0%87%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
1.4.地理坐标查询
&lt;/h2>&lt;p>所谓的地理坐标查询，其实就是根据经纬度查询，官方文档：https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html&lt;/p>
&lt;p>常见的使用场景包括：&lt;/p>
&lt;ul>
&lt;li>携程：搜索我附近的酒店&lt;/li>
&lt;li>滴滴：搜索我附近的出租车&lt;/li>
&lt;li>微信：搜索我附近的人&lt;/li>
&lt;/ul>
&lt;p>附近的酒店：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-35e9cbe377ca03.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721172645103"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>附近的车：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-1bd68fbae84b60.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721172654880"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="141矩形范围查询">
&lt;a href="#141%e7%9f%a9%e5%bd%a2%e8%8c%83%e5%9b%b4%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
1.4.1.矩形范围查询
&lt;/h3>&lt;p>矩形范围查询，也就是geo_bounding_box查询，查询坐标落在某个矩形范围的所有文档：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-68871439075ab3.gif"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="DKV9HZbVS6"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>查询时，需要指定矩形的&lt;strong>左上&lt;/strong>、&lt;strong>右下&lt;/strong>两个点的坐标，然后画出一个矩形，落在该矩形内的都是符合条件的点。&lt;/p>
&lt;p>语法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-5">&lt;a class="lnlinks" href="#hl-6-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-6">&lt;a class="lnlinks" href="#hl-6-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-7">&lt;a class="lnlinks" href="#hl-6-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-8">&lt;a class="lnlinks" href="#hl-6-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-9">&lt;a class="lnlinks" href="#hl-6-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-10">&lt;a class="lnlinks" href="#hl-6-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-11">&lt;a class="lnlinks" href="#hl-6-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-12">&lt;a class="lnlinks" href="#hl-6-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-13">&lt;a class="lnlinks" href="#hl-6-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-14">&lt;a class="lnlinks" href="#hl-6-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-15">&lt;a class="lnlinks" href="#hl-6-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-16">&lt;a class="lnlinks" href="#hl-6-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-17">&lt;a class="lnlinks" href="#hl-6-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-18">&lt;a class="lnlinks" href="#hl-6-18">18&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// geo_bounding_box查询
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">GET&lt;/span> &lt;span class="err">/indexName/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;geo_bounding_box&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;FIELD&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;top_left&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// 左上点
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>          &lt;span class="nt">&amp;#34;lat&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mf">31.1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;lon&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mf">121.5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;bottom_right&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// 右下点
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>          &lt;span class="nt">&amp;#34;lat&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mf">30.9&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;lon&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mf">121.7&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这种并不符合“附近的人”这样的需求，所以我们就不做了。&lt;/p>
&lt;h3 id="142附近查询">
&lt;a href="#142%e9%99%84%e8%bf%91%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
1.4.2.附近查询
&lt;/h3>&lt;p>附近查询，也叫做距离查询（geo_distance）：查询到指定中心点小于某个距离值的所有文档。&lt;/p>
&lt;p>换句话来说，在地图上找一个点作为圆心，以指定距离为半径，画一个圆，落在圆内的坐标都算符合条件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-33bd291fd71e60.gif"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="vZrdKAh19C"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>语法说明：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-8">&lt;a class="lnlinks" href="#hl-7-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-9">&lt;a class="lnlinks" href="#hl-7-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-10">&lt;a class="lnlinks" href="#hl-7-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// geo_distance 查询
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">GET&lt;/span> &lt;span class="err">/indexName/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;geo_distance&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;distance&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;15km&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 半径
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>      &lt;span class="nt">&amp;#34;FIELD&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;31.21,121.5&amp;#34;&lt;/span> &lt;span class="c1">// 圆心
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>示例：&lt;/p>
&lt;p>我们先搜索陆家嘴附近15km的酒店：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-98dff141596390.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721175443234"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>发现共有47家酒店。&lt;/p>
&lt;p>然后把半径缩短到3公里：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-dd5c0af25fdac5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721182031475"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以发现，搜索到的酒店数量减少到了5家。&lt;/p>
&lt;h2 id="15复合查询">
&lt;a href="#15%e5%a4%8d%e5%90%88%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
1.5.复合查询
&lt;/h2>&lt;p>复合（compound）查询：复合查询可以将其它简单查询组合起来，实现更复杂的搜索逻辑。常见的有两种：&lt;/p>
&lt;ul>
&lt;li>fuction score：算分函数查询，可以控制文档相关性算分，控制文档排名&lt;/li>
&lt;li>bool query：布尔查询，利用逻辑关系组合多个其它的查询，实现复杂搜索&lt;/li>
&lt;/ul>
&lt;h3 id="151相关性算分">
&lt;a href="#151%e7%9b%b8%e5%85%b3%e6%80%a7%e7%ae%97%e5%88%86" class="header-anchor">#&lt;/a>
1.5.1.相关性算分
&lt;/h3>&lt;p>当我们利用match查询时，文档结果会根据与搜索词条的关联度打分（_score），返回结果时按照分值降序排列。&lt;/p>
&lt;p>例如，我们搜索 &amp;ldquo;虹桥如家&amp;rdquo;，结果如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-6">&lt;a class="lnlinks" href="#hl-8-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-7">&lt;a class="lnlinks" href="#hl-8-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-8">&lt;a class="lnlinks" href="#hl-8-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-9">&lt;a class="lnlinks" href="#hl-8-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-10">&lt;a class="lnlinks" href="#hl-8-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-11">&lt;a class="lnlinks" href="#hl-8-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-12">&lt;a class="lnlinks" href="#hl-8-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-13">&lt;a class="lnlinks" href="#hl-8-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-14">&lt;a class="lnlinks" href="#hl-8-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-15">&lt;a class="lnlinks" href="#hl-8-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-16">&lt;a class="lnlinks" href="#hl-8-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-17">&lt;a class="lnlinks" href="#hl-8-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-18">&lt;a class="lnlinks" href="#hl-8-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-19">&lt;a class="lnlinks" href="#hl-8-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-20">&lt;a class="lnlinks" href="#hl-8-20">20&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;_score&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mf">17.850193&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;_source&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;虹桥如家酒店真不错&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;_score&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mf">12.259849&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;_source&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;外滩如家酒店真不错&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;_score&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mf">11.91091&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;_source&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;迪士尼如家酒店真不错&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在elasticsearch中，早期使用的打分算法是TF-IDF算法，公式如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-9ec6bd94f5b61e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721190152134"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在后来的5.1版本升级中，elasticsearch将算法改进为BM25算法，公式如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-b98b8083486b31.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721190416214"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>TF-IDF算法有一各缺陷，就是词条频率越高，文档得分也会越高，单个词条对文档影响较大。而BM25则会让单个词条的算分有一个上限，曲线更加平滑：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-c4dbfe7f9c77a0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721190907320"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>小结：elasticsearch会根据词条和文档的相关度做打分，算法由两种：&lt;/p>
&lt;ul>
&lt;li>TF-IDF算法&lt;/li>
&lt;li>BM25算法，elasticsearch5.1版本后采用的算法&lt;/li>
&lt;/ul>
&lt;h3 id="152算分函数查询">
&lt;a href="#152%e7%ae%97%e5%88%86%e5%87%bd%e6%95%b0%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
1.5.2.算分函数查询
&lt;/h3>&lt;p>根据相关度打分是比较合理的需求，但&lt;strong>合理的不一定是产品经理需要&lt;/strong>的。&lt;/p>
&lt;p>以百度为例，你搜索的结果中，并不是相关度越高排名越靠前，而是谁掏的钱多排名就越靠前。如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-d7b28d03971e37.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721191144560"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>要想认为控制相关性算分，就需要利用elasticsearch中的function score 查询了。&lt;/p>
&lt;h4 id="1语法说明">
&lt;a href="#1%e8%af%ad%e6%b3%95%e8%af%b4%e6%98%8e" class="header-anchor">#&lt;/a>
1）语法说明
&lt;/h4>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-9d40afc830a1df.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721191544750"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>function score 查询中包含四部分内容：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>原始查询&lt;/strong>条件：query部分，基于这个条件搜索文档，并且基于BM25算法给文档打分，&lt;strong>原始算分&lt;/strong>（query score)&lt;/li>
&lt;li>&lt;strong>过滤条件&lt;/strong>：filter部分，符合该条件的文档才会重新算分&lt;/li>
&lt;li>&lt;strong>算分函数&lt;/strong>：符合filter条件的文档要根据这个函数做运算，得到的&lt;strong>函数算分&lt;/strong>（function score），有四种函数
&lt;ul>
&lt;li>weight：函数结果是常量&lt;/li>
&lt;li>field_value_factor：以文档中的某个字段值作为函数结果&lt;/li>
&lt;li>random_score：以随机数作为函数结果&lt;/li>
&lt;li>script_score：自定义算分函数算法&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>运算模式&lt;/strong>：算分函数的结果、原始查询的相关性算分，两者之间的运算方式，包括：
&lt;ul>
&lt;li>multiply：相乘&lt;/li>
&lt;li>replace：用function score替换query score&lt;/li>
&lt;li>其它，例如：sum、avg、max、min&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>function score的运行流程如下：&lt;/p>
&lt;ul>
&lt;li>1）根据&lt;strong>原始条件&lt;/strong>查询搜索文档，并且计算相关性算分，称为&lt;strong>原始算分&lt;/strong>（query score）&lt;/li>
&lt;li>2）根据&lt;strong>过滤条件&lt;/strong>，过滤文档&lt;/li>
&lt;li>3）符合&lt;strong>过滤条件&lt;/strong>的文档，基于&lt;strong>算分函数&lt;/strong>运算，得到&lt;strong>函数算分&lt;/strong>（function score）&lt;/li>
&lt;li>4）将&lt;strong>原始算分&lt;/strong>（query score）和&lt;strong>函数算分&lt;/strong>（function score）基于&lt;strong>运算模式&lt;/strong>做运算，得到最终结果，作为相关性算分。&lt;/li>
&lt;/ul>
&lt;p>因此，其中的关键点是：&lt;/p>
&lt;ul>
&lt;li>过滤条件：决定哪些文档的算分被修改&lt;/li>
&lt;li>算分函数：决定函数算分的算法&lt;/li>
&lt;li>运算模式：决定最终算分结果&lt;/li>
&lt;/ul>
&lt;h4 id="2示例">
&lt;a href="#2%e7%a4%ba%e4%be%8b" class="header-anchor">#&lt;/a>
2）示例
&lt;/h4>&lt;p>需求：给“如家”这个品牌的酒店排名靠前一些&lt;/p>
&lt;p>翻译一下这个需求，转换为之前说的四个要点：&lt;/p>
&lt;ul>
&lt;li>原始条件：不确定，可以任意变化&lt;/li>
&lt;li>过滤条件：brand = &amp;ldquo;如家&amp;rdquo;&lt;/li>
&lt;li>算分函数：可以简单粗暴，直接给固定的算分结果，weight&lt;/li>
&lt;li>运算模式：比如求和&lt;/li>
&lt;/ul>
&lt;p>因此最终的DSL语句如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-5">&lt;a class="lnlinks" href="#hl-9-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-6">&lt;a class="lnlinks" href="#hl-9-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-7">&lt;a class="lnlinks" href="#hl-9-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-8">&lt;a class="lnlinks" href="#hl-9-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-9">&lt;a class="lnlinks" href="#hl-9-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-10">&lt;a class="lnlinks" href="#hl-9-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-11">&lt;a class="lnlinks" href="#hl-9-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-12">&lt;a class="lnlinks" href="#hl-9-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-13">&lt;a class="lnlinks" href="#hl-9-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-14">&lt;a class="lnlinks" href="#hl-9-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-15">&lt;a class="lnlinks" href="#hl-9-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-16">&lt;a class="lnlinks" href="#hl-9-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-17">&lt;a class="lnlinks" href="#hl-9-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-18">&lt;a class="lnlinks" href="#hl-9-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-19">&lt;a class="lnlinks" href="#hl-9-19">19&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/hotel/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;function_score&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="err">....&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="c1">// 原始查询，可以是任意条件
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>      &lt;span class="nt">&amp;#34;functions&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span> &lt;span class="c1">// 算分函数
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>        &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;filter&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// 满足的条件，品牌必须是如家
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>            &lt;span class="nt">&amp;#34;term&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">              &lt;span class="nt">&amp;#34;brand&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;如家&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">            &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;weight&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="c1">// 算分权重为2
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>        &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;boost_mode&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;sum&amp;#34;&lt;/span> &lt;span class="c1">// 加权模式，求和
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试，在未添加算分函数时，如家得分如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-d9290888f161cc.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721193152520"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>添加了算分函数后，如家得分就提升了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-8e0331d3e511ab.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721193458182"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h4 id="3小结">
&lt;a href="#3%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
3）小结
&lt;/h4>&lt;p>function score query定义的三要素是什么？&lt;/p>
&lt;ul>
&lt;li>过滤条件：哪些文档要加分&lt;/li>
&lt;li>算分函数：如何计算function score&lt;/li>
&lt;li>加权方式：function score 与 query score如何运算&lt;/li>
&lt;/ul>
&lt;h3 id="153布尔查询">
&lt;a href="#153%e5%b8%83%e5%b0%94%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
1.5.3.布尔查询
&lt;/h3>&lt;p>布尔查询是一个或多个查询子句的组合，每一个子句就是一个&lt;strong>子查询&lt;/strong>。子查询的组合方式有：&lt;/p>
&lt;ul>
&lt;li>must：必须匹配每个子查询，类似“与”&lt;/li>
&lt;li>should：选择性匹配子查询，类似“或”&lt;/li>
&lt;li>must_not：必须不匹配，&lt;strong>不参与算分&lt;/strong>，类似“非”&lt;/li>
&lt;li>filter：必须匹配，&lt;strong>不参与算分&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>比如在搜索酒店时，除了关键字搜索外，我们还可能根据品牌、价格、城市等字段做过滤：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-654dc6edf34357.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721193822848"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>每一个不同的字段，其查询的条件、方式都不一样，必须是多个不同的查询，而要组合这些查询，就必须用bool查询了。&lt;/p>
&lt;p>需要注意的是，搜索时，参与&lt;strong>打分的字段越多，查询的性能也越差&lt;/strong>。因此这种多条件查询时，建议这样做：&lt;/p>
&lt;ul>
&lt;li>搜索框的关键字搜索，是全文检索查询，使用must查询，参与算分&lt;/li>
&lt;li>其它过滤条件，采用filter查询。不参与算分&lt;/li>
&lt;/ul>
&lt;h4 id="1语法示例">
&lt;a href="#1%e8%af%ad%e6%b3%95%e7%a4%ba%e4%be%8b" class="header-anchor">#&lt;/a>
1）语法示例：
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-5">&lt;a class="lnlinks" href="#hl-10-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-6">&lt;a class="lnlinks" href="#hl-10-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-7">&lt;a class="lnlinks" href="#hl-10-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-8">&lt;a class="lnlinks" href="#hl-10-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-9">&lt;a class="lnlinks" href="#hl-10-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-10">&lt;a class="lnlinks" href="#hl-10-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-11">&lt;a class="lnlinks" href="#hl-10-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-12">&lt;a class="lnlinks" href="#hl-10-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-13">&lt;a class="lnlinks" href="#hl-10-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-14">&lt;a class="lnlinks" href="#hl-10-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-15">&lt;a class="lnlinks" href="#hl-10-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-16">&lt;a class="lnlinks" href="#hl-10-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-17">&lt;a class="lnlinks" href="#hl-10-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-18">&lt;a class="lnlinks" href="#hl-10-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-19">&lt;a class="lnlinks" href="#hl-10-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-20">&lt;a class="lnlinks" href="#hl-10-20">20&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/hotel/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;bool&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;must&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;term&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;city&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;上海&amp;#34;&lt;/span> &lt;span class="p">}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;should&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;term&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;brand&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;皇冠假日&amp;#34;&lt;/span> &lt;span class="p">}},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;term&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;brand&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;华美达&amp;#34;&lt;/span> &lt;span class="p">}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;must_not&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;range&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;price&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;lte&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">500&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;filter&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;range&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;score&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;gte&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">45&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="2示例-1">
&lt;a href="#2%e7%a4%ba%e4%be%8b-1" class="header-anchor">#&lt;/a>
2）示例
&lt;/h4>&lt;p>需求：搜索名字包含“如家”，价格不高于400，在坐标31.21,121.5周围10km范围内的酒店。&lt;/p>
&lt;p>分析：&lt;/p>
&lt;ul>
&lt;li>名称搜索，属于全文检索查询，应该参与算分。放到must中&lt;/li>
&lt;li>价格不高于400，用range查询，属于过滤条件，不参与算分。放到must_not中&lt;/li>
&lt;li>周围10km范围内，用geo_distance查询，属于过滤条件，不参与算分。放到filter中&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-906e60e8edcc04.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721194744183"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h4 id="3小结-1">
&lt;a href="#3%e5%b0%8f%e7%bb%93-1" class="header-anchor">#&lt;/a>
3）小结
&lt;/h4>&lt;p>bool查询有几种逻辑关系？&lt;/p>
&lt;ul>
&lt;li>must：必须匹配的条件，可以理解为“与”&lt;/li>
&lt;li>should：选择性匹配的条件，可以理解为“或”&lt;/li>
&lt;li>must_not：必须不匹配的条件，不参与打分&lt;/li>
&lt;li>filter：必须匹配的条件，不参与打分&lt;/li>
&lt;/ul>
&lt;h1 id="2搜索结果处理">
&lt;a href="#2%e6%90%9c%e7%b4%a2%e7%bb%93%e6%9e%9c%e5%a4%84%e7%90%86" class="header-anchor">#&lt;/a>
2.搜索结果处理
&lt;/h1>&lt;p>搜索的结果可以按照用户指定的方式去处理或展示。&lt;/p>
&lt;h2 id="21排序">
&lt;a href="#21%e6%8e%92%e5%ba%8f" class="header-anchor">#&lt;/a>
2.1.排序
&lt;/h2>&lt;p>elasticsearch默认是根据相关度算分（_score）来排序，但是也支持自定义方式对搜索&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html" target="_blank" rel="noopener"
>结果排序
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>。可以排序字段类型有：keyword类型、数值类型、地理坐标类型、日期类型等。&lt;/p>
&lt;h3 id="211普通字段排序">
&lt;a href="#211%e6%99%ae%e9%80%9a%e5%ad%97%e6%ae%b5%e6%8e%92%e5%ba%8f" class="header-anchor">#&lt;/a>
2.1.1.普通字段排序
&lt;/h3>&lt;p>keyword、数值、日期类型排序的语法基本一致。&lt;/p>
&lt;p>&lt;strong>语法&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-5">&lt;a class="lnlinks" href="#hl-11-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-6">&lt;a class="lnlinks" href="#hl-11-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-7">&lt;a class="lnlinks" href="#hl-11-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-8">&lt;a class="lnlinks" href="#hl-11-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-9">&lt;a class="lnlinks" href="#hl-11-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-10">&lt;a class="lnlinks" href="#hl-11-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-11">&lt;a class="lnlinks" href="#hl-11-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/indexName/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;match_all&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;sort&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;FIELD&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;desc&amp;#34;&lt;/span>  &lt;span class="c1">// 排序字段、排序方式ASC、DESC
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>排序条件是一个数组，也就是可以写多个排序条件。按照声明的顺序，当第一个条件相等时，再按照第二个条件排序，以此类推&lt;/p>
&lt;p>&lt;strong>示例&lt;/strong>：&lt;/p>
&lt;p>需求描述：酒店数据按照用户评价（score)降序排序，评价相同的按照价格(price)升序排序&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-d259112666cf45.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721195728306"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="212地理坐标排序">
&lt;a href="#212%e5%9c%b0%e7%90%86%e5%9d%90%e6%a0%87%e6%8e%92%e5%ba%8f" class="header-anchor">#&lt;/a>
2.1.2.地理坐标排序
&lt;/h3>&lt;p>地理坐标排序略有不同。&lt;/p>
&lt;p>&lt;strong>语法说明&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-6">&lt;a class="lnlinks" href="#hl-12-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-7">&lt;a class="lnlinks" href="#hl-12-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-8">&lt;a class="lnlinks" href="#hl-12-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-9">&lt;a class="lnlinks" href="#hl-12-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-10">&lt;a class="lnlinks" href="#hl-12-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-11">&lt;a class="lnlinks" href="#hl-12-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-12">&lt;a class="lnlinks" href="#hl-12-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-13">&lt;a class="lnlinks" href="#hl-12-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-14">&lt;a class="lnlinks" href="#hl-12-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-15">&lt;a class="lnlinks" href="#hl-12-15">15&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/indexName/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;match_all&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;sort&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;_geo_distance&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;FIELD&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;纬度，经度&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 文档中geo_point类型的字段名、目标坐标点
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>          &lt;span class="nt">&amp;#34;order&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;asc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 排序方式
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>          &lt;span class="nt">&amp;#34;unit&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;km&amp;#34;&lt;/span> &lt;span class="c1">// 排序的距离单位
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个查询的含义是：&lt;/p>
&lt;ul>
&lt;li>指定一个坐标，作为目标点&lt;/li>
&lt;li>计算每一个文档中，指定字段（必须是geo_point类型）的坐标 到目标点的距离是多少&lt;/li>
&lt;li>根据距离排序&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>示例：&lt;/strong>&lt;/p>
&lt;p>需求描述：实现对酒店数据按照到你的位置坐标的距离升序排序&lt;/p>
&lt;p>提示：获取你的位置的经纬度的方式：https://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat/&lt;/p>
&lt;p>假设我的位置是：31.034661，121.612282，寻找我周围距离最近的酒店。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-b36f4b48f8e892.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721200214690"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="22分页">
&lt;a href="#22%e5%88%86%e9%a1%b5" class="header-anchor">#&lt;/a>
2.2.分页
&lt;/h2>&lt;p>elasticsearch 默认情况下只返回top10的数据。而如果要查询更多数据就需要修改分页参数了。elasticsearch中通过修改from、size参数来控制要返回的分页结果：&lt;/p>
&lt;ul>
&lt;li>from：从第几个文档开始&lt;/li>
&lt;li>size：总共查询几个文档&lt;/li>
&lt;/ul>
&lt;p>类似于mysql中的&lt;code>limit ?, ?&lt;/code>&lt;/p>
&lt;h3 id="221基本的分页">
&lt;a href="#221%e5%9f%ba%e6%9c%ac%e7%9a%84%e5%88%86%e9%a1%b5" class="header-anchor">#&lt;/a>
2.2.1.基本的分页
&lt;/h3>&lt;p>分页的基本语法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-6">&lt;a class="lnlinks" href="#hl-13-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-7">&lt;a class="lnlinks" href="#hl-13-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-8">&lt;a class="lnlinks" href="#hl-13-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-9">&lt;a class="lnlinks" href="#hl-13-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-10">&lt;a class="lnlinks" href="#hl-13-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-11">&lt;a class="lnlinks" href="#hl-13-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/hotel/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;match_all&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;from&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 分页开始的位置，默认为0
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>  &lt;span class="nt">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 期望获取的文档总数
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>  &lt;span class="nt">&amp;#34;sort&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;price&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;asc&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="222深度分页问题">
&lt;a href="#222%e6%b7%b1%e5%ba%a6%e5%88%86%e9%a1%b5%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
2.2.2.深度分页问题
&lt;/h3>&lt;p>现在，我要查询990~1000的数据，查询逻辑要这么写：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-5">&lt;a class="lnlinks" href="#hl-14-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-6">&lt;a class="lnlinks" href="#hl-14-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-7">&lt;a class="lnlinks" href="#hl-14-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-8">&lt;a class="lnlinks" href="#hl-14-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-9">&lt;a class="lnlinks" href="#hl-14-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-10">&lt;a class="lnlinks" href="#hl-14-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-11">&lt;a class="lnlinks" href="#hl-14-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/hotel/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;match_all&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;from&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">990&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 分页开始的位置，默认为0
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>  &lt;span class="nt">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 期望获取的文档总数
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>  &lt;span class="nt">&amp;#34;sort&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;price&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;asc&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里是查询990开始的数据，也就是 第990~第1000条 数据。&lt;/p>
&lt;p>不过，elasticsearch内部分页时，必须先查询 0~1000条，然后截取其中的990 ~ 1000的这10条：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-cb427058cdb041.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721200643029"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>查询TOP1000，如果es是单点模式，这并无太大影响。&lt;/p>
&lt;p>但是elasticsearch将来一定是集群，例如我集群有5个节点，我要查询TOP1000的数据，并不是每个节点查询200条就可以了。&lt;/p>
&lt;p>因为节点A的TOP200，在另一个节点可能排到10000名以外了。&lt;/p>
&lt;p>因此要想获取整个集群的TOP1000，必须先查询出每个节点的TOP1000，汇总结果后，重新排名，重新截取TOP1000。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-512a98e0d4d350.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721201003229"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>那如果我要查询9900~10000的数据呢？是不是要先查询TOP10000呢？那每个节点都要查询10000条？汇总到内存中？&lt;/p>
&lt;p>当查询分页深度较大时，汇总数据过多，对内存和CPU会产生非常大的压力，因此elasticsearch会禁止from+ size 超过10000的请求。&lt;/p>
&lt;p>针对深度分页，ES提供了两种解决方案，&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html" target="_blank" rel="noopener"
>官方文档
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>：&lt;/p>
&lt;ul>
&lt;li>search after：分页时需要排序，原理是从上一次的排序值开始，查询下一页数据。官方推荐使用的方式。&lt;/li>
&lt;li>scroll：原理将排序后的文档id形成快照，保存在内存。官方已经不推荐使用。&lt;/li>
&lt;/ul>
&lt;h3 id="223小结">
&lt;a href="#223%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
2.2.3.小结
&lt;/h3>&lt;p>分页查询的常见实现方案以及优缺点：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>from + size&lt;/code>：&lt;/p>
&lt;ul>
&lt;li>优点：支持随机翻页&lt;/li>
&lt;li>缺点：深度分页问题，默认查询上限（from + size）是10000&lt;/li>
&lt;li>场景：百度、京东、谷歌、淘宝这样的随机翻页搜索&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>after search&lt;/code>：&lt;/p>
&lt;ul>
&lt;li>优点：没有查询上限（单次查询的size不超过10000）&lt;/li>
&lt;li>缺点：只能向后逐页查询，不支持随机翻页&lt;/li>
&lt;li>场景：没有随机翻页需求的搜索，例如手机向下滚动翻页&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>scroll&lt;/code>：&lt;/p>
&lt;ul>
&lt;li>优点：没有查询上限（单次查询的size不超过10000）&lt;/li>
&lt;li>缺点：会有额外内存消耗，并且搜索结果是非实时的&lt;/li>
&lt;li>场景：海量数据的获取和迁移。从ES7.1开始不推荐，建议用 after search方案。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="23高亮">
&lt;a href="#23%e9%ab%98%e4%ba%ae" class="header-anchor">#&lt;/a>
2.3.高亮
&lt;/h2>&lt;h3 id="231高亮原理">
&lt;a href="#231%e9%ab%98%e4%ba%ae%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
2.3.1.高亮原理
&lt;/h3>&lt;p>什么是高亮显示呢？&lt;/p>
&lt;p>我们在百度，京东搜索时，关键字会变成红色，比较醒目，这叫高亮显示：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-33798e10fd5e72.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721202705030"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>高亮显示的实现分为两步：&lt;/p>
&lt;ul>
&lt;li>1）给文档中的所有关键字都添加一个标签，例如&lt;code>&amp;lt;em&amp;gt;&lt;/code>标签&lt;/li>
&lt;li>2）页面给&lt;code>&amp;lt;em&amp;gt;&lt;/code>标签编写CSS样式&lt;/li>
&lt;/ul>
&lt;h3 id="232实现高亮">
&lt;a href="#232%e5%ae%9e%e7%8e%b0%e9%ab%98%e4%ba%ae" class="header-anchor">#&lt;/a>
2.3.2.实现高亮
&lt;/h3>&lt;p>&lt;strong>高亮的语法&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-6">&lt;a class="lnlinks" href="#hl-15-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-7">&lt;a class="lnlinks" href="#hl-15-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-8">&lt;a class="lnlinks" href="#hl-15-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-9">&lt;a class="lnlinks" href="#hl-15-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-10">&lt;a class="lnlinks" href="#hl-15-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-11">&lt;a class="lnlinks" href="#hl-15-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-12">&lt;a class="lnlinks" href="#hl-15-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-13">&lt;a class="lnlinks" href="#hl-15-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-14">&lt;a class="lnlinks" href="#hl-15-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-15">&lt;a class="lnlinks" href="#hl-15-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-16">&lt;a class="lnlinks" href="#hl-15-16">16&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/hotel/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;match&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;FIELD&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;TEXT&amp;#34;&lt;/span> &lt;span class="c1">// 查询条件，高亮一定要使用全文检索查询
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;highlight&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;fields&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// 指定要高亮的字段
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>      &lt;span class="nt">&amp;#34;FIELD&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;pre_tags&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;em&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>  &lt;span class="c1">// 用来标记高亮字段的前置标签
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>        &lt;span class="nt">&amp;#34;post_tags&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;/em&amp;gt;&amp;#34;&lt;/span> &lt;span class="c1">// 用来标记高亮字段的后置标签
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>注意：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>高亮是对关键字高亮，因此&lt;strong>搜索条件必须带有关键字&lt;/strong>，而不能是范围这样的查询。&lt;/li>
&lt;li>默认情况下，&lt;strong>高亮的字段，必须与搜索指定的字段一致&lt;/strong>，否则无法高亮&lt;/li>
&lt;li>如果要对非搜索字段高亮，则需要添加一个属性：required_field_match=false&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>示例&lt;/strong>：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-e9e2654d3b9453.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721203349633"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="24总结">
&lt;a href="#24%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
2.4.总结
&lt;/h2>&lt;p>查询的DSL是一个大的JSON对象，包含下列属性：&lt;/p>
&lt;ul>
&lt;li>query：查询条件&lt;/li>
&lt;li>from和size：分页条件&lt;/li>
&lt;li>sort：排序条件&lt;/li>
&lt;li>highlight：高亮条件&lt;/li>
&lt;/ul>
&lt;p>示例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-634d0bcacab727.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721203657850"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="3restclient查询文档">
&lt;a href="#3restclient%e6%9f%a5%e8%af%a2%e6%96%87%e6%a1%a3" class="header-anchor">#&lt;/a>
3.RestClient查询文档
&lt;/h1>&lt;p>文档的查询同样适用昨天学习的 RestHighLevelClient对象，基本步骤包括：&lt;/p>
&lt;ul>
&lt;li>1）准备Request对象&lt;/li>
&lt;li>2）准备请求参数&lt;/li>
&lt;li>3）发起请求&lt;/li>
&lt;li>4）解析响应&lt;/li>
&lt;/ul>
&lt;h2 id="31快速入门">
&lt;a href="#31%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8" class="header-anchor">#&lt;/a>
3.1.快速入门
&lt;/h2>&lt;p>我们以match_all查询为例&lt;/p>
&lt;h3 id="311发起查询请求">
&lt;a href="#311%e5%8f%91%e8%b5%b7%e6%9f%a5%e8%af%a2%e8%af%b7%e6%b1%82" class="header-anchor">#&lt;/a>
3.1.1.发起查询请求
&lt;/h3>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-7418195927b1fd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721203950559"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>代码解读：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>第一步，创建&lt;code>SearchRequest&lt;/code>对象，指定索引库名&lt;/p>
&lt;/li>
&lt;li>
&lt;p>第二步，利用&lt;code>request.source()&lt;/code>构建DSL，DSL中可以包含查询、分页、排序、高亮等&lt;/p>
&lt;ul>
&lt;li>&lt;code>query()&lt;/code>：代表查询条件，利用&lt;code>QueryBuilders.matchAllQuery()&lt;/code>构建一个match_all查询的DSL&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>第三步，利用client.search()发送请求，得到响应&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>这里关键的API有两个，一个是&lt;code>request.source()&lt;/code>，其中包含了查询、排序、分页、高亮等所有功能：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-16821f928de55c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721215640790"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>另一个是&lt;code>QueryBuilders&lt;/code>，其中包含match、term、function_score、bool等各种查询：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-62c01589e71dde.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721215729236"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="312解析响应">
&lt;a href="#312%e8%a7%a3%e6%9e%90%e5%93%8d%e5%ba%94" class="header-anchor">#&lt;/a>
3.1.2.解析响应
&lt;/h3>&lt;p>响应结果的解析：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-982d66085250de.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721214221057"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>elasticsearch返回的结果是一个JSON字符串，结构包含：&lt;/p>
&lt;ul>
&lt;li>&lt;code>hits&lt;/code>：命中的结果
&lt;ul>
&lt;li>&lt;code>total&lt;/code>：总条数，其中的value是具体的总条数值&lt;/li>
&lt;li>&lt;code>max_score&lt;/code>：所有结果中得分最高的文档的相关性算分&lt;/li>
&lt;li>&lt;code>hits&lt;/code>：搜索结果的文档数组，其中的每个文档都是一个json对象
&lt;ul>
&lt;li>&lt;code>_source&lt;/code>：文档中的原始数据，也是json对象&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>因此，我们解析响应结果，就是逐层解析JSON字符串，流程如下：&lt;/p>
&lt;ul>
&lt;li>&lt;code>SearchHits&lt;/code>：通过response.getHits()获取，就是JSON中的最外层的hits，代表命中的结果
&lt;ul>
&lt;li>&lt;code>SearchHits#getTotalHits().value&lt;/code>：获取总条数信息&lt;/li>
&lt;li>&lt;code>SearchHits#getHits()&lt;/code>：获取SearchHit数组，也就是文档数组
&lt;ul>
&lt;li>&lt;code>SearchHit#getSourceAsString()&lt;/code>：获取文档结果中的_source，也就是原始的json文档数据&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="313完整代码">
&lt;a href="#313%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81" class="header-anchor">#&lt;/a>
3.1.3.完整代码
&lt;/h3>&lt;p>完整代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-7">&lt;a class="lnlinks" href="#hl-16-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-8">&lt;a class="lnlinks" href="#hl-16-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-9">&lt;a class="lnlinks" href="#hl-16-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-10">&lt;a class="lnlinks" href="#hl-16-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-11">&lt;a class="lnlinks" href="#hl-16-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-12">&lt;a class="lnlinks" href="#hl-16-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-13">&lt;a class="lnlinks" href="#hl-16-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-14">&lt;a class="lnlinks" href="#hl-16-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-15">&lt;a class="lnlinks" href="#hl-16-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-16">&lt;a class="lnlinks" href="#hl-16-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-17">&lt;a class="lnlinks" href="#hl-16-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-18">&lt;a class="lnlinks" href="#hl-16-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-19">&lt;a class="lnlinks" href="#hl-16-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-20">&lt;a class="lnlinks" href="#hl-16-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-21">&lt;a class="lnlinks" href="#hl-16-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-22">&lt;a class="lnlinks" href="#hl-16-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-23">&lt;a class="lnlinks" href="#hl-16-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-24">&lt;a class="lnlinks" href="#hl-16-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-25">&lt;a class="lnlinks" href="#hl-16-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-26">&lt;a class="lnlinks" href="#hl-16-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-27">&lt;a class="lnlinks" href="#hl-16-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-28">&lt;a class="lnlinks" href="#hl-16-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-29">&lt;a class="lnlinks" href="#hl-16-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-30">&lt;a class="lnlinks" href="#hl-16-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-31">&lt;a class="lnlinks" href="#hl-16-31">31&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testMatchAll&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备DSL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchAllQuery&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.解析响应&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">handleResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">handleResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SearchResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.解析响应&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchHits&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">searchHits&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getHits&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.1.获取总条数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">searchHits&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getTotalHits&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;共搜索到&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;条数据&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.2.文档数组&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchHit&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hits&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">searchHits&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getHits&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.3.遍历&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SearchHit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hits&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取文档source&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hit&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getSourceAsString&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 反序列化&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JSON&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">parseObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotelDoc = &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="314小结">
&lt;a href="#314%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
3.1.4.小结
&lt;/h3>&lt;p>查询的基本步骤是：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>创建SearchRequest对象&lt;/p>
&lt;/li>
&lt;li>
&lt;p>准备Request.source()，也就是DSL。&lt;/p>
&lt;p>① QueryBuilders来构建查询条件&lt;/p>
&lt;p>② 传入Request.source() 的 query() 方法&lt;/p>
&lt;/li>
&lt;li>
&lt;p>发送请求，得到结果&lt;/p>
&lt;/li>
&lt;li>
&lt;p>解析结果（参考JSON结果，从外到内，逐层解析）&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="32match查询">
&lt;a href="#32match%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
3.2.match查询
&lt;/h2>&lt;p>全文检索的match和multi_match查询与match_all的API基本一致。差别是查询条件，也就是query的部分。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-b30c68156ffa5b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721215923060"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>因此，Java代码上的差异主要是request.source().query()中的参数了。同样是利用QueryBuilders提供的方法：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-6745c7bc27ad37.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721215843099"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>而结果解析代码则完全一致，可以抽取并共享。&lt;/p>
&lt;p>完整代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-4">&lt;a class="lnlinks" href="#hl-17-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-5">&lt;a class="lnlinks" href="#hl-17-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-6">&lt;a class="lnlinks" href="#hl-17-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-7">&lt;a class="lnlinks" href="#hl-17-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-8">&lt;a class="lnlinks" href="#hl-17-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-9">&lt;a class="lnlinks" href="#hl-17-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-10">&lt;a class="lnlinks" href="#hl-17-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-11">&lt;a class="lnlinks" href="#hl-17-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-12">&lt;a class="lnlinks" href="#hl-17-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-13">&lt;a class="lnlinks" href="#hl-17-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testMatch&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备DSL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;all&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;如家&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.解析响应&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">handleResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="33精确查询">
&lt;a href="#33%e7%b2%be%e7%a1%ae%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
3.3.精确查询
&lt;/h2>&lt;p>精确查询主要是两者：&lt;/p>
&lt;ul>
&lt;li>term：词条精确匹配&lt;/li>
&lt;li>range：范围查询&lt;/li>
&lt;/ul>
&lt;p>与之前的查询相比，差异同样在查询条件，其它都一样。&lt;/p>
&lt;p>查询条件构造的API如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-6b9a03b71c88f8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721220305140"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="34布尔查询">
&lt;a href="#34%e5%b8%83%e5%b0%94%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
3.4.布尔查询
&lt;/h2>&lt;p>布尔查询是用must、must_not、filter等方式组合其它查询，代码示例如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-96cc582fee25da.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721220927286"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，API与其它查询的差别同样是在查询条件的构建，QueryBuilders，结果解析等其他代码完全不变。&lt;/p>
&lt;p>完整代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-5">&lt;a class="lnlinks" href="#hl-18-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-6">&lt;a class="lnlinks" href="#hl-18-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-7">&lt;a class="lnlinks" href="#hl-18-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-8">&lt;a class="lnlinks" href="#hl-18-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-9">&lt;a class="lnlinks" href="#hl-18-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-10">&lt;a class="lnlinks" href="#hl-18-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-11">&lt;a class="lnlinks" href="#hl-18-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-12">&lt;a class="lnlinks" href="#hl-18-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-13">&lt;a class="lnlinks" href="#hl-18-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-14">&lt;a class="lnlinks" href="#hl-18-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-15">&lt;a class="lnlinks" href="#hl-18-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-16">&lt;a class="lnlinks" href="#hl-18-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-17">&lt;a class="lnlinks" href="#hl-18-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-18">&lt;a class="lnlinks" href="#hl-18-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-19">&lt;a class="lnlinks" href="#hl-18-19">19&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testBool&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备DSL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.1.准备BooleanQuery&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">BoolQueryBuilder&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">boolQuery&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.2.添加term&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">termQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;city&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;杭州&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.3.添加range&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">rangeQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;price&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">lte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">250&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.解析响应&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">handleResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="35排序分页">
&lt;a href="#35%e6%8e%92%e5%ba%8f%e5%88%86%e9%a1%b5" class="header-anchor">#&lt;/a>
3.5.排序、分页
&lt;/h2>&lt;p>搜索结果的排序和分页是与query同级的参数，因此同样是使用request.source()来设置。&lt;/p>
&lt;p>对应的API如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-1d2e7502239f63.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721221121266"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>完整代码示例：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-5">&lt;a class="lnlinks" href="#hl-19-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-6">&lt;a class="lnlinks" href="#hl-19-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-7">&lt;a class="lnlinks" href="#hl-19-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-8">&lt;a class="lnlinks" href="#hl-19-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-9">&lt;a class="lnlinks" href="#hl-19-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-10">&lt;a class="lnlinks" href="#hl-19-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-11">&lt;a class="lnlinks" href="#hl-19-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-12">&lt;a class="lnlinks" href="#hl-19-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-13">&lt;a class="lnlinks" href="#hl-19-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-14">&lt;a class="lnlinks" href="#hl-19-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-15">&lt;a class="lnlinks" href="#hl-19-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-16">&lt;a class="lnlinks" href="#hl-19-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-17">&lt;a class="lnlinks" href="#hl-19-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-18">&lt;a class="lnlinks" href="#hl-19-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-19">&lt;a class="lnlinks" href="#hl-19-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-20">&lt;a class="lnlinks" href="#hl-19-20">20&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testPageAndSort&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 页码，每页大小&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">page&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">5&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备DSL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.1.query&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchAllQuery&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.2.排序 sort&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">sort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;price&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SortOrder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ASC&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.3.分页 from、size&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">from&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">page&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">5&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.解析响应&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">handleResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="36高亮">
&lt;a href="#36%e9%ab%98%e4%ba%ae" class="header-anchor">#&lt;/a>
3.6.高亮
&lt;/h2>&lt;p>高亮的代码与之前代码差异较大，有两点：&lt;/p>
&lt;ul>
&lt;li>查询的DSL：其中除了查询条件，还需要添加高亮条件，同样是与query同级。&lt;/li>
&lt;li>结果解析：结果除了要解析_source文档数据，还要解析高亮结果&lt;/li>
&lt;/ul>
&lt;h3 id="361高亮请求构建">
&lt;a href="#361%e9%ab%98%e4%ba%ae%e8%af%b7%e6%b1%82%e6%9e%84%e5%bb%ba" class="header-anchor">#&lt;/a>
3.6.1.高亮请求构建
&lt;/h3>&lt;p>高亮请求的构建API如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-75451be3f1d870.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721221744883"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>上述代码省略了查询条件部分，但是大家不要忘了：高亮查询必须使用全文检索查询，并且要有搜索关键字，将来才可以对关键字高亮。&lt;/p>
&lt;p>完整代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-4">&lt;a class="lnlinks" href="#hl-20-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-5">&lt;a class="lnlinks" href="#hl-20-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-6">&lt;a class="lnlinks" href="#hl-20-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-7">&lt;a class="lnlinks" href="#hl-20-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-8">&lt;a class="lnlinks" href="#hl-20-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-9">&lt;a class="lnlinks" href="#hl-20-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-10">&lt;a class="lnlinks" href="#hl-20-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-11">&lt;a class="lnlinks" href="#hl-20-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-12">&lt;a class="lnlinks" href="#hl-20-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-13">&lt;a class="lnlinks" href="#hl-20-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-14">&lt;a class="lnlinks" href="#hl-20-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-15">&lt;a class="lnlinks" href="#hl-20-15">15&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">testHighlight&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备DSL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.1.query&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;all&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;如家&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.2.高亮&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">highlighter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HighlightBuilder&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">field&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">requireFieldMatch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.解析响应&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">handleResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="362高亮结果解析">
&lt;a href="#362%e9%ab%98%e4%ba%ae%e7%bb%93%e6%9e%9c%e8%a7%a3%e6%9e%90" class="header-anchor">#&lt;/a>
3.6.2.高亮结果解析
&lt;/h3>&lt;p>高亮的结果与查询的文档结果默认是分离的，并不在一起。&lt;/p>
&lt;p>因此解析高亮的代码需要额外处理：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-27e55e07cc03a3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721222057212"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>代码解读：&lt;/p>
&lt;ul>
&lt;li>第一步：从结果中获取source。hit.getSourceAsString()，这部分是非高亮结果，json字符串。还需要反序列为HotelDoc对象&lt;/li>
&lt;li>第二步：获取高亮结果。hit.getHighlightFields()，返回值是一个Map，key是高亮字段名称，值是HighlightField对象，代表高亮值&lt;/li>
&lt;li>第三步：从map中根据高亮字段名称，获取高亮字段值对象HighlightField&lt;/li>
&lt;li>第四步：从HighlightField中获取Fragments，并且转为字符串。这部分就是真正的高亮字符串了&lt;/li>
&lt;li>第五步：用高亮的结果替换HotelDoc中的非高亮结果&lt;/li>
&lt;/ul>
&lt;p>完整代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-21-1">&lt;a class="lnlinks" href="#hl-21-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-2">&lt;a class="lnlinks" href="#hl-21-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-3">&lt;a class="lnlinks" href="#hl-21-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-4">&lt;a class="lnlinks" href="#hl-21-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-5">&lt;a class="lnlinks" href="#hl-21-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-6">&lt;a class="lnlinks" href="#hl-21-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-7">&lt;a class="lnlinks" href="#hl-21-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-8">&lt;a class="lnlinks" href="#hl-21-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-9">&lt;a class="lnlinks" href="#hl-21-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-10">&lt;a class="lnlinks" href="#hl-21-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-11">&lt;a class="lnlinks" href="#hl-21-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-12">&lt;a class="lnlinks" href="#hl-21-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-13">&lt;a class="lnlinks" href="#hl-21-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-14">&lt;a class="lnlinks" href="#hl-21-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-15">&lt;a class="lnlinks" href="#hl-21-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-16">&lt;a class="lnlinks" href="#hl-21-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-17">&lt;a class="lnlinks" href="#hl-21-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-18">&lt;a class="lnlinks" href="#hl-21-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-19">&lt;a class="lnlinks" href="#hl-21-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-20">&lt;a class="lnlinks" href="#hl-21-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-21">&lt;a class="lnlinks" href="#hl-21-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-22">&lt;a class="lnlinks" href="#hl-21-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-23">&lt;a class="lnlinks" href="#hl-21-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-24">&lt;a class="lnlinks" href="#hl-21-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-25">&lt;a class="lnlinks" href="#hl-21-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-26">&lt;a class="lnlinks" href="#hl-21-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-27">&lt;a class="lnlinks" href="#hl-21-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-28">&lt;a class="lnlinks" href="#hl-21-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-29">&lt;a class="lnlinks" href="#hl-21-29">29&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">handleResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SearchResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.解析响应&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchHits&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">searchHits&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getHits&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.1.获取总条数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">searchHits&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getTotalHits&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;共搜索到&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;条数据&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.2.文档数组&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchHit&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hits&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">searchHits&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getHits&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.3.遍历&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SearchHit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hits&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取文档source&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hit&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getSourceAsString&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 反序列化&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JSON&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">parseObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取高亮结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HighlightField&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">highlightFields&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hit&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getHighlightFields&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">CollectionUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">highlightFields&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 根据字段名获取高亮结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HighlightField&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">highlightField&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">highlightFields&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">highlightField&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取高亮值&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">highlightField&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getFragments&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">]&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">string&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 覆盖非高亮结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotelDoc = &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="4黑马旅游案例">
&lt;a href="#4%e9%bb%91%e9%a9%ac%e6%97%85%e6%b8%b8%e6%a1%88%e4%be%8b" class="header-anchor">#&lt;/a>
4.黑马旅游案例
&lt;/h1>&lt;p>下面，我们通过黑马旅游的案例来实战演练下之前学习的知识。&lt;/p>
&lt;p>我们实现四部分功能：&lt;/p>
&lt;ul>
&lt;li>酒店搜索和分页&lt;/li>
&lt;li>酒店结果过滤&lt;/li>
&lt;li>我周边的酒店&lt;/li>
&lt;li>酒店竞价排名&lt;/li>
&lt;/ul>
&lt;p>启动我们提供的hotel-demo项目，其默认端口是8089，访问http://localhost:8090，就能看到项目页面了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-051ee2501fafd8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721223159598"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="41酒店搜索和分页">
&lt;a href="#41%e9%85%92%e5%ba%97%e6%90%9c%e7%b4%a2%e5%92%8c%e5%88%86%e9%a1%b5" class="header-anchor">#&lt;/a>
4.1.酒店搜索和分页
&lt;/h2>&lt;p>案例需求：实现黑马旅游的酒店搜索功能，完成关键字搜索和分页&lt;/p>
&lt;h3 id="411需求分析">
&lt;a href="#411%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90" class="header-anchor">#&lt;/a>
4.1.1.需求分析
&lt;/h3>&lt;p>在项目的首页，有一个大大的搜索框，还有分页按钮：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-98872c42342414.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721223859419"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>点击搜索按钮，可以看到浏览器控制台发出了请求：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-cca443f28ee330.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721224033789"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>请求参数如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-32fd2b026368b3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721224112708"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>由此可以知道，我们这个请求的信息如下：&lt;/p>
&lt;ul>
&lt;li>请求方式：POST&lt;/li>
&lt;li>请求路径：/hotel/list&lt;/li>
&lt;li>请求参数：JSON对象，包含4个字段：
&lt;ul>
&lt;li>key：搜索关键字&lt;/li>
&lt;li>page：页码&lt;/li>
&lt;li>size：每页大小&lt;/li>
&lt;li>sortBy：排序，目前暂不实现&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>返回值：分页查询，需要返回分页结果PageResult，包含两个属性：
&lt;ul>
&lt;li>&lt;code>total&lt;/code>：总条数&lt;/li>
&lt;li>&lt;code>List&amp;lt;HotelDoc&amp;gt;&lt;/code>：当前页的数据&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>因此，我们实现业务的流程如下：&lt;/p>
&lt;ul>
&lt;li>步骤一：定义实体类，接收请求参数的JSON对象&lt;/li>
&lt;li>步骤二：编写controller，接收页面的请求&lt;/li>
&lt;li>步骤三：编写业务实现，利用RestHighLevelClient实现搜索、分页&lt;/li>
&lt;/ul>
&lt;h3 id="412定义实体类">
&lt;a href="#412%e5%ae%9a%e4%b9%89%e5%ae%9e%e4%bd%93%e7%b1%bb" class="header-anchor">#&lt;/a>
4.1.2.定义实体类
&lt;/h3>&lt;p>实体类有两个，一个是前端的请求参数实体，一个是服务端应该返回的响应结果实体。&lt;/p>
&lt;p>1）请求参数&lt;/p>
&lt;p>前端请求的json结构如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-22-1">&lt;a class="lnlinks" href="#hl-22-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-2">&lt;a class="lnlinks" href="#hl-22-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-3">&lt;a class="lnlinks" href="#hl-22-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-4">&lt;a class="lnlinks" href="#hl-22-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-5">&lt;a class="lnlinks" href="#hl-22-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-6">&lt;a class="lnlinks" href="#hl-22-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;key&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;搜索关键字&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;page&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;sortBy&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;default&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>因此，我们在&lt;code>cn.itcast.hotel.pojo&lt;/code>包下定义一个实体类：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-23-1">&lt;a class="lnlinks" href="#hl-23-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-2">&lt;a class="lnlinks" href="#hl-23-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-3">&lt;a class="lnlinks" href="#hl-23-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-4">&lt;a class="lnlinks" href="#hl-23-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-5">&lt;a class="lnlinks" href="#hl-23-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-6">&lt;a class="lnlinks" href="#hl-23-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-7">&lt;a class="lnlinks" href="#hl-23-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-8">&lt;a class="lnlinks" href="#hl-23-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-9">&lt;a class="lnlinks" href="#hl-23-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-10">&lt;a class="lnlinks" href="#hl-23-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-23-11">&lt;a class="lnlinks" href="#hl-23-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.pojo&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.Data&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Data&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">RequestParams&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">page&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sortBy&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）返回值&lt;/p>
&lt;p>分页查询，需要返回分页结果PageResult，包含两个属性：&lt;/p>
&lt;ul>
&lt;li>&lt;code>total&lt;/code>：总条数&lt;/li>
&lt;li>&lt;code>List&amp;lt;HotelDoc&amp;gt;&lt;/code>：当前页的数据&lt;/li>
&lt;/ul>
&lt;p>因此，我们在&lt;code>cn.itcast.hotel.pojo&lt;/code>中定义返回结果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-24-1">&lt;a class="lnlinks" href="#hl-24-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-2">&lt;a class="lnlinks" href="#hl-24-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-3">&lt;a class="lnlinks" href="#hl-24-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-4">&lt;a class="lnlinks" href="#hl-24-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-5">&lt;a class="lnlinks" href="#hl-24-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-6">&lt;a class="lnlinks" href="#hl-24-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-7">&lt;a class="lnlinks" href="#hl-24-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-8">&lt;a class="lnlinks" href="#hl-24-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-9">&lt;a class="lnlinks" href="#hl-24-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-10">&lt;a class="lnlinks" href="#hl-24-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-11">&lt;a class="lnlinks" href="#hl-24-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-12">&lt;a class="lnlinks" href="#hl-24-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-13">&lt;a class="lnlinks" href="#hl-24-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-14">&lt;a class="lnlinks" href="#hl-24-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-15">&lt;a class="lnlinks" href="#hl-24-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-16">&lt;a class="lnlinks" href="#hl-24-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-17">&lt;a class="lnlinks" href="#hl-24-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-18">&lt;a class="lnlinks" href="#hl-24-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-19">&lt;a class="lnlinks" href="#hl-24-19">19&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.pojo&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.Data&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.util.List&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Data&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">PageResult&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotels&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">PageResult&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">PageResult&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotels&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">hotels&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotels&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="413定义controller">
&lt;a href="#413%e5%ae%9a%e4%b9%89controller" class="header-anchor">#&lt;/a>
4.1.3.定义controller
&lt;/h3>&lt;p>定义一个HotelController，声明查询接口，满足下列要求：&lt;/p>
&lt;ul>
&lt;li>请求方式：Post&lt;/li>
&lt;li>请求路径：/hotel/list&lt;/li>
&lt;li>请求参数：对象，类型为RequestParam&lt;/li>
&lt;li>返回值：PageResult，包含两个属性
&lt;ul>
&lt;li>&lt;code>Long total&lt;/code>：总条数&lt;/li>
&lt;li>&lt;code>List&amp;lt;HotelDoc&amp;gt; hotels&lt;/code>：酒店数据&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>因此，我们在&lt;code>cn.itcast.hotel.web&lt;/code>中定义HotelController：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-25-1">&lt;a class="lnlinks" href="#hl-25-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-2">&lt;a class="lnlinks" href="#hl-25-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-3">&lt;a class="lnlinks" href="#hl-25-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-4">&lt;a class="lnlinks" href="#hl-25-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-5">&lt;a class="lnlinks" href="#hl-25-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-6">&lt;a class="lnlinks" href="#hl-25-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-7">&lt;a class="lnlinks" href="#hl-25-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-8">&lt;a class="lnlinks" href="#hl-25-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-9">&lt;a class="lnlinks" href="#hl-25-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-10">&lt;a class="lnlinks" href="#hl-25-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-11">&lt;a class="lnlinks" href="#hl-25-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-12">&lt;a class="lnlinks" href="#hl-25-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RestController&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@RequestMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/hotel&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">HotelController&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IHotelService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 搜索酒店数据&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@PostMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/list&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PageResult&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nd">@RequestBody&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestParams&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="414实现搜索业务">
&lt;a href="#414%e5%ae%9e%e7%8e%b0%e6%90%9c%e7%b4%a2%e4%b8%9a%e5%8a%a1" class="header-anchor">#&lt;/a>
4.1.4.实现搜索业务
&lt;/h3>&lt;p>我们在controller调用了IHotelService，并没有实现该方法，因此下面我们就在IHotelService中定义方法，并且去实现业务逻辑。&lt;/p>
&lt;p>1）在&lt;code>cn.itcast.hotel.service&lt;/code>中的&lt;code>IHotelService&lt;/code>接口中定义一个方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-26-1">&lt;a class="lnlinks" href="#hl-26-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-2">&lt;a class="lnlinks" href="#hl-26-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-3">&lt;a class="lnlinks" href="#hl-26-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-4">&lt;a class="lnlinks" href="#hl-26-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-5">&lt;a class="lnlinks" href="#hl-26-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-26-6">&lt;a class="lnlinks" href="#hl-26-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 根据关键字搜索酒店信息
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param params 请求参数对象，包含用户输入的关键字
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @return 酒店文档列表
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">PageResult&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RequestParams&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）实现搜索业务，肯定离不开RestHighLevelClient，我们需要把它注册到Spring中作为一个Bean。在&lt;code>cn.itcast.hotel&lt;/code>中的&lt;code>HotelDemoApplication&lt;/code>中声明这个Bean：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-27-1">&lt;a class="lnlinks" href="#hl-27-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-2">&lt;a class="lnlinks" href="#hl-27-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-3">&lt;a class="lnlinks" href="#hl-27-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-4">&lt;a class="lnlinks" href="#hl-27-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-5">&lt;a class="lnlinks" href="#hl-27-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-27-6">&lt;a class="lnlinks" href="#hl-27-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RestHighLevelClient&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">client&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RestHighLevelClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RestClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HttpHost&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://192.168.150.101:9200&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）在&lt;code>cn.itcast.hotel.service.impl&lt;/code>中的&lt;code>HotelService&lt;/code>中实现search方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-28-1">&lt;a class="lnlinks" href="#hl-28-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-2">&lt;a class="lnlinks" href="#hl-28-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-3">&lt;a class="lnlinks" href="#hl-28-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-4">&lt;a class="lnlinks" href="#hl-28-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-5">&lt;a class="lnlinks" href="#hl-28-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-6">&lt;a class="lnlinks" href="#hl-28-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-7">&lt;a class="lnlinks" href="#hl-28-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-8">&lt;a class="lnlinks" href="#hl-28-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-9">&lt;a class="lnlinks" href="#hl-28-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-10">&lt;a class="lnlinks" href="#hl-28-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-11">&lt;a class="lnlinks" href="#hl-28-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-12">&lt;a class="lnlinks" href="#hl-28-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-13">&lt;a class="lnlinks" href="#hl-28-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-14">&lt;a class="lnlinks" href="#hl-28-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-15">&lt;a class="lnlinks" href="#hl-28-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-16">&lt;a class="lnlinks" href="#hl-28-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-17">&lt;a class="lnlinks" href="#hl-28-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-18">&lt;a class="lnlinks" href="#hl-28-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-19">&lt;a class="lnlinks" href="#hl-28-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-20">&lt;a class="lnlinks" href="#hl-28-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-21">&lt;a class="lnlinks" href="#hl-28-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-22">&lt;a class="lnlinks" href="#hl-28-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-23">&lt;a class="lnlinks" href="#hl-28-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-24">&lt;a class="lnlinks" href="#hl-28-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-25">&lt;a class="lnlinks" href="#hl-28-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-26">&lt;a class="lnlinks" href="#hl-28-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-27">&lt;a class="lnlinks" href="#hl-28-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-28">&lt;a class="lnlinks" href="#hl-28-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-29">&lt;a class="lnlinks" href="#hl-28-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-30">&lt;a class="lnlinks" href="#hl-28-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-31">&lt;a class="lnlinks" href="#hl-28-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-32">&lt;a class="lnlinks" href="#hl-28-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-33">&lt;a class="lnlinks" href="#hl-28-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-34">&lt;a class="lnlinks" href="#hl-28-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-35">&lt;a class="lnlinks" href="#hl-28-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-36">&lt;a class="lnlinks" href="#hl-28-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-37">&lt;a class="lnlinks" href="#hl-28-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-38">&lt;a class="lnlinks" href="#hl-28-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-39">&lt;a class="lnlinks" href="#hl-28-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-40">&lt;a class="lnlinks" href="#hl-28-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-41">&lt;a class="lnlinks" href="#hl-28-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-42">&lt;a class="lnlinks" href="#hl-28-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-43">&lt;a class="lnlinks" href="#hl-28-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-44">&lt;a class="lnlinks" href="#hl-28-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-45">&lt;a class="lnlinks" href="#hl-28-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-46">&lt;a class="lnlinks" href="#hl-28-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-47">&lt;a class="lnlinks" href="#hl-28-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-48">&lt;a class="lnlinks" href="#hl-28-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-28-49">&lt;a class="lnlinks" href="#hl-28-49">49&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PageResult&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RequestParams&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备DSL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.1.query&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">||&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchAllQuery&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;all&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.2.分页&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">page&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPage&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getSize&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">from&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">page&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.解析响应&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">handleResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuntimeException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">// 结果解析&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PageResult&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">handleResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SearchResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.解析响应&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchHits&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">searchHits&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getHits&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.1.获取总条数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">searchHits&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getTotalHits&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">value&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.2.文档数组&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchHit&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hits&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">searchHits&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getHits&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.3.遍历&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotels&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SearchHit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hits&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 获取文档source&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hit&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getSourceAsString&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 反序列化&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">JSON&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">parseObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 放入集合&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">hotels&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.4.封装返回&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PageResult&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotels&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="42酒店结果过滤">
&lt;a href="#42%e9%85%92%e5%ba%97%e7%bb%93%e6%9e%9c%e8%bf%87%e6%bb%a4" class="header-anchor">#&lt;/a>
4.2.酒店结果过滤
&lt;/h2>&lt;p>需求：添加品牌、城市、星级、价格等过滤功能&lt;/p>
&lt;h3 id="421需求分析">
&lt;a href="#421%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90" class="header-anchor">#&lt;/a>
4.2.1.需求分析
&lt;/h3>&lt;p>在页面搜索框下面，会有一些过滤项：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-f76c076056b800.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722091940726"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>传递的参数如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-e449f578109bb3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722092051994"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>包含的过滤条件有：&lt;/p>
&lt;ul>
&lt;li>brand：品牌值&lt;/li>
&lt;li>city：城市&lt;/li>
&lt;li>minPrice~maxPrice：价格范围&lt;/li>
&lt;li>starName：星级&lt;/li>
&lt;/ul>
&lt;p>我们需要做两件事情：&lt;/p>
&lt;ul>
&lt;li>修改请求参数的对象RequestParams，接收上述参数&lt;/li>
&lt;li>修改业务逻辑，在搜索条件之外，添加一些过滤条件&lt;/li>
&lt;/ul>
&lt;h3 id="422修改实体类">
&lt;a href="#422%e4%bf%ae%e6%94%b9%e5%ae%9e%e4%bd%93%e7%b1%bb" class="header-anchor">#&lt;/a>
4.2.2.修改实体类
&lt;/h3>&lt;p>修改在&lt;code>cn.itcast.hotel.pojo&lt;/code>包下的实体类RequestParams：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-29-1">&lt;a class="lnlinks" href="#hl-29-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-2">&lt;a class="lnlinks" href="#hl-29-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-3">&lt;a class="lnlinks" href="#hl-29-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-4">&lt;a class="lnlinks" href="#hl-29-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-5">&lt;a class="lnlinks" href="#hl-29-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-6">&lt;a class="lnlinks" href="#hl-29-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-7">&lt;a class="lnlinks" href="#hl-29-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-8">&lt;a class="lnlinks" href="#hl-29-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-9">&lt;a class="lnlinks" href="#hl-29-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-10">&lt;a class="lnlinks" href="#hl-29-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-11">&lt;a class="lnlinks" href="#hl-29-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-12">&lt;a class="lnlinks" href="#hl-29-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-29-13">&lt;a class="lnlinks" href="#hl-29-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Data&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">RequestParams&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">page&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sortBy&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 下面是新增的过滤条件参数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">city&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brand&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">starName&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">minPrice&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">maxPrice&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="423修改搜索业务">
&lt;a href="#423%e4%bf%ae%e6%94%b9%e6%90%9c%e7%b4%a2%e4%b8%9a%e5%8a%a1" class="header-anchor">#&lt;/a>
4.2.3.修改搜索业务
&lt;/h3>&lt;p>在HotelService的search方法中，只有一个地方需要修改：requet.source().query( &amp;hellip; )其中的查询条件。&lt;/p>
&lt;p>在之前的业务中，只有match查询，根据关键字搜索，现在要添加条件过滤，包括：&lt;/p>
&lt;ul>
&lt;li>品牌过滤：是keyword类型，用term查询&lt;/li>
&lt;li>星级过滤：是keyword类型，用term查询&lt;/li>
&lt;li>价格过滤：是数值类型，用range查询&lt;/li>
&lt;li>城市过滤：是keyword类型，用term查询&lt;/li>
&lt;/ul>
&lt;p>多个查询条件组合，肯定是boolean查询来组合：&lt;/p>
&lt;ul>
&lt;li>关键字搜索放到must中，参与算分&lt;/li>
&lt;li>其它过滤条件放到filter中，不参与算分&lt;/li>
&lt;/ul>
&lt;p>因为条件构建的逻辑比较复杂，这里先封装为一个函数：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-53f1a31ba26d5d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722092935453"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>buildBasicQuery的代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-30-1">&lt;a class="lnlinks" href="#hl-30-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-2">&lt;a class="lnlinks" href="#hl-30-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-3">&lt;a class="lnlinks" href="#hl-30-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-4">&lt;a class="lnlinks" href="#hl-30-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-5">&lt;a class="lnlinks" href="#hl-30-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-6">&lt;a class="lnlinks" href="#hl-30-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-7">&lt;a class="lnlinks" href="#hl-30-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-8">&lt;a class="lnlinks" href="#hl-30-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-9">&lt;a class="lnlinks" href="#hl-30-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-10">&lt;a class="lnlinks" href="#hl-30-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-11">&lt;a class="lnlinks" href="#hl-30-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-12">&lt;a class="lnlinks" href="#hl-30-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-13">&lt;a class="lnlinks" href="#hl-30-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-14">&lt;a class="lnlinks" href="#hl-30-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-15">&lt;a class="lnlinks" href="#hl-30-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-16">&lt;a class="lnlinks" href="#hl-30-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-17">&lt;a class="lnlinks" href="#hl-30-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-18">&lt;a class="lnlinks" href="#hl-30-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-19">&lt;a class="lnlinks" href="#hl-30-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-20">&lt;a class="lnlinks" href="#hl-30-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-21">&lt;a class="lnlinks" href="#hl-30-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-22">&lt;a class="lnlinks" href="#hl-30-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-23">&lt;a class="lnlinks" href="#hl-30-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-24">&lt;a class="lnlinks" href="#hl-30-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-25">&lt;a class="lnlinks" href="#hl-30-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-26">&lt;a class="lnlinks" href="#hl-30-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-27">&lt;a class="lnlinks" href="#hl-30-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-28">&lt;a class="lnlinks" href="#hl-30-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-29">&lt;a class="lnlinks" href="#hl-30-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-30">&lt;a class="lnlinks" href="#hl-30-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-31">&lt;a class="lnlinks" href="#hl-30-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-32">&lt;a class="lnlinks" href="#hl-30-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-30-33">&lt;a class="lnlinks" href="#hl-30-33">33&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">buildBasicQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RequestParams&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.构建BooleanQuery&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">BoolQueryBuilder&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">boolQuery&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.关键字搜索&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">||&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchAllQuery&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;all&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.城市条件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCity&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCity&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">termQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;city&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCity&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.品牌条件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBrand&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBrand&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">termQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;brand&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBrand&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 5.星级条件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getStarName&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getStarName&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">termQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;starName&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getStarName&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 6.价格&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMinPrice&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMaxPrice&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">rangeQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;price&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">gte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMinPrice&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">lte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMaxPrice&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 7.放入source&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="43我周边的酒店">
&lt;a href="#43%e6%88%91%e5%91%a8%e8%be%b9%e7%9a%84%e9%85%92%e5%ba%97" class="header-anchor">#&lt;/a>
4.3.我周边的酒店
&lt;/h2>&lt;p>需求：我附近的酒店&lt;/p>
&lt;h3 id="431需求分析">
&lt;a href="#431%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90" class="header-anchor">#&lt;/a>
4.3.1.需求分析
&lt;/h3>&lt;p>在酒店列表页的右侧，有一个小地图，点击地图的定位按钮，地图会找到你所在的位置：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-c9a9887b67d72d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722093414542"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>并且，在前端会发起查询请求，将你的坐标发送到服务端：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-ce3ed150b15da1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722093642382"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们要做的事情就是基于这个location坐标，然后按照距离对周围酒店排序。实现思路如下：&lt;/p>
&lt;ul>
&lt;li>修改RequestParams参数，接收location字段&lt;/li>
&lt;li>修改search方法业务逻辑，如果location有值，添加根据geo_distance排序的功能&lt;/li>
&lt;/ul>
&lt;h3 id="432修改实体类">
&lt;a href="#432%e4%bf%ae%e6%94%b9%e5%ae%9e%e4%bd%93%e7%b1%bb" class="header-anchor">#&lt;/a>
4.3.2.修改实体类
&lt;/h3>&lt;p>修改在&lt;code>cn.itcast.hotel.pojo&lt;/code>包下的实体类RequestParams：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-31-1">&lt;a class="lnlinks" href="#hl-31-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-2">&lt;a class="lnlinks" href="#hl-31-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-3">&lt;a class="lnlinks" href="#hl-31-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-4">&lt;a class="lnlinks" href="#hl-31-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-5">&lt;a class="lnlinks" href="#hl-31-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-6">&lt;a class="lnlinks" href="#hl-31-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-7">&lt;a class="lnlinks" href="#hl-31-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-8">&lt;a class="lnlinks" href="#hl-31-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-9">&lt;a class="lnlinks" href="#hl-31-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-10">&lt;a class="lnlinks" href="#hl-31-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-11">&lt;a class="lnlinks" href="#hl-31-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-12">&lt;a class="lnlinks" href="#hl-31-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-13">&lt;a class="lnlinks" href="#hl-31-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-14">&lt;a class="lnlinks" href="#hl-31-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-15">&lt;a class="lnlinks" href="#hl-31-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-16">&lt;a class="lnlinks" href="#hl-31-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-17">&lt;a class="lnlinks" href="#hl-31-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-31-18">&lt;a class="lnlinks" href="#hl-31-18">18&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.pojo&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.Data&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Data&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">RequestParams&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">page&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sortBy&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">city&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brand&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">starName&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">minPrice&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">maxPrice&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 我当前的地理坐标&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">location&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="433距离排序api">
&lt;a href="#433%e8%b7%9d%e7%a6%bb%e6%8e%92%e5%ba%8fapi" class="header-anchor">#&lt;/a>
4.3.3.距离排序API
&lt;/h3>&lt;p>我们以前学习过排序功能，包括两种：&lt;/p>
&lt;ul>
&lt;li>普通字段排序&lt;/li>
&lt;li>地理坐标排序&lt;/li>
&lt;/ul>
&lt;p>我们只讲了普通字段排序对应的java写法。地理坐标排序只学过DSL语法，如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-32-1">&lt;a class="lnlinks" href="#hl-32-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-2">&lt;a class="lnlinks" href="#hl-32-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-3">&lt;a class="lnlinks" href="#hl-32-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-4">&lt;a class="lnlinks" href="#hl-32-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-5">&lt;a class="lnlinks" href="#hl-32-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-6">&lt;a class="lnlinks" href="#hl-32-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-7">&lt;a class="lnlinks" href="#hl-32-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-8">&lt;a class="lnlinks" href="#hl-32-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-9">&lt;a class="lnlinks" href="#hl-32-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-10">&lt;a class="lnlinks" href="#hl-32-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-11">&lt;a class="lnlinks" href="#hl-32-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-12">&lt;a class="lnlinks" href="#hl-32-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-13">&lt;a class="lnlinks" href="#hl-32-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-14">&lt;a class="lnlinks" href="#hl-32-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-15">&lt;a class="lnlinks" href="#hl-32-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-16">&lt;a class="lnlinks" href="#hl-32-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-17">&lt;a class="lnlinks" href="#hl-32-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-32-18">&lt;a class="lnlinks" href="#hl-32-18">18&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/indexName/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;match_all&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;sort&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;price&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;asc&amp;#34;&lt;/span>  
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;_geo_distance&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;FIELD&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;纬度，经度&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;order&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;asc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;unit&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;km&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>对应的java代码示例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-71acc7a1b7cf24.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722095227059"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="434添加距离排序">
&lt;a href="#434%e6%b7%bb%e5%8a%a0%e8%b7%9d%e7%a6%bb%e6%8e%92%e5%ba%8f" class="header-anchor">#&lt;/a>
4.3.4.添加距离排序
&lt;/h3>&lt;p>在&lt;code>cn.itcast.hotel.service.impl&lt;/code>的&lt;code>HotelService&lt;/code>的&lt;code>search&lt;/code>方法中，添加一个排序功能：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-7a4d270bd6ae61.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722095902314"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>完整代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-33-1">&lt;a class="lnlinks" href="#hl-33-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-2">&lt;a class="lnlinks" href="#hl-33-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-3">&lt;a class="lnlinks" href="#hl-33-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-4">&lt;a class="lnlinks" href="#hl-33-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-5">&lt;a class="lnlinks" href="#hl-33-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-6">&lt;a class="lnlinks" href="#hl-33-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-7">&lt;a class="lnlinks" href="#hl-33-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-8">&lt;a class="lnlinks" href="#hl-33-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-9">&lt;a class="lnlinks" href="#hl-33-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-10">&lt;a class="lnlinks" href="#hl-33-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-11">&lt;a class="lnlinks" href="#hl-33-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-12">&lt;a class="lnlinks" href="#hl-33-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-13">&lt;a class="lnlinks" href="#hl-33-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-14">&lt;a class="lnlinks" href="#hl-33-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-15">&lt;a class="lnlinks" href="#hl-33-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-16">&lt;a class="lnlinks" href="#hl-33-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-17">&lt;a class="lnlinks" href="#hl-33-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-18">&lt;a class="lnlinks" href="#hl-33-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-19">&lt;a class="lnlinks" href="#hl-33-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-20">&lt;a class="lnlinks" href="#hl-33-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-21">&lt;a class="lnlinks" href="#hl-33-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-22">&lt;a class="lnlinks" href="#hl-33-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-23">&lt;a class="lnlinks" href="#hl-33-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-24">&lt;a class="lnlinks" href="#hl-33-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-25">&lt;a class="lnlinks" href="#hl-33-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-26">&lt;a class="lnlinks" href="#hl-33-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-27">&lt;a class="lnlinks" href="#hl-33-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-28">&lt;a class="lnlinks" href="#hl-33-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-29">&lt;a class="lnlinks" href="#hl-33-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-30">&lt;a class="lnlinks" href="#hl-33-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-31">&lt;a class="lnlinks" href="#hl-33-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-33-32">&lt;a class="lnlinks" href="#hl-33-32">32&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PageResult&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RequestParams&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备DSL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.1.query&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">buildBasicQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.2.分页&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">page&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPage&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getSize&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">from&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">page&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.3.排序&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">location&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLocation&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">location&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">location&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">sort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SortBuilders&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">geoDistanceSort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;location&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">GeoPoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">location&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">order&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SortOrder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">ASC&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">unit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DistanceUnit&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">KILOMETERS&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.解析响应&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">handleResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuntimeException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="435排序距离显示">
&lt;a href="#435%e6%8e%92%e5%ba%8f%e8%b7%9d%e7%a6%bb%e6%98%be%e7%a4%ba" class="header-anchor">#&lt;/a>
4.3.5.排序距离显示
&lt;/h3>&lt;p>重启服务后，测试我的酒店功能：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-4dd3e5cfd3909c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722100040674"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>发现确实可以实现对我附近酒店的排序，不过并没有看到酒店到底距离我多远，这该怎么办？&lt;/p>
&lt;p>排序完成后，页面还要获取我附近每个酒店的具体&lt;strong>距离&lt;/strong>值，这个值在响应结果中是独立的：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-aa5dcc074e4b25.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722095648542"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>因此，我们在结果解析阶段，除了解析source部分以外，还要得到sort部分，也就是排序的距离，然后放到响应结果中。&lt;/p>
&lt;p>我们要做两件事：&lt;/p>
&lt;ul>
&lt;li>修改HotelDoc，添加排序距离字段，用于页面显示&lt;/li>
&lt;li>修改HotelService类中的handleResponse方法，添加对sort值的获取&lt;/li>
&lt;/ul>
&lt;p>1）修改HotelDoc类，添加距离字段&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-34-1">&lt;a class="lnlinks" href="#hl-34-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-2">&lt;a class="lnlinks" href="#hl-34-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-3">&lt;a class="lnlinks" href="#hl-34-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-4">&lt;a class="lnlinks" href="#hl-34-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-5">&lt;a class="lnlinks" href="#hl-34-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-6">&lt;a class="lnlinks" href="#hl-34-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-7">&lt;a class="lnlinks" href="#hl-34-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-8">&lt;a class="lnlinks" href="#hl-34-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-9">&lt;a class="lnlinks" href="#hl-34-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-10">&lt;a class="lnlinks" href="#hl-34-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-11">&lt;a class="lnlinks" href="#hl-34-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-12">&lt;a class="lnlinks" href="#hl-34-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-13">&lt;a class="lnlinks" href="#hl-34-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-14">&lt;a class="lnlinks" href="#hl-34-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-15">&lt;a class="lnlinks" href="#hl-34-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-16">&lt;a class="lnlinks" href="#hl-34-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-17">&lt;a class="lnlinks" href="#hl-34-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-18">&lt;a class="lnlinks" href="#hl-34-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-19">&lt;a class="lnlinks" href="#hl-34-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-20">&lt;a class="lnlinks" href="#hl-34-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-21">&lt;a class="lnlinks" href="#hl-34-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-22">&lt;a class="lnlinks" href="#hl-34-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-23">&lt;a class="lnlinks" href="#hl-34-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-24">&lt;a class="lnlinks" href="#hl-34-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-25">&lt;a class="lnlinks" href="#hl-34-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-26">&lt;a class="lnlinks" href="#hl-34-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-27">&lt;a class="lnlinks" href="#hl-34-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-28">&lt;a class="lnlinks" href="#hl-34-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-29">&lt;a class="lnlinks" href="#hl-34-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-30">&lt;a class="lnlinks" href="#hl-34-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-31">&lt;a class="lnlinks" href="#hl-34-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-32">&lt;a class="lnlinks" href="#hl-34-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-33">&lt;a class="lnlinks" href="#hl-34-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-34">&lt;a class="lnlinks" href="#hl-34-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-35">&lt;a class="lnlinks" href="#hl-34-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-36">&lt;a class="lnlinks" href="#hl-34-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-34-37">&lt;a class="lnlinks" href="#hl-34-37">37&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.pojo&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.Data&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.NoArgsConstructor&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Data&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@NoArgsConstructor&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">HotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">address&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">score&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brand&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">city&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">starName&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">business&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">location&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pic&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 排序时的 距离值&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">distance&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">HotelDoc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Hotel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">address&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getAddress&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">price&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPrice&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">score&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getScore&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">brand&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBrand&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">city&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCity&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">starName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getStarName&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">business&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBusiness&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">location&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLatitude&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;, &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLongitude&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">pic&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPic&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）修改HotelService中的handleResponse方法&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-6eac87b0722d76.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722100613966"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>重启后测试，发现页面能成功显示距离了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-82603182bcd0ff.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722100838604"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="44酒店竞价排名">
&lt;a href="#44%e9%85%92%e5%ba%97%e7%ab%9e%e4%bb%b7%e6%8e%92%e5%90%8d" class="header-anchor">#&lt;/a>
4.4.酒店竞价排名
&lt;/h2>&lt;p>需求：让指定的酒店在搜索结果中排名置顶&lt;/p>
&lt;h3 id="441需求分析">
&lt;a href="#441%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90" class="header-anchor">#&lt;/a>
4.4.1.需求分析
&lt;/h3>&lt;p>要让指定酒店在搜索结果中排名置顶，效果如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-8613370421e84a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722100947292"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>页面会给指定的酒店添加&lt;strong>广告&lt;/strong>标记。&lt;/p>
&lt;p>那怎样才能让指定的酒店排名置顶呢？&lt;/p>
&lt;p>我们之前学习过的function_score查询可以影响算分，算分高了，自然排名也就高了。而function_score包含3个要素：&lt;/p>
&lt;ul>
&lt;li>过滤条件：哪些文档要加分&lt;/li>
&lt;li>算分函数：如何计算function score&lt;/li>
&lt;li>加权方式：function score 与 query score如何运算&lt;/li>
&lt;/ul>
&lt;p>这里的需求是：让&lt;strong>指定酒店&lt;/strong>排名靠前。因此我们需要给这些酒店添加一个标记，这样在过滤条件中就可以&lt;strong>根据这个标记来判断，是否要提高算分&lt;/strong>。&lt;/p>
&lt;p>比如，我们给酒店添加一个字段：isAD，Boolean类型：&lt;/p>
&lt;ul>
&lt;li>true：是广告&lt;/li>
&lt;li>false：不是广告&lt;/li>
&lt;/ul>
&lt;p>这样function_score包含3个要素就很好确定了：&lt;/p>
&lt;ul>
&lt;li>过滤条件：判断isAD 是否为true&lt;/li>
&lt;li>算分函数：我们可以用最简单暴力的weight，固定加权值&lt;/li>
&lt;li>加权方式：可以用默认的相乘，大大提高算分&lt;/li>
&lt;/ul>
&lt;p>因此，业务的实现步骤包括：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>给HotelDoc类添加isAD字段，Boolean类型&lt;/p>
&lt;/li>
&lt;li>
&lt;p>挑选几个你喜欢的酒店，给它的文档数据添加isAD字段，值为true&lt;/p>
&lt;/li>
&lt;li>
&lt;p>修改search方法，添加function score功能，给isAD值为true的酒店增加权重&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="442修改hoteldoc实体">
&lt;a href="#442%e4%bf%ae%e6%94%b9hoteldoc%e5%ae%9e%e4%bd%93" class="header-anchor">#&lt;/a>
4.4.2.修改HotelDoc实体
&lt;/h3>&lt;p>给&lt;code>cn.itcast.hotel.pojo&lt;/code>包下的HotelDoc类添加isAD字段：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-095622e656f897.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722101908062"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="443添加广告标记">
&lt;a href="#443%e6%b7%bb%e5%8a%a0%e5%b9%bf%e5%91%8a%e6%a0%87%e8%ae%b0" class="header-anchor">#&lt;/a>
4.4.3.添加广告标记
&lt;/h3>&lt;p>接下来，我们挑几个酒店，添加isAD字段，设置为true：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-35-1">&lt;a class="lnlinks" href="#hl-35-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-2">&lt;a class="lnlinks" href="#hl-35-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-3">&lt;a class="lnlinks" href="#hl-35-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-4">&lt;a class="lnlinks" href="#hl-35-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-5">&lt;a class="lnlinks" href="#hl-35-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-6">&lt;a class="lnlinks" href="#hl-35-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-7">&lt;a class="lnlinks" href="#hl-35-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-8">&lt;a class="lnlinks" href="#hl-35-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-9">&lt;a class="lnlinks" href="#hl-35-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-10">&lt;a class="lnlinks" href="#hl-35-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-11">&lt;a class="lnlinks" href="#hl-35-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-12">&lt;a class="lnlinks" href="#hl-35-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-13">&lt;a class="lnlinks" href="#hl-35-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-14">&lt;a class="lnlinks" href="#hl-35-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-15">&lt;a class="lnlinks" href="#hl-35-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-16">&lt;a class="lnlinks" href="#hl-35-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-17">&lt;a class="lnlinks" href="#hl-35-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-18">&lt;a class="lnlinks" href="#hl-35-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-19">&lt;a class="lnlinks" href="#hl-35-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-20">&lt;a class="lnlinks" href="#hl-35-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-21">&lt;a class="lnlinks" href="#hl-35-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-22">&lt;a class="lnlinks" href="#hl-35-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-23">&lt;a class="lnlinks" href="#hl-35-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-35-24">&lt;a class="lnlinks" href="#hl-35-24">24&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">/hotel/_update/&lt;/span>&lt;span class="mi">1902197537&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;doc&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;isAD&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">/hotel/_update/&lt;/span>&lt;span class="mi">2056126831&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;doc&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;isAD&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">/hotel/_update/&lt;/span>&lt;span class="mi">1989806195&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;doc&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;isAD&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">/hotel/_update/&lt;/span>&lt;span class="mi">2056105938&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;doc&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;isAD&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="444添加算分函数查询">
&lt;a href="#444%e6%b7%bb%e5%8a%a0%e7%ae%97%e5%88%86%e5%87%bd%e6%95%b0%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
4.4.4.添加算分函数查询
&lt;/h3>&lt;p>接下来我们就要修改查询条件了。之前是用的boolean 查询，现在要改成function_socre查询。&lt;/p>
&lt;p>function_score查询结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-9d40afc830a1df.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210721191544750"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>对应的JavaAPI如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738250-15dbf853a346a3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210722102850818"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们可以将之前写的boolean查询作为&lt;strong>原始查询&lt;/strong>条件放到query中，接下来就是添加&lt;strong>过滤条件&lt;/strong>、&lt;strong>算分函数&lt;/strong>、&lt;strong>加权模式&lt;/strong>了。所以原来的代码依然可以沿用。&lt;/p>
&lt;p>修改&lt;code>cn.itcast.hotel.service.impl&lt;/code>包下的&lt;code>HotelService&lt;/code>类中的&lt;code>buildBasicQuery&lt;/code>方法，添加算分函数查询：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-36-1">&lt;a class="lnlinks" href="#hl-36-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-2">&lt;a class="lnlinks" href="#hl-36-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-3">&lt;a class="lnlinks" href="#hl-36-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-4">&lt;a class="lnlinks" href="#hl-36-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-5">&lt;a class="lnlinks" href="#hl-36-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-6">&lt;a class="lnlinks" href="#hl-36-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-7">&lt;a class="lnlinks" href="#hl-36-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-8">&lt;a class="lnlinks" href="#hl-36-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-9">&lt;a class="lnlinks" href="#hl-36-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-10">&lt;a class="lnlinks" href="#hl-36-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-11">&lt;a class="lnlinks" href="#hl-36-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-12">&lt;a class="lnlinks" href="#hl-36-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-13">&lt;a class="lnlinks" href="#hl-36-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-14">&lt;a class="lnlinks" href="#hl-36-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-15">&lt;a class="lnlinks" href="#hl-36-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-16">&lt;a class="lnlinks" href="#hl-36-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-17">&lt;a class="lnlinks" href="#hl-36-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-18">&lt;a class="lnlinks" href="#hl-36-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-19">&lt;a class="lnlinks" href="#hl-36-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-20">&lt;a class="lnlinks" href="#hl-36-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-21">&lt;a class="lnlinks" href="#hl-36-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-22">&lt;a class="lnlinks" href="#hl-36-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-23">&lt;a class="lnlinks" href="#hl-36-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-24">&lt;a class="lnlinks" href="#hl-36-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-25">&lt;a class="lnlinks" href="#hl-36-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-26">&lt;a class="lnlinks" href="#hl-36-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-27">&lt;a class="lnlinks" href="#hl-36-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-28">&lt;a class="lnlinks" href="#hl-36-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-29">&lt;a class="lnlinks" href="#hl-36-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-30">&lt;a class="lnlinks" href="#hl-36-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-31">&lt;a class="lnlinks" href="#hl-36-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-32">&lt;a class="lnlinks" href="#hl-36-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-33">&lt;a class="lnlinks" href="#hl-36-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-34">&lt;a class="lnlinks" href="#hl-36-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-35">&lt;a class="lnlinks" href="#hl-36-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-36">&lt;a class="lnlinks" href="#hl-36-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-37">&lt;a class="lnlinks" href="#hl-36-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-38">&lt;a class="lnlinks" href="#hl-36-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-39">&lt;a class="lnlinks" href="#hl-36-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-40">&lt;a class="lnlinks" href="#hl-36-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-41">&lt;a class="lnlinks" href="#hl-36-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-42">&lt;a class="lnlinks" href="#hl-36-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-43">&lt;a class="lnlinks" href="#hl-36-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-44">&lt;a class="lnlinks" href="#hl-36-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-45">&lt;a class="lnlinks" href="#hl-36-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-46">&lt;a class="lnlinks" href="#hl-36-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-47">&lt;a class="lnlinks" href="#hl-36-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-36-48">&lt;a class="lnlinks" href="#hl-36-48">48&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">buildBasicQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RequestParams&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.构建BooleanQuery&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">BoolQueryBuilder&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">boolQuery&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 关键字搜索&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">||&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchAllQuery&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">matchQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;all&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 城市条件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCity&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCity&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">termQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;city&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCity&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 品牌条件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBrand&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBrand&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">termQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;brand&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBrand&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 星级条件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getStarName&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getStarName&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">termQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;starName&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getStarName&lt;/span>&lt;span class="p">()));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 价格&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMinPrice&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&amp;amp;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMaxPrice&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">rangeQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;price&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">gte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMinPrice&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">lte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getMaxPrice&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.算分控制&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">FunctionScoreQueryBuilder&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">functionScoreQuery&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">functionScoreQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 原始查询，相关性算分的查询&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">boolQuery&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// function score的数组&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FunctionScoreQueryBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">FilterFunctionBuilder&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 其中的一个function score 元素&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FunctionScoreQueryBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">FilterFunctionBuilder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 过滤条件&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">QueryBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">termQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;isAD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 算分函数&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ScoreFunctionBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">weightFactorFunction&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">});&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">functionScoreQuery&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>7.分布式搜索引擎03</title><link>https://logan.wssw.fun/p/2023/01/73491673/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/73491673/</guid><description>&lt;h1 id="分布式搜索引擎03">
&lt;a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e6%90%9c%e7%b4%a2%e5%bc%95%e6%93%8e03" class="header-anchor">#&lt;/a>
分布式搜索引擎03
&lt;/h1>&lt;h1 id="0学习目标">
&lt;a href="#0%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87" class="header-anchor">#&lt;/a>
0.学习目标
&lt;/h1>&lt;h1 id="1数据聚合">
&lt;a href="#1%e6%95%b0%e6%8d%ae%e8%81%9a%e5%90%88" class="header-anchor">#&lt;/a>
1.数据聚合
&lt;/h1>&lt;p>**&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" target="_blank" rel="noopener"
>聚合（
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" target="_blank" rel="noopener"
>aggregations
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" target="_blank" rel="noopener"
>）
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>**可以让我们极其方便的实现对数据的统计、分析、运算。例如：&lt;/p>
&lt;ul>
&lt;li>什么品牌的手机最受欢迎？&lt;/li>
&lt;li>这些手机的平均价格、最高价格、最低价格？&lt;/li>
&lt;li>这些手机每月的销售情况如何？&lt;/li>
&lt;/ul>
&lt;p>实现这些统计功能的比数据库的sql要方便的多，而且查询速度非常快，可以实现近实时搜索效果。&lt;/p>
&lt;h2 id="11聚合的种类">
&lt;a href="#11%e8%81%9a%e5%90%88%e7%9a%84%e7%a7%8d%e7%b1%bb" class="header-anchor">#&lt;/a>
1.1.聚合的种类
&lt;/h2>&lt;p>聚合常见的有三类：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>**桶（Bucket）**聚合：用来对文档做分组&lt;/p>
&lt;ul>
&lt;li>TermAggregation：按照文档字段值分组，例如按照品牌值分组、按照国家分组&lt;/li>
&lt;li>Date Histogram：按照日期阶梯分组，例如一周为一组，或者一月为一组&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>**度量（Metric）**聚合：用以计算一些值，比如：最大值、最小值、平均值等&lt;/p>
&lt;ul>
&lt;li>Avg：求平均值&lt;/li>
&lt;li>Max：求最大值&lt;/li>
&lt;li>Min：求最小值&lt;/li>
&lt;li>Stats：同时求max、min、avg、sum等&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>**管道（pipeline）**聚合：其它聚合的结果为基础做聚合&lt;/p>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>**注意：**参加聚合的字段必须是keyword、日期、数值、布尔类型&lt;/p>
&lt;/blockquote>
&lt;h2 id="12dsl实现聚合">
&lt;a href="#12dsl%e5%ae%9e%e7%8e%b0%e8%81%9a%e5%90%88" class="header-anchor">#&lt;/a>
1.2.DSL实现聚合
&lt;/h2>&lt;p>现在，我们要统计所有数据中的酒店品牌有几种，其实就是按照品牌对数据分组。此时可以根据酒店品牌的名称做聚合，也就是Bucket聚合。&lt;/p>
&lt;h3 id="121bucket聚合语法">
&lt;a href="#121bucket%e8%81%9a%e5%90%88%e8%af%ad%e6%b3%95" class="header-anchor">#&lt;/a>
1.2.1.Bucket聚合语法
&lt;/h3>&lt;p>语法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-6">&lt;a class="lnlinks" href="#hl-0-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-7">&lt;a class="lnlinks" href="#hl-0-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-8">&lt;a class="lnlinks" href="#hl-0-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-9">&lt;a class="lnlinks" href="#hl-0-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-10">&lt;a class="lnlinks" href="#hl-0-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-11">&lt;a class="lnlinks" href="#hl-0-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-12">&lt;a class="lnlinks" href="#hl-0-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/hotel/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>  &lt;span class="c1">// 设置size为0，结果中不包含文档，只包含聚合结果
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>  &lt;span class="nt">&amp;#34;aggs&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// 定义聚合
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>    &lt;span class="nt">&amp;#34;brandAgg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//给聚合起个名字
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>      &lt;span class="nt">&amp;#34;terms&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// 聚合的类型，按照品牌值聚合，所以选择term
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>        &lt;span class="nt">&amp;#34;field&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;brand&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 参与聚合的字段
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>        &lt;span class="nt">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span> &lt;span class="c1">// 希望获取的聚合结果数量
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-5634a1a408d0ea.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723171948228"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="122聚合结果排序">
&lt;a href="#122%e8%81%9a%e5%90%88%e7%bb%93%e6%9e%9c%e6%8e%92%e5%ba%8f" class="header-anchor">#&lt;/a>
1.2.2.聚合结果排序
&lt;/h3>&lt;p>默认情况下，Bucket聚合会统计Bucket内的文档数量，记为_count，并且按照_count降序排序。&lt;/p>
&lt;p>我们可以指定order属性，自定义聚合的排序方式：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-9">&lt;a class="lnlinks" href="#hl-1-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-10">&lt;a class="lnlinks" href="#hl-1-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-11">&lt;a class="lnlinks" href="#hl-1-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-12">&lt;a class="lnlinks" href="#hl-1-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-13">&lt;a class="lnlinks" href="#hl-1-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-14">&lt;a class="lnlinks" href="#hl-1-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-15">&lt;a class="lnlinks" href="#hl-1-15">15&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/hotel/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> 
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;aggs&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;brandAgg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;terms&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;field&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;brand&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;order&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;_count&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;asc&amp;#34;&lt;/span> &lt;span class="c1">// 按照_count升序排列
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>        &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="123限定聚合范围">
&lt;a href="#123%e9%99%90%e5%ae%9a%e8%81%9a%e5%90%88%e8%8c%83%e5%9b%b4" class="header-anchor">#&lt;/a>
1.2.3.限定聚合范围
&lt;/h3>&lt;p>默认情况下，Bucket聚合是对索引库的所有文档做聚合，但真实场景下，用户会输入搜索条件，因此聚合必须是对搜索结果聚合。那么聚合必须添加限定条件。&lt;/p>
&lt;p>我们可以限定要聚合的文档范围，只要添加query条件即可：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-9">&lt;a class="lnlinks" href="#hl-2-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-10">&lt;a class="lnlinks" href="#hl-2-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-11">&lt;a class="lnlinks" href="#hl-2-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-12">&lt;a class="lnlinks" href="#hl-2-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-13">&lt;a class="lnlinks" href="#hl-2-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-14">&lt;a class="lnlinks" href="#hl-2-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-15">&lt;a class="lnlinks" href="#hl-2-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-16">&lt;a class="lnlinks" href="#hl-2-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-17">&lt;a class="lnlinks" href="#hl-2-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-18">&lt;a class="lnlinks" href="#hl-2-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-19">&lt;a class="lnlinks" href="#hl-2-19">19&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/hotel/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;range&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;price&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;lte&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">200&lt;/span> &lt;span class="c1">// 只对200元以下的文档聚合
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">},&lt;/span> 
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> 
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;aggs&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;brandAgg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;terms&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;field&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;brand&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这次，聚合得到的品牌明显变少了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-8e1b1ec14bb498.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723172404836"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="124metric聚合语法">
&lt;a href="#124metric%e8%81%9a%e5%90%88%e8%af%ad%e6%b3%95" class="header-anchor">#&lt;/a>
1.2.4.Metric聚合语法
&lt;/h3>&lt;p>上节课，我们对酒店按照品牌分组，形成了一个个桶。现在我们需要对桶内的酒店做运算，获取每个品牌的用户评分的min、max、avg等值。&lt;/p>
&lt;p>这就要用到Metric聚合了，例如stat聚合：就可以获取min、max、avg等结果。&lt;/p>
&lt;p>语法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-7">&lt;a class="lnlinks" href="#hl-3-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-8">&lt;a class="lnlinks" href="#hl-3-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-9">&lt;a class="lnlinks" href="#hl-3-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-10">&lt;a class="lnlinks" href="#hl-3-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-11">&lt;a class="lnlinks" href="#hl-3-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-12">&lt;a class="lnlinks" href="#hl-3-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-13">&lt;a class="lnlinks" href="#hl-3-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-14">&lt;a class="lnlinks" href="#hl-3-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-15">&lt;a class="lnlinks" href="#hl-3-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-16">&lt;a class="lnlinks" href="#hl-3-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-17">&lt;a class="lnlinks" href="#hl-3-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-18">&lt;a class="lnlinks" href="#hl-3-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-19">&lt;a class="lnlinks" href="#hl-3-19">19&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/hotel/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> 
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;aggs&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;brandAgg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> 
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;terms&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> 
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;field&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;brand&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> 
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;aggs&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// 是brands聚合的子聚合，也就是分组后对每组分别计算
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>        &lt;span class="nt">&amp;#34;score_stats&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// 聚合名称
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>          &lt;span class="nt">&amp;#34;stats&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// 聚合类型，这里stats可以计算min、max、avg等
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>            &lt;span class="nt">&amp;#34;field&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;score&amp;#34;&lt;/span> &lt;span class="c1">// 聚合字段，这里是score
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>          &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这次的score_stats聚合是在brandAgg的聚合内部嵌套的子聚合。因为我们需要在每个桶分别计算。&lt;/p>
&lt;p>另外，我们还可以给聚合结果做个排序，例如按照每个桶的酒店平均分做排序：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-c3bdbd738072a9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723172917636"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="125小结">
&lt;a href="#125%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
1.2.5.小结
&lt;/h3>&lt;p>aggs代表聚合，与query同级，此时query的作用是？&lt;/p>
&lt;ul>
&lt;li>限定聚合的的文档范围&lt;/li>
&lt;/ul>
&lt;p>聚合必须的三要素：&lt;/p>
&lt;ul>
&lt;li>聚合名称&lt;/li>
&lt;li>聚合类型&lt;/li>
&lt;li>聚合字段&lt;/li>
&lt;/ul>
&lt;p>聚合可配置属性有：&lt;/p>
&lt;ul>
&lt;li>size：指定聚合结果数量&lt;/li>
&lt;li>order：指定聚合结果排序方式&lt;/li>
&lt;li>field：指定聚合字段&lt;/li>
&lt;/ul>
&lt;h2 id="13restapi实现聚合">
&lt;a href="#13restapi%e5%ae%9e%e7%8e%b0%e8%81%9a%e5%90%88" class="header-anchor">#&lt;/a>
1.3.RestAPI实现聚合
&lt;/h2>&lt;h3 id="131api语法">
&lt;a href="#131api%e8%af%ad%e6%b3%95" class="header-anchor">#&lt;/a>
1.3.1.API语法
&lt;/h3>&lt;p>聚合条件与query条件同级别，因此需要使用request.source()来指定聚合条件。&lt;/p>
&lt;p>聚合条件的语法：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-1046bb015ed913.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723173057733"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>聚合的结果也与查询结果不同，API也比较特殊。不过同样是JSON逐层解析：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-43d559473abb6f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723173215728"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="132业务需求">
&lt;a href="#132%e4%b8%9a%e5%8a%a1%e9%9c%80%e6%b1%82" class="header-anchor">#&lt;/a>
1.3.2.业务需求
&lt;/h3>&lt;p>需求：搜索页面的品牌、城市等信息不应该是在页面写死，而是通过聚合索引库中的酒店数据得来的：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-8336082d6012bc.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723192605566"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>分析：&lt;/p>
&lt;p>目前，页面的城市列表、星级列表、品牌列表都是写死的，并不会随着搜索结果的变化而变化。但是用户搜索条件改变时，搜索结果会跟着变化。&lt;/p>
&lt;p>例如：用户搜索“东方明珠”，那搜索的酒店肯定是在上海东方明珠附近，因此，城市只能是上海，此时城市列表中就不应该显示北京、深圳、杭州这些信息了。&lt;/p>
&lt;p>也就是说，搜索结果中包含哪些城市，页面就应该列出哪些城市；搜索结果中包含哪些品牌，页面就应该列出哪些品牌。&lt;/p>
&lt;p>如何得知搜索结果中包含哪些品牌？如何得知搜索结果中包含哪些城市？&lt;/p>
&lt;p>使用聚合功能，利用Bucket聚合，对搜索结果中的文档基于品牌分组、基于城市分组，就能得知包含哪些品牌、哪些城市了。&lt;/p>
&lt;p>因为是对搜索结果聚合，因此聚合是&lt;strong>限定范围的聚合&lt;/strong>，也就是说聚合的限定条件跟搜索文档的条件一致。&lt;/p>
&lt;p>查看浏览器可以发现，前端其实已经发出了这样的一个请求：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-bef30debb2c03f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723193730799"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>请求&lt;strong>参数与搜索文档的参数完全一致&lt;/strong>。&lt;/p>
&lt;p>返回值类型就是页面要展示的最终结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-aec71f0c6a6649.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723203915982"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>结果是一个Map结构：&lt;/p>
&lt;ul>
&lt;li>key是字符串，城市、星级、品牌、价格&lt;/li>
&lt;li>value是集合，例如多个城市的名称&lt;/li>
&lt;/ul>
&lt;h3 id="133业务实现">
&lt;a href="#133%e4%b8%9a%e5%8a%a1%e5%ae%9e%e7%8e%b0" class="header-anchor">#&lt;/a>
1.3.3.业务实现
&lt;/h3>&lt;p>在&lt;code>cn.itcast.hotel.web&lt;/code>包的&lt;code>HotelController&lt;/code>中添加一个方法，遵循下面的要求：&lt;/p>
&lt;ul>
&lt;li>请求方式：&lt;code>POST&lt;/code>&lt;/li>
&lt;li>请求路径：&lt;code>/hotel/filters&lt;/code>&lt;/li>
&lt;li>请求参数：&lt;code>RequestParams&lt;/code>，与搜索文档的参数一致&lt;/li>
&lt;li>返回值类型：&lt;code>Map&amp;lt;String, List&amp;lt;String&amp;gt;&amp;gt;&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@PostMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;filters&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">getFilters&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nd">@RequestBody&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestParams&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getFilters&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里调用了IHotelService中的getFilters方法，尚未实现。&lt;/p>
&lt;p>在&lt;code>cn.itcast.hotel.service.IHotelService&lt;/code>中定义新方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">filters&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RequestParams&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在&lt;code>cn.itcast.hotel.service.impl.HotelService&lt;/code>中实现该方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-5">&lt;a class="lnlinks" href="#hl-6-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-6">&lt;a class="lnlinks" href="#hl-6-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-7">&lt;a class="lnlinks" href="#hl-6-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-8">&lt;a class="lnlinks" href="#hl-6-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-9">&lt;a class="lnlinks" href="#hl-6-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-10">&lt;a class="lnlinks" href="#hl-6-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-11">&lt;a class="lnlinks" href="#hl-6-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-12">&lt;a class="lnlinks" href="#hl-6-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-13">&lt;a class="lnlinks" href="#hl-6-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-14">&lt;a class="lnlinks" href="#hl-6-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-15">&lt;a class="lnlinks" href="#hl-6-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-16">&lt;a class="lnlinks" href="#hl-6-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-17">&lt;a class="lnlinks" href="#hl-6-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-18">&lt;a class="lnlinks" href="#hl-6-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-19">&lt;a class="lnlinks" href="#hl-6-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-20">&lt;a class="lnlinks" href="#hl-6-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-21">&lt;a class="lnlinks" href="#hl-6-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-22">&lt;a class="lnlinks" href="#hl-6-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-23">&lt;a class="lnlinks" href="#hl-6-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-24">&lt;a class="lnlinks" href="#hl-6-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-25">&lt;a class="lnlinks" href="#hl-6-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-26">&lt;a class="lnlinks" href="#hl-6-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-27">&lt;a class="lnlinks" href="#hl-6-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-28">&lt;a class="lnlinks" href="#hl-6-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-29">&lt;a class="lnlinks" href="#hl-6-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-30">&lt;a class="lnlinks" href="#hl-6-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-31">&lt;a class="lnlinks" href="#hl-6-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-32">&lt;a class="lnlinks" href="#hl-6-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-33">&lt;a class="lnlinks" href="#hl-6-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-34">&lt;a class="lnlinks" href="#hl-6-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-35">&lt;a class="lnlinks" href="#hl-6-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-36">&lt;a class="lnlinks" href="#hl-6-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-37">&lt;a class="lnlinks" href="#hl-6-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-38">&lt;a class="lnlinks" href="#hl-6-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-39">&lt;a class="lnlinks" href="#hl-6-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-40">&lt;a class="lnlinks" href="#hl-6-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-41">&lt;a class="lnlinks" href="#hl-6-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-42">&lt;a class="lnlinks" href="#hl-6-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-43">&lt;a class="lnlinks" href="#hl-6-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-44">&lt;a class="lnlinks" href="#hl-6-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-45">&lt;a class="lnlinks" href="#hl-6-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-46">&lt;a class="lnlinks" href="#hl-6-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-47">&lt;a class="lnlinks" href="#hl-6-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-48">&lt;a class="lnlinks" href="#hl-6-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-49">&lt;a class="lnlinks" href="#hl-6-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-50">&lt;a class="lnlinks" href="#hl-6-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-51">&lt;a class="lnlinks" href="#hl-6-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-52">&lt;a class="lnlinks" href="#hl-6-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-53">&lt;a class="lnlinks" href="#hl-6-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-54">&lt;a class="lnlinks" href="#hl-6-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-55">&lt;a class="lnlinks" href="#hl-6-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-56">&lt;a class="lnlinks" href="#hl-6-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-57">&lt;a class="lnlinks" href="#hl-6-57">57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-58">&lt;a class="lnlinks" href="#hl-6-58">58&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-59">&lt;a class="lnlinks" href="#hl-6-59">59&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-60">&lt;a class="lnlinks" href="#hl-6-60">60&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-61">&lt;a class="lnlinks" href="#hl-6-61">61&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-62">&lt;a class="lnlinks" href="#hl-6-62">62&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-63">&lt;a class="lnlinks" href="#hl-6-63">63&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-64">&lt;a class="lnlinks" href="#hl-6-64">64&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-65">&lt;a class="lnlinks" href="#hl-6-65">65&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">filters&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RequestParams&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备DSL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.1.query&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">buildBasicQuery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.2.设置size&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.3.聚合&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">buildAggregation&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发出请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.解析结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HashMap&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Aggregations&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">aggregations&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getAggregations&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.1.根据品牌名称，获取品牌结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brandList&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getAggByName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">aggregations&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;brandAgg&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;品牌&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brandList&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.2.根据品牌名称，获取品牌结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cityList&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getAggByName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">aggregations&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;cityAgg&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;城市&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cityList&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.3.根据品牌名称，获取品牌结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">starList&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getAggByName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">aggregations&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;starAgg&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;星级&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">starList&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuntimeException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">buildAggregation&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">aggregation&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AggregationBuilders&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">terms&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;brandAgg&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">field&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;brand&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">100&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">aggregation&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AggregationBuilders&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">terms&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;cityAgg&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">field&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;city&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">100&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">aggregation&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AggregationBuilders&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">terms&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;starAgg&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">field&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;starName&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">100&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">getAggByName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Aggregations&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">aggregations&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">aggName&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.1.根据聚合名称获取聚合结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Terms&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brandTerms&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">aggregations&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">aggName&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.2.获取buckets&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;?&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">extends&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Terms&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">Bucket&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">buckets&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brandTerms&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBuckets&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.3.遍历&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brandList&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Terms&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">Bucket&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">bucket&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">buckets&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.4.获取key&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">bucket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getKeyAsString&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">brandList&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brandList&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="2自动补全">
&lt;a href="#2%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8" class="header-anchor">#&lt;/a>
2.自动补全
&lt;/h1>&lt;p>当用户在搜索框输入字符时，我们应该提示出与该字符有关的搜索项，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-c1ae8ea1d1093f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723204936367"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这种根据用户输入的字母，提示完整词条的功能，就是自动补全了。&lt;/p>
&lt;p>因为需要根据拼音字母来推断，因此要用到拼音分词功能。&lt;/p>
&lt;h2 id="21拼音分词器">
&lt;a href="#21%e6%8b%bc%e9%9f%b3%e5%88%86%e8%af%8d%e5%99%a8" class="header-anchor">#&lt;/a>
2.1.拼音分词器
&lt;/h2>&lt;p>要实现根据字母做补全，就必须对文档按照拼音分词。在GitHub上恰好有elasticsearch的拼音分词插件。地址：https://github.com/medcl/elasticsearch-analysis-pinyin&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-a2959e9a2c4b49.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723205932746"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>课前资料中也提供了拼音分词器的安装包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-4598ea2e6b092e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723205722303"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>安装方式与IK分词器一样，分三步：&lt;/p>
&lt;p>​ ①解压&lt;/p>
&lt;p>​ ②上传到虚拟机中，elasticsearch的plugin目录&lt;/p>
&lt;p>​ ③重启elasticsearch&lt;/p>
&lt;p>​ ④测试&lt;/p>
&lt;p>详细安装步骤可以参考IK分词器的安装过程。&lt;/p>
&lt;p>测试用法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">/_analyze&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;如家酒店还不错&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;pinyin&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-115d12820c3f3d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723210126506"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="22自定义分词器">
&lt;a href="#22%e8%87%aa%e5%ae%9a%e4%b9%89%e5%88%86%e8%af%8d%e5%99%a8" class="header-anchor">#&lt;/a>
2.2.自定义分词器
&lt;/h2>&lt;p>默认的拼音分词器会将每个汉字单独分为拼音，而我们希望的是每个词条形成一组拼音，需要对拼音分词器做个性化定制，形成自定义分词器。&lt;/p>
&lt;p>elasticsearch中分词器（analyzer）的组成包含三部分：&lt;/p>
&lt;ul>
&lt;li>character filters：在tokenizer之前对文本进行处理。例如删除字符、替换字符&lt;/li>
&lt;li>tokenizer：将文本按照一定的规则切割成词条（term）。例如keyword，就是不分词；还有ik_smart&lt;/li>
&lt;li>tokenizer filter：将tokenizer输出的词条做进一步处理。例如大小写转换、同义词处理、拼音处理等&lt;/li>
&lt;/ul>
&lt;p>文档分词时会依次由这三部分来处理文档：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-b463ba65fc5601.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723210427878"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>声明自定义分词器的语法如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-6">&lt;a class="lnlinks" href="#hl-8-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-7">&lt;a class="lnlinks" href="#hl-8-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-8">&lt;a class="lnlinks" href="#hl-8-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-9">&lt;a class="lnlinks" href="#hl-8-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-10">&lt;a class="lnlinks" href="#hl-8-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-11">&lt;a class="lnlinks" href="#hl-8-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-12">&lt;a class="lnlinks" href="#hl-8-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-13">&lt;a class="lnlinks" href="#hl-8-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-14">&lt;a class="lnlinks" href="#hl-8-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-15">&lt;a class="lnlinks" href="#hl-8-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-16">&lt;a class="lnlinks" href="#hl-8-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-17">&lt;a class="lnlinks" href="#hl-8-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-18">&lt;a class="lnlinks" href="#hl-8-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-19">&lt;a class="lnlinks" href="#hl-8-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-20">&lt;a class="lnlinks" href="#hl-8-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-21">&lt;a class="lnlinks" href="#hl-8-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-22">&lt;a class="lnlinks" href="#hl-8-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-23">&lt;a class="lnlinks" href="#hl-8-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-24">&lt;a class="lnlinks" href="#hl-8-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-25">&lt;a class="lnlinks" href="#hl-8-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-26">&lt;a class="lnlinks" href="#hl-8-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-27">&lt;a class="lnlinks" href="#hl-8-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-28">&lt;a class="lnlinks" href="#hl-8-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-29">&lt;a class="lnlinks" href="#hl-8-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-30">&lt;a class="lnlinks" href="#hl-8-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-31">&lt;a class="lnlinks" href="#hl-8-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-32">&lt;a class="lnlinks" href="#hl-8-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-33">&lt;a class="lnlinks" href="#hl-8-33">33&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">PUT&lt;/span> &lt;span class="err">/test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;settings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;analysis&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// 自定义分词器
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>        &lt;span class="nt">&amp;#34;my_analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>  &lt;span class="c1">// 分词器名称
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>          &lt;span class="nt">&amp;#34;tokenizer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_max_word&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;filter&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;py&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;filter&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// 自定义tokenizer filter
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>        &lt;span class="nt">&amp;#34;py&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// 过滤器名称
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>          &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;pinyin&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 过滤器类型，这里是pinyin
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nt">&amp;#34;keep_full_pinyin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;keep_joined_full_pinyin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;keep_original&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;limit_first_letter_length&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;remove_duplicated_term&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">          &lt;span class="nt">&amp;#34;none_chinese_pinyin_tokenize&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;mappings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;properties&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;my_analyzer&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;search_analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_smart&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-90e6dfaa173b80.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723211829150"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>总结：&lt;/p>
&lt;p>如何使用拼音分词器？&lt;/p>
&lt;ul>
&lt;li>
&lt;p>①下载pinyin分词器&lt;/p>
&lt;/li>
&lt;li>
&lt;p>②解压并放到elasticsearch的plugin目录&lt;/p>
&lt;/li>
&lt;li>
&lt;p>③重启即可&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>如何自定义分词器？&lt;/p>
&lt;ul>
&lt;li>
&lt;p>①创建索引库时，在settings中配置，可以包含三部分&lt;/p>
&lt;/li>
&lt;li>
&lt;p>②character filter&lt;/p>
&lt;/li>
&lt;li>
&lt;p>③tokenizer&lt;/p>
&lt;/li>
&lt;li>
&lt;p>④filter&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>拼音分词器注意事项？&lt;/p>
&lt;ul>
&lt;li>为了避免搜索到同音字，搜索时不要使用拼音分词器&lt;/li>
&lt;/ul>
&lt;h2 id="23自动补全查询">
&lt;a href="#23%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
2.3.自动补全查询
&lt;/h2>&lt;p>elasticsearch提供了&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html" target="_blank" rel="noopener"
>Completion Suggester
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回。为了提高补全查询的效率，对于文档中字段的类型有一些约束：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>参与补全查询的字段必须是completion类型。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>字段的内容一般是用来补全的多个词条形成的数组。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>比如，一个这样的索引库：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-5">&lt;a class="lnlinks" href="#hl-9-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-6">&lt;a class="lnlinks" href="#hl-9-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-7">&lt;a class="lnlinks" href="#hl-9-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-8">&lt;a class="lnlinks" href="#hl-9-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-9">&lt;a class="lnlinks" href="#hl-9-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-10">&lt;a class="lnlinks" href="#hl-9-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-11">&lt;a class="lnlinks" href="#hl-9-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 创建索引库
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">PUT&lt;/span> &lt;span class="err">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;mappings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;properties&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;completion&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后插入下面的数据：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-5">&lt;a class="lnlinks" href="#hl-10-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-6">&lt;a class="lnlinks" href="#hl-10-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-7">&lt;a class="lnlinks" href="#hl-10-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-8">&lt;a class="lnlinks" href="#hl-10-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-9">&lt;a class="lnlinks" href="#hl-10-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-10">&lt;a class="lnlinks" href="#hl-10-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-11">&lt;a class="lnlinks" href="#hl-10-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-12">&lt;a class="lnlinks" href="#hl-10-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-13">&lt;a class="lnlinks" href="#hl-10-13">13&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 示例数据
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">POST&lt;/span> &lt;span class="err">test/_doc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;Sony&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;WH-1000XM3&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">test/_doc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;SK-II&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;PITERA&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">test/_doc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;Nintendo&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;switch&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查询的DSL语句如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-5">&lt;a class="lnlinks" href="#hl-11-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-6">&lt;a class="lnlinks" href="#hl-11-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-7">&lt;a class="lnlinks" href="#hl-11-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-8">&lt;a class="lnlinks" href="#hl-11-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-9">&lt;a class="lnlinks" href="#hl-11-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-10">&lt;a class="lnlinks" href="#hl-11-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-11">&lt;a class="lnlinks" href="#hl-11-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-12">&lt;a class="lnlinks" href="#hl-11-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-13">&lt;a class="lnlinks" href="#hl-11-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-14">&lt;a class="lnlinks" href="#hl-11-14">14&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 自动补全查询
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">GET&lt;/span> &lt;span class="err">/test/_search&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="nt">&amp;#34;suggest&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="nt">&amp;#34;title_suggest&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">      &lt;span class="nt">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 关键字
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>      &lt;span class="nt">&amp;#34;completion&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">        &lt;span class="nt">&amp;#34;field&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 补全查询的字段
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>        &lt;span class="nt">&amp;#34;skip_duplicates&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 跳过重复的
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>        &lt;span class="nt">&amp;#34;size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="c1">// 获取前10条结果
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>      &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">  &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="24实现酒店搜索框自动补全">
&lt;a href="#24%e5%ae%9e%e7%8e%b0%e9%85%92%e5%ba%97%e6%90%9c%e7%b4%a2%e6%a1%86%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8" class="header-anchor">#&lt;/a>
2.4.实现酒店搜索框自动补全
&lt;/h2>&lt;p>现在，我们的hotel索引库还没有设置拼音分词器，需要修改索引库中的配置。但是我们知道索引库是无法修改的，只能删除然后重新创建。&lt;/p>
&lt;p>另外，我们需要添加一个字段，用来做自动补全，将brand、suggestion、city等都放进去，作为自动补全的提示。&lt;/p>
&lt;p>因此，总结一下，我们需要做的事情包括：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>修改hotel索引库结构，设置自定义拼音分词器&lt;/p>
&lt;/li>
&lt;li>
&lt;p>修改索引库的name、all字段，使用自定义分词器&lt;/p>
&lt;/li>
&lt;li>
&lt;p>索引库添加一个新字段suggestion，类型为completion类型，使用自定义的分词器&lt;/p>
&lt;/li>
&lt;li>
&lt;p>给HotelDoc类添加suggestion字段，内容包含brand、business&lt;/p>
&lt;/li>
&lt;li>
&lt;p>重新导入数据到hotel库&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="241修改酒店映射结构">
&lt;a href="#241%e4%bf%ae%e6%94%b9%e9%85%92%e5%ba%97%e6%98%a0%e5%b0%84%e7%bb%93%e6%9e%84" class="header-anchor">#&lt;/a>
2.4.1.修改酒店映射结构
&lt;/h3>&lt;p>代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-6">&lt;a class="lnlinks" href="#hl-12-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-7">&lt;a class="lnlinks" href="#hl-12-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-8">&lt;a class="lnlinks" href="#hl-12-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-9">&lt;a class="lnlinks" href="#hl-12-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-10">&lt;a class="lnlinks" href="#hl-12-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-11">&lt;a class="lnlinks" href="#hl-12-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-12">&lt;a class="lnlinks" href="#hl-12-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-13">&lt;a class="lnlinks" href="#hl-12-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-14">&lt;a class="lnlinks" href="#hl-12-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-15">&lt;a class="lnlinks" href="#hl-12-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-16">&lt;a class="lnlinks" href="#hl-12-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-17">&lt;a class="lnlinks" href="#hl-12-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-18">&lt;a class="lnlinks" href="#hl-12-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-19">&lt;a class="lnlinks" href="#hl-12-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-20">&lt;a class="lnlinks" href="#hl-12-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-21">&lt;a class="lnlinks" href="#hl-12-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-22">&lt;a class="lnlinks" href="#hl-12-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-23">&lt;a class="lnlinks" href="#hl-12-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-24">&lt;a class="lnlinks" href="#hl-12-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-25">&lt;a class="lnlinks" href="#hl-12-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-26">&lt;a class="lnlinks" href="#hl-12-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-27">&lt;a class="lnlinks" href="#hl-12-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-28">&lt;a class="lnlinks" href="#hl-12-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-29">&lt;a class="lnlinks" href="#hl-12-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-30">&lt;a class="lnlinks" href="#hl-12-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-31">&lt;a class="lnlinks" href="#hl-12-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-32">&lt;a class="lnlinks" href="#hl-12-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-33">&lt;a class="lnlinks" href="#hl-12-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-34">&lt;a class="lnlinks" href="#hl-12-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-35">&lt;a class="lnlinks" href="#hl-12-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-36">&lt;a class="lnlinks" href="#hl-12-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-37">&lt;a class="lnlinks" href="#hl-12-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-38">&lt;a class="lnlinks" href="#hl-12-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-39">&lt;a class="lnlinks" href="#hl-12-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-40">&lt;a class="lnlinks" href="#hl-12-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-41">&lt;a class="lnlinks" href="#hl-12-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-42">&lt;a class="lnlinks" href="#hl-12-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-43">&lt;a class="lnlinks" href="#hl-12-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-44">&lt;a class="lnlinks" href="#hl-12-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-45">&lt;a class="lnlinks" href="#hl-12-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-46">&lt;a class="lnlinks" href="#hl-12-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-47">&lt;a class="lnlinks" href="#hl-12-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-48">&lt;a class="lnlinks" href="#hl-12-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-49">&lt;a class="lnlinks" href="#hl-12-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-50">&lt;a class="lnlinks" href="#hl-12-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-51">&lt;a class="lnlinks" href="#hl-12-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-52">&lt;a class="lnlinks" href="#hl-12-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-53">&lt;a class="lnlinks" href="#hl-12-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-54">&lt;a class="lnlinks" href="#hl-12-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-55">&lt;a class="lnlinks" href="#hl-12-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-56">&lt;a class="lnlinks" href="#hl-12-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-57">&lt;a class="lnlinks" href="#hl-12-57">57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-58">&lt;a class="lnlinks" href="#hl-12-58">58&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-59">&lt;a class="lnlinks" href="#hl-12-59">59&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-60">&lt;a class="lnlinks" href="#hl-12-60">60&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-61">&lt;a class="lnlinks" href="#hl-12-61">61&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-62">&lt;a class="lnlinks" href="#hl-12-62">62&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-63">&lt;a class="lnlinks" href="#hl-12-63">63&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-64">&lt;a class="lnlinks" href="#hl-12-64">64&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-65">&lt;a class="lnlinks" href="#hl-12-65">65&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-66">&lt;a class="lnlinks" href="#hl-12-66">66&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-67">&lt;a class="lnlinks" href="#hl-12-67">67&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-68">&lt;a class="lnlinks" href="#hl-12-68">68&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-69">&lt;a class="lnlinks" href="#hl-12-69">69&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-70">&lt;a class="lnlinks" href="#hl-12-70">70&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-71">&lt;a class="lnlinks" href="#hl-12-71">71&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-72">&lt;a class="lnlinks" href="#hl-12-72">72&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-73">&lt;a class="lnlinks" href="#hl-12-73">73&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-74">&lt;a class="lnlinks" href="#hl-12-74">74&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-75">&lt;a class="lnlinks" href="#hl-12-75">75&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-76">&lt;a class="lnlinks" href="#hl-12-76">76&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-77">&lt;a class="lnlinks" href="#hl-12-77">77&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-78">&lt;a class="lnlinks" href="#hl-12-78">78&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-79">&lt;a class="lnlinks" href="#hl-12-79">79&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-80">&lt;a class="lnlinks" href="#hl-12-80">80&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-81">&lt;a class="lnlinks" href="#hl-12-81">81&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-82">&lt;a class="lnlinks" href="#hl-12-82">82&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// 酒店数据索引库
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">PUT&lt;/span> &lt;span class="err">/hotel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;settings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analysis&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;text_anlyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;tokenizer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_max_word&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;filter&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;py&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;completion_analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;tokenizer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;filter&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;py&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;filter&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;py&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;pinyin&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;keep_full_pinyin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;keep_joined_full_pinyin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;keep_original&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;limit_first_letter_length&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;remove_duplicated_term&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;none_chinese_pinyin_tokenize&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;mappings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;properties&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;text_anlyzer&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;search_analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_smart&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;copy_to&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;all&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;address&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;index&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;price&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;integer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;score&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;integer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;brand&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;copy_to&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;all&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;city&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;starName&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;business&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;copy_to&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;all&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;location&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;geo_point&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;pic&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;index&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;all&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;text_anlyzer&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;search_analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_smart&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;suggestion&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;completion&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;completion_analyzer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="242修改hoteldoc实体">
&lt;a href="#242%e4%bf%ae%e6%94%b9hoteldoc%e5%ae%9e%e4%bd%93" class="header-anchor">#&lt;/a>
2.4.2.修改HotelDoc实体
&lt;/h3>&lt;p>HotelDoc中要添加一个字段，用来做自动补全，内容可以是酒店品牌、城市、商圈等信息。按照自动补全字段的要求，最好是这些字段的数组。&lt;/p>
&lt;p>因此我们在HotelDoc中添加一个suggestion字段，类型为&lt;code>List&amp;lt;String&amp;gt;&lt;/code>，然后将brand、city、business等信息放到里面。&lt;/p>
&lt;p>代码如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-6">&lt;a class="lnlinks" href="#hl-13-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-7">&lt;a class="lnlinks" href="#hl-13-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-8">&lt;a class="lnlinks" href="#hl-13-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-9">&lt;a class="lnlinks" href="#hl-13-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-10">&lt;a class="lnlinks" href="#hl-13-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-11">&lt;a class="lnlinks" href="#hl-13-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-12">&lt;a class="lnlinks" href="#hl-13-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-13">&lt;a class="lnlinks" href="#hl-13-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-14">&lt;a class="lnlinks" href="#hl-13-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-15">&lt;a class="lnlinks" href="#hl-13-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-16">&lt;a class="lnlinks" href="#hl-13-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-17">&lt;a class="lnlinks" href="#hl-13-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-18">&lt;a class="lnlinks" href="#hl-13-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-19">&lt;a class="lnlinks" href="#hl-13-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-20">&lt;a class="lnlinks" href="#hl-13-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-21">&lt;a class="lnlinks" href="#hl-13-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-22">&lt;a class="lnlinks" href="#hl-13-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-23">&lt;a class="lnlinks" href="#hl-13-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-24">&lt;a class="lnlinks" href="#hl-13-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-25">&lt;a class="lnlinks" href="#hl-13-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-26">&lt;a class="lnlinks" href="#hl-13-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-27">&lt;a class="lnlinks" href="#hl-13-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-28">&lt;a class="lnlinks" href="#hl-13-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-29">&lt;a class="lnlinks" href="#hl-13-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-30">&lt;a class="lnlinks" href="#hl-13-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-31">&lt;a class="lnlinks" href="#hl-13-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-32">&lt;a class="lnlinks" href="#hl-13-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-33">&lt;a class="lnlinks" href="#hl-13-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-34">&lt;a class="lnlinks" href="#hl-13-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-35">&lt;a class="lnlinks" href="#hl-13-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-36">&lt;a class="lnlinks" href="#hl-13-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-37">&lt;a class="lnlinks" href="#hl-13-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-38">&lt;a class="lnlinks" href="#hl-13-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-39">&lt;a class="lnlinks" href="#hl-13-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-40">&lt;a class="lnlinks" href="#hl-13-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-41">&lt;a class="lnlinks" href="#hl-13-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-42">&lt;a class="lnlinks" href="#hl-13-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-43">&lt;a class="lnlinks" href="#hl-13-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-44">&lt;a class="lnlinks" href="#hl-13-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-45">&lt;a class="lnlinks" href="#hl-13-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-46">&lt;a class="lnlinks" href="#hl-13-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-47">&lt;a class="lnlinks" href="#hl-13-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-48">&lt;a class="lnlinks" href="#hl-13-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-49">&lt;a class="lnlinks" href="#hl-13-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-50">&lt;a class="lnlinks" href="#hl-13-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-51">&lt;a class="lnlinks" href="#hl-13-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-52">&lt;a class="lnlinks" href="#hl-13-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-53">&lt;a class="lnlinks" href="#hl-13-53">53&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.pojo&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.Data&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.NoArgsConstructor&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.util.ArrayList&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.util.Arrays&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.util.Collections&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">java.util.List&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Data&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@NoArgsConstructor&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">HotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">address&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">price&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">score&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">brand&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">city&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">starName&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">business&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">location&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pic&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">distance&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">isAD&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">suggestion&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">HotelDoc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Hotel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">address&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getAddress&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">price&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPrice&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">score&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getScore&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">brand&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBrand&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">city&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getCity&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">starName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getStarName&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">business&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getBusiness&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">location&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLatitude&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;, &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getLongitude&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">pic&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getPic&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 组装suggestion&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">business&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">contains&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">)){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// business有多个值，需要切割&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">business&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 添加元素&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">suggestion&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">suggestion&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">brand&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Collections&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">addAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">suggestion&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">suggestion&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Arrays&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">asList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">brand&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">business&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="243重新导入">
&lt;a href="#243%e9%87%8d%e6%96%b0%e5%af%bc%e5%85%a5" class="header-anchor">#&lt;/a>
2.4.3.重新导入
&lt;/h3>&lt;p>重新执行之前编写的导入数据功能，可以看到新的酒店数据中包含了suggestion：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-f4e37d0956d9e6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723213546183"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="244自动补全查询的javaapi">
&lt;a href="#244%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8%e6%9f%a5%e8%af%a2%e7%9a%84javaapi" class="header-anchor">#&lt;/a>
2.4.4.自动补全查询的JavaAPI
&lt;/h3>&lt;p>之前我们学习了自动补全查询的DSL，而没有学习对应的JavaAPI，这里给出一个示例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-a3e843223814b5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723213759922"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>而自动补全的结果也比较特殊，解析的代码如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-2fa085edbd515c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723213917524"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="245实现搜索框自动补全">
&lt;a href="#245%e5%ae%9e%e7%8e%b0%e6%90%9c%e7%b4%a2%e6%a1%86%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8" class="header-anchor">#&lt;/a>
2.4.5.实现搜索框自动补全
&lt;/h3>&lt;p>查看前端页面，可以发现当我们在输入框键入时，前端会发起ajax请求：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-d47d070ef52b46.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723214021062"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>返回值是补全词条的集合，类型为&lt;code>List&amp;lt;String&amp;gt;&lt;/code>&lt;/p>
&lt;p>1）在&lt;code>cn.itcast.hotel.web&lt;/code>包下的&lt;code>HotelController&lt;/code>中添加新接口，接收新的请求：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@GetMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;suggestion&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">getSuggestions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nd">@RequestParam&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;key&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prefix&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getSuggestions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">prefix&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）在&lt;code>cn.itcast.hotel.service&lt;/code>包下的&lt;code>IhotelService&lt;/code>中添加方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">getSuggestions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prefix&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）在&lt;code>cn.itcast.hotel.service.impl.HotelService&lt;/code>中实现该方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-7">&lt;a class="lnlinks" href="#hl-16-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-8">&lt;a class="lnlinks" href="#hl-16-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-9">&lt;a class="lnlinks" href="#hl-16-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-10">&lt;a class="lnlinks" href="#hl-16-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-11">&lt;a class="lnlinks" href="#hl-16-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-12">&lt;a class="lnlinks" href="#hl-16-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-13">&lt;a class="lnlinks" href="#hl-16-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-14">&lt;a class="lnlinks" href="#hl-16-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-15">&lt;a class="lnlinks" href="#hl-16-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-16">&lt;a class="lnlinks" href="#hl-16-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-17">&lt;a class="lnlinks" href="#hl-16-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-18">&lt;a class="lnlinks" href="#hl-16-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-19">&lt;a class="lnlinks" href="#hl-16-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-20">&lt;a class="lnlinks" href="#hl-16-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-21">&lt;a class="lnlinks" href="#hl-16-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-22">&lt;a class="lnlinks" href="#hl-16-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-23">&lt;a class="lnlinks" href="#hl-16-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-24">&lt;a class="lnlinks" href="#hl-16-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-25">&lt;a class="lnlinks" href="#hl-16-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-26">&lt;a class="lnlinks" href="#hl-16-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-27">&lt;a class="lnlinks" href="#hl-16-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-28">&lt;a class="lnlinks" href="#hl-16-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-29">&lt;a class="lnlinks" href="#hl-16-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-30">&lt;a class="lnlinks" href="#hl-16-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-31">&lt;a class="lnlinks" href="#hl-16-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-32">&lt;a class="lnlinks" href="#hl-16-32">32&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">getSuggestions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prefix&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SearchRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备DSL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">suggest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SuggestBuilder&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">addSuggestion&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;suggestions&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SuggestBuilders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">completionSuggestion&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;suggestion&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">prefix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">prefix&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">skipDuplicates&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发起请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">SearchResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.解析结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Suggest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">suggest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getSuggest&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.1.根据补全查询名称，获取补全结果&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">CompletionSuggestion&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">suggestions&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">suggest&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getSuggestion&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;suggestions&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.2.获取options&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">CompletionSuggestion&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">Option&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">options&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">suggestions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getOptions&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 4.3.遍历&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ArrayList&lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CompletionSuggestion&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">Option&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">option&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">options&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">text&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">option&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getText&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">text&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuntimeException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="3数据同步">
&lt;a href="#3%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5" class="header-anchor">#&lt;/a>
3.数据同步
&lt;/h1>&lt;p>elasticsearch中的酒店数据来自于mysql数据库，因此mysql数据发生改变时，elasticsearch也必须跟着改变，这个就是elasticsearch与mysql之间的&lt;strong>数据同步&lt;/strong>。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-3d58bbd543d0de.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723214758392"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="31思路分析">
&lt;a href="#31%e6%80%9d%e8%b7%af%e5%88%86%e6%9e%90" class="header-anchor">#&lt;/a>
3.1.思路分析
&lt;/h2>&lt;p>常见的数据同步方案有三种：&lt;/p>
&lt;ul>
&lt;li>同步调用&lt;/li>
&lt;li>异步通知&lt;/li>
&lt;li>监听binlog&lt;/li>
&lt;/ul>
&lt;h3 id="311同步调用">
&lt;a href="#311%e5%90%8c%e6%ad%a5%e8%b0%83%e7%94%a8" class="header-anchor">#&lt;/a>
3.1.1.同步调用
&lt;/h3>&lt;p>方案一：同步调用&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-422b3352b7b20d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723214931869"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>基本步骤如下：&lt;/p>
&lt;ul>
&lt;li>hotel-demo对外提供接口，用来修改elasticsearch中的数据&lt;/li>
&lt;li>酒店管理服务在完成数据库操作后，直接调用hotel-demo提供的接口，&lt;/li>
&lt;/ul>
&lt;h3 id="312异步通知">
&lt;a href="#312%e5%bc%82%e6%ad%a5%e9%80%9a%e7%9f%a5" class="header-anchor">#&lt;/a>
3.1.2.异步通知
&lt;/h3>&lt;p>方案二：异步通知&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-9f6cc494274564.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723215140735"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>流程如下：&lt;/p>
&lt;ul>
&lt;li>hotel-admin对mysql数据库数据完成增、删、改后，发送MQ消息&lt;/li>
&lt;li>hotel-demo监听MQ，接收到消息后完成elasticsearch数据修改&lt;/li>
&lt;/ul>
&lt;h3 id="313监听binlog">
&lt;a href="#313%e7%9b%91%e5%90%acbinlog" class="header-anchor">#&lt;/a>
3.1.3.监听binlog
&lt;/h3>&lt;p>方案三：监听binlog&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-9f54254d30acd6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723215518541"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>流程如下：&lt;/p>
&lt;ul>
&lt;li>给mysql开启binlog功能&lt;/li>
&lt;li>mysql完成增、删、改操作都会记录在binlog中&lt;/li>
&lt;li>hotel-demo基于canal监听binlog变化，实时更新elasticsearch中的内容&lt;/li>
&lt;/ul>
&lt;h3 id="314选择">
&lt;a href="#314%e9%80%89%e6%8b%a9" class="header-anchor">#&lt;/a>
3.1.4.选择
&lt;/h3>&lt;p>方式一：同步调用&lt;/p>
&lt;ul>
&lt;li>优点：实现简单，粗暴&lt;/li>
&lt;li>缺点：业务耦合度高&lt;/li>
&lt;/ul>
&lt;p>方式二：异步通知&lt;/p>
&lt;ul>
&lt;li>优点：低耦合，实现难度一般&lt;/li>
&lt;li>缺点：依赖mq的可靠性&lt;/li>
&lt;/ul>
&lt;p>方式三：监听binlog&lt;/p>
&lt;ul>
&lt;li>优点：完全解除服务间耦合&lt;/li>
&lt;li>缺点：开启binlog增加数据库负担、实现复杂度高&lt;/li>
&lt;/ul>
&lt;h2 id="32实现数据同步">
&lt;a href="#32%e5%ae%9e%e7%8e%b0%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5" class="header-anchor">#&lt;/a>
3.2.实现数据同步
&lt;/h2>&lt;h3 id="321思路">
&lt;a href="#321%e6%80%9d%e8%b7%af" class="header-anchor">#&lt;/a>
3.2.1.思路
&lt;/h3>&lt;p>利用课前资料提供的hotel-admin项目作为酒店管理的微服务。当酒店数据发生增、删、改时，要求对elasticsearch中数据也要完成相同操作。&lt;/p>
&lt;p>步骤：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>导入课前资料提供的hotel-admin项目，启动并测试酒店数据的CRUD&lt;/p>
&lt;/li>
&lt;li>
&lt;p>声明exchange、queue、RoutingKey&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在hotel-admin中的增、删、改业务中完成消息发送&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在hotel-demo中完成消息监听，并更新elasticsearch中数据&lt;/p>
&lt;/li>
&lt;li>
&lt;p>启动并测试数据同步功能&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="322导入demo">
&lt;a href="#322%e5%af%bc%e5%85%a5demo" class="header-anchor">#&lt;/a>
3.2.2.导入demo
&lt;/h3>&lt;p>导入课前资料提供的hotel-admin项目：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-ae0731460dc2cd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723220237930"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>运行后，访问 http://localhost:8099&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-fd268943e117c2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723220354464"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中包含了酒店的CRUD功能：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-2f61546c91dae1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723220511090"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="323声明交换机队列">
&lt;a href="#323%e5%a3%b0%e6%98%8e%e4%ba%a4%e6%8d%a2%e6%9c%ba%e9%98%9f%e5%88%97" class="header-anchor">#&lt;/a>
3.2.3.声明交换机、队列
&lt;/h3>&lt;p>MQ结构如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-8ee85fd32dfa97.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723215850307"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h4 id="1引入依赖">
&lt;a href="#1%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96" class="header-anchor">#&lt;/a>
1）引入依赖
&lt;/h4>&lt;p>在hotel-admin、hotel-demo中引入rabbitmq的依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-4">&lt;a class="lnlinks" href="#hl-17-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-5">&lt;a class="lnlinks" href="#hl-17-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!--amqp--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.springframework.boot&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-boot-starter-amqp&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="2声明队列交换机名称">
&lt;a href="#2%e5%a3%b0%e6%98%8e%e9%98%9f%e5%88%97%e4%ba%a4%e6%8d%a2%e6%9c%ba%e5%90%8d%e7%a7%b0" class="header-anchor">#&lt;/a>
2）声明队列交换机名称
&lt;/h4>&lt;p>在hotel-admin和hotel-demo中的&lt;code>cn.itcast.hotel.constatnts&lt;/code>包下新建一个类&lt;code>MqConstants&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-5">&lt;a class="lnlinks" href="#hl-18-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-6">&lt;a class="lnlinks" href="#hl-18-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-7">&lt;a class="lnlinks" href="#hl-18-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-8">&lt;a class="lnlinks" href="#hl-18-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-9">&lt;a class="lnlinks" href="#hl-18-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-10">&lt;a class="lnlinks" href="#hl-18-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-11">&lt;a class="lnlinks" href="#hl-18-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-12">&lt;a class="lnlinks" href="#hl-18-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-13">&lt;a class="lnlinks" href="#hl-18-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-14">&lt;a class="lnlinks" href="#hl-18-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-15">&lt;a class="lnlinks" href="#hl-18-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-16">&lt;a class="lnlinks" href="#hl-18-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-17">&lt;a class="lnlinks" href="#hl-18-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-18">&lt;a class="lnlinks" href="#hl-18-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-19">&lt;a class="lnlinks" href="#hl-18-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-20">&lt;a class="lnlinks" href="#hl-18-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-21">&lt;a class="lnlinks" href="#hl-18-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-22">&lt;a class="lnlinks" href="#hl-18-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-23">&lt;a class="lnlinks" href="#hl-18-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-24">&lt;a class="lnlinks" href="#hl-18-24">24&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.constatnts&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">MqConstants&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 交换机
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HOTEL_EXCHANGE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;hotel.topic&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 监听新增和修改的队列
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HOTEL_INSERT_QUEUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;hotel.insert.queue&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 监听删除的队列
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HOTEL_DELETE_QUEUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;hotel.delete.queue&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 新增或修改的RoutingKey
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HOTEL_INSERT_KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;hotel.insert&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 删除的RoutingKey
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">static&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HOTEL_DELETE_KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;hotel.delete&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="3声明队列交换机">
&lt;a href="#3%e5%a3%b0%e6%98%8e%e9%98%9f%e5%88%97%e4%ba%a4%e6%8d%a2%e6%9c%ba" class="header-anchor">#&lt;/a>
3）声明队列交换机
&lt;/h4>&lt;p>在hotel-demo中，定义配置类，声明队列、交换机：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-5">&lt;a class="lnlinks" href="#hl-19-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-6">&lt;a class="lnlinks" href="#hl-19-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-7">&lt;a class="lnlinks" href="#hl-19-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-8">&lt;a class="lnlinks" href="#hl-19-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-9">&lt;a class="lnlinks" href="#hl-19-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-10">&lt;a class="lnlinks" href="#hl-19-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-11">&lt;a class="lnlinks" href="#hl-19-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-12">&lt;a class="lnlinks" href="#hl-19-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-13">&lt;a class="lnlinks" href="#hl-19-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-14">&lt;a class="lnlinks" href="#hl-19-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-15">&lt;a class="lnlinks" href="#hl-19-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-16">&lt;a class="lnlinks" href="#hl-19-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-17">&lt;a class="lnlinks" href="#hl-19-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-18">&lt;a class="lnlinks" href="#hl-19-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-19">&lt;a class="lnlinks" href="#hl-19-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-20">&lt;a class="lnlinks" href="#hl-19-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-21">&lt;a class="lnlinks" href="#hl-19-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-22">&lt;a class="lnlinks" href="#hl-19-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-23">&lt;a class="lnlinks" href="#hl-19-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-24">&lt;a class="lnlinks" href="#hl-19-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-25">&lt;a class="lnlinks" href="#hl-19-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-26">&lt;a class="lnlinks" href="#hl-19-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-27">&lt;a class="lnlinks" href="#hl-19-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-28">&lt;a class="lnlinks" href="#hl-19-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-29">&lt;a class="lnlinks" href="#hl-19-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-30">&lt;a class="lnlinks" href="#hl-19-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-31">&lt;a class="lnlinks" href="#hl-19-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-32">&lt;a class="lnlinks" href="#hl-19-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-33">&lt;a class="lnlinks" href="#hl-19-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-34">&lt;a class="lnlinks" href="#hl-19-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-35">&lt;a class="lnlinks" href="#hl-19-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-36">&lt;a class="lnlinks" href="#hl-19-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-37">&lt;a class="lnlinks" href="#hl-19-37">37&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.config&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.constants.MqConstants&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.core.Binding&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.core.BindingBuilder&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.core.Queue&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.core.TopicExchange&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.context.annotation.Bean&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.context.annotation.Configuration&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Configuration&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">MqConfig&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TopicExchange&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">topicExchange&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TopicExchange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">MqConstants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HOTEL_EXCHANGE&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">insertQueue&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">MqConstants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HOTEL_INSERT_QUEUE&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">deleteQueue&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Queue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">MqConstants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HOTEL_DELETE_QUEUE&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Binding&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">insertQueueBinding&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BindingBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">insertQueue&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="na">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">topicExchange&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="na">with&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">MqConstants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HOTEL_INSERT_KEY&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Binding&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">deleteQueueBinding&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BindingBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">deleteQueue&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="na">to&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">topicExchange&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="na">with&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">MqConstants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HOTEL_DELETE_KEY&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="324发送mq消息">
&lt;a href="#324%e5%8f%91%e9%80%81mq%e6%b6%88%e6%81%af" class="header-anchor">#&lt;/a>
3.2.4.发送MQ消息
&lt;/h3>&lt;p>在hotel-admin中的增、删、改业务中分别发送MQ消息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-172b82dae0cf95.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723221843816"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="325接收mq消息">
&lt;a href="#325%e6%8e%a5%e6%94%b6mq%e6%b6%88%e6%81%af" class="header-anchor">#&lt;/a>
3.2.5.接收MQ消息
&lt;/h3>&lt;p>hotel-demo接收到MQ消息要做的事情包括：&lt;/p>
&lt;ul>
&lt;li>新增消息：根据传递的hotel的id查询hotel信息，然后新增一条数据到索引库&lt;/li>
&lt;li>删除消息：根据传递的hotel的id删除索引库中的一条数据&lt;/li>
&lt;/ul>
&lt;p>1）首先在hotel-demo的&lt;code>cn.itcast.hotel.service&lt;/code>包下的&lt;code>IHotelService&lt;/code>中新增新增、删除业务&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">deleteById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">insertById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）给hotel-demo中的&lt;code>cn.itcast.hotel.service.impl&lt;/code>包下的HotelService中实现业务：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-21-1">&lt;a class="lnlinks" href="#hl-21-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-2">&lt;a class="lnlinks" href="#hl-21-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-3">&lt;a class="lnlinks" href="#hl-21-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-4">&lt;a class="lnlinks" href="#hl-21-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-5">&lt;a class="lnlinks" href="#hl-21-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-6">&lt;a class="lnlinks" href="#hl-21-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-7">&lt;a class="lnlinks" href="#hl-21-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-8">&lt;a class="lnlinks" href="#hl-21-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-9">&lt;a class="lnlinks" href="#hl-21-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-10">&lt;a class="lnlinks" href="#hl-21-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-11">&lt;a class="lnlinks" href="#hl-21-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-12">&lt;a class="lnlinks" href="#hl-21-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-13">&lt;a class="lnlinks" href="#hl-21-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-14">&lt;a class="lnlinks" href="#hl-21-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-15">&lt;a class="lnlinks" href="#hl-21-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-16">&lt;a class="lnlinks" href="#hl-21-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-17">&lt;a class="lnlinks" href="#hl-21-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-18">&lt;a class="lnlinks" href="#hl-21-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-19">&lt;a class="lnlinks" href="#hl-21-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-20">&lt;a class="lnlinks" href="#hl-21-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-21">&lt;a class="lnlinks" href="#hl-21-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-22">&lt;a class="lnlinks" href="#hl-21-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-23">&lt;a class="lnlinks" href="#hl-21-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-24">&lt;a class="lnlinks" href="#hl-21-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-25">&lt;a class="lnlinks" href="#hl-21-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-26">&lt;a class="lnlinks" href="#hl-21-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-27">&lt;a class="lnlinks" href="#hl-21-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-28">&lt;a class="lnlinks" href="#hl-21-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-29">&lt;a class="lnlinks" href="#hl-21-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-21-30">&lt;a class="lnlinks" href="#hl-21-30">30&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">deleteById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">DeleteRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DeleteRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuntimeException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">insertById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">try&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 0.根据id查询酒店数据&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Hotel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">getById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 转换为文档类型&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HotelDoc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.准备Request对象&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">IndexRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IndexRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hotel&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">id&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hotel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.准备Json文档&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">source&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">JSON&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">toJSONString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hotelDoc&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">XContentType&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">JSON&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 3.发送请求&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">index&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">DEFAULT&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">catch&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">throw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RuntimeException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）编写监听器&lt;/p>
&lt;p>在hotel-demo中的&lt;code>cn.itcast.hotel.mq&lt;/code>包新增一个类：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-22-1">&lt;a class="lnlinks" href="#hl-22-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-2">&lt;a class="lnlinks" href="#hl-22-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-3">&lt;a class="lnlinks" href="#hl-22-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-4">&lt;a class="lnlinks" href="#hl-22-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-5">&lt;a class="lnlinks" href="#hl-22-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-6">&lt;a class="lnlinks" href="#hl-22-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-7">&lt;a class="lnlinks" href="#hl-22-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-8">&lt;a class="lnlinks" href="#hl-22-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-9">&lt;a class="lnlinks" href="#hl-22-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-10">&lt;a class="lnlinks" href="#hl-22-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-11">&lt;a class="lnlinks" href="#hl-22-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-12">&lt;a class="lnlinks" href="#hl-22-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-13">&lt;a class="lnlinks" href="#hl-22-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-14">&lt;a class="lnlinks" href="#hl-22-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-15">&lt;a class="lnlinks" href="#hl-22-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-16">&lt;a class="lnlinks" href="#hl-22-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-17">&lt;a class="lnlinks" href="#hl-22-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-18">&lt;a class="lnlinks" href="#hl-22-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-19">&lt;a class="lnlinks" href="#hl-22-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-20">&lt;a class="lnlinks" href="#hl-22-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-21">&lt;a class="lnlinks" href="#hl-22-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-22">&lt;a class="lnlinks" href="#hl-22-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-23">&lt;a class="lnlinks" href="#hl-22-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-24">&lt;a class="lnlinks" href="#hl-22-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-25">&lt;a class="lnlinks" href="#hl-22-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-26">&lt;a class="lnlinks" href="#hl-22-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-27">&lt;a class="lnlinks" href="#hl-22-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-28">&lt;a class="lnlinks" href="#hl-22-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-29">&lt;a class="lnlinks" href="#hl-22-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-30">&lt;a class="lnlinks" href="#hl-22-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-31">&lt;a class="lnlinks" href="#hl-22-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-22-32">&lt;a class="lnlinks" href="#hl-22-32">32&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.mq&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.constants.MqConstants&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.hotel.service.IHotelService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.amqp.rabbit.annotation.RabbitListener&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.factory.annotation.Autowired&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.stereotype.Component&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Component&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">HotelListener&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IHotelService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hotelService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 监听酒店新增或修改的业务
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param id 酒店id
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queues&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MqConstants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HOTEL_INSERT_QUEUE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenHotelInsertOrUpdate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">hotelService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">insertById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 监听酒店删除的业务
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param id 酒店id
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@RabbitListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queues&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MqConstants&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">HOTEL_DELETE_QUEUE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">listenHotelDelete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">hotelService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">deleteById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="4集群">
&lt;a href="#4%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.集群
&lt;/h1>&lt;p>单机的elasticsearch做数据存储，必然面临两个问题：海量数据存储问题、单点故障问题。&lt;/p>
&lt;ul>
&lt;li>海量数据存储问题：将索引库从逻辑上拆分为N个分片（shard），存储到多个节点&lt;/li>
&lt;li>单点故障问题：将分片数据在不同节点备份（replica ）&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ES集群相关概念&lt;/strong>:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>集群（cluster）：一组拥有共同的 cluster name 的 节点。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;font color="red">节点（node)&lt;/font> ：集群中的一个 Elasticearch 实例&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;font color="red">分片（shard）&lt;/font>：索引可以被拆分为不同的部分进行存储，称为分片。在集群环境下，一个索引的不同分片可以拆分到不同的节点中&lt;/p>
&lt;p>解决问题：数据量太大，单点存储量有限的问题。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-0ae3c328ff4c10.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20200104124440086"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;blockquote>
&lt;p>此处，我们把数据分成3片：shard0、shard1、shard2&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>主分片（Primary shard）：相对于副本分片的定义。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>副本分片（Replica shard）每个主分片可以有一个或者多个副本，数据和主分片一样。&lt;/p>
&lt;p>​&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本实在是太高了！&lt;/p>
&lt;p>为了在高可用和成本间寻求平衡，我们可以这样做：&lt;/p>
&lt;ul>
&lt;li>首先对数据分片，存储到不同节点&lt;/li>
&lt;li>然后对每个分片进行备份，放到对方节点，完成互相备份&lt;/li>
&lt;/ul>
&lt;p>这样可以大大减少所需要的服务节点数量，如图，我们以3分片，每个分片备份一份为例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-814ac98fabb71c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20200104124551912"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>现在，每个分片都有1个备份，存储在3个节点：&lt;/p>
&lt;ul>
&lt;li>node0：保存了分片0和1&lt;/li>
&lt;li>node1：保存了分片0和2&lt;/li>
&lt;li>node2：保存了分片1和2&lt;/li>
&lt;/ul>
&lt;h2 id="41搭建es集群">
&lt;a href="#41%e6%90%ad%e5%bb%baes%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.1.搭建ES集群
&lt;/h2>&lt;p>参考课前资料的文档：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-d2eb04fcf0b107.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723222732427"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的第四章节：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-61553cc6e7ce28.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723222812619"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="42集群脑裂问题">
&lt;a href="#42%e9%9b%86%e7%be%a4%e8%84%91%e8%a3%82%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
4.2.集群脑裂问题
&lt;/h2>&lt;h3 id="421集群职责划分">
&lt;a href="#421%e9%9b%86%e7%be%a4%e8%81%8c%e8%b4%a3%e5%88%92%e5%88%86" class="header-anchor">#&lt;/a>
4.2.1.集群职责划分
&lt;/h3>&lt;p>elasticsearch中集群节点有不同的职责划分：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-b3b6f0c4c8f17d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723223008967"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>默认情况下，集群中的任何一个节点都同时具备上述四种角色。&lt;/p>
&lt;p>但是真实的集群一定要将集群职责分离：&lt;/p>
&lt;ul>
&lt;li>master节点：对CPU要求高，但是内存要求第&lt;/li>
&lt;li>data节点：对CPU和内存要求都高&lt;/li>
&lt;li>coordinating节点：对网络带宽、CPU要求高&lt;/li>
&lt;/ul>
&lt;p>职责分离可以让我们根据不同节点的需求分配不同的硬件去部署。而且避免业务之间的互相干扰。&lt;/p>
&lt;p>一个典型的es集群职责划分如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-9307b0ab9c6abd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723223629142"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="422脑裂问题">
&lt;a href="#422%e8%84%91%e8%a3%82%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
4.2.2.脑裂问题
&lt;/h3>&lt;p>脑裂是因为集群中的节点失联导致的。&lt;/p>
&lt;p>例如一个集群中，主节点与其它节点失联：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-13210dd91cf865.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723223804995"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>此时，node2和node3认为node1宕机，就会重新选主：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-95fc409e08d785.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723223845754"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>当node3当选后，集群继续对外提供服务，node2和node3自成集群，node1自成集群，两个集群数据不同步，出现数据差异。&lt;/p>
&lt;p>当网络恢复后，因为集群中有两个master节点，集群状态的不一致，出现脑裂的情况：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-fe91151d7b3236.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723224000555"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解决脑裂的方案是，要求选票超过 ( eligible节点数量 + 1 ）/ 2 才能当选为主，因此eligible节点数量最好是奇数。对应配置项是discovery.zen.minimum_master_nodes，在es7.0以后，已经成为默认配置，因此一般不会发生脑裂问题&lt;/p>
&lt;p>例如：3个节点形成的集群，选票必须超过 （3 + 1） / 2 ，也就是2票。node3得到node2和node3的选票，当选为主。node1只有自己1票，没有当选。集群中依然只有1个主节点，没有出现脑裂。&lt;/p>
&lt;h3 id="423小结">
&lt;a href="#423%e5%b0%8f%e7%bb%93" class="header-anchor">#&lt;/a>
4.2.3.小结
&lt;/h3>&lt;p>master eligible节点的作用是什么？&lt;/p>
&lt;ul>
&lt;li>参与集群选主&lt;/li>
&lt;li>主节点可以管理集群状态、管理分片信息、处理创建和删除索引库的请求&lt;/li>
&lt;/ul>
&lt;p>data节点的作用是什么？&lt;/p>
&lt;ul>
&lt;li>数据的CRUD&lt;/li>
&lt;/ul>
&lt;p>coordinator节点的作用是什么？&lt;/p>
&lt;ul>
&lt;li>
&lt;p>路由请求到其它节点&lt;/p>
&lt;/li>
&lt;li>
&lt;p>合并查询到的结果，返回给用户&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="43集群分布式存储">
&lt;a href="#43%e9%9b%86%e7%be%a4%e5%88%86%e5%b8%83%e5%bc%8f%e5%ad%98%e5%82%a8" class="header-anchor">#&lt;/a>
4.3.集群分布式存储
&lt;/h2>&lt;p>当新增文档时，应该保存到不同分片，保证数据均衡，那么coordinating node如何确定数据该存储到哪个分片呢？&lt;/p>
&lt;h3 id="431分片存储测试">
&lt;a href="#431%e5%88%86%e7%89%87%e5%ad%98%e5%82%a8%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
4.3.1.分片存储测试
&lt;/h3>&lt;p>插入三条数据：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-3cd81f59f64d41.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723225006058"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-b4371a91c23fcd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723225034637"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-736882fcc56032.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723225112029"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>测试可以看到，三条数据分别在不同分片：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-bf71b1a7c551bd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723225227928"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-f61cd2868db8ab.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723225342120"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="432分片存储原理">
&lt;a href="#432%e5%88%86%e7%89%87%e5%ad%98%e5%82%a8%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
4.3.2.分片存储原理
&lt;/h3>&lt;p>elasticsearch会通过hash算法来计算文档应该存储到哪个分片：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-6e75ed305a423d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723224354904"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>说明：&lt;/p>
&lt;ul>
&lt;li>_routing默认是文档的id&lt;/li>
&lt;li>算法与分片数量有关，因此索引库一旦创建，分片数量不能修改！&lt;/li>
&lt;/ul>
&lt;p>新增文档的流程如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-bf8a5edf9ff0e4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723225436084"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解读：&lt;/p>
&lt;ul>
&lt;li>1）新增一个id=1的文档&lt;/li>
&lt;li>2）对id做hash运算，假如得到的是2，则应该存储到shard-2&lt;/li>
&lt;li>3）shard-2的主分片在node3节点，将数据路由到node3&lt;/li>
&lt;li>4）保存文档&lt;/li>
&lt;li>5）同步给shard-2的副本replica-2，在node2节点&lt;/li>
&lt;li>6）返回结果给coordinating-node节点&lt;/li>
&lt;/ul>
&lt;h2 id="44集群分布式查询">
&lt;a href="#44%e9%9b%86%e7%be%a4%e5%88%86%e5%b8%83%e5%bc%8f%e6%9f%a5%e8%af%a2" class="header-anchor">#&lt;/a>
4.4.集群分布式查询
&lt;/h2>&lt;p>elasticsearch的查询分成两个阶段：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>scatter phase：分散阶段，coordinating node会把请求分发到每一个分片&lt;/p>
&lt;/li>
&lt;li>
&lt;p>gather phase：聚集阶段，coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-eae1e5fde4ee62.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723225809848"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="45集群故障转移">
&lt;a href="#45%e9%9b%86%e7%be%a4%e6%95%85%e9%9a%9c%e8%bd%ac%e7%a7%bb" class="header-anchor">#&lt;/a>
4.5.集群故障转移
&lt;/h2>&lt;p>集群的master节点会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其它节点，确保数据安全，这个叫做故障转移。&lt;/p>
&lt;p>1）例如一个集群结构如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-ee4d6240398ad4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723225945963"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>现在，node1是主节点，其它两个节点是从节点。&lt;/p>
&lt;p>2）突然，node1发生了故障：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-65a0eeb6272ee3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723230020574"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>宕机后的第一件事，需要重新选主，例如选中了node2：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-9ed47610985b30.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723230055974"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>node2成为主节点后，会检测集群监控状态，发现：shard-1、shard-0没有副本节点。因此需要将node1上的数据迁移到node2、node3：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738359-e3ffa30723c7dd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210723230216642"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p></description></item><item><title>8.sentinel规则持久化</title><link>https://logan.wssw.fun/p/2023/01/4916u149/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/4916u149/</guid><description>&lt;h1 id="sentinel-规则持久化">
&lt;a href="#sentinel-%e8%a7%84%e5%88%99%e6%8c%81%e4%b9%85%e5%8c%96" class="header-anchor">#&lt;/a>
Sentinel 规则持久化
&lt;/h1>&lt;h2 id="一修改order-service服务">
&lt;a href="#%e4%b8%80%e4%bf%ae%e6%94%b9order-service%e6%9c%8d%e5%8a%a1" class="header-anchor">#&lt;/a>
一、修改order-service服务
&lt;/h2>&lt;p>修改OrderService，让其监听Nacos中的sentinel规则配置。&lt;/p>
&lt;p>具体步骤如下：&lt;/p>
&lt;h3 id="1引入依赖">
&lt;a href="#1%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96" class="header-anchor">#&lt;/a>
1.引入依赖
&lt;/h3>&lt;p>在order-service中引入sentinel监听nacos的依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.alibaba.csp&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>sentinel-datasource-nacos&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2配置nacos地址">
&lt;a href="#2%e9%85%8d%e7%bd%aenacos%e5%9c%b0%e5%9d%80" class="header-anchor">#&lt;/a>
2.配置nacos地址
&lt;/h3>&lt;p>在order-service中的application.yml文件配置nacos地址及监听的配置信息：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-9">&lt;a class="lnlinks" href="#hl-1-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-10">&lt;a class="lnlinks" href="#hl-1-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">sentinel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">datasource&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">flow&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server-addr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost:8848&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># nacos地址&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dataId&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">orderservice-flow-rules&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">groupId&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">SENTINEL_GROUP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rule-type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">flow&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 还可以是：degrade、authority、param-flow&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="二修改sentinel-dashboard源码">
&lt;a href="#%e4%ba%8c%e4%bf%ae%e6%94%b9sentinel-dashboard%e6%ba%90%e7%a0%81" class="header-anchor">#&lt;/a>
二、修改sentinel-dashboard源码
&lt;/h2>&lt;p>SentinelDashboard默认不支持nacos的持久化，需要修改源码。&lt;/p>
&lt;h3 id="1-解压">
&lt;a href="#1-%e8%a7%a3%e5%8e%8b" class="header-anchor">#&lt;/a>
1. 解压
&lt;/h3>&lt;p>解压课前资料中的sentinel源码包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739924-f311122ac91e01.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210618201340086"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后并用IDEA打开这个项目，结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739924-43edda3d86b33a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210618201412878"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="2-修改nacos依赖">
&lt;a href="#2-%e4%bf%ae%e6%94%b9nacos%e4%be%9d%e8%b5%96" class="header-anchor">#&lt;/a>
2. 修改nacos依赖
&lt;/h3>&lt;p>在sentinel-dashboard源码的pom文件中，nacos的依赖默认的scope是test，只能在测试时使用，这里要去除：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739924-f380ab1f27f1a5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210618201607831"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>将sentinel-datasource-nacos依赖的scope去掉：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.alibaba.csp&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>sentinel-datasource-nacos&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3-添加nacos支持">
&lt;a href="#3-%e6%b7%bb%e5%8a%a0nacos%e6%94%af%e6%8c%81" class="header-anchor">#&lt;/a>
3. 添加nacos支持
&lt;/h3>&lt;p>在sentinel-dashboard的test包下，已经编写了对nacos的支持，我们需要将其拷贝到main下。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739924-99c151c2748609.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210618201726280"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="4-修改nacos地址">
&lt;a href="#4-%e4%bf%ae%e6%94%b9nacos%e5%9c%b0%e5%9d%80" class="header-anchor">#&lt;/a>
4. 修改nacos地址
&lt;/h3>&lt;p>然后，还需要修改测试代码中的NacosConfig类：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739924-24472f1ad8498e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210618201912078"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>修改其中的nacos地址，让其读取application.properties中的配置：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739924-3e2abf3aea5c77.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210618202047575"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在sentinel-dashboard的application.properties中添加nacos地址配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="na">nacos.addr&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">localhost:8848&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="5-配置nacos数据源">
&lt;a href="#5-%e9%85%8d%e7%bd%aenacos%e6%95%b0%e6%8d%ae%e6%ba%90" class="header-anchor">#&lt;/a>
5. 配置nacos数据源
&lt;/h3>&lt;p>另外，还需要修改com.alibaba.csp.sentinel.dashboard.controller.v2包下的FlowControllerV2类：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739924-7d41fc5d2a12d9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210618202322301"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>让我们添加的Nacos数据源生效：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739924-b582cf3865b65c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210618202334536"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="6-修改前端页面">
&lt;a href="#6-%e4%bf%ae%e6%94%b9%e5%89%8d%e7%ab%af%e9%a1%b5%e9%9d%a2" class="header-anchor">#&lt;/a>
6. 修改前端页面
&lt;/h3>&lt;p>接下来，还要修改前端页面，添加一个支持nacos的菜单。&lt;/p>
&lt;p>修改src/main/webapp/resources/app/scripts/directives/sidebar/目录下的sidebar.html文件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739924-77127e56872a3c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210618202433356"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>将其中的这部分注释打开：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739924-52553a64bf2bc5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210618202449881"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>修改其中的文本：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739924-5fcc236d568d75.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210618202501928"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="7-重新编译打包项目">
&lt;a href="#7-%e9%87%8d%e6%96%b0%e7%bc%96%e8%af%91%e6%89%93%e5%8c%85%e9%a1%b9%e7%9b%ae" class="header-anchor">#&lt;/a>
7. 重新编译、打包项目
&lt;/h3>&lt;p>运行IDEA中的maven插件，编译和打包修改好的Sentinel-Dashboard：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739924-983dee110cb12f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210618202701492"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="8启动">
&lt;a href="#8%e5%90%af%e5%8a%a8" class="header-anchor">#&lt;/a>
8.启动
&lt;/h3>&lt;p>启动方式跟官方一样：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">java -jar sentinel-dashboard.jar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果要修改nacos地址，需要添加参数：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">java -jar -Dnacos.addr&lt;span class="o">=&lt;/span>localhost:8848 sentinel-dashboard.jar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>8.微服务保护</title><link>https://logan.wssw.fun/p/2023/01/157v3815/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/157v3815/</guid><description>&lt;h1 id="微服务保护">
&lt;a href="#%e5%be%ae%e6%9c%8d%e5%8a%a1%e4%bf%9d%e6%8a%a4" class="header-anchor">#&lt;/a>
微服务保护
&lt;/h1>&lt;h1 id="1初识sentinel">
&lt;a href="#1%e5%88%9d%e8%af%86sentinel" class="header-anchor">#&lt;/a>
1.初识Sentinel
&lt;/h1>&lt;h2 id="11雪崩问题及解决方案">
&lt;a href="#11%e9%9b%aa%e5%b4%a9%e9%97%ae%e9%a2%98%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88" class="header-anchor">#&lt;/a>
1.1.雪崩问题及解决方案
&lt;/h2>&lt;h3 id="111雪崩问题">
&lt;a href="#111%e9%9b%aa%e5%b4%a9%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
1.1.1.雪崩问题
&lt;/h3>&lt;p>微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-9c410b76246fd1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1533829099748"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如图，如果服务提供者I发生了故障，当前的应用的部分业务因为依赖于服务I，因此也会被阻塞。此时，其它不依赖于服务I的业务似乎不受影响。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-e684b16bf6d661.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1533829198240"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>但是，依赖服务I的业务请求被阻塞，用户不会得到响应，则tomcat的这个线程不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-003ecb87784b2b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="1533829307389"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，那么当前服务也就不可用了。&lt;/p>
&lt;p>那么，依赖于当前服务的其它服务随着时间的推移，最终也都会变的不可用，形成级联失败，雪崩就发生了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-f05fc2790354d1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715172710340"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="112超时处理">
&lt;a href="#112%e8%b6%85%e6%97%b6%e5%a4%84%e7%90%86" class="header-anchor">#&lt;/a>
1.1.2.超时处理
&lt;/h3>&lt;p>解决雪崩问题的常见方式有四种：&lt;/p>
&lt;p>•超时处理：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-38f9c5a755977e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715172820438"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="113仓壁模式">
&lt;a href="#113%e4%bb%93%e5%a3%81%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
1.1.3.仓壁模式
&lt;/h3>&lt;p>方案2：仓壁模式&lt;/p>
&lt;p>仓壁模式来源于船舱的设计：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-21b282cdd77de9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715172946352"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。&lt;/p>
&lt;p>于此类似，我们可以限定每个业务能使用的线程数，避免耗尽整个tomcat的资源，因此也叫线程隔离。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-8f1f5df7487629.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715173215243"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="114断路器">
&lt;a href="#114%e6%96%ad%e8%b7%af%e5%99%a8" class="header-anchor">#&lt;/a>
1.1.4.断路器
&lt;/h3>&lt;p>断路器模式：由&lt;strong>断路器&lt;/strong>统计业务执行的异常比例，如果超出阈值则会&lt;strong>熔断&lt;/strong>该业务，拦截访问该业务的一切请求。&lt;/p>
&lt;p>断路器会统计访问某个服务的请求数量，异常比例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-2cd8a62efe9b27.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715173327075"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>当发现访问服务D的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务D的一切请求，形成熔断：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-0514466b9f9995.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715173428073"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="115限流">
&lt;a href="#115%e9%99%90%e6%b5%81" class="header-anchor">#&lt;/a>
1.1.5.限流
&lt;/h3>&lt;p>&lt;strong>流量控制&lt;/strong>：限制业务访问的QPS，避免服务因流量的突增而故障。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-f3446b81b24dac.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715173555158"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="116总结">
&lt;a href="#116%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
1.1.6.总结
&lt;/h3>&lt;p>什么是雪崩问题？&lt;/p>
&lt;ul>
&lt;li>微服务之间相互调用，因为调用链中的一个服务故障，引起整个链路都无法访问的情况。&lt;/li>
&lt;/ul>
&lt;p>可以认为：&lt;/p>
&lt;p>&lt;strong>限流&lt;/strong>是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种&lt;strong>预防&lt;/strong>措施。&lt;/p>
&lt;p>&lt;strong>超时处理、线程隔离、降级熔断&lt;/strong>是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种&lt;strong>补救&lt;/strong>措施。&lt;/p>
&lt;h2 id="12服务保护技术对比">
&lt;a href="#12%e6%9c%8d%e5%8a%a1%e4%bf%9d%e6%8a%a4%e6%8a%80%e6%9c%af%e5%af%b9%e6%af%94" class="header-anchor">#&lt;/a>
1.2.服务保护技术对比
&lt;/h2>&lt;p>在SpringCloud当中支持多种服务保护技术：&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://github.com/Netflix/Hystrix" target="_blank" rel="noopener"
>Netfix Hystrix
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/alibaba/Sentinel" target="_blank" rel="noopener"
>Sentinel
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/resilience4j/resilience4j" target="_blank" rel="noopener"
>Resilience4J
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>早期比较流行的是Hystrix框架，但目前国内实用最广泛的还是阿里巴巴的Sentinel框架，这里我们做下对比：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;/th>
&lt;th>&lt;strong>Sentinel&lt;/strong>&lt;/th>
&lt;th>&lt;strong>Hystrix&lt;/strong>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>隔离策略&lt;/td>
&lt;td>信号量隔离&lt;/td>
&lt;td>线程池隔离/信号量隔离&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>熔断降级策略&lt;/td>
&lt;td>基于慢调用比例或异常比例&lt;/td>
&lt;td>基于失败比率&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>实时指标实现&lt;/td>
&lt;td>滑动窗口&lt;/td>
&lt;td>滑动窗口（基于 RxJava）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>规则配置&lt;/td>
&lt;td>支持多种数据源&lt;/td>
&lt;td>支持多种数据源&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>扩展性&lt;/td>
&lt;td>多个扩展点&lt;/td>
&lt;td>插件的形式&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>基于注解的支持&lt;/td>
&lt;td>支持&lt;/td>
&lt;td>支持&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>限流&lt;/td>
&lt;td>基于 QPS，支持基于调用关系的限流&lt;/td>
&lt;td>有限的支持&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>流量整形&lt;/td>
&lt;td>支持慢启动、匀速排队模式&lt;/td>
&lt;td>不支持&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>系统自适应保护&lt;/td>
&lt;td>支持&lt;/td>
&lt;td>不支持&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>控制台&lt;/td>
&lt;td>开箱即用，可配置规则、查看秒级监控、机器发现等&lt;/td>
&lt;td>不完善&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>常见框架的适配&lt;/td>
&lt;td>Servlet、Spring Cloud、Dubbo、gRPC 等&lt;/td>
&lt;td>Servlet、Spring Cloud Netflix&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="13sentinel介绍和安装">
&lt;a href="#13sentinel%e4%bb%8b%e7%bb%8d%e5%92%8c%e5%ae%89%e8%a3%85" class="header-anchor">#&lt;/a>
1.3.Sentinel介绍和安装
&lt;/h2>&lt;h3 id="131初识sentinel">
&lt;a href="#131%e5%88%9d%e8%af%86sentinel" class="header-anchor">#&lt;/a>
1.3.1.初识Sentinel
&lt;/h3>&lt;p>Sentinel是阿里巴巴开源的一款微服务流量控制组件。官网地址：https://sentinelguard.io/zh-cn/index.html&lt;/p>
&lt;p>Sentinel 具有以下特征:&lt;/p>
&lt;p>•&lt;strong>丰富的应用场景&lt;/strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。&lt;/p>
&lt;p>•&lt;strong>完备的实时监控&lt;/strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。&lt;/p>
&lt;p>•&lt;strong>广泛的开源生态&lt;/strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。&lt;/p>
&lt;p>•&lt;strong>完善的&lt;/strong> &lt;strong>SPI&lt;/strong> &lt;strong>扩展点&lt;/strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。&lt;/p>
&lt;h3 id="132安装sentinel">
&lt;a href="#132%e5%ae%89%e8%a3%85sentinel" class="header-anchor">#&lt;/a>
1.3.2.安装Sentinel
&lt;/h3>&lt;p>1）下载&lt;/p>
&lt;p>sentinel官方提供了UI控制台，方便我们对系统做限流设置。大家可以在&lt;a class="link" href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener"
>GitHub
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>下载。&lt;/p>
&lt;p>课前资料也提供了下载好的jar包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-21f5c7d8fac4f8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715174252531"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>2）运行&lt;/p>
&lt;p>将jar包放到任意非中文目录，执行命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">java -jar sentinel-dashboard-1.8.1.jar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>配置项&lt;/strong>&lt;/th>
&lt;th>&lt;strong>默认值&lt;/strong>&lt;/th>
&lt;th>&lt;strong>说明&lt;/strong>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>server.port&lt;/td>
&lt;td>8080&lt;/td>
&lt;td>服务端口&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>sentinel.dashboard.auth.username&lt;/td>
&lt;td>sentinel&lt;/td>
&lt;td>默认用户名&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>sentinel.dashboard.auth.password&lt;/td>
&lt;td>sentinel&lt;/td>
&lt;td>默认密码&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>例如，修改端口：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">java -Dserver.port&lt;span class="o">=&lt;/span>&lt;span class="m">8090&lt;/span> -jar sentinel-dashboard-1.8.1.jar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）访问&lt;/p>
&lt;p>访问http://localhost:8080页面，就可以看到sentinel的控制台了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-f340741a0f78c8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715190827846"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>需要输入账号和密码，默认都是：sentinel&lt;/p>
&lt;p>登录后，发现一片空白，什么都没有：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-78ac30beeaf4ca.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715191134448"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这是因为我们还没有与微服务整合。&lt;/p>
&lt;h2 id="14微服务整合sentinel">
&lt;a href="#14%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%95%b4%e5%90%88sentinel" class="header-anchor">#&lt;/a>
1.4.微服务整合Sentinel
&lt;/h2>&lt;p>我们在order-service中整合sentinel，并连接sentinel的控制台，步骤如下：&lt;/p>
&lt;p>1）引入sentinel依赖&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!--sentinel--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.alibaba.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-alibaba-sentinel&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）配置控制台&lt;/p>
&lt;p>修改application.yaml文件，添加下面内容：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-7">&lt;a class="lnlinks" href="#hl-3-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8088&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">sentinel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">transport&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dashboard&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost:8080&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）访问order-service的任意端点&lt;/p>
&lt;p>打开浏览器，访问http://localhost:8088/order/101，这样才能触发sentinel的监控。&lt;/p>
&lt;p>然后再访问sentinel的控制台，查看效果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-4f14b85544e4f7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715191241799"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="2流量控制">
&lt;a href="#2%e6%b5%81%e9%87%8f%e6%8e%a7%e5%88%b6" class="header-anchor">#&lt;/a>
2.流量控制
&lt;/h1>&lt;p>雪崩问题虽然有四种方案，但是限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。&lt;/p>
&lt;h2 id="21簇点链路">
&lt;a href="#21%e7%b0%87%e7%82%b9%e9%93%be%e8%b7%af" class="header-anchor">#&lt;/a>
2.1.簇点链路
&lt;/h2>&lt;p>当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的一个调用链就叫做&lt;strong>簇点链路&lt;/strong>。簇点链路中被监控的每一个接口就是一个&lt;strong>资源&lt;/strong>。&lt;/p>
&lt;p>默认情况下sentinel会监控SpringMVC的每一个端点（Endpoint，也就是controller中的方法），因此SpringMVC的每一个端点（Endpoint）就是调用链路中的一个资源。&lt;/p>
&lt;p>例如，我们刚才访问的order-service中的OrderController中的端点：/order/{orderId}&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-941f68c905315f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715191757319"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>流控、熔断等都是针对簇点链路中的资源来设置的，因此我们可以点击对应资源后面的按钮来设置规则：&lt;/p>
&lt;ul>
&lt;li>流控：流量控制&lt;/li>
&lt;li>降级：降级熔断&lt;/li>
&lt;li>热点：热点参数限流，是限流的一种&lt;/li>
&lt;li>授权：请求的权限控制&lt;/li>
&lt;/ul>
&lt;h2 id="21快速入门">
&lt;a href="#21%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8" class="header-anchor">#&lt;/a>
2.1.快速入门
&lt;/h2>&lt;h3 id="211示例">
&lt;a href="#211%e7%a4%ba%e4%be%8b" class="header-anchor">#&lt;/a>
2.1.1.示例
&lt;/h3>&lt;p>点击资源/order/{orderId}后面的流控按钮，就可以弹出表单。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-941f68c905315f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715191757319"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>表单中可以填写限流规则，如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-20224e3a2e3b00.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715192010657"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其含义是限制 /order/{orderId}这个资源的单机QPS为1，即每秒只允许1次请求，超出的请求会被拦截并报错。&lt;/p>
&lt;h3 id="212练习">
&lt;a href="#212%e7%bb%83%e4%b9%a0" class="header-anchor">#&lt;/a>
2.1.2.练习：
&lt;/h3>&lt;p>需求：给 /order/{orderId}这个资源设置流控规则，QPS不能超过 5，然后测试。&lt;/p>
&lt;p>1）首先在sentinel控制台添加限流规则&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-5b385084f65c20.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715192455429"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>2）利用jmeter测试&lt;/p>
&lt;p>如果没有用过jmeter，可以参考课前资料提供的文档《Jmeter快速入门.md》&lt;/p>
&lt;p>课前资料提供了编写好的Jmeter测试样例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-e20c0a5b53ac05.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715200431615"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>打开jmeter，导入课前资料提供的测试样例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-5306e9db3dee4d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715200537171"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>选择：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-b0b2297c1a9f9a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715200635414"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>20个用户，2秒内运行完，QPS是10，超过了5.&lt;/p>
&lt;p>选中&lt;code>流控入门，QPS&amp;lt;5&lt;/code>右键运行：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-9f84dc930f619b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715200804594"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;blockquote>
&lt;p>注意，不要点击菜单中的执行按钮来运行。&lt;/p>
&lt;/blockquote>
&lt;p>结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-74b01a279db41e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715200853671"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，成功的请求每次只有5个&lt;/p>
&lt;h2 id="22流控模式">
&lt;a href="#22%e6%b5%81%e6%8e%a7%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
2.2.流控模式
&lt;/h2>&lt;p>在添加限流规则时，点击高级选项，可以选择三种&lt;strong>流控模式&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式&lt;/li>
&lt;li>关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流&lt;/li>
&lt;li>链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-6f5758c2088639.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715201827886"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>快速入门测试的就是直接模式。&lt;/p>
&lt;h3 id="221关联模式">
&lt;a href="#221%e5%85%b3%e8%81%94%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
2.2.1.关联模式
&lt;/h3>&lt;p>&lt;strong>关联模式&lt;/strong>：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流&lt;/p>
&lt;p>&lt;strong>配置规则&lt;/strong>：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-c7741cc9dc9033.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715202540786"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>&lt;strong>语法说明&lt;/strong>：当/write资源访问量触发阈值时，就会对/read资源限流，避免影响/write资源。&lt;/p>
&lt;p>&lt;strong>使用场景&lt;/strong>：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。&lt;/p>
&lt;p>&lt;strong>需求说明&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>在OrderController新建两个端点：/order/query和/order/update，无需实现业务&lt;/p>
&lt;/li>
&lt;li>
&lt;p>配置流控规则，当/order/ update资源被访问的QPS超过5时，对/order/query请求限流&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>1）定义/order/query端点，模拟订单查询&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@GetMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/query&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">queryOrder&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;查询订单成功&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）定义/order/update端点，模拟订单更新&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-4">&lt;a class="lnlinks" href="#hl-5-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@GetMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/update&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">updateOrder&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;更新订单成功&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启服务，查看sentinel控制台的簇点链路：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-15bda31001dc53.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716101805951"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>3）配置流控规则&lt;/p>
&lt;p>对哪个端点限流，就点击哪个端点后面的按钮。我们是对订单查询/order/query限流，因此点击它后面的按钮：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-3c39b09edddd2f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716101934499"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在表单中填写流控规则：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-855d5982431c37.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716102103814"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>4）在Jmeter测试&lt;/p>
&lt;p>选择《流控模式-关联》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-48c6df8ea41428.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716102416266"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到1000个用户，100秒，因此QPS为10，超过了我们设定的阈值：5&lt;/p>
&lt;p>查看http请求：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-67b4dc08a4584d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716102532554"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>请求的目标是/order/update，这样这个断点就会触发阈值。&lt;/p>
&lt;p>但限流的目标是/order/query，我们在浏览器访问，可以发现：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-13715448cb928c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716102636030"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>确实被限流了。&lt;/p>
&lt;p>5）总结&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-fe421a649625f8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716103143002"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="222链路模式">
&lt;a href="#222%e9%93%be%e8%b7%af%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
2.2.2.链路模式
&lt;/h3>&lt;p>&lt;strong>链路模式&lt;/strong>：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。&lt;/p>
&lt;p>&lt;strong>配置示例&lt;/strong>：&lt;/p>
&lt;p>例如有两条请求链路：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>/test1 &amp;ndash;&amp;gt; /common&lt;/p>
&lt;/li>
&lt;li>
&lt;p>/test2 &amp;ndash;&amp;gt; /common&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>如果只希望统计从/test2进入到/common的请求，则可以这样配置：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-bd5cc4e351a599.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716103536346"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>&lt;strong>实战案例&lt;/strong>&lt;/p>
&lt;p>需求：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。&lt;/p>
&lt;p>步骤：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>在OrderService中添加一个queryGoods方法，不用实现业务&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在OrderController中，改造/order/query端点，调用OrderService中的queryGoods方法&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在OrderController中添加一个/order/save的端点，调用OrderService的queryGoods方法&lt;/p>
&lt;/li>
&lt;li>
&lt;p>给queryGoods设置限流规则，从/order/query进入queryGoods的方法限制QPS必须小于2&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>实现：&lt;/p>
&lt;h4 id="1添加查询商品方法">
&lt;a href="#1%e6%b7%bb%e5%8a%a0%e6%9f%a5%e8%af%a2%e5%95%86%e5%93%81%e6%96%b9%e6%b3%95" class="header-anchor">#&lt;/a>
1）添加查询商品方法
&lt;/h4>&lt;p>在order-service服务中，给OrderService类添加一个queryGoods方法：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">queryGoods&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;查询商品&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="2查询订单时查询商品">
&lt;a href="#2%e6%9f%a5%e8%af%a2%e8%ae%a2%e5%8d%95%e6%97%b6%e6%9f%a5%e8%af%a2%e5%95%86%e5%93%81" class="header-anchor">#&lt;/a>
2）查询订单时，查询商品
&lt;/h4>&lt;p>在order-service的OrderController中，修改/order/query端点的业务逻辑：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-8">&lt;a class="lnlinks" href="#hl-7-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@GetMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/query&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">queryOrder&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 查询商品&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">orderService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">queryGoods&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 查询订单&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;查询订单&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;查询订单成功&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="3新增订单查询商品">
&lt;a href="#3%e6%96%b0%e5%a2%9e%e8%ae%a2%e5%8d%95%e6%9f%a5%e8%af%a2%e5%95%86%e5%93%81" class="header-anchor">#&lt;/a>
3）新增订单，查询商品
&lt;/h4>&lt;p>在order-service的OrderController中，修改/order/save端点，模拟新增订单：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-6">&lt;a class="lnlinks" href="#hl-8-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-7">&lt;a class="lnlinks" href="#hl-8-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-8">&lt;a class="lnlinks" href="#hl-8-8">8&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@GetMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/save&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">saveOrder&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 查询商品&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">orderService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">queryGoods&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 查询订单&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;新增订单&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;新增订单成功&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="4给查询商品添加资源标记">
&lt;a href="#4%e7%bb%99%e6%9f%a5%e8%af%a2%e5%95%86%e5%93%81%e6%b7%bb%e5%8a%a0%e8%b5%84%e6%ba%90%e6%a0%87%e8%ae%b0" class="header-anchor">#&lt;/a>
4）给查询商品添加资源标记
&lt;/h4>&lt;p>默认情况下，OrderService中的方法是不被Sentinel监控的，需要我们自己通过注解来标记要监控的方法。&lt;/p>
&lt;p>给OrderService的queryGoods方法添加@SentinelResource注解：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@SentinelResource&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;goods&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">queryGoods&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;查询商品&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。&lt;/p>
&lt;p>我们需要关闭这种对SpringMVC的资源聚合，修改order-service服务的application.yml文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">sentinel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">web-context-unify&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 关闭context整合&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启服务，访问/order/query和/order/save，可以查看到sentinel的簇点链路规则中，出现了新的资源：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-4c74114b490b87.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716105227163"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h4 id="5添加流控规则">
&lt;a href="#5%e6%b7%bb%e5%8a%a0%e6%b5%81%e6%8e%a7%e8%a7%84%e5%88%99" class="header-anchor">#&lt;/a>
5）添加流控规则
&lt;/h4>&lt;p>点击goods资源后面的流控按钮，在弹出的表单中填写下面信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-ee63d87a35dd29.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716105408723"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>只统计从/order/query进入/goods的资源，QPS阈值为2，超出则被限流。&lt;/p>
&lt;h4 id="6jmeter测试">
&lt;a href="#6jmeter%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
6）Jmeter测试
&lt;/h4>&lt;p>选择《流控模式-链路》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-dc01957a651e7f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716105612312"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到这里200个用户，50秒内发完，QPS为4，超过了我们设定的阈值2&lt;/p>
&lt;p>一个http请求是访问/order/save：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-452420a2b4e4b1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716105812789"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>运行的结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-f658ea1e411101.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716110027064"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>完全不受影响。&lt;/p>
&lt;p>另一个是访问/order/query：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-ce6ae7adfa4e22.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716105855951"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>运行结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-3bbba8bc9c8a6a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716105956401"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>每次只有2个通过。&lt;/p>
&lt;h3 id="223总结">
&lt;a href="#223%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
2.2.3.总结
&lt;/h3>&lt;p>流控模式有哪些？&lt;/p>
&lt;p>•直接：对当前资源限流&lt;/p>
&lt;p>•关联：高优先级资源触发阈值，对低优先级资源限流。&lt;/p>
&lt;p>•链路：阈值统计时，只统计从指定资源进入当前资源的请求，是对请求来源的限流&lt;/p>
&lt;h2 id="23流控效果">
&lt;a href="#23%e6%b5%81%e6%8e%a7%e6%95%88%e6%9e%9c" class="header-anchor">#&lt;/a>
2.3.流控效果
&lt;/h2>&lt;p>在流控的高级选项中，还有一个流控效果选项：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-48f918cff3c118.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716110225104"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>流控效果是指请求达到流控阈值时应该采取的措施，包括三种：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="231warm-up">
&lt;a href="#231warm-up" class="header-anchor">#&lt;/a>
2.3.1.warm up
&lt;/h3>&lt;p>阈值一般是一个微服务能承担的最大QPS，但是一个服务刚刚启动时，一切资源尚未初始化（&lt;strong>冷启动&lt;/strong>），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。&lt;/p>
&lt;p>warm up也叫&lt;strong>预热模式&lt;/strong>，是应对服务冷启动的一种方案。请求阈值初始值是 maxThreshold / coldFactor，持续指定时长后，逐渐提高到maxThreshold值。而coldFactor的默认值是3.&lt;/p>
&lt;p>例如，我设置QPS的maxThreshold为10，预热时间为5秒，那么初始阈值就是 10 / 3 ，也就是3，然后在5秒后逐渐增长到10.&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-f794c3cdf5cf39.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716110629796"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>&lt;strong>案例&lt;/strong>&lt;/p>
&lt;p>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用warm up效果，预热时长为5秒&lt;/p>
&lt;h4 id="1配置流控规则">
&lt;a href="#1%e9%85%8d%e7%bd%ae%e6%b5%81%e6%8e%a7%e8%a7%84%e5%88%99" class="header-anchor">#&lt;/a>
1）配置流控规则：
&lt;/h4>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-b29bfe5dbd0f71.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716111012387"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h4 id="2jmeter测试">
&lt;a href="#2jmeter%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
2）Jmeter测试
&lt;/h4>&lt;p>选择《流控效果，warm up》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-822d60be2ccd38.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716111136699"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>QPS为10.&lt;/p>
&lt;p>刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-a42bbb42e5af3c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716111303701"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>随着时间推移，成功比例越来越高：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-dded3eb999c69d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716111404717"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>到Sentinel控制台查看实时监控：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-a18cd2cce23a3a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716111526480"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>一段时间后：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-7eec5293ca1c4e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716111658541"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="232排队等待">
&lt;a href="#232%e6%8e%92%e9%98%9f%e7%ad%89%e5%be%85" class="header-anchor">#&lt;/a>
2.3.2.排队等待
&lt;/h3>&lt;p>当请求超过QPS阈值时，快速失败和warm up 会拒绝新的请求并抛出异常。&lt;/p>
&lt;p>而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。&lt;/p>
&lt;p>工作原理&lt;/p>
&lt;p>例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着&lt;strong>预期等待时长&lt;/strong>超过2000ms的请求会被拒绝并抛出异常。&lt;/p>
&lt;p>那什么叫做预期等待时长呢？&lt;/p>
&lt;p>比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：&lt;/p>
&lt;ul>
&lt;li>第6个请求的&lt;strong>预期等待时长&lt;/strong> = 200 * （6 - 1） = 1000ms&lt;/li>
&lt;li>第12个请求的预期等待时长 = 200 * （12-1） = 2200ms&lt;/li>
&lt;/ul>
&lt;p>现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-6375bf51a646a3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716113147176"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-a1fa9793f206cd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716113426524"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>平滑的QPS曲线，对于服务器来说是更友好的。&lt;/p>
&lt;p>&lt;strong>案例&lt;/strong>&lt;/p>
&lt;p>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用排队的流控效果，超时时长设置为5s&lt;/p>
&lt;h4 id="1添加流控规则">
&lt;a href="#1%e6%b7%bb%e5%8a%a0%e6%b5%81%e6%8e%a7%e8%a7%84%e5%88%99" class="header-anchor">#&lt;/a>
1）添加流控规则
&lt;/h4>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-7c678fe2528b46.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716114048918"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h4 id="2jmeter测试-1">
&lt;a href="#2jmeter%e6%b5%8b%e8%af%95-1" class="header-anchor">#&lt;/a>
2）Jmeter测试
&lt;/h4>&lt;p>选择《流控效果，队列》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-2e20ee235380b8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716114243558"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>QPS为15，已经超过了我们设定的10。&lt;/p>
&lt;p>如果是之前的 快速失败、warmup模式，超出的请求应该会直接报错。&lt;/p>
&lt;p>但是我们看看队列模式的运行结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-0a70c90c40bb1c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716114429361"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>全部都通过了。&lt;/p>
&lt;p>再去sentinel查看实时监控的QPS曲线：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-cc5407c4c1e37d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716114522935"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>QPS非常平滑，一致保持在10，但是超出的请求没有被拒绝，而是放入队列。因此&lt;strong>响应时间&lt;/strong>（等待时间）会越来越长。&lt;/p>
&lt;p>当队列满了以后，才会有部分请求失败：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-dea57281a2eff4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716114651137"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="233总结">
&lt;a href="#233%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
2.3.3.总结
&lt;/h3>&lt;p>流控效果有哪些？&lt;/p>
&lt;ul>
&lt;li>
&lt;p>快速失败：QPS超过阈值时，拒绝新的请求&lt;/p>
&lt;/li>
&lt;li>
&lt;p>warm up： QPS超过阈值时，拒绝新的请求；QPS阈值是逐渐提升的，可以避免冷启动时高并发导致服务宕机。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>排队等待：请求会进入队列，按照阈值允许的时间间隔依次执行请求；如果请求预期等待时长大于超时时间，直接拒绝&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="24热点参数限流">
&lt;a href="#24%e7%83%ad%e7%82%b9%e5%8f%82%e6%95%b0%e9%99%90%e6%b5%81" class="header-anchor">#&lt;/a>
2.4.热点参数限流
&lt;/h2>&lt;p>之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是&lt;strong>分别统计参数值相同的请求&lt;/strong>，判断是否超过QPS阈值。&lt;/p>
&lt;h3 id="241全局参数限流">
&lt;a href="#241%e5%85%a8%e5%b1%80%e5%8f%82%e6%95%b0%e9%99%90%e6%b5%81" class="header-anchor">#&lt;/a>
2.4.1.全局参数限流
&lt;/h3>&lt;p>例如，一个根据id查询商品的接口：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-bce31d262c7029.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716115014663"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-a7cd99f78a2fb8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716115131463"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。&lt;/p>
&lt;p>配置示例：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-2159c021f951e7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716115232426"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒&lt;strong>相同参数值&lt;/strong>的请求数不能超过5&lt;/p>
&lt;h3 id="242热点参数限流">
&lt;a href="#242%e7%83%ad%e7%82%b9%e5%8f%82%e6%95%b0%e9%99%90%e6%b5%81" class="header-anchor">#&lt;/a>
2.4.2.热点参数限流
&lt;/h3>&lt;p>刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.&lt;/p>
&lt;p>而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-afbcc2be3c2fd8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716115717523"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：&lt;/p>
&lt;p>•如果参数值是100，则每1秒允许的QPS为10&lt;/p>
&lt;p>•如果参数值是101，则每1秒允许的QPS为15&lt;/p>
&lt;h3 id="244案例">
&lt;a href="#244%e6%a1%88%e4%be%8b" class="header-anchor">#&lt;/a>
2.4.4.案例
&lt;/h3>&lt;p>&lt;strong>案例需求&lt;/strong>：给/order/{orderId}这个资源添加热点参数限流，规则如下：&lt;/p>
&lt;p>•默认的热点参数规则是每1秒请求量不超过2&lt;/p>
&lt;p>•给102这个参数设置例外：每1秒请求量不超过4&lt;/p>
&lt;p>•给103这个参数设置例外：每1秒请求量不超过10&lt;/p>
&lt;p>&lt;strong>注意事项&lt;/strong>：热点参数限流对默认的SpringMVC资源无效，需要利用@SentinelResource注解标记资源&lt;/p>
&lt;h4 id="1标记资源">
&lt;a href="#1%e6%a0%87%e8%ae%b0%e8%b5%84%e6%ba%90" class="header-anchor">#&lt;/a>
1）标记资源
&lt;/h4>&lt;p>给order-service中的OrderController中的/order/{orderId}资源添加注解：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-66f6a32ef34536.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716120033572"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h4 id="2热点参数限流规则">
&lt;a href="#2%e7%83%ad%e7%82%b9%e5%8f%82%e6%95%b0%e9%99%90%e6%b5%81%e8%a7%84%e5%88%99" class="header-anchor">#&lt;/a>
2）热点参数限流规则
&lt;/h4>&lt;p>访问该接口，可以看到我们标记的hot资源出现了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-e3a1dd0eed1d42.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716120208509"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这里不要点击hot后面的按钮，页面有BUG&lt;/p>
&lt;p>点击左侧菜单中&lt;strong>热点规则&lt;/strong>菜单：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-f61eb0f818ed26.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716120319009"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>点击新增，填写表单：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-df9b1b032c5d96.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716120536714"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h4 id="3jmeter测试">
&lt;a href="#3jmeter%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
3）Jmeter测试
&lt;/h4>&lt;p>选择《热点参数限流 QPS1》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-221b20734989a5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716120754527"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这里发起请求的QPS为5.&lt;/p>
&lt;p>包含3个http请求：&lt;/p>
&lt;p>普通参数，QPS阈值为2&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-f02b0cd2bced23.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716120840501"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>运行结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-1ceeccce8eb8fb.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716121105567"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>例外项，QPS阈值为4&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-686f9e2beb61c4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716120900365"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>运行结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-bdc779ea1b6bc4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716121201630"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>例外项，QPS阈值为10&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-30d5443f896164.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716120919131"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>运行结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-527fe28c1a1d3f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716121220305"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="3隔离和降级">
&lt;a href="#3%e9%9a%94%e7%a6%bb%e5%92%8c%e9%99%8d%e7%ba%a7" class="header-anchor">#&lt;/a>
3.隔离和降级
&lt;/h1>&lt;p>限流是一种预防措施，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。&lt;/p>
&lt;p>而要将这些故障控制在一定范围，避免雪崩，就要靠&lt;strong>线程隔离&lt;/strong>（舱壁模式）和&lt;strong>熔断降级&lt;/strong>手段了。&lt;/p>
&lt;p>&lt;strong>线程隔离&lt;/strong>之前讲到过：调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-8f1f5df7487629.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715173215243"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>&lt;strong>熔断降级&lt;/strong>：是在调用方这边加入断路器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-0514466b9f9995.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715173428073"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，不管是线程隔离还是熔断降级，都是对&lt;strong>客户端&lt;/strong>（调用方）的保护。需要在&lt;strong>调用方&lt;/strong> 发起远程调用时做线程隔离、或者服务熔断。&lt;/p>
&lt;p>而我们的微服务远程调用都是基于Feign来完成的，因此我们需要将Feign与Sentinel整合，在Feign里面实现线程隔离和服务熔断。&lt;/p>
&lt;h2 id="31feignclient整合sentinel">
&lt;a href="#31feignclient%e6%95%b4%e5%90%88sentinel" class="header-anchor">#&lt;/a>
3.1.FeignClient整合Sentinel
&lt;/h2>&lt;p>SpringCloud中，微服务调用都是通过Feign来实现的，因此做客户端保护必须整合Feign和Sentinel。&lt;/p>
&lt;h3 id="311修改配置开启sentinel功能">
&lt;a href="#311%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae%e5%bc%80%e5%90%afsentinel%e5%8a%9f%e8%83%bd" class="header-anchor">#&lt;/a>
3.1.1.修改配置，开启sentinel功能
&lt;/h3>&lt;p>修改OrderService的application.yml文件，开启Feign的Sentinel功能：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">feign&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">sentinel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">enabled&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 开启feign对sentinel的支持&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="312编写失败降级逻辑">
&lt;a href="#312%e7%bc%96%e5%86%99%e5%a4%b1%e8%b4%a5%e9%99%8d%e7%ba%a7%e9%80%bb%e8%be%91" class="header-anchor">#&lt;/a>
3.1.2.编写失败降级逻辑
&lt;/h3>&lt;p>业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。&lt;/p>
&lt;p>给FeignClient编写失败后的降级逻辑&lt;/p>
&lt;p>①方式一：FallbackClass，无法对远程调用的异常做处理&lt;/p>
&lt;p>②方式二：FallbackFactory，可以对远程调用的异常做处理，我们选择这种&lt;/p>
&lt;p>这里我们演示方式二的失败降级处理。&lt;/p>
&lt;p>&lt;strong>步骤一&lt;/strong>：在feing-api项目中定义类，实现FallbackFactory：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-a6a69843a3bfb0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716122403502"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-6">&lt;a class="lnlinks" href="#hl-12-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-7">&lt;a class="lnlinks" href="#hl-12-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-8">&lt;a class="lnlinks" href="#hl-12-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-9">&lt;a class="lnlinks" href="#hl-12-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-10">&lt;a class="lnlinks" href="#hl-12-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-11">&lt;a class="lnlinks" href="#hl-12-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-12">&lt;a class="lnlinks" href="#hl-12-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-13">&lt;a class="lnlinks" href="#hl-12-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-14">&lt;a class="lnlinks" href="#hl-12-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-15">&lt;a class="lnlinks" href="#hl-12-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-16">&lt;a class="lnlinks" href="#hl-12-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-17">&lt;a class="lnlinks" href="#hl-12-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-18">&lt;a class="lnlinks" href="#hl-12-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-19">&lt;a class="lnlinks" href="#hl-12-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-20">&lt;a class="lnlinks" href="#hl-12-20">20&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.feign.clients.fallback&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.feign.clients.UserClient&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.feign.pojo.User&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">feign.hystrix.FallbackFactory&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.extern.slf4j.Slf4j&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Slf4j&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">UserClientFallbackFactory&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">implements&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FallbackFactory&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">UserClient&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UserClient&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Throwable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">throwable&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UserClient&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">User&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">findById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;查询用户异常&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">throwable&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">User&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">};&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>步骤二&lt;/strong>：在feing-api项目中的DefaultFeignConfiguration类中将UserClientFallbackFactory注册为一个Bean：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@Bean&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UserClientFallbackFactory&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">userClientFallbackFactory&lt;/span>&lt;span class="p">(){&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UserClientFallbackFactory&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>步骤三&lt;/strong>：在feing-api项目中的UserClient接口中使用UserClientFallbackFactory：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-5">&lt;a class="lnlinks" href="#hl-14-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-6">&lt;a class="lnlinks" href="#hl-14-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-7">&lt;a class="lnlinks" href="#hl-14-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-8">&lt;a class="lnlinks" href="#hl-14-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-9">&lt;a class="lnlinks" href="#hl-14-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-10">&lt;a class="lnlinks" href="#hl-14-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-11">&lt;a class="lnlinks" href="#hl-14-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-12">&lt;a class="lnlinks" href="#hl-14-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.feign.clients.fallback.UserClientFallbackFactory&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.feign.pojo.User&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.cloud.openfeign.FeignClient&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.web.bind.annotation.GetMapping&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.web.bind.annotation.PathVariable&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@FeignClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;userservice&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">fallbackFactory&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UserClientFallbackFactory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">interface&lt;/span> &lt;span class="nc">UserClient&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@GetMapping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/user/{id}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">User&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">findById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nd">@PathVariable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Long&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启后，访问一次订单查询业务，然后查看sentinel控制台，可以看到新的簇点链路：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-2ce498e3c41c10.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716123705780"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="313总结">
&lt;a href="#313%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
3.1.3.总结
&lt;/h3>&lt;p>Sentinel支持的雪崩解决方案：&lt;/p>
&lt;ul>
&lt;li>线程隔离（仓壁模式）&lt;/li>
&lt;li>降级熔断&lt;/li>
&lt;/ul>
&lt;p>Feign整合Sentinel的步骤：&lt;/p>
&lt;ul>
&lt;li>在application.yml中配置：feign.sentienl.enable=true&lt;/li>
&lt;li>给FeignClient编写FallbackFactory并注册为Bean&lt;/li>
&lt;li>将FallbackFactory配置到FeignClient&lt;/li>
&lt;/ul>
&lt;h2 id="32线程隔离舱壁模式">
&lt;a href="#32%e7%ba%bf%e7%a8%8b%e9%9a%94%e7%a6%bb%e8%88%b1%e5%a3%81%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
3.2.线程隔离（舱壁模式）
&lt;/h2>&lt;h3 id="321线程隔离的实现方式">
&lt;a href="#321%e7%ba%bf%e7%a8%8b%e9%9a%94%e7%a6%bb%e7%9a%84%e5%ae%9e%e7%8e%b0%e6%96%b9%e5%bc%8f" class="header-anchor">#&lt;/a>
3.2.1.线程隔离的实现方式
&lt;/h3>&lt;p>线程隔离有两种方式实现：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>线程池隔离&lt;/p>
&lt;/li>
&lt;li>
&lt;p>信号量隔离（Sentinel默认采用）&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-601bd38277006d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716123036937"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>&lt;strong>线程池隔离&lt;/strong>：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果&lt;/p>
&lt;p>&lt;strong>信号量隔离&lt;/strong>：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。&lt;/p>
&lt;p>两者的优缺点：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-f11c4870e7d99f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716123240518"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="322sentinel的线程隔离">
&lt;a href="#322sentinel%e7%9a%84%e7%ba%bf%e7%a8%8b%e9%9a%94%e7%a6%bb" class="header-anchor">#&lt;/a>
3.2.2.sentinel的线程隔离
&lt;/h3>&lt;p>&lt;strong>用法说明&lt;/strong>：&lt;/p>
&lt;p>在添加限流规则时，可以选择两种阈值类型：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-5cd72b1aedbdb8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716123411217"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;ul>
&lt;li>
&lt;p>QPS：就是每秒的请求数，在快速入门中已经演示过&lt;/p>
&lt;/li>
&lt;li>
&lt;p>线程数：是该资源能使用用的tomcat线程数的最大值。也就是通过限制线程数量，实现&lt;strong>线程隔离&lt;/strong>（舱壁模式）。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>案例需求&lt;/strong>：给 order-service服务中的UserClient的查询用户接口设置流控规则，线程数不能超过 2。然后利用jemeter测试。&lt;/p>
&lt;h4 id="1配置隔离规则">
&lt;a href="#1%e9%85%8d%e7%bd%ae%e9%9a%94%e7%a6%bb%e8%a7%84%e5%88%99" class="header-anchor">#&lt;/a>
1）配置隔离规则
&lt;/h4>&lt;p>选择feign接口后面的流控按钮：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-57679f3c1e3095.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716123831992"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>填写表单：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-02e9480d192b3c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716123936844"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h4 id="2jmeter测试-2">
&lt;a href="#2jmeter%e6%b5%8b%e8%af%95-2" class="header-anchor">#&lt;/a>
2）Jmeter测试
&lt;/h4>&lt;p>选择《阈值类型-线程数&amp;lt;2》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-ba3cfaa87b70e0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716124229894"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>一次发生10个请求，有较大概率并发线程数超过2，而超出的请求会走之前定义的失败降级逻辑。&lt;/p>
&lt;p>查看运行结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-26d3ca8dbc6370.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716124147820"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>发现虽然结果都是通过了，不过部分请求得到的响应是降级返回的null信息。&lt;/p>
&lt;h3 id="323总结">
&lt;a href="#323%e6%80%bb%e7%bb%93" class="header-anchor">#&lt;/a>
3.2.3.总结
&lt;/h3>&lt;p>线程隔离的两种手段是？&lt;/p>
&lt;ul>
&lt;li>
&lt;p>信号量隔离&lt;/p>
&lt;/li>
&lt;li>
&lt;p>线程池隔离&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>信号量隔离的特点是？&lt;/p>
&lt;ul>
&lt;li>基于计数器模式，简单，开销小&lt;/li>
&lt;/ul>
&lt;p>线程池隔离的特点是？&lt;/p>
&lt;ul>
&lt;li>基于线程池模式，有额外开销，但隔离控制更强&lt;/li>
&lt;/ul>
&lt;h2 id="33熔断降级">
&lt;a href="#33%e7%86%94%e6%96%ad%e9%99%8d%e7%ba%a7" class="header-anchor">#&lt;/a>
3.3.熔断降级
&lt;/h2>&lt;p>熔断降级是解决雪崩问题的重要手段。其思路是由&lt;strong>断路器&lt;/strong>统计服务调用的异常比例、慢请求比例，如果超出阈值则会&lt;strong>熔断&lt;/strong>该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。&lt;/p>
&lt;p>断路器控制熔断和放行是通过状态机来完成的：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-5b048d356fb5f2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716130958518"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>状态机包括三个状态：&lt;/p>
&lt;ul>
&lt;li>closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态&lt;/li>
&lt;li>open：打开状态，服务调用被&lt;strong>熔断&lt;/strong>，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态5秒后会进入half-open状态&lt;/li>
&lt;li>half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。
&lt;ul>
&lt;li>请求成功：则切换到closed状态&lt;/li>
&lt;li>请求失败：则切换到open状态&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>断路器熔断策略有三种：慢调用、异常比例、异常数&lt;/p>
&lt;h3 id="331慢调用">
&lt;a href="#331%e6%85%a2%e8%b0%83%e7%94%a8" class="header-anchor">#&lt;/a>
3.3.1.慢调用
&lt;/h3>&lt;p>&lt;strong>慢调用&lt;/strong>：业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。&lt;/p>
&lt;p>例如：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-2641ab8319970a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716145934347"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解读：RT超过500ms的调用是慢调用，统计最近10000ms内的请求，如果请求量超过10次，并且慢调用比例不低于0.5，则触发熔断，熔断时长为5秒。然后进入half-open状态，放行一次请求做测试。&lt;/p>
&lt;p>&lt;strong>案例&lt;/strong>&lt;/p>
&lt;p>需求：给 UserClient的查询用户接口设置降级规则，慢调用的RT阈值为50ms，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5&lt;/p>
&lt;h4 id="1设置慢调用">
&lt;a href="#1%e8%ae%be%e7%bd%ae%e6%85%a2%e8%b0%83%e7%94%a8" class="header-anchor">#&lt;/a>
1）设置慢调用
&lt;/h4>&lt;p>修改user-service中的/user/{id}这个接口的业务。通过休眠模拟一个延迟时间：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-b60867f6170a1e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716150234787"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>此时，orderId=101的订单，关联的是id为1的用户，调用时长为60ms：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-1be1a6be7beca2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716150510956"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>orderId=102的订单，关联的是id为2的用户，调用时长为非常短；&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-3c209fd2485b04.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716150605208"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h4 id="2设置熔断规则">
&lt;a href="#2%e8%ae%be%e7%bd%ae%e7%86%94%e6%96%ad%e8%a7%84%e5%88%99" class="header-anchor">#&lt;/a>
2）设置熔断规则
&lt;/h4>&lt;p>下面，给feign接口设置降级规则：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-62e07f268ba470.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716150654094"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>规则：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-ee73590bc3b0ff.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716150740434"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>超过50ms的请求都会被认为是慢请求&lt;/p>
&lt;h4 id="3测试">
&lt;a href="#3%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
3）测试
&lt;/h4>&lt;p>在浏览器访问：http://localhost:8088/order/101，快速刷新5次，可以发现：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-3bf51f89647d9f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716150911004"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>触发了熔断，请求时长缩短至5ms，快速失败了，并且走降级逻辑，返回的null&lt;/p>
&lt;p>在浏览器访问：http://localhost:8088/order/102，竟然也被熔断了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-8da46a9c90a097.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716151107785"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="332异常比例异常数">
&lt;a href="#332%e5%bc%82%e5%b8%b8%e6%af%94%e4%be%8b%e5%bc%82%e5%b8%b8%e6%95%b0" class="header-anchor">#&lt;/a>
3.3.2.异常比例、异常数
&lt;/h3>&lt;p>&lt;strong>异常比例或异常数&lt;/strong>：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。&lt;/p>
&lt;p>例如，一个异常比例设置：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-08b0fdd6417954.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716131430682"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于0.4，则触发熔断。&lt;/p>
&lt;p>一个异常数设置：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-e99dd00e63aa98.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716131522912"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于2次，则触发熔断。&lt;/p>
&lt;p>&lt;strong>案例&lt;/strong>&lt;/p>
&lt;p>需求：给 UserClient的查询用户接口设置降级规则，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5s&lt;/p>
&lt;h4 id="1设置异常请求">
&lt;a href="#1%e8%ae%be%e7%bd%ae%e5%bc%82%e5%b8%b8%e8%af%b7%e6%b1%82" class="header-anchor">#&lt;/a>
1）设置异常请求
&lt;/h4>&lt;p>首先，修改user-service中的/user/{id}这个接口的业务。手动抛出异常，以触发异常比例的熔断：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-8f8a86d6c56a3c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716151348183"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>也就是说，id 为 2时，就会触发异常&lt;/p>
&lt;h4 id="2设置熔断规则-1">
&lt;a href="#2%e8%ae%be%e7%bd%ae%e7%86%94%e6%96%ad%e8%a7%84%e5%88%99-1" class="header-anchor">#&lt;/a>
2）设置熔断规则
&lt;/h4>&lt;p>下面，给feign接口设置降级规则：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-62e07f268ba470.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716150654094"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>规则：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-bf9b8b71914f3a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716151538785"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在5次请求中，只要异常比例超过0.4，也就是有2次以上的异常，就会触发熔断。&lt;/p>
&lt;h4 id="3测试-1">
&lt;a href="#3%e6%b5%8b%e8%af%95-1" class="header-anchor">#&lt;/a>
3）测试
&lt;/h4>&lt;p>在浏览器快速访问：http://localhost:8088/order/102，快速刷新5次，触发熔断：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-02282515fcd7a6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716151722916"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>此时，我们去访问本来应该正常的103：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-7fbb6a120c18b6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716151844817"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="4授权规则">
&lt;a href="#4%e6%8e%88%e6%9d%83%e8%a7%84%e5%88%99" class="header-anchor">#&lt;/a>
4.授权规则
&lt;/h1>&lt;p>授权规则可以对请求方来源做判断和控制。&lt;/p>
&lt;h2 id="41授权规则">
&lt;a href="#41%e6%8e%88%e6%9d%83%e8%a7%84%e5%88%99" class="header-anchor">#&lt;/a>
4.1.授权规则
&lt;/h2>&lt;h3 id="411基本规则">
&lt;a href="#411%e5%9f%ba%e6%9c%ac%e8%a7%84%e5%88%99" class="header-anchor">#&lt;/a>
4.1.1.基本规则
&lt;/h3>&lt;p>授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>白名单：来源（origin）在白名单内的调用者允许访问&lt;/p>
&lt;/li>
&lt;li>
&lt;p>黑名单：来源（origin）在黑名单内的调用者不允许访问&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>点击左侧菜单的授权，可以看到授权规则：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-942e840f8668e6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716152010750"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;ul>
&lt;li>
&lt;p>资源名：就是受保护的资源，例如/order/{orderId}&lt;/p>
&lt;/li>
&lt;li>
&lt;p>流控应用：是来源者的名单，&lt;/p>
&lt;ul>
&lt;li>如果是勾选白名单，则名单中的来源被许可访问。&lt;/li>
&lt;li>如果是勾选黑名单，则名单中的来源被禁止访问。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>比如：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-78e7b7a7d4634a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716152349191"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>我们允许请求从gateway到order-service，不允许浏览器访问order-service，那么白名单中就要填写&lt;strong>网关的来源名称（origin）&lt;/strong>。&lt;/p>
&lt;h3 id="412如何获取origin">
&lt;a href="#412%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96origin" class="header-anchor">#&lt;/a>
4.1.2.如何获取origin
&lt;/h3>&lt;p>Sentinel是通过RequestOriginParser这个接口的parseOrigin来获取请求的来源的。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-6">&lt;a class="lnlinks" href="#hl-15-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">interface&lt;/span> &lt;span class="nc">RequestOriginParser&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 从请求request对象中获取origin，获取方式自定义
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">parseOrigin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个方法的作用就是从request对象中，获取请求者的origin值并返回。&lt;/p>
&lt;p>默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。&lt;/p>
&lt;p>因此，我们需要自定义这个接口的实现，让&lt;strong>不同的请求，返回不同的origin&lt;/strong>。&lt;/p>
&lt;p>例如order-service服务中，我们定义一个RequestOriginParser的实现类：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-7">&lt;a class="lnlinks" href="#hl-16-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-8">&lt;a class="lnlinks" href="#hl-16-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-9">&lt;a class="lnlinks" href="#hl-16-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-10">&lt;a class="lnlinks" href="#hl-16-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-11">&lt;a class="lnlinks" href="#hl-16-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-12">&lt;a class="lnlinks" href="#hl-16-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-13">&lt;a class="lnlinks" href="#hl-16-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-14">&lt;a class="lnlinks" href="#hl-16-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-15">&lt;a class="lnlinks" href="#hl-16-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-16">&lt;a class="lnlinks" href="#hl-16-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-17">&lt;a class="lnlinks" href="#hl-16-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-18">&lt;a class="lnlinks" href="#hl-16-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-19">&lt;a class="lnlinks" href="#hl-16-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-20">&lt;a class="lnlinks" href="#hl-16-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-21">&lt;a class="lnlinks" href="#hl-16-21">21&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.order.sentinel&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.RequestOriginParser&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.stereotype.Component&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.util.StringUtils&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">javax.servlet.http.HttpServletRequest&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Component&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">HeaderOriginParser&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">implements&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RequestOriginParser&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">parseOrigin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.获取请求头&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">origin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getHeader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;origin&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.非空判断&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">StringUtils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">isEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">origin&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">origin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;blank&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">origin&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我们会尝试从request-header中获取origin值。&lt;/p>
&lt;h3 id="413给网关添加请求头">
&lt;a href="#413%e7%bb%99%e7%bd%91%e5%85%b3%e6%b7%bb%e5%8a%a0%e8%af%b7%e6%b1%82%e5%a4%b4" class="header-anchor">#&lt;/a>
4.1.3.给网关添加请求头
&lt;/h3>&lt;p>既然获取请求origin的方式是从reques-header中获取origin值，我们必须让&lt;strong>所有从gateway路由到微服务的请求都带上origin头&lt;/strong>。&lt;/p>
&lt;p>这个需要利用之前学习的一个GatewayFilter来实现，AddRequestHeaderGatewayFilter。&lt;/p>
&lt;p>修改gateway服务中的application.yml，添加一个defaultFilter：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-4">&lt;a class="lnlinks" href="#hl-17-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-5">&lt;a class="lnlinks" href="#hl-17-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-6">&lt;a class="lnlinks" href="#hl-17-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-7">&lt;a class="lnlinks" href="#hl-17-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gateway&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">default-filters&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">AddRequestHeader=origin,gateway&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">routes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># ...略&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这样，从gateway路由的所有请求都会带上origin头，值为gateway。而从其它地方到达微服务的请求则没有这个头。&lt;/p>
&lt;h3 id="414配置授权规则">
&lt;a href="#414%e9%85%8d%e7%bd%ae%e6%8e%88%e6%9d%83%e8%a7%84%e5%88%99" class="header-anchor">#&lt;/a>
4.1.4.配置授权规则
&lt;/h3>&lt;p>接下来，我们添加一个授权规则，放行origin值为gateway的请求。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-de68bfa85f86d9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716153250134"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>配置如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-18d250a37c89dc.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716153301069"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>现在，我们直接跳过网关，访问order-service服务：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-49ddb8e42697e5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716153348396"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>通过网关访问：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-8b551b852b30aa.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716153434095"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="42自定义异常结果">
&lt;a href="#42%e8%87%aa%e5%ae%9a%e4%b9%89%e5%bc%82%e5%b8%b8%e7%bb%93%e6%9e%9c" class="header-anchor">#&lt;/a>
4.2.自定义异常结果
&lt;/h2>&lt;p>默认情况下，发生限流、降级、授权拦截时，都会抛出异常到调用方。异常结果都是flow limmiting（限流）。这样不够友好，无法得知是限流还是降级还是授权拦截。&lt;/p>
&lt;h3 id="421异常类型">
&lt;a href="#421%e5%bc%82%e5%b8%b8%e7%b1%bb%e5%9e%8b" class="header-anchor">#&lt;/a>
4.2.1.异常类型
&lt;/h3>&lt;p>而如果要自定义异常时的返回结果，需要实现BlockExceptionHandler接口：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-5">&lt;a class="lnlinks" href="#hl-18-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-6">&lt;a class="lnlinks" href="#hl-18-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">interface&lt;/span> &lt;span class="nc">BlockExceptionHandler&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 处理请求被限流、降级、授权拦截时抛出的异常：BlockException
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HttpServletResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个方法有三个参数：&lt;/p>
&lt;ul>
&lt;li>HttpServletRequest request：request对象&lt;/li>
&lt;li>HttpServletResponse response：response对象&lt;/li>
&lt;li>BlockException e：被sentinel拦截时抛出的异常&lt;/li>
&lt;/ul>
&lt;p>这里的BlockException包含多个不同的子类：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>异常&lt;/strong>&lt;/th>
&lt;th>&lt;strong>说明&lt;/strong>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>FlowException&lt;/td>
&lt;td>限流异常&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ParamFlowException&lt;/td>
&lt;td>热点参数限流的异常&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DegradeException&lt;/td>
&lt;td>降级异常&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>AuthorityException&lt;/td>
&lt;td>授权规则异常&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SystemBlockException&lt;/td>
&lt;td>系统规则异常&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="422自定义异常处理">
&lt;a href="#422%e8%87%aa%e5%ae%9a%e4%b9%89%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86" class="header-anchor">#&lt;/a>
4.2.2.自定义异常处理
&lt;/h3>&lt;p>下面，我们就在order-service定义一个自定义异常处理类：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-5">&lt;a class="lnlinks" href="#hl-19-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-6">&lt;a class="lnlinks" href="#hl-19-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-7">&lt;a class="lnlinks" href="#hl-19-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-8">&lt;a class="lnlinks" href="#hl-19-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-9">&lt;a class="lnlinks" href="#hl-19-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-10">&lt;a class="lnlinks" href="#hl-19-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-11">&lt;a class="lnlinks" href="#hl-19-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-12">&lt;a class="lnlinks" href="#hl-19-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-13">&lt;a class="lnlinks" href="#hl-19-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-14">&lt;a class="lnlinks" href="#hl-19-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-15">&lt;a class="lnlinks" href="#hl-19-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-16">&lt;a class="lnlinks" href="#hl-19-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-17">&lt;a class="lnlinks" href="#hl-19-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-18">&lt;a class="lnlinks" href="#hl-19-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-19">&lt;a class="lnlinks" href="#hl-19-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-20">&lt;a class="lnlinks" href="#hl-19-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-21">&lt;a class="lnlinks" href="#hl-19-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-22">&lt;a class="lnlinks" href="#hl-19-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-23">&lt;a class="lnlinks" href="#hl-19-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-24">&lt;a class="lnlinks" href="#hl-19-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-25">&lt;a class="lnlinks" href="#hl-19-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-26">&lt;a class="lnlinks" href="#hl-19-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-27">&lt;a class="lnlinks" href="#hl-19-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-28">&lt;a class="lnlinks" href="#hl-19-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-29">&lt;a class="lnlinks" href="#hl-19-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-30">&lt;a class="lnlinks" href="#hl-19-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-31">&lt;a class="lnlinks" href="#hl-19-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-32">&lt;a class="lnlinks" href="#hl-19-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-33">&lt;a class="lnlinks" href="#hl-19-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-34">&lt;a class="lnlinks" href="#hl-19-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-35">&lt;a class="lnlinks" href="#hl-19-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-36">&lt;a class="lnlinks" href="#hl-19-36">36&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.order.sentinel&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.alibaba.csp.sentinel.slots.block.BlockException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.alibaba.csp.sentinel.slots.block.authority.AuthorityException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.alibaba.csp.sentinel.slots.block.degrade.DegradeException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.alibaba.csp.sentinel.slots.block.flow.FlowException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.stereotype.Component&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">javax.servlet.http.HttpServletRequest&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">javax.servlet.http.HttpServletResponse&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Component&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">SentinelExceptionHandler&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">implements&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BlockExceptionHandler&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HttpServletResponse&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BlockException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Exception&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;未知异常&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">429&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">instanceof&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FlowException&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;请求被限流了&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">instanceof&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ParamFlowException&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;请求被热点参数限流&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">instanceof&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DegradeException&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;请求被降级了&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">instanceof&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AuthorityException&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;没有权限访问&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">401&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setContentType&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;application/json;charset=utf-8&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setStatus&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getWriter&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="na">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;{\&amp;#34;msg\&amp;#34;: &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;, \&amp;#34;status\&amp;#34;: &amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;}&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启测试，在不同场景下，会返回不同的异常消息.&lt;/p>
&lt;p>限流：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-d91bd0f7f78eb9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716153938887"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>授权拦截时：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-cb761757654527.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716154012736"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="5规则持久化">
&lt;a href="#5%e8%a7%84%e5%88%99%e6%8c%81%e4%b9%85%e5%8c%96" class="header-anchor">#&lt;/a>
5.规则持久化
&lt;/h1>&lt;p>现在，sentinel的所有规则都是内存存储，重启后所有规则都会丢失。在生产环境下，我们必须确保这些规则的持久化，避免丢失。&lt;/p>
&lt;h2 id="51规则管理模式">
&lt;a href="#51%e8%a7%84%e5%88%99%e7%ae%a1%e7%90%86%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
5.1.规则管理模式
&lt;/h2>&lt;p>规则是否能持久化，取决于规则管理模式，sentinel支持三种规则管理模式：&lt;/p>
&lt;ul>
&lt;li>原始模式：Sentinel的默认模式，将规则保存在内存，重启服务会丢失。&lt;/li>
&lt;li>pull模式&lt;/li>
&lt;li>push模式&lt;/li>
&lt;/ul>
&lt;h3 id="511pull模式">
&lt;a href="#511pull%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
5.1.1.pull模式
&lt;/h3>&lt;p>pull模式：控制台将配置的规则推送到Sentinel客户端，而客户端会将配置规则保存在本地文件或数据库中。以后会定时去本地文件或数据库中查询，更新本地规则。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-8bc2dcc4de5eb4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716154155238"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="512push模式">
&lt;a href="#512push%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
5.1.2.push模式
&lt;/h3>&lt;p>push模式：控制台将配置规则推送到远程配置中心，例如Nacos。Sentinel客户端监听Nacos，获取配置变更的推送消息，完成本地配置更新。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-d534212ad469bd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716154215456"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="52实现push模式">
&lt;a href="#52%e5%ae%9e%e7%8e%b0push%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
5.2.实现push模式
&lt;/h2>&lt;p>详细步骤可以参考课前资料的《sentinel规则持久化》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738471-f673659dd4bc85.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210716154255466"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p></description></item><item><title>9.seata的部署和集成</title><link>https://logan.wssw.fun/p/2023/01/57149157/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/57149157/</guid><description>&lt;h1 id="seata的部署和集成">
&lt;a href="#seata%e7%9a%84%e9%83%a8%e7%bd%b2%e5%92%8c%e9%9b%86%e6%88%90" class="header-anchor">#&lt;/a>
seata的部署和集成
&lt;/h1>&lt;h1 id="一部署seata的tc-server">
&lt;a href="#%e4%b8%80%e9%83%a8%e7%bd%b2seata%e7%9a%84tc-server" class="header-anchor">#&lt;/a>
一、部署Seata的tc-server
&lt;/h1>&lt;h2 id="1下载">
&lt;a href="#1%e4%b8%8b%e8%bd%bd" class="header-anchor">#&lt;/a>
1.下载
&lt;/h2>&lt;p>首先我们要下载seata-server包，地址在&lt;a class="link" href="http://seata.io/zh-cn/blog/download.html" target="_blank" rel="noopener"
>http
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;a class="link" href="http://seata.io/zh-cn/blog/download.html" target="_blank" rel="noopener"
>://seata.io/zh-cn/blog/download
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;a class="link" href="http://seata.io/zh-cn/blog/download.html" target="_blank" rel="noopener"
>.
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;a class="link" href="http://seata.io/zh-cn/blog/download.html" target="_blank" rel="noopener"
>html
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/p>
&lt;p>当然，课前资料也准备好了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740004-80cf4532278731.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210622202357640"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="2解压">
&lt;a href="#2%e8%a7%a3%e5%8e%8b" class="header-anchor">#&lt;/a>
2.解压
&lt;/h2>&lt;p>在非中文目录解压缩这个zip包，其目录结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740004-d10ca5024a9ee5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210622202515014"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="3修改配置">
&lt;a href="#3%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
3.修改配置
&lt;/h2>&lt;p>修改conf目录下的registry.conf文件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740004-1c0817989e1617.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210622202622874"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-6">&lt;a class="lnlinks" href="#hl-0-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-7">&lt;a class="lnlinks" href="#hl-0-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-8">&lt;a class="lnlinks" href="#hl-0-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-9">&lt;a class="lnlinks" href="#hl-0-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-10">&lt;a class="lnlinks" href="#hl-0-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-11">&lt;a class="lnlinks" href="#hl-0-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-12">&lt;a class="lnlinks" href="#hl-0-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-13">&lt;a class="lnlinks" href="#hl-0-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-14">&lt;a class="lnlinks" href="#hl-0-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-15">&lt;a class="lnlinks" href="#hl-0-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-16">&lt;a class="lnlinks" href="#hl-0-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-17">&lt;a class="lnlinks" href="#hl-0-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-18">&lt;a class="lnlinks" href="#hl-0-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-19">&lt;a class="lnlinks" href="#hl-0-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-20">&lt;a class="lnlinks" href="#hl-0-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-21">&lt;a class="lnlinks" href="#hl-0-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-22">&lt;a class="lnlinks" href="#hl-0-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-23">&lt;a class="lnlinks" href="#hl-0-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-24">&lt;a class="lnlinks" href="#hl-0-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-25">&lt;a class="lnlinks" href="#hl-0-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-26">&lt;a class="lnlinks" href="#hl-0-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-27">&lt;a class="lnlinks" href="#hl-0-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-28">&lt;a class="lnlinks" href="#hl-0-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-29">&lt;a class="lnlinks" href="#hl-0-29">29&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="na">registry&lt;/span> &lt;span class="s">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># tc服务的注册中心类，这里选择nacos，也可以是eureka、zookeeper等&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">nacos&lt;/span> &lt;span class="s">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># seata tc 服务注册到 nacos的服务名称，可以自定义&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">application&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;seata-tc-server&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">serverAddr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;127.0.0.1:8848&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">group&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;DEFAULT_GROUP&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">namespace&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">cluster&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;SH&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">username&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err"> }&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">config&lt;/span> &lt;span class="s">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 读取tc服务端的配置文件的方式，这里是从nacos配置中心读取，这样如果tc是集群，可以共享配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 配置nacos地址等信息&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">nacos&lt;/span> &lt;span class="s">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">serverAddr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;127.0.0.1:8848&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">namespace&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">group&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;SEATA_GROUP&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">username&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="na">dataId&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;seataServer.properties&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err"> }&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="4在nacos添加配置">
&lt;a href="#4%e5%9c%a8nacos%e6%b7%bb%e5%8a%a0%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
4.在nacos添加配置
&lt;/h2>&lt;p>特别注意，为了让tc服务的集群可以共享配置，我们选择了nacos作为统一配置中心。因此服务端配置文件seataServer.properties文件需要在nacos中配好。&lt;/p>
&lt;p>格式如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740004-6dadf314756fac.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210622203609227"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>配置内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-9">&lt;a class="lnlinks" href="#hl-1-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-10">&lt;a class="lnlinks" href="#hl-1-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-11">&lt;a class="lnlinks" href="#hl-1-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-12">&lt;a class="lnlinks" href="#hl-1-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-13">&lt;a class="lnlinks" href="#hl-1-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-14">&lt;a class="lnlinks" href="#hl-1-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-15">&lt;a class="lnlinks" href="#hl-1-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-16">&lt;a class="lnlinks" href="#hl-1-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-17">&lt;a class="lnlinks" href="#hl-1-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-18">&lt;a class="lnlinks" href="#hl-1-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-19">&lt;a class="lnlinks" href="#hl-1-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-20">&lt;a class="lnlinks" href="#hl-1-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-21">&lt;a class="lnlinks" href="#hl-1-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-22">&lt;a class="lnlinks" href="#hl-1-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-23">&lt;a class="lnlinks" href="#hl-1-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-24">&lt;a class="lnlinks" href="#hl-1-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-25">&lt;a class="lnlinks" href="#hl-1-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-26">&lt;a class="lnlinks" href="#hl-1-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-27">&lt;a class="lnlinks" href="#hl-1-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-28">&lt;a class="lnlinks" href="#hl-1-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-29">&lt;a class="lnlinks" href="#hl-1-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-30">&lt;a class="lnlinks" href="#hl-1-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-31">&lt;a class="lnlinks" href="#hl-1-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-32">&lt;a class="lnlinks" href="#hl-1-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-33">&lt;a class="lnlinks" href="#hl-1-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-34">&lt;a class="lnlinks" href="#hl-1-34">34&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 数据存储方式，db代表数据库&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.mode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">db&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.datasource&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">druid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.dbType&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">mysql&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.driverClassName&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">com.mysql.jdbc.Driver&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.url&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&amp;amp;rewriteBatchedStatements=true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.user&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">root&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.password&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">123&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.minConn&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.maxConn&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">30&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.globalTable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">global_table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.branchTable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">branch_table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.queryLimit&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.lockTable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">lock_table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">store.db.maxWait&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">5000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 事务、日志等配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server.recovery.committingRetryPeriod&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server.recovery.asynCommittingRetryPeriod&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server.recovery.rollbackingRetryPeriod&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server.recovery.timeoutRetryPeriod&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server.maxCommitRetryTimeout&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">-1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server.maxRollbackRetryTimeout&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">-1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server.rollbackRetryTimeoutUnlockEnable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server.undo.logSaveDays&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">7&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">server.undo.logDeletePeriod&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">86400000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 客户端与服务端传输方式&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.serialization&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">seata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.compressor&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">none&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 关闭metrics功能，提高性能&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">metrics.enabled&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">metrics.registryType&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">compact&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">metrics.exporterList&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">prometheus&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">metrics.exporterPrometheusPort&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">9898&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>==其中的数据库地址、用户名、密码都需要修改成你自己的数据库信息。==&lt;/p>
&lt;h2 id="5创建数据库表">
&lt;a href="#5%e5%88%9b%e5%bb%ba%e6%95%b0%e6%8d%ae%e5%ba%93%e8%a1%a8" class="header-anchor">#&lt;/a>
5.创建数据库表
&lt;/h2>&lt;p>特别注意：tc服务在管理分布式事务时，需要记录事务相关数据到数据库中，你需要提前创建好这些表。&lt;/p>
&lt;p>新建一个名为seata的数据库，运行课前资料提供的sql文件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740004-9b2ea1a983e2d1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210622204145159"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这些表主要记录全局事务、分支事务、全局锁信息：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-9">&lt;a class="lnlinks" href="#hl-2-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-10">&lt;a class="lnlinks" href="#hl-2-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-11">&lt;a class="lnlinks" href="#hl-2-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-12">&lt;a class="lnlinks" href="#hl-2-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-13">&lt;a class="lnlinks" href="#hl-2-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-14">&lt;a class="lnlinks" href="#hl-2-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-15">&lt;a class="lnlinks" href="#hl-2-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-16">&lt;a class="lnlinks" href="#hl-2-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-17">&lt;a class="lnlinks" href="#hl-2-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-18">&lt;a class="lnlinks" href="#hl-2-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-19">&lt;a class="lnlinks" href="#hl-2-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-20">&lt;a class="lnlinks" href="#hl-2-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-21">&lt;a class="lnlinks" href="#hl-2-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-22">&lt;a class="lnlinks" href="#hl-2-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-23">&lt;a class="lnlinks" href="#hl-2-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-24">&lt;a class="lnlinks" href="#hl-2-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-25">&lt;a class="lnlinks" href="#hl-2-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-26">&lt;a class="lnlinks" href="#hl-2-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-27">&lt;a class="lnlinks" href="#hl-2-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-28">&lt;a class="lnlinks" href="#hl-2-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-29">&lt;a class="lnlinks" href="#hl-2-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-30">&lt;a class="lnlinks" href="#hl-2-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-31">&lt;a class="lnlinks" href="#hl-2-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-32">&lt;a class="lnlinks" href="#hl-2-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-33">&lt;a class="lnlinks" href="#hl-2-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-34">&lt;a class="lnlinks" href="#hl-2-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-35">&lt;a class="lnlinks" href="#hl-2-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-36">&lt;a class="lnlinks" href="#hl-2-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-37">&lt;a class="lnlinks" href="#hl-2-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-38">&lt;a class="lnlinks" href="#hl-2-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-39">&lt;a class="lnlinks" href="#hl-2-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-40">&lt;a class="lnlinks" href="#hl-2-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-41">&lt;a class="lnlinks" href="#hl-2-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-42">&lt;a class="lnlinks" href="#hl-2-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-43">&lt;a class="lnlinks" href="#hl-2-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-44">&lt;a class="lnlinks" href="#hl-2-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-45">&lt;a class="lnlinks" href="#hl-2-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-46">&lt;a class="lnlinks" href="#hl-2-46">46&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-mysql" data-lang="mysql">&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NAMES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8mb4&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FOREIGN_KEY_CHECKS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- ----------------------------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 分支事务表
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- ----------------------------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">DROP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IF&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">EXISTS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">branch_table&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">branch_table&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">branch_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">transaction_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">resource_group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">resource_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">256&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">branch_type&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">tinyint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">client_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">64&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">application_data&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2000&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_create&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">branch_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">USING&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BTREE&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">INDEX&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">idx_xid&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">USING&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BTREE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kp">ENGINE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ROW_FORMAT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Compact&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- ----------------------------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 全局事务表
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- ----------------------------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">DROP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IF&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">EXISTS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">global_table&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">global_table&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">transaction_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">tinyint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">application_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">transaction_service_group&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">transaction_name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">timeout&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">begin_time&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">application_data&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2000&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_create&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">USING&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BTREE&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">INDEX&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">idx_gmt_modified_status&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">USING&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BTREE&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">INDEX&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">idx_transaction_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">transaction_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">USING&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BTREE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kp">ENGINE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CHARACTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">utf8_general_ci&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ROW_FORMAT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Compact&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kt">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">FOREIGN_KEY_CHECKS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="6启动tc服务">
&lt;a href="#6%e5%90%af%e5%8a%a8tc%e6%9c%8d%e5%8a%a1" class="header-anchor">#&lt;/a>
6.启动TC服务
&lt;/h2>&lt;p>进入bin目录，运行其中的seata-server.bat即可：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740004-e34bcf8f752d46.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210622205427318"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>启动成功后，seata-server应该已经注册到nacos注册中心了。&lt;/p>
&lt;p>打开浏览器，访问nacos地址：http://localhost:8848，然后进入服务列表页面，可以看到seata-tc-server的信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740004-5968f38157082a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210622205901450"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="二微服务集成seata">
&lt;a href="#%e4%ba%8c%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%9b%86%e6%88%90seata" class="header-anchor">#&lt;/a>
二、微服务集成seata
&lt;/h1>&lt;h2 id="1引入依赖">
&lt;a href="#1%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96" class="header-anchor">#&lt;/a>
1.引入依赖
&lt;/h2>&lt;p>首先，我们需要在微服务中引入seata依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-7">&lt;a class="lnlinks" href="#hl-3-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-8">&lt;a class="lnlinks" href="#hl-3-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-9">&lt;a class="lnlinks" href="#hl-3-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-10">&lt;a class="lnlinks" href="#hl-3-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-11">&lt;a class="lnlinks" href="#hl-3-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-12">&lt;a class="lnlinks" href="#hl-3-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-13">&lt;a class="lnlinks" href="#hl-3-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-14">&lt;a class="lnlinks" href="#hl-3-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-15">&lt;a class="lnlinks" href="#hl-3-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-16">&lt;a class="lnlinks" href="#hl-3-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-17">&lt;a class="lnlinks" href="#hl-3-17">17&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.alibaba.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-alibaba-seata&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;exclusions&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!--版本较低，1.3.0，因此排除--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;exclusion&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>seata-spring-boot-starter&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>io.seata&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/exclusion&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/exclusions&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!--seata starter 采用1.4.2版本--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>io.seata&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>seata-spring-boot-starter&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>${seata.version}&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="2修改配置文件">
&lt;a href="#2%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="header-anchor">#&lt;/a>
2.修改配置文件
&lt;/h2>&lt;p>需要修改application.yml文件，添加一些配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-3">&lt;a class="lnlinks" href="#hl-4-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-4">&lt;a class="lnlinks" href="#hl-4-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-5">&lt;a class="lnlinks" href="#hl-4-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-6">&lt;a class="lnlinks" href="#hl-4-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-7">&lt;a class="lnlinks" href="#hl-4-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-8">&lt;a class="lnlinks" href="#hl-4-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-9">&lt;a class="lnlinks" href="#hl-4-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-10">&lt;a class="lnlinks" href="#hl-4-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-11">&lt;a class="lnlinks" href="#hl-4-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-12">&lt;a class="lnlinks" href="#hl-4-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-13">&lt;a class="lnlinks" href="#hl-4-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-4-14">&lt;a class="lnlinks" href="#hl-4-14">14&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">seata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">registry&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># TC服务注册中心的配置，微服务根据这些信息去注册中心获取tc服务地址&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># 参考tc服务自己的registry.conf中的配置&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nacos&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># tc&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server-addr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">127.0.0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">8848&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">DEFAULT_GROUP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">application&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">seata-tc-server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># tc服务在nacos中的服务名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cluster&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">SH&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tx-service-group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">seata-demo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 事务组，根据这个获取tc服务的cluster名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">service&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">vgroup-mapping&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 事务组与TC服务cluster的映射关系&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">seata-demo&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">SH&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="三tc服务的高可用和异地容灾">
&lt;a href="#%e4%b8%89tc%e6%9c%8d%e5%8a%a1%e7%9a%84%e9%ab%98%e5%8f%af%e7%94%a8%e5%92%8c%e5%bc%82%e5%9c%b0%e5%ae%b9%e7%81%be" class="header-anchor">#&lt;/a>
三、TC服务的高可用和异地容灾
&lt;/h1>&lt;h2 id="1模拟异地容灾的tc集群">
&lt;a href="#1%e6%a8%a1%e6%8b%9f%e5%bc%82%e5%9c%b0%e5%ae%b9%e7%81%be%e7%9a%84tc%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
1.模拟异地容灾的TC集群
&lt;/h2>&lt;p>计划启动两台seata的tc服务节点：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>节点名称&lt;/th>
&lt;th>ip地址&lt;/th>
&lt;th>端口号&lt;/th>
&lt;th>集群名称&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>seata&lt;/td>
&lt;td>127.0.0.1&lt;/td>
&lt;td>8091&lt;/td>
&lt;td>SH&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>seata2&lt;/td>
&lt;td>127.0.0.1&lt;/td>
&lt;td>8092&lt;/td>
&lt;td>HZ&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>之前我们已经启动了一台seata服务，端口是8091，集群名为SH。&lt;/p>
&lt;p>现在，将seata目录复制一份，起名为seata2&lt;/p>
&lt;p>修改seata2/conf/registry.conf内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-4">&lt;a class="lnlinks" href="#hl-5-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-5">&lt;a class="lnlinks" href="#hl-5-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-6">&lt;a class="lnlinks" href="#hl-5-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-7">&lt;a class="lnlinks" href="#hl-5-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-8">&lt;a class="lnlinks" href="#hl-5-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-9">&lt;a class="lnlinks" href="#hl-5-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-10">&lt;a class="lnlinks" href="#hl-5-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-11">&lt;a class="lnlinks" href="#hl-5-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-12">&lt;a class="lnlinks" href="#hl-5-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-13">&lt;a class="lnlinks" href="#hl-5-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-14">&lt;a class="lnlinks" href="#hl-5-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-15">&lt;a class="lnlinks" href="#hl-5-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-16">&lt;a class="lnlinks" href="#hl-5-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-17">&lt;a class="lnlinks" href="#hl-5-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-18">&lt;a class="lnlinks" href="#hl-5-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-19">&lt;a class="lnlinks" href="#hl-5-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-20">&lt;a class="lnlinks" href="#hl-5-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-21">&lt;a class="lnlinks" href="#hl-5-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-22">&lt;a class="lnlinks" href="#hl-5-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-23">&lt;a class="lnlinks" href="#hl-5-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-24">&lt;a class="lnlinks" href="#hl-5-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-25">&lt;a class="lnlinks" href="#hl-5-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-26">&lt;a class="lnlinks" href="#hl-5-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-27">&lt;a class="lnlinks" href="#hl-5-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-28">&lt;a class="lnlinks" href="#hl-5-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-29">&lt;a class="lnlinks" href="#hl-5-29">29&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">registry&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># tc服务的注册中心类，这里选择nacos，也可以是eureka、zookeeper等
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">type&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">nacos&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># seata tc 服务注册到 nacos的服务名称，可以自定义
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">application&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;seata-tc-server&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">serverAddr&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;127.0.0.1:8848&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">group&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;DEFAULT_GROUP&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">namespace&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">cluster&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;HZ&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">username&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">password&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">config&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 读取tc服务端的配置文件的方式，这里是从nacos配置中心读取，这样如果tc是集群，可以共享配置
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">type&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 配置nacos地址等信息
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="s">nacos&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">serverAddr&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;127.0.0.1:8848&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">namespace&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">group&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;SEATA_GROUP&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">username&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">password&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">dataId&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;seataServer.properties&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>进入seata2/bin目录，然后运行命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">seata-server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">bat&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8092&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>打开nacos控制台，查看服务列表：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740004-ddd524036ee719.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210624151150840"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>点进详情查看：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740004-cd2b7f49f03550.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210624151221747"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="2将事务组映射配置到nacos">
&lt;a href="#2%e5%b0%86%e4%ba%8b%e5%8a%a1%e7%bb%84%e6%98%a0%e5%b0%84%e9%85%8d%e7%bd%ae%e5%88%b0nacos" class="header-anchor">#&lt;/a>
2.将事务组映射配置到nacos
&lt;/h2>&lt;p>接下来，我们需要将tx-service-group与cluster的映射关系都配置到nacos配置中心。&lt;/p>
&lt;p>新建一个配置：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740004-dbc361c9966ccd.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210624151507072"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>配置的内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-8">&lt;a class="lnlinks" href="#hl-7-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-9">&lt;a class="lnlinks" href="#hl-7-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-10">&lt;a class="lnlinks" href="#hl-7-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-11">&lt;a class="lnlinks" href="#hl-7-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-12">&lt;a class="lnlinks" href="#hl-7-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-13">&lt;a class="lnlinks" href="#hl-7-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-14">&lt;a class="lnlinks" href="#hl-7-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-15">&lt;a class="lnlinks" href="#hl-7-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-16">&lt;a class="lnlinks" href="#hl-7-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-17">&lt;a class="lnlinks" href="#hl-7-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-18">&lt;a class="lnlinks" href="#hl-7-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-19">&lt;a class="lnlinks" href="#hl-7-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-20">&lt;a class="lnlinks" href="#hl-7-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-21">&lt;a class="lnlinks" href="#hl-7-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-22">&lt;a class="lnlinks" href="#hl-7-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-23">&lt;a class="lnlinks" href="#hl-7-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-24">&lt;a class="lnlinks" href="#hl-7-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-25">&lt;a class="lnlinks" href="#hl-7-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-26">&lt;a class="lnlinks" href="#hl-7-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-27">&lt;a class="lnlinks" href="#hl-7-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-28">&lt;a class="lnlinks" href="#hl-7-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-29">&lt;a class="lnlinks" href="#hl-7-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-30">&lt;a class="lnlinks" href="#hl-7-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-31">&lt;a class="lnlinks" href="#hl-7-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-32">&lt;a class="lnlinks" href="#hl-7-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-33">&lt;a class="lnlinks" href="#hl-7-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-34">&lt;a class="lnlinks" href="#hl-7-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-35">&lt;a class="lnlinks" href="#hl-7-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-36">&lt;a class="lnlinks" href="#hl-7-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-37">&lt;a class="lnlinks" href="#hl-7-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-38">&lt;a class="lnlinks" href="#hl-7-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-39">&lt;a class="lnlinks" href="#hl-7-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-40">&lt;a class="lnlinks" href="#hl-7-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-41">&lt;a class="lnlinks" href="#hl-7-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-42">&lt;a class="lnlinks" href="#hl-7-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-43">&lt;a class="lnlinks" href="#hl-7-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-44">&lt;a class="lnlinks" href="#hl-7-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-45">&lt;a class="lnlinks" href="#hl-7-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-46">&lt;a class="lnlinks" href="#hl-7-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-47">&lt;a class="lnlinks" href="#hl-7-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-48">&lt;a class="lnlinks" href="#hl-7-48">48&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 事务组映射关系&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">service.vgroupMapping.seata-demo&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">SH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">service.enableDegrade&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">service.disableGlobalTransaction&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 与TC服务的通信配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">TCP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.server&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">NIO&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.heartbeat&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.enableClientBatchSendRequest&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.threadFactory.bossThreadPrefix&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">NettyBoss&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.threadFactory.workerThreadPrefix&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">NettyServerNIOWorker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.threadFactory.serverExecutorThreadPrefix&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">NettyServerBizHandler&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.threadFactory.shareBossWorker&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.threadFactory.clientSelectorThreadPrefix&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">NettyClientSelector&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.threadFactory.clientSelectorThreadSize&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.threadFactory.clientWorkerThreadPrefix&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">NettyClientWorkerThread&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.threadFactory.bossThreadSize&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.threadFactory.workerThreadSize&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">default&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">transport.shutdown.wait&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># RM配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.rm.asyncCommitBufferLimit&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.rm.lock.retryInterval&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.rm.lock.retryTimes&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">30&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.rm.lock.retryPolicyBranchRollbackOnConflict&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.rm.reportRetryCount&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.rm.tableMetaCheckEnable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.rm.tableMetaCheckerInterval&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">60000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.rm.sqlParserType&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">druid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.rm.reportSuccessEnable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.rm.sagaBranchRegisterEnable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># TM配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.tm.commitRetryCount&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.tm.rollbackRetryCount&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.tm.defaultGlobalTransactionTimeout&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">60000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.tm.degradeCheck&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.tm.degradeCheckAllowTimes&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.tm.degradeCheckPeriod&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">2000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># undo日志配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.undo.dataValidation&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.undo.logSerialization&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">jackson&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.undo.onlyCareUpdateColumns&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.undo.logTable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">undo_log&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.undo.compress.enable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.undo.compress.type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">zip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.undo.compress.threshold&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">64k&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">client.log.exceptionRate&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">100&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="3微服务读取nacos配置">
&lt;a href="#3%e5%be%ae%e6%9c%8d%e5%8a%a1%e8%af%bb%e5%8f%96nacos%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
3.微服务读取nacos配置
&lt;/h2>&lt;p>接下来，需要修改每一个微服务的application.yml文件，让微服务读取nacos中的client.properties文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-6">&lt;a class="lnlinks" href="#hl-8-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-7">&lt;a class="lnlinks" href="#hl-8-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-8">&lt;a class="lnlinks" href="#hl-8-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-9">&lt;a class="lnlinks" href="#hl-8-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">seata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">config&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nacos&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server-addr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">127.0.0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">8848&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">username&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nacos&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">password&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nacos&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">SEATA_GROUP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">data-id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">client.properties&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启微服务，现在微服务到底是连接tc的SH集群，还是tc的HZ集群，都统一由nacos的client.properties来决定了。&lt;/p></description></item><item><title>9.分布式事务</title><link>https://logan.wssw.fun/p/2023/01/17845117/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/17845117/</guid><description>&lt;h1 id="分布式事务">
&lt;a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" class="header-anchor">#&lt;/a>
分布式事务
&lt;/h1>&lt;h1 id="0学习目标">
&lt;a href="#0%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87" class="header-anchor">#&lt;/a>
0.学习目标
&lt;/h1>&lt;h1 id="1分布式事务问题">
&lt;a href="#1%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
1.分布式事务问题
&lt;/h1>&lt;h2 id="11本地事务">
&lt;a href="#11%e6%9c%ac%e5%9c%b0%e4%ba%8b%e5%8a%a1" class="header-anchor">#&lt;/a>
1.1.本地事务
&lt;/h2>&lt;p>本地事务，也就是传统的&lt;strong>单机事务&lt;/strong>。在传统数据库事务中，必须要满足四个原则：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-995930d562424b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724165045186"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="12分布式事务">
&lt;a href="#12%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1" class="header-anchor">#&lt;/a>
1.2.分布式事务
&lt;/h2>&lt;p>&lt;strong>分布式事务&lt;/strong>，就是指不是在单个服务或单个数据库架构下，产生的事务，例如：&lt;/p>
&lt;ul>
&lt;li>跨数据源的分布式事务&lt;/li>
&lt;li>跨服务的分布式事务&lt;/li>
&lt;li>综合情况&lt;/li>
&lt;/ul>
&lt;p>在数据库水平拆分、服务垂直拆分之后，一个业务操作通常要跨多个数据库、服务才能完成。例如电商行业中比较常见的下单付款案例，包括下面几个行为：&lt;/p>
&lt;ul>
&lt;li>创建新订单&lt;/li>
&lt;li>扣减商品库存&lt;/li>
&lt;li>从用户账户余额扣除金额&lt;/li>
&lt;/ul>
&lt;p>完成上面的操作需要访问三个不同的微服务和三个不同的数据库。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-e35699348349a1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724165338958"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>订单的创建、库存的扣减、账户扣款在每一个服务和数据库内是一个本地事务，可以保证ACID原则。&lt;/p>
&lt;p>但是当我们把三件事情看做一个&amp;quot;业务&amp;quot;，要满足保证“业务”的原子性，要么所有操作全部成功，要么全部失败，不允许出现部分成功部分失败的现象，这就是&lt;strong>分布式系统下的事务&lt;/strong>了。&lt;/p>
&lt;p>此时ACID难以满足，这是分布式事务要解决的问题&lt;/p>
&lt;h2 id="13演示分布式事务问题">
&lt;a href="#13%e6%bc%94%e7%a4%ba%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
1.3.演示分布式事务问题
&lt;/h2>&lt;p>我们通过一个案例来演示分布式事务的问题：&lt;/p>
&lt;p>1）&lt;strong>创建数据库，名为seata_demo，然后导入课前资料提供的SQL文件：&lt;/strong>&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-870964f0cf7f33.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724165634571"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>2）&lt;strong>导入课前资料提供的微服务：&lt;/strong>&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-788a3e7bb78d4f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724165709994"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>微服务结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-a2a69017f7c440.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724165729273"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中：&lt;/p>
&lt;p>seata-demo：父工程，负责管理项目依赖&lt;/p>
&lt;ul>
&lt;li>account-service：账户服务，负责管理用户的资金账户。提供扣减余额的接口&lt;/li>
&lt;li>storage-service：库存服务，负责管理商品库存。提供扣减库存的接口&lt;/li>
&lt;li>order-service：订单服务，负责管理订单。创建订单时，需要调用account-service和storage-service&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>3）启动nacos、所有微服务&lt;/strong>&lt;/p>
&lt;p>&lt;strong>4）测试下单功能，发出Post请求：&lt;/strong>&lt;/p>
&lt;p>请求如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">curl --location --request POST &lt;span class="s1">&amp;#39;http://localhost:8082/order?userId=user202103032042012&amp;amp;commodityCode=100202003032041&amp;amp;count=20&amp;amp;money=200&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-47916f893f15fb.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724170113404"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>测试发现，当库存不足时，如果余额已经扣减，并不会回滚，出现了分布式事务问题。&lt;/p>
&lt;h1 id="2理论基础">
&lt;a href="#2%e7%90%86%e8%ae%ba%e5%9f%ba%e7%a1%80" class="header-anchor">#&lt;/a>
2.理论基础
&lt;/h1>&lt;p>解决分布式事务问题，需要一些分布式系统的基础知识作为理论指导。&lt;/p>
&lt;h2 id="21cap定理">
&lt;a href="#21cap%e5%ae%9a%e7%90%86" class="header-anchor">#&lt;/a>
2.1.CAP定理
&lt;/h2>&lt;p>1998年，加州大学的计算机科学家 Eric Brewer 提出，分布式系统有三个指标。&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>Consistency（一致性）&lt;/li>
&lt;li>Availability（可用性）&lt;/li>
&lt;li>Partition tolerance （分区容错性）&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-65d448f79ddb86.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724170517944"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>它们的第一个字母分别是 C、A、P。&lt;/p>
&lt;p>Eric Brewer 说，这三个指标不可能同时做到。这个结论就叫做 CAP 定理。&lt;/p>
&lt;h3 id="211一致性">
&lt;a href="#211%e4%b8%80%e8%87%b4%e6%80%a7" class="header-anchor">#&lt;/a>
2.1.1.一致性
&lt;/h3>&lt;p>Consistency（一致性）：用户访问分布式系统中的任意节点，得到的数据必须一致。&lt;/p>
&lt;p>比如现在包含两个节点，其中的初始数据是一致的：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-19bd83cea58ba5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724170704694"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>当我们修改其中一个节点的数据时，两者的数据产生了差异：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-3f01b5e8db798c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724170735847"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>要想保住一致性，就必须实现node01 到 node02的数据 同步：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-0cd23112fbe55b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724170834855"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="212可用性">
&lt;a href="#212%e5%8f%af%e7%94%a8%e6%80%a7" class="header-anchor">#&lt;/a>
2.1.2.可用性
&lt;/h3>&lt;p>Availability （可用性）：用户访问集群中的任意健康节点，必须能得到响应，而不是超时或拒绝。&lt;/p>
&lt;p>如图，有三个节点的集群，访问任何一个都可以及时得到响应：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-954cf3856c5467.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724170932072"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>当有部分节点因为网络故障或其它原因无法访问时，代表节点不可用：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-b6829b1f9a2c45.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724171007516"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="213分区容错">
&lt;a href="#213%e5%88%86%e5%8c%ba%e5%ae%b9%e9%94%99" class="header-anchor">#&lt;/a>
2.1.3.分区容错
&lt;/h3>&lt;p>&lt;strong>Partition（分区）&lt;/strong>：因为网络故障或其它原因导致分布式系统中的部分节点与其它节点失去连接，形成独立分区。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-2f490f86d483c6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724171041210"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>&lt;strong>Tolerance（容错）&lt;/strong>：在集群出现分区时，整个系统也要持续对外提供服务&lt;/p>
&lt;h3 id="214矛盾">
&lt;a href="#214%e7%9f%9b%e7%9b%be" class="header-anchor">#&lt;/a>
2.1.4.矛盾
&lt;/h3>&lt;p>在分布式系统中，系统间的网络不能100%保证健康，一定会有故障的时候，而服务有必须对外保证服务。因此Partition Tolerance不可避免。&lt;/p>
&lt;p>当节点接收到新的数据变更时，就会出现问题了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-92d69e8906fdd3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724171546472"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如果此时要保证&lt;strong>一致性&lt;/strong>，就必须等待网络恢复，完成数据同步后，整个集群才对外提供服务，服务处于阻塞状态，不可用。&lt;/p>
&lt;p>如果此时要保证&lt;strong>可用性&lt;/strong>，就不能等待网络恢复，那node01、node02与node03之间就会出现数据不一致。&lt;/p>
&lt;p>也就是说，在P一定会出现的情况下，A和C之间只能实现一个。&lt;/p>
&lt;h2 id="22base理论">
&lt;a href="#22base%e7%90%86%e8%ae%ba" class="header-anchor">#&lt;/a>
2.2.BASE理论
&lt;/h2>&lt;p>BASE理论是对CAP的一种解决思路，包含三个思想：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Basically Available&lt;/strong> &lt;strong>（基本可用）&lt;/strong>：分布式系统在出现故障时，允许损失部分可用性，即保证核心可用。&lt;/li>
&lt;li>**Soft State（软状态）：**在一定时间内，允许出现中间状态，比如临时的不一致状态。&lt;/li>
&lt;li>&lt;strong>Eventually Consistent（最终一致性）&lt;/strong>：虽然无法保证强一致性，但是在软状态结束后，最终达到数据一致。&lt;/li>
&lt;/ul>
&lt;h2 id="23解决分布式事务的思路">
&lt;a href="#23%e8%a7%a3%e5%86%b3%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e7%9a%84%e6%80%9d%e8%b7%af" class="header-anchor">#&lt;/a>
2.3.解决分布式事务的思路
&lt;/h2>&lt;p>分布式事务最大的问题是各个子事务的一致性问题，因此可以借鉴CAP定理和BASE理论，有两种解决思路：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>AP模式：各子事务分别执行和提交，允许出现结果不一致，然后采用弥补措施恢复数据即可，实现最终一致。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>CP模式：各个子事务执行后互相等待，同时提交，同时回滚，达成强一致。但事务等待过程中，处于弱可用状态。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>但不管是哪一种模式，都需要在子系统事务之间互相通讯，协调事务状态，也就是需要一个&lt;strong>事务协调者(TC)&lt;/strong>：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-903f22573f91f1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724172123567"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这里的子系统事务，称为&lt;strong>分支事务&lt;/strong>；有关联的各个分支事务在一起称为&lt;strong>全局事务&lt;/strong>。&lt;/p>
&lt;h1 id="3初识seata">
&lt;a href="#3%e5%88%9d%e8%af%86seata" class="header-anchor">#&lt;/a>
3.初识Seata
&lt;/h1>&lt;p>Seata是 2019 年 1 月份蚂蚁金服和阿里巴巴共同开源的分布式事务解决方案。致力于提供高性能和简单易用的分布式事务服务，为用户打造一站式的分布式解决方案。&lt;/p>
&lt;p>官网地址：http://seata.io/，其中的文档、播客中提供了大量的使用说明、源码分析。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-2532dc4f969020.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724172225817"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="31seata的架构">
&lt;a href="#31seata%e7%9a%84%e6%9e%b6%e6%9e%84" class="header-anchor">#&lt;/a>
3.1.Seata的架构
&lt;/h2>&lt;p>Seata事务管理中有三个重要的角色：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>TC (Transaction Coordinator) -&lt;/strong> **事务协调者：**维护全局和分支事务的状态，协调全局事务提交或回滚。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>TM (Transaction Manager) -&lt;/strong> **事务管理器：**定义全局事务的范围、开始全局事务、提交或回滚全局事务。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>RM (Resource Manager) -&lt;/strong> **资源管理器：**管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>整体的架构如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-c7a6aabca5088b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724172326452"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>Seata基于上述架构提供了四种不同的分布式事务解决方案：&lt;/p>
&lt;ul>
&lt;li>XA模式：强一致性分阶段事务模式，牺牲了一定的可用性，无业务侵入&lt;/li>
&lt;li>TCC模式：最终一致的分阶段事务模式，有业务侵入&lt;/li>
&lt;li>AT模式：最终一致的分阶段事务模式，无业务侵入，也是Seata的默认模式&lt;/li>
&lt;li>SAGA模式：长事务模式，有业务侵入&lt;/li>
&lt;/ul>
&lt;p>无论哪种方案，都离不开TC，也就是事务的协调者。&lt;/p>
&lt;h2 id="32部署tc服务">
&lt;a href="#32%e9%83%a8%e7%bd%b2tc%e6%9c%8d%e5%8a%a1" class="header-anchor">#&lt;/a>
3.2.部署TC服务
&lt;/h2>&lt;p>参考课前资料提供的文档《 seata的部署和集成.md 》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-883cd38b8fef94.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724172549013"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="33微服务集成seata">
&lt;a href="#33%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%9b%86%e6%88%90seata" class="header-anchor">#&lt;/a>
3.3.微服务集成Seata
&lt;/h2>&lt;p>我们以order-service为例来演示。&lt;/p>
&lt;h3 id="331引入依赖">
&lt;a href="#331%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96" class="header-anchor">#&lt;/a>
3.3.1.引入依赖
&lt;/h3>&lt;p>首先，在order-service中引入依赖：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-9">&lt;a class="lnlinks" href="#hl-1-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-10">&lt;a class="lnlinks" href="#hl-1-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-11">&lt;a class="lnlinks" href="#hl-1-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-12">&lt;a class="lnlinks" href="#hl-1-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-13">&lt;a class="lnlinks" href="#hl-1-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-14">&lt;a class="lnlinks" href="#hl-1-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-15">&lt;a class="lnlinks" href="#hl-1-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-16">&lt;a class="lnlinks" href="#hl-1-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-17">&lt;a class="lnlinks" href="#hl-1-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-18">&lt;a class="lnlinks" href="#hl-1-18">18&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!--seata--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.alibaba.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-alibaba-seata&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;exclusions&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!--版本较低，1.3.0，因此排除--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;exclusion&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>seata-spring-boot-starter&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>io.seata&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/exclusion&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/exclusions&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>io.seata&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>seata-spring-boot-starter&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!--seata starter 采用1.4.2版本--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>${seata.version}&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="332配置tc地址">
&lt;a href="#332%e9%85%8d%e7%bd%aetc%e5%9c%b0%e5%9d%80" class="header-anchor">#&lt;/a>
3.3.2.配置TC地址
&lt;/h3>&lt;p>在order-service中的application.yml中，配置TC服务信息，通过注册中心nacos，结合服务名称获取TC地址：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-9">&lt;a class="lnlinks" href="#hl-2-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-10">&lt;a class="lnlinks" href="#hl-2-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-11">&lt;a class="lnlinks" href="#hl-2-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-12">&lt;a class="lnlinks" href="#hl-2-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-13">&lt;a class="lnlinks" href="#hl-2-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-14">&lt;a class="lnlinks" href="#hl-2-14">14&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">seata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">registry&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># TC服务注册中心的配置，微服务根据这些信息去注册中心获取tc服务地址&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nacos&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 注册中心类型 nacos&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server-addr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">127.0.0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">8848&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># nacos地址&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># namespace，默认为空&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">DEFAULT_GROUP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 分组，默认是DEFAULT_GROUP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">application&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">seata-tc-server&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># seata服务名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">username&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nacos&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">password&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nacos&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tx-service-group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">seata-demo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 事务组名称&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">service&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">vgroup-mapping&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 事务组与cluster的映射关系&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">seata-demo&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">SH&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>微服务如何根据这些配置寻找TC的地址呢？&lt;/p>
&lt;p>我们知道注册到Nacos中的微服务，确定一个具体实例需要四个信息：&lt;/p>
&lt;ul>
&lt;li>namespace：命名空间&lt;/li>
&lt;li>group：分组&lt;/li>
&lt;li>application：服务名&lt;/li>
&lt;li>cluster：集群名&lt;/li>
&lt;/ul>
&lt;p>以上四个信息，在刚才的yaml文件中都能找到：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-e14a9611f76b47.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724173654258"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>namespace为空，就是默认的public&lt;/p>
&lt;p>结合起来，TC服务的信息就是：public@DEFAULT_GROUP@seata-tc-server@SH，这样就能确定TC服务集群了。然后就可以去Nacos拉取对应的实例信息了。&lt;/p>
&lt;h3 id="333其它服务">
&lt;a href="#333%e5%85%b6%e5%ae%83%e6%9c%8d%e5%8a%a1" class="header-anchor">#&lt;/a>
3.3.3.其它服务
&lt;/h3>&lt;p>其它两个微服务也都参考order-service的步骤来做，完全一样。&lt;/p>
&lt;h1 id="4动手实践">
&lt;a href="#4%e5%8a%a8%e6%89%8b%e5%ae%9e%e8%b7%b5" class="header-anchor">#&lt;/a>
4.动手实践
&lt;/h1>&lt;p>下面我们就一起学习下Seata中的四种不同的事务模式。&lt;/p>
&lt;h2 id="41xa模式">
&lt;a href="#41xa%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
4.1.XA模式
&lt;/h2>&lt;p>XA 规范 是 X/Open 组织定义的分布式事务处理（DTP，Distributed Transaction Processing）标准，XA 规范 描述了全局的TM与局部的RM之间的接口，几乎所有主流的数据库都对 XA 规范 提供了支持。&lt;/p>
&lt;h3 id="411两阶段提交">
&lt;a href="#411%e4%b8%a4%e9%98%b6%e6%ae%b5%e6%8f%90%e4%ba%a4" class="header-anchor">#&lt;/a>
4.1.1.两阶段提交
&lt;/h3>&lt;p>XA是规范，目前主流数据库都实现了这种规范，实现的原理都是基于两阶段提交。&lt;/p>
&lt;p>正常情况：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-f1f4981d26151d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724174102768"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>异常情况：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-50dd1b90404b6b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724174234987"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>一阶段：&lt;/p>
&lt;ul>
&lt;li>事务协调者通知每个事物参与者执行本地事务&lt;/li>
&lt;li>本地事务执行完成后报告事务执行状态给事务协调者，此时事务不提交，继续持有数据库锁&lt;/li>
&lt;/ul>
&lt;p>二阶段：&lt;/p>
&lt;ul>
&lt;li>事务协调者基于一阶段的报告来判断下一步操作
&lt;ul>
&lt;li>如果一阶段都成功，则通知所有事务参与者，提交事务&lt;/li>
&lt;li>如果一阶段任意一个参与者失败，则通知所有事务参与者回滚事务&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="412seata的xa模型">
&lt;a href="#412seata%e7%9a%84xa%e6%a8%a1%e5%9e%8b" class="header-anchor">#&lt;/a>
4.1.2.Seata的XA模型
&lt;/h3>&lt;p>Seata对原始的XA模式做了简单的封装和改造，以适应自己的事务模型，基本架构如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-abe22f1cc3122c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724174424070"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>RM一阶段的工作：&lt;/p>
&lt;p>​ ① 注册分支事务到TC&lt;/p>
&lt;p>​ ② 执行分支业务sql但不提交&lt;/p>
&lt;p>​ ③ 报告执行状态到TC&lt;/p>
&lt;p>TC二阶段的工作：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>TC检测各分支事务执行状态&lt;/p>
&lt;p>a.如果都成功，通知所有RM提交事务&lt;/p>
&lt;p>b.如果有失败，通知所有RM回滚事务&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>RM二阶段的工作：&lt;/p>
&lt;ul>
&lt;li>接收TC指令，提交或回滚事务&lt;/li>
&lt;/ul>
&lt;h3 id="413优缺点">
&lt;a href="#413%e4%bc%98%e7%bc%ba%e7%82%b9" class="header-anchor">#&lt;/a>
4.1.3.优缺点
&lt;/h3>&lt;p>XA模式的优点是什么？&lt;/p>
&lt;ul>
&lt;li>事务的强一致性，满足ACID原则。&lt;/li>
&lt;li>常用数据库都支持，实现简单，并且没有代码侵入&lt;/li>
&lt;/ul>
&lt;p>XA模式的缺点是什么？&lt;/p>
&lt;ul>
&lt;li>因为一阶段需要锁定数据库资源，等待二阶段结束才释放，性能较差&lt;/li>
&lt;li>依赖关系型数据库实现事务&lt;/li>
&lt;/ul>
&lt;h3 id="414实现xa模式">
&lt;a href="#414%e5%ae%9e%e7%8e%b0xa%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
4.1.4.实现XA模式
&lt;/h3>&lt;p>Seata的starter已经完成了XA模式的自动装配，实现非常简单，步骤如下：&lt;/p>
&lt;p>1）修改application.yml文件（每个参与事务的微服务），开启XA模式：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">seata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">data-source-proxy-mode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">XA&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）给发起全局事务的入口方法添加@GlobalTransactional注解:&lt;/p>
&lt;p>本例中是OrderServiceImpl中的create方法.&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-8a878a127b1193.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724174859556"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>3）重启服务并测试&lt;/p>
&lt;p>重启order-service，再次测试，发现无论怎样，三个微服务都能成功回滚。&lt;/p>
&lt;h2 id="42at模式">
&lt;a href="#42at%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
4.2.AT模式
&lt;/h2>&lt;p>AT模式同样是分阶段提交的事务模型，不过缺弥补了XA模型中资源锁定周期过长的缺陷。&lt;/p>
&lt;h3 id="421seata的at模型">
&lt;a href="#421seata%e7%9a%84at%e6%a8%a1%e5%9e%8b" class="header-anchor">#&lt;/a>
4.2.1.Seata的AT模型
&lt;/h3>&lt;p>基本流程图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-fe46bb73425cd6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724175327511"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>阶段一RM的工作：&lt;/p>
&lt;ul>
&lt;li>注册分支事务&lt;/li>
&lt;li>记录undo-log（数据快照）&lt;/li>
&lt;li>执行业务sql并提交&lt;/li>
&lt;li>报告事务状态&lt;/li>
&lt;/ul>
&lt;p>阶段二提交时RM的工作：&lt;/p>
&lt;ul>
&lt;li>删除undo-log即可&lt;/li>
&lt;/ul>
&lt;p>阶段二回滚时RM的工作：&lt;/p>
&lt;ul>
&lt;li>根据undo-log恢复数据到更新前&lt;/li>
&lt;/ul>
&lt;h3 id="422流程梳理">
&lt;a href="#422%e6%b5%81%e7%a8%8b%e6%a2%b3%e7%90%86" class="header-anchor">#&lt;/a>
4.2.2.流程梳理
&lt;/h3>&lt;p>我们用一个真实的业务来梳理下AT模式的原理。&lt;/p>
&lt;p>比如，现在又一个数据库表，记录用户余额：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>id&lt;/strong>&lt;/th>
&lt;th>&lt;strong>money&lt;/strong>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>100&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>其中一个分支业务要执行的SQL为：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">update&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tb_account&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">set&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">money&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">money&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>AT模式下，当前分支事务执行流程如下：&lt;/p>
&lt;p>一阶段：&lt;/p>
&lt;p>1）TM发起并注册全局事务到TC&lt;/p>
&lt;p>2）TM调用分支事务&lt;/p>
&lt;p>3）分支事务准备执行业务SQL&lt;/p>
&lt;p>4）RM拦截业务SQL，根据where条件查询原始数据，形成快照。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;money&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>5）RM执行业务SQL，提交本地事务，释放数据库锁。此时 &lt;code>money = 90&lt;/code>&lt;/p>
&lt;p>6）RM报告本地事务状态给TC&lt;/p>
&lt;p>二阶段：&lt;/p>
&lt;p>1）TM通知TC事务结束&lt;/p>
&lt;p>2）TC检查分支事务状态&lt;/p>
&lt;p>​ a）如果都成功，则立即删除快照&lt;/p>
&lt;p>​ b）如果有分支事务失败，需要回滚。读取快照数据（&lt;code>{&amp;quot;id&amp;quot;: 1, &amp;quot;money&amp;quot;: 100}&lt;/code>），将快照恢复到数据库。此时数据库再次恢复为100&lt;/p>
&lt;p>流程图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-89b0c374217403.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724180722921"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="423at与xa的区别">
&lt;a href="#423at%e4%b8%8exa%e7%9a%84%e5%8c%ba%e5%88%ab" class="header-anchor">#&lt;/a>
4.2.3.AT与XA的区别
&lt;/h3>&lt;p>简述AT模式与XA模式最大的区别是什么？&lt;/p>
&lt;ul>
&lt;li>XA模式一阶段不提交事务，锁定资源；AT模式一阶段直接提交，不锁定资源。&lt;/li>
&lt;li>XA模式依赖数据库机制实现回滚；AT模式利用数据快照实现数据回滚。&lt;/li>
&lt;li>XA模式强一致；AT模式最终一致&lt;/li>
&lt;/ul>
&lt;h3 id="424脏写问题">
&lt;a href="#424%e8%84%8f%e5%86%99%e9%97%ae%e9%a2%98" class="header-anchor">#&lt;/a>
4.2.4.脏写问题
&lt;/h3>&lt;p>在多线程并发访问AT模式的分布式事务时，有可能出现脏写问题，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-a4919fdecdb716.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724181541234"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解决思路就是引入了全局锁的概念。在释放DB锁之前，先拿到全局锁。避免同一时刻有另外一个事务来操作当前数据。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-488839606b78c0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724181843029"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="425优缺点">
&lt;a href="#425%e4%bc%98%e7%bc%ba%e7%82%b9" class="header-anchor">#&lt;/a>
4.2.5.优缺点
&lt;/h3>&lt;p>AT模式的优点：&lt;/p>
&lt;ul>
&lt;li>一阶段完成直接提交事务，释放数据库资源，性能比较好&lt;/li>
&lt;li>利用全局锁实现读写隔离&lt;/li>
&lt;li>没有代码侵入，框架自动完成回滚和提交&lt;/li>
&lt;/ul>
&lt;p>AT模式的缺点：&lt;/p>
&lt;ul>
&lt;li>两阶段之间属于软状态，属于最终一致&lt;/li>
&lt;li>框架的快照功能会影响性能，但比XA模式要好很多&lt;/li>
&lt;/ul>
&lt;h3 id="426实现at模式">
&lt;a href="#426%e5%ae%9e%e7%8e%b0at%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
4.2.6.实现AT模式
&lt;/h3>&lt;p>AT模式中的快照生成、回滚等动作都是由框架自动完成，没有任何代码侵入，因此实现非常简单。&lt;/p>
&lt;p>只不过，AT模式需要一个表来记录全局锁、另一张表来记录数据快照undo_log。&lt;/p>
&lt;p>1）导入数据库表，记录全局锁&lt;/p>
&lt;p>导入课前资料提供的Sql文件：seata-at.sql，其中lock_table导入到TC服务关联的数据库，undo_log表导入到微服务关联的数据库：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-2a7bba07bef808.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724182217272"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>2）修改application.yml文件，将事务模式修改为AT模式即可：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">seata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">data-source-proxy-mode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">AT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 默认就是AT&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）重启服务并测试&lt;/p>
&lt;h2 id="43tcc模式">
&lt;a href="#43tcc%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
4.3.TCC模式
&lt;/h2>&lt;p>TCC模式与AT模式非常相似，每阶段都是独立事务，不同的是TCC通过人工编码来实现数据恢复。需要实现三个方法：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Try：资源的检测和预留；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Confirm：完成资源操作业务；要求 Try 成功 Confirm 一定要能成功。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Cancel：预留资源释放，可以理解为try的反向操作。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="431流程分析">
&lt;a href="#431%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90" class="header-anchor">#&lt;/a>
4.3.1.流程分析
&lt;/h3>&lt;p>举例，一个扣减用户余额的业务。假设账户A原来余额是100，需要余额扣减30元。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>阶段一（ Try ）&lt;/strong>：检查余额是否充足，如果充足则冻结金额增加30元，可用余额扣除30&lt;/li>
&lt;/ul>
&lt;p>初识余额：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-aab5a11edcf598.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724182424907"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>余额充足，可以冻结：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-a438a597142643.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724182457951"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>此时，总金额 = 冻结金额 + 可用金额，数量依然是100不变。事务直接提交无需等待其它事务。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>阶段二（Confirm)&lt;/strong>：假如要提交（Confirm），则冻结金额扣减30&lt;/li>
&lt;/ul>
&lt;p>确认可以提交，不过之前可用金额已经扣减过了，这里只要清除冻结金额就好了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-ee91fa71f78d42.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724182706011"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>此时，总金额 = 冻结金额 + 可用金额 = 0 + 70 = 70元&lt;/p>
&lt;ul>
&lt;li>&lt;strong>阶段二(Canncel)&lt;/strong>：如果要回滚（Cancel），则冻结金额扣减30，可用余额增加30&lt;/li>
&lt;/ul>
&lt;p>需要回滚，那么就要释放冻结金额，恢复可用金额：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-c2bba3ab022a2e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724182810734"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="432seata的tcc模型">
&lt;a href="#432seata%e7%9a%84tcc%e6%a8%a1%e5%9e%8b" class="header-anchor">#&lt;/a>
4.3.2.Seata的TCC模型
&lt;/h3>&lt;p>Seata中的TCC模型依然延续之前的事务架构，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-d1392152110fe8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724182937713"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="433优缺点">
&lt;a href="#433%e4%bc%98%e7%bc%ba%e7%82%b9" class="header-anchor">#&lt;/a>
4.3.3.优缺点
&lt;/h3>&lt;p>TCC模式的每个阶段是做什么的？&lt;/p>
&lt;ul>
&lt;li>Try：资源检查和预留&lt;/li>
&lt;li>Confirm：业务执行和提交&lt;/li>
&lt;li>Cancel：预留资源的释放&lt;/li>
&lt;/ul>
&lt;p>TCC的优点是什么？&lt;/p>
&lt;ul>
&lt;li>一阶段完成直接提交事务，释放数据库资源，性能好&lt;/li>
&lt;li>相比AT模型，无需生成快照，无需使用全局锁，性能最强&lt;/li>
&lt;li>不依赖数据库事务，而是依赖补偿操作，可以用于非事务型数据库&lt;/li>
&lt;/ul>
&lt;p>TCC的缺点是什么？&lt;/p>
&lt;ul>
&lt;li>有代码侵入，需要人为编写try、Confirm和Cancel接口，太麻烦&lt;/li>
&lt;li>软状态，事务是最终一致&lt;/li>
&lt;li>需要考虑Confirm和Cancel的失败情况，做好幂等处理&lt;/li>
&lt;/ul>
&lt;h3 id="434事务悬挂和空回滚">
&lt;a href="#434%e4%ba%8b%e5%8a%a1%e6%82%ac%e6%8c%82%e5%92%8c%e7%a9%ba%e5%9b%9e%e6%bb%9a" class="header-anchor">#&lt;/a>
4.3.4.事务悬挂和空回滚
&lt;/h3>&lt;h4 id="1空回滚">
&lt;a href="#1%e7%a9%ba%e5%9b%9e%e6%bb%9a" class="header-anchor">#&lt;/a>
1）空回滚
&lt;/h4>&lt;p>当某分支事务的try阶段&lt;strong>阻塞&lt;/strong>时，可能导致全局事务超时而触发二阶段的cancel操作。在未执行try操作时先执行了cancel操作，这时cancel不能做回滚，就是&lt;strong>空回滚&lt;/strong>。&lt;/p>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-b06dc11dd38a04.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724183426891"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>执行cancel操作时，应当判断try是否已经执行，如果尚未执行，则应该空回滚。&lt;/p>
&lt;h4 id="2业务悬挂">
&lt;a href="#2%e4%b8%9a%e5%8a%a1%e6%82%ac%e6%8c%82" class="header-anchor">#&lt;/a>
2）业务悬挂
&lt;/h4>&lt;p>对于已经空回滚的业务，之前被阻塞的try操作恢复，继续执行try，就永远不可能confirm或cancel ，事务一直处于中间状态，这就是&lt;strong>业务悬挂&lt;/strong>。&lt;/p>
&lt;p>执行try操作时，应当判断cancel是否已经执行过了，如果已经执行，应当阻止空回滚后的try操作，避免悬挂&lt;/p>
&lt;h3 id="435实现tcc模式">
&lt;a href="#435%e5%ae%9e%e7%8e%b0tcc%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
4.3.5.实现TCC模式
&lt;/h3>&lt;p>解决空回滚和业务悬挂问题，必须要记录当前事务状态，是在try、还是cancel？&lt;/p>
&lt;h4 id="1思路分析">
&lt;a href="#1%e6%80%9d%e8%b7%af%e5%88%86%e6%9e%90" class="header-anchor">#&lt;/a>
1）思路分析
&lt;/h4>&lt;p>这里我们定义一张表：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">account_freeze_tbl&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;用户id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">freeze_money&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;冻结金额&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="k">state&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;事务状态，0:try，1:confirm，2:cancel&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">  &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">USING&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BTREE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ROW_FORMAT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">COMPACT&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中：&lt;/p>
&lt;ul>
&lt;li>xid：是全局事务id&lt;/li>
&lt;li>freeze_money：用来记录用户冻结金额&lt;/li>
&lt;li>state：用来记录事务状态&lt;/li>
&lt;/ul>
&lt;p>那此时，我们的业务开怎么做呢？&lt;/p>
&lt;ul>
&lt;li>Try业务：
&lt;ul>
&lt;li>记录冻结金额和事务状态到account_freeze表&lt;/li>
&lt;li>扣减account表可用金额&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Confirm业务
&lt;ul>
&lt;li>根据xid删除account_freeze表的冻结记录&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Cancel业务
&lt;ul>
&lt;li>修改account_freeze表，冻结金额为0，state为2&lt;/li>
&lt;li>修改account表，恢复可用金额&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>如何判断是否空回滚？
&lt;ul>
&lt;li>cancel业务中，根据xid查询account_freeze，如果为null则说明try还没做，需要空回滚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>如何避免业务悬挂？
&lt;ul>
&lt;li>try业务中，根据xid查询account_freeze ，如果已经存在则证明Cancel已经执行，拒绝执行try业务&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>接下来，我们改造account-service，利用TCC实现余额扣减功能。&lt;/p>
&lt;h4 id="2声明tcc接口">
&lt;a href="#2%e5%a3%b0%e6%98%8etcc%e6%8e%a5%e5%8f%a3" class="header-anchor">#&lt;/a>
2）声明TCC接口
&lt;/h4>&lt;p>TCC的Try、Confirm、Cancel方法都需要在接口中基于注解来声明，&lt;/p>
&lt;p>我们在account-service项目中的&lt;code>cn.itcast.account.service&lt;/code>包中新建一个接口，声明TCC三个接口：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-6">&lt;a class="lnlinks" href="#hl-8-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-7">&lt;a class="lnlinks" href="#hl-8-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-8">&lt;a class="lnlinks" href="#hl-8-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-9">&lt;a class="lnlinks" href="#hl-8-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-10">&lt;a class="lnlinks" href="#hl-8-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-11">&lt;a class="lnlinks" href="#hl-8-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-12">&lt;a class="lnlinks" href="#hl-8-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-13">&lt;a class="lnlinks" href="#hl-8-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-14">&lt;a class="lnlinks" href="#hl-8-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-15">&lt;a class="lnlinks" href="#hl-8-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-16">&lt;a class="lnlinks" href="#hl-8-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-17">&lt;a class="lnlinks" href="#hl-8-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-18">&lt;a class="lnlinks" href="#hl-8-18">18&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.account.service&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">io.seata.rm.tcc.api.BusinessActionContext&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">io.seata.rm.tcc.api.BusinessActionContextParameter&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">io.seata.rm.tcc.api.LocalTCC&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">io.seata.rm.tcc.api.TwoPhaseBusinessAction&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@LocalTCC&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">interface&lt;/span> &lt;span class="nc">AccountTCCService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@TwoPhaseBusinessAction&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;deduct&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">commitMethod&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;confirm&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rollbackMethod&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;cancel&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">deduct&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nd">@BusinessActionContextParameter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">paramName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;userId&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">userId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@BusinessActionContextParameter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">paramName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;money&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">money&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">confirm&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BusinessActionContext&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">cancel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BusinessActionContext&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="3编写实现类">
&lt;a href="#3%e7%bc%96%e5%86%99%e5%ae%9e%e7%8e%b0%e7%b1%bb" class="header-anchor">#&lt;/a>
3）编写实现类
&lt;/h4>&lt;p>在account-service服务中的&lt;code>cn.itcast.account.service.impl&lt;/code>包下新建一个类，实现TCC业务：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-5">&lt;a class="lnlinks" href="#hl-9-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-6">&lt;a class="lnlinks" href="#hl-9-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-7">&lt;a class="lnlinks" href="#hl-9-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-8">&lt;a class="lnlinks" href="#hl-9-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-9">&lt;a class="lnlinks" href="#hl-9-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-10">&lt;a class="lnlinks" href="#hl-9-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-11">&lt;a class="lnlinks" href="#hl-9-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-12">&lt;a class="lnlinks" href="#hl-9-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-13">&lt;a class="lnlinks" href="#hl-9-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-14">&lt;a class="lnlinks" href="#hl-9-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-15">&lt;a class="lnlinks" href="#hl-9-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-16">&lt;a class="lnlinks" href="#hl-9-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-17">&lt;a class="lnlinks" href="#hl-9-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-18">&lt;a class="lnlinks" href="#hl-9-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-19">&lt;a class="lnlinks" href="#hl-9-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-20">&lt;a class="lnlinks" href="#hl-9-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-21">&lt;a class="lnlinks" href="#hl-9-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-22">&lt;a class="lnlinks" href="#hl-9-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-23">&lt;a class="lnlinks" href="#hl-9-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-24">&lt;a class="lnlinks" href="#hl-9-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-25">&lt;a class="lnlinks" href="#hl-9-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-26">&lt;a class="lnlinks" href="#hl-9-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-27">&lt;a class="lnlinks" href="#hl-9-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-28">&lt;a class="lnlinks" href="#hl-9-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-29">&lt;a class="lnlinks" href="#hl-9-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-30">&lt;a class="lnlinks" href="#hl-9-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-31">&lt;a class="lnlinks" href="#hl-9-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-32">&lt;a class="lnlinks" href="#hl-9-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-33">&lt;a class="lnlinks" href="#hl-9-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-34">&lt;a class="lnlinks" href="#hl-9-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-35">&lt;a class="lnlinks" href="#hl-9-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-36">&lt;a class="lnlinks" href="#hl-9-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-37">&lt;a class="lnlinks" href="#hl-9-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-38">&lt;a class="lnlinks" href="#hl-9-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-39">&lt;a class="lnlinks" href="#hl-9-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-40">&lt;a class="lnlinks" href="#hl-9-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-41">&lt;a class="lnlinks" href="#hl-9-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-42">&lt;a class="lnlinks" href="#hl-9-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-43">&lt;a class="lnlinks" href="#hl-9-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-44">&lt;a class="lnlinks" href="#hl-9-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-45">&lt;a class="lnlinks" href="#hl-9-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-46">&lt;a class="lnlinks" href="#hl-9-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-47">&lt;a class="lnlinks" href="#hl-9-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-48">&lt;a class="lnlinks" href="#hl-9-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-49">&lt;a class="lnlinks" href="#hl-9-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-50">&lt;a class="lnlinks" href="#hl-9-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-51">&lt;a class="lnlinks" href="#hl-9-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-52">&lt;a class="lnlinks" href="#hl-9-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-53">&lt;a class="lnlinks" href="#hl-9-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-54">&lt;a class="lnlinks" href="#hl-9-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-55">&lt;a class="lnlinks" href="#hl-9-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-56">&lt;a class="lnlinks" href="#hl-9-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-57">&lt;a class="lnlinks" href="#hl-9-57">57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-58">&lt;a class="lnlinks" href="#hl-9-58">58&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-59">&lt;a class="lnlinks" href="#hl-9-59">59&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-60">&lt;a class="lnlinks" href="#hl-9-60">60&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-61">&lt;a class="lnlinks" href="#hl-9-61">61&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-62">&lt;a class="lnlinks" href="#hl-9-62">62&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.account.service.impl&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.account.entity.AccountFreeze&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.account.mapper.AccountFreezeMapper&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.account.mapper.AccountMapper&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">cn.itcast.account.service.AccountTCCService&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">io.seata.core.context.RootContext&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">io.seata.rm.tcc.api.BusinessActionContext&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">lombok.extern.slf4j.Slf4j&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.beans.factory.annotation.Autowired&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.stereotype.Service&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kn">import&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nn">org.springframework.transaction.annotation.Transactional&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nd">@Slf4j&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">class&lt;/span> &lt;span class="nc">AccountTCCServiceImpl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">implements&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AccountTCCService&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AccountMapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">accountMapper&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Autowired&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AccountFreezeMapper&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">freezeMapper&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Transactional&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">deduct&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">userId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">money&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 0.获取事务id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RootContext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getXID&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.扣减可用余额&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">accountMapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">deduct&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">userId&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">money&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.记录冻结金额，事务状态&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">AccountFreeze&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">freeze&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AccountFreeze&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">freeze&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setUserId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">userId&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">freeze&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setFreezeMoney&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">money&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">freeze&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setState&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AccountFreeze&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">TRY&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">freeze&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setXid&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">freezeMapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">freeze&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">confirm&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BusinessActionContext&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.获取事务id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getXid&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.根据id删除冻结记录&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">freezeMapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">deleteById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">cancel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BusinessActionContext&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 0.查询冻结记录&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getXid&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">AccountFreeze&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">freeze&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">freezeMapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">selectById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 1.恢复可用余额&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">accountMapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">refund&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">freeze&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getUserId&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">freeze&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">getFreezeMoney&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 2.将冻结金额清零，状态改为CANCEL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">freeze&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setFreezeMoney&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">freeze&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">setState&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AccountFreeze&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">State&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">CANCEL&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">freezeMapper&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">updateById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">freeze&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="44saga模式">
&lt;a href="#44saga%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
4.4.SAGA模式
&lt;/h2>&lt;p>Saga 模式是 Seata 即将开源的长事务解决方案，将由蚂蚁金服主要贡献。&lt;/p>
&lt;p>其理论基础是Hector &amp;amp; Kenneth 在1987年发表的论文&lt;a class="link" href="https://microservices.io/patterns/data/saga.html" target="_blank" rel="noopener"
>Sagas
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>。&lt;/p>
&lt;p>Seata官网对于Saga的指南：https://seata.io/zh-cn/docs/user/saga.html&lt;/p>
&lt;h3 id="441原理">
&lt;a href="#441%e5%8e%9f%e7%90%86" class="header-anchor">#&lt;/a>
4.4.1.原理
&lt;/h3>&lt;p>在 Saga 模式下，分布式事务内有多个参与者，每一个参与者都是一个冲正补偿服务，需要用户根据业务场景实现其正向操作和逆向回滚操作。&lt;/p>
&lt;p>分布式事务执行过程中，依次执行各参与者的正向操作，如果所有正向操作均执行成功，那么分布式事务提交。如果任何一个正向操作执行失败，那么分布式事务会去退回去执行前面各参与者的逆向回滚操作，回滚已提交的参与者，使分布式事务回到初始状态。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-d4427f33de8eee.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724184846396"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>Saga也分为两个阶段：&lt;/p>
&lt;ul>
&lt;li>一阶段：直接提交本地事务&lt;/li>
&lt;li>二阶段：成功则什么都不做；失败则通过编写补偿业务来回滚&lt;/li>
&lt;/ul>
&lt;h3 id="442优缺点">
&lt;a href="#442%e4%bc%98%e7%bc%ba%e7%82%b9" class="header-anchor">#&lt;/a>
4.4.2.优缺点
&lt;/h3>&lt;p>优点：&lt;/p>
&lt;ul>
&lt;li>事务参与者可以基于事件驱动实现异步调用，吞吐高&lt;/li>
&lt;li>一阶段直接提交事务，无锁，性能好&lt;/li>
&lt;li>不用编写TCC中的三个阶段，实现简单&lt;/li>
&lt;/ul>
&lt;p>缺点：&lt;/p>
&lt;ul>
&lt;li>软状态持续时间不确定，时效性差&lt;/li>
&lt;li>没有锁，没有事务隔离，会有脏写&lt;/li>
&lt;/ul>
&lt;h2 id="45四种模式对比">
&lt;a href="#45%e5%9b%9b%e7%a7%8d%e6%a8%a1%e5%bc%8f%e5%af%b9%e6%af%94" class="header-anchor">#&lt;/a>
4.5.四种模式对比
&lt;/h2>&lt;p>我们从以下几个方面来对比四种实现：&lt;/p>
&lt;ul>
&lt;li>一致性：能否保证事务的一致性？强一致还是最终一致？&lt;/li>
&lt;li>隔离性：事务之间的隔离性如何？&lt;/li>
&lt;li>代码侵入：是否需要对业务代码改造？&lt;/li>
&lt;li>性能：有无性能损耗？&lt;/li>
&lt;li>场景：常见的业务场景&lt;/li>
&lt;/ul>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-eb7f9f78aaf46c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724185021819"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="5高可用">
&lt;a href="#5%e9%ab%98%e5%8f%af%e7%94%a8" class="header-anchor">#&lt;/a>
5.高可用
&lt;/h1>&lt;p>Seata的TC服务作为分布式事务核心，一定要保证集群的高可用性。&lt;/p>
&lt;h2 id="51高可用架构模型">
&lt;a href="#51%e9%ab%98%e5%8f%af%e7%94%a8%e6%9e%b6%e6%9e%84%e6%a8%a1%e5%9e%8b" class="header-anchor">#&lt;/a>
5.1.高可用架构模型
&lt;/h2>&lt;p>搭建TC服务集群非常简单，启动多个TC服务，注册到nacos即可。&lt;/p>
&lt;p>但集群并不能确保100%安全，万一集群所在机房故障怎么办？所以如果要求较高，一般都会做异地多机房容灾。&lt;/p>
&lt;p>比如一个TC集群在上海，另一个TC集群在杭州：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-17a511f737351d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724185240957"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>微服务基于事务组（tx-service-group)与TC集群的映射关系，来查找当前应该使用哪个TC集群。当SH集群故障时，只需要将vgroup-mapping中的映射关系改成HZ。则所有微服务就会切换到HZ的TC集群了。&lt;/p>
&lt;h2 id="52实现高可用">
&lt;a href="#52%e5%ae%9e%e7%8e%b0%e9%ab%98%e5%8f%af%e7%94%a8" class="header-anchor">#&lt;/a>
5.2.实现高可用
&lt;/h2>&lt;p>具体实现请参考课前资料提供的文档《seata的部署和集成.md》：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-883cd38b8fef94.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724172549013"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>第三章节：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653738637-9742a4ed751dba.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210724185638729"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p></description></item><item><title>Jmeter快速入门</title><link>https://logan.wssw.fun/p/2023/01/11783511/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/11783511/</guid><description>&lt;h1 id="jmeter快速入门">
&lt;a href="#jmeter%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8" class="header-anchor">#&lt;/a>
Jmeter快速入门
&lt;/h1>&lt;h1 id="1安装jmeter">
&lt;a href="#1%e5%ae%89%e8%a3%85jmeter" class="header-anchor">#&lt;/a>
1.安装Jmeter
&lt;/h1>&lt;p>Jmeter依赖于JDK，所以必须确保当前计算机上已经安装了JDK，并且配置了环境变量。&lt;/p>
&lt;h2 id="11下载">
&lt;a href="#11%e4%b8%8b%e8%bd%bd" class="header-anchor">#&lt;/a>
1.1.下载
&lt;/h2>&lt;p>可以Apache Jmeter官网下载，地址：http://jmeter.apache.org/download_jmeter.cgi&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-6c5ee1c7adad00.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715193149837"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>当然，我们课前资料也提供了下载好的安装包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-98eafffc0b17e9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715193224094"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="12解压">
&lt;a href="#12%e8%a7%a3%e5%8e%8b" class="header-anchor">#&lt;/a>
1.2.解压
&lt;/h2>&lt;p>因为下载的是zip包，解压缩即可使用，目录结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-6e33ee87bce824.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715193334367"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中的bin目录就是执行的脚本，其中包含启动脚本：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-4e6998eb19a969.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715193414601"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="13运行">
&lt;a href="#13%e8%bf%90%e8%a1%8c" class="header-anchor">#&lt;/a>
1.3.运行
&lt;/h3>&lt;p>双击即可运行，但是有两点注意：&lt;/p>
&lt;ul>
&lt;li>启动速度比较慢，要耐心等待&lt;/li>
&lt;li>启动后黑窗口不能关闭，否则Jmeter也跟着关闭了&lt;/li>
&lt;/ul>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-81e2418fc1b2a4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715193730096"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="2快速入门">
&lt;a href="#2%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8" class="header-anchor">#&lt;/a>
2.快速入门
&lt;/h1>&lt;h2 id="21设置中文语言">
&lt;a href="#21%e8%ae%be%e7%bd%ae%e4%b8%ad%e6%96%87%e8%af%ad%e8%a8%80" class="header-anchor">#&lt;/a>
2.1.设置中文语言
&lt;/h2>&lt;p>默认Jmeter的语言是英文，需要设置：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-c051afbe874669.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715193838719"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>效果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-98f7a3c9929e25.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715193914039"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>注意&lt;/strong>：上面的配置只能保证本次运行是中文，如果要永久中文，需要修改Jmeter的配置文件&lt;/p>
&lt;/blockquote>
&lt;p>打开jmeter文件夹，在bin目录中找到 &lt;strong>jmeter.properties&lt;/strong>，添加下面配置：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="na">language&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">zh_CN&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-a744bfe7b41f24.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715194137982"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;blockquote>
&lt;p>注意：前面不要出现#，#代表注释，另外这里是下划线，不是中划线&lt;/p>
&lt;/blockquote>
&lt;h2 id="22基本用法">
&lt;a href="#22%e5%9f%ba%e6%9c%ac%e7%94%a8%e6%b3%95" class="header-anchor">#&lt;/a>
2.2.基本用法
&lt;/h2>&lt;p>在测试计划上点鼠标右键，选择添加 &amp;gt; 线程（用户） &amp;gt; 线程组：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-83730445eb688c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715194413178"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在新增的线程组中，填写线程信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-a1882ee03976b3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715195053807"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>给线程组点鼠标右键，添加http取样器：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-552650ee585177.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715195144130"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>编写取样器内容：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-6eaf83842f4da4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715195410764"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>添加监听报告：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-f0dbc4e471ce2c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715195844978"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>添加监听结果树：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-bccecef4f9325c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715200155537"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>汇总报告结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-9cdadb2ce1cfb5.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715200243194"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>结果树：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739882-5206f09e8a6ccf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210715200336526"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p></description></item><item><title>Nacos安装指南</title><link>https://logan.wssw.fun/p/2023/01/38z56138/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/38z56138/</guid><description>&lt;h1 id="nacos安装指南">
&lt;a href="#nacos%e5%ae%89%e8%a3%85%e6%8c%87%e5%8d%97" class="header-anchor">#&lt;/a>
Nacos安装指南
&lt;/h1>&lt;h1 id="1windows安装">
&lt;a href="#1windows%e5%ae%89%e8%a3%85" class="header-anchor">#&lt;/a>
1.Windows安装
&lt;/h1>&lt;p>开发阶段采用单机安装即可。&lt;/p>
&lt;h2 id="11下载安装包">
&lt;a href="#11%e4%b8%8b%e8%bd%bd%e5%ae%89%e8%a3%85%e5%8c%85" class="header-anchor">#&lt;/a>
1.1.下载安装包
&lt;/h2>&lt;p>在Nacos的GitHub页面，提供有下载链接，可以下载编译好的Nacos服务端或者源代码：&lt;/p>
&lt;p>GitHub主页：https://github.com/alibaba/nacos&lt;/p>
&lt;p>GitHub的Release下载页：https://github.com/alibaba/nacos/releases&lt;/p>
&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-827280425f9c77.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402161102887"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>本课程采用1.4.1.版本的Nacos，课前资料已经准备了安装包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-677d33d82668d7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402161130261"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>windows版本使用&lt;code>nacos-server-1.4.1.zip&lt;/code>包即可。&lt;/p>
&lt;h2 id="12解压">
&lt;a href="#12%e8%a7%a3%e5%8e%8b" class="header-anchor">#&lt;/a>
1.2.解压
&lt;/h2>&lt;p>将这个包解压到任意非中文目录下，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-7df68d4af2fb3a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402161843337"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>目录说明：&lt;/p>
&lt;ul>
&lt;li>bin：启动脚本&lt;/li>
&lt;li>conf：配置文件&lt;/li>
&lt;/ul>
&lt;h2 id="13端口配置">
&lt;a href="#13%e7%ab%af%e5%8f%a3%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
1.3.端口配置
&lt;/h2>&lt;p>Nacos的默认端口是8848，如果你电脑上的其它进程占用了8848端口，请先尝试关闭该进程。&lt;/p>
&lt;p>&lt;strong>如果无法关闭占用8848端口的进程&lt;/strong>，也可以进入nacos的conf目录，修改配置文件中的端口：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-2823088b827a4e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402162008280"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>修改其中的内容：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-4d4241a3f20ebf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402162251093"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="14启动">
&lt;a href="#14%e5%90%af%e5%8a%a8" class="header-anchor">#&lt;/a>
1.4.启动
&lt;/h2>&lt;p>启动非常简单，进入bin目录，结构如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-b09e2213451d80.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402162350977"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后执行命令即可：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>windows命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">startup.cmd -m standalone
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;p>执行后的效果如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-c2765f479ac071.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402162526774"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="15访问">
&lt;a href="#15%e8%ae%bf%e9%97%ae" class="header-anchor">#&lt;/a>
1.5.访问
&lt;/h2>&lt;p>在浏览器输入地址：http://127.0.0.1:8848/nacos即可：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-539b1b126a2b55.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402162630427"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>默认的账号和密码都是nacos，进入后：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-62e46fb8d183a3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402162709515"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="2linux安装">
&lt;a href="#2linux%e5%ae%89%e8%a3%85" class="header-anchor">#&lt;/a>
2.Linux安装
&lt;/h1>&lt;p>Linux或者Mac安装方式与Windows类似。&lt;/p>
&lt;h2 id="21安装jdk">
&lt;a href="#21%e5%ae%89%e8%a3%85jdk" class="header-anchor">#&lt;/a>
2.1.安装JDK
&lt;/h2>&lt;p>Nacos依赖于JDK运行，索引Linux上也需要安装JDK才行。&lt;/p>
&lt;p>上传jdk安装包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-aa1e2546874823.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402172334810"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>上传到某个目录，例如：&lt;code>/usr/local/&lt;/code>&lt;/p>
&lt;p>然后解压缩：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">tar -xvf jdk-8u144-linux-x64.tar.gz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后重命名为java&lt;/p>
&lt;p>配置环境变量：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">JAVA_HOME&lt;/span>&lt;span class="o">=&lt;/span>/usr/local/java
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$PATH&lt;/span>:&lt;span class="nv">$JAVA_HOME&lt;/span>/bin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>设置环境变量：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">source&lt;/span> /etc/profile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="22上传安装包">
&lt;a href="#22%e4%b8%8a%e4%bc%a0%e5%ae%89%e8%a3%85%e5%8c%85" class="header-anchor">#&lt;/a>
2.2.上传安装包
&lt;/h2>&lt;p>如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-827280425f9c77.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402161102887"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>也可以直接使用课前资料中的tar.gz：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-677d33d82668d7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402161130261"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>上传到Linux服务器的某个目录，例如&lt;code>/usr/local/src&lt;/code>目录下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-5b373973a16c60.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402163715580"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="23解压">
&lt;a href="#23%e8%a7%a3%e5%8e%8b" class="header-anchor">#&lt;/a>
2.3.解压
&lt;/h2>&lt;p>命令解压缩安装包：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">tar -xvf nacos-server-1.4.1.tar.gz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后删除安装包：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">rm -rf nacos-server-1.4.1.tar.gz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>目录中最终样式：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-daf7c4c88ae583.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402163858429"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>目录内部：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739263-974ea47973e1bb.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402164414827"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="24端口配置">
&lt;a href="#24%e7%ab%af%e5%8f%a3%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
2.4.端口配置
&lt;/h2>&lt;p>与windows中类似&lt;/p>
&lt;h2 id="25启动">
&lt;a href="#25%e5%90%af%e5%8a%a8" class="header-anchor">#&lt;/a>
2.5.启动
&lt;/h2>&lt;p>在nacos/bin目录中，输入命令启动Nacos：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">sh startup.sh -m standalone
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="3nacos的依赖">
&lt;a href="#3nacos%e7%9a%84%e4%be%9d%e8%b5%96" class="header-anchor">#&lt;/a>
3.Nacos的依赖
&lt;/h1>&lt;p>父工程：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.alibaba.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-alibaba-dependencies&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>2.2.5.RELEASE&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;type&amp;gt;&lt;/span>pom&lt;span class="nt">&amp;lt;/type&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;scope&amp;gt;&lt;/span>import&lt;span class="nt">&amp;lt;/scope&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>客户端：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!-- nacos客户端依赖包 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>com.alibaba.cloud&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>spring-cloud-starter-alibaba-nacos-discovery&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>nacos集群搭建</title><link>https://logan.wssw.fun/p/2023/01/956118f5/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/956118f5/</guid><description>&lt;h1 id="nacos集群搭建">
&lt;a href="#nacos%e9%9b%86%e7%be%a4%e6%90%ad%e5%bb%ba" class="header-anchor">#&lt;/a>
Nacos集群搭建
&lt;/h1>&lt;h1 id="1集群结构图">
&lt;a href="#1%e9%9b%86%e7%be%a4%e7%bb%93%e6%9e%84%e5%9b%be" class="header-anchor">#&lt;/a>
1.集群结构图
&lt;/h1>&lt;p>官方给出的Nacos集群图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739314-5139d15efd765a.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210409210621117"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>其中包含3个nacos节点，然后一个负载均衡器代理3个Nacos。这里负载均衡器可以使用nginx。&lt;/p>
&lt;p>我们计划的集群结构：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739314-35240f279ca3ef.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210409211355037"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>三个nacos节点的地址：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>节点&lt;/th>
&lt;th>ip&lt;/th>
&lt;th>port&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>nacos1&lt;/td>
&lt;td>192.168.150.1&lt;/td>
&lt;td>8845&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>nacos2&lt;/td>
&lt;td>192.168.150.1&lt;/td>
&lt;td>8846&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>nacos3&lt;/td>
&lt;td>192.168.150.1&lt;/td>
&lt;td>8847&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h1 id="2搭建集群">
&lt;a href="#2%e6%90%ad%e5%bb%ba%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
2.搭建集群
&lt;/h1>&lt;p>搭建集群的基本步骤：&lt;/p>
&lt;ul>
&lt;li>搭建数据库，初始化数据库表结构&lt;/li>
&lt;li>下载nacos安装包&lt;/li>
&lt;li>配置nacos&lt;/li>
&lt;li>启动nacos集群&lt;/li>
&lt;li>nginx反向代理&lt;/li>
&lt;/ul>
&lt;h2 id="21初始化数据库">
&lt;a href="#21%e5%88%9d%e5%a7%8b%e5%8c%96%e6%95%b0%e6%8d%ae%e5%ba%93" class="header-anchor">#&lt;/a>
2.1.初始化数据库
&lt;/h2>&lt;p>Nacos默认数据存储在内嵌数据库Derby中，不属于生产可用的数据库。&lt;/p>
&lt;p>官方推荐的最佳实践是使用带有主从的高可用数据库集群，主从模式的高可用数据库可以参考&lt;strong>传智教育&lt;/strong>的后续高手课程。&lt;/p>
&lt;p>这里我们以单点的数据库为例来讲解。&lt;/p>
&lt;p>首先新建一个数据库，命名为nacos，而后导入下面的SQL：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-6">&lt;a class="lnlinks" href="#hl-0-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-7">&lt;a class="lnlinks" href="#hl-0-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-8">&lt;a class="lnlinks" href="#hl-0-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-9">&lt;a class="lnlinks" href="#hl-0-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-10">&lt;a class="lnlinks" href="#hl-0-10"> 10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-11">&lt;a class="lnlinks" href="#hl-0-11"> 11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-12">&lt;a class="lnlinks" href="#hl-0-12"> 12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-13">&lt;a class="lnlinks" href="#hl-0-13"> 13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-14">&lt;a class="lnlinks" href="#hl-0-14"> 14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-15">&lt;a class="lnlinks" href="#hl-0-15"> 15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-16">&lt;a class="lnlinks" href="#hl-0-16"> 16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-17">&lt;a class="lnlinks" href="#hl-0-17"> 17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-18">&lt;a class="lnlinks" href="#hl-0-18"> 18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-19">&lt;a class="lnlinks" href="#hl-0-19"> 19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-20">&lt;a class="lnlinks" href="#hl-0-20"> 20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-21">&lt;a class="lnlinks" href="#hl-0-21"> 21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-22">&lt;a class="lnlinks" href="#hl-0-22"> 22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-23">&lt;a class="lnlinks" href="#hl-0-23"> 23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-24">&lt;a class="lnlinks" href="#hl-0-24"> 24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-25">&lt;a class="lnlinks" href="#hl-0-25"> 25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-26">&lt;a class="lnlinks" href="#hl-0-26"> 26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-27">&lt;a class="lnlinks" href="#hl-0-27"> 27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-28">&lt;a class="lnlinks" href="#hl-0-28"> 28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-29">&lt;a class="lnlinks" href="#hl-0-29"> 29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-30">&lt;a class="lnlinks" href="#hl-0-30"> 30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-31">&lt;a class="lnlinks" href="#hl-0-31"> 31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-32">&lt;a class="lnlinks" href="#hl-0-32"> 32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-33">&lt;a class="lnlinks" href="#hl-0-33"> 33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-34">&lt;a class="lnlinks" href="#hl-0-34"> 34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-35">&lt;a class="lnlinks" href="#hl-0-35"> 35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-36">&lt;a class="lnlinks" href="#hl-0-36"> 36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-37">&lt;a class="lnlinks" href="#hl-0-37"> 37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-38">&lt;a class="lnlinks" href="#hl-0-38"> 38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-39">&lt;a class="lnlinks" href="#hl-0-39"> 39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-40">&lt;a class="lnlinks" href="#hl-0-40"> 40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-41">&lt;a class="lnlinks" href="#hl-0-41"> 41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-42">&lt;a class="lnlinks" href="#hl-0-42"> 42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-43">&lt;a class="lnlinks" href="#hl-0-43"> 43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-44">&lt;a class="lnlinks" href="#hl-0-44"> 44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-45">&lt;a class="lnlinks" href="#hl-0-45"> 45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-46">&lt;a class="lnlinks" href="#hl-0-46"> 46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-47">&lt;a class="lnlinks" href="#hl-0-47"> 47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-48">&lt;a class="lnlinks" href="#hl-0-48"> 48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-49">&lt;a class="lnlinks" href="#hl-0-49"> 49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-50">&lt;a class="lnlinks" href="#hl-0-50"> 50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-51">&lt;a class="lnlinks" href="#hl-0-51"> 51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-52">&lt;a class="lnlinks" href="#hl-0-52"> 52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-53">&lt;a class="lnlinks" href="#hl-0-53"> 53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-54">&lt;a class="lnlinks" href="#hl-0-54"> 54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-55">&lt;a class="lnlinks" href="#hl-0-55"> 55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-56">&lt;a class="lnlinks" href="#hl-0-56"> 56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-57">&lt;a class="lnlinks" href="#hl-0-57"> 57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-58">&lt;a class="lnlinks" href="#hl-0-58"> 58&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-59">&lt;a class="lnlinks" href="#hl-0-59"> 59&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-60">&lt;a class="lnlinks" href="#hl-0-60"> 60&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-61">&lt;a class="lnlinks" href="#hl-0-61"> 61&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-62">&lt;a class="lnlinks" href="#hl-0-62"> 62&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-63">&lt;a class="lnlinks" href="#hl-0-63"> 63&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-64">&lt;a class="lnlinks" href="#hl-0-64"> 64&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-65">&lt;a class="lnlinks" href="#hl-0-65"> 65&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-66">&lt;a class="lnlinks" href="#hl-0-66"> 66&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-67">&lt;a class="lnlinks" href="#hl-0-67"> 67&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-68">&lt;a class="lnlinks" href="#hl-0-68"> 68&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-69">&lt;a class="lnlinks" href="#hl-0-69"> 69&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-70">&lt;a class="lnlinks" href="#hl-0-70"> 70&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-71">&lt;a class="lnlinks" href="#hl-0-71"> 71&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-72">&lt;a class="lnlinks" href="#hl-0-72"> 72&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-73">&lt;a class="lnlinks" href="#hl-0-73"> 73&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-74">&lt;a class="lnlinks" href="#hl-0-74"> 74&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-75">&lt;a class="lnlinks" href="#hl-0-75"> 75&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-76">&lt;a class="lnlinks" href="#hl-0-76"> 76&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-77">&lt;a class="lnlinks" href="#hl-0-77"> 77&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-78">&lt;a class="lnlinks" href="#hl-0-78"> 78&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-79">&lt;a class="lnlinks" href="#hl-0-79"> 79&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-80">&lt;a class="lnlinks" href="#hl-0-80"> 80&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-81">&lt;a class="lnlinks" href="#hl-0-81"> 81&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-82">&lt;a class="lnlinks" href="#hl-0-82"> 82&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-83">&lt;a class="lnlinks" href="#hl-0-83"> 83&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-84">&lt;a class="lnlinks" href="#hl-0-84"> 84&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-85">&lt;a class="lnlinks" href="#hl-0-85"> 85&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-86">&lt;a class="lnlinks" href="#hl-0-86"> 86&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-87">&lt;a class="lnlinks" href="#hl-0-87"> 87&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-88">&lt;a class="lnlinks" href="#hl-0-88"> 88&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-89">&lt;a class="lnlinks" href="#hl-0-89"> 89&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-90">&lt;a class="lnlinks" href="#hl-0-90"> 90&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-91">&lt;a class="lnlinks" href="#hl-0-91"> 91&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-92">&lt;a class="lnlinks" href="#hl-0-92"> 92&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-93">&lt;a class="lnlinks" href="#hl-0-93"> 93&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-94">&lt;a class="lnlinks" href="#hl-0-94"> 94&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-95">&lt;a class="lnlinks" href="#hl-0-95"> 95&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-96">&lt;a class="lnlinks" href="#hl-0-96"> 96&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-97">&lt;a class="lnlinks" href="#hl-0-97"> 97&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-98">&lt;a class="lnlinks" href="#hl-0-98"> 98&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-99">&lt;a class="lnlinks" href="#hl-0-99"> 99&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-100">&lt;a class="lnlinks" href="#hl-0-100">100&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-101">&lt;a class="lnlinks" href="#hl-0-101">101&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-102">&lt;a class="lnlinks" href="#hl-0-102">102&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-103">&lt;a class="lnlinks" href="#hl-0-103">103&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-104">&lt;a class="lnlinks" href="#hl-0-104">104&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-105">&lt;a class="lnlinks" href="#hl-0-105">105&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-106">&lt;a class="lnlinks" href="#hl-0-106">106&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-107">&lt;a class="lnlinks" href="#hl-0-107">107&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-108">&lt;a class="lnlinks" href="#hl-0-108">108&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-109">&lt;a class="lnlinks" href="#hl-0-109">109&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-110">&lt;a class="lnlinks" href="#hl-0-110">110&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-111">&lt;a class="lnlinks" href="#hl-0-111">111&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-112">&lt;a class="lnlinks" href="#hl-0-112">112&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-113">&lt;a class="lnlinks" href="#hl-0-113">113&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-114">&lt;a class="lnlinks" href="#hl-0-114">114&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-115">&lt;a class="lnlinks" href="#hl-0-115">115&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-116">&lt;a class="lnlinks" href="#hl-0-116">116&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-117">&lt;a class="lnlinks" href="#hl-0-117">117&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-118">&lt;a class="lnlinks" href="#hl-0-118">118&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-119">&lt;a class="lnlinks" href="#hl-0-119">119&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-120">&lt;a class="lnlinks" href="#hl-0-120">120&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-121">&lt;a class="lnlinks" href="#hl-0-121">121&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-122">&lt;a class="lnlinks" href="#hl-0-122">122&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-123">&lt;a class="lnlinks" href="#hl-0-123">123&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-124">&lt;a class="lnlinks" href="#hl-0-124">124&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-125">&lt;a class="lnlinks" href="#hl-0-125">125&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-126">&lt;a class="lnlinks" href="#hl-0-126">126&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-127">&lt;a class="lnlinks" href="#hl-0-127">127&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-128">&lt;a class="lnlinks" href="#hl-0-128">128&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-129">&lt;a class="lnlinks" href="#hl-0-129">129&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-130">&lt;a class="lnlinks" href="#hl-0-130">130&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-131">&lt;a class="lnlinks" href="#hl-0-131">131&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-132">&lt;a class="lnlinks" href="#hl-0-132">132&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-133">&lt;a class="lnlinks" href="#hl-0-133">133&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-134">&lt;a class="lnlinks" href="#hl-0-134">134&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-135">&lt;a class="lnlinks" href="#hl-0-135">135&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-136">&lt;a class="lnlinks" href="#hl-0-136">136&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-137">&lt;a class="lnlinks" href="#hl-0-137">137&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-138">&lt;a class="lnlinks" href="#hl-0-138">138&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-139">&lt;a class="lnlinks" href="#hl-0-139">139&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-140">&lt;a class="lnlinks" href="#hl-0-140">140&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-141">&lt;a class="lnlinks" href="#hl-0-141">141&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-142">&lt;a class="lnlinks" href="#hl-0-142">142&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-143">&lt;a class="lnlinks" href="#hl-0-143">143&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-144">&lt;a class="lnlinks" href="#hl-0-144">144&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-145">&lt;a class="lnlinks" href="#hl-0-145">145&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-146">&lt;a class="lnlinks" href="#hl-0-146">146&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-147">&lt;a class="lnlinks" href="#hl-0-147">147&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-148">&lt;a class="lnlinks" href="#hl-0-148">148&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-149">&lt;a class="lnlinks" href="#hl-0-149">149&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-150">&lt;a class="lnlinks" href="#hl-0-150">150&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-151">&lt;a class="lnlinks" href="#hl-0-151">151&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-152">&lt;a class="lnlinks" href="#hl-0-152">152&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-153">&lt;a class="lnlinks" href="#hl-0-153">153&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-154">&lt;a class="lnlinks" href="#hl-0-154">154&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-155">&lt;a class="lnlinks" href="#hl-0-155">155&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-156">&lt;a class="lnlinks" href="#hl-0-156">156&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-157">&lt;a class="lnlinks" href="#hl-0-157">157&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-158">&lt;a class="lnlinks" href="#hl-0-158">158&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-159">&lt;a class="lnlinks" href="#hl-0-159">159&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-160">&lt;a class="lnlinks" href="#hl-0-160">160&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-161">&lt;a class="lnlinks" href="#hl-0-161">161&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-162">&lt;a class="lnlinks" href="#hl-0-162">162&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-163">&lt;a class="lnlinks" href="#hl-0-163">163&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-164">&lt;a class="lnlinks" href="#hl-0-164">164&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-165">&lt;a class="lnlinks" href="#hl-0-165">165&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-166">&lt;a class="lnlinks" href="#hl-0-166">166&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-167">&lt;a class="lnlinks" href="#hl-0-167">167&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-168">&lt;a class="lnlinks" href="#hl-0-168">168&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-169">&lt;a class="lnlinks" href="#hl-0-169">169&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-170">&lt;a class="lnlinks" href="#hl-0-170">170&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-171">&lt;a class="lnlinks" href="#hl-0-171">171&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-172">&lt;a class="lnlinks" href="#hl-0-172">172&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-173">&lt;a class="lnlinks" href="#hl-0-173">173&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-174">&lt;a class="lnlinks" href="#hl-0-174">174&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-175">&lt;a class="lnlinks" href="#hl-0-175">175&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-176">&lt;a class="lnlinks" href="#hl-0-176">176&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-177">&lt;a class="lnlinks" href="#hl-0-177">177&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-178">&lt;a class="lnlinks" href="#hl-0-178">178&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-179">&lt;a class="lnlinks" href="#hl-0-179">179&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-180">&lt;a class="lnlinks" href="#hl-0-180">180&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-181">&lt;a class="lnlinks" href="#hl-0-181">181&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-182">&lt;a class="lnlinks" href="#hl-0-182">182&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-183">&lt;a class="lnlinks" href="#hl-0-183">183&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-184">&lt;a class="lnlinks" href="#hl-0-184">184&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-185">&lt;a class="lnlinks" href="#hl-0-185">185&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-186">&lt;a class="lnlinks" href="#hl-0-186">186&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-187">&lt;a class="lnlinks" href="#hl-0-187">187&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-188">&lt;a class="lnlinks" href="#hl-0-188">188&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-189">&lt;a class="lnlinks" href="#hl-0-189">189&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-190">&lt;a class="lnlinks" href="#hl-0-190">190&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-191">&lt;a class="lnlinks" href="#hl-0-191">191&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-192">&lt;a class="lnlinks" href="#hl-0-192">192&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-193">&lt;a class="lnlinks" href="#hl-0-193">193&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-194">&lt;a class="lnlinks" href="#hl-0-194">194&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-195">&lt;a class="lnlinks" href="#hl-0-195">195&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-196">&lt;a class="lnlinks" href="#hl-0-196">196&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-197">&lt;a class="lnlinks" href="#hl-0-197">197&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-0-198">&lt;a class="lnlinks" href="#hl-0-198">198&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">config_info&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">data_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;data_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">longtext&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;content&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">md5&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;md5&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_create&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;创建时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;修改时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">src_user&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">text&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;source user&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">src_ip&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;source ip&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">app_name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;租户字段&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">c_desc&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">256&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">c_use&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">64&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">effect&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">64&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="k">type&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">64&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">c_schema&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">text&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">UNIQUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">uk_configinfo_datagrouptenant&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">data_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8_bin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;config_info&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 数据库全名 = nacos_config */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 表名称 = config_info_aggr */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">config_info_aggr&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">data_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;data_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;group_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">datum_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;datum_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">longtext&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;内容&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;修改时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">app_name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;租户字段&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">UNIQUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">uk_configinfoaggr_datagrouptenantdatum&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">data_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">datum_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8_bin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;增加租户字段&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 数据库全名 = nacos_config */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 表名称 = config_info_beta */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">config_info_beta&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">data_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;data_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;group_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">app_name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;app_name&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">longtext&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;content&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">beta_ips&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1024&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;betaIps&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">md5&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;md5&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_create&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;创建时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;修改时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">src_user&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">text&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;source user&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">src_ip&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;source ip&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;租户字段&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">UNIQUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">uk_configinfobeta_datagrouptenant&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">data_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8_bin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;config_info_beta&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 数据库全名 = nacos_config */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 表名称 = config_info_tag */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">config_info_tag&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">data_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;data_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;group_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;tenant_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tag_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;tag_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">app_name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;app_name&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">longtext&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;content&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">md5&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;md5&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_create&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;创建时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;修改时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">src_user&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">text&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;source user&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">src_ip&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;source ip&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">UNIQUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">uk_configinfotag_datagrouptenanttag&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">data_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tag_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8_bin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;config_info_tag&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 数据库全名 = nacos_config */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 表名称 = config_tags_relation */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">config_tags_relation&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tag_name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;tag_name&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tag_type&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">64&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;tag_type&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">data_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;data_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;group_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;tenant_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">nid&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">nid&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">UNIQUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">uk_configtagrelation_configidtag&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tag_name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tag_type&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">idx_tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8_bin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;config_tag_relation&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 数据库全名 = nacos_config */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 表名称 = group_capacity */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_capacity&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;主键ID&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;Group ID，空字符表示整个集群&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">quota&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;配额，0表示使用默认值&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="k">usage&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;使用量&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">max_size&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;单个配置大小上限，单位为字节，0表示使用默认值&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">max_aggr_count&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;聚合子配置最大个数，，0表示使用默认值&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">max_aggr_size&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">max_history_count&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;最大变更历史数量&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_create&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;创建时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;修改时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">UNIQUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">uk_group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8_bin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;集群、各Group容量信息表&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 数据库全名 = nacos_config */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 表名称 = his_config_info */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">his_config_info&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">64&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">nid&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">data_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">group_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">app_name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;app_name&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">longtext&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">md5&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_create&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">src_user&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">text&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">src_ip&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">op_type&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">char&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;租户字段&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">nid&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">idx_gmt_create&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_create&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">idx_gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">idx_did&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">data_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8_bin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;多租户改造&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 数据库全名 = nacos_config */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 表名称 = tenant_capacity */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/******************************************/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_capacity&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;主键ID&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;Tenant ID&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">quota&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;配额，0表示使用默认值&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="k">usage&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;使用量&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">max_size&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;单个配置大小上限，单位为字节，0表示使用默认值&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">max_aggr_count&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;聚合子配置最大个数&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">max_aggr_size&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">max_history_count&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">unsigned&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;最大变更历史数量&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_create&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;创建时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CURRENT_TIMESTAMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;修改时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">UNIQUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">uk_tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8_bin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;租户容量信息表&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_info&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">AUTO_INCREMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">kp&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;kp&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">default&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;tenant_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">default&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;tenant_name&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_desc&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">256&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;tenant_desc&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">create_source&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;create_source&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_create&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;创建时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">gmt_modified&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">bigint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;修改时间&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">UNIQUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">uk_tenant_info_kptenantid&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">kp&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">idx_tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">tenant_id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CHARSET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COLLATE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">utf8_bin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COMMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;tenant_info&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">password&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">enabled&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">boolean&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">roles&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="k">role&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">UNIQUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INDEX&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">idx_user_role&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ASC&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="k">role&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ASC&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">USING&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BTREE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">permissions&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="k">role&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">UNIQUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INDEX&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">uk_role_permission&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="k">role&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">USING&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BTREE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">password&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">enabled&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;nacos&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TRUE&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">roles&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">role&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;nacos&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;ROLE_ADMIN&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="22下载nacos">
&lt;a href="#22%e4%b8%8b%e8%bd%bdnacos" class="header-anchor">#&lt;/a>
2.2.下载nacos
&lt;/h2>&lt;p>nacos在GitHub上有下载地址：https://github.com/alibaba/nacos/tags，可以选择任意版本下载。&lt;/p>
&lt;p>本例中才用1.4.1版本：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739314-de06e5253098d4.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210409212119411"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="23配置nacos">
&lt;a href="#23%e9%85%8d%e7%bd%aenacos" class="header-anchor">#&lt;/a>
2.3.配置Nacos
&lt;/h2>&lt;p>将这个包解压到任意非中文目录下，如图：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739314-ce738fb7393fd9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210402161843337"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>目录说明：&lt;/p>
&lt;ul>
&lt;li>bin：启动脚本&lt;/li>
&lt;li>conf：配置文件&lt;/li>
&lt;/ul>
&lt;p>进入nacos的conf目录，修改配置文件cluster.conf.example，重命名为cluster.conf：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739314-79c1dbeff4cbe7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210409212459292"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后添加内容：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">127.0.0.1:8845
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.0.1.8846
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.0.1.8847
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后修改application.properties文件，添加数据库配置&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="na">spring.datasource.platform&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">mysql&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">db.num&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">db.url.0&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;amp;connectTimeout=1000&amp;amp;socketTimeout=3000&amp;amp;autoReconnect=true&amp;amp;useUnicode=true&amp;amp;useSSL=false&amp;amp;serverTimezone=UTC&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">db.user.0&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">root&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">db.password.0&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">123&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="24启动">
&lt;a href="#24%e5%90%af%e5%8a%a8" class="header-anchor">#&lt;/a>
2.4.启动
&lt;/h2>&lt;p>将nacos文件夹复制三份，分别命名为：nacos1、nacos2、nacos3&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739314-7a5522d9c231ed.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210409213335538"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后分别修改三个文件夹中的application.properties，&lt;/p>
&lt;p>nacos1:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="na">server.port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">8845&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>nacos2:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="na">server.port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">8846&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>nacos3:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="na">server.port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">8847&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后分别启动三个nacos节点：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">startup.cmd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="25nginx反向代理">
&lt;a href="#25nginx%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86" class="header-anchor">#&lt;/a>
2.5.nginx反向代理
&lt;/h2>&lt;p>找到课前资料提供的nginx安装包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739314-767ef0ea2e4110.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210410103253355"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解压到任意非中文目录下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739314-58d89f8ddc123e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210410103322874"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>修改conf/nginx.conf文件，配置如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-8">&lt;a class="lnlinks" href="#hl-7-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-9">&lt;a class="lnlinks" href="#hl-7-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-10">&lt;a class="lnlinks" href="#hl-7-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-11">&lt;a class="lnlinks" href="#hl-7-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-12">&lt;a class="lnlinks" href="#hl-7-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-13">&lt;a class="lnlinks" href="#hl-7-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-14">&lt;a class="lnlinks" href="#hl-7-14">14&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">upstream&lt;/span> &lt;span class="s">nacos-cluster&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">127.0.0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8845&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">127.0.0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8846&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">127.0.0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8847&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">80&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">localhost&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/nacos&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://nacos-cluster&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>而后在浏览器访问：http://localhost/nacos即可。&lt;/p>
&lt;p>代码中application.yml文件配置如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">spring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloud&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nacos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server-addr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost:80&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Nacos地址&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="26优化">
&lt;a href="#26%e4%bc%98%e5%8c%96" class="header-anchor">#&lt;/a>
2.6.优化
&lt;/h2>&lt;ul>
&lt;li>
&lt;p>实际部署时，需要给做反向代理的nginx服务器设置一个域名，这样后续如果有服务器迁移nacos的客户端也无需更改配置.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Nacos的各个节点应该部署到多个不同服务器，做好容灾和隔离&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>RabbitMQ部署指南1</title><link>https://logan.wssw.fun/p/2023/01/1784e117/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/1784e117/</guid><description>&lt;h1 id="rabbitmq部署指南">
&lt;a href="#rabbitmq%e9%83%a8%e7%bd%b2%e6%8c%87%e5%8d%97" class="header-anchor">#&lt;/a>
RabbitMQ部署指南
&lt;/h1>&lt;h1 id="1单机部署">
&lt;a href="#1%e5%8d%95%e6%9c%ba%e9%83%a8%e7%bd%b2" class="header-anchor">#&lt;/a>
1.单机部署
&lt;/h1>&lt;p>我们在Centos7虚拟机中使用Docker来安装。&lt;/p>
&lt;h2 id="11下载镜像">
&lt;a href="#11%e4%b8%8b%e8%bd%bd%e9%95%9c%e5%83%8f" class="header-anchor">#&lt;/a>
1.1.下载镜像
&lt;/h2>&lt;p>方式一：在线拉取&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker pull rabbitmq:3-management
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>方式二：从本地加载&lt;/p>
&lt;p>在课前资料已经提供了镜像包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739369-c80009dae47489.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210423191210349"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>上传到虚拟机中后，使用命令加载镜像即可：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker load -i mq.tar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="12安装mq">
&lt;a href="#12%e5%ae%89%e8%a3%85mq" class="header-anchor">#&lt;/a>
1.2.安装MQ
&lt;/h2>&lt;p>执行下面的命令来运行MQ容器：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-9">&lt;a class="lnlinks" href="#hl-2-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -e &lt;span class="nv">RABBITMQ_DEFAULT_USER&lt;/span>&lt;span class="o">=&lt;/span>itcast &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -e &lt;span class="nv">RABBITMQ_DEFAULT_PASS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">123321&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --name mq &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --hostname mq1 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -p 15672:15672 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -p 5672:5672 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -d &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> rabbitmq:3-management
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="2集群部署">
&lt;a href="#2%e9%9b%86%e7%be%a4%e9%83%a8%e7%bd%b2" class="header-anchor">#&lt;/a>
2.集群部署
&lt;/h1>&lt;p>接下来，我们看看如何安装RabbitMQ的集群。&lt;/p>
&lt;h2 id="21集群分类">
&lt;a href="#21%e9%9b%86%e7%be%a4%e5%88%86%e7%b1%bb" class="header-anchor">#&lt;/a>
2.1.集群分类
&lt;/h2>&lt;p>在RabbitMQ的官方文档中，讲述了两种集群的配置方式：&lt;/p>
&lt;ul>
&lt;li>普通模式：普通模式集群不进行数据同步，每个MQ都有自己的队列、数据信息（其它元数据信息如交换机等会同步）。例如我们有2个MQ：mq1，和mq2，如果你的消息在mq1，而你连接到了mq2，那么mq2会去mq1拉取消息，然后返回给你。如果mq1宕机，消息就会丢失。&lt;/li>
&lt;li>镜像模式：与普通模式不同，队列会在各个mq的镜像节点之间同步，因此你连接到任何一个镜像节点，均可获取到消息。而且如果一个节点宕机，并不会导致数据丢失。不过，这种方式增加了数据同步的带宽消耗。&lt;/li>
&lt;/ul>
&lt;p>我们先来看普通模式集群。&lt;/p>
&lt;h2 id="22设置网络">
&lt;a href="#22%e8%ae%be%e7%bd%ae%e7%bd%91%e7%bb%9c" class="header-anchor">#&lt;/a>
2.2.设置网络
&lt;/h2>&lt;p>首先，我们需要让3台MQ互相知道对方的存在。&lt;/p>
&lt;p>分别在3台机器中，设置 /etc/hosts文件，添加如下内容：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">192.168.150.101 mq1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.150.102 mq2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.150.103 mq3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>并在每台机器上测试，是否可以ping通对方：&lt;/p></description></item><item><title>RabbitMQ部署指南2</title><link>https://logan.wssw.fun/p/2023/01/45yhgx45/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/45yhgx45/</guid><description>&lt;h1 id="rabbitmq部署指南">
&lt;a href="#rabbitmq%e9%83%a8%e7%bd%b2%e6%8c%87%e5%8d%97" class="header-anchor">#&lt;/a>
RabbitMQ部署指南
&lt;/h1>&lt;h1 id="1单机部署">
&lt;a href="#1%e5%8d%95%e6%9c%ba%e9%83%a8%e7%bd%b2" class="header-anchor">#&lt;/a>
1.单机部署
&lt;/h1>&lt;p>我们在Centos7虚拟机中使用Docker来安装。&lt;/p>
&lt;h2 id="11下载镜像">
&lt;a href="#11%e4%b8%8b%e8%bd%bd%e9%95%9c%e5%83%8f" class="header-anchor">#&lt;/a>
1.1.下载镜像
&lt;/h2>&lt;p>方式一：在线拉取&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker pull rabbitmq:3.8-management
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>方式二：从本地加载&lt;/p>
&lt;p>在课前资料已经提供了镜像包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-d8548aac18c259.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210423191210349"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>上传到虚拟机中后，使用命令加载镜像即可：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker load -i mq.tar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="12安装mq">
&lt;a href="#12%e5%ae%89%e8%a3%85mq" class="header-anchor">#&lt;/a>
1.2.安装MQ
&lt;/h2>&lt;p>执行下面的命令来运行MQ容器：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-9">&lt;a class="lnlinks" href="#hl-2-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-10">&lt;a class="lnlinks" href="#hl-2-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -e &lt;span class="nv">RABBITMQ_DEFAULT_USER&lt;/span>&lt;span class="o">=&lt;/span>itcast &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -e &lt;span class="nv">RABBITMQ_DEFAULT_PASS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">123321&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v mq-plugins:/plugins &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --name mq &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --hostname mq1 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -p 15672:15672 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -p 5672:5672 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -d &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> rabbitmq:3.8-management
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="2安装delayexchange插件">
&lt;a href="#2%e5%ae%89%e8%a3%85delayexchange%e6%8f%92%e4%bb%b6" class="header-anchor">#&lt;/a>
2.安装DelayExchange插件
&lt;/h1>&lt;p>官方的安装指南地址为：https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq&lt;/p>
&lt;p>上述文档是基于linux原生安装RabbitMQ，然后安装插件。&lt;/p>
&lt;p>因为我们之前是基于Docker安装RabbitMQ，所以下面我们会讲解基于Docker来安装RabbitMQ插件。&lt;/p>
&lt;h2 id="21下载插件">
&lt;a href="#21%e4%b8%8b%e8%bd%bd%e6%8f%92%e4%bb%b6" class="header-anchor">#&lt;/a>
2.1.下载插件
&lt;/h2>&lt;p>RabbitMQ有一个官方的插件社区，地址为：https://www.rabbitmq.com/community-plugins.html&lt;/p>
&lt;p>其中包含各种各样的插件，包括我们要使用的DelayExchange插件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-5eef457f94f2b3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713104511055"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>大家可以去对应的GitHub页面下载3.8.9版本的插件，地址为https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/tag/3.8.9这个对应RabbitMQ的3.8.5以上版本。&lt;/p>
&lt;p>课前资料也提供了下载好的插件：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-108ffd0949e25c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713104808909"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="22上传插件">
&lt;a href="#22%e4%b8%8a%e4%bc%a0%e6%8f%92%e4%bb%b6" class="header-anchor">#&lt;/a>
2.2.上传插件
&lt;/h2>&lt;p>因为我们是基于Docker安装，所以需要先查看RabbitMQ的插件目录对应的数据卷。如果不是基于Docker的同学，请参考第一章部分，重新创建Docker容器。&lt;/p>
&lt;p>我们之前设定的RabbitMQ的数据卷名称为&lt;code>mq-plugins&lt;/code>，所以我们使用下面命令查看数据卷：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker volume inspect mq-plugins
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可以得到下面结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-5a2bc8456409ab.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713105135701"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>接下来，将插件上传到这个目录即可：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-99ab1763e8c5a2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713105339785"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="23安装插件">
&lt;a href="#23%e5%ae%89%e8%a3%85%e6%8f%92%e4%bb%b6" class="header-anchor">#&lt;/a>
2.3.安装插件
&lt;/h2>&lt;p>最后就是安装了，需要进入MQ容器内部来执行安装。我的容器名为&lt;code>mq&lt;/code>，所以执行下面命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker &lt;span class="nb">exec&lt;/span> -it mq bash
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>执行时，请将其中的 &lt;code>-it&lt;/code> 后面的&lt;code>mq&lt;/code>替换为你自己的容器名.&lt;/p>
&lt;p>进入容器内部后，执行下面命令开启插件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">rabbitmq-plugins &lt;span class="nb">enable&lt;/span> rabbitmq_delayed_message_exchange
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-a75060f0c5ab17.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210713105829435"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="3集群部署">
&lt;a href="#3%e9%9b%86%e7%be%a4%e9%83%a8%e7%bd%b2" class="header-anchor">#&lt;/a>
3.集群部署
&lt;/h1>&lt;p>接下来，我们看看如何安装RabbitMQ的集群。&lt;/p>
&lt;h2 id="21集群分类">
&lt;a href="#21%e9%9b%86%e7%be%a4%e5%88%86%e7%b1%bb" class="header-anchor">#&lt;/a>
2.1.集群分类
&lt;/h2>&lt;p>在RabbitMQ的官方文档中，讲述了两种集群的配置方式：&lt;/p>
&lt;ul>
&lt;li>普通模式：普通模式集群不进行数据同步，每个MQ都有自己的队列、数据信息（其它元数据信息如交换机等会同步）。例如我们有2个MQ：mq1，和mq2，如果你的消息在mq1，而你连接到了mq2，那么mq2会去mq1拉取消息，然后返回给你。如果mq1宕机，消息就会丢失。&lt;/li>
&lt;li>镜像模式：与普通模式不同，队列会在各个mq的镜像节点之间同步，因此你连接到任何一个镜像节点，均可获取到消息。而且如果一个节点宕机，并不会导致数据丢失。不过，这种方式增加了数据同步的带宽消耗。&lt;/li>
&lt;/ul>
&lt;p>我们先来看普通模式集群，我们的计划部署3节点的mq集群：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>主机名&lt;/th>
&lt;th>控制台端口&lt;/th>
&lt;th>amqp通信端口&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>mq1&lt;/td>
&lt;td>8081 &amp;mdash;&amp;gt; 15672&lt;/td>
&lt;td>8071 &amp;mdash;&amp;gt; 5672&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>mq2&lt;/td>
&lt;td>8082 &amp;mdash;&amp;gt; 15672&lt;/td>
&lt;td>8072 &amp;mdash;&amp;gt; 5672&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>mq3&lt;/td>
&lt;td>8083 &amp;mdash;&amp;gt; 15672&lt;/td>
&lt;td>8073 &amp;mdash;&amp;gt; 5672&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>集群中的节点标示默认都是：&lt;code>rabbit@[hostname]&lt;/code>，因此以上三个节点的名称分别为：&lt;/p>
&lt;ul>
&lt;li>rabbit@mq1&lt;/li>
&lt;li>rabbit@mq2&lt;/li>
&lt;li>rabbit@mq3&lt;/li>
&lt;/ul>
&lt;h2 id="22获取cookie">
&lt;a href="#22%e8%8e%b7%e5%8f%96cookie" class="header-anchor">#&lt;/a>
2.2.获取cookie
&lt;/h2>&lt;p>RabbitMQ底层依赖于Erlang，而Erlang虚拟机就是一个面向分布式的语言，默认就支持集群模式。集群模式中的每个RabbitMQ 节点使用 cookie 来确定它们是否被允许相互通信。&lt;/p>
&lt;p>要使两个节点能够通信，它们必须具有相同的共享秘密，称为&lt;strong>Erlang cookie&lt;/strong>。cookie 只是一串最多 255 个字符的字母数字字符。&lt;/p>
&lt;p>每个集群节点必须具有&lt;strong>相同的 cookie&lt;/strong>。实例之间也需要它来相互通信。&lt;/p>
&lt;p>我们先在之前启动的mq容器中获取一个cookie值，作为集群的cookie。执行下面的命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker &lt;span class="nb">exec&lt;/span> -it mq cat /var/lib/rabbitmq/.erlang.cookie
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可以看到cookie值如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">FXZMCVGLBIXZCDEMMVZQ
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>接下来，停止并删除当前的mq容器，我们重新搭建集群。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker rm -f mq
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-09dbe5380af5cf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717212345165"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="23准备集群配置">
&lt;a href="#23%e5%87%86%e5%a4%87%e9%9b%86%e7%be%a4%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
2.3.准备集群配置
&lt;/h2>&lt;p>在/tmp目录新建一个配置文件 rabbitmq.conf：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 创建文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">touch rabbitmq.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>文件内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-5">&lt;a class="lnlinks" href="#hl-10-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-6">&lt;a class="lnlinks" href="#hl-10-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">loopback_users.guest&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">listeners.tcp.default&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">5672&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">cluster_formation.peer_discovery_backend&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">rabbit_peer_discovery_classic_config&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">cluster_formation.classic_config.nodes.1&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">rabbit@mq1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">cluster_formation.classic_config.nodes.2&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">rabbit@mq2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">cluster_formation.classic_config.nodes.3&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">rabbit@mq3&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>再创建一个文件，记录cookie&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-5">&lt;a class="lnlinks" href="#hl-11-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-6">&lt;a class="lnlinks" href="#hl-11-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-7">&lt;a class="lnlinks" href="#hl-11-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 创建cookie文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">touch .erlang.cookie
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 写入cookie&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;FXZMCVGLBIXZCDEMMVZQ&amp;#34;&lt;/span> &amp;gt; .erlang.cookie
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 修改cookie文件的权限&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chmod &lt;span class="m">600&lt;/span> .erlang.cookie
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>准备三个目录,mq1、mq2、mq3：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3">3&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 创建目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir mq1 mq2 mq3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后拷贝rabbitmq.conf、cookie文件到mq1、mq2、mq3：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-5">&lt;a class="lnlinks" href="#hl-13-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-6">&lt;a class="lnlinks" href="#hl-13-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-7">&lt;a class="lnlinks" href="#hl-13-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-8">&lt;a class="lnlinks" href="#hl-13-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-9">&lt;a class="lnlinks" href="#hl-13-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入/tmp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 拷贝&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp rabbitmq.conf mq1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp rabbitmq.conf mq2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp rabbitmq.conf mq3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp .erlang.cookie mq1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp .erlang.cookie mq2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp .erlang.cookie mq3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="24启动集群">
&lt;a href="#24%e5%90%af%e5%8a%a8%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
2.4.启动集群
&lt;/h2>&lt;p>创建一个网络：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker network create mq-net
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>docker volume create&lt;/p>
&lt;p>运行命令&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-6">&lt;a class="lnlinks" href="#hl-15-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-7">&lt;a class="lnlinks" href="#hl-15-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-8">&lt;a class="lnlinks" href="#hl-15-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-9">&lt;a class="lnlinks" href="#hl-15-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-10">&lt;a class="lnlinks" href="#hl-15-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run -d --net mq-net &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-v &lt;span class="si">${&lt;/span>&lt;span class="nv">PWD&lt;/span>&lt;span class="si">}&lt;/span>/mq1/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-v &lt;span class="si">${&lt;/span>&lt;span class="nv">PWD&lt;/span>&lt;span class="si">}&lt;/span>/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e &lt;span class="nv">RABBITMQ_DEFAULT_USER&lt;/span>&lt;span class="o">=&lt;/span>itcast &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e &lt;span class="nv">RABBITMQ_DEFAULT_PASS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">123321&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--name mq1 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--hostname mq1 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-p 8071:5672 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-p 8081:15672 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>rabbitmq:3.8-management
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-7">&lt;a class="lnlinks" href="#hl-16-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-8">&lt;a class="lnlinks" href="#hl-16-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-9">&lt;a class="lnlinks" href="#hl-16-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-10">&lt;a class="lnlinks" href="#hl-16-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run -d --net mq-net &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-v &lt;span class="si">${&lt;/span>&lt;span class="nv">PWD&lt;/span>&lt;span class="si">}&lt;/span>/mq2/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-v &lt;span class="si">${&lt;/span>&lt;span class="nv">PWD&lt;/span>&lt;span class="si">}&lt;/span>/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e &lt;span class="nv">RABBITMQ_DEFAULT_USER&lt;/span>&lt;span class="o">=&lt;/span>itcast &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e &lt;span class="nv">RABBITMQ_DEFAULT_PASS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">123321&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--name mq2 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--hostname mq2 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-p 8072:5672 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-p 8082:15672 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>rabbitmq:3.8-management
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-4">&lt;a class="lnlinks" href="#hl-17-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-5">&lt;a class="lnlinks" href="#hl-17-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-6">&lt;a class="lnlinks" href="#hl-17-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-7">&lt;a class="lnlinks" href="#hl-17-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-8">&lt;a class="lnlinks" href="#hl-17-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-9">&lt;a class="lnlinks" href="#hl-17-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-17-10">&lt;a class="lnlinks" href="#hl-17-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run -d --net mq-net &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-v &lt;span class="si">${&lt;/span>&lt;span class="nv">PWD&lt;/span>&lt;span class="si">}&lt;/span>/mq3/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-v &lt;span class="si">${&lt;/span>&lt;span class="nv">PWD&lt;/span>&lt;span class="si">}&lt;/span>/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e &lt;span class="nv">RABBITMQ_DEFAULT_USER&lt;/span>&lt;span class="o">=&lt;/span>itcast &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e &lt;span class="nv">RABBITMQ_DEFAULT_PASS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">123321&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--name mq3 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--hostname mq3 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-p 8073:5672 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-p 8083:15672 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>rabbitmq:3.8-management
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="25测试">
&lt;a href="#25%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
2.5.测试
&lt;/h2>&lt;p>在mq1这个节点上添加一个队列：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-96e78d3c854c88.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717222833196"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>如图，在mq2和mq3两个控制台也都能看到：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-5e47f979f6bf47.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717223057902"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="251数据共享测试">
&lt;a href="#251%e6%95%b0%e6%8d%ae%e5%85%b1%e4%ba%ab%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
2.5.1.数据共享测试
&lt;/h3>&lt;p>点击这个队列，进入管理页面：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-41eee20115d82b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717223421750"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后利用控制台发送一条消息到这个队列：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-dc8463d7d603cf.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717223320238"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>结果在mq2、mq3上都能看到这条消息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-6a697b94359ced.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717223603628"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="252可用性测试">
&lt;a href="#252%e5%8f%af%e7%94%a8%e6%80%a7%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
2.5.2.可用性测试
&lt;/h3>&lt;p>我们让其中一台节点mq1宕机：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker stop mq1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后登录mq2或mq3的控制台，发现simple.queue也不可用了：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-4097d73226e3f7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717223800203"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>说明数据并没有拷贝到mq2和mq3。&lt;/p>
&lt;h1 id="4镜像模式">
&lt;a href="#4%e9%95%9c%e5%83%8f%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
4.镜像模式
&lt;/h1>&lt;p>在刚刚的案例中，一旦创建队列的主机宕机，队列就会不可用。不具备高可用能力。如果要解决这个问题，必须使用官方提供的镜像集群方案。&lt;/p>
&lt;p>官方文档地址：https://www.rabbitmq.com/ha.html&lt;/p>
&lt;h2 id="41镜像模式的特征">
&lt;a href="#41%e9%95%9c%e5%83%8f%e6%a8%a1%e5%bc%8f%e7%9a%84%e7%89%b9%e5%be%81" class="header-anchor">#&lt;/a>
4.1.镜像模式的特征
&lt;/h2>&lt;p>默认情况下，队列只保存在创建该队列的节点上。而镜像模式下，创建队列的节点被称为该队列的&lt;strong>主节点&lt;/strong>，队列还会拷贝到集群中的其它节点，也叫做该队列的&lt;strong>镜像&lt;/strong>节点。&lt;/p>
&lt;p>但是，不同队列可以在集群中的任意节点上创建，因此不同队列的主节点可以不同。甚至，&lt;strong>一个队列的主节点可能是另一个队列的镜像节点&lt;/strong>。&lt;/p>
&lt;p>用户发送给队列的一切请求，例如发送消息、消息回执默认都会在主节点完成，如果是从节点接收到请求，也会路由到主节点去完成。&lt;strong>镜像节点仅仅起到备份数据作用&lt;/strong>。&lt;/p>
&lt;p>当主节点接收到消费者的ACK时，所有镜像都会删除节点中的数据。&lt;/p>
&lt;p>总结如下：&lt;/p>
&lt;ul>
&lt;li>镜像队列结构是一主多从（从就是镜像）&lt;/li>
&lt;li>所有操作都是主节点完成，然后同步给镜像节点&lt;/li>
&lt;li>主宕机后，镜像节点会替代成新的主（如果在主从同步完成前，主就已经宕机，可能出现数据丢失）&lt;/li>
&lt;li>不具备负载均衡功能，因为所有操作都会有主节点完成（但是不同队列，其主节点可以不同，可以利用这个提高吞吐量）&lt;/li>
&lt;/ul>
&lt;h2 id="42镜像模式的配置">
&lt;a href="#42%e9%95%9c%e5%83%8f%e6%a8%a1%e5%bc%8f%e7%9a%84%e9%85%8d%e7%bd%ae" class="header-anchor">#&lt;/a>
4.2.镜像模式的配置
&lt;/h2>&lt;p>镜像模式的配置有3种模式：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">ha-mode&lt;/th>
&lt;th style="text-align:left">ha-params&lt;/th>
&lt;th style="text-align:left">效果&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">准确模式exactly&lt;/td>
&lt;td style="text-align:left">队列的副本量count&lt;/td>
&lt;td style="text-align:left">集群中队列副本（主服务器和镜像服务器之和）的数量。count如果为1意味着单个副本：即队列主节点。count值为2表示2个副本：1个队列主和1个队列镜像。换句话说：count = 镜像数量 + 1。如果群集中的节点数少于count，则该队列将镜像到所有节点。如果有集群总数大于count+1，并且包含镜像的节点出现故障，则将在另一个节点上创建一个新的镜像。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">all&lt;/td>
&lt;td style="text-align:left">(none)&lt;/td>
&lt;td style="text-align:left">队列在群集中的所有节点之间进行镜像。队列将镜像到任何新加入的节点。镜像到所有节点将对所有群集节点施加额外的压力，包括网络I / O，磁盘I / O和磁盘空间使用情况。推荐使用exactly，设置副本数为（N / 2 +1）。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">nodes&lt;/td>
&lt;td style="text-align:left">&lt;em>node names&lt;/em>&lt;/td>
&lt;td style="text-align:left">指定队列创建到哪些节点，如果指定的节点全部不存在，则会出现异常。如果指定的节点在集群中存在，但是暂时不可用，会创建节点到当前客户端连接到的节点。&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>这里我们以rabbitmqctl命令作为案例来讲解配置语法。&lt;/p>
&lt;p>语法示例：&lt;/p>
&lt;h3 id="421exactly模式">
&lt;a href="#421exactly%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
4.2.1.exactly模式
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">rabbitmqctl set_policy ha-two &amp;#34;^two\.&amp;#34; &amp;#39;{&amp;#34;ha-mode&amp;#34;:&amp;#34;exactly&amp;#34;,&amp;#34;ha-params&amp;#34;:2,&amp;#34;ha-sync-mode&amp;#34;:&amp;#34;automatic&amp;#34;}&amp;#39;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>rabbitmqctl set_policy&lt;/code>：固定写法&lt;/li>
&lt;li>&lt;code>ha-two&lt;/code>：策略名称，自定义&lt;/li>
&lt;li>&lt;code>&amp;quot;^two\.&amp;quot;&lt;/code>：匹配队列的正则表达式，符合命名规则的队列才生效，这里是任何以&lt;code>two.&lt;/code>开头的队列名称&lt;/li>
&lt;li>&lt;code>'{&amp;quot;ha-mode&amp;quot;:&amp;quot;exactly&amp;quot;,&amp;quot;ha-params&amp;quot;:2,&amp;quot;ha-sync-mode&amp;quot;:&amp;quot;automatic&amp;quot;}'&lt;/code>: 策略内容
&lt;ul>
&lt;li>&lt;code>&amp;quot;ha-mode&amp;quot;:&amp;quot;exactly&amp;quot;&lt;/code>：策略模式，此处是exactly模式，指定副本数量&lt;/li>
&lt;li>&lt;code>&amp;quot;ha-params&amp;quot;:2&lt;/code>：策略参数，这里是2，就是副本数量为2，1主1镜像&lt;/li>
&lt;li>&lt;code>&amp;quot;ha-sync-mode&amp;quot;:&amp;quot;automatic&amp;quot;&lt;/code>：同步策略，默认是manual，即新加入的镜像节点不会同步旧的消息。如果设置为automatic，则新加入的镜像节点会把主节点中所有消息都同步，会带来额外的网络开销&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="422all模式">
&lt;a href="#422all%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
4.2.2.all模式
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">rabbitmqctl set_policy ha-all &amp;#34;^all\.&amp;#34; &amp;#39;{&amp;#34;ha-mode&amp;#34;:&amp;#34;all&amp;#34;}&amp;#39;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>ha-all&lt;/code>：策略名称，自定义&lt;/li>
&lt;li>&lt;code>&amp;quot;^all\.&amp;quot;&lt;/code>：匹配所有以&lt;code>all.&lt;/code>开头的队列名&lt;/li>
&lt;li>&lt;code>'{&amp;quot;ha-mode&amp;quot;:&amp;quot;all&amp;quot;}'&lt;/code>：策略内容
&lt;ul>
&lt;li>&lt;code>&amp;quot;ha-mode&amp;quot;:&amp;quot;all&amp;quot;&lt;/code>：策略模式，此处是all模式，即所有节点都会称为镜像节点&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="423nodes模式">
&lt;a href="#423nodes%e6%a8%a1%e5%bc%8f" class="header-anchor">#&lt;/a>
4.2.3.nodes模式
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-21-1">&lt;a class="lnlinks" href="#hl-21-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">rabbitmqctl set_policy ha-nodes &amp;#34;^nodes\.&amp;#34; &amp;#39;{&amp;#34;ha-mode&amp;#34;:&amp;#34;nodes&amp;#34;,&amp;#34;ha-params&amp;#34;:[&amp;#34;rabbit@nodeA&amp;#34;, &amp;#34;rabbit@nodeB&amp;#34;]}&amp;#39;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>rabbitmqctl set_policy&lt;/code>：固定写法&lt;/li>
&lt;li>&lt;code>ha-nodes&lt;/code>：策略名称，自定义&lt;/li>
&lt;li>&lt;code>&amp;quot;^nodes\.&amp;quot;&lt;/code>：匹配队列的正则表达式，符合命名规则的队列才生效，这里是任何以&lt;code>nodes.&lt;/code>开头的队列名称&lt;/li>
&lt;li>&lt;code>'{&amp;quot;ha-mode&amp;quot;:&amp;quot;nodes&amp;quot;,&amp;quot;ha-params&amp;quot;:[&amp;quot;rabbit@nodeA&amp;quot;, &amp;quot;rabbit@nodeB&amp;quot;]}'&lt;/code>: 策略内容
&lt;ul>
&lt;li>&lt;code>&amp;quot;ha-mode&amp;quot;:&amp;quot;nodes&amp;quot;&lt;/code>：策略模式，此处是nodes模式&lt;/li>
&lt;li>&lt;code>&amp;quot;ha-params&amp;quot;:[&amp;quot;rabbit@mq1&amp;quot;, &amp;quot;rabbit@mq2&amp;quot;]&lt;/code>：策略参数，这里指定副本所在节点名称&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="43测试">
&lt;a href="#43%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
4.3.测试
&lt;/h2>&lt;p>我们使用exactly模式的镜像，因为集群节点数量为3，因此镜像数量就设置为2.&lt;/p>
&lt;p>运行下面的命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-22-1">&lt;a class="lnlinks" href="#hl-22-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker &lt;span class="nb">exec&lt;/span> -it mq1 rabbitmqctl set_policy ha-two &lt;span class="s2">&amp;#34;^two\.&amp;#34;&lt;/span> &lt;span class="s1">&amp;#39;{&amp;#34;ha-mode&amp;#34;:&amp;#34;exactly&amp;#34;,&amp;#34;ha-params&amp;#34;:2,&amp;#34;ha-sync-mode&amp;#34;:&amp;#34;automatic&amp;#34;}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>下面，我们创建一个新的队列：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-cf31f6d86ba20f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717231751411"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在任意一个mq控制台查看队列：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-608759de8e8d37.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717231829505"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="431测试数据共享">
&lt;a href="#431%e6%b5%8b%e8%af%95%e6%95%b0%e6%8d%ae%e5%85%b1%e4%ba%ab" class="header-anchor">#&lt;/a>
4.3.1.测试数据共享
&lt;/h3>&lt;p>给two.queue发送一条消息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-b05735ecea110d.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717231958996"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>然后在mq1、mq2、mq3的任意控制台查看消息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-59a733851cd67f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717232108584"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="432测试高可用">
&lt;a href="#432%e6%b5%8b%e8%af%95%e9%ab%98%e5%8f%af%e7%94%a8" class="header-anchor">#&lt;/a>
4.3.2.测试高可用
&lt;/h3>&lt;p>现在，我们让two.queue的主节点mq1宕机：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-23-1">&lt;a class="lnlinks" href="#hl-23-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker stop mq1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查看集群状态：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-551e39f78bac7e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717232257420"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>查看队列状态：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-cb39805d33d8a8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717232322646"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>发现依然是健康的！并且其主节点切换到了rabbit@mq2上&lt;/p>
&lt;h1 id="5仲裁队列">
&lt;a href="#5%e4%bb%b2%e8%a3%81%e9%98%9f%e5%88%97" class="header-anchor">#&lt;/a>
5.仲裁队列
&lt;/h1>&lt;p>从RabbitMQ 3.8版本开始，引入了新的仲裁队列，他具备与镜像队里类似的功能，但使用更加方便。&lt;/p>
&lt;h2 id="51添加仲裁队列">
&lt;a href="#51%e6%b7%bb%e5%8a%a0%e4%bb%b2%e8%a3%81%e9%98%9f%e5%88%97" class="header-anchor">#&lt;/a>
5.1.添加仲裁队列
&lt;/h2>&lt;p>在任意控制台添加一个队列，一定要选择队列类型为Quorum类型。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-1c7b11adc4efb0.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717234329640"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>在任意控制台查看队列：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-ae2ed46c73405f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210717234426209"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>可以看到，仲裁队列的 + 2字样。代表这个队列有2个镜像节点。&lt;/p>
&lt;p>因为仲裁队列默认的镜像数为5。如果你的集群有7个节点，那么镜像数肯定是5；而我们集群只有3个节点，因此镜像数量就是3.&lt;/p>
&lt;h2 id="52测试">
&lt;a href="#52%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
5.2.测试
&lt;/h2>&lt;p>可以参考对镜像集群的测试，效果是一样的。&lt;/p>
&lt;h2 id="53集群扩容">
&lt;a href="#53%e9%9b%86%e7%be%a4%e6%89%a9%e5%ae%b9" class="header-anchor">#&lt;/a>
5.3.集群扩容
&lt;/h2>&lt;h3 id="531加入集群">
&lt;a href="#531%e5%8a%a0%e5%85%a5%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
5.3.1.加入集群
&lt;/h3>&lt;p>1）启动一个新的MQ容器：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-24-1">&lt;a class="lnlinks" href="#hl-24-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-2">&lt;a class="lnlinks" href="#hl-24-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-3">&lt;a class="lnlinks" href="#hl-24-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-4">&lt;a class="lnlinks" href="#hl-24-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-5">&lt;a class="lnlinks" href="#hl-24-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-6">&lt;a class="lnlinks" href="#hl-24-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-7">&lt;a class="lnlinks" href="#hl-24-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-8">&lt;a class="lnlinks" href="#hl-24-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-24-9">&lt;a class="lnlinks" href="#hl-24-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run -d --net mq-net &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-v &lt;span class="si">${&lt;/span>&lt;span class="nv">PWD&lt;/span>&lt;span class="si">}&lt;/span>/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e &lt;span class="nv">RABBITMQ_DEFAULT_USER&lt;/span>&lt;span class="o">=&lt;/span>itcast &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e &lt;span class="nv">RABBITMQ_DEFAULT_PASS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">123321&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--name mq4 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--hostname mq5 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-p 8074:15672 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-p 8084:15672 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>rabbitmq:3.8-management
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2）进入容器控制台：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-25-1">&lt;a class="lnlinks" href="#hl-25-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker &lt;span class="nb">exec&lt;/span> -it mq4 bash
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）停止mq进程&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-26-1">&lt;a class="lnlinks" href="#hl-26-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">rabbitmqctl stop_app
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4）重置RabbitMQ中的数据：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-27-1">&lt;a class="lnlinks" href="#hl-27-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">rabbitmqctl reset
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>5）加入mq1：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-28-1">&lt;a class="lnlinks" href="#hl-28-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">rabbitmqctl join_cluster rabbit@mq1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>6）再次启动mq进程&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-29-1">&lt;a class="lnlinks" href="#hl-29-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">rabbitmqctl start_app
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-e72c69e4142c79.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718001909492"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="532增加仲裁队列副本">
&lt;a href="#532%e5%a2%9e%e5%8a%a0%e4%bb%b2%e8%a3%81%e9%98%9f%e5%88%97%e5%89%af%e6%9c%ac" class="header-anchor">#&lt;/a>
5.3.2.增加仲裁队列副本
&lt;/h3>&lt;p>我们先查看下quorum.queue这个队列目前的副本情况，进入mq1容器：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-30-1">&lt;a class="lnlinks" href="#hl-30-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker &lt;span class="nb">exec&lt;/span> -it mq1 bash
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>执行命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-31-1">&lt;a class="lnlinks" href="#hl-31-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">rabbitmq-queues quorum_status &lt;span class="s2">&amp;#34;quorum.queue&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-db38e934732384.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718002118357"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>现在，我们让mq4也加入进来：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-32-1">&lt;a class="lnlinks" href="#hl-32-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">rabbitmq-queues add_member &lt;span class="s2">&amp;#34;quorum.queue&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;rabbit@mq4&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-f713020075a20e.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718002253226"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>再次查看：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-33-1">&lt;a class="lnlinks" href="#hl-33-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">rabbitmq-queues quorum_status &lt;span class="s2">&amp;#34;quorum.queue&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-67ce321113daa9.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718002342603"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>查看控制台，发现quorum.queue的镜像数量也从原来的 +2 变成了 +3：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653740313-d9771b106f08ca.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210718002422365"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p></description></item><item><title>安装elasticsearch1</title><link>https://logan.wssw.fun/p/2023/01/34a16834/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/34a16834/</guid><description>&lt;h1 id="安装elasticsearch">
&lt;a href="#%e5%ae%89%e8%a3%85elasticsearch" class="header-anchor">#&lt;/a>
安装elasticsearch
&lt;/h1>&lt;h1 id="1部署单点es">
&lt;a href="#1%e9%83%a8%e7%bd%b2%e5%8d%95%e7%82%b9es" class="header-anchor">#&lt;/a>
1.部署单点es
&lt;/h1>&lt;h2 id="11创建网络">
&lt;a href="#11%e5%88%9b%e5%bb%ba%e7%bd%91%e7%bb%9c" class="header-anchor">#&lt;/a>
1.1.创建网络
&lt;/h2>&lt;p>因为我们还需要部署kibana容器，因此需要让es和kibana容器互联。这里先创建一个网络：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker network create es-net
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="12加载镜像">
&lt;a href="#12%e5%8a%a0%e8%bd%bd%e9%95%9c%e5%83%8f" class="header-anchor">#&lt;/a>
1.2.加载镜像
&lt;/h2>&lt;p>这里我们采用elasticsearch的7.12.1版本的镜像，这个镜像体积非常大，接近1G。不建议大家自己pull。&lt;/p>
&lt;p>课前资料提供了镜像的tar包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739413-3472ce4c7cb4d3.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210510165308064"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>大家将其上传到虚拟机中，然后运行命令加载即可：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 导入数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker load -i es.tar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>同理还有&lt;code>kibana&lt;/code>的tar包也需要这样做。&lt;/p>
&lt;h2 id="13运行">
&lt;a href="#13%e8%bf%90%e8%a1%8c" class="header-anchor">#&lt;/a>
1.3.运行
&lt;/h2>&lt;p>运行docker命令，部署单点es：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-9">&lt;a class="lnlinks" href="#hl-2-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-10">&lt;a class="lnlinks" href="#hl-2-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-11">&lt;a class="lnlinks" href="#hl-2-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run -d &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --name es &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -e &lt;span class="s2">&amp;#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -e &lt;span class="s2">&amp;#34;discovery.type=single-node&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v es-data:/usr/share/elasticsearch/data &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v es-plugins:/usr/share/elasticsearch/plugins &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --privileged &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --network es-net &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -p 9200:9200 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -p 9300:9300 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>elasticsearch:7.12.1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>命令解释：&lt;/p>
&lt;ul>
&lt;li>&lt;code>-e &amp;quot;cluster.name=es-docker-cluster&amp;quot;&lt;/code>：设置集群名称&lt;/li>
&lt;li>&lt;code>-e &amp;quot;http.host=0.0.0.0&amp;quot;&lt;/code>：监听的地址，可以外网访问&lt;/li>
&lt;li>&lt;code>-e &amp;quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&amp;quot;&lt;/code>：内存大小&lt;/li>
&lt;li>&lt;code>-e &amp;quot;discovery.type=single-node&amp;quot;&lt;/code>：非集群模式&lt;/li>
&lt;li>&lt;code>-v es-data:/usr/share/elasticsearch/data&lt;/code>：挂载逻辑卷，绑定es的数据目录&lt;/li>
&lt;li>&lt;code>-v es-logs:/usr/share/elasticsearch/logs&lt;/code>：挂载逻辑卷，绑定es的日志目录&lt;/li>
&lt;li>&lt;code>-v es-plugins:/usr/share/elasticsearch/plugins&lt;/code>：挂载逻辑卷，绑定es的插件目录&lt;/li>
&lt;li>&lt;code>--privileged&lt;/code>：授予逻辑卷访问权&lt;/li>
&lt;li>&lt;code>--network es-net&lt;/code> ：加入一个名为es-net的网络中&lt;/li>
&lt;li>&lt;code>-p 9200:9200&lt;/code>：端口映射配置&lt;/li>
&lt;/ul>
&lt;p>在浏览器中输入：http://192.168.150.101:9200 即可看到elasticsearch的响应结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739413-2602e7f8ec3f4b.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210506101053676"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="2部署kibana">
&lt;a href="#2%e9%83%a8%e7%bd%b2kibana" class="header-anchor">#&lt;/a>
2.部署kibana
&lt;/h1>&lt;p>kibana可以给我们提供一个elasticsearch的可视化界面，便于我们学习。&lt;/p>
&lt;h2 id="21部署">
&lt;a href="#21%e9%83%a8%e7%bd%b2" class="header-anchor">#&lt;/a>
2.1.部署
&lt;/h2>&lt;p>运行docker命令，部署kibana&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run -d &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--name kibana &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e &lt;span class="nv">ELASTICSEARCH_HOSTS&lt;/span>&lt;span class="o">=&lt;/span>http://es:9200 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--network&lt;span class="o">=&lt;/span>es-net &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-p 5601:5601 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>kibana:7.12.1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>--network es-net&lt;/code> ：加入一个名为es-net的网络中，与elasticsearch在同一个网络中&lt;/li>
&lt;li>&lt;code>-e ELASTICSEARCH_HOSTS=http://es:9200&amp;quot;&lt;/code>：设置elasticsearch的地址，因为kibana已经与elasticsearch在一个网络，因此可以用容器名直接访问elasticsearch&lt;/li>
&lt;li>&lt;code>-p 5601:5601&lt;/code>：端口映射配置&lt;/li>
&lt;/ul>
&lt;p>kibana启动一般比较慢，需要多等待一会，可以通过命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker logs -f kibana
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查看运行日志，当查看到下面的日志，说明成功：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739413-c22d6835fb5e04.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210109105135812"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>此时，在浏览器输入地址访问：http://192.168.150.101:5601，即可看到结果&lt;/p>
&lt;h2 id="22devtools">
&lt;a href="#22devtools" class="header-anchor">#&lt;/a>
2.2.DevTools
&lt;/h2>&lt;p>kibana中提供了一个DevTools界面：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739413-04816119d8fec7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210506102630393"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这个界面中可以编写DSL来操作elasticsearch。并且对DSL语句有自动补全功能。&lt;/p>
&lt;h1 id="3安装ik分词器">
&lt;a href="#3%e5%ae%89%e8%a3%85ik%e5%88%86%e8%af%8d%e5%99%a8" class="header-anchor">#&lt;/a>
3.安装IK分词器
&lt;/h1>&lt;h2 id="31在线安装ik插件较慢">
&lt;a href="#31%e5%9c%a8%e7%ba%bf%e5%ae%89%e8%a3%85ik%e6%8f%92%e4%bb%b6%e8%be%83%e6%85%a2" class="header-anchor">#&lt;/a>
3.1.在线安装ik插件（较慢）
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-4">&lt;a class="lnlinks" href="#hl-5-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-5">&lt;a class="lnlinks" href="#hl-5-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-6">&lt;a class="lnlinks" href="#hl-5-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-7">&lt;a class="lnlinks" href="#hl-5-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-8">&lt;a class="lnlinks" href="#hl-5-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-9">&lt;a class="lnlinks" href="#hl-5-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-10">&lt;a class="lnlinks" href="#hl-5-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入容器内部&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker &lt;span class="nb">exec&lt;/span> -it elasticsearch /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 在线下载并安装&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.12.1/elasticsearch-analysis-ik-7.12.1.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#退出&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#重启容器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker restart elasticsearch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="32离线安装ik插件推荐">
&lt;a href="#32%e7%a6%bb%e7%ba%bf%e5%ae%89%e8%a3%85ik%e6%8f%92%e4%bb%b6%e6%8e%a8%e8%8d%90" class="header-anchor">#&lt;/a>
3.2.离线安装ik插件（推荐）
&lt;/h2>&lt;h3 id="1查看数据卷目录">
&lt;a href="#1%e6%9f%a5%e7%9c%8b%e6%95%b0%e6%8d%ae%e5%8d%b7%e7%9b%ae%e5%bd%95" class="header-anchor">#&lt;/a>
1）查看数据卷目录
&lt;/h3>&lt;p>安装插件需要知道elasticsearch的plugins目录位置，而我们用了数据卷挂载，因此需要查看elasticsearch的数据卷目录，通过下面命令查看:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker volume inspect es-plugins
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>显示结果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-8">&lt;a class="lnlinks" href="#hl-7-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-9">&lt;a class="lnlinks" href="#hl-7-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-10">&lt;a class="lnlinks" href="#hl-7-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-11">&lt;a class="lnlinks" href="#hl-7-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;CreatedAt&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2022-05-06T10:06:34+08:00&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;Driver&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;local&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;Labels&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;Mountpoint&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/var/lib/docker/volumes/es-plugins/_data&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;Name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;es-plugins&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;Options&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;Scope&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>说明plugins目录被挂载到了：&lt;code>/var/lib/docker/volumes/es-plugins/_data &lt;/code>这个目录中。&lt;/p>
&lt;h3 id="2解压缩分词器安装包">
&lt;a href="#2%e8%a7%a3%e5%8e%8b%e7%bc%a9%e5%88%86%e8%af%8d%e5%99%a8%e5%ae%89%e8%a3%85%e5%8c%85" class="header-anchor">#&lt;/a>
2）解压缩分词器安装包
&lt;/h3>&lt;p>下面我们需要把课前资料中的ik分词器解压缩，重命名为ik&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739413-4af55021520380.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210506110249144"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="3上传到es容器的插件数据卷中">
&lt;a href="#3%e4%b8%8a%e4%bc%a0%e5%88%b0es%e5%ae%b9%e5%99%a8%e7%9a%84%e6%8f%92%e4%bb%b6%e6%95%b0%e6%8d%ae%e5%8d%b7%e4%b8%ad" class="header-anchor">#&lt;/a>
3）上传到es容器的插件数据卷中
&lt;/h3>&lt;p>也就是&lt;code>/var/lib/docker/volumes/es-plugins/_data &lt;/code>：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739413-0780ed0e108be1.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210506110704293"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="4重启容器">
&lt;a href="#4%e9%87%8d%e5%90%af%e5%ae%b9%e5%99%a8" class="header-anchor">#&lt;/a>
4）重启容器
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 4、重启容器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker restart es
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看es日志&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker logs -f es
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="5测试">
&lt;a href="#5%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
5）测试：
&lt;/h3>&lt;p>IK分词器包含两种模式：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>ik_smart&lt;/code>：最少切分&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>ik_max_word&lt;/code>：最细切分&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-5">&lt;a class="lnlinks" href="#hl-10-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/_analyze&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_max_word&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;黑马程序员学习java太棒了&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-5">&lt;a class="lnlinks" href="#hl-11-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-6">&lt;a class="lnlinks" href="#hl-11-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-7">&lt;a class="lnlinks" href="#hl-11-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-8">&lt;a class="lnlinks" href="#hl-11-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-9">&lt;a class="lnlinks" href="#hl-11-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-10">&lt;a class="lnlinks" href="#hl-11-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-11">&lt;a class="lnlinks" href="#hl-11-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-12">&lt;a class="lnlinks" href="#hl-11-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-13">&lt;a class="lnlinks" href="#hl-11-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-14">&lt;a class="lnlinks" href="#hl-11-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-15">&lt;a class="lnlinks" href="#hl-11-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-16">&lt;a class="lnlinks" href="#hl-11-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-17">&lt;a class="lnlinks" href="#hl-11-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-18">&lt;a class="lnlinks" href="#hl-11-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-19">&lt;a class="lnlinks" href="#hl-11-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-20">&lt;a class="lnlinks" href="#hl-11-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-21">&lt;a class="lnlinks" href="#hl-11-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-22">&lt;a class="lnlinks" href="#hl-11-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-23">&lt;a class="lnlinks" href="#hl-11-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-24">&lt;a class="lnlinks" href="#hl-11-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-25">&lt;a class="lnlinks" href="#hl-11-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-26">&lt;a class="lnlinks" href="#hl-11-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-27">&lt;a class="lnlinks" href="#hl-11-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-28">&lt;a class="lnlinks" href="#hl-11-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-29">&lt;a class="lnlinks" href="#hl-11-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-30">&lt;a class="lnlinks" href="#hl-11-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-31">&lt;a class="lnlinks" href="#hl-11-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-32">&lt;a class="lnlinks" href="#hl-11-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-33">&lt;a class="lnlinks" href="#hl-11-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-34">&lt;a class="lnlinks" href="#hl-11-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-35">&lt;a class="lnlinks" href="#hl-11-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-36">&lt;a class="lnlinks" href="#hl-11-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-37">&lt;a class="lnlinks" href="#hl-11-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-38">&lt;a class="lnlinks" href="#hl-11-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-39">&lt;a class="lnlinks" href="#hl-11-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-40">&lt;a class="lnlinks" href="#hl-11-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-41">&lt;a class="lnlinks" href="#hl-11-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-42">&lt;a class="lnlinks" href="#hl-11-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-43">&lt;a class="lnlinks" href="#hl-11-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-44">&lt;a class="lnlinks" href="#hl-11-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-45">&lt;a class="lnlinks" href="#hl-11-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-46">&lt;a class="lnlinks" href="#hl-11-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-47">&lt;a class="lnlinks" href="#hl-11-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-48">&lt;a class="lnlinks" href="#hl-11-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-49">&lt;a class="lnlinks" href="#hl-11-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-50">&lt;a class="lnlinks" href="#hl-11-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-51">&lt;a class="lnlinks" href="#hl-11-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-52">&lt;a class="lnlinks" href="#hl-11-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-53">&lt;a class="lnlinks" href="#hl-11-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-54">&lt;a class="lnlinks" href="#hl-11-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-55">&lt;a class="lnlinks" href="#hl-11-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-56">&lt;a class="lnlinks" href="#hl-11-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-57">&lt;a class="lnlinks" href="#hl-11-57">57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-58">&lt;a class="lnlinks" href="#hl-11-58">58&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-59">&lt;a class="lnlinks" href="#hl-11-59">59&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-60">&lt;a class="lnlinks" href="#hl-11-60">60&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-61">&lt;a class="lnlinks" href="#hl-11-61">61&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-62">&lt;a class="lnlinks" href="#hl-11-62">62&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-63">&lt;a class="lnlinks" href="#hl-11-63">63&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-64">&lt;a class="lnlinks" href="#hl-11-64">64&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-65">&lt;a class="lnlinks" href="#hl-11-65">65&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-66">&lt;a class="lnlinks" href="#hl-11-66">66&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-67">&lt;a class="lnlinks" href="#hl-11-67">67&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;tokens&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;黑马&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_WORD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;程序员&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_WORD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;程序&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_WORD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;员&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_CHAR&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;学习&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_WORD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;java&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">11&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ENGLISH&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;太棒了&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">11&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">14&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_WORD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;太棒&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">11&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">13&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_WORD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">7&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;了&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">13&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">14&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_CHAR&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="33-扩展词词典">
&lt;a href="#33-%e6%89%a9%e5%b1%95%e8%af%8d%e8%af%8d%e5%85%b8" class="header-anchor">#&lt;/a>
3.3 扩展词词典
&lt;/h2>&lt;p>随着互联网的发展，“造词运动”也越发的频繁。出现了很多新的词语，在原有的词汇列表中并不存在。比如：“奥力给”，“传智播客” 等。&lt;/p>
&lt;p>所以我们的词汇也需要不断的更新，IK分词器提供了扩展词汇的功能。&lt;/p>
&lt;p>1）打开IK分词器config目录：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739413-febd4a5b521e80.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210506112225508"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>2）在IKAnalyzer.cfg.xml配置文件内容添加：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-6">&lt;a class="lnlinks" href="#hl-12-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-7">&lt;a class="lnlinks" href="#hl-12-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;UTF-8&amp;#34;?&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;!DOCTYPE properties SYSTEM &amp;#34;http://java.sun.com/dtd/properties.dtd&amp;#34;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;properties&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;comment&amp;gt;&lt;/span>IK Analyzer 扩展配置&lt;span class="nt">&amp;lt;/comment&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!--用户可以在这里配置自己的扩展字典 *** 添加扩展词典--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;entry&lt;/span> &lt;span class="na">key=&lt;/span>&lt;span class="s">&amp;#34;ext_dict&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>ext.dic&lt;span class="nt">&amp;lt;/entry&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/properties&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）新建一个 ext.dic，可以参考config目录下复制一个配置文件进行修改&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="na">传智播客&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">奥力给&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4）重启elasticsearch&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker restart es
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看 日志&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker logs -f elasticsearch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739413-3d066953310314.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20201115230900504"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>日志中已经成功加载ext.dic配置文件&lt;/p>
&lt;p>5）测试效果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/_analyze&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_max_word&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;传智播客Java就业超过90%,奥力给！&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>注意当前文件的编码必须是 UTF-8 格式，严禁使用Windows记事本编辑&lt;/p>
&lt;/blockquote>
&lt;h2 id="34-停用词词典">
&lt;a href="#34-%e5%81%9c%e7%94%a8%e8%af%8d%e8%af%8d%e5%85%b8" class="header-anchor">#&lt;/a>
3.4 停用词词典
&lt;/h2>&lt;p>在互联网项目中，在网络间传输的速度很快，所以很多语言是不允许在网络上传递的，如：关于宗教、政治等敏感词语，那么我们在搜索时也应该忽略当前词汇。&lt;/p>
&lt;p>IK分词器也提供了强大的停用词功能，让我们在索引时就直接忽略当前的停用词汇表中的内容。&lt;/p>
&lt;p>1）IKAnalyzer.cfg.xml配置文件内容添加：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-7">&lt;a class="lnlinks" href="#hl-16-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-8">&lt;a class="lnlinks" href="#hl-16-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-9">&lt;a class="lnlinks" href="#hl-16-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;UTF-8&amp;#34;?&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;!DOCTYPE properties SYSTEM &amp;#34;http://java.sun.com/dtd/properties.dtd&amp;#34;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;properties&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;comment&amp;gt;&lt;/span>IK Analyzer 扩展配置&lt;span class="nt">&amp;lt;/comment&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!--用户可以在这里配置自己的扩展字典--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;entry&lt;/span> &lt;span class="na">key=&lt;/span>&lt;span class="s">&amp;#34;ext_dict&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>ext.dic&lt;span class="nt">&amp;lt;/entry&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!--用户可以在这里配置自己的扩展停止词字典 *** 添加停用词词典--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;entry&lt;/span> &lt;span class="na">key=&lt;/span>&lt;span class="s">&amp;#34;ext_stopwords&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>stopword.dic&lt;span class="nt">&amp;lt;/entry&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/properties&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）在 stopword.dic 添加停用词&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="na">习大大&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4）重启elasticsearch&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-5">&lt;a class="lnlinks" href="#hl-18-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-6">&lt;a class="lnlinks" href="#hl-18-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 重启服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker restart elasticsearch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker restart kibana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看 日志&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker logs -f elasticsearch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>日志中已经成功加载stopword.dic配置文件&lt;/p>
&lt;p>5）测试效果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-5">&lt;a class="lnlinks" href="#hl-19-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/_analyze&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_max_word&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;传智播客Java就业率超过95%,习大大都点赞,奥力给！&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>注意当前文件的编码必须是 UTF-8 格式，严禁使用Windows记事本编辑&lt;/p>
&lt;/blockquote>
&lt;h1 id="4部署es集群">
&lt;a href="#4%e9%83%a8%e7%bd%b2es%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.部署es集群
&lt;/h1>&lt;p>部署es集群可以直接使用docker-compose来完成，不过要求你的Linux虚拟机至少有&lt;strong>4G&lt;/strong>的内存空间&lt;/p>
&lt;p>首先编写一个docker-compose文件，内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-4">&lt;a class="lnlinks" href="#hl-20-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-5">&lt;a class="lnlinks" href="#hl-20-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-6">&lt;a class="lnlinks" href="#hl-20-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-7">&lt;a class="lnlinks" href="#hl-20-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-8">&lt;a class="lnlinks" href="#hl-20-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-9">&lt;a class="lnlinks" href="#hl-20-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-10">&lt;a class="lnlinks" href="#hl-20-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-11">&lt;a class="lnlinks" href="#hl-20-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-12">&lt;a class="lnlinks" href="#hl-20-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-13">&lt;a class="lnlinks" href="#hl-20-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-14">&lt;a class="lnlinks" href="#hl-20-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-15">&lt;a class="lnlinks" href="#hl-20-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-16">&lt;a class="lnlinks" href="#hl-20-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-17">&lt;a class="lnlinks" href="#hl-20-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-18">&lt;a class="lnlinks" href="#hl-20-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-19">&lt;a class="lnlinks" href="#hl-20-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-20">&lt;a class="lnlinks" href="#hl-20-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-21">&lt;a class="lnlinks" href="#hl-20-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-22">&lt;a class="lnlinks" href="#hl-20-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-23">&lt;a class="lnlinks" href="#hl-20-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-24">&lt;a class="lnlinks" href="#hl-20-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-25">&lt;a class="lnlinks" href="#hl-20-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-26">&lt;a class="lnlinks" href="#hl-20-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-27">&lt;a class="lnlinks" href="#hl-20-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-28">&lt;a class="lnlinks" href="#hl-20-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-29">&lt;a class="lnlinks" href="#hl-20-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-30">&lt;a class="lnlinks" href="#hl-20-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-31">&lt;a class="lnlinks" href="#hl-20-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-32">&lt;a class="lnlinks" href="#hl-20-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-33">&lt;a class="lnlinks" href="#hl-20-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-34">&lt;a class="lnlinks" href="#hl-20-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-35">&lt;a class="lnlinks" href="#hl-20-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-36">&lt;a class="lnlinks" href="#hl-20-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-37">&lt;a class="lnlinks" href="#hl-20-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-38">&lt;a class="lnlinks" href="#hl-20-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-39">&lt;a class="lnlinks" href="#hl-20-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-40">&lt;a class="lnlinks" href="#hl-20-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-41">&lt;a class="lnlinks" href="#hl-20-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-42">&lt;a class="lnlinks" href="#hl-20-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-43">&lt;a class="lnlinks" href="#hl-20-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-44">&lt;a class="lnlinks" href="#hl-20-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-45">&lt;a class="lnlinks" href="#hl-20-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-46">&lt;a class="lnlinks" href="#hl-20-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-47">&lt;a class="lnlinks" href="#hl-20-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-48">&lt;a class="lnlinks" href="#hl-20-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-49">&lt;a class="lnlinks" href="#hl-20-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-50">&lt;a class="lnlinks" href="#hl-20-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-51">&lt;a class="lnlinks" href="#hl-20-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-52">&lt;a class="lnlinks" href="#hl-20-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-53">&lt;a class="lnlinks" href="#hl-20-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-54">&lt;a class="lnlinks" href="#hl-20-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-55">&lt;a class="lnlinks" href="#hl-20-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-56">&lt;a class="lnlinks" href="#hl-20-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-57">&lt;a class="lnlinks" href="#hl-20-57">57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-58">&lt;a class="lnlinks" href="#hl-20-58">58&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-59">&lt;a class="lnlinks" href="#hl-20-59">59&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-60">&lt;a class="lnlinks" href="#hl-20-60">60&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-61">&lt;a class="lnlinks" href="#hl-20-61">61&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-62">&lt;a class="lnlinks" href="#hl-20-62">62&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-63">&lt;a class="lnlinks" href="#hl-20-63">63&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-64">&lt;a class="lnlinks" href="#hl-20-64">64&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-65">&lt;a class="lnlinks" href="#hl-20-65">65&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-66">&lt;a class="lnlinks" href="#hl-20-66">66&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-67">&lt;a class="lnlinks" href="#hl-20-67">67&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-68">&lt;a class="lnlinks" href="#hl-20-68">68&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-69">&lt;a class="lnlinks" href="#hl-20-69">69&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-70">&lt;a class="lnlinks" href="#hl-20-70">70&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">version: &lt;span class="s1">&amp;#39;2.2&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> es01:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> container_name: es01
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> environment:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - node.name&lt;span class="o">=&lt;/span>es01
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cluster.name&lt;span class="o">=&lt;/span>es-docker-cluster
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - discovery.seed_hosts&lt;span class="o">=&lt;/span>es02,es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cluster.initial_master_nodes&lt;span class="o">=&lt;/span>es01,es02,es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - bootstrap.memory_lock&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - &lt;span class="s2">&amp;#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ulimits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memlock:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> soft: -1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hard: -1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - data01:/usr/share/elasticsearch/data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ports:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - 9200:9200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> networks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - elastic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> es02:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> container_name: es02
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> environment:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - node.name&lt;span class="o">=&lt;/span>es02
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cluster.name&lt;span class="o">=&lt;/span>es-docker-cluster
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - discovery.seed_hosts&lt;span class="o">=&lt;/span>es01,es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cluster.initial_master_nodes&lt;span class="o">=&lt;/span>es01,es02,es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - bootstrap.memory_lock&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - &lt;span class="s2">&amp;#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ulimits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memlock:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> soft: -1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hard: -1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - data02:/usr/share/elasticsearch/data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> networks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - elastic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> es03:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> container_name: es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> environment:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - node.name&lt;span class="o">=&lt;/span>es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cluster.name&lt;span class="o">=&lt;/span>es-docker-cluster
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - discovery.seed_hosts&lt;span class="o">=&lt;/span>es01,es02
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cluster.initial_master_nodes&lt;span class="o">=&lt;/span>es01,es02,es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - bootstrap.memory_lock&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - &lt;span class="s2">&amp;#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ulimits:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> memlock:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> soft: -1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hard: -1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - data03:/usr/share/elasticsearch/data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> networks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - elastic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data01:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> driver: &lt;span class="nb">local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data02:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> driver: &lt;span class="nb">local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data03:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> driver: &lt;span class="nb">local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">networks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> elastic:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> driver: bridge
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Run &lt;code>docker-compose&lt;/code> to bring up the cluster:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-21-1">&lt;a class="lnlinks" href="#hl-21-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker-compose up
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>安装elasticsearch2</title><link>https://logan.wssw.fun/p/2023/01/11784511/</link><pubDate>Tue, 03 Jan 2023 15:49:51 +0800</pubDate><guid>https://logan.wssw.fun/p/2023/01/11784511/</guid><description>&lt;h1 id="安装elasticsearch">
&lt;a href="#%e5%ae%89%e8%a3%85elasticsearch" class="header-anchor">#&lt;/a>
安装elasticsearch
&lt;/h1>&lt;h1 id="1部署单点es">
&lt;a href="#1%e9%83%a8%e7%bd%b2%e5%8d%95%e7%82%b9es" class="header-anchor">#&lt;/a>
1.部署单点es
&lt;/h1>&lt;h2 id="11创建网络">
&lt;a href="#11%e5%88%9b%e5%bb%ba%e7%bd%91%e7%bb%9c" class="header-anchor">#&lt;/a>
1.1.创建网络
&lt;/h2>&lt;p>因为我们还需要部署kibana容器，因此需要让es和kibana容器互联。这里先创建一个网络：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker network create es-net
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="12加载镜像">
&lt;a href="#12%e5%8a%a0%e8%bd%bd%e9%95%9c%e5%83%8f" class="header-anchor">#&lt;/a>
1.2.加载镜像
&lt;/h2>&lt;p>这里我们采用elasticsearch的7.12.1版本的镜像，这个镜像体积非常大，接近1G。不建议大家自己pull。&lt;/p>
&lt;p>课前资料提供了镜像的tar包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-1e6323f9dd58cb.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210510165308064"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>大家将其上传到虚拟机中，然后运行命令加载即可：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 导入数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker load -i es.tar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>同理还有&lt;code>kibana&lt;/code>的tar包也需要这样做。&lt;/p>
&lt;h2 id="13运行">
&lt;a href="#13%e8%bf%90%e8%a1%8c" class="header-anchor">#&lt;/a>
1.3.运行
&lt;/h2>&lt;p>运行docker命令，部署单点es：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-8">&lt;a class="lnlinks" href="#hl-2-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-9">&lt;a class="lnlinks" href="#hl-2-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-10">&lt;a class="lnlinks" href="#hl-2-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-2-11">&lt;a class="lnlinks" href="#hl-2-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run -d &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --name es &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -e &lt;span class="s2">&amp;#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -e &lt;span class="s2">&amp;#34;discovery.type=single-node&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v es-data:/usr/share/elasticsearch/data &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -v es-plugins:/usr/share/elasticsearch/plugins &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --privileged &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --network es-net &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -p 9200:9200 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -p 9300:9300 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>elasticsearch:7.12.1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>命令解释：&lt;/p>
&lt;ul>
&lt;li>&lt;code>-e &amp;quot;cluster.name=es-docker-cluster&amp;quot;&lt;/code>：设置集群名称&lt;/li>
&lt;li>&lt;code>-e &amp;quot;http.host=0.0.0.0&amp;quot;&lt;/code>：监听的地址，可以外网访问&lt;/li>
&lt;li>&lt;code>-e &amp;quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&amp;quot;&lt;/code>：内存大小&lt;/li>
&lt;li>&lt;code>-e &amp;quot;discovery.type=single-node&amp;quot;&lt;/code>：非集群模式&lt;/li>
&lt;li>&lt;code>-v es-data:/usr/share/elasticsearch/data&lt;/code>：挂载逻辑卷，绑定es的数据目录&lt;/li>
&lt;li>&lt;code>-v es-logs:/usr/share/elasticsearch/logs&lt;/code>：挂载逻辑卷，绑定es的日志目录&lt;/li>
&lt;li>&lt;code>-v es-plugins:/usr/share/elasticsearch/plugins&lt;/code>：挂载逻辑卷，绑定es的插件目录&lt;/li>
&lt;li>&lt;code>--privileged&lt;/code>：授予逻辑卷访问权&lt;/li>
&lt;li>&lt;code>--network es-net&lt;/code> ：加入一个名为es-net的网络中&lt;/li>
&lt;li>&lt;code>-p 9200:9200&lt;/code>：端口映射配置&lt;/li>
&lt;/ul>
&lt;p>在浏览器中输入：http://192.168.150.101:9200 即可看到elasticsearch的响应结果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-fabd4af8330f86.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210506101053676"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h1 id="2部署kibana">
&lt;a href="#2%e9%83%a8%e7%bd%b2kibana" class="header-anchor">#&lt;/a>
2.部署kibana
&lt;/h1>&lt;p>kibana可以给我们提供一个elasticsearch的可视化界面，便于我们学习。&lt;/p>
&lt;h2 id="21部署">
&lt;a href="#21%e9%83%a8%e7%bd%b2" class="header-anchor">#&lt;/a>
2.1.部署
&lt;/h2>&lt;p>运行docker命令，部署kibana&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run -d &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--name kibana &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-e &lt;span class="nv">ELASTICSEARCH_HOSTS&lt;/span>&lt;span class="o">=&lt;/span>http://es:9200 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>--network&lt;span class="o">=&lt;/span>es-net &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>-p 5601:5601 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>kibana:7.12.1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>--network es-net&lt;/code> ：加入一个名为es-net的网络中，与elasticsearch在同一个网络中&lt;/li>
&lt;li>&lt;code>-e ELASTICSEARCH_HOSTS=http://es:9200&amp;quot;&lt;/code>：设置elasticsearch的地址，因为kibana已经与elasticsearch在一个网络，因此可以用容器名直接访问elasticsearch&lt;/li>
&lt;li>&lt;code>-p 5601:5601&lt;/code>：端口映射配置&lt;/li>
&lt;/ul>
&lt;p>kibana启动一般比较慢，需要多等待一会，可以通过命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker logs -f kibana
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查看运行日志，当查看到下面的日志，说明成功：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-c946778331a7e7.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210109105135812"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>此时，在浏览器输入地址访问：http://192.168.150.101:5601，即可看到结果&lt;/p>
&lt;h2 id="22devtools">
&lt;a href="#22devtools" class="header-anchor">#&lt;/a>
2.2.DevTools
&lt;/h2>&lt;p>kibana中提供了一个DevTools界面：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-ad0b223fd81bb2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210506102630393"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>这个界面中可以编写DSL来操作elasticsearch。并且对DSL语句有自动补全功能。&lt;/p>
&lt;h1 id="3安装ik分词器">
&lt;a href="#3%e5%ae%89%e8%a3%85ik%e5%88%86%e8%af%8d%e5%99%a8" class="header-anchor">#&lt;/a>
3.安装IK分词器
&lt;/h1>&lt;h2 id="31在线安装ik插件较慢">
&lt;a href="#31%e5%9c%a8%e7%ba%bf%e5%ae%89%e8%a3%85ik%e6%8f%92%e4%bb%b6%e8%be%83%e6%85%a2" class="header-anchor">#&lt;/a>
3.1.在线安装ik插件（较慢）
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-4">&lt;a class="lnlinks" href="#hl-5-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-5">&lt;a class="lnlinks" href="#hl-5-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-6">&lt;a class="lnlinks" href="#hl-5-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-7">&lt;a class="lnlinks" href="#hl-5-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-8">&lt;a class="lnlinks" href="#hl-5-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-9">&lt;a class="lnlinks" href="#hl-5-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-5-10">&lt;a class="lnlinks" href="#hl-5-10">10&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 进入容器内部&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker &lt;span class="nb">exec&lt;/span> -it elasticsearch /bin/bash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 在线下载并安装&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.12.1/elasticsearch-analysis-ik-7.12.1.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#退出&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#重启容器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker restart elasticsearch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="32离线安装ik插件推荐">
&lt;a href="#32%e7%a6%bb%e7%ba%bf%e5%ae%89%e8%a3%85ik%e6%8f%92%e4%bb%b6%e6%8e%a8%e8%8d%90" class="header-anchor">#&lt;/a>
3.2.离线安装ik插件（推荐）
&lt;/h2>&lt;h3 id="1查看数据卷目录">
&lt;a href="#1%e6%9f%a5%e7%9c%8b%e6%95%b0%e6%8d%ae%e5%8d%b7%e7%9b%ae%e5%bd%95" class="header-anchor">#&lt;/a>
1）查看数据卷目录
&lt;/h3>&lt;p>安装插件需要知道elasticsearch的plugins目录位置，而我们用了数据卷挂载，因此需要查看elasticsearch的数据卷目录，通过下面命令查看:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker volume inspect es-plugins
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>显示结果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-8">&lt;a class="lnlinks" href="#hl-7-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-9">&lt;a class="lnlinks" href="#hl-7-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-10">&lt;a class="lnlinks" href="#hl-7-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-7-11">&lt;a class="lnlinks" href="#hl-7-11">11&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;CreatedAt&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2022-05-06T10:06:34+08:00&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;Driver&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;local&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;Labels&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;Mountpoint&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/var/lib/docker/volumes/es-plugins/_data&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;Name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;es-plugins&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;Options&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;Scope&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>说明plugins目录被挂载到了：&lt;code>/var/lib/docker/volumes/es-plugins/_data &lt;/code>这个目录中。&lt;/p>
&lt;h3 id="2解压缩分词器安装包">
&lt;a href="#2%e8%a7%a3%e5%8e%8b%e7%bc%a9%e5%88%86%e8%af%8d%e5%99%a8%e5%ae%89%e8%a3%85%e5%8c%85" class="header-anchor">#&lt;/a>
2）解压缩分词器安装包
&lt;/h3>&lt;p>下面我们需要把课前资料中的ik分词器解压缩，重命名为ik&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-9d18165dc13c79.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210506110249144"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="3上传到es容器的插件数据卷中">
&lt;a href="#3%e4%b8%8a%e4%bc%a0%e5%88%b0es%e5%ae%b9%e5%99%a8%e7%9a%84%e6%8f%92%e4%bb%b6%e6%95%b0%e6%8d%ae%e5%8d%b7%e4%b8%ad" class="header-anchor">#&lt;/a>
3）上传到es容器的插件数据卷中
&lt;/h3>&lt;p>也就是&lt;code>/var/lib/docker/volumes/es-plugins/_data &lt;/code>：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-68cf1388427260.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210506110704293"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h3 id="4重启容器">
&lt;a href="#4%e9%87%8d%e5%90%af%e5%ae%b9%e5%99%a8" class="header-anchor">#&lt;/a>
4）重启容器
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 4、重启容器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker restart es
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看es日志&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker logs -f es
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="5测试">
&lt;a href="#5%e6%b5%8b%e8%af%95" class="header-anchor">#&lt;/a>
5）测试：
&lt;/h3>&lt;p>IK分词器包含两种模式：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>ik_smart&lt;/code>：最少切分&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>ik_max_word&lt;/code>：最细切分&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-10-5">&lt;a class="lnlinks" href="#hl-10-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/_analyze&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_max_word&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;黑马程序员学习java太棒了&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-5">&lt;a class="lnlinks" href="#hl-11-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-6">&lt;a class="lnlinks" href="#hl-11-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-7">&lt;a class="lnlinks" href="#hl-11-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-8">&lt;a class="lnlinks" href="#hl-11-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-9">&lt;a class="lnlinks" href="#hl-11-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-10">&lt;a class="lnlinks" href="#hl-11-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-11">&lt;a class="lnlinks" href="#hl-11-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-12">&lt;a class="lnlinks" href="#hl-11-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-13">&lt;a class="lnlinks" href="#hl-11-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-14">&lt;a class="lnlinks" href="#hl-11-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-15">&lt;a class="lnlinks" href="#hl-11-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-16">&lt;a class="lnlinks" href="#hl-11-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-17">&lt;a class="lnlinks" href="#hl-11-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-18">&lt;a class="lnlinks" href="#hl-11-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-19">&lt;a class="lnlinks" href="#hl-11-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-20">&lt;a class="lnlinks" href="#hl-11-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-21">&lt;a class="lnlinks" href="#hl-11-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-22">&lt;a class="lnlinks" href="#hl-11-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-23">&lt;a class="lnlinks" href="#hl-11-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-24">&lt;a class="lnlinks" href="#hl-11-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-25">&lt;a class="lnlinks" href="#hl-11-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-26">&lt;a class="lnlinks" href="#hl-11-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-27">&lt;a class="lnlinks" href="#hl-11-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-28">&lt;a class="lnlinks" href="#hl-11-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-29">&lt;a class="lnlinks" href="#hl-11-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-30">&lt;a class="lnlinks" href="#hl-11-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-31">&lt;a class="lnlinks" href="#hl-11-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-32">&lt;a class="lnlinks" href="#hl-11-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-33">&lt;a class="lnlinks" href="#hl-11-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-34">&lt;a class="lnlinks" href="#hl-11-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-35">&lt;a class="lnlinks" href="#hl-11-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-36">&lt;a class="lnlinks" href="#hl-11-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-37">&lt;a class="lnlinks" href="#hl-11-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-38">&lt;a class="lnlinks" href="#hl-11-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-39">&lt;a class="lnlinks" href="#hl-11-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-40">&lt;a class="lnlinks" href="#hl-11-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-41">&lt;a class="lnlinks" href="#hl-11-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-42">&lt;a class="lnlinks" href="#hl-11-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-43">&lt;a class="lnlinks" href="#hl-11-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-44">&lt;a class="lnlinks" href="#hl-11-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-45">&lt;a class="lnlinks" href="#hl-11-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-46">&lt;a class="lnlinks" href="#hl-11-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-47">&lt;a class="lnlinks" href="#hl-11-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-48">&lt;a class="lnlinks" href="#hl-11-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-49">&lt;a class="lnlinks" href="#hl-11-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-50">&lt;a class="lnlinks" href="#hl-11-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-51">&lt;a class="lnlinks" href="#hl-11-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-52">&lt;a class="lnlinks" href="#hl-11-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-53">&lt;a class="lnlinks" href="#hl-11-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-54">&lt;a class="lnlinks" href="#hl-11-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-55">&lt;a class="lnlinks" href="#hl-11-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-56">&lt;a class="lnlinks" href="#hl-11-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-57">&lt;a class="lnlinks" href="#hl-11-57">57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-58">&lt;a class="lnlinks" href="#hl-11-58">58&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-59">&lt;a class="lnlinks" href="#hl-11-59">59&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-60">&lt;a class="lnlinks" href="#hl-11-60">60&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-61">&lt;a class="lnlinks" href="#hl-11-61">61&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-62">&lt;a class="lnlinks" href="#hl-11-62">62&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-63">&lt;a class="lnlinks" href="#hl-11-63">63&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-64">&lt;a class="lnlinks" href="#hl-11-64">64&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-65">&lt;a class="lnlinks" href="#hl-11-65">65&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-66">&lt;a class="lnlinks" href="#hl-11-66">66&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-11-67">&lt;a class="lnlinks" href="#hl-11-67">67&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;tokens&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;黑马&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_WORD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;程序员&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_WORD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;程序&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_WORD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;员&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_CHAR&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;学习&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_WORD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;java&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">11&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ENGLISH&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;太棒了&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">11&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">14&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_WORD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;太棒&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">11&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">13&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_WORD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">7&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;了&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">13&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;end_offset&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">14&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;CN_CHAR&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;position&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="33-扩展词词典">
&lt;a href="#33-%e6%89%a9%e5%b1%95%e8%af%8d%e8%af%8d%e5%85%b8" class="header-anchor">#&lt;/a>
3.3 扩展词词典
&lt;/h2>&lt;p>随着互联网的发展，“造词运动”也越发的频繁。出现了很多新的词语，在原有的词汇列表中并不存在。比如：“奥力给”，“传智播客” 等。&lt;/p>
&lt;p>所以我们的词汇也需要不断的更新，IK分词器提供了扩展词汇的功能。&lt;/p>
&lt;p>1）打开IK分词器config目录：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-e62144f4bb0f9c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210506112225508"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>2）在IKAnalyzer.cfg.xml配置文件内容添加：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-6">&lt;a class="lnlinks" href="#hl-12-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-12-7">&lt;a class="lnlinks" href="#hl-12-7">7&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;UTF-8&amp;#34;?&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;!DOCTYPE properties SYSTEM &amp;#34;http://java.sun.com/dtd/properties.dtd&amp;#34;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;properties&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;comment&amp;gt;&lt;/span>IK Analyzer 扩展配置&lt;span class="nt">&amp;lt;/comment&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!--用户可以在这里配置自己的扩展字典 *** 添加扩展词典--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;entry&lt;/span> &lt;span class="na">key=&lt;/span>&lt;span class="s">&amp;#34;ext_dict&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>ext.dic&lt;span class="nt">&amp;lt;/entry&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/properties&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）新建一个 ext.dic，可以参考config目录下复制一个配置文件进行修改&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="na">传智播客&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">奥力给&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4）重启elasticsearch&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4">4&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker restart es
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看 日志&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker logs -f elasticsearch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-e2e0e6c4a135b8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20201115230900504"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>日志中已经成功加载ext.dic配置文件&lt;/p>
&lt;p>5）测试效果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-3">&lt;a class="lnlinks" href="#hl-15-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-4">&lt;a class="lnlinks" href="#hl-15-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-15-5">&lt;a class="lnlinks" href="#hl-15-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/_analyze&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_max_word&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;传智播客Java就业超过90%,奥力给！&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>注意当前文件的编码必须是 UTF-8 格式，严禁使用Windows记事本编辑&lt;/p>
&lt;/blockquote>
&lt;h2 id="34-停用词词典">
&lt;a href="#34-%e5%81%9c%e7%94%a8%e8%af%8d%e8%af%8d%e5%85%b8" class="header-anchor">#&lt;/a>
3.4 停用词词典
&lt;/h2>&lt;p>在互联网项目中，在网络间传输的速度很快，所以很多语言是不允许在网络上传递的，如：关于宗教、政治等敏感词语，那么我们在搜索时也应该忽略当前词汇。&lt;/p>
&lt;p>IK分词器也提供了强大的停用词功能，让我们在索引时就直接忽略当前的停用词汇表中的内容。&lt;/p>
&lt;p>1）IKAnalyzer.cfg.xml配置文件内容添加：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-5">&lt;a class="lnlinks" href="#hl-16-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-6">&lt;a class="lnlinks" href="#hl-16-6">6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-7">&lt;a class="lnlinks" href="#hl-16-7">7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-8">&lt;a class="lnlinks" href="#hl-16-8">8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-16-9">&lt;a class="lnlinks" href="#hl-16-9">9&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;UTF-8&amp;#34;?&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;!DOCTYPE properties SYSTEM &amp;#34;http://java.sun.com/dtd/properties.dtd&amp;#34;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;properties&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;comment&amp;gt;&lt;/span>IK Analyzer 扩展配置&lt;span class="nt">&amp;lt;/comment&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!--用户可以在这里配置自己的扩展字典--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;entry&lt;/span> &lt;span class="na">key=&lt;/span>&lt;span class="s">&amp;#34;ext_dict&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>ext.dic&lt;span class="nt">&amp;lt;/entry&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c">&amp;lt;!--用户可以在这里配置自己的扩展停止词字典 *** 添加停用词词典--&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;entry&lt;/span> &lt;span class="na">key=&lt;/span>&lt;span class="s">&amp;#34;ext_stopwords&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>stopword.dic&lt;span class="nt">&amp;lt;/entry&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/properties&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3）在 stopword.dic 添加停用词&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-properties" data-lang="properties">&lt;span class="line">&lt;span class="cl">&lt;span class="na">习大大&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4）重启elasticsearch&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-5">&lt;a class="lnlinks" href="#hl-18-5">5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-18-6">&lt;a class="lnlinks" href="#hl-18-6">6&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 重启服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker restart elasticsearch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker restart kibana
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看 日志&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker logs -f elasticsearch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>日志中已经成功加载stopword.dic配置文件&lt;/p>
&lt;p>5）测试效果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1">1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2">2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3">3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4">4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-19-5">&lt;a class="lnlinks" href="#hl-19-5">5&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">GET&lt;/span> &lt;span class="err">/_analyze&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;analyzer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ik_max_word&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;传智播客Java就业率超过95%,习大大都点赞,奥力给！&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>注意当前文件的编码必须是 UTF-8 格式，严禁使用Windows记事本编辑&lt;/p>
&lt;/blockquote>
&lt;h1 id="4部署es集群">
&lt;a href="#4%e9%83%a8%e7%bd%b2es%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.部署es集群
&lt;/h1>&lt;p>我们会在单机上利用docker容器运行多个es实例来模拟es集群。不过生产环境推荐大家每一台服务节点仅部署一个es的实例。&lt;/p>
&lt;p>部署es集群可以直接使用docker-compose来完成，但这要求你的Linux虚拟机至少有&lt;strong>4G&lt;/strong>的内存空间&lt;/p>
&lt;h2 id="41创建es集群">
&lt;a href="#41%e5%88%9b%e5%bb%baes%e9%9b%86%e7%be%a4" class="header-anchor">#&lt;/a>
4.1.创建es集群
&lt;/h2>&lt;p>首先编写一个docker-compose文件，内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-4">&lt;a class="lnlinks" href="#hl-20-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-5">&lt;a class="lnlinks" href="#hl-20-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-6">&lt;a class="lnlinks" href="#hl-20-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-7">&lt;a class="lnlinks" href="#hl-20-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-8">&lt;a class="lnlinks" href="#hl-20-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-9">&lt;a class="lnlinks" href="#hl-20-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-10">&lt;a class="lnlinks" href="#hl-20-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-11">&lt;a class="lnlinks" href="#hl-20-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-12">&lt;a class="lnlinks" href="#hl-20-12">12&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-13">&lt;a class="lnlinks" href="#hl-20-13">13&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-14">&lt;a class="lnlinks" href="#hl-20-14">14&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-15">&lt;a class="lnlinks" href="#hl-20-15">15&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-16">&lt;a class="lnlinks" href="#hl-20-16">16&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-17">&lt;a class="lnlinks" href="#hl-20-17">17&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-18">&lt;a class="lnlinks" href="#hl-20-18">18&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-19">&lt;a class="lnlinks" href="#hl-20-19">19&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-20">&lt;a class="lnlinks" href="#hl-20-20">20&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-21">&lt;a class="lnlinks" href="#hl-20-21">21&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-22">&lt;a class="lnlinks" href="#hl-20-22">22&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-23">&lt;a class="lnlinks" href="#hl-20-23">23&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-24">&lt;a class="lnlinks" href="#hl-20-24">24&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-25">&lt;a class="lnlinks" href="#hl-20-25">25&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-26">&lt;a class="lnlinks" href="#hl-20-26">26&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-27">&lt;a class="lnlinks" href="#hl-20-27">27&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-28">&lt;a class="lnlinks" href="#hl-20-28">28&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-29">&lt;a class="lnlinks" href="#hl-20-29">29&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-30">&lt;a class="lnlinks" href="#hl-20-30">30&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-31">&lt;a class="lnlinks" href="#hl-20-31">31&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-32">&lt;a class="lnlinks" href="#hl-20-32">32&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-33">&lt;a class="lnlinks" href="#hl-20-33">33&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-34">&lt;a class="lnlinks" href="#hl-20-34">34&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-35">&lt;a class="lnlinks" href="#hl-20-35">35&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-36">&lt;a class="lnlinks" href="#hl-20-36">36&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-37">&lt;a class="lnlinks" href="#hl-20-37">37&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-38">&lt;a class="lnlinks" href="#hl-20-38">38&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-39">&lt;a class="lnlinks" href="#hl-20-39">39&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-40">&lt;a class="lnlinks" href="#hl-20-40">40&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-41">&lt;a class="lnlinks" href="#hl-20-41">41&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-42">&lt;a class="lnlinks" href="#hl-20-42">42&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-43">&lt;a class="lnlinks" href="#hl-20-43">43&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-44">&lt;a class="lnlinks" href="#hl-20-44">44&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-45">&lt;a class="lnlinks" href="#hl-20-45">45&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-46">&lt;a class="lnlinks" href="#hl-20-46">46&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-47">&lt;a class="lnlinks" href="#hl-20-47">47&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-48">&lt;a class="lnlinks" href="#hl-20-48">48&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-49">&lt;a class="lnlinks" href="#hl-20-49">49&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-50">&lt;a class="lnlinks" href="#hl-20-50">50&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-51">&lt;a class="lnlinks" href="#hl-20-51">51&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-52">&lt;a class="lnlinks" href="#hl-20-52">52&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-53">&lt;a class="lnlinks" href="#hl-20-53">53&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-54">&lt;a class="lnlinks" href="#hl-20-54">54&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-55">&lt;a class="lnlinks" href="#hl-20-55">55&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-56">&lt;a class="lnlinks" href="#hl-20-56">56&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-57">&lt;a class="lnlinks" href="#hl-20-57">57&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-20-58">&lt;a class="lnlinks" href="#hl-20-58">58&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">version: &lt;span class="s1">&amp;#39;2.2&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> es01:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> image: elasticsearch:7.12.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> container_name: es01
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> environment:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - node.name&lt;span class="o">=&lt;/span>es01
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cluster.name&lt;span class="o">=&lt;/span>es-docker-cluster
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - discovery.seed_hosts&lt;span class="o">=&lt;/span>es02,es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cluster.initial_master_nodes&lt;span class="o">=&lt;/span>es01,es02,es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - &lt;span class="s2">&amp;#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - data01:/usr/share/elasticsearch/data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ports:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - 9200:9200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> networks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - elastic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> es02:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> image: elasticsearch:7.12.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> container_name: es02
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> environment:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - node.name&lt;span class="o">=&lt;/span>es02
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cluster.name&lt;span class="o">=&lt;/span>es-docker-cluster
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - discovery.seed_hosts&lt;span class="o">=&lt;/span>es01,es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cluster.initial_master_nodes&lt;span class="o">=&lt;/span>es01,es02,es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - &lt;span class="s2">&amp;#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - data02:/usr/share/elasticsearch/data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ports:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - 9201:9200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> networks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - elastic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> es03:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> image: elasticsearch:7.12.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> container_name: es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> environment:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - node.name&lt;span class="o">=&lt;/span>es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cluster.name&lt;span class="o">=&lt;/span>es-docker-cluster
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - discovery.seed_hosts&lt;span class="o">=&lt;/span>es01,es02
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - cluster.initial_master_nodes&lt;span class="o">=&lt;/span>es01,es02,es03
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - &lt;span class="s2">&amp;#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - data03:/usr/share/elasticsearch/data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> networks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - elastic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ports:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - 9202:9200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data01:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> driver: &lt;span class="nb">local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data02:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> driver: &lt;span class="nb">local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data03:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> driver: &lt;span class="nb">local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">networks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> elastic:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> driver: bridge
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>es运行需要修改一些linux系统权限，修改&lt;code>/etc/sysctl.conf&lt;/code>文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-21-1">&lt;a class="lnlinks" href="#hl-21-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">vi /etc/sysctl.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>添加下面的内容：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-22-1">&lt;a class="lnlinks" href="#hl-22-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">vm.max_map_count&lt;span class="o">=&lt;/span>&lt;span class="m">262144&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后执行命令，让配置生效：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-23-1">&lt;a class="lnlinks" href="#hl-23-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">sysctl -p
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>通过docker-compose启动集群：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-24-1">&lt;a class="lnlinks" href="#hl-24-1">1&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker-compose up -d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="42集群状态监控">
&lt;a href="#42%e9%9b%86%e7%be%a4%e7%8a%b6%e6%80%81%e7%9b%91%e6%8e%a7" class="header-anchor">#&lt;/a>
4.2.集群状态监控
&lt;/h2>&lt;p>kibana可以监控es集群，不过新版本需要依赖es的x-pack 功能，配置比较复杂。&lt;/p>
&lt;p>这里推荐使用cerebro来监控es集群状态，官方网址：https://github.com/lmenezes/cerebro&lt;/p>
&lt;p>课前资料已经提供了安装包：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-e1d025e1fe414c.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210602220751081"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>解压即可使用，非常方便。&lt;/p>
&lt;p>解压好的目录如下：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-1362abb46d97e6.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210602220824668"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>进入对应的bin目录：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-f94be19387e563.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210602220846137"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>双击其中的cerebro.bat文件即可启动服务。&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-043d888cfff457.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210602220941101"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>访问http://localhost:9000 即可进入管理界面：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-c8ed3f2755315f.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210602221115763"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>输入你的elasticsearch的任意节点的地址和端口，点击connect即可：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-e5b34184e64ae8.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210109181106866"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>绿色的条，代表集群处于绿色（健康状态）。&lt;/p>
&lt;h2 id="43创建索引库">
&lt;a href="#43%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95%e5%ba%93" class="header-anchor">#&lt;/a>
4.3.创建索引库
&lt;/h2>&lt;h3 id="1利用kibana的devtools创建索引库">
&lt;a href="#1%e5%88%a9%e7%94%a8kibana%e7%9a%84devtools%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95%e5%ba%93" class="header-anchor">#&lt;/a>
1）利用kibana的DevTools创建索引库
&lt;/h3>&lt;p>在DevTools中输入指令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt" id="hl-25-1">&lt;a class="lnlinks" href="#hl-25-1"> 1&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-2">&lt;a class="lnlinks" href="#hl-25-2"> 2&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-3">&lt;a class="lnlinks" href="#hl-25-3"> 3&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-4">&lt;a class="lnlinks" href="#hl-25-4"> 4&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-5">&lt;a class="lnlinks" href="#hl-25-5"> 5&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-6">&lt;a class="lnlinks" href="#hl-25-6"> 6&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-7">&lt;a class="lnlinks" href="#hl-25-7"> 7&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-8">&lt;a class="lnlinks" href="#hl-25-8"> 8&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-9">&lt;a class="lnlinks" href="#hl-25-9"> 9&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-10">&lt;a class="lnlinks" href="#hl-25-10">10&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-11">&lt;a class="lnlinks" href="#hl-25-11">11&lt;/a>
&lt;/span>&lt;span class="lnt" id="hl-25-12">&lt;a class="lnlinks" href="#hl-25-12">12&lt;/a>
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">PUT&lt;/span> &lt;span class="err">/itcast&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;settings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;number_of_shards&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 分片数量
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nt">&amp;#34;number_of_replicas&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="c1">// 副本数量
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;mappings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;properties&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// mapping映射定义 ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2利用cerebro创建索引库">
&lt;a href="#2%e5%88%a9%e7%94%a8cerebro%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95%e5%ba%93" class="header-anchor">#&lt;/a>
2）利用cerebro创建索引库
&lt;/h3>&lt;p>利用cerebro还可以创建索引库：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-a50d6471068fb2.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210602221409524"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>填写索引库信息：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-f4e00ea9b4f889.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210602221520629"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;p>点击右下角的create按钮：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-bb32a20f061067.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210602221542745"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p>
&lt;h2 id="44查看分片效果">
&lt;a href="#44%e6%9f%a5%e7%9c%8b%e5%88%86%e7%89%87%e6%95%88%e6%9e%9c" class="header-anchor">#&lt;/a>
4.4.查看分片效果
&lt;/h2>&lt;p>回到首页，即可查看索引库分片效果：&lt;/p>
&lt;p>
&lt;img src="https://logan.1357810.xyz/img/20220528/1653739473-087869f70c2949.png"
width="900"
height="600"
loading="lazy"
decoding="async"
alt="image-20210602221914483"
class="gallery-image link-image"
data-flex-grow="20"
data-flex-basis="20px"
>
&lt;/p></description></item></channel></rss>